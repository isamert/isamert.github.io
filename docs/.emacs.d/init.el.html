<!doctype html>
<html lang="en">
  <head>
      <style>
       @import url("https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css");

       #toc {
           position: fixed;
           right: 20px;
           top: 50px;
           width: 300px;
           font-size: 0.7em;
       }

       #toc-header {
           position: sticky;
           top: 0;
           z-index: 1;
           padding: 10px;
           border-bottom: 1px solid #ddd;
       }

       #toggle-btn {
           float: right;
           cursor: pointer;
           font-size: 0.9em;
           color: #3498db;
       }

       #toc ul {
           list-style: none;
           padding-left: 0;
           margin-left: 0;
           overflow-y: auto;
           max-height: 70vh;
       }

       #toc li {
           margin: 5px 0;
           cursor: pointer;
       }

       /* Indentation based on the level */
       .toc-level-1 { margin-left: 0; }
       .toc-level-2 { margin-left: 20px !important; }
       .toc-level-3 { margin-left: 40px !important; }
       .toc-level-4 { margin-left: 60px !important; }
       .toc-level-5 { margin-left: 80px !important; }
       .toc-level-6 { margin-left: 100px !important; }

       body {
           margin: 0;
           font-family: "Monaco", "Courier New", monospace;
           background-color: #1b1d1e;
           color: #839496;
           overflow: hidden;
       }

       .emacs-window {
           display: flex;
           flex-direction: column;
           height: 100vh;
           border: 1px solid #073642;
       }

       .tab-bar {
           display: flex;
           justify-content: space-between;
           background-color: #262829;
           padding: 5px;
           color: #839496;
           max-height: 1rem;
           font-size: 1rem;
       }

       .tabs {
           display: flex;
       }

       .tab {
           margin-right: 10px;
       }

       .content {
           flex: 1;
           background-color: #1b1d1e;
           color: #839496;
           overflow-y: auto;
           padding: 0px 10px;
       }

       .content pre {
           margin: 1px 0px;
           padding: 0px 0px;
           white-space: pre-wrap;
       }

       .content:focus {
           outline: none;
       }

       .mode-line {
           display: flex;
           justify-content: space-between;
           background-color: #00629d;
           padding: 5px;
           color: #ffffff;
       }

       #echo-area {
           background-color: #1b1d1e;
           padding: 5px;
           color: #586e75;
           min-height: 1rem;
       }

       .mode-line .left {
           white-space: pre-wrap;
       }

       #buffer-git-address {
           text-decoration: underline;
           cursor: pointer;
           color: inherit;
           background: none;
           border: none;
           box-shadow: none;
           padding: 0;
           margin: 0;
       }
      </style>
  </head>
  <body spellcheck="false">
    <div class="emacs-window">
      <div class="tab-bar">
        <div class="tabs">
            <a href="/" style="text-decoration: none; color: #007bff;"> <i class="fas fa-arrow-left"></i> isamert.net</a>
        </div>
        <div class="date"><i class="fa fa-calendar"></i> [2025-01-12 Sun]</div>
      </div>
      <div class="content" contenteditable>
        
<style type="text/css"><!-- 
body, pre { text-decoration: none;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; }
span.default   { text-decoration: none;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; }
span.default a {  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.outline-5-0044   { color: #c99fe3;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; }
span.outline-5-0044 a { color: #c99fe3;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-2-face-0043   { text-decoration: none;  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-2-face-0043 a {  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.default-0042   { text-decoration: none;  font-size: 105%; }
span.default-0042 a {  font-size: 105%; text-decoration: underline; }
span.default-0041   { text-decoration: none;  font-size: 105%; }
span.default-0041 a {  font-size: 105%; text-decoration: underline; }
span.default-0040   { text-decoration: none;  font-size: 105%; }
span.default-0040 a {  font-size: 105%; text-decoration: underline; }
span.default-0039   { text-decoration: none;  font-size: 105%; }
span.default-0039 a {  font-size: 105%; text-decoration: underline; }
span.default-0038   { text-decoration: none;  font-size: 105%; }
span.default-0038 a {  font-size: 105%; text-decoration: underline; }
span.default-0037   { text-decoration: none;  font-size: 105%; }
span.default-0037 a {  font-size: 105%; text-decoration: underline; }
span.rainbow-delimiters-depth-1-face-0036   { text-decoration: none;  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-1-face-0036 a {  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.negation-char   { text-decoration: none;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; }
span.negation-char a {  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.regexp-grouping-construct   { text-decoration: none;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; }
span.regexp-grouping-construct a {  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.regexp-grouping-backslash   { text-decoration: none;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; }
span.regexp-grouping-backslash a {  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  color: #dddddd;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.warning   { text-decoration: none;  color: #d08928;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.warning a {  color: #d08928;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.default-0035   { text-decoration: none;  font-size: 105%; }
span.default-0035 a {  font-size: 105%; text-decoration: underline; }
span.rainbow-delimiters-depth-9-face   { text-decoration: none;  color: #a9a1e1;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-9-face a {  color: #a9a1e1;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-8-face   { text-decoration: none;  color: #60aa00;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-8-face a {  color: #60aa00;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-7-face   { text-decoration: none;  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-7-face a {  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.type   { text-decoration: none;  color: #00aa80;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.type a {  color: #00aa80;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.function-name   { text-decoration: none;  color: #b77fdb;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.function-name a {  color: #b77fdb;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.doc   { text-decoration: none;  color: #808080;  font-style: italic;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  background: #1b1d1e;  font-size: 16pt; }
span.doc a {  color: #808080;  font-style: italic;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.outline-4-0034   { color: #90b6f9;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; }
span.outline-4-0034 a { color: #90b6f9;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; text-decoration: underline; }
span.builtin   { text-decoration: none;  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.builtin a {  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.constant   { text-decoration: none;  color: #60aa00;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.constant a {  color: #60aa00;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.highlight-quoted-symbol   { text-decoration: none;  color: #00aa80;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.highlight-quoted-symbol a {  color: #00aa80;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.highlight-quoted-quote   { text-decoration: none;  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.highlight-quoted-quote a {  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-6-face   { text-decoration: none;  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-6-face a {  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-5-face   { text-decoration: none;  color: #4db5bd;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-5-face a {  color: #4db5bd;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.string   { text-decoration: none;  color: #d08928;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.string a {  color: #d08928;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-4-face   { text-decoration: none;  color: #a9a1e1;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-4-face a {  color: #a9a1e1;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-3-face   { text-decoration: none;  color: #60aa00;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-3-face a {  color: #60aa00;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-2-face   { text-decoration: none;  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-2-face a {  color: #b77fdb;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.variable-name   { text-decoration: none;  color: #5699af;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.variable-name a {  color: #5699af;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.keyword   { text-decoration: none;  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.keyword a {  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.rainbow-delimiters-depth-1-face   { text-decoration: none;  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; }
span.rainbow-delimiters-depth-1-face a {  color: #6c9ef8;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.outline-3-0033   { color: #5699af;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; }
span.outline-3-0033 a { color: #5699af;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; text-decoration: underline; }
span.outline-2-0030   { color: #b77fdb;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; }
span.outline-2-0030 a { color: #b77fdb;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; text-decoration: underline; }
span.comment   { text-decoration: none;  color: #808080;  font-style: italic;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  background: #1b1d1e;  font-size: 16pt; }
span.comment a {  color: #808080;  font-style: italic;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.outline-1-0029   { color: #6c9ef8;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; }
span.outline-1-0029 a { color: #6c9ef8;  font-weight: 700;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-style: normal;  background: #1b1d1e;  text-decoration: overline;  font-size: 16pt; text-decoration: underline; }
span.comment-delimiter   { text-decoration: none;  color: #808080;  font-style: italic;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  background: #1b1d1e;  font-size: 16pt; }
span.comment-delimiter a {  color: #808080;  font-style: italic;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  background: #1b1d1e;  font-size: 16pt; text-decoration: underline; }
span.outli-stem-emacs-lisp-mode-1-0028   { text-decoration: overline;  background: #2f6f3d;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  color: #dddddd;  font-size: 16pt; }
span.outli-stem-emacs-lisp-mode-1-0028 a { text-decoration: overline;  background: #2f6f3d;  font-family: "Cascadia Code NF";  font-stretch: normal;  font-weight: nil;  font-style: normal;  color: #dddddd;  font-size: 16pt; text-decoration: underline; }
 --></style>

<pre><span class="outli-stem-emacs-lisp-mode-1-0028">;</span><span class="comment-delimiter">;;</span><span class="outline-1-0029"> index.el --- isamert's configuration -*- lexical-binding: t; -*-
</span>
<span class="comment-delimiter">;;;</span><span class="outline-1-0029"> Commentary:
</span>
<span class="comment-delimiter">;; </span><span class="comment">isamert's configuration
</span>
<span class="comment-delimiter">;; </span><span class="comment">This is my Emacs configuration. My main focus is sanity. I'm a
</span><span class="comment-delimiter">;; </span><span class="comment">person who get frustrated pretty easily. So instead of optimizing
</span><span class="comment-delimiter">;; </span><span class="comment">the time spent on doing things, I try to find ways of doing things
</span><span class="comment-delimiter">;; </span><span class="comment">that does not make me frustrated. Most of the time you get speed
</span><span class="comment-delimiter">;; </span><span class="comment">boost as a byproduct.
</span>
<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Emacs installation
</span>
<span class="comment-delimiter">;; </span><span class="comment">I use my distributions package manager to install Emacs. However,
</span><span class="comment-delimiter">;; </span><span class="comment">in MacOS (my work computer) I use /homebrew/ and /emacs-plus/
</span><span class="comment-delimiter">;; </span><span class="comment">formula. Here is how you install it:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src sh
</span><span class="comment-delimiter">;;   </span><span class="comment">brew tap d12frosted/emacs-plus
</span><span class="comment-delimiter">;;   </span><span class="comment">brew install emacs-plus@30 \
</span><span class="comment-delimiter">;;        </span><span class="comment">--with-dragon-icon \
</span><span class="comment-delimiter">;;        </span><span class="comment">--with-dbus \
</span><span class="comment-delimiter">;;        </span><span class="comment">--with-imagemagick \
</span><span class="comment-delimiter">;;        </span><span class="comment">--with-poll \
</span><span class="comment-delimiter">;;        </span><span class="comment">--with-debug
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">There are also other nice Emacs distributions, like:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- https://github.com/jimeh/emacs-builds
</span><span class="comment-delimiter">;; </span><span class="comment">- https://emacsformacosx.com/
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">But I need the aforementioned switches and patches. Otherwise these
</span><span class="comment-delimiter">;; </span><span class="comment">are very good.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">* --with-poll
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">You can read about the options [[https://github.com/d12frosted/homebrew-emacs-plus#options][here]], but the most important one is
</span><span class="comment-delimiter">;; </span><span class="comment">~--with-poll~. Otherwise you'll get lot's of /no file descriptors
</span><span class="comment-delimiter">;; </span><span class="comment">left, too many files are open/ errors, especially if you are using
</span><span class="comment-delimiter">;; </span><span class="comment">LSP etc..
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">* --with-debug
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">It is nice for debugging crashes or freezes. Helps you get a better
</span><span class="comment-delimiter">;; </span><span class="comment">output from the debugger. When Emacs freezes and ~pkill -USR2 Emacs~
</span><span class="comment-delimiter">;; </span><span class="comment">is not helping, what you can do to debug the issue is:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src sh
</span><span class="comment-delimiter">;;   </span><span class="comment">$ cd ~/Library/Caches/Homebrew/emacs-plus@30--git/src
</span><span class="comment-delimiter">;;   </span><span class="comment">$ lldb --local-lldbinit /opt/homebrew/Cellar/emacs-plus@30/&lt;VERSION&gt;/Emacs.app
</span><span class="comment-delimiter">;;   </span><span class="comment">(lldb) r # → Do this to start emacs
</span><span class="comment-delimiter">;;   </span><span class="comment"># wait for the freeze
</span><span class="comment-delimiter">;;   </span><span class="comment"># C-c to quit the Emacs after freeze
</span><span class="comment-delimiter">;;   </span><span class="comment">(lldb) xbacktrace # or bt
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Same story with crashes. Just run Emacs through =lldb= all the time
</span><span class="comment-delimiter">;; </span><span class="comment">and be prepared I guess...
</span>
<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Usage notes
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> General notes and conventions
</span>
<span class="comment-delimiter">;; </span><span class="comment">- This configuration is meant to be used with /emacs daemon/, so I don't really care about the startup time etc.
</span><span class="comment-delimiter">;; </span><span class="comment">- I try to split package configurations into multiple org src blocks and unify them using ~noweb~ references under a single =use-package= directive.
</span><span class="comment-delimiter">;; </span><span class="comment">- I try to put things in way that easily copyable from the configuration. An example would be using multiple =(setq ...)= lines instead of having one =(setq ... ...)= call and setting multiple variables in one go.
</span><span class="comment-delimiter">;; </span><span class="comment">- I make use of =use-package= features quite minimally. See [[id:3d974e67-11fc-4f07-8cd4-ec6fd63152c4][here]] for more information that. This is generally related with the item above and future-proofing.
</span><span class="comment-delimiter">;; </span><span class="comment">- I use =verbatim text= and ~code text~ completely randomly.
</span><span class="comment-delimiter">;; </span><span class="comment">- I try to prefer built-in packages or packages that enhances built-in ones where possible. I'm also trying to simplify my configuration, so another goal is to reduce the package number. Although I intend to keep packages that enhances the overall experience with no special configuration (just install and forget type of packages).
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Keybinding conventions
</span>
<span class="comment-delimiter">;; </span><span class="comment">- After leader
</span><span class="comment-delimiter">;;   </span><span class="comment">- =e= :: is reserved for independent programs, that is not related to editing/programming. For example, &quot;ec&quot; opens calendar, &quot;ee&quot; opens elfeed, &quot;er...&quot; controls the radio.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =t= :: is reserved for toggling stuff. Toggle the terminal, toggle a frequently accessed buffer etc.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =h= :: is reserved for any menu with fuzzy selection that does not fit anywhere else.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =g= :: is for git related functionality.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =p= :: is for project related functionality.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =/= :: is for search/translate related functionality. (Generally external programs)
</span><span class="comment-delimiter">;;   </span><span class="comment">- =b= :: is for buffers.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =w= :: is for windows. I also use =C-w= for this, which is default prefix for window-related functions in vim.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =o= :: is for org-mode/outline mode.
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Updating packages
</span>
<span class="comment-delimiter">;; </span><span class="comment">Just do ~M-x straight-pull-all~. I do this quite infrequently. If
</span><span class="comment-delimiter">;; </span><span class="comment">everything is working fine as it is, I tend to not update anything.
</span>
<span class="comment-delimiter">;;;</span><span class="outline-1-0029"> Code:
</span>
<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Preparation
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> straight.el and use-package
</span>
<span class="comment-delimiter">;; </span><span class="comment">Useful to see which packages take long time to load
</span><span class="comment-delimiter">;; </span><span class="comment">(require 'use-package)
</span><span class="comment-delimiter">;; </span><span class="comment">(setq use-package-compute-statistics t)
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> use-package-enable-imenu-support t<span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">With that, IMenu will show packages section
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">bootstrap-version</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">straight-base-dir</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>bootstrap-file
       <span class="rainbow-delimiters-depth-4-face">(</span>expand-file-name <span class="string">&quot;straight/repos/straight.el/bootstrap.el&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">ignore-errors</span> straight-base-dir<span class="rainbow-delimiters-depth-6-face">)</span> user-emacs-directory<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
      (</span>bootstrap-version 5<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>file-exists-p bootstrap-file<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span>
        <span class="rainbow-delimiters-depth-4-face">(</span>url-retrieve-synchronously
         <span class="string">&quot;https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el&quot;</span>
         <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">silent</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">inhibit-cookies</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-max<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>eval-print-last-sexp<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>load bootstrap-file nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">nomessage</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>straight-use-package <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">use-package</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">straight</span>
  <span class="builtin">:custom</span> <span class="rainbow-delimiters-depth-2-face">(</span>straight-use-package-by-default t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">I tend to not use the =use-package= goodies while configuring my
</span><span class="comment-delimiter">;; </span><span class="comment">packages, meaning that I don't use =:hook=, =:bind= etc. as they
</span><span class="comment-delimiter">;; </span><span class="comment">have relatively simpler alternatives in Emacs and using
</span><span class="comment-delimiter">;; </span><span class="comment">=use-package= alternatives of these makes copy/pasting harder. Here
</span><span class="comment-delimiter">;; </span><span class="comment">are the keywords that I use the most:
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =:init= :: This gets called before the package gets initialized.
</span><span class="comment-delimiter">;; </span><span class="comment">- =:config= :: This gets called after the package is initialized.
</span><span class="comment-delimiter">;; </span><span class="comment">- =:after= :: This makes the current definition to wait the loading of listed packages, like =:after (evil org)= makes it wait for the =evil= and =org= packages to be loaded.
</span><span class="comment-delimiter">;; </span><span class="comment">- =:if= :: Loads the package conditionally, like =:if (eq system-type 'darwin)=.
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Hiding mode indicators from modeline
</span>
<span class="comment-delimiter">;; </span><span class="comment">~diminish.el~ provides a way to hide mode indicators from mode
</span><span class="comment-delimiter">;; </span><span class="comment">line. Either pass ~:diminish t~ to use-package while installing or
</span><span class="comment-delimiter">;; </span><span class="comment">just call ~(diminish 'x-mode)~.
</span>
<span class="comment-delimiter">;; </span><span class="comment">(use-package diminish)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Currently I use [[mini-modeline]] as my modeline and it already
</span><span class="comment-delimiter">;; </span><span class="comment">hides minor mode indicators from the modeline. So this package is
</span><span class="comment-delimiter">;; </span><span class="comment">not needed but better have it as I might change my modeline in the
</span><span class="comment-delimiter">;; </span><span class="comment">future.
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Load path
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">im-load-path</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="string">&quot;~/.emacs.d/load/&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;The path that I keep my extra stuff.
Probably stuff that not committed to git.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defconst</span> <span class="variable-name">im-packages-path</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="string">&quot;~/.emacs.d/packages/&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;The path that I keep my experimental packages in.
These packages are not published as a separate project but lives
in my dotfiles repository.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">load-path</span> im-load-path<span class="rainbow-delimiters-depth-1-face">)
(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">load-path</span> im-packages-path<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Also load ~im-secrets~ from =load-path=. I'll be utilizing some
</span><span class="comment-delimiter">;; </span><span class="comment">variables defined here throughout my configuration. It contains
</span><span class="comment-delimiter">;; </span><span class="comment">some api-keys, some tokens or some passwords etc. that I don't want
</span><span class="comment-delimiter">;; </span><span class="comment">to leak into public. Instead of doing mutations on an external
</span><span class="comment-delimiter">;; </span><span class="comment">hidden script, I define variables in this external hidden script
</span><span class="comment-delimiter">;; </span><span class="comment">and reference them in the configuration. This way the logic stays
</span><span class="comment-delimiter">;; </span><span class="comment">in the public configuration file so that everyone can take a look,
</span><span class="comment-delimiter">;; </span><span class="comment">but only the variable itself will be hidden from the public.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">im-secrets</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Essential packages
</span>
<span class="comment-delimiter">;; </span><span class="comment">I use =s.el= and =dash.el= extensively. They already come as a
</span><span class="comment-delimiter">;; </span><span class="comment">dependency with other packages but I may use them before loading
</span><span class="comment-delimiter">;; </span><span class="comment">any package, so:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">dash</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:config</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">dash</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">s</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:config</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">s</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">yaml</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Following provides defmemoize macro. Use (memoize-restore
</span><span class="comment-delimiter">;; </span><span class="comment">'fn-name) to restore the original function.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">memoize</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Web server stuff.  `</span><span class="constant">elnode-make-webserver</span><span class="comment">' is very useful for
</span><span class="comment-delimiter">;; </span><span class="comment">starting a webserver in given directory.  Use `</span><span class="constant">elnode-server-list</span><span class="comment">'
</span><span class="comment-delimiter">;; </span><span class="comment">to list active webservers.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">elnode</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>elnode-error-log-to-messages nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">JS-like async/await. Simply return a promise from a function with
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src elisp
</span><span class="comment-delimiter">;; </span><span class="comment">(promise-new
</span><span class="comment-delimiter">;;  </span><span class="comment">(lambda (resolve reject)
</span><span class="comment-delimiter">;;    </span><span class="comment">(funcall resolve arg)))
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">and then
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src elisp
</span><span class="comment-delimiter">;; </span><span class="comment">(async-defun some-function ()
</span><span class="comment-delimiter">;;   </span><span class="comment">(message &quot;Result is %s&quot; (await promise-returned-function)))
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">async-await</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">async-defun</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">im-async-await</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">async-cl-defun</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">request</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>request-log-level <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">warn</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>request-message-level -1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">llama</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;tarsius/llama&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> emacs-async
</span>
<span class="comment-delimiter">;; </span><span class="comment">To be able execute elisp asynchronously. Of course this has lot's
</span><span class="comment-delimiter">;; </span><span class="comment">of limitations, the lambda passed to ~async-start~ will be executed
</span><span class="comment-delimiter">;; </span><span class="comment">in a freshly started Emacs instance and it will not have the any
</span><span class="comment-delimiter">;; </span><span class="comment">context of the currently running Emacs instance. There are ways to
</span><span class="comment-delimiter">;; </span><span class="comment">pass variables into the context of newly created Emacs instance
</span><span class="comment-delimiter">;; </span><span class="comment">which helps a lot.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">async</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> parse-csv
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">parse-csv</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-parse-csv</span> <span class="rainbow-delimiters-depth-2-face">(</span>csv<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Parse CSV into an elisp object.

CSV is a string that contains the csv data.  The first line should be
the header line.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>parsed <span class="rainbow-delimiters-depth-5-face">(</span>parse-csv-string-rows csv ?\, ?\&quot; <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>headers <span class="rainbow-delimiters-depth-5-face">(</span>car <span class="rainbow-delimiters-depth-6-face">(</span>-take 1 parsed<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>data <span class="rainbow-delimiters-depth-5-face">(</span>-drop 1 parsed<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>-zip-pair headers it<span class="rainbow-delimiters-depth-4-face">)</span> data<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-parse-csv-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Parse a CSV buffer into an elisp list and inspect it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-inspect <span class="rainbow-delimiters-depth-3-face">(</span>im-parse-csv <span class="rainbow-delimiters-depth-4-face">(</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">) (</span>point-max<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>autoload <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">parse-csv-string-rows</span> <span class="string">&quot;parse-csv&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> midnight-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">I run some functions periodically using midnight-mode. Runs once a
</span><span class="comment-delimiter">;; </span><span class="comment">day at the specified time. Simply add your function via ~add-hook~
</span><span class="comment-delimiter">;; </span><span class="comment">to ~midnight-hook~.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">midnight</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">From: https://old.reddit.com/r/emacs/comments/y4nc0e/help_needed_with_midnightmode/
</span>  <span class="comment-delimiter">;; </span><span class="comment">To make it *not* work at each emacs startup, use numbers instead of &quot;10:30am&quot;
</span>  <span class="comment-delimiter">;;</span><span class="comment">
</span>  <span class="comment-delimiter">;; </span><span class="comment">Set it to 10:30am because some jobs require VPN to be open.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>midnight-delay-set <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">midnight-delay</span> <span class="rainbow-delimiters-depth-3-face">(</span>truncate <span class="rainbow-delimiters-depth-4-face">(</span>* 10.5 60 60<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>midnight-mode +1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Variables and functions
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some basic variable and function definitions that will be used in
</span><span class="comment-delimiter">;; </span><span class="comment">configuration.
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> General utilities
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-mkdir-if-not</span> <span class="rainbow-delimiters-depth-2-face">(</span>dir<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create the DIR if it does not exist return DIR.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>file-exists-p dir<span class="rainbow-delimiters-depth-3-face">)
    (</span>make-directory dir<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  dir<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-font-exists-p</span> <span class="rainbow-delimiters-depth-2-face">(</span>font<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Check if FONT exists.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>x-list-fonts font<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-assoc-regexp</span> <span class="rainbow-delimiters-depth-2-face">(</span>key list <span class="type">&amp;optional</span> fn<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `assoc` but uses `string-match (car pair) KEY` for
comparison and returns all the matching pairs.  FN is applied to
the keys before matching, if present.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>seq-filter
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>pair<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>string-match-p <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> fn <span class="rainbow-delimiters-depth-7-face">(</span>funcall fn <span class="rainbow-delimiters-depth-8-face">(</span>car pair<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">) (</span>car pair<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> key<span class="rainbow-delimiters-depth-5-face">)</span>
       pair<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   list<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-region-or</span> <span class="rainbow-delimiters-depth-2-face">(</span>what <span class="type">&amp;optional</span> alternative<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return currently selected string or WHAT-at-point string.
WHAT can be </span><span class="builtin">\\=</span><span class="doc">'symbol </span><span class="builtin">\\=</span><span class="doc">'word or a function that returns string
etc.

If WHAT is </span><span class="builtin">\\=</span><span class="doc">'string, then when no region is found user is
prompted with `</span><span class="constant">read-string</span><span class="doc">'.

If WHAT is a literal string, then it's treated as an argument to
`</span><span class="constant">skip-chars-forward</span><span class="doc">' and `</span><span class="constant">skip-chars-forward</span><span class="doc">'.

If ALTERNATIVE is non-nil, then if the result of WHAT returns nil
then `</span><span class="constant">im-region-or</span><span class="doc">' is called with ALTERNATIVE.  A useful example
would be providing </span><span class="builtin">\\=</span><span class="doc">'string as ALTERNATIVE so that if a match
not found with WHAT, then it is requested from the user.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>result <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cond</span>
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>use-region-p<span class="rainbow-delimiters-depth-7-face">) (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-8-face">(</span>region-beginning<span class="rainbow-delimiters-depth-8-face">) (</span>region-end<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="rainbow-delimiters-depth-7-face">(</span>equal what <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">string</span><span class="rainbow-delimiters-depth-7-face">) (</span>read-string <span class="string">&quot;Enter value: &quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="rainbow-delimiters-depth-7-face">(</span>functionp what<span class="rainbow-delimiters-depth-7-face">) (</span>funcall what<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="rainbow-delimiters-depth-7-face">(</span>symbolp what<span class="rainbow-delimiters-depth-7-face">) (</span>thing-at-point what t<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="rainbow-delimiters-depth-7-face">(</span>stringp what<span class="rainbow-delimiters-depth-7-face">)
                  (</span><span class="keyword">save-excursion</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>start <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-3-face">(</span>skip-chars-backward <span class="string">&quot;0-9&quot;</span><span class="rainbow-delimiters-depth-3-face">) (</span>point<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                           (</span>end <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-3-face">(</span>skip-chars-forward <span class="string">&quot;0-9&quot;</span><span class="rainbow-delimiters-depth-3-face">) (</span>point<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                           (</span>x <span class="rainbow-delimiters-depth-2-face">(</span>buffer-substring-no-properties start end<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                      (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-1-face">(</span>s-blank? x<span class="rainbow-delimiters-depth-1-face">)</span> nil x<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span>t what<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> result
        result
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> alternative
          <span class="rainbow-delimiters-depth-5-face">(</span>im-region-or alternative<span class="rainbow-delimiters-depth-5-face">)</span>
        result<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">get-integer-at-cursor</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get the integer at the cursor.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>start <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-7-face">(</span>skip-chars-backward <span class="string">&quot;0-9&quot;</span><span class="rainbow-delimiters-depth-7-face">) (</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>end <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-7-face">(</span>skip-chars-forward <span class="string">&quot;0-9&quot;</span><span class="rainbow-delimiters-depth-7-face">) (</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>string-to-number <span class="rainbow-delimiters-depth-5-face">(</span>buffer-substring start end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-inner-back-quote-at-point</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return text inside the back quotes at point.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>bounds <span class="rainbow-delimiters-depth-5-face">(</span>evil-inner-back-quote<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>buffer-substring-no-properties
     <span class="rainbow-delimiters-depth-4-face">(</span>nth 0 bounds<span class="rainbow-delimiters-depth-4-face">)
     (</span>nth 1 bounds<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-shell-command-to-string</span> <span class="rainbow-delimiters-depth-2-face">(</span>cmd<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">shell-command-to-string</span><span class="doc">' but only stdout is returned.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>string-trim
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-output-to-string</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">with-current-buffer</span> standard-output
       <span class="rainbow-delimiters-depth-5-face">(</span>process-file
        shell-file-name nil <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span>t nil<span class="rainbow-delimiters-depth-6-face">)</span>  nil shell-command-switch
        cmd<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-serialize-into-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>file data<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>f-exists? <span class="rainbow-delimiters-depth-4-face">(</span>f-dirname file<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>f-mkdir-full-path <span class="rainbow-delimiters-depth-4-face">(</span>f-dirname file<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-temp-file</span> <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name file<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>print-length nil<span class="rainbow-delimiters-depth-5-face">)
          (</span>print-level nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>prin1 data <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-deserialize-from-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>file<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fpath <span class="rainbow-delimiters-depth-5-face">(</span>expand-file-name file<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span>file-exists-p fpath<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">with-temp-buffer</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>insert-file-contents fpath<span class="rainbow-delimiters-depth-5-face">)
        (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>read <span class="rainbow-delimiters-depth-6-face">(</span>current-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> Add a way to invalidate the file after given date
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defmacro</span> <span class="function-name">defmemoizefile</span> <span class="rainbow-delimiters-depth-2-face">(</span>name arglist file <span class="type">&amp;rest</span> body<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like a normal memoize function but persist the memoize cache to
a file so that when Emacs is opened freshly, it'll continue using
the memoize cache.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 3<span class="rainbow-delimiters-depth-3-face">) (</span>doc-string 4<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>origfn <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="rainbow-delimiters-depth-7-face">(</span>symbol-name name<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;---defmemoizefile-origfn&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>memoizemap <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="rainbow-delimiters-depth-7-face">(</span>symbol-name name<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;---defmemoizefile-memoizemap&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> ,memoizemap <span class="rainbow-delimiters-depth-5-face">(</span>make-hash-table <span class="builtin">:test</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>file-exists-p <span class="rainbow-delimiters-depth-6-face">(</span>expand-file-name ,file<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">setq</span> ,memoizemap <span class="rainbow-delimiters-depth-6-face">(</span>im-deserialize-from-file ,file<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)

       (</span><span class="keyword">defun</span> ,origfn ,arglist
         ,@body<span class="rainbow-delimiters-depth-4-face">)

       (</span><span class="keyword">defun</span> ,name <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> ___args<span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>memoizedresult <span class="rainbow-delimiters-depth-8-face">(</span>gethash ___args ,memoizemap<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
             memoizedresult
           <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>___result <span class="rainbow-delimiters-depth-9-face">(</span>apply <span class="highlight-quoted-quote">#'</span>,origfn ___args<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>map-put! ,memoizemap ___args ___result<span class="rainbow-delimiters-depth-7-face">)
             (</span>im-serialize-into-file ,file ,memoizemap<span class="rainbow-delimiters-depth-7-face">)</span>
             ___result<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-select-window-with-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Select the visible window that matches given BUFFER-NAME.
If more than one buffer is matched, then let user interactively
select the right window using `</span><span class="constant">aw-select</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>curr <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name <span class="rainbow-delimiters-depth-6-face">(</span>current-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>windows <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--filter</span>
                   <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">-as-&gt;</span> <span class="rainbow-delimiters-depth-7-face">(</span>window-buffer it<span class="rainbow-delimiters-depth-7-face">)</span> buffer
                          <span class="rainbow-delimiters-depth-7-face">(</span>buffer-name buffer<span class="rainbow-delimiters-depth-7-face">)
                          (</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-8-face">(</span>string-match buffer-name buffer<span class="rainbow-delimiters-depth-8-face">) (</span>not <span class="rainbow-delimiters-depth-9-face">(</span>equal curr buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                   (</span>window-list<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>select-window
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>= 1 <span class="rainbow-delimiters-depth-6-face">(</span>length windows<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span>car windows<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">cl-letf</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>symbol-function <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">aw-window-list</span><span class="rainbow-delimiters-depth-8-face">) (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">() (</span>sort <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-1-face">(</span>,@windows ,<span class="rainbow-delimiters-depth-2-face">(</span>selected-window<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">aw-window&lt;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>aw-select nil<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-with-visible-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer-name <span class="type">&amp;rest</span> body<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Evaluate BODY within the BUFFER-NAME that is currently visible.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-selected-window</span> <span class="rainbow-delimiters-depth-3-face">(</span>selected-window<span class="rainbow-delimiters-depth-3-face">)
     (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-select-window-with-buffer ,buffer-name<span class="rainbow-delimiters-depth-4-face">)</span>
       ,@body<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-sync-async-command-to-string</span> <span class="rainbow-delimiters-depth-2-face">(</span>command <span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run async command and wait until it's finished. This may seem stupid but I had to use it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>process <span class="rainbow-delimiters-depth-6-face">(</span>apply <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">start-process</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;sync-async-proc&quot;</span> ,<span class="rainbow-delimiters-depth-8-face">(</span>current-buffer<span class="rainbow-delimiters-depth-8-face">)</span> ,command ,@args<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span>process-live-p process<span class="rainbow-delimiters-depth-5-face">)
        (</span>sit-for 0.1<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-plist-to-alist</span> <span class="rainbow-delimiters-depth-2-face">(</span>plist<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert PLIST to an alist.
Taken from transient.el.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> plist
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-5-face">(</span>cons <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>symbol <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">pop</span> plist<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                         (</span>name <span class="rainbow-delimiters-depth-9-face">(</span>symbol-name symbol<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>eq <span class="rainbow-delimiters-depth-9-face">(</span>aref name 0<span class="rainbow-delimiters-depth-9-face">)</span> ?:<span class="rainbow-delimiters-depth-8-face">)
                        (</span>intern <span class="rainbow-delimiters-depth-9-face">(</span>substring name 1<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                      symbol<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="keyword">pop</span> plist<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
            alist<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>nreverse alist<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">let-plist</span> <span class="rainbow-delimiters-depth-2-face">(</span>plist <span class="type">&amp;rest</span> form<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">let-alist</span><span class="doc">' but for plists.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let-alist</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-plist-to-alist ,plist<span class="rainbow-delimiters-depth-3-face">)</span>
     ,@form<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-mimetype</span> <span class="rainbow-delimiters-depth-2-face">(</span>path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return mimetype of given file at PATH.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>string-trim <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;file --brief --mime-type '</span><span class="constant">%s</span><span class="string">'&quot;</span> path<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-to-keyword</span> <span class="rainbow-delimiters-depth-2-face">(</span>it<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert given string or symbol to a :keyword.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">thread-last</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>stringp it<span class="rainbow-delimiters-depth-5-face">)</span> it<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>symbolp it<span class="rainbow-delimiters-depth-5-face">) (</span>symbol-name it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>t <span class="rainbow-delimiters-depth-5-face">(</span><span class="warning">error</span> <span class="string">&quot;Trying to convert %s to symbol&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>string-remove-prefix <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>concat <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>downcase<span class="rainbow-delimiters-depth-3-face">)
    (</span>intern<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-alist-to-plist</span> <span class="rainbow-delimiters-depth-2-face">(</span>alist<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert association list ALIST into the equivalent property-list form.
The plist is returned.  This converts from

\((a . 1) (b . 2) (c . 3))

into

\(:a 1 :b 2 :c 3)

The original alist is not modified.

This function is taken from `</span><span class="constant">mm-decode.el</span><span class="doc">' and modified.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>plist<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> alist
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>el <span class="rainbow-delimiters-depth-7-face">(</span>car alist<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> plist <span class="rainbow-delimiters-depth-6-face">(</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>cdr el<span class="rainbow-delimiters-depth-7-face">) (</span>cons <span class="rainbow-delimiters-depth-8-face">(</span>im-to-keyword <span class="rainbow-delimiters-depth-9-face">(</span>car el<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> plist<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> alist <span class="rainbow-delimiters-depth-5-face">(</span>cdr alist<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>nreverse plist<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">λ-interactive</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> body<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Useful for defining keybindings.&quot;</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">() (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-3-face">)</span> ,@body<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kill</span> <span class="rainbow-delimiters-depth-2-face">(</span>x <span class="type">&amp;optional</span> replace<span class="rainbow-delimiters-depth-2-face">)
  (</span>kill-new x replace<span class="rainbow-delimiters-depth-2-face">)</span>
  x<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-force-focus-emacs</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Focus Emacs frame if not focused already.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">im-when-on</span>
     <span class="builtin">:darwin</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string
      <span class="string">&quot;osascript -e 'tell application \&quot;System Events\&quot; to click UI element \&quot;Emacs\&quot; of list 1 of application process \&quot;Dock\&quot;'&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:linux</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="warning">user-error</span> <span class="string">&quot;Implement this: im-force-focus-emacs&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-line-count-below-cursor</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return the number of lines displayed below the cursor in the current window.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>line <span class="rainbow-delimiters-depth-5-face">(</span>line-number-at-pos<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>move-to-window-line 0<span class="rainbow-delimiters-depth-4-face">)
      (</span>- <span class="rainbow-delimiters-depth-5-face">(</span>window-height<span class="rainbow-delimiters-depth-5-face">) (</span>- line <span class="rainbow-delimiters-depth-6-face">(</span>line-number-at-pos<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Configuration utilities
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-apply-patch-from-src-block</span> <span class="rainbow-delimiters-depth-2-face">(</span>block-point-or-name target-folder<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Apply the patch at src block BLOCK-POINT-OR-NAME to TARGET-FOLDER.
I keep some of my changes to packages as in patch format and this
simplifies applying those patches.  I try to utilize advices most
of the time but this is for those times where advices either
complicates things or not sufficient.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-5-face">(</span>x <span class="rainbow-delimiters-depth-6-face">(</span>org-babel-where-is-src-block-head<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                         x
                       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-excursion</span>
                         <span class="rainbow-delimiters-depth-6-face">(</span>org-babel-goto-named-src-block <span class="rainbow-delimiters-depth-7-face">(</span>read-string <span class="string">&quot;Block name: &quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                         (</span>point<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>stringp block-point-or-name<span class="rainbow-delimiters-depth-4-face">)
        (</span>org-babel-goto-named-result block-point-or-name<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char block-point-or-name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>block-content <span class="rainbow-delimiters-depth-6-face">(</span>org-element-property <span class="builtin">:value</span> <span class="rainbow-delimiters-depth-7-face">(</span>org-element-at-point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>filename <span class="rainbow-delimiters-depth-6-face">(</span>make-temp-file <span class="string">&quot;temp&quot;</span> nil <span class="string">&quot;.patch&quot;</span> block-content<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>default-directory target-folder<span class="rainbow-delimiters-depth-5-face">)
           (</span>patch-command <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;patch -p1 &lt; %s&quot;</span> filename<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>patch-command-result <span class="rainbow-delimiters-depth-6-face">(</span>shell-command-to-string patch-command<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>string-match-p <span class="string">&quot;^patching file&quot;</span> patch-command-result<span class="rainbow-delimiters-depth-5-face">)
          (</span>message <span class="string">&quot;Patch applied successfully:\n%s&quot;</span> patch-command-result<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="warning">error</span> <span class="string">&quot;Error applying patch:\n%s&quot;</span> patch-command-result<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-tangle-file</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> doc path contents<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Tangle CONTENTS into PATH.
DOC is simply for documentation, have no specific use.  If CONTENTS has
a shebang at the beginning, then the executable bit is set to file.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>make-directory <span class="rainbow-delimiters-depth-3-face">(</span>file-name-directory path<span class="rainbow-delimiters-depth-3-face">)</span> t<span class="rainbow-delimiters-depth-2-face">)
  (</span>write-region <span class="rainbow-delimiters-depth-3-face">(</span>concat contents <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> nil path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Make it executable if needed
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>s-matches? <span class="string">&quot;^[ \t]*#!&quot;</span> contents<span class="rainbow-delimiters-depth-3-face">)
    (</span>set-file-modes path <span class="rainbow-delimiters-depth-4-face">(</span>file-modes-symbolic-to-number <span class="string">&quot;+x&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>file-modes path<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Elisp utils
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defmacro</span> <span class="function-name">im-tap</span> <span class="rainbow-delimiters-depth-2-face">(</span>form<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Evaluate FORM and return its result.
Additionally, print a message to the *Messages* buffer showing
the form and its result.

This macro is useful for debugging and inspecting the
intermediate results of Elisp code without changing your code
structure. Just wrap the form with `</span><span class="constant">im-tap</span><span class="doc">' that you want to see
it's output without introducing an intermediate let-form.&quot;</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>result ,form<span class="rainbow-delimiters-depth-4-face">)
         (</span>print-length nil<span class="rainbow-delimiters-depth-4-face">)
         (</span>print-level nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>message <span class="string">&quot;[im-tap :: %s] → %s&quot;</span> ,<span class="rainbow-delimiters-depth-4-face">(</span>prin1-to-string form<span class="rainbow-delimiters-depth-4-face">)</span> result<span class="rainbow-delimiters-depth-3-face">)</span>
     result<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-inspect</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-debug</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-debug</span> <span class="rainbow-delimiters-depth-2-face">(</span>thing<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-tap</span><span class="doc">' but uses `</span><span class="constant">pp-display-expression</span><span class="doc">' to display the
result instead of `</span><span class="constant">message</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>print-length nil<span class="rainbow-delimiters-depth-4-face">)
        (</span>print-level nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>pp-display-expression thing <span class="string">&quot;*im-debug*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  thing<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-append!</span> <span class="rainbow-delimiters-depth-2-face">(</span>lst item<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Append ITEM to end of the LST.
Modifies LST. Only meant to be used in configuration.&quot;</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> ,lst <span class="rainbow-delimiters-depth-3-face">(</span>append ,lst <span class="rainbow-delimiters-depth-4-face">(</span>list ,item<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-elisp-find-file-prefix</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Extract prefix from defgroup statement in current buffer.
I use this in my `</span><span class="constant">defun</span><span class="doc">' snippet via yasnippet.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-4-face">(</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>search-forward-regexp <span class="string">&quot;:prefix \&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\&quot;&quot;</span> nil t<span class="rainbow-delimiters-depth-5-face">)
          (</span>match-string 1<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
      <span class="string">&quot;im-&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-open-region-in-temp-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>content<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Open CONTENT (selected region or given string) in a temporary buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>im-region-or <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">string</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>switch-to-buffer <span class="rainbow-delimiters-depth-3-face">(</span>generate-new-buffer <span class="string">&quot;*temp-region*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>insert content<span class="rainbow-delimiters-depth-2-face">)
  (</span>switch-to-buffer <span class="rainbow-delimiters-depth-3-face">(</span>current-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kill-this-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Kill current buffer.
Function `</span><span class="constant">kill-this-buffer</span><span class="doc">' does not work reliably.  See
documentation of it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kill-buffer <span class="rainbow-delimiters-depth-3-face">(</span>current-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-add-to-path</span> <span class="rainbow-delimiters-depth-2-face">(</span>path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Add given PATH to PATH variable.
Useful for adding something to Emacs' PATH without restarting it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sPath: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">exec-path</span> <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name path<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>setenv <span class="string">&quot;PATH&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>concat <span class="rainbow-delimiters-depth-4-face">(</span>getenv <span class="string">&quot;PATH&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>expand-file-name path<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-get-reset-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create BUFFER and return it.
If it exists, it's killed first and return a new buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-3-face">(</span>kill-buffer buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>get-buffer-create buffer<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Clipboard functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-clipboard-contains-image-p</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Check whether the clipboard has image or not.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>locate-file <span class="string">&quot;wl-paste&quot;</span> exec-path<span class="rainbow-delimiters-depth-4-face">)
    (</span>s-contains? <span class="string">&quot;image/&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string <span class="string">&quot;wl-paste --list-types&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>locate-file <span class="string">&quot;xclip&quot;</span> exec-path<span class="rainbow-delimiters-depth-4-face">)
    (</span>s-contains? <span class="string">&quot;image/&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>im-sync-async-command-to-string <span class="string">&quot;xclip&quot; &quot;-o&quot; &quot;-sel&quot; &quot;c&quot; &quot;-t&quot; &quot;TARGETS&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>locate-file <span class="string">&quot;pngpaste&quot;</span> exec-path<span class="rainbow-delimiters-depth-4-face">)
    (</span>eq <span class="rainbow-delimiters-depth-5-face">(</span>shell-command <span class="string">&quot;pngpaste - &amp;&gt;/dev/null&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> 0<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-save-clipboard-image-to-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>file<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Save the image in clipboard (if there is any) to given FILE.
Also see `</span><span class="constant">im-clipboard-contains-image-p</span><span class="doc">' to check if there is one.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;FFile to save the image: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>shell-command
   <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;%s &gt; %s&quot;</span>
           <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">cond</span>
            <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>locate-file <span class="string">&quot;wl-paste&quot;</span> exec-path<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;wl-paste&quot;</span><span class="rainbow-delimiters-depth-5-face">)
            (</span><span class="rainbow-delimiters-depth-6-face">(</span>locate-file <span class="string">&quot;xclip&quot;</span> exec-path<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;xclip -selection clipboard -target image/png -out&quot;</span><span class="rainbow-delimiters-depth-5-face">)
            (</span><span class="rainbow-delimiters-depth-6-face">(</span>locate-file <span class="string">&quot;pngpaste&quot;</span> exec-path<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;pngpaste -&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
           file<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> User input
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-get-input</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> <span class="rainbow-delimiters-depth-3-face">(</span>mode <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-3-face">)
                             (</span>init <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
                             on-accept
                             on-reject
                             pre-process<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Display a buffer to user to enter some input.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="string">&quot;*im-input*&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>success-handler <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()
                            (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-6-face">)
                            (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>pre-proc-result <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when</span> pre-process
                                                     <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-current-buffer</span> buffer
                                                       <span class="rainbow-delimiters-depth-2-face">(</span>funcall pre-process<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                                  (</span>result <span class="rainbow-delimiters-depth-9-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-1-face">(</span>buffer-string<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                              (</span>kill-buffer buffer<span class="rainbow-delimiters-depth-7-face">)
                              (</span><span class="keyword">if</span> pre-process
                                  <span class="rainbow-delimiters-depth-8-face">(</span>funcall on-accept result pre-proc-result<span class="rainbow-delimiters-depth-8-face">)
                                (</span>funcall on-accept result<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>reject-handler <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()
                           (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-6-face">)
                           (</span>kill-buffer buffer<span class="rainbow-delimiters-depth-6-face">)
                           (</span><span class="keyword">when</span> on-reject
                             <span class="rainbow-delimiters-depth-7-face">(</span>funcall on-reject<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> buffer
      <span class="rainbow-delimiters-depth-4-face">(</span>funcall mode<span class="rainbow-delimiters-depth-4-face">)
      (</span>use-local-map <span class="rainbow-delimiters-depth-5-face">(</span>copy-keymap <span class="rainbow-delimiters-depth-6-face">(</span>current-local-map<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>local-set-key <span class="rainbow-delimiters-depth-5-face">(</span>kbd <span class="string">&quot;C-c C-c&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> success-handler<span class="rainbow-delimiters-depth-4-face">)
      (</span>local-set-key <span class="rainbow-delimiters-depth-5-face">(</span>kbd <span class="string">&quot;C-c C-k&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> reject-handler<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> header-line-format <span class="string">&quot;Hit `C-c C-c' to save `C-c C-k' to reject.&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert init<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-alist-completing-read</span> <span class="rainbow-delimiters-depth-2-face">(</span>prompt alist <span class="type">&amp;optional</span> initial<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">completing-read</span><span class="doc">' but returns value of the selected key in given ALIST.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>alist-get
   <span class="rainbow-delimiters-depth-3-face">(</span>completing-read prompt alist nil nil initial<span class="rainbow-delimiters-depth-3-face">)</span>
   alist nil nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-completing-read</span>
    <span class="rainbow-delimiters-depth-2-face">(</span>prompt objects <span class="type">&amp;key</span> <span class="rainbow-delimiters-depth-3-face">(</span>formatter <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">identity</span><span class="rainbow-delimiters-depth-3-face">)</span> category <span class="rainbow-delimiters-depth-3-face">(</span>sort? t<span class="rainbow-delimiters-depth-3-face">)</span> def multiple?<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Provide an interactive completion interface for selecting an item from a list of objects.

- PROMPT: The prompt string to display to the user.
- OBJECTS: A list of objects to choose from.
- FORMATTER: (Optional) A function that formats each object
  before displaying it to the user. The default is `'</span><span class="constant">identity</span><span class="doc">',
  which means no formatting.
- CATEGORY: (Optional) A category symbol associated with the
  completion. This can be used to provide additional completion
  behavior.
- SORT?: (Optional) A boolean value indicating whether the
  completion list should be sorted. The default is t.
- DEF: (Optional) The default value to return if no selection is
  made. If multiple selections are allowed, this value will be
  returned as a list.
- MULTIPLE?: (Optional) A boolean value indicating whether
  multiple selections are allowed. The default is `nil`.

If MULTIPLE? is nil, this function returns the selected object
from the completion list. If MULTIPLE? is t, this function
returns a list of selected objects. If no selection is made, the
DEF value is returned.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>object-table
          <span class="rainbow-delimiters-depth-5-face">(</span>make-hash-table <span class="builtin">:test</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">equal</span> <span class="builtin">:size</span> <span class="rainbow-delimiters-depth-6-face">(</span>length objects<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>object-strings
          <span class="rainbow-delimiters-depth-5-face">(</span>mapcar
           <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>object<span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>formatted-object <span class="rainbow-delimiters-depth-1-face">(</span>funcall formatter object<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
               (</span>puthash formatted-object object object-table<span class="rainbow-delimiters-depth-8-face">)
               (</span>propertize formatted-object <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">empv-item</span> object<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
           objects<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>selected
          <span class="rainbow-delimiters-depth-5-face">(</span>funcall
           <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> multiple? <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">completing-read-multiple</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">completing-read</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>format <span class="string">&quot;%s &quot;</span> prompt<span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>string predicate action<span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>eq action <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">metadata</span><span class="rainbow-delimiters-depth-8-face">)</span>
                 <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-8-face">(</span>metadata
                   ,<span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when</span> category <span class="rainbow-delimiters-depth-1-face">(</span>cons <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">category</span> category<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
                   ,@<span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">unless</span> sort?
                       <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>display-sort-function . identity<span class="rainbow-delimiters-depth-2-face">)
                         (</span>cycle-sort-function . identity<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
               (</span>complete-with-action
                action object-strings string predicate<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> multiple?
        <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-5-face">(</span>mapcar <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>it<span class="rainbow-delimiters-depth-7-face">) (</span>gethash it object-table<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> selected<span class="rainbow-delimiters-depth-5-face">)</span> def<span class="rainbow-delimiters-depth-4-face">)
      (</span>gethash selected object-table <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> def selected<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)


(</span><span class="keyword">defun</span> <span class="function-name">im-dmenu</span> <span class="rainbow-delimiters-depth-2-face">(</span>prompt items <span class="type">&amp;rest</span> _ignored<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">completing-read</span><span class="doc">' but instead use dmenu.
Useful for system-wide scripts.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">thread-first</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">cond</span>
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>functionp items<span class="rainbow-delimiters-depth-6-face">)
        (</span>funcall items <span class="string">&quot;&quot;</span> nil t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="rainbow-delimiters-depth-6-face">(</span>listp <span class="rainbow-delimiters-depth-7-face">(</span>car items<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span> items<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>t
        items<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>string-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
      string-trim
      insert<span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command-on-region
     <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)
     (</span>point-max<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">im-when-on</span>
      <span class="builtin">:linux</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;rofi -dmenu -fuzzy -i -p '</span><span class="constant">%s</span><span class="string">'&quot;</span> prompt<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="builtin">:darwin</span> <span class="string">&quot;choose&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     nil t <span class="string">&quot;*im-dmenu error*&quot;</span> nil<span class="rainbow-delimiters-depth-3-face">)
    (</span>string-trim <span class="rainbow-delimiters-depth-4-face">(</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defmacro</span> <span class="function-name">im-output-select</span>
    <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> cmd prompt keep-order
          <span class="rainbow-delimiters-depth-3-face">(</span>formatter <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">it</span><span class="rainbow-delimiters-depth-3-face">)
          (</span>split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
          (</span>drop 0<span class="rainbow-delimiters-depth-3-face">)
          (</span>filter t<span class="rainbow-delimiters-depth-3-face">)
          (</span>map <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">it</span><span class="rainbow-delimiters-depth-3-face">) (</span><span class="keyword">do</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">it</span><span class="rainbow-delimiters-depth-3-face">)</span> category<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given CMD and do a `</span><span class="constant">completing-read</span><span class="doc">' on it.
This macro is intended to quicken up the process of running a
shell command and doing a `</span><span class="constant">completing-read</span><span class="doc">' on it and then using
the result in another context, possibly on another shell
command.&quot;</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>it<span class="rainbow-delimiters-depth-4-face">)</span> ,do<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-completing-read
     ,prompt
     <span class="rainbow-delimiters-depth-4-face">(</span>seq-filter
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>it<span class="rainbow-delimiters-depth-6-face">)</span> ,filter<span class="rainbow-delimiters-depth-5-face">)
      (</span>seq-map-indexed
       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>it idx<span class="rainbow-delimiters-depth-7-face">)</span> ,map<span class="rainbow-delimiters-depth-6-face">)
       (</span>seq-drop
        <span class="rainbow-delimiters-depth-7-face">(</span>s-split
         ,split
         <span class="rainbow-delimiters-depth-8-face">(</span>shell-command-to-string ,cmd<span class="rainbow-delimiters-depth-8-face">)</span>
         t<span class="rainbow-delimiters-depth-7-face">)</span>
        ,drop<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:formatter</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>it<span class="rainbow-delimiters-depth-5-face">)</span> ,formatter<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:sort?</span> ,<span class="rainbow-delimiters-depth-4-face">(</span>not keep-order<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:category</span> ,category<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-read-string</span> <span class="rainbow-delimiters-depth-2-face">(</span>prompt <span class="type">&amp;rest</span> rest<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">read-string</span><span class="doc">' but returns `</span><span class="constant">nil</span><span class="doc">' on empty input.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>result <span class="rainbow-delimiters-depth-5-face">(</span>string-trim <span class="rainbow-delimiters-depth-6-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">read-string</span> prompt rest<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>string-equal result <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
        nil
      result<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> String utils
</span>
<span class="comment-delimiter">;; </span><span class="comment">Source: https://gist.github.com/jordonbiondo/c4e22b4289be130bc59b
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defmacro</span> <span class="function-name">im-s-interpolated</span> <span class="rainbow-delimiters-depth-2-face">(</span>str<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Elisp string interpolation.
Uses #{elisp-code} syntax.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>exprs nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-temp-buffer</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>insert str<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char 1<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span>re-search-forward <span class="string">&quot;#{&quot;</span> nil t 1<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>here <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>emptyp <span class="rainbow-delimiters-depth-8-face">(</span>eql <span class="rainbow-delimiters-depth-9-face">(</span>char-after<span class="rainbow-delimiters-depth-9-face">)</span> ?}<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">unless</span>  emptyp <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-8-face">(</span>read <span class="rainbow-delimiters-depth-9-face">(</span>buffer-substring <span class="rainbow-delimiters-depth-1-face">(</span>point<span class="rainbow-delimiters-depth-1-face">) (</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-2-face">(</span>forward-sexp 1<span class="rainbow-delimiters-depth-2-face">) (</span>point<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> exprs<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>delete-region <span class="rainbow-delimiters-depth-7-face">(</span>- here 2<span class="rainbow-delimiters-depth-7-face">) (</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-8-face">(</span>search-forward <span class="string">&quot;}&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>point<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">unless</span> emptyp <span class="rainbow-delimiters-depth-7-face">(</span>insert <span class="string">&quot;%s&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-7-face">(</span>forward-char 1<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>append <span class="rainbow-delimiters-depth-5-face">(</span>list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">format</span> <span class="rainbow-delimiters-depth-6-face">(</span>buffer-string<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">) (</span>reverse exprs<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-s-upcase-until</span> <span class="rainbow-delimiters-depth-2-face">(</span>until s<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Make prefix of a string S uppercase until given char UNTIL.
`(im-s-upcase-until \&quot;-\&quot; \&quot;aha-hehe\&quot;)' -&gt; \&quot;AHA-hehe\&quot;&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>end <span class="rainbow-delimiters-depth-5-face">(</span>s-index-of until s<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>concat
     <span class="rainbow-delimiters-depth-4-face">(</span>s-upcase <span class="rainbow-delimiters-depth-5-face">(</span>substring s 0 end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>substring s end<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-string-url-case</span> <span class="rainbow-delimiters-depth-2-face">(</span>str<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert STR to something like `</span><span class="constant">a-string-appropriate-for-urls</span><span class="doc">'.
&gt;&gt; (im-string-url-case \&quot; test: test! şeyler ÜPPERCaSE   vs.\&quot;)
=&gt; \&quot;test-test-seyler-uppercase-vs\&quot;&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span>
   str
   downcase
   <span class="rainbow-delimiters-depth-3-face">(</span>s-replace-all
    <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;'&quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ö&quot;</span> . <span class="string">&quot;o&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ı&quot;</span> . <span class="string">&quot;i&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ğ&quot;</span> . <span class="string">&quot;g&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ü&quot;</span> . <span class="string">&quot;u&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ş&quot;</span> . <span class="string">&quot;s&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ö&quot;</span> . <span class="string">&quot;o&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ç&quot;</span> . <span class="string">&quot;c&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>s-trim<span class="rainbow-delimiters-depth-3-face">)
   (</span>replace-regexp-in-string <span class="string">&quot;[</span><span class="negation-char">^</span><span class="string">a-zA-Z0-9]&quot; &quot;-&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>replace-regexp-in-string <span class="string">&quot;-+&quot; &quot;-&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>s-chop-prefix <span class="string">&quot;-&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>s-chop-suffix <span class="string">&quot;-&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-human-readable-size</span> <span class="rainbow-delimiters-depth-2-face">(</span>size-in-bytes<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>units <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;B&quot; &quot;KB&quot; &quot;MB&quot; &quot;GB&quot; &quot;TB&quot; &quot;PB&quot; &quot;EB&quot; &quot;ZB&quot; &quot;YB&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>unit <span class="rainbow-delimiters-depth-5-face">(</span>car units<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>bytes <span class="rainbow-delimiters-depth-5-face">(</span>float size-in-bytes<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>exponent <span class="rainbow-delimiters-depth-5-face">(</span>floor <span class="rainbow-delimiters-depth-6-face">(</span>log bytes 1024<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> units <span class="rainbow-delimiters-depth-4-face">(</span>cdr units<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-4-face">(</span>&gt; exponent 0<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> bytes <span class="rainbow-delimiters-depth-5-face">(</span>/ bytes 1024.0<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> exponent <span class="rainbow-delimiters-depth-5-face">(</span>1- exponent<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> unit <span class="rainbow-delimiters-depth-5-face">(</span>car units<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> units <span class="rainbow-delimiters-depth-5-face">(</span>cdr units<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>format <span class="string">&quot;%.2f %s&quot;</span> bytes unit<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-non-blank-or-nil</span> <span class="rainbow-delimiters-depth-2-face">(</span>x<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">and</span> x <span class="rainbow-delimiters-depth-4-face">(</span>s-blank-str? x<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
      nil
    x<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> List/hash-table/vector utils
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-hash-table-to-alist</span> <span class="rainbow-delimiters-depth-2-face">(</span>val<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Bad way to convert hash-tables with vectors into alists.
I use this only for debugging.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>hash-table-p val<span class="rainbow-delimiters-depth-4-face">) (</span>im-hash-table-to-alist <span class="rainbow-delimiters-depth-5-face">(</span>ht-to-alist val<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>vectorp val<span class="rainbow-delimiters-depth-4-face">) (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-hash-table-to-alist</span> <span class="rainbow-delimiters-depth-5-face">(</span>cl-coerce val <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>json-alist-p val<span class="rainbow-delimiters-depth-4-face">) (</span>map-apply <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>key it<span class="rainbow-delimiters-depth-6-face">) (</span>cons key <span class="rainbow-delimiters-depth-7-face">(</span>im-hash-table-to-alist it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> val<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>listp val<span class="rainbow-delimiters-depth-4-face">) (</span>mapcar <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>key it<span class="rainbow-delimiters-depth-6-face">) (</span>cons key <span class="rainbow-delimiters-depth-7-face">(</span>im-hash-table-to-alist it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> val<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t val<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Quick table
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-output-to-tabulated-list</span> <span class="rainbow-delimiters-depth-2-face">(</span>str <span class="type">&amp;key</span> buffer <span class="rainbow-delimiters-depth-3-face">(</span>sep <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> buffer
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>lines <span class="rainbow-delimiters-depth-6-face">(</span>s-split <span class="string">&quot;\n&quot;</span> str t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>header-items <span class="rainbow-delimiters-depth-6-face">(</span>s-split sep <span class="rainbow-delimiters-depth-7-face">(</span>car lines<span class="rainbow-delimiters-depth-7-face">)</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>header <span class="rainbow-delimiters-depth-6-face">(</span>cl-coerce <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-8-face">(</span>list it <span class="rainbow-delimiters-depth-9-face">(</span>/ 100 <span class="rainbow-delimiters-depth-1-face">(</span>length header-items<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> nil<span class="rainbow-delimiters-depth-8-face">)</span> header-items<span class="rainbow-delimiters-depth-7-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vector</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>rows <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">thread-last</span> lines
                    <span class="rainbow-delimiters-depth-7-face">(</span>-drop 1<span class="rainbow-delimiters-depth-7-face">)
                    (</span><span class="keyword">--map-indexed</span> <span class="rainbow-delimiters-depth-8-face">(</span>list <span class="rainbow-delimiters-depth-9-face">(</span>number-to-string it-index<span class="rainbow-delimiters-depth-9-face">) (</span>cl-coerce <span class="rainbow-delimiters-depth-1-face">(</span>s-split sep it t<span class="rainbow-delimiters-depth-1-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vector</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>tabulated-list-mode<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> tabulated-list-format header<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> tabulated-list-entries rows<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> tabulated-list-padding 4<span class="rainbow-delimiters-depth-4-face">)
      (</span>tabulated-list-init-header<span class="rainbow-delimiters-depth-4-face">)
      (</span>tabulated-list-print t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> UI utilities
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-insert-toggle-button</span> <span class="rainbow-delimiters-depth-2-face">(</span>state1 state2 <span class="type">&amp;key</span> help on-toggle<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Insert a button that change it's text from STATE1 to STATE2 when clicked.
HELP is displayed when cursor is on the button and
`</span><span class="constant">im-help-at-point-mode</span><span class="doc">' is enabled.

ON-TOGGLE is called when user toggles the button.  It will be
called with the current state of the button.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>insert-text-button
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>functionp state1<span class="rainbow-delimiters-depth-4-face">) (</span>funcall state1<span class="rainbow-delimiters-depth-4-face">)</span> state1<span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">action</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>button<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>start <span class="rainbow-delimiters-depth-7-face">(</span>button-start button<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>end <span class="rainbow-delimiters-depth-7-face">(</span>button-end button<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>cursor <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>delete-region start end<span class="rainbow-delimiters-depth-5-face">)
       (</span>im-insert-toggle-button state2 state1 <span class="builtin">:help</span> help <span class="builtin">:on-toggle</span> on-toggle<span class="rainbow-delimiters-depth-5-face">)
       (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>&lt; cursor <span class="rainbow-delimiters-depth-8-face">(</span>+ start <span class="rainbow-delimiters-depth-9-face">(</span>length state2<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span> cursor start<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">when</span> on-toggle
         <span class="rainbow-delimiters-depth-6-face">(</span>funcall on-toggle state2<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">kbd-help</span> help
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">follow-link</span> t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> API call
</span>
<span class="comment-delimiter">;; </span><span class="comment">This function is for doing easy REST calls and it uses plists for
</span><span class="comment-delimiter">;; </span><span class="comment">everything because it's more readable and easier to type than
</span><span class="comment-delimiter">;; </span><span class="comment">alists (but you can still use alists if you want or need to). I use
</span><span class="comment-delimiter">;; </span><span class="comment">this to quickly prototype stuff in elisp.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-request</span>
    <span class="rainbow-delimiters-depth-2-face">(</span>endpoint
     <span class="type">&amp;rest</span> params
     <span class="type">&amp;key</span> <span class="rainbow-delimiters-depth-3-face">(</span>-type <span class="string">&quot;GET&quot;</span><span class="rainbow-delimiters-depth-3-face">) (</span>-headers<span class="rainbow-delimiters-depth-3-face">) (</span>-data<span class="rainbow-delimiters-depth-3-face">) (</span>-params<span class="rainbow-delimiters-depth-3-face">) (</span>-async?<span class="rainbow-delimiters-depth-3-face">) (</span>-on-success<span class="rainbow-delimiters-depth-3-face">) (</span>-on-error<span class="rainbow-delimiters-depth-3-face">) (</span>-raw<span class="rainbow-delimiters-depth-3-face">)</span>
     <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">request</span><span class="doc">' but plist and JSON oriented. JSON responses are
automatically parsed, query parameters are constructed from
top-level keywords, request body can be a plist (which will be
serialized into JSON). Examples:

    (im-request \&quot;some/endpoint\&quot;)

With url parameters:

    (im-request \&quot;...\&quot; :query \&quot;test\&quot; :page 3 :page_size 15)

If you want to pass an alist as url params:

    (im-request \&quot;...\&quot; :-params </span><span class="builtin">\\=</span><span class="doc">'((query . \&quot;test\&quot;) (page . 3) (page_size . 15)))

POST with json body:

    (im-request \&quot;...\&quot; :-type </span><span class="builtin">\\=</span><span class="doc">'POST :-data </span><span class="builtin">\\=</span><span class="doc">'(:key1 1 :key2 2))

With some HTTP headers:

    (im-request \&quot;...\&quot; :-headers </span><span class="builtin">\\=</span><span class="doc">'(:Authorization \&quot;Bearer e21ewqfasdwtkl\&quot;))

For async requests, simply provide a success handler:

    (im-request \&quot;...\&quot;
      :-on-success (cl-function
                  (lambda (&amp;key data &amp;allow-other-keys)
                    ...use the parsed json DATA...)))&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent defun<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;URL: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="builtin">:-raw</span> t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>json
        <span class="rainbow-delimiters-depth-4-face">(</span>json-object-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">alist</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>json-array-type <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>json-key-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">symbol</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>

    <span class="comment-delimiter">;; </span><span class="comment">Remove request related items from params list
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">dolist</span> <span class="rainbow-delimiters-depth-4-face">(</span>key <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:-type :-headers :-data :-params :-async? :-on-success :-raw :-on-error</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">cl-remf</span> params key<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>fn <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>resolve reject<span class="rainbow-delimiters-depth-7-face">)
                (</span>request
                  endpoint
                  <span class="builtin">:type</span> -type
                  <span class="builtin">:headers</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">cond</span>
                            <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">and</span> -headers <span class="rainbow-delimiters-depth-2-face">(</span>json-alist-p -headers<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span> -headers<span class="rainbow-delimiters-depth-9-face">)
                            (</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">and</span> -headers <span class="rainbow-delimiters-depth-2-face">(</span>json-plist-p -headers<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">) (</span>im-plist-to-alist -headers<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                            (</span>t nil<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  <span class="builtin">:parser</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> -raw <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">buffer-string</span> <span class="rainbow-delimiters-depth-9-face">(</span>apply-partially <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">json-parse-buffer</span> <span class="builtin">:object-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">alist</span> <span class="builtin">:array-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  <span class="builtin">:success</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">cl-function</span>
                            <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="type">&amp;key</span> data <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-1-face">)
                              (</span>funcall resolve data<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  <span class="builtin">:error</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">cl-function</span>
                          <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="type">&amp;key</span> data status error-thrown <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-1-face">)
                            (</span><span class="keyword">unless</span> -on-error
                              <span class="rainbow-delimiters-depth-2-face">(</span>message <span class="string">&quot;im-request :: failed status=%s, error-thrown=%s, data=%s&quot;</span> status error-thrown data<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                            (</span>funcall reject data<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  <span class="builtin">:sync</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-9-face">(</span>not -on-success<span class="rainbow-delimiters-depth-9-face">) (</span>not -async?<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  <span class="builtin">:data</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">cond</span>
                         <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">and</span> -data <span class="rainbow-delimiters-depth-2-face">(</span>json-alist-p -data<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">) (</span>json-encode -data<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                         (</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">and</span> -data <span class="rainbow-delimiters-depth-2-face">(</span>json-plist-p -data<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">) (</span>json-encode <span class="rainbow-delimiters-depth-2-face">(</span>im-plist-to-alist -data<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                         (</span><span class="rainbow-delimiters-depth-1-face">(</span>stringp -data<span class="rainbow-delimiters-depth-1-face">)</span> -data<span class="rainbow-delimiters-depth-9-face">)
                         (</span>t nil<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  <span class="builtin">:params</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">cond</span>
                           <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">and</span> -params <span class="rainbow-delimiters-depth-2-face">(</span>json-alist-p -params<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span> -params<span class="rainbow-delimiters-depth-9-face">)
                           (</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">and</span> -params <span class="rainbow-delimiters-depth-2-face">(</span>json-plist-p params<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">) (</span>im-plist-to-alist -params<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                           (</span>t <span class="rainbow-delimiters-depth-1-face">(</span>im-plist-to-alist params<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">cond</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>-async? <span class="rainbow-delimiters-depth-6-face">(</span>promise-new fn<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> -on-success -on-error<span class="rainbow-delimiters-depth-6-face">)
        (</span>funcall
         fn
         <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> -on-success <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>data<span class="rainbow-delimiters-depth-9-face">) (</span>message <span class="string">&quot;im-request :: Unhandled success. Data: %s&quot;</span> data<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
         (</span><span class="keyword">or</span> -on-error <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>data<span class="rainbow-delimiters-depth-9-face">) (</span>message <span class="string">&quot;im-request :: Unhandled error. Data: %s&quot;</span> data<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>t <span class="rainbow-delimiters-depth-6-face">(</span>funcall fn <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>data<span class="rainbow-delimiters-depth-8-face">) (</span><span class="keyword">setq</span> json data<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">) (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>data<span class="rainbow-delimiters-depth-8-face">) (</span><span class="warning">user-error</span> <span class="string">&quot;Request failed, see earlier logs.&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-8-face">(</span>get-buffer-create <span class="string">&quot;*im-request-response*&quot;</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>erase-buffer<span class="rainbow-delimiters-depth-8-face">)
              (</span>insert json<span class="rainbow-delimiters-depth-8-face">)
              (</span>json-pretty-print-buffer<span class="rainbow-delimiters-depth-8-face">)
              (</span>json-ts-mode<span class="rainbow-delimiters-depth-8-face">)
              (</span>switch-to-buffer-other-window <span class="rainbow-delimiters-depth-9-face">(</span>current-buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>goto-char <span class="rainbow-delimiters-depth-9-face">(</span>point-min<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
          json<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Remove this, use the one above with :-async? t
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-request-json-async</span> <span class="rainbow-delimiters-depth-2-face">(</span>url <span class="type">&amp;key</span> headers type data<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Async `</span><span class="constant">request</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>promise-new
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>resolve reject<span class="rainbow-delimiters-depth-4-face">)
     (</span>request
       url
       <span class="builtin">:headers</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;Content-Type&quot;</span> . <span class="string">&quot;application/json&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
                  ,@headers<span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="builtin">:type</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> type <span class="string">&quot;GET&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="builtin">:data</span> data
       <span class="builtin">:parser</span> <span class="rainbow-delimiters-depth-5-face">(</span>apply-partially <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">json-parse-buffer</span> <span class="builtin">:object-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">alist</span> <span class="builtin">:array-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="builtin">:success</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cl-function</span>
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="type">&amp;key</span> data <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-7-face">)
                   (</span>funcall resolve data<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="builtin">:error</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cl-function</span>
               <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="type">&amp;key</span> data error-thrown <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-7-face">)
                 (</span>message <span class="string">&quot;request failed :: %s | %s&quot;</span> data error-thrown<span class="rainbow-delimiters-depth-7-face">)
                 (</span>funcall reject data<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> URL/web utils
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-url-parse-title</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>dom-text <span class="rainbow-delimiters-depth-3-face">(</span>car <span class="rainbow-delimiters-depth-4-face">(</span>dom-by-tag <span class="rainbow-delimiters-depth-5-face">(</span>libxml-parse-html-region <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">) (</span>point-max<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">title</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-url-get-title</span> <span class="rainbow-delimiters-depth-2-face">(</span>url<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get title of the URL.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>url-retrieve-synchronously url <span class="builtin">:silent :inhibit-cookies</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-url-parse-title<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-url-get-title-async</span> <span class="rainbow-delimiters-depth-2-face">(</span>url cb<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get title of the URL, async.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>url-retrieve
   url
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>_status<span class="rainbow-delimiters-depth-4-face">)
     (</span>funcall cb <span class="rainbow-delimiters-depth-5-face">(</span>im-url-parse-title<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>kill-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   nil <span class="builtin">:silent :inhibit-cookies</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">with-default-browser</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> body<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>browse-url-handlers nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>browse-url-browser-function browse-url-secondary-browser-function<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
     ,@body<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-json-encode-and-show</span> <span class="rainbow-delimiters-depth-2-face">(</span>obj<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Show given elisp OBJ as pretty printed JSON.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>switch-to-buffer-other-window <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create <span class="string">&quot;*raw-pretty*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>insert <span class="rainbow-delimiters-depth-3-face">(</span>json-encode obj<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>json-pretty-print-buffer<span class="rainbow-delimiters-depth-2-face">)
  (</span>json-ts-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-url?</span> <span class="rainbow-delimiters-depth-2-face">(</span>url<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Check if given URL is really an URL or not.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-3-face">(</span>s-match <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">https?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">file</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">://</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">www.&quot;</span> url<span class="rainbow-delimiters-depth-3-face">)
      (</span>s-match <span class="string">&quot;\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">org</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">net</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">com</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">$&quot;</span> url<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-check-internet-connection</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return t if there is an active internet connection.
May return false on slow connections.  Checks blocking, max 150 ms (for
Linux), 1 secs for Mac.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-when-on</span>
   <span class="builtin">:linux</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>= 0 <span class="rainbow-delimiters-depth-4-face">(</span>call-process <span class="string">&quot;nc&quot;</span> nil nil nil <span class="string">&quot;-w&quot; &quot;150ms&quot; &quot;-z&quot; &quot;www.google.com&quot; &quot;80&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:darwin</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>= 0 <span class="rainbow-delimiters-depth-4-face">(</span>call-process <span class="string">&quot;nc&quot;</span> nil nil nil  <span class="string">&quot;-G&quot; &quot;1&quot; &quot;-z&quot; &quot;www.google.com&quot; &quot;80&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> File operations
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-latest-file</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get latest file in PATH.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>car <span class="rainbow-delimiters-depth-3-face">(</span>directory-files <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> path default-directory<span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">full</span> <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[</span><span class="negation-char">^</span><span class="string">.]</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\\.[</span><span class="negation-char">^</span><span class="string">.]</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\\.\\..</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">file-newer-than-file-p</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-directory-files-recursively</span> <span class="rainbow-delimiters-depth-2-face">(</span>dir regexp<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Faster alternative to `</span><span class="constant">directory-files-recursively</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>format
    <span class="string">&quot;fd '</span><span class="constant">%s</span><span class="string">' '</span><span class="constant">%s</span><span class="string">' --type file --maxdepth 4 --absolute-path&quot;</span>
    regexp
    <span class="rainbow-delimiters-depth-4-face">(</span>expand-file-name dir<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>shell-command-to-string<span class="rainbow-delimiters-depth-3-face">)
   (</span>s-trim<span class="rainbow-delimiters-depth-3-face">)
   (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-encode-image-base64</span> <span class="rainbow-delimiters-depth-2-face">(</span>path<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>type <span class="rainbow-delimiters-depth-5-face">(</span>nth 1 <span class="rainbow-delimiters-depth-6-face">(</span>s-match <span class="string">&quot;.*\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">jpg</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">jpeg</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">png</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> path<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>base64 <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">with-temp-buffer</span>
                   <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>coding-system-for-read <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">no-conversion</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                     (</span>insert-file-contents path<span class="rainbow-delimiters-depth-7-face">)
                     (</span>base64-encode-region <span class="rainbow-delimiters-depth-8-face">(</span>point-min<span class="rainbow-delimiters-depth-8-face">) (</span>point-max<span class="rainbow-delimiters-depth-8-face">)</span> t<span class="rainbow-delimiters-depth-7-face">)
                     (</span>buffer-string<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>format <span class="string">&quot;data:image/%s;base64,%s&quot;</span> type base64<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> OS Utils
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-ssh-host-list</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return all host names defined in ~/.ssh/config.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>f-read-text <span class="string">&quot;~/.ssh/config&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>s-lines<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>nth 1 <span class="rainbow-delimiters-depth-5-face">(</span>s-match <span class="string">&quot;^Host </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>-filter <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">identity</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>-remove-item <span class="string">&quot;*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defmacro</span> <span class="function-name">im-when-on</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> linux darwin<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">pcase</span> system-type
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span> darwin<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">gnu/linux</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">linux</span><span class="rainbow-delimiters-depth-4-face">)</span> linux<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Git
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-git-temp-clone</span> <span class="rainbow-delimiters-depth-2-face">(</span>url <span class="type">&amp;key</span> on-success <span class="rainbow-delimiters-depth-3-face">(</span>on-fail <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">() (</span>alert <span class="string">&quot;Cloning failed!&quot;</span> <span class="builtin">:title</span> <span class="string">&quot;im-git-temp-clone&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Clone URL into a temp directory and run ON-SUCCESS inside it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>dir <span class="rainbow-delimiters-depth-5-face">(</span>make-temp-file <span class="string">&quot;im_temp_git_dir&quot;</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>lab-git-clone
     url
     dir
     <span class="builtin">:shallow</span> t
     <span class="builtin">:callback</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>success?<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">if</span> success?
           <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>default-directory <span class="rainbow-delimiters-depth-9-face">(</span>f-join dir <span class="rainbow-delimiters-depth-1-face">(</span>file-name-base url<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>funcall on-success<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>funcall on-fail<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Interactive utilities
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-generate-random-string</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-insert-random-string</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-generate-random-id</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-insert-random-string</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-insert-random-string</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Generate a 7 character random string.
Useful for the cases where I need to reference stuff inside a
file/project etc.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>chars <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>string <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">dotimes</span> <span class="rainbow-delimiters-depth-4-face">(</span>_ 7 string<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> string <span class="rainbow-delimiters-depth-5-face">(</span>concat string <span class="rainbow-delimiters-depth-6-face">(</span>string <span class="rainbow-delimiters-depth-7-face">(</span>aref chars <span class="rainbow-delimiters-depth-8-face">(</span>random <span class="rainbow-delimiters-depth-9-face">(</span>length chars<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert string<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Formalize the notation, something like &quot;ref:&lt;id&gt;&quot; and
</span><span class="comment-delimiter">;; </span><span class="comment">&quot;def:&lt;id&gt;&quot; and have a function that finds this specific id in the
</span><span class="comment-delimiter">;; </span><span class="comment">current project.
</span>
<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Basics
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Overriding some defaults
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> save-silently t<span class="rainbow-delimiters-depth-1-face">)
(</span>setenv <span class="string">&quot;EDITOR&quot; &quot;emacsclient&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span>setenv <span class="string">&quot;VISUAL&quot; &quot;emacsclient&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span>setenv <span class="string">&quot;BROWSER&quot; &quot;emacs-browser&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span>im-tangle-file
 <span class="builtin">:doc</span> <span class="doc">&quot;Simple `</span><span class="constant">browse-url</span><span class="doc">' wrapper. This enables external processes to call emacs with a url.&quot;</span>
 <span class="builtin">:path</span> <span class="string">&quot;~/.bin/emacs-browser&quot;</span>
 <span class="builtin">:contents</span> <span class="string">&quot;#!/bin/bash
emacsclient --eval \&quot;(browse-url \\\&quot;$1\\\&quot;)\&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> M-Backspace should delete, instead of killing
</span>
<span class="comment-delimiter">;; </span><span class="comment">https://www.emacswiki.org/emacs/BackwardDeleteWord
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">delete-word</span> <span class="rainbow-delimiters-depth-2-face">(</span>arg<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Delete characters forward until encountering the end of a word.
With argument, do this that many times.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;p&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>use-region-p<span class="rainbow-delimiters-depth-3-face">)
      (</span>delete-region <span class="rainbow-delimiters-depth-4-face">(</span>region-beginning<span class="rainbow-delimiters-depth-4-face">) (</span>region-end<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>delete-region <span class="rainbow-delimiters-depth-4-face">(</span>point<span class="rainbow-delimiters-depth-4-face">) (</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-5-face">(</span>forward-word arg<span class="rainbow-delimiters-depth-5-face">) (</span>point<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">backward-delete-word</span> <span class="rainbow-delimiters-depth-2-face">(</span>arg<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Delete characters backward until encountering the end of a word.
With argument, do this that many times.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;p&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>delete-word <span class="rainbow-delimiters-depth-3-face">(</span>- arg<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">(</span>read-kbd-macro <span class="string">&quot;&lt;M-DEL&gt;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">backward-delete-word</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Recent files
</span>
<span class="comment-delimiter">;; </span><span class="comment">Save recent files. Also exclude package files that appears after
</span><span class="comment-delimiter">;; </span><span class="comment">installing a package or after an update from recent list.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">recentf</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . recentf-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>recentf-max-saved-items 500<span class="rainbow-delimiters-depth-2-face">)
  (</span>recentf-exclude <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="string">&quot;.*\\.elc&quot;
                         &quot;/tmp/.*&quot;
                         &quot;/var/folders/.*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> reveal-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Enable the reveal-mode. This is quite needed as some commands that
</span><span class="comment-delimiter">;; </span><span class="comment">does jumping does not reveal the text if it's hidden and reveal
</span><span class="comment-delimiter">;; </span><span class="comment">mode does that.
</span>
<span class="comment-delimiter">;; </span><span class="comment">(global-reveal-mode)
</span><span class="comment-delimiter">;; </span><span class="comment">(setq reveal-auto-hide t)
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Save minibuffer, kill-ring, search-ring history
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">savehist</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . savehist-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Clipboard selections are copied into the kill-ring
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> save-interprogram-paste-before-kill t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> savehist-additional-variables <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>kill-ring search-ring regexp-search-ring<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> savehist-file <span class="string">&quot;~/.emacs.d/savehist&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Better scrolling
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Better settings for mouse scroll
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> mouse-wheel-scroll-amount <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>1 <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>shift<span class="rainbow-delimiters-depth-4-face">)</span> . 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">one line at a time
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> mouse-wheel-progressive-speed nil<span class="rainbow-delimiters-depth-1-face">)</span>            <span class="comment-delimiter">;; </span><span class="comment">don't accelerate scrolling
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> mouse-wheel-follow-mouse <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">t</span><span class="rainbow-delimiters-depth-1-face">)</span>                  <span class="comment-delimiter">;; </span><span class="comment">scroll window under mouse
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Mouse shortcuts for zooming
</span>
<span class="comment-delimiter">;; </span><span class="comment">Ctrl-Scroll to zoom in and out
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">[</span>C-mouse-4<span class="rainbow-delimiters-depth-2-face">]</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">text-scale-increase</span><span class="rainbow-delimiters-depth-1-face">)
(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">[</span>C-mouse-5<span class="rainbow-delimiters-depth-2-face">]</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">text-scale-decrease</span><span class="rainbow-delimiters-depth-1-face">)
(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;C-+&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">text-scale-increase</span><span class="rainbow-delimiters-depth-1-face">)
(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;C-=&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">text-scale-decrease</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Conservative scrolling
</span>
<span class="comment-delimiter">;; </span><span class="comment">If the cursor is at the end of the file, when you scroll emacs does a strange jump. This fixes it.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> scroll-conservatively 101<span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">When cursor reaches end, just scroll line-by-line
</span><span class="comment-delimiter">;; </span><span class="comment">(setq scroll-margin 10) ;; Start scolling earlier
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Backups
</span>
<span class="comment-delimiter">;; </span><span class="comment">Instead of having a file that ends with ~ or '# files in same
</span><span class="comment-delimiter">;; </span><span class="comment">directory, save all backup files in =~/.emacs.d/backups=.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">im-backup-dir</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-mkdir-if-not <span class="string">&quot;~/.emacs.d/backups/&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> backup-directory-alist <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;.*&quot;</span> . ,im-backup-dir<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">setq</span> auto-save-file-name-transforms <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;.*&quot;</span> ,im-backup-dir t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> backup-by-copying t<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ Don't delink hardlinks
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> version-control t<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ Use version numbers on backups
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> delete-old-versions t<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ Automatically delete excess backups
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> kept-new-versions 20<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ How many of the newest versions to keep
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> kept-old-versions 5<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ How many of the old versions to keep
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Remove trailing space before save
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">before-save-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">delete-trailing-whitespace</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Make script files executable automatically
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-save-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">executable-make-buffer-file-executable-if-script-p</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">ob-tangle</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-babel-post-tangle-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">executable-make-buffer-file-executable-if-script-p</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Automatically run some commands after saving specific files
</span>
<span class="comment-delimiter">;; </span><span class="comment">This is like =autocmd BufWritePost= of vim. When a particular file
</span><span class="comment-delimiter">;; </span><span class="comment">is edited, I want to make sure a command runs after the save.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-run-after-save-alist</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;~/.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">Xresources</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Xdefaults</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> . <span class="string">&quot;xrdb %; notify-send 'xrdb updated'&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;~/.Xresources.d/.*&quot;</span>              . <span class="string">&quot;xrdb ~/.Xresources; notify-send 'xrdb updated'&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;~/.config/sxhkd/sxhkdrc&quot;</span>         . <span class="string">&quot;pkill -USR1 -x sxhkd; notify-send 'sxhkd updated'&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;~/.config/skhd/skhdrc&quot;</span>           . <span class="string">&quot;skhd --reload; osascript -e 'display notification \&quot;skhd updated\&quot;'&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;~/.config/kmonad-linux.kbd&quot;</span>      . <span class="string">&quot;systemctl --user restart kmonad&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;File association list with their respective command.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-save-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-post-save-run-command</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">ob-tangle</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-babel-post-tangle-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-post-save-run-command</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-post-save-run-command</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Execute the specified command after saving specified file.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fname <span class="rainbow-delimiters-depth-5-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
              (</span>match <span class="rainbow-delimiters-depth-5-face">(</span>im-assoc-regexp fname im-run-after-save-alist <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">expand-file-name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>mapcar
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">-lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>_ . command<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">cond</span>
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>stringp command<span class="rainbow-delimiters-depth-7-face">)
         (</span>shell-command <span class="rainbow-delimiters-depth-8-face">(</span>s-replace <span class="string">&quot;%&quot;</span> fname command<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="rainbow-delimiters-depth-7-face">(</span>functionp command<span class="rainbow-delimiters-depth-7-face">)
         (</span>funcall command fname<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>t
         <span class="rainbow-delimiters-depth-7-face">(</span>message <span class="string">&quot;&gt;&gt; Wrong specification in `</span><span class="constant">im-run-after-save-alist</span><span class="string">' for %s&quot;</span> fname<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     match<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> repeat-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Enables you to have repeatable keybindings.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">repeat</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . repeat-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-make-repeatable</span> <span class="rainbow-delimiters-depth-2-face">(</span>name <span class="type">&amp;rest</span> pairs<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Put given PAIRS in a keymap named NAME and mark them as repeatable.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>pairs <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cl-loop</span> for <span class="rainbow-delimiters-depth-6-face">(</span>a b<span class="rainbow-delimiters-depth-6-face">)</span> on pairs by <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cddr</span> collect <span class="rainbow-delimiters-depth-6-face">(</span>list a b<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>map-name <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;im-repeat-map-for-%s&quot;</span> name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defvar</span> ,map-name
         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>map <span class="rainbow-delimiters-depth-8-face">(</span>make-sparse-keymap<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
           ,@<span class="rainbow-delimiters-depth-6-face">(</span>mapcar <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>it<span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-8-face">(</span>define-key map <span class="rainbow-delimiters-depth-9-face">(</span>kbd ,<span class="rainbow-delimiters-depth-1-face">(</span>car it<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="highlight-quoted-quote">'</span>,<span class="rainbow-delimiters-depth-9-face">(</span>cadr it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span> pairs<span class="rainbow-delimiters-depth-6-face">)</span>
           map<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>-each <span class="highlight-quoted-quote">'</span>,<span class="rainbow-delimiters-depth-5-face">(</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cadr</span> pairs<span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>it<span class="rainbow-delimiters-depth-6-face">) (</span>put it <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">repeat-map</span> <span class="highlight-quoted-quote">'</span>,map-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Visuals
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> General
</span>
<span class="comment-delimiter">;; </span><span class="comment">Disable menubar
</span><span class="rainbow-delimiters-depth-1-face">(</span>menu-bar-mode 0<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Wrap long lines.
</span><span class="comment-delimiter">;; </span><span class="comment">(global-visual-line-mode t)
</span>
<span class="comment-delimiter">;; </span><span class="comment">This sometimes causes performance problems. So
</span><span class="comment-delimiter">;; </span><span class="comment">instead of calling `</span><span class="constant">global-visual-line-mode</span><span class="comment">', I enable it per-mode
</span><span class="comment-delimiter">;; </span><span class="comment">basis.  Here are some basic modes that it's enabled for:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">TeX-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">visual-line-mode</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">text-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">visual-line-mode</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Highlight current line
</span><span class="rainbow-delimiters-depth-1-face">(</span>global-hl-line-mode t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-disable-hl-line-mode-for-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Disable `</span><span class="constant">global-hl-line-mode</span><span class="doc">' for current buffer only.
I explicitly disable this mode for some modes in my configuration
using this function.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> global-hl-line-mode nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Themes
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">modus-themes</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">ef-themes</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">kaolin-themes</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">doom-themes</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Fix for doomemacs/themes#720
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>custom-set-faces
   <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span>tab-bar
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:background</span> ,<span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span>doom-color <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bg-alt</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">unspecified</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:foreground</span> ,<span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span>doom-color <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">fg-alt</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">unspecified</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">im-adaptive-theme</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . im-adaptive-theme-enable<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-adaptive-theme-detect-geolocation-automatically t<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-adaptive-theme-day-themes
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="comment-delimiter">;; </span><span class="comment">Pinkish white theme, really nice to look at.
</span>     ef-summer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-adaptive-theme-night-themes
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="comment-delimiter">;; </span><span class="comment">Grayish theme with great colors.
</span>     doom-one
     <span class="comment-delimiter">;; </span><span class="comment">A regular black theme with nice amount of contrast.
</span>     modus-vivendi
     <span class="comment-delimiter">;; </span><span class="comment">Like solarized but much nicer colors.
</span>     ef-melissa-dark
     <span class="comment-delimiter">;; </span><span class="comment">like ef-summer but dark. Black and purple.
</span>     ef-cherie
     <span class="comment-delimiter">;; </span><span class="comment">Nice dark theme with good contrast.
</span>     doom-Iosvkem<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Fonts
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">im-fonts</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;Cascadia Code NF&quot;
    &quot;FiraCode Nerd Font&quot;
    &quot;Iosevka Nerd Font&quot;
    &quot;IBM Plex Mono&quot;
    &quot;Iosevka Comfy Motion&quot;
    &quot;Iosevka Comfy&quot;
    &quot;Liberation Mono&quot;
    &quot;Noto Sans Mono&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Fonts that I use.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-current-font</span> nil
  <span class="doc">&quot;Holds the currently used font name.
One of `</span><span class="constant">im-fonts</span><span class="doc">'.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defconst</span> <span class="variable-name">im-font-height</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-when-on</span> <span class="builtin">:linux</span> 108 <span class="builtin">:darwin</span> 150<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-set-font</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> next<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Set the first available font from the `</span><span class="constant">im-fonts</span><span class="doc">' list.
If NEXT is non-nil, then use the next font.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">and-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fonts <span class="rainbow-delimiters-depth-5-face">(</span>-filter <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-font-exists-p</span> im-fonts<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
             (</span>font <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> next
                       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>cadr <span class="rainbow-delimiters-depth-8-face">(</span>member im-current-font fonts<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">) (</span>car fonts<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                     (</span>car fonts<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>set-face-attribute <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">default</span> nil
                        <span class="builtin">:font</span> font
                        <span class="builtin">:weight</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
                        <span class="builtin">:width</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
                        <span class="builtin">:height</span> im-font-height<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> im-current-font font<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-init-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-set-font</span> 99<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> prettify-symbols-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">I make use of this mode quite frequently throughout the configuration.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> prettify-symbols-unprettify-at-point t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-prettify-mode</span> <span class="rainbow-delimiters-depth-2-face">(</span>mode pairs<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Prettify given PAIRS in given MODE.
Just a simple wrapper around `prettify-symbols-mode`&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>hook <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="rainbow-delimiters-depth-7-face">(</span>symbol-name mode<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;-prettify-symbols-hook&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defun</span> ,hook <span class="rainbow-delimiters-depth-5-face">()
         (</span><span class="keyword">setq</span> prettify-symbols-alist <span class="rainbow-delimiters-depth-6-face">(</span>append prettify-symbols-alist ,pairs<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span>prettify-symbols-mode 1<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>add-hook <span class="highlight-quoted-quote">'</span>,mode <span class="highlight-quoted-quote">#'</span>,hook<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Frame title
</span>
<span class="comment-delimiter">;; </span><span class="comment">Make window title contain buffer name so it's easier to identify
</span><span class="comment-delimiter">;; </span><span class="comment">windows. I use ~rofi~ to switch between windows in my DE, so it
</span><span class="comment-delimiter">;; </span><span class="comment">helps to have buffer name in window title.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> frame-title-format <span class="string">&quot;%b - emacs&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Parentheses
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Matching
</span>
<span class="comment-delimiter">;; </span><span class="comment">Just enable parenthesis matching.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">show-paren</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>prog-mode . show-paren-local-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> show-paren-style <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">parenthesis</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Rainbow
</span>
<span class="comment-delimiter">;; </span><span class="comment">Colors parentheses depending on their dept.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">rainbow-delimiters</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>prog-mode . rainbow-delimiters-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Highlight trailing spaces
</span>
<span class="comment-delimiter">;; </span><span class="comment">Following highlights trailing spaces. Also see: [[Remove trailing
</span><span class="comment-delimiter">;; </span><span class="comment">space before save]]
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">whitespace</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . global-whitespace-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> whitespace-style <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>face empty tabs trailing<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> whitespace-global-modes <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>not org-mode markdown-mode vterm-mode magit-log-mode nov-mode eshell-mode dired-mode dirvish-mode w3m-mode eat-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-whitespace-mode-toggle</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle between more and less agressive whitespace modes.
Toggles between showing every whitespace (tabs, spaces, newlines
etc.) and only showing trailing spaces and tabs.  By default I use
the latter but sometimes I want to see everything and the
function helps me go between these modes easily.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>member <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">spaces</span> whitespace-style<span class="rainbow-delimiters-depth-3-face">)
      (</span><span class="keyword">setq</span> whitespace-style <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>face empty tabs trailing<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> whitespace-style <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>face tabs spaces trailing lines space-before-tab newline indentation empty space-after-tab space-mark tab-mark newline-mark<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>whitespace-mode 0<span class="rainbow-delimiters-depth-2-face">)
  (</span>whitespace-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Spaces instead of tabs
</span>
<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: This breaks org-mode.
</span><span class="comment-delimiter">;; </span><span class="comment">(setq-default tab-width 2)
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq-default</span> indent-tabs-mode nil<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Shackle windows
</span>
<span class="comment-delimiter">;; </span><span class="comment">Make some temproary windows appear at bottom. This makes buffer
</span><span class="comment-delimiter">;; </span><span class="comment">management so much easier. Buffers that will match given regex will
</span><span class="comment-delimiter">;; </span><span class="comment">appear at bottom while covering the given amount of screen.
</span>
<span class="comment-delimiter">;; </span><span class="comment">SOURCE: https://www.reddit.com/r/emacs/comments/345vtl/make_helm_window_at_the_bottom_without_using_any/
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-shackle-window</span> <span class="rainbow-delimiters-depth-2-face">(</span>name size<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Make the buffer NAME appear at bottom of the window, filling
SIZE percent of the window.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">display-buffer-alist</span>
               <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span>,name
                 <span class="rainbow-delimiters-depth-4-face">(</span>display-buffer-in-side-window<span class="rainbow-delimiters-depth-4-face">)
                 (</span>inhibit-same-window . t<span class="rainbow-delimiters-depth-4-face">)
                 (</span>window-height . ,size<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-clear-side-windows</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Clear all side windows.
This is sometimes required to get around the error: `Cannot make
side window the only window'&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>window-with-parameter <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">window-side</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>window-toggle-side-windows<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Miscellaneous packages
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some small packages that enriches editing experience visually. I
</span><span class="comment-delimiter">;; </span><span class="comment">don't enable all of them by default, I enable most of them whenever
</span><span class="comment-delimiter">;; </span><span class="comment">I need the functionality. I utilize an appearance [[Hydra]] to
</span><span class="comment-delimiter">;; </span><span class="comment">quickly toggle the functionality I need.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Show column guidelines
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">fill-column-indicator</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">By default Emacs scales fonts with text-scale-{increase,decrease}
</span><span class="comment-delimiter">;; </span><span class="comment">per buffer. This scales fonts with
</span><span class="comment-delimiter">;; </span><span class="comment">default-text-scale-{increase,decrease} globally.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">default-text-scale</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>default-text-scale-decrease default-text-scale-decrease<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">This shows some indent guides and it's highly configurable.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">highlight-indent-guides</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>set-face-background <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">highlight-indent-guides-odd-face</span> <span class="string">&quot;darkgray&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>set-face-background <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">highlight-indent-guides-even-face</span> <span class="string">&quot;dimgray&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>set-face-foreground <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">highlight-indent-guides-character-face</span> <span class="string">&quot;dimgray&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> highlight-indent-guides-method <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bitmap</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> highlight-indent-guides-bitmap-function <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">highlight-indent-guides--bitmap-line</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Spacious padding
</span>
<span class="comment-delimiter">;; </span><span class="comment">Add some padding to Emacs frame to freshen things up.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Disabled for now.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">spacious-padding</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>spacious-padding-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> page-break-lines
</span>
<span class="comment-delimiter">;; </span><span class="comment">I used to separate files using  but then I discovered [[outli]]
</span><span class="comment-delimiter">;; </span><span class="comment">and it did the same job but better. I still use page-break-lines
</span><span class="comment-delimiter">;; </span><span class="comment">mode in some cases where I need to draw a horizontal line in the
</span><span class="comment-delimiter">;; </span><span class="comment">buffer to separate some stuff.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">page-break-lines</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>page-break-lines-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> evil-mode
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Basic configuration
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:init</span>
  <span class="comment-delimiter">;; </span><span class="comment">Following two is required by evil-collection. It's probably wiser
</span>  <span class="comment-delimiter">;; </span><span class="comment">to set evil-want-keybinding to t if you will not use
</span>  <span class="comment-delimiter">;; </span><span class="comment">evil-collection
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-want-integration t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> evil-want-keybinding nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">This generally confuses me.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-jumps-cross-buffers nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Disable evil bindings in insert mode. This needs to be called
</span>  <span class="comment-delimiter">;; </span><span class="comment">before loading evil mode...
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-disable-insert-state-bindings t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">This seems to be the most reliable undo system.  Also see `</span><span class="constant">vundo</span><span class="comment">'
</span>  <span class="comment-delimiter">;; </span><span class="comment">package down below for undo-tree like functionality
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-undo-system <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">undo-fu</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">...but I want some default evil bindings in insert mode, so just
</span>  <span class="comment-delimiter">;; </span><span class="comment">remap them
</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-d&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-shift-left-line</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-t&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-shift-right-line</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-complete-next</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-p&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-complete-previous</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-o&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-execute-in-normal-state</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">C-a is `</span><span class="constant">completion-at-point</span><span class="comment">' but I like to be standard Emacs
</span>  <span class="comment-delimiter">;; </span><span class="comment">beginning-of-line. I already bind `M-o p' to
</span>  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">completion-at-point</span><span class="comment">'
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key evil-command-line-map <span class="string">&quot;C-a&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">beginning-of-line</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">C-i interferes with TAB key, so disable it
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-want-C-i-jump nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">C-i is bound to TAB, so I use C-l for `</span><span class="constant">evil-jump-forward</span><span class="comment">'
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span> <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-l&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-jump-forward</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">evil-jump-backward</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">evil-jump-forward</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">When I paste something in visual mode, I don't want it to take
</span>  <span class="comment-delimiter">;; </span><span class="comment">over the kill ring I also use evil-exchange, which eliminates the
</span>  <span class="comment-delimiter">;; </span><span class="comment">need for this totally
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-kill-on-visual-paste nil<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Over the time I found myself utilizing emacs C-u more and more,
</span>  <span class="comment-delimiter">;; </span><span class="comment">so disable this
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-want-C-u-scroll nil<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Make horizontal movement cross lines
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-default</span> evil-cross-lines t<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Open ex-mode with `&lt;`&gt; text instead of '</span><span class="constant">&lt;</span><span class="comment">'&gt; by default while
</span>  <span class="comment-delimiter">;; </span><span class="comment">visual mode is active. This way commands will work on selected
</span>  <span class="comment-delimiter">;; </span><span class="comment">char range instead of selected line range.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-ex-visual-char-range t<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">This is needed for being able to use *-eval-last-sexp kind of
</span>  <span class="comment-delimiter">;; </span><span class="comment">functions in normal mode. Elisp-related ones works out of the box
</span>  <span class="comment-delimiter">;; </span><span class="comment">but other ones (like for Racket, Clojure etc.) are not patched by
</span>  <span class="comment-delimiter">;; </span><span class="comment">default.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-move-beyond-eol t<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Makes # and * search for symbols instead of words.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-symbol-word-search t<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Move between visual lines instead of real lines
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;remap&gt; &lt;evil-next-line&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-next-visual-line</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;remap&gt; &lt;evil-previous-line&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-previous-visual-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">motion</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;remap&gt; &lt;evil-next-line&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-next-visual-line</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;remap&gt; &lt;evil-previous-line&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-previous-visual-line</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Use default yank-pop because it integrates itself with consult
</span>  <span class="comment-delimiter">;; </span><span class="comment">The binding may seem a bit weird but it's how it's done.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key evil-normal-state-map <span class="rainbow-delimiters-depth-3-face">[</span>remap yank-pop<span class="rainbow-delimiters-depth-3-face">]</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">yank-pop</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Change cursor colors based on current mode.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-normal-state-cursor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;green&quot;</span> box<span class="rainbow-delimiters-depth-3-face">)</span>
        evil-visual-state-cursor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;orange&quot;</span> box<span class="rainbow-delimiters-depth-3-face">)</span>
        evil-emacs-state-cursor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;purple&quot;</span> box<span class="rainbow-delimiters-depth-3-face">)</span>
        evil-insert-state-cursor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;pink&quot;</span> bar<span class="rainbow-delimiters-depth-3-face">)</span>
        evil-replace-state-cursor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;red&quot;</span> bar<span class="rainbow-delimiters-depth-3-face">)</span>
        evil-operator-state-cursor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;red&quot;</span> hollow<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>evil-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> general.el
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">general</span>
  <span class="comment-delimiter">;; </span><span class="comment">Not required to be installed after evil but loading it before
</span>  <span class="comment-delimiter">;; </span><span class="comment">causes some problems like keys not getting bound sometimes etc.
</span>  <span class="builtin">:demand</span> t
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>general-override-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-create-definer</span> im-leader
  <span class="builtin">:prefix</span> <span class="string">&quot;&lt;SPC&gt;&quot;</span>
  <span class="comment-delimiter">;; </span><span class="comment">This is important because if you don't set it some modes will
</span>  <span class="comment-delimiter">;; </span><span class="comment">fail to pick up leader bindings.  See:
</span>  <span class="comment-delimiter">;; </span><span class="comment">https://github.com/noctuid/general.el/issues/190
</span>  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">override</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-create-definer</span> im-leader-v
  <span class="builtin">:prefix</span> <span class="string">&quot;&lt;SPC&gt;&quot;</span>
  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">override</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>normal visual<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-create-definer</span> im-leader2
  <span class="builtin">:prefix</span> <span class="string">&quot;&lt;f16&gt;&quot;</span>
  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">override</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-create-definer</span> im-leader2-v
  <span class="builtin">:prefix</span> <span class="string">&quot;&lt;f16&gt;&quot;</span>
  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">override</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>normal visual<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-collection
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-collection</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-want-unimpaired-p t<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-unimpaired-want-repeat-mode-integration t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">grep</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-grep-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">replace</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-replace-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">compile</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-compile-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">xref</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-xref-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">help</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-help-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">imenu</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-imenu-setup<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-imenu-list-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">custom</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-custom-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> evil-unimpaired
</span>
<span class="comment-delimiter">;; </span><span class="comment">Apparently [[evil-collection]] has a vim-unimpaired implementation
</span><span class="comment-delimiter">;; </span><span class="comment">already. It contains bindings like:
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[&lt;SPC&gt;~ ~]&lt;SPC&gt;~ Insert newline above/below.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[b~ ~]b~ Go to prev/next buffer.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[p~, ~]p~ Paste up/down.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[e~, ~]e~ Move line up/down.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[d~, ~]d~ Delete line above/below.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[q~ ~]q~ Go to prev/next error.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[Q~ ~]Q~ Go to first/last error.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[n~ ~]n~ Go to prev/next conflict marker.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ~[t~ ~]t~ Go to prev/next </span><span class="default-0035">TODO</span><span class="comment">. (This is defined in [[Dummy IDE mode]])
</span>
<span class="comment-delimiter">;; </span><span class="comment">These also support repeat-mode. You can do ~]b~ and spam ~b~ to switch buffers.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Following are my extensions:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-collection</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-init <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">unimpaired</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">define-advice</span> <span class="function-name">evil-collection-unimpaired-previous-error</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> recenter<span class="rainbow-delimiters-depth-3-face">) (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">evil-collection-unimpaired-next-error</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> recenter<span class="rainbow-delimiters-depth-3-face">) (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>evil-collection-define-key <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-collection-unimpaired-mode-map</span>
    <span class="string">&quot;[d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-delete-line-above</span>
    <span class="string">&quot;]d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-delete-line-below</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-delete-line-above</span> <span class="rainbow-delimiters-depth-3-face">()</span>
    <span class="doc">&quot;Delete the line above.&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>forward-line -1<span class="rainbow-delimiters-depth-4-face">)
      (</span>beginning-of-line<span class="rainbow-delimiters-depth-4-face">)
      (</span>kill-line<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-blank? <span class="rainbow-delimiters-depth-6-face">(</span>s-trim <span class="rainbow-delimiters-depth-7-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span> t<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>kill-line<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-delete-line-below</span> <span class="rainbow-delimiters-depth-3-face">()</span>
    <span class="doc">&quot;Delete the line below.&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>forward-line 1<span class="rainbow-delimiters-depth-4-face">)
      (</span>beginning-of-line<span class="rainbow-delimiters-depth-4-face">)
      (</span>kill-line<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-blank? <span class="rainbow-delimiters-depth-6-face">(</span>s-trim <span class="rainbow-delimiters-depth-7-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span> t<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>kill-line<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-mc (multiple cursors)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Multiple cursors for evil.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Basics
</span><span class="comment-delimiter">;;   </span><span class="comment">- =C-n= / =C-p= are used for creating cursors
</span><span class="comment-delimiter">;;   </span><span class="comment">- =M-n= / =M-p= are used for moving between cursors
</span><span class="comment-delimiter">;;   </span><span class="comment">- =A= and =I= creates cursors in visual selection mode as you may expect.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =gkk= to clear all cursors.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- To be able to create cursors at arbitrary positions:
</span><span class="comment-delimiter">;;   </span><span class="comment">- =gkp= to pause all cursors. (Your main cursors moves freely while mc cursors stays still)
</span><span class="comment-delimiter">;;   </span><span class="comment">- =gkr= to resume paused cursors.
</span><span class="comment-delimiter">;;   </span><span class="comment">- =gkh= create a cursor at the point of main cursor. (Use after =gkp=).
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-mc</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>normal visual<span class="rainbow-delimiters-depth-3-face">)</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-mc-key-map</span>
   <span class="comment-delimiter">;; </span><span class="comment">Clear default evil-mc bindings
</span>   <span class="string">&quot;gr&quot;</span> nil
   <span class="comment-delimiter">;; </span><span class="comment">Add my bindings using &quot;gc&quot;
</span>   <span class="string">&quot;gcc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-mc-undo-all-cursors</span>
   <span class="string">&quot;gcp&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-mc-pause-cursors</span>
   <span class="string">&quot;gcr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-mc-resume-cursors</span>
   <span class="string">&quot;gch&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-mc-make-cursor-here</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">visual</span>
   <span class="string">&quot;A&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-mc-make-cursor-in-visual-selection-end</span>
   <span class="string">&quot;I&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-mc-make-cursor-in-visual-selection-beg</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>after-init . global-evil-mc-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-surround
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Change surroundings. Do =cs&quot;'= to turn =&quot;Hello world!&quot;= into ='Hello world!'=.
</span><span class="comment-delimiter">;;   </span><span class="comment">- ='Hello world!'= ~cs'&lt;q&gt;~ =&lt;q&gt;Hello world!&lt;/q&gt;=
</span><span class="comment-delimiter">;;   </span><span class="comment">- =Hel|lo= ~ysiw&quot;~ =&quot;Hello&quot;= (| is the cursor position.)
</span><span class="comment-delimiter">;;   </span><span class="comment">- =Hello= ~ysw{~ ={ Hello }=  (~{[(~ adds spaces)
</span><span class="comment-delimiter">;;   </span><span class="comment">- =Hello= ~ysw}~ ={Hello}=    (~}])~ does not add spaces)
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- Wrap selection with ~&lt;visual-state&gt; S~.
</span><span class="comment-delimiter">;; </span><span class="comment">- Wrap selection on new lines with ~&lt;visual-state&gt; gS~
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-surround</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>global-evil-surround-mode 1<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Invert some default pairs
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">map</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>map-put! evil-surround-pairs-alist ?\( <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;(&quot;</span> . <span class="string">&quot;)&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>map-put! evil-surround-pairs-alist ?\) <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;( &quot;</span> . <span class="string">&quot; )&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>map-put! evil-surround-pairs-alist ?\[ <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;[&quot;</span> . <span class="string">&quot;]&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>map-put! evil-surround-pairs-alist ?\] <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;[ &quot;</span> . <span class="string">&quot; ]&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>map-put! evil-surround-pairs-alist ?\{ <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;{&quot;</span> . <span class="string">&quot;}&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>map-put! evil-surround-pairs-alist ?\} <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;{ &quot;</span> . <span class="string">&quot; }&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Convert `` to `' in emacs-lisp mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs-lisp-mode-hook</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span><span class="keyword">push</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span>?<span class="highlight-quoted-quote">`</span> <span class="highlight-quoted-symbol">.</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;`&quot;</span> . <span class="string">&quot;'&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> evil-surround-pairs-alist<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-escape
</span>
<span class="comment-delimiter">;; </span><span class="comment">Return back to normal mode using ~jk~ from anywhere. It does not
</span><span class="comment-delimiter">;; </span><span class="comment">play well with multiple cursors, so use ~ESC~ to when using evil-mc
</span><span class="comment-delimiter">;; </span><span class="comment">related stuff.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-escape</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-escape-key-sequence <span class="string">&quot;jk&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Just Kidding bro, I didn't mean that *escapes*
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-escape-delay 0.2<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> evil-escape-excluded-major-modes <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>magit-status-mode magit-log-mode magit-diff-mode image-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-escape-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-matchit
</span>
<span class="comment-delimiter">;; </span><span class="comment">Jump between matching tags using ~%~, like =&lt;div&gt;...&lt;/div&gt;=,
</span><span class="comment-delimiter">;; </span><span class="comment">={...}= etc. =ci%=, =da%= etc. works as expected.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-matchit</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>global-evil-matchit-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-goggles
</span>
<span class="comment-delimiter">;; </span><span class="comment">~evil-goggles~ gives nice visual feedbacks while editing with
</span><span class="comment-delimiter">;; </span><span class="comment">evil-mode. When you do =dd=, =yw=, =ciw= or something similar, it
</span><span class="comment-delimiter">;; </span><span class="comment">will give a visual feedback for the selection. Feels kinda natural
</span><span class="comment-delimiter">;; </span><span class="comment">to have this.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-goggles</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-goggles-duration 0.20
        evil-goggles-pulse nil
        evil-goggles-enable-change t
        evil-goggles-enable-delete t
        evil-goggles-enable-indent t
        evil-goggles-enable-yank t
        evil-goggles-enable-join t
        evil-goggles-enable-fill-and-move t
        evil-goggles-enable-paste t
        evil-goggles-enable-shift t
        evil-goggles-enable-surround t
        evil-goggles-enable-commentary t
        evil-goggles-enable-nerd-commenter t
        evil-goggles-enable-replace-with-register t
        evil-goggles-enable-set-marker t
        evil-goggles-enable-undo t
        evil-goggles-enable-redo t<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-goggles-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-goggles-use-diff-faces<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-snipe
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Overall better =f/F/t/T= and . Nice visual feedbacks.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-snipe</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>magit-mode . turn-off-evil-snipe-override-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">(evil-snipe-mode 1) ;; This enables s/S bindings. I use those keys with avy
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>evil-snipe-override-mode 1<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">This overrides default f/F, t/T bindings
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-snipe-scope <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">visible</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">See https://github.com/hlissner/evil-snipe/issues/72
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-snipe-skip-leading-whitespace nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-exchange
</span>
<span class="comment-delimiter">;; </span><span class="comment">Change two parts of the text.
</span><span class="comment-delimiter">;; </span><span class="comment">- Mark some text in visual mode and do =gx=.
</span><span class="comment-delimiter">;; </span><span class="comment">- Mark some other text in visual mode and do =gx= again to exchange two parts.
</span><span class="comment-delimiter">;; </span><span class="comment">- You can use ~gx&lt;motion&gt;~ instead of visual mode too.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-exchange</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-exchange-install<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-visualstar
</span>
<span class="comment-delimiter">;; </span><span class="comment">With this package, you can do a visual selection and ~*~, ~#~ keys will work on them.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-visualstar</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-visualstar/persistent t<span class="rainbow-delimiters-depth-2-face">)
  (</span>global-evil-visualstar-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> evil-numbers
</span>
<span class="comment-delimiter">;; </span><span class="comment">Pretty useful for macros. Increment or decrement number at point
</span><span class="comment-delimiter">;; </span><span class="comment">with ~+,-~ in normal mode.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-numbers</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;+&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-numbers/inc-at-pt</span>
   <span class="string">&quot;-&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-numbers/dec-at-pt</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> goto-chg
</span>
<span class="comment-delimiter">;; </span><span class="comment">=g;= goes to the last change. (repeatable)
</span>
<span class="comment-delimiter">;; </span><span class="comment">There is also =gv= which selects the last selection. Not related to
</span><span class="comment-delimiter">;; </span><span class="comment">this package, it's a default functionality but I wanted to mention.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">goto-chg</span>
  <span class="builtin">:after</span> evil
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>evil-goto-last-change<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">define-advice</span> <span class="function-name">evil-goto-last-change</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> recenter<span class="rainbow-delimiters-depth-3-face">)
    (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">)
    (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-make-repeatable</span> evil-goto-chg
  <span class="string">&quot;;&quot;</span> evil-goto-last-change<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Custom text-objects
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> org blocks
</span>
<span class="comment-delimiter">;; </span><span class="comment">There is `</span><span class="constant">org-babel-mark-block</span><span class="comment">' but it only works for source blocks
</span><span class="comment-delimiter">;; </span><span class="comment">but this one works for everything between #begin_&lt;&gt; ... #end_&lt;&gt;.
</span><span class="comment-delimiter">;; </span><span class="comment">There is also &quot;e&quot; object defined by evil-org, which works for quite
</span><span class="comment-delimiter">;; </span><span class="comment">most things but it does not work, for example, org-ai blocks etc.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">evil-define-text-object</span> <span class="function-name">im-evil-inner-org-block</span> <span class="rainbow-delimiters-depth-2-face">(</span>count <span class="type">&amp;optional</span> _beg _end _type<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Select inner side of org source blocks.&quot;</span>
  <span class="builtin">:extend-selection</span> nil
  <span class="rainbow-delimiters-depth-2-face">(</span>im-find-hash-positions<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-text-object</span> <span class="function-name">im-evil-outer-org-block</span> <span class="rainbow-delimiters-depth-2-face">(</span>count <span class="type">&amp;optional</span> _beg _end _type<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Select outer side of org source blocks.&quot;</span>
  <span class="builtin">:extend-selection</span> nil
  <span class="rainbow-delimiters-depth-2-face">(</span>im-find-hash-positions t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>define-key evil-inner-text-objects-map <span class="string">&quot;#&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-evil-inner-org-block</span><span class="rainbow-delimiters-depth-1-face">)
(</span>define-key evil-outer-text-objects-map <span class="string">&quot;#&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-evil-outer-org-block</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-find-hash-positions</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> include-hash-lines<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find the positions of the first line starting with '#' upwards and downwards.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>up-pos nil<span class="rainbow-delimiters-depth-4-face">)
        (</span>down-pos nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Search upwards for the first line starting with &quot;#&quot;
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>beginning-of-line<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>not up-pos<span class="rainbow-delimiters-depth-6-face">) (</span>not <span class="rainbow-delimiters-depth-7-face">(</span>bobp<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>forward-line -1<span class="rainbow-delimiters-depth-5-face">)
        (</span>beginning-of-line<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>looking-at <span class="string">&quot;^#&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">unless</span> include-hash-lines
            <span class="rainbow-delimiters-depth-7-face">(</span>forward-line 1<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">setq</span> up-pos <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Search downwards for the first line starting with &quot;#&quot;
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>beginning-of-line<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>not down-pos<span class="rainbow-delimiters-depth-6-face">) (</span>not <span class="rainbow-delimiters-depth-7-face">(</span>eobp<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>forward-line 1<span class="rainbow-delimiters-depth-5-face">)
        (</span>beginning-of-line<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>looking-at <span class="string">&quot;^#&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">when</span> include-hash-lines
            <span class="rainbow-delimiters-depth-7-face">(</span>forward-line 1<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">setq</span> down-pos <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>list up-pos down-pos<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Extra repeatable keys for evil
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-make-repeatable</span> evil-section
  <span class="string">&quot;[&quot;</span> evil-backward-section-begin
  <span class="string">&quot;]&quot;</span> evil-forward-section-begin<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> org-mode
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Tips etc.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some lesser known functions:
</span><span class="comment-delimiter">;; </span><span class="comment">- org-copy-visible :: Useful for only sending the outline. Also works with selection.
</span><span class="comment-delimiter">;; </span><span class="comment">- orgtbl-create-or-convert-from-region :: Useful for data that is separated by \t or spaces.
</span><span class="comment-delimiter">;; </span><span class="comment">- After converting to table, I can use ~org-table-sort-lines~. Alternative is using ~sort-fields~ without converting the data into table but it's not that nice to use.
</span><span class="comment-delimiter">;; </span><span class="comment">- I generally use it in combination with ~embark-collect~. Any completing-read → embark-collect → orgtbl-create-or-convert-from-region.
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Constants
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">watchlist-org</span> <span class="string">&quot;~/Documents/notes/watchlist.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">readinglist-org</span> <span class="string">&quot;~/Documents/notes/readinglist.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">courses-org</span> <span class="string">&quot;~/Documents/notes/courses.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">bullet-org</span> <span class="string">&quot;~/Documents/notes/bullet.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">directory-notes-org</span> <span class="string">&quot;~/Documents/notes/directory-notes.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">life-org</span> <span class="string">&quot;~/Documents/notes/life.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">reality-org</span> <span class="string">&quot;~/Documents/notes/reality.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">projects-org</span> <span class="string">&quot;~/Documents/notes/projects.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>
<span class="rainbow-delimiters-depth-1-face-0036">(</span><span class="keyword">defconst</span> <span class="variable-name">gpt-org</span> <span class="string">&quot;~/Documents/notes/extra/gpt.org&quot;</span><span class="rainbow-delimiters-depth-1-face-0036">)</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">people-org</span> <span class="string">&quot;~/Documents/notes/people.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">diary-org</span> <span class="string">&quot;~/Documents/notes/diary.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">snippets-org</span> <span class="string">&quot;~/Documents/notes/snippets.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">bookmarks-org</span> <span class="string">&quot;~/Documents/notes/bookmarks.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">work-org</span> <span class="string">&quot;~/Documents/notes/trendyol.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">temp-org</span> <span class="string">&quot;~/Documents/notes/temp.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">passwords-org</span> <span class="string">&quot;~/Documents/notes/passwords.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">engineering-org</span> <span class="string">&quot;~/Documents/notes/engineering.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">netherlands-org</span> <span class="string">&quot;~/Documents/notes/netherlands.org&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-plus-contrib
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.org\\'&quot;</span> . org-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-return-follows-link t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Open links with RET
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-src-fontify-natively t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Enable code highlighting in ~SRC~ blocks.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-src-window-setup <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">current-window</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Open indirect edits in current window and don't mess with window config at all
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-hierarchical-todo-statistics t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Show all children in todo statistics [1/5]
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-imenu-depth 7<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ include up to 7-depth headers in imenu search
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-image-actual-width nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Disable showing inline images in full width. Now you can add `#+ATTR_*: :width 300` to resize inline images
</span>  <span class="comment-delimiter">;; </span><span class="comment">(setq org-ellipsis &quot;⤵&quot;)
</span>  <span class="comment-delimiter">;; </span><span class="comment">(setq org-ellipsis &quot;…&quot;)
</span>  <span class="comment-delimiter">;; </span><span class="comment">^ Replace ... with … in collapsed sections
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-hide-emphasis-markers t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Hide *...* /.../ etc.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-pretty-entities t<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-log-into-drawer t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Log into LOGBOOK drawer instead of directly loging under the heading
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-extend-today-until 3<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Consider the current day to end at 3AM
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-use-effective-time t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Make timestamp processing functions aware of the previous config
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-element-use-cache nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Cache causes bunch of random errors although disabling cache
</span>  <span class="comment-delimiter">;; </span><span class="comment">reduces the agenda performance significantly
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-tags-column 0<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Tags starts right after the heading.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-reverse-note-order t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ I keep new notes at the beginning. This helps with that.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-confirm-babel-evaluate nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Don't ask permissions for evaluating code blocks
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-clock-clocked-in-display <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">mode-line</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Shows in the tab-bar, if tab-bar is enabled.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-habit-show-habits nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Speeds up agenda a bit
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-edit-src-content-indentation 0<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ No indentation for src blocks
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-cycle-include-plain-lists <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">integrate</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Also toggle visibility of plain list with TAB etc. like they are subheadings
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-fold-core-style <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">text-properties</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Documentation says text-properties are more buggy but my
</span>  <span class="comment-delimiter">;; </span><span class="comment">experience is the opposite. At least for now. overlay folding
</span>  <span class="comment-delimiter">;; </span><span class="comment">messes things up with indirect buffers which I use quite a
</span>  <span class="comment-delimiter">;; </span><span class="comment">lot. Haven't reported upstream tho.
</span>
  <span class="comment-delimiter">;; </span><span class="comment">Put archive files under an archive/ directory
</span>  <span class="comment-delimiter">;; </span><span class="comment">I don't want them to pollute my directory
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-archive-location <span class="string">&quot;archive/%s_archive::&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-directory <span class="string">&quot;~/Documents/notes&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-id-link-to-org-use-id <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">create-if-interactive-and-no-custom-id</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ org-store-link creates an ID for header only if called interactively and if there is no custom id
</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Automatically invoke `</span><span class="constant">org-indent-mode</span><span class="comment">' which gives nice little
</span>  <span class="comment-delimiter">;; </span><span class="comment">indentation under subsections. It makes reading easier. This does
</span>  <span class="comment-delimiter">;; </span><span class="comment">not add any spaces/tabs to the text file, the indentation is only
</span>  <span class="comment-delimiter">;; </span><span class="comment">visually apparent in Emacs.
</span>  <span class="comment-delimiter">;; </span><span class="comment">(add-hook 'org-mode-hook #'org-indent-mode t)
</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-org-calendar-directory</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;%s/calendars&quot;</span> org-directory<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-calendar-files
        <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>file-exists-p im-org-calendar-directory<span class="rainbow-delimiters-depth-4-face">)
          (</span>directory-files im-org-calendar-directory <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">full</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">rx</span> <span class="string">&quot;.org&quot;</span> eos<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> org-agenda-files <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span>,bullet-org ,projects-org ,work-org ,people-org ,readinglist-org ,watchlist-org ,life-org ,netherlands-org ,@im-calendar-files<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">When I unfold an header if the contents are longer than remaining
</span>  <span class="comment-delimiter">;; </span><span class="comment">window width then cursor recenters to the top of the window. I
</span>  <span class="comment-delimiter">;; </span><span class="comment">disable with the following line.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-cycle</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">setq</span> org-cycle-hook <span class="rainbow-delimiters-depth-4-face">(</span>delq <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-cycle-optimize-window-after-visibility-change</span> org-cycle-hook<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-link-abbrev-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;imdb&quot;</span> . <span class="string">&quot;https://www.imdb.com/title/%s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-link-abbrev-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;yt&quot;</span> . <span class="string">&quot;https://youtu.be/%s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ More info: https://orgmode.org/manual/Link-Abbreviations.html
</span>
  <span class="comment-delimiter">;; </span><span class="comment">With the following, I can call functions defined inside this file in other org files
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-babel-lob-ingest <span class="rainbow-delimiters-depth-3-face">(</span>concat org-directory <span class="string">&quot;/utils.org&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">org-contrib</span> <span class="builtin">:after</span> org<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">http://www.foldl.me/2012/disabling-electric-indent-mode/
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-disable-electric-indent</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>set <span class="rainbow-delimiters-depth-3-face">(</span>make-local-variable <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">electric-indent-functions</span><span class="rainbow-delimiters-depth-3-face">)
       (</span>list <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>arg<span class="rainbow-delimiters-depth-5-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">no-indent</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-electric-indent</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">evil-org</span>
  <span class="builtin">:after</span> <span class="rainbow-delimiters-depth-2-face">(</span>org org-agenda<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;&lt;RET&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-return</span>
   <span class="string">&quot;S-&lt;return&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-link-to-indirect-buffer</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>insert normal<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;M-Q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-unfill-paragraph</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span>
    <span class="string">&quot;oyy&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-store-link-dwim</span>
    <span class="string">&quot;oa&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda</span>
    <span class="string">&quot;ow&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">widen</span>
    <span class="comment-delimiter">;; </span><span class="comment">org-capture
</span>    <span class="string">&quot;og&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-capture</span>
    <span class="string">&quot;oG&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-capture-goto-last-stored</span>
    <span class="comment-delimiter">;; </span><span class="comment">org-clock
</span>    <span class="string">&quot;occ&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clock-in</span>
    <span class="string">&quot;ocC&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clock-cancel</span>
    <span class="string">&quot;ocr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clock-in-last</span>
    <span class="string">&quot;ocl&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clock-in-last</span>
    <span class="string">&quot;oco&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clock-out</span>
    <span class="string">&quot;ocg&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clock-goto</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span>
    <span class="comment-delimiter">;; </span><span class="comment">general
</span>    <span class="string">&quot;op&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-set-property</span>
    <span class="string">&quot;oi&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-toggle-inline-images</span>
    <span class="string">&quot;oI&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-redisplay-inline-images</span>
    <span class="string">&quot;or&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-refile</span>
    <span class="string">&quot;oR&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-mode-restart</span>
    <span class="string">&quot;oh&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-show-only-headings</span>
    <span class="string">&quot;os&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-schedule</span>
    <span class="string">&quot;od&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-deadline</span>
    <span class="string">&quot;ov&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-babel-expand-src-block</span>
    <span class="string">&quot;oq&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-tree-to-indirect-buffer</span>
    <span class="string">&quot;oQ&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-link-to-indirect-buffer</span>
    <span class="string">&quot;o1&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-show-outline-only</span>
    <span class="comment-delimiter">;; </span><span class="comment">link stuff
</span>    <span class="string">&quot;oyi&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-copy-id</span>
    <span class="comment-delimiter">;; </span><span class="comment">src blocks etc
</span>    <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-babel-remove-result</span>
    <span class="string">&quot;D&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-babel-remove-all-results</span>
    <span class="string">&quot;oo&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-babel-result-to-buffer</span>
    <span class="string">&quot;oe&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-edit-special</span>
    <span class="string">&quot;ot&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-babel-tangle-current-block</span>
    <span class="string">&quot;o-&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-babel-demarcate-block</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src-mode-map</span>
    <span class="string">&quot;ot&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-babel-tangle-current-block</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader-v</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span>
    <span class="string">&quot;o#&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-insert-structure-template</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader-v</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src-mode-map</span>
    <span class="string">&quot;oe&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-edit-src-exit</span>
    <span class="string">&quot;oE&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-edit-src-abort</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-mode . evil-org-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">evil-org-agenda</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-org-agenda-set-keys<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-org-set-key-theme <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>textobjects insert navigation additional shift todo heading<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-normalize-keymaps</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-tree-to-indirect-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Same as `</span><span class="constant">org-tree-to-indirect-buffer</span><span class="doc">' but let's you open
  multiple indirect buffers.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>current-prefix-arg <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span>4<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-tree-to-indirect-buffer</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-org-focused-tree-to-indirect-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> forms<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Same as `</span><span class="constant">org-tree-to-indirect-buffer</span><span class="doc">' but let's you open
  multiple indirect buffers.&quot;</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>current-prefix-arg <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span>4<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>source-buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
         target-buffer<span class="rainbow-delimiters-depth-3-face">)
     (</span><span class="keyword">save-excursion</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">save-restriction</span>
         <span class="rainbow-delimiters-depth-5-face">(</span>widen<span class="rainbow-delimiters-depth-5-face">)</span>
         ,@forms
         <span class="rainbow-delimiters-depth-5-face">(</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-tree-to-indirect-buffer</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">setq</span> target-buffer <span class="rainbow-delimiters-depth-6-face">(</span>current-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">If the link points to another buffer, current window will start
</span>     <span class="comment-delimiter">;; </span><span class="comment">showing that buffer. We don't want that, so we are restoring
</span>     <span class="comment-delimiter">;; </span><span class="comment">the current buffer here:
</span>     <span class="rainbow-delimiters-depth-3-face">(</span>set-window-buffer nil source-buffer<span class="rainbow-delimiters-depth-3-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Newly opened indirect buffer is not focused automatically, we
</span>     <span class="comment-delimiter">;; </span><span class="comment">fix that here:
</span>     <span class="rainbow-delimiters-depth-3-face">(</span>im-select-window-with-buffer <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;%s::.*&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name target-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>im-show-outline-only<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-link-to-indirect-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open link at point on a new indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Force org to open the link in current window
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-default-browser</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>org-link-frame-setup <span class="rainbow-delimiters-depth-6-face">(</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>cons <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">find-file</span><span class="rainbow-delimiters-depth-7-face">)</span> org-link-frame-setup<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">pcase</span> <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:type</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-element-context<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="string">&quot;http&quot; &quot;https&quot;</span><span class="rainbow-delimiters-depth-6-face">) (</span>org-open-at-point<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>_ <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
           <span class="comment-delimiter">;; </span><span class="comment">If we are in an indirect buffer, then find the real
</span>           <span class="comment-delimiter">;; </span><span class="comment">buffer and widen it so that org-open-at-point
</span>           <span class="comment-delimiter">;; </span><span class="comment">works. This does not restore narrowing but whatever.
</span>           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-8-face">(</span>base <span class="rainbow-delimiters-depth-9-face">(</span>buffer-base-buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">with-current-buffer</span> base
               <span class="rainbow-delimiters-depth-9-face">(</span>switch-to-buffer <span class="rainbow-delimiters-depth-1-face">(</span>current-buffer<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
               (</span>widen<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>org-open-at-point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-show-outline-only</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show all headers but hide all bodies.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>outline-next-heading<span class="rainbow-delimiters-depth-3-face">)
    (</span>outline-show-branches<span class="rainbow-delimiters-depth-3-face">)
    (</span>outline-hide-body<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Babel
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> General configuration
</span>
<span class="comment-delimiter">;; </span><span class="comment">Allow these languages to run in code blocks
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-babel-do-load-languages
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-babel-load-languages</span>
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>emacs-lisp . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>shell . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>scheme . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>python . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>jupyter . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>julia . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>verb . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>http . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>R . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>haskell . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>js . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>sql . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>dot . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>gnuplot . t<span class="rainbow-delimiters-depth-4-face">)
     (</span>plantuml . t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: im-load-ob-lang-lazy
</span><span class="comment-delimiter">;; </span><span class="comment">(defmacro im-load-ob-lang-lazy (&amp;rest langs)
</span><span class="comment-delimiter">;;   </span><span class="comment">&quot;Like `</span><span class="constant">org-babel-do-load-languages</span><span class="comment">' but load them lazily using `</span><span class="constant">use-package</span><span class="comment">'.&quot;
</span><span class="comment-delimiter">;;   </span><span class="comment">`(progn
</span><span class="comment-delimiter">;;      </span><span class="comment">,@(mapcar (lambda (lang)
</span><span class="comment-delimiter">;;                  </span><span class="comment">`(use-package ,(intern (concat &quot;ob-&quot; (symbol-name lang)))
</span><span class="comment-delimiter">;;                     </span><span class="comment">:defer t
</span><span class="comment-delimiter">;;                     </span><span class="comment">:straight (:type built-in)
</span><span class="comment-delimiter">;;                     </span><span class="comment">;; </span><span class="default-0035">TODO</span><span class="comment"> add view
</span><span class="comment-delimiter">;;                     </span><span class="comment">:commands (,(intern (concat &quot;org-babel-execute:&quot; (symbol-name lang))))))
</span><span class="comment-delimiter">;;                </span><span class="comment">langs)))
</span><span class="comment-delimiter">;; </span><span class="comment">(im-load-ob-lang-lazy
</span><span class="comment-delimiter">;;  </span><span class="comment">emacs-lisp shell scheme python verb http R haskell js sql dot gnuplot plantuml)
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Helper functions
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some codeblocks produce image files as it's result (like dot
</span><span class="comment-delimiter">;; </span><span class="comment">language). Re-executing these blocks removes the image
</span><span class="comment-delimiter">;; </span><span class="comment">overlay. With this hook images are automatically updated after
</span><span class="comment-delimiter">;; </span><span class="comment">code-block execution and not removed from screen.
</span><span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-babel-after-execute-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-redisplay-images-if-enabled</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-org-babel-split-or-wrap-src-code-block</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-babel-demarcate-block</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-babel-tangle-current-block</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Tangle the current source block and all other related
blocks (the ones that tangles into the same file).

This function also works inside `</span><span class="constant">org-edit-special</span><span class="doc">' buffers and
does not disrupt the current window configuration.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil org-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>src-edit? <span class="rainbow-delimiters-depth-5-face">(</span>org-src-edit-buffer-p<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
        buffer pos
        <span class="rainbow-delimiters-depth-4-face">(</span>current-prefix-arg <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span>16<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;;     </span><span class="comment">^ '(4) only tangles current file, '(16) tangles all code
</span>    <span class="comment-delimiter">;;     </span><span class="comment">blocks related to current tangle file target
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-window-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">when</span> src-edit? <span class="rainbow-delimiters-depth-5-face">(</span>org-edit-src-exit<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> pos <span class="rainbow-delimiters-depth-5-face">(</span>point<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>call-interactively <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-babel-tangle</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> src-edit?
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>org-src-window-setup <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">current-window</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">with-current-buffer</span> buffer
          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-excursion</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>goto-char pos<span class="rainbow-delimiters-depth-7-face">)
            (</span>org-edit-special<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">https://emacs.stackexchange.com/questions/23870/org-babel-result-to-a-separate-buffer/27190#27190
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-babel-result-to-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;A function to efficiently feed babel code block result to a separate buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil org-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-open-at-point<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-babel-remove-result<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-redisplay-images-if-enabled</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">when</span> org-inline-image-overlays
    <span class="rainbow-delimiters-depth-3-face">(</span>org-redisplay-inline-images<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> ob-http &amp; verb-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Http request in org-mode babel.  You can get the generated curl
</span><span class="comment-delimiter">;; </span><span class="comment">command after executing the code block, from *curl command history*
</span><span class="comment-delimiter">;; </span><span class="comment">buffer or using `</span><span class="constant">:print-curl</span><span class="comment">' parameter to the block.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">ob-http</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;ag91/ob-http&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:after</span> org<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">An alternative to ob-http, might be better
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">verb</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;federicotdn/verb&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:after</span> org
  <span class="comment-delimiter">;; </span><span class="comment">:hook (org-mode . verb-mode)
</span>  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;ur&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">verb-send-request-on-point</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-curl-to-org-http</span> <span class="rainbow-delimiters-depth-2-face">(</span>curl-str<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert CURL-STR into an ob-http block.
More concretely this function converts given curl command (that
is copied from Chrome/Firefox dev tools, using the `Copy as curl'
option) into an ob-http block to be able to use all the goodies
that is provided by ob-http.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)
        (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-6-face">(</span>region-beginning<span class="rainbow-delimiters-depth-6-face">) (</span>region-end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>read-string <span class="string">&quot;Curl string: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>tokens <span class="rainbow-delimiters-depth-5-face">(</span>im-cmdargs-tokenize curl-str<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>headers <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>request <span class="string">&quot;GET&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
        url
        <span class="rainbow-delimiters-depth-4-face">(</span>query-params <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)</span>
        data<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--each-indexed</span> tokens
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">pcase</span> it
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="string">&quot;-H&quot; &quot;--header&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-7-face">(</span>nth <span class="rainbow-delimiters-depth-8-face">(</span>1+ it-index<span class="rainbow-delimiters-depth-8-face">)</span> tokens<span class="rainbow-delimiters-depth-7-face">)</span> headers<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="string">&quot;-d&quot; &quot;--data-binary&quot; &quot;--data-raw&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">setq</span> data <span class="rainbow-delimiters-depth-7-face">(</span>nth <span class="rainbow-delimiters-depth-8-face">(</span>1+ it-index<span class="rainbow-delimiters-depth-8-face">)</span> tokens<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="string">&quot;-X&quot; &quot;--request&quot; &quot;--data-raw&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">setq</span> request <span class="rainbow-delimiters-depth-7-face">(</span>nth <span class="rainbow-delimiters-depth-8-face">(</span>1+ it-index<span class="rainbow-delimiters-depth-8-face">)</span> tokens<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
        <span class="comment-delimiter">;; </span><span class="comment">Only supports --data-urlencode in the GET context. It will
</span>        <span class="comment-delimiter">;; </span><span class="comment">append --data-urlencode arguments to url as query string.
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;--data-urlencode&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-7-face">(</span>nth <span class="rainbow-delimiters-depth-8-face">(</span>1+ it-index<span class="rainbow-delimiters-depth-8-face">)</span> tokens<span class="rainbow-delimiters-depth-7-face">)</span> query-params<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="rainbow-delimiters-depth-6-face">(</span>pred <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>x<span class="rainbow-delimiters-depth-8-face">) (</span>s-prefix? <span class="string">&quot;http&quot;</span> x<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">setq</span> url it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>query-params<span class="rainbow-delimiters-depth-5-face">)
               (</span>qs <span class="rainbow-delimiters-depth-6-face">(</span>url-build-query-string <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-split-up-to <span class="string">&quot;=&quot;</span> it 2<span class="rainbow-delimiters-depth-8-face">)</span> query-params<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-contains? <span class="string">&quot;?&quot;</span> url<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">setq</span> url <span class="rainbow-delimiters-depth-6-face">(</span>concat url <span class="string">&quot;&amp;&quot;</span> qs<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> url <span class="rainbow-delimiters-depth-6-face">(</span>concat url <span class="string">&quot;?&quot;</span> qs<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert
     <span class="rainbow-delimiters-depth-4-face">(</span>s-trim <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">im-s-interpolated</span> <span class="string">&quot;#{request} #{url}\n#{(s-join \&quot;\\n\&quot; headers)}\n\n#{(or data \&quot;\&quot;)}&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-cmdargs-tokenize</span> <span class="rainbow-delimiters-depth-2-face">(</span>input<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>insert input<span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>tokens <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">()</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while-let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>chr <span class="rainbow-delimiters-depth-7-face">(</span>get-byte<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>eobp<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">pcase</span> chr
          <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> ?\s ?\t ?\n<span class="rainbow-delimiters-depth-7-face">) (</span>forward-char<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>?\&quot;
           <span class="rainbow-delimiters-depth-7-face">(</span>forward-char<span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">push</span>
            <span class="rainbow-delimiters-depth-8-face">(</span>replace-regexp-in-string
             <span class="rainbow-delimiters-depth-9-face">(</span>regexp-quote <span class="string">&quot;\\\&quot;&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;\&quot;&quot;</span>
             <span class="rainbow-delimiters-depth-9-face">(</span>buffer-substring
              <span class="rainbow-delimiters-depth-1-face">(</span>point<span class="rainbow-delimiters-depth-1-face">)
              (</span>1- <span class="rainbow-delimiters-depth-2-face">(</span>re-search-forward <span class="string">&quot;[</span><span class="negation-char">^</span><span class="string">\\]\&quot;&quot;</span> nil t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
            tokens<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>?\<span class="highlight-quoted-quote">'</span>
           <span class="rainbow-delimiters-depth-7-face">(</span>forward-char<span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-8-face">(</span>buffer-substring
                  <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)
                  (</span>1- <span class="rainbow-delimiters-depth-1-face">(</span>re-search-forward <span class="string">&quot;'&quot;</span> nil t<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                 tokens<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>_ <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-8-face">(</span>buffer-substring
                    <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)</span>
                    <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> Handle eol
</span>                    <span class="rainbow-delimiters-depth-9-face">(</span>1- <span class="rainbow-delimiters-depth-1-face">(</span>re-search-forward <span class="string">&quot;[ \t]&quot;</span> nil t<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                   tokens<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>nreverse tokens<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Exporting
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> HTML
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">htmlize</span> <span class="builtin">:after</span> org<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> iCalendar settings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-icalendar-store-UID t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> org-icalendar-alarm-time 15<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> org-icalendar-use-scheduled <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>todo-start event-if-todo<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> org-icalendar-use-deadline <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>todo-due event-if-todo<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Agenda
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some general settings.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-agenda</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> org
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-agenda-mode-map</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;RET&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-switch-to</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;\t&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-goto</span>
   <span class="string">&quot;s&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-schedule</span>
   <span class="string">&quot;w&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-week-view</span>
   <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-day-view</span>
   <span class="string">&quot;t&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-todo</span>
   <span class="string">&quot;L&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-log-mode</span>
   <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-quit</span>
   <span class="string">&quot;R&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-clockreport-mode</span>
   <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-agenda-redo</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-agenda-remove-tags t<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-include-diary t<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-use-time-grid t<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-time-grid
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>daily today require-timed remove-match<span class="rainbow-delimiters-depth-4-face">)
     (</span>800 900 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 2000 2100 2200 2300 2400<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot; ┄┄┄┄┄ &quot; &quot;┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Make it open faster
</span>  <span class="comment-delimiter">;; </span><span class="comment">https://orgmode.org/manual/Speeding-Up-Your-Agendas.html
</span>  <span class="comment-delimiter">;; </span><span class="comment">https://orgmode.org/worg/agenda-optimization.html
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-agenda-dim-blocked-tasks nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-inhibit-startup t<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-use-tag-inheritance nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-ignore-drawer-properties <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>effort appt category<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-agenda-mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-agenda-finalize-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-force-normal-state</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-caldav (calendar sync)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Sync calendars with: `</span><span class="constant">org-caldav-sync</span><span class="comment">'.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-caldav</span>
  <span class="builtin">:after</span> org
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-caldav-url <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;%s/remote.php/dav/calendars/%s&quot;</span> im-nextcloud-url im-nextcloud-user<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-caldav-calendars <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--map</span>
                         <span class="rainbow-delimiters-depth-4-face">(</span>list
                          <span class="builtin">:calendar-id</span> it
                          <span class="builtin">:inbox</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s/%s.org&quot;</span> im-org-calendar-directory it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
                         im-nextcloud-calendars<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Fix the following, automatically get
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-icalendar-timezone <span class="string">&quot;Europe/Amsterdam&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Set it under the notes directory so that they will be synced
</span>  <span class="comment-delimiter">;; </span><span class="comment">between devices
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-caldav-save-directory <span class="string">&quot;~/Documents/notes/data/&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Set the following to nil, I already have set `</span><span class="constant">org-caldav-calendars</span><span class="comment">' above
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>org-caldav-inbox nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-caldav-calendar-id nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-caldav-files nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> ToDo keywords &amp; faces
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="comment-delimiter">;; </span><span class="comment">Add this to org files if you need:
</span>  <span class="comment-delimiter">;; </span><span class="comment">#+</span><span class="default-0035">TODO</span><span class="comment">: </span><span class="default-0035">TODO</span><span class="comment"> PROG WAITING DONE
</span>  <span class="comment-delimiter">;; </span><span class="comment">OR
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-todo-keywords
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>sequence <span class="string">&quot;</span><span class="default-0037">TODO</span><span class="string">(t)&quot; &quot;PROG(p)&quot; &quot;WAIT(w)&quot; &quot;DONE(d)&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Now you can do C-c C-t {t,p,w,d} to set the state directly
</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-todo-keyword-faces
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;WAIT&quot;</span> . <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;yellow&quot;</span> <span class="builtin">:weight</span> bold<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="string">&quot;PROG&quot;</span> . <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;magenta&quot;</span> <span class="builtin">:weight</span> bold <span class="builtin">:underline</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>custom-set-faces
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-headline-done <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:strike-through</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-agenda-done <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:strike-through</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-column <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:background</span> unspecified<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-scheduled-today <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;light green&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>

   <span class="comment-delimiter">;; </span><span class="comment">Make some stuff small
</span>   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-drawer <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:height</span> 0.8<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-special-keyword <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:height</span> 0.8<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>org-block-end-line <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:height</span> 0.8<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-capture
</span>
<span class="comment-delimiter">;; </span><span class="comment">See [[https://orgmode.org/manual/Template-elements.html#Template-elements][this page]] for more detail on template elements.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some functions that I utilize for capture templates:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-daily-last-entry</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>im-bullet-focus-today<span class="rainbow-delimiters-depth-2-face">)
  (</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-max<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-daily-summary</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>im-bullet-focus-today<span class="rainbow-delimiters-depth-2-face">)
  (</span>re-search-forward <span class="string">&quot;^** Summary&quot;</span> nil t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-first-top-level-todo-entry</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Find first top-level </span><span class="default-0038">TODO</span><span class="doc"> entry in current buffer.
This way you can insert new entry right after other non-</span><span class="default-0038">TODO</span><span class="doc">
entries.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-min<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>re-search-forward <span class="string">&quot;^\\* </span><span class="default-0037">TODO</span><span class="string">&quot;</span> nil t<span class="rainbow-delimiters-depth-2-face">)
  (</span>beginning-of-line<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-first-N-level-todo-entry</span> <span class="rainbow-delimiters-depth-2-face">(</span>n<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find first N-level </span><span class="default-0038">TODO</span><span class="doc"> entry in current buffer.
This way you can insert new entry right after other non-</span><span class="default-0038">TODO</span><span class="doc">
  entries.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-min<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>re-search-forward <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;^\\*\\{</span><span class="variable-name">%s\\</span><span class="string">} </span><span class="default-0037">TODO</span><span class="string">&quot;</span> n<span class="rainbow-delimiters-depth-3-face">)</span> nil t<span class="rainbow-delimiters-depth-2-face">)
  (</span>beginning-of-line<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-first-top-level-todo-entry-within-header</span> <span class="rainbow-delimiters-depth-2-face">(</span>header<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find first top-level </span><span class="default-0038">TODO</span><span class="doc"> entry in under HEADER in current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">()
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span>n<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>re-search-forward <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\*+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> %s&quot;</span> header<span class="rainbow-delimiters-depth-6-face">)</span> nil t<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">setq</span> n <span class="rainbow-delimiters-depth-6-face">(</span>1+ <span class="rainbow-delimiters-depth-7-face">(</span>length <span class="rainbow-delimiters-depth-8-face">(</span>match-string 1<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="warning">user-error</span> <span class="string">&quot;Cannot find header %s&quot;</span> header<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">save-restriction</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-5-face">)
        (</span>im-org-capture--find-first-N-level-todo-entry n<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-snippet</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>mode-name <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-capture-get <span class="builtin">:original-buffer</span><span class="rainbow-delimiters-depth-6-face">)
                      (</span>symbol-name major-mode<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>result <span class="rainbow-delimiters-depth-5-face">(</span>org-find-exact-headline-in-buffer mode-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> result
        <span class="rainbow-delimiters-depth-4-face">(</span>goto-char result<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>re-search-forward <span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">&quot;</span> org-outline-regexp <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> nil t<span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-line -1<span class="rainbow-delimiters-depth-4-face">)
      (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;\n* %s&quot;</span> mode-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-capture--find-snippet-one-liner</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>im-org-capture--find-snippet<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>re-search-forward <span class="string">&quot;\\*\\* One-liners&quot;</span> nil t<span class="rainbow-delimiters-depth-3-face">)
    (</span>end-of-line<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="string">&quot;\n** One-liners&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span>
   org-capture-templates
   <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;i&quot; &quot;Inbox&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>file+headline bullet-org <span class="string">&quot;Inbox&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;- %U %?&quot;</span>
      <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;I&quot; &quot;Work Inbox&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>file+headline work-org <span class="string">&quot;Inbox&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;- %U %?&quot;</span>
      <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;n&quot; &quot;Meeting/clock note&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>clock<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;t&quot; &quot;Study/investigate later&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>file+olp bullet-org <span class="string">&quot;Life backlog&quot; &quot;Investigate&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;- [ ] %U %(im-org-make-link-string (read-string \&quot;URL: \&quot;))&quot;</span>
      <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;l&quot; &quot;Life todo&quot;</span> plain
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function bullet-org ,<span class="rainbow-delimiters-depth-6-face">(</span>im-org-capture--find-first-top-level-todo-entry-within-header <span class="string">&quot;Life backlog&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#B] %?\n:PROPERTIES:\n:CREATED_AT: %U\n:END:\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;w&quot; &quot;Work todo&quot;</span> plain
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function bullet-org ,<span class="rainbow-delimiters-depth-6-face">(</span>im-org-capture--find-first-top-level-todo-entry-within-header <span class="string">&quot;Work backlog&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#B] %?\n:PROPERTIES:\n:CREATED_AT: %U\n:END:\n&quot;</span> <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;c&quot; &quot;Computer todo&quot;</span> plain
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function bullet-org ,<span class="rainbow-delimiters-depth-6-face">(</span>im-org-capture--find-first-top-level-todo-entry-within-header <span class="string">&quot;Computer backlog&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#B] %?\n:PROPERTIES:\n:CREATED_AT: %U\n:END:\n&quot;</span> <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;f&quot; &quot;Free time backlog&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>file+headline bullet-org <span class="string">&quot;Free time backlog&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;- %U %?&quot;</span> <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;T&quot; &quot;Daily </span><span class="default-0037">TODO</span><span class="string">&quot;</span> plain
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function bullet-org im-org-capture--find-daily-last-entry<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#B] %?\n:PROPERTIES:\n:CREATED_AT: %U\n:END:\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;S&quot; &quot;Daily summary&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function bullet-org im-org-capture--find-daily-summary<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;- %U %?&quot;</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;a&quot; &quot;Shopping&quot;</span> plain
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function bullet-org ,<span class="rainbow-delimiters-depth-6-face">(</span>im-org-capture--find-first-top-level-todo-entry-within-header <span class="string">&quot;Alisveris&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;*** </span><span class="default-0037">TODO</span><span class="string"> [#B] %?\n:PROPERTIES:\n:CREATED_AT: %U\n:END:\n&quot;</span>
      <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;m&quot; &quot;Watchlist item&quot;</span> plain
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function watchlist-org im-org-capture--find-first-top-level-todo-entry<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;* </span><span class="default-0037">TODO</span><span class="string"> %?\n:PROPERTIES:\n:CREATED_AT: %U\n:WHY: FILLME!\n:END:\n\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;D&quot; &quot;Diary&quot;</span> entry
      <span class="rainbow-delimiters-depth-5-face">(</span>file diary-org<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;* %u\n&quot;</span>
      <span class="builtin">:prepend</span> t<span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;s&quot; &quot;Snippets&quot;</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;ss&quot; &quot;Snippet&quot;</span> entry
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function snippets-org im-org-capture--find-snippet<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;** &quot;</span><span class="rainbow-delimiters-depth-4-face">)

     (</span><span class="string">&quot;so&quot; &quot;One liner snippet&quot;</span> item
      <span class="rainbow-delimiters-depth-5-face">(</span>file+function snippets-org im-org-capture--find-snippet-one-liner<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="string">&quot;- %? :: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-refile
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-refile-targets <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>org-agenda-files . <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:maxlevel</span> . 3<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Show the full path of the header
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-refile-use-outline-path <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Make the refile completion work with vertico
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-outline-path-complete-in-steps nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Add new headers by appending &quot;/new header name&quot; and refile creates it for you
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> org-refile-allow-creating-parent-nodes <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">confirm</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-modern
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-modern</span>
  <span class="builtin">:after</span> org
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-modern-timestamp nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-use-sub-superscripts nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-modern-table nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-modern-hide-stars <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-modern-list
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="comment-delimiter">;; </span><span class="comment">(?- . &quot;-&quot;)
</span>     <span class="rainbow-delimiters-depth-4-face">(</span>?* . <span class="string">&quot;•&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>?+ . <span class="string">&quot;‣&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-modern-todo-faces
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;PROG&quot;</span> <span class="builtin">:background</span> <span class="string">&quot;purple&quot;</span> <span class="builtin">:foreground</span> <span class="string">&quot;plum1&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;WAIT&quot;</span> <span class="builtin">:background</span> <span class="string">&quot;goldenrod3&quot;</span> <span class="builtin">:foreground</span> <span class="string">&quot;yellow2&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-modern-priority-faces
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>?A <span class="builtin">:background</span> <span class="string">&quot;forest green&quot;</span> <span class="builtin">:foreground</span> <span class="string">&quot;beige&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>?B <span class="builtin">:background</span> <span class="string">&quot;goldenrod&quot;</span> <span class="builtin">:foreground</span> <span class="string">&quot;beige&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>?C <span class="builtin">:background</span> <span class="string">&quot;coral&quot;</span> <span class="builtin">:foreground</span> <span class="string">&quot;beige&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>?D <span class="builtin">:background</span> <span class="string">&quot;red3&quot;</span> <span class="builtin">:foreground</span> <span class="string">&quot;beige&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-mode . org-modern-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-agenda-finalize . org-modern-agenda<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-rainbow-tags
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-rainbow-tags</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-rainbow-tags-hash-start-index 6<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-rainbow-tags-extra-face-attributes
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:inverse-video</span> t <span class="builtin">:box</span> nil <span class="builtin">:weight</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bold</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-mode . org-rainbow-tags-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-ql
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-ql</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:after</span> org
  <span class="comment-delimiter">;; </span><span class="comment">Load org-ql-search prematurely to be able to use org-ql blocks in
</span>  <span class="comment-delimiter">;; </span><span class="comment">org-mode
</span>  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">org-ql-search</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Here are some utility functions that I use in org-ql dynamic blocks:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">sort-by-num-prop</span> <span class="rainbow-delimiters-depth-2-face">(</span>prop x y<span class="rainbow-delimiters-depth-2-face">)
  (</span>&lt; <span class="rainbow-delimiters-depth-3-face">(</span>string-to-number <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property prop y<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;0&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>string-to-number <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property prop x<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;0&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">sort-by-prop</span> <span class="rainbow-delimiters-depth-2-face">(</span>prop x y<span class="rainbow-delimiters-depth-2-face">)
  (</span>string&lt; <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>org-element-property prop y<span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)
           (</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>org-element-property prop x<span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">You have to use ~:sort (lambda ...)~ syntax in org-ql dynamic
</span><span class="comment-delimiter">;; </span><span class="comment">blocks if you want to supply a function for the ~:sort~
</span><span class="comment-delimiter">;; </span><span class="comment">parameter. You can't use a function that returns a lambda, hence
</span><span class="comment-delimiter">;; </span><span class="comment">the functions defined above should be used like this:
</span>
<span class="comment-delimiter">;; </span><span class="comment">#+begin: org-ql :query ... :sort (lambda (x y) (sort-by-num-prop :RATING x y))
</span><span class="comment-delimiter">;; </span><span class="comment">#+end
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here are some predefined searches:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-ql-current-week-tasks</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>week-end <span class="rainbow-delimiters-depth-5-face">(</span>im-date <span class="string">&quot;next monday - 1 day&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-ql-search org-agenda-files
      <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>scheduled <span class="builtin">:to</span> ,week-end<span class="rainbow-delimiters-depth-6-face">)
                (</span>deadline <span class="builtin">:to</span> ,week-end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
            (</span>not <span class="rainbow-delimiters-depth-6-face">(</span>done<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;W%s&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>format-time-string <span class="string">&quot;%U&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:super-groups</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:auto-category</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:sort</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>date<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Linking improvements
</span>
<span class="comment-delimiter">;; </span><span class="comment">Org does not provide an easy way to copy link at point. Here is a fix for that:
</span>
<span class="comment-delimiter">;; </span><span class="comment">Source: https://emacs.stackexchange.com/a/60555
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-link-copy</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Extract URL from org-mode link and add it to kill ring.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>link <span class="rainbow-delimiters-depth-5-face">(</span>org-element-lineage <span class="rainbow-delimiters-depth-6-face">(</span>org-element-context<span class="rainbow-delimiters-depth-6-face">)</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span>link<span class="rainbow-delimiters-depth-6-face">)</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>type <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:type</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>url <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:path</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>url <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> type url <span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>s-blank? url<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">) (</span>concat type <span class="string">&quot;:&quot;</span> url<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">any</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>message <span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="string">&quot;Copied URL: &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-kill url<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    url<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-store-link-dwim</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">org-store-link</span><span class="doc">' but if point is on an org-link, just copy
    it to clipboard. Otherwise call `</span><span class="constant">org-store-link</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>org-in-regexp org-link-any-re 1<span class="rainbow-delimiters-depth-3-face">)
      (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-link-copy</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-store-link nil t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Show expanded links at point
</span>
<span class="comment-delimiter">;; </span><span class="comment">This following trick (got it from
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://www.reddit.com/r/emacs/comments/o68i0v/weekly_tips_tricks_c_thread/h2rizey?utm_source=share&amp;utm_medium=web2x&amp;context=3][this]]
</span><span class="comment-delimiter">;; </span><span class="comment">comment) simply calls =C-h .= (=display-local-help=) when idle,
</span><span class="comment-delimiter">;; </span><span class="comment">which shows the destination of links in the echo area (and maybe
</span><span class="comment-delimiter">;; </span><span class="comment">displays other helpful stuff).
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-help-at-point-mode</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show tooltips in the echo area automatically for current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> help-at-pt-display-when-idle t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> help-at-pt-timer-delay 0<span class="rainbow-delimiters-depth-2-face">)
  (</span>help-at-pt-cancel-timer<span class="rainbow-delimiters-depth-2-face">)
  (</span>help-at-pt-set-timer<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-help-at-point-mode</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Insert links/images more intelligently
</span>
<span class="comment-delimiter">;; </span><span class="comment">- if region is selected and there is a url in the clipboard, convert it to a link directly.
</span><span class="comment-delimiter">;; </span><span class="comment">- if nothing is selected and there is a link in clipboard, just insert it as a link with the link's own title.
</span><span class="comment-delimiter">;; </span><span class="comment">- if clipboard has in image in it, save that into a file that you interactively select and then insert it into the buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">- otherwise call ~org-insert-link~
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader-v</span> <span class="string">&quot;oP&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-insert-dwim</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-mode-map</span> <span class="string">&quot;C-o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-insert-dwim</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-insert-dwim</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">org-insert-link</span><span class="doc">' but improved with dwim features.
Based on: https://xenodium.com/emacs-dwim-do-what-i-mean/&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>point-in-link <span class="rainbow-delimiters-depth-5-face">(</span>org-in-regexp org-link-any-re 1<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>clipboard-url <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>string-match-p <span class="string">&quot;^http&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>current-kill 0<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                          (</span>current-kill 0<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>region-content <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>region-active-p<span class="rainbow-delimiters-depth-6-face">)
                           (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>region-beginning<span class="rainbow-delimiters-depth-7-face">)
                                                           (</span>region-end<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>im-clipboard-contains-image-p<span class="rainbow-delimiters-depth-5-face">)
      (</span>call-interactively <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-org-attach-image-from-clipboard</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> region-content clipboard-url <span class="rainbow-delimiters-depth-6-face">(</span>not point-in-link<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>delete-region <span class="rainbow-delimiters-depth-6-face">(</span>region-beginning<span class="rainbow-delimiters-depth-6-face">) (</span>region-end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>insert <span class="rainbow-delimiters-depth-6-face">(</span>org-make-link-string clipboard-url region-content<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> clipboard-url <span class="rainbow-delimiters-depth-6-face">(</span>not point-in-link<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>insert <span class="rainbow-delimiters-depth-6-face">(</span>im-org-make-link-string clipboard-url<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>t
      <span class="rainbow-delimiters-depth-5-face">(</span>call-interactively <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-insert-link</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-attach-image-from-clipboard</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> file-path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Attach the image in the clipboard into your org-buffer.
This function saves the image file into the FILE-PATH or if it's
not provided then it saves the image into ~/.cache.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-file-name
     <span class="string">&quot;Save file to (leave empty to create a temp file): &quot;</span>
     nil nil nil <span class="rainbow-delimiters-depth-5-face">(</span>im-org-suggest-filename nil <span class="string">&quot;.png&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>file <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> file-path <span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>string-empty-p file-path<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span>file-relative-name file-path<span class="rainbow-delimiters-depth-6-face">)
                (</span>expand-file-name <span class="rainbow-delimiters-depth-7-face">(</span>make-temp-file <span class="string">&quot;~/.cache/org_temp_image_&quot;</span> nil <span class="string">&quot;.png&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-save-clipboard-image-to-file file<span class="rainbow-delimiters-depth-4-face">)
        (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;#+ATTR_ORG: :width 400\n[[file:%s]]&quot;</span> file<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;Saving file failed!&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-make-link-string</span> <span class="rainbow-delimiters-depth-2-face">(</span>url<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">org-make-link-string</span><span class="doc">' but fetches URL and extracts the
title automatically.  Also adds author and duration info to
YouTube links.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>im-youtube-link-extract-id url<span class="rainbow-delimiters-depth-4-face">) (</span>im-org-format-youtube-link url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t <span class="rainbow-delimiters-depth-4-face">(</span>org-link-make-string url <span class="rainbow-delimiters-depth-5-face">(</span>im-url-get-title url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">YouTube related
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-youtube-link-extract-id</span> <span class="rainbow-delimiters-depth-2-face">(</span>link<span class="rainbow-delimiters-depth-2-face">)
  (</span>nth 4 <span class="rainbow-delimiters-depth-3-face">(</span>s-match <span class="string">&quot;https?://</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">www\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">youtu\\.be</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">youtube.com</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">watch\\?v=</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[a-zA-Z0-9_-]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">&amp;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?/?&quot;</span> link<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-format-youtube-link</span> <span class="rainbow-delimiters-depth-2-face">(</span>link<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Format given YouTube link as org-mode link.
Length, author, title etc. are appended to the link.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>id <span class="rainbow-delimiters-depth-5-face">(</span>im-youtube-link-extract-id link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let-alist</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-request <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s/videos/%s&quot;</span> empv-invidious-instance id<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-link-make-string
       link
       <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%0.2f mins, by %s || %s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>/ .lengthSeconds 60.0<span class="rainbow-delimiters-depth-6-face">)</span> .author .title<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Find backlinks dynamically
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;oB&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-link-find-backlinks</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-link-find-backlinks</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> id<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find backlinks for ID (or current heading).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory org-directory<span class="rainbow-delimiters-depth-4-face">)
        (</span>id <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> id <span class="rainbow-delimiters-depth-6-face">(</span>org-id-get<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> id
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="warning">user-error</span> <span class="string">&quot;No ID found for current heading&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:command</span> <span class="string">&quot;rg&quot;</span>
     <span class="builtin">:args</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span>,<span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;\\[\\[</span><span class="constant">id:%s\\</span><span class="string">]&quot;</span> id<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;--color=never&quot; &quot;--no-heading&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-finish</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>out<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>infos <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-9-face">(</span>-take 2 <span class="rainbow-delimiters-depth-1-face">(</span>s-split-up-to <span class="string">&quot;:&quot;</span> it 2<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">) (</span>s-split <span class="string">&quot;\n&quot;</span> out t<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>backlinks <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">-&gt;&gt;</span>
                          <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">--map</span>
                           <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>find-file-noselect <span class="rainbow-delimiters-depth-3-face">(</span>f-join default-directory <span class="rainbow-delimiters-depth-4-face">(</span>car it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                             (</span><span class="keyword">save-excursion</span>
                               <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-restriction</span>
                                 <span class="rainbow-delimiters-depth-4-face">(</span>widen<span class="rainbow-delimiters-depth-4-face">)
                                 (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                                 (</span>forward-line <span class="rainbow-delimiters-depth-5-face">(</span>1- <span class="rainbow-delimiters-depth-6-face">(</span>string-to-number <span class="rainbow-delimiters-depth-7-face">(</span>nth 1 it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                                 (</span>format
                                  <span class="string">&quot;- [[file:%s][%s]] :: %s / %s&quot;</span>
                                  <span class="rainbow-delimiters-depth-5-face">(</span>car it<span class="rainbow-delimiters-depth-5-face">)
                                  (</span>car it<span class="rainbow-delimiters-depth-5-face">)
                                  (</span>s-join <span class="string">&quot; → &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;*%s*&quot;</span> it<span class="rainbow-delimiters-depth-7-face">) (</span>org-get-outline-path<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                                  (</span>substring-no-properties <span class="rainbow-delimiters-depth-6-face">(</span>org-store-link nil<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                                  (</span>im-org-header-line-to-title <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
                           infos<span class="rainbow-delimiters-depth-9-face">)
                          (</span>-uniq<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>im-peek
          <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">()
            (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-9-face">(</span>get-buffer-create <span class="string">&quot;*im-org-link-backlinks*&quot;</span><span class="rainbow-delimiters-depth-9-face">)
              (</span>erase-buffer<span class="rainbow-delimiters-depth-9-face">)
              (</span>insert <span class="rainbow-delimiters-depth-1-face">(</span>s-join <span class="string">&quot;\n&quot;</span> backlinks<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
              (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-1-face">(</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-1-face">)
                (</span>org-mode<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
              (</span>current-buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Jump to a header or link a header
</span>
<span class="comment-delimiter">;; </span><span class="comment">Keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;ol&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-link-header</span>
  <span class="string">&quot;oj&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-jump-to-header</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Utility
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-header-line-to-title</span> <span class="rainbow-delimiters-depth-2-face">(</span>line<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Remove </span><span class="default-0038">TODO</span><span class="doc">/*/unnecessary whitespace from given LINE.
Then return the title of given `org-mode` header.  Just
like (org-entry-get nil \&quot;ITEM\&quot;) but works on given string.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span> line
       <span class="rainbow-delimiters-depth-3-face">(</span>s-replace-regexp <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="default-0037">TODO</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">PROG</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">DONE</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">WAIT</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Remove </span><span class="default-0035">TODO</span><span class="comment"> states
</span>       <span class="rainbow-delimiters-depth-3-face">(</span>s-replace-regexp <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\[#.\\{</span><span class="variable-name">1\\</span><span class="string">}\\]\</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Remove priorities
</span>       <span class="rainbow-delimiters-depth-3-face">(</span>s-replace-regexp <span class="string">&quot;:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">+$&quot;  &quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Remove tags
</span>       <span class="rainbow-delimiters-depth-3-face">(</span>replace-regexp-in-string <span class="string">&quot;\\[\\[</span><span class="constant">.*\\</span><span class="string">]\\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]\\]&quot;  &quot;\\1&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Fix links
</span>       <span class="rainbow-delimiters-depth-3-face">(</span>replace-regexp-in-string <span class="string">&quot;\\[\\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]\\]&quot;  &quot;\\1&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Fix links
</span>       <span class="rainbow-delimiters-depth-3-face">(</span>s-trim<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-file-get-header-id</span> <span class="rainbow-delimiters-depth-2-face">(</span>file-path header-line<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return the id of given header at HEADER-LINE in FILE-PATH.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>enable-local-variables nil<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">) (</span>find-file-noselect file-path<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">save-restriction</span>
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-excursion</span>
          <span class="rainbow-delimiters-depth-6-face">(</span>widen<span class="rainbow-delimiters-depth-6-face">)
          (</span>goto-char 0<span class="rainbow-delimiters-depth-6-face">)
          (</span>forward-line header-line<span class="rainbow-delimiters-depth-6-face">)
          (</span>org-id-get nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">create</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>save-buffer<span class="rainbow-delimiters-depth-6-face">)
          (</span>org-id-get nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">create</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-all-headers</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return all headers in `</span><span class="constant">org-directory</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span> <span class="rainbow-delimiters-depth-3-face">(</span>concat <span class="string">&quot;cd &quot;</span> org-directory <span class="string">&quot;; &quot;
               &quot;rg&quot;
               &quot; --no-heading&quot; &quot; --with-filename&quot;
               &quot; --line-number&quot; &quot; -t org&quot;
               &quot; &quot; &quot;\&quot;^\\*+ \&quot; &quot;</span><span class="rainbow-delimiters-depth-3-face">)
       (</span>shell-command-to-string<span class="rainbow-delimiters-depth-3-face">)
       (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
       (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span>s-blank? it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
       (</span><span class="keyword">--map</span>
        <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">-let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>fname line . content<span class="rainbow-delimiters-depth-7-face">) (</span>split-string it <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                (</span>header <span class="rainbow-delimiters-depth-7-face">(</span>im-org-header-line-to-title <span class="rainbow-delimiters-depth-8-face">(</span>string-join content <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
          <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span>,<span class="rainbow-delimiters-depth-6-face">(</span>format
              <span class="string">&quot;%s:%s %s %s&quot;</span>
              <span class="rainbow-delimiters-depth-7-face">(</span>propertize fname <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;plum&quot;</span>  <span class="builtin">:slant</span> italic<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>propertize line <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="builtin">:slant</span> italic <span class="builtin">:weight</span> thin<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>propertize <span class="string">&quot;»&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;green&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>propertize header <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;sky blue&quot;</span> <span class="builtin">:weight</span> bold<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
            .
            <span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:fname</span> ,<span class="rainbow-delimiters-depth-7-face">(</span>concat org-directory <span class="string">&quot;/&quot;</span> fname<span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:line</span> ,<span class="rainbow-delimiters-depth-7-face">(</span>1- <span class="rainbow-delimiters-depth-8-face">(</span>string-to-number line<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:header</span> ,header<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-link-header</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Interactively select a header and insert it as a link into the buffer.
Headers are gathered from all the org files found in `</span><span class="constant">org-directory</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>save-some-buffers<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>selected <span class="rainbow-delimiters-depth-5-face">(</span>im-alist-completing-read
                    <span class="string">&quot;Select header: &quot;</span>
                    <span class="rainbow-delimiters-depth-6-face">(</span>im-org-all-headers<span class="rainbow-delimiters-depth-6-face">)
                    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span>use-region-p<span class="rainbow-delimiters-depth-7-face">)
                      (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-8-face">(</span>region-beginning<span class="rainbow-delimiters-depth-8-face">) (</span>region-end<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>header-id <span class="rainbow-delimiters-depth-5-face">(</span>im-org-file-get-header-id <span class="rainbow-delimiters-depth-6-face">(</span>plist-get selected <span class="builtin">:fname</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get selected <span class="builtin">:line</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-insert-link
     nil
     <span class="rainbow-delimiters-depth-4-face">(</span>concat <span class="string">&quot;id:&quot;</span> header-id<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)
       (</span>read-string <span class="string">&quot;Enter link text: &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get selected <span class="builtin">:header</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-jump-to-header</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Jump to selected header.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>selected <span class="rainbow-delimiters-depth-5-face">(</span>im-alist-completing-read <span class="string">&quot;Select header:&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-org-all-headers<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>find-file <span class="rainbow-delimiters-depth-5-face">(</span>plist-get selected <span class="builtin">:fname</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>widen<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char 0<span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-line <span class="rainbow-delimiters-depth-5-face">(</span>plist-get selected <span class="builtin">:line</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>reveal-post-command<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Insert image with width
</span>
<span class="comment-delimiter">;; </span><span class="comment">This function is especially useful when used in combination with =embark-act-all=. The workflow is as follows:
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-x= =im-org-insert-image-file-with-width=
</span><span class="comment-delimiter">;; </span><span class="comment">- Filter the files that you want to insert to your buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">- Hit enter if there is only one item.
</span><span class="comment-delimiter">;; </span><span class="comment">- If there are multiple items that you want to insert, do =M-a= (embark-act) and then =S= (=embark-collect-snapshot=).
</span><span class="comment-delimiter">;; </span><span class="comment">- Then you can do =embark-act-all= or just hit enter on the items that you want to insert to your buffer.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-insert-image-file-with-width</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Insert interactively selected image file with fixed width information.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fname <span class="rainbow-delimiters-depth-5-face">(</span>file-relative-name <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name <span class="string">&quot;Select file: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;#+ATTR_ORG: :width 400\n[[file:%s]]\n\n&quot;</span> fname<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Renaming files under cursor
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-rename-file-at-point</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Interactively rename the file under cursor and update the link.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>link <span class="rainbow-delimiters-depth-5-face">(</span>org-element-context<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>type <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:type</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>path <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:path</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>begin <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:begin</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>end <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:end</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>cbegin <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:contents-begin</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>cend <span class="rainbow-delimiters-depth-5-face">(</span>org-element-property <span class="builtin">:contents-end</span> link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
         content<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span>equal type <span class="string">&quot;file&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;Link is not a file&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> cbegin cend<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> content <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;[%s]&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>buffer-substring-no-properties cbegin cend<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>use-relative? <span class="rainbow-delimiters-depth-6-face">(</span>not <span class="rainbow-delimiters-depth-7-face">(</span>file-name-absolute-p path<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>fname <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name <span class="string">&quot;New name: &quot;</span>
                                 <span class="rainbow-delimiters-depth-7-face">(</span>expand-file-name
                                  <span class="rainbow-delimiters-depth-8-face">(</span>file-name-directory path<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
                                 nil nil
                                 <span class="rainbow-delimiters-depth-7-face">(</span>im-org-suggest-filename path<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> use-relative?
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">setq</span> fname <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="string">&quot;./&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>file-relative-name fname<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>rename-file path fname<span class="rainbow-delimiters-depth-5-face">)
        (</span>delete-region begin end<span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;[[file:%s]%s]&quot;</span>
                        fname
                        <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> content <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Project management
</span>
<span class="comment-delimiter">;; </span><span class="comment">I'm doing all of my project management in org-mode. Here you can
</span><span class="comment-delimiter">;; </span><span class="comment">find some supplementary functionality that makes project management
</span><span class="comment-delimiter">;; </span><span class="comment">within org-mode easy.
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Do a regexp search in a project inside a org dynamic block
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here I create a dynamic block for org-mode, named
</span><span class="comment-delimiter">;; </span><span class="comment">~project-grep~. You can create a block like the following:
</span>
<span class="comment-delimiter">;; </span><span class="comment">#+begin: project-grep :root &quot;~/Workspace/projects/dotfiles&quot; :regexp &quot;</span><span class="default-0035">TODO</span><span class="comment">&quot;
</span><span class="comment-delimiter">;; </span><span class="comment">#+end
</span>
<span class="comment-delimiter">;; </span><span class="comment">When you invoke =C-c C-c= on that block, it will automatically run
</span><span class="comment-delimiter">;; </span><span class="comment">given REGEXP in given ROOT and create a nicely formatted table
</span><span class="comment-delimiter">;; </span><span class="comment">containing all the results. Results are formatted into org-links
</span><span class="comment-delimiter">;; </span><span class="comment">you can easily jump into.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">org-dblock-write:project-grep</span> <span class="rainbow-delimiters-depth-2-face">(</span>params<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Do a regular expression search in given project.
PARAMS may contain `</span><span class="constant">:root</span><span class="doc">' or `</span><span class="constant">:regexp</span><span class="doc">'.

`</span><span class="constant">:root</span><span class="doc">' - Where to run the search. If it's skipped, it's
`</span><span class="constant">default-directory</span><span class="doc">'.

`</span><span class="constant">:regexp</span><span class="doc">' - Regexp to grep in given folder. If it's skipped it
searches for </span><span class="default-0038">TODO</span><span class="doc">/</span><span class="default-0038">FIXME</span><span class="doc"> items in given folder.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>root <span class="rainbow-delimiters-depth-5-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>plist-get params <span class="builtin">:root</span><span class="rainbow-delimiters-depth-7-face">)</span> default-directory<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>regexp <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get params <span class="builtin">:regexp</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;(//|#|--|;)+ ?(</span><span class="default-0037">TODO</span><span class="string">|</span><span class="default-0037">FIXME</span><span class="string">)&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>default-directory root<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s | &quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;&quot; &quot;ID&quot; &quot;File&quot; &quot;Content&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="string">&quot;|-|\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--each-indexed</span>
        <span class="rainbow-delimiters-depth-4-face">(</span>s-split
         <span class="string">&quot;\n&quot;</span>
         <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;rg --line-number '</span><span class="constant">%s</span><span class="string">'&quot;</span> regexp<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
         <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">omit-nulls</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>data <span class="rainbow-delimiters-depth-7-face">(</span>s-split-up-to <span class="string">&quot;:&quot;</span> it 2<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
             (</span>file <span class="rainbow-delimiters-depth-7-face">(</span>s-join <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>-take 2 data<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
             (</span>file-link <span class="rainbow-delimiters-depth-7-face">(</span>concat <span class="string">&quot;[[file:&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>f-join default-directory <span class="rainbow-delimiters-depth-9-face">(</span>s-replace <span class="string">&quot;:&quot; &quot;::&quot;</span> file<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;][&quot;</span> file <span class="string">&quot;]]&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
             (</span>content <span class="rainbow-delimiters-depth-7-face">(</span>s-replace <span class="string">&quot;|&quot; &quot; \\vert &quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>-last-item data<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="string">&quot;| &quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;%s&quot;</span> it-index<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="string">&quot; | &quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert file-link<span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="string">&quot; | &quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert content<span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="string">&quot; |\n&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>delete-char 1<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-table-align<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Archiving URLS
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-org-archive-url-path</span> <span class="string">&quot;~/Documents/notes/data/archvive/&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-archive-url</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Archive URL and generate an new org entry for it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>url update?<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">If we are on a heading and calling this function, we probably
</span>    <span class="comment-delimiter">;; </span><span class="comment">just want to update/initialize the archive for current
</span>    <span class="comment-delimiter">;; </span><span class="comment">heading. Otherwise we are creating a new archive.
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>_ <span class="rainbow-delimiters-depth-6-face">(</span>org-at-heading-p<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
             (</span>old-url <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>org-entry-get nil <span class="string">&quot;URL&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
                          <span class="comment-delimiter">;; </span><span class="comment">There might not be an URL property but
</span>                          <span class="comment-delimiter">;; </span><span class="comment">the header itself might be a link, try to
</span>                          <span class="comment-delimiter">;; </span><span class="comment">extract it
</span>                          <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span>plist-get <span class="rainbow-delimiters-depth-9-face">(</span>cadr <span class="rainbow-delimiters-depth-1-face">(</span>org-element-context<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="builtin">:raw-link</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">progn</span>
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">setq</span> url old-url<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">setq</span> update? t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">progn</span>
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">setq</span> url <span class="rainbow-delimiters-depth-6-face">(</span>read-string <span class="string">&quot;URL: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>org-insert-heading<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>

    <span class="comment-delimiter">;; </span><span class="comment">Precautionary call
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>org-id-get-create<span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>url-title <span class="rainbow-delimiters-depth-6-face">(</span>read-string <span class="string">&quot;Title: &quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>im-url-get-title url<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>archive-path <span class="rainbow-delimiters-depth-6-face">(</span>format
                          <span class="string">&quot;%s/%s_%s_%s.html&quot;</span>
                          im-org-archive-url-path
                          <span class="rainbow-delimiters-depth-7-face">(</span>org-id-get-create<span class="rainbow-delimiters-depth-7-face">)
                          (</span>format-time-string <span class="string">&quot;%Y%m%dT%H%M%S&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                          (</span>im-string-url-case url-title<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-set-property
       <span class="string">&quot;ARCHIVED_AT&quot;</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s[[file:./%s][%s]]&quot;</span>
               <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>older-archives <span class="rainbow-delimiters-depth-9-face">(</span>org-entry-get nil <span class="string">&quot;ARCHIVED_AT&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                   (</span>format <span class="string">&quot;%s, &quot;</span> older-archives<span class="rainbow-delimiters-depth-7-face">)</span>
                 <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)
               (</span>f-relative archive-path<span class="rainbow-delimiters-depth-6-face">)
               (</span>format-time-string <span class="string">&quot;%Y-%m-%dT%H:%M&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">unless</span> update?
        <span class="rainbow-delimiters-depth-5-face">(</span>insert <span class="rainbow-delimiters-depth-6-face">(</span>org-make-link-string url url-title<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)

      (</span>org-set-property <span class="string">&quot;URL&quot;</span> url<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-5-face">(</span>org-entry-get nil <span class="string">&quot;CREATED&quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>org-set-property <span class="string">&quot;CREATED&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>format-time-string <span class="string">&quot;[%Y-%m-%d %a %H:%M]&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>

      <span class="comment-delimiter">;; </span><span class="comment">Create the archive
</span>      <span class="rainbow-delimiters-depth-4-face">(</span>f-mkdir im-org-archive-url-path<span class="rainbow-delimiters-depth-4-face">)
      (</span>im-archive-url
       url
       <span class="builtin">:where</span> archive-path
       <span class="builtin">:tidy</span> t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-capture</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-capture-templates</span>
   <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;b&quot; &quot;Bookmark&quot;</span> entry
     <span class="rainbow-delimiters-depth-4-face">(</span>file+headline ,bookmarks-org <span class="string">&quot;Unsorted&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;** (call-interactively #'im-org-archive-url)\n- Don't forget to TAG!&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Convert items to </span><span class="default-0039">TODO</span><span class="outline-3-0033"> entries
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-convert-item-to-todo-and-refile</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> yank-only<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert org item to todo header and refile.
I take notes in the following format during the day via
org-capture template:

    - [2023-04-09 Sun 23:57] Some note

At the end of the day, I convert these notes into tasks if
applicable. This means rewriting them into a </span><span class="default-0038">TODO</span><span class="doc"> header with
CREATED_AT property and refiling into the appropriate
header. This function automatizes that.

If YANK-ONLY is non-nil (with prefix arg while calling
interactively), only yank the result, do not refile.

&gt;&gt; (with-temp-buffer
    (insert \&quot;- [2023-06-28 Wed 10:13] Test\\n\&quot;)
    (beginning-of-buffer)
    (im-org-convert-item-to-todo-and-refile t))
=&gt; \&quot;** </span><span class="default-0038">TODO</span><span class="doc"> [#B] Test
:PROPERTIES:
:CREATED_AT: [2023-06-28 Wed 10:13]
:END:
\&quot;

&gt;&gt; (with-temp-buffer
    (insert \&quot;- [2023-06-28 Wed 10:13] Test :: The body.\\n\&quot;)
    (beginning-of-buffer)
    (im-org-convert-item-to-todo-and-refile t))
=&gt; \&quot;** </span><span class="default-0038">TODO</span><span class="doc"> [#B] Test
:PROPERTIES:
:CREATED_AT: [2023-06-28 Wed 10:13]
:END:
The body.
\&quot;

&gt;&gt; (with-temp-buffer
    (insert \&quot;- [2023-06-28 Wed 10:13] Test and a link [[here]] :: The body.\\n\&quot;)
    (beginning-of-buffer)
    (im-org-convert-item-to-todo-and-refile t))
=&gt; \&quot;** </span><span class="default-0038">TODO</span><span class="doc"> [#B] Test and a link [[here]]
:PROPERTIES:
:CREATED_AT: [2023-06-28 Wed 10:13]
:END:
The body.
\&quot;

Version: 2023-07-31
- Fixed not being able to parse headers with links.
Version: 2023-06-28
- Initial version.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>beginning-of-line<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>line <span class="rainbow-delimiters-depth-6-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>timestamp nil<span class="rainbow-delimiters-depth-5-face">)
          (</span>text nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-5-face">(</span>match <span class="rainbow-delimiters-depth-6-face">(</span>s-match <span class="string">&quot;^- </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\[[ X-]] </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\[</span><span class="constant">.*?</span><span class="string">]</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> line<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> timestamp <span class="rainbow-delimiters-depth-6-face">(</span>nth 2 match<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> text <span class="rainbow-delimiters-depth-6-face">(</span>nth 3 match<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>buffer <span class="rainbow-delimiters-depth-8-face">(</span>current-buffer<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
               (</span>data <span class="rainbow-delimiters-depth-8-face">(</span>s-split <span class="string">&quot; :: &quot;</span> text<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
               (</span>header <span class="rainbow-delimiters-depth-8-face">(</span>nth 0 data<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
               (</span>body <span class="rainbow-delimiters-depth-8-face">(</span>nth 1 data<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
               result<span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">with-temp-buffer</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>insert
             <span class="rainbow-delimiters-depth-8-face">(</span>concat <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#B] &quot;</span> header <span class="string">&quot;\n&quot;
                     &quot;:PROPERTIES:&quot; &quot;\n&quot;
                     &quot;:CREATED_AT: &quot;</span> timestamp <span class="string">&quot;\n&quot;
                     &quot;:END:&quot; &quot;\n&quot;</span>
                     <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">if</span> body <span class="rainbow-delimiters-depth-1-face">(</span>concat body <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">setq</span> result <span class="rainbow-delimiters-depth-8-face">(</span>buffer-string<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
            <span class="comment-delimiter">;; </span><span class="comment">To be able to refile
</span>            <span class="rainbow-delimiters-depth-7-face">(</span>org-mode<span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">if</span> yank-only
                <span class="rainbow-delimiters-depth-8-face">(</span>im-kill result<span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>org-refile-targets nil<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                (</span>org-refile nil buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
              <span class="comment-delimiter">;; </span><span class="comment">Remove the line after everything to prevent loss of data
</span>              <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">with-current-buffer</span> buffer
                <span class="rainbow-delimiters-depth-9-face">(</span>delete-region <span class="rainbow-delimiters-depth-1-face">(</span>line-beginning-position<span class="rainbow-delimiters-depth-1-face">) (</span>1+ <span class="rainbow-delimiters-depth-2-face">(</span>line-end-position<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
              result<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Sort entries intelligently
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-sort-entries-best</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Best sorting mechanism for your backlog.
Entries are sorted by priority, with most effort entries being
on top in their priority range.  Also entries are sorted by their
</span><span class="default-0038">TODO</span><span class="doc"> state.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">progn</span>
    <span class="comment-delimiter">;; </span><span class="comment">Sort by creation time
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>org-sort-entries nil ?R nil nil <span class="string">&quot;CREATED_AT&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Sort by Effort, the one with least effort is at top
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>org-sort-entries nil ?R nil nil <span class="string">&quot;Effort&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Sort by priority
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>org-sort-entries nil ?p<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Sort by </span><span class="default-0035">TODO</span><span class="comment"> state
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>org-sort-entries nil ?o<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Move non-</span><span class="default-0035">TODO</span><span class="comment"> headers to top
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>org-sort-entries nil ?F <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">() (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>org-entry-is-done-p<span class="rainbow-delimiters-depth-7-face">) (</span>org-entry-is-todo-p<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> -1 <span class="rainbow-delimiters-depth-6-face">(</span>- 1000 <span class="rainbow-delimiters-depth-7-face">(</span>length <span class="rainbow-delimiters-depth-8-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Remembering to clock in
</span>
<span class="comment-delimiter">;; </span><span class="comment">I forget to clock in (and out) most of the time, so I want Emacs to
</span><span class="comment-delimiter">;; </span><span class="comment">remind clocking to me. This function regularly checks if I'm
</span><span class="comment-delimiter">;; </span><span class="comment">clocked in or not and tries to remind me to take the appropriate
</span><span class="comment-delimiter">;; </span><span class="comment">action.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-clock-in-a-task</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Display today's tasks and require user to select one to clock in.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>find-file-noselect <span class="string">&quot;~/Documents/notes/bullet.org&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>im-bullet-focus-today<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>task <span class="rainbow-delimiters-depth-7-face">(</span>cdr
                   <span class="rainbow-delimiters-depth-8-face">(</span>im-completing-read
                    <span class="string">&quot;Select task: &quot;</span>
                    <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">-&gt;&gt;</span>
                     <span class="rainbow-delimiters-depth-1-face">(</span>org-map-entries
                      <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">()
                        (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>props <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-properties<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                          (</span><span class="keyword">when-let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>todo <span class="rainbow-delimiters-depth-7-face">(</span>alist-get <span class="string">&quot;</span><span class="default-0037">TODO</span><span class="string">&quot;</span> props nil nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                                      (</span>_ <span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>equal <span class="string">&quot;DONE&quot;</span> todo<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                            (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>bounds <span class="rainbow-delimiters-depth-8-face">(</span>bounds-of-thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                              (</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>buffer-substring <span class="rainbow-delimiters-depth-8-face">(</span>car bounds<span class="rainbow-delimiters-depth-8-face">) (</span>cdr bounds<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">) (</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                     (</span>-filter <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">identity</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
                    <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> task
          <span class="rainbow-delimiters-depth-6-face">(</span>widen<span class="rainbow-delimiters-depth-6-face">)
          (</span>goto-char task<span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>elapsed-minutes <span class="rainbow-delimiters-depth-9-face">(</span>read-number <span class="string">&quot;How may minutes you've already spent?&quot;</span> 1<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>org-clock-in nil <span class="rainbow-delimiters-depth-8-face">(</span>time-subtract <span class="rainbow-delimiters-depth-9-face">(</span>current-time<span class="rainbow-delimiters-depth-9-face">) (</span>seconds-to-time <span class="rainbow-delimiters-depth-1-face">(</span>* elapsed-minutes 60<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span> <span class="string">&quot;ocb&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-bullet-clock-in-a-task</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-check-clock</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Check if are we currently clocked in or not.
If not, prompt user to clock in.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">cond</span>
   <span class="comment-delimiter">;; </span><span class="comment">If we are clocked in and we have been clocking longer than the
</span>   <span class="comment-delimiter">;; </span><span class="comment">effort or allocated time, ask if we want to clock out.
</span>   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>org-clocking-p<span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>find-file-noselect <span class="string">&quot;~/Documents/notes/bullet.org&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="keyword">save-window-excursion</span>
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-restriction</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>org-clock-goto<span class="rainbow-delimiters-depth-7-face">)
          (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>effort <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-2-face">(</span>e <span class="rainbow-delimiters-depth-3-face">(</span>org-entry-get nil <span class="string">&quot;EFFORT&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                           (</span>im-svgcal--time-diff <span class="string">&quot;0:00&quot;</span> e<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                 (</span>allocated-time
                  <span class="rainbow-delimiters-depth-1-face">(</span>-sum <span class="rainbow-delimiters-depth-2-face">(</span>-map <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>range start end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">) (</span>im-svgcal--time-diff start end<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-svgcal--org-entry-timestamps<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
            (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">and</span>
                   <span class="rainbow-delimiters-depth-1-face">(</span>&gt; <span class="rainbow-delimiters-depth-2-face">(</span>org-clock-get-clocked-time<span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>&gt; allocated-time 0<span class="rainbow-delimiters-depth-3-face">)</span> allocated-time effort<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                   (</span>y-or-n-p <span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;&gt;&gt; You are still clocked in to '</span><span class="constant">%s</span><span class="string">'! Want to clock out now?&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
              <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Maybe ask how many minutes have been elapsed since the
</span>              <span class="comment-delimiter">;; </span><span class="comment">task is done.
</span>              <span class="rainbow-delimiters-depth-9-face">(</span>org-clock-out<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t
    <span class="rainbow-delimiters-depth-4-face">(</span>alert <span class="string">&quot;You are not clocked in!&quot;</span> <span class="builtin">:title</span> <span class="string">&quot;CLOCKING&quot;</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>y-or-n-p <span class="string">&quot;Want to clock in?&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>im-bullet-clock-in-a-task<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">I disabled this for now because it does not work well.
</span><span class="comment-delimiter">;; </span><span class="comment">(run-with-timer 60 600 #'im-org-check-clock)
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-org-unfill-paragraph
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-unfill-paragraph</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> justify region<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Unfill the paragraph at point.
This function unfills the paragraph at point, removing line
breaks and joining the lines together. This function relies on
  `</span><span class="constant">org-fill-paragraph</span><span class="doc">' to perform the actual unfilling.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span>barf-if-buffer-read-only<span class="rainbow-delimiters-depth-4-face">)
       (</span>list <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> current-prefix-arg <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">full</span><span class="rainbow-delimiters-depth-5-face">)</span> t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fill-column 9999<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-fill-paragraph justify region<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-org-new-todo
</span>
<span class="comment-delimiter">;; </span><span class="comment">NOTE: With C-o in minibuffer, I can insert links to minibuffer.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-new-todo</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> priority<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create new org </span><span class="default-0038">TODO</span><span class="doc"> item with the fields I want them to be there.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>content <span class="rainbow-delimiters-depth-5-face">(</span>concat
                  <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;TODO%s %s &quot;</span>
                          <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-8-face">(</span>priority
                                   <span class="rainbow-delimiters-depth-9-face">(</span>im-non-blank-or-nil
                                    <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">or</span> priority
                                        <span class="rainbow-delimiters-depth-2-face">(</span>completing-read
                                         <span class="string">&quot;Select priority:&quot;</span>
                                         <span class="rainbow-delimiters-depth-3-face">(</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">char-to-string</span> <span class="rainbow-delimiters-depth-4-face">(</span>number-sequence
                                                                   org-priority-highest
                                                                   <span class="rainbow-delimiters-depth-5-face">(</span>1+ org-priority-lowest<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                              (</span>format <span class="string">&quot; [#%s]&quot;</span> priority<span class="rainbow-delimiters-depth-8-face">)</span>
                            <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                          (</span>s-trim <span class="rainbow-delimiters-depth-8-face">(</span>read-string <span class="string">&quot;Header: &quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>date <span class="rainbow-delimiters-depth-9-face">(</span>im-bullet-current-date<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span>format <span class="string">&quot;\nSCHEDULED: &lt;%s&gt;&quot;</span> date<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span>format
                   <span class="string">&quot;\n:PROPERTIES:\n:CREATED_AT: [%s]\n:END:&quot;</span>
                   <span class="rainbow-delimiters-depth-7-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%d %a %H:%M&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-insert-heading <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>4<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert content<span class="rainbow-delimiters-depth-3-face">)
    (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-set-tags-command</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-set-effort<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-new-heading</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Create a new heading with some automatically set properties.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>content <span class="rainbow-delimiters-depth-5-face">(</span>concat
                  <span class="rainbow-delimiters-depth-6-face">(</span>format
                   <span class="string">&quot;%s%s&quot;</span>
                   <span class="rainbow-delimiters-depth-7-face">(</span>s-trim <span class="rainbow-delimiters-depth-8-face">(</span>read-string <span class="string">&quot;Header: &quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                   (</span>format
                    <span class="string">&quot;\n:PROPERTIES:\n:CREATED_AT: [%s]\n:END:&quot;</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%d %a %H:%M&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-insert-heading <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>4<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert content<span class="rainbow-delimiters-depth-3-face">)
    (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-set-tags-command</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span>
  <span class="string">&quot;ok&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-new-todo</span>
  <span class="string">&quot;oK&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-org-new-heading</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-transclusion
</span>
<span class="comment-delimiter">;; </span><span class="comment">My main use case for
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://github.com/nobiot/org-transclusion][org-transclusion]] is
</span><span class="comment-delimiter">;; </span><span class="comment">that I sometimes create curated lists of other headings and instead
</span><span class="comment-delimiter">;; </span><span class="comment">of simply inserting standard links, I convert them into
</span><span class="comment-delimiter">;; </span><span class="comment">org-transclusion directives. This way I can directly view linked
</span><span class="comment-delimiter">;; </span><span class="comment">content on the spot. Especially useful for meeting notes.
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-transclusion</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span>
    <span class="string">&quot;of&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-transclusion-add</span>
    <span class="string">&quot;oF&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-transclusion-remove</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Capture changed headings on save
</span>
<span class="comment-delimiter">;; </span><span class="comment">Sometimes, I want to capture which headings are changed on save and
</span><span class="comment-delimiter">;; </span><span class="comment">do some actions on those headings. Following code accomplishes
</span><span class="comment-delimiter">;; </span><span class="comment">that, but only for top and second level headings. To do so add a
</span><span class="comment-delimiter">;; </span><span class="comment">function to ~im-org-header-changed-hook~.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-org-header-changed-hook-blacklist-files</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;bullet.org&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Do not run change hook on these files.
If file is too big (&gt; 1 MB?, or too much headers), this hook
makes saving quite slow.  I could simply put a file limit on the
hooks but that makes thing even more complicated.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-org-header-changed-hook</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Functions run after an entry is changed.

Functions are called with one argument which is the following plist:
    (:begin ... :end ... :level ... :properties ... :header... :body ...)

Functions are called separately for each changed entry/header.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar-local</span> <span class="variable-name">im--org-heading-prev-state</span> nil
  <span class="doc">&quot;Holds the previous state of the top-level headers.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-store-heading-state</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Store the state of the top-level headers for later comparison.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>file <span class="rainbow-delimiters-depth-6-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>file-exists-p file<span class="rainbow-delimiters-depth-6-face">)
                 (</span>not <span class="rainbow-delimiters-depth-7-face">(</span>-contains? im-org-header-changed-hook-blacklist-files <span class="rainbow-delimiters-depth-8-face">(</span>f-filename file<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> im--org-heading-prev-state
              <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">with-temp-buffer</span>
                <span class="rainbow-delimiters-depth-7-face">(</span>insert-file-contents file<span class="rainbow-delimiters-depth-7-face">)
                (</span><span class="keyword">delay-mode-hooks</span> <span class="rainbow-delimiters-depth-8-face">(</span>org-mode<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
                <span class="comment-delimiter">;; </span><span class="comment">Save only :body &amp; :header because one line
</span>                <span class="comment-delimiter">;; </span><span class="comment">added/removed will invalidate all headers by
</span>                <span class="comment-delimiter">;; </span><span class="comment">changing :begin and :end
</span>                <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-8-face">(</span>cons <span class="rainbow-delimiters-depth-9-face">(</span>plist-get it <span class="builtin">:header</span><span class="rainbow-delimiters-depth-9-face">) (</span>plist-get it <span class="builtin">:body</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">) (</span>im-org-get-some-headers<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-compare-heading-state</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Compare current top-level headers with the stored state to detect changes.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-4-face">(</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-4-face">)
             (</span>not <span class="rainbow-delimiters-depth-5-face">(</span>-contains? im-org-header-changed-hook-blacklist-files <span class="rainbow-delimiters-depth-6-face">(</span>f-filename <span class="rainbow-delimiters-depth-7-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>-each <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--remove</span>
            <span class="rainbow-delimiters-depth-5-face">(</span>member <span class="rainbow-delimiters-depth-6-face">(</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:header</span><span class="rainbow-delimiters-depth-7-face">) (</span>plist-get it <span class="builtin">:body</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> im--org-heading-prev-state<span class="rainbow-delimiters-depth-5-face">)
            (</span>im-org-get-some-headers<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>header-plist<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">--each</span> im-org-header-changed-hook
          <span class="rainbow-delimiters-depth-6-face">(</span>funcall it header-plist<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-get-some-headers</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Extract top-level headers and their content from the current Org buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>headers <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>widen<span class="rainbow-delimiters-depth-4-face">)
      (</span>org-map-entries
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()
         (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>header <span class="rainbow-delimiters-depth-9-face">(</span>org-get-heading t t t t<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                (</span>elem <span class="rainbow-delimiters-depth-9-face">(</span>org-element-at-point<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">push</span>
            <span class="rainbow-delimiters-depth-8-face">(</span>list
             <span class="builtin">:begin</span> <span class="rainbow-delimiters-depth-9-face">(</span>org-element-property <span class="builtin">:begin</span> elem<span class="rainbow-delimiters-depth-9-face">)</span>
             <span class="builtin">:end</span> <span class="rainbow-delimiters-depth-9-face">(</span>org-element-property <span class="builtin">:end</span> elem<span class="rainbow-delimiters-depth-9-face">)</span>
             <span class="builtin">:level</span> <span class="rainbow-delimiters-depth-9-face">(</span>org-element-property <span class="builtin">:level</span> elem<span class="rainbow-delimiters-depth-9-face">)</span>
             <span class="builtin">:properties</span> <span class="rainbow-delimiters-depth-9-face">(</span>org-entry-properties<span class="rainbow-delimiters-depth-9-face">)</span>
             <span class="builtin">:header</span> header
             <span class="builtin">:body</span>
             <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-1-face">(</span>start <span class="rainbow-delimiters-depth-2-face">(</span>org-element-property <span class="builtin">:contents-begin</span> elem<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
               (</span>buffer-substring-no-properties
                start
                <span class="rainbow-delimiters-depth-2-face">(</span>org-element-property <span class="builtin">:contents-end</span> elem<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
            headers<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="string">&quot;LEVEL&lt;3&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    headers<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">before-save-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-org-store-heading-state</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-save-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-org-compare-heading-state</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Get effort of linked header
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-get-link-effort-at-point</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return the effort of linked header.
Only works with id links.  Useful while planning.  When called
interactively, insert the effort at the end of the line.

I generally bind this to a key while using by
`</span><span class="constant">im-embark-bind-leader-command</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>effort<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>file . pos<span class="rainbow-delimiters-depth-6-face">) (</span>org-id-find <span class="rainbow-delimiters-depth-7-face">(</span>org-element-property <span class="builtin">:path</span> <span class="rainbow-delimiters-depth-8-face">(</span>org-element-lineage <span class="rainbow-delimiters-depth-9-face">(</span>org-element-context<span class="rainbow-delimiters-depth-9-face">)</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-9-face">(</span>link<span class="rainbow-delimiters-depth-9-face">)</span> t<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>find-file-noselect file<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">save-excursion</span>
          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-restriction</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>widen<span class="rainbow-delimiters-depth-7-face">)
            (</span>goto-char pos<span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">setq</span> effort <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-9-face">(</span>org-entry-get nil <span class="string">&quot;Effort&quot;</span><span class="rainbow-delimiters-depth-9-face">)
                             (</span><span class="keyword">progn</span>
                               <span class="rainbow-delimiters-depth-1-face">(</span>org-set-effort<span class="rainbow-delimiters-depth-1-face">)
                               (</span>org-entry-get nil <span class="string">&quot;Effort&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>end-of-line<span class="rainbow-delimiters-depth-4-face">)
      (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot; → %s&quot;</span> effort<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> corg.el --- Org Mode block header completion
</span>
<span class="comment-delimiter">;; </span><span class="comment">Completion at point for dynamic block headers, source block headers
</span><span class="comment-delimiter">;; </span><span class="comment">etc.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">corg</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/corg.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>org-mode . corg-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-svgcal
</span>
<span class="comment-delimiter">;; </span><span class="comment">Experimental SVG visual calendar for the current day.
</span>
<span class="comment-delimiter">;; </span><span class="comment">At the time of writing this, I wasn't aware of (or maybe it didn't
</span><span class="comment-delimiter">;; </span><span class="comment">even exist?) org-timeblock[1].  im-svgcal is quite similar to that
</span><span class="comment-delimiter">;; </span><span class="comment">but only works for given day and it's independent from the agenda,
</span><span class="comment-delimiter">;; </span><span class="comment">it simply draws a calendar for current org file (or current
</span><span class="comment-delimiter">;; </span><span class="comment">restricted section of the org file).
</span>
<span class="comment-delimiter">;; </span><span class="comment">[1]: https://github.com/ichernyshovvv/org-timeblock
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">im-svgcal</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-svgcal-enable im-svgcal-run<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:straight</span> nil<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Extra functionality
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-open-thing-at-point
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-open-thing-at-point-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;List of (THING-DETECTOR . THING-OPENER) pairs.
THING-DETECTOR should be a no-arg function that returns the
thing, if found.  Otherwise it should return nil.

THING-OPENER should be a function with 1 arg, which should take
the thing (which is the thing return by the THING-DETECTOR) and
open.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;eo&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-open-thing-at-point</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-open-thing-at-point</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Detect and open the thing at point.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">--any</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-4-face">(</span>result <span class="rainbow-delimiters-depth-5-face">(</span>funcall <span class="rainbow-delimiters-depth-6-face">(</span>car it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>funcall <span class="rainbow-delimiters-depth-5-face">(</span>cdr it<span class="rainbow-delimiters-depth-5-face">)</span> result<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   im-open-thing-at-point-alist<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-open-thing-at-point-alist</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span>,<span class="rainbow-delimiters-depth-3-face">(</span>apply-partially <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">thing-at-point</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-3-face">)</span> . browse-url<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-ensure-binary
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-ensure-binary</span> <span class="rainbow-delimiters-depth-2-face">(</span>command <span class="type">&amp;key</span> package installer<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Ensures that the binary COMMAND is installed.
If not, alerts the user and copies the installation instructions
to the kill ring.

COMMAND can be a string or a list.  If it's a string, it will be
split and the first element will be used as the binary name.  If
it's a list, the first element will be used as the binary name.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>binary <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cond</span>
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>stringp command<span class="rainbow-delimiters-depth-7-face">) (</span>car <span class="rainbow-delimiters-depth-8-face">(</span>split-string command <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="rainbow-delimiters-depth-7-face">(</span>listp command<span class="rainbow-delimiters-depth-7-face">) (</span>car command<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span>t <span class="rainbow-delimiters-depth-7-face">(</span><span class="warning">error</span> <span class="string">&quot;&gt;&gt; Invalid command: '</span><span class="constant">%s</span><span class="string">'&quot;</span> command<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span>executable-find binary<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>installer <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> installer
                              <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">im-when-on</span> <span class="builtin">:darwin</span> <span class="string">&quot;brew install&quot;</span> <span class="builtin">:linux</span> <span class="string">&quot;pacman -S&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
               (</span>package <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> package binary<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
               (</span>install-cmd <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;%s %s&quot;</span> installer package<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>kill-new install-cmd<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="warning">error</span> <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;Binary '</span><span class="constant">%s</span><span class="string">' not found. Do `</span><span class="constant">%s</span><span class="string">'&quot;</span> binary install-cmd<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      command<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Other packages
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> which-key
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">which-key</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> which-key-max-display-columns 4<span class="rainbow-delimiters-depth-2-face">)
  (</span>which-key-setup-minibuffer<span class="rainbow-delimiters-depth-2-face">)
  (</span>which-key-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> doc-view-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">doc-view</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-doc-view-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> world-clock
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Simply do ~M-x world-clock~.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> world-clock-list
      <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;Europe/Amsterdam&quot; &quot;Amsterdam&quot;</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;Europe/Istanbul&quot; &quot;Istanbul&quot;</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;Asia/Tokyo&quot; &quot;Tokyo&quot;</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;America/Los_Angeles&quot; &quot;Seattle&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> world-clock-time-format <span class="string">&quot;%a %d %b %R %Z&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> eldoc
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">eldoc</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">I have a `</span><span class="constant">im-peek-doc</span><span class="comment">' function that displays the documentation
</span>  <span class="comment-delimiter">;; </span><span class="comment">inline, which eleminates the need for multiline doc in minibuffer
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>eldoc-echo-area-use-multiline-p nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>eldoc-documentation-strategy <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eldoc-documentation-compose-eagerly</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> display-time-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">I started using Emacs in full screen (Emacs maximalism goes on), so
</span><span class="comment-delimiter">;; </span><span class="comment">this is helpful.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">display-time</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . display-time-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> display-time-format <span class="string">&quot;%b %d, %H:%M %a&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> display-time-default-load-average nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> outline-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">This is a built-in mode for providing basic outlining
</span><span class="comment-delimiter">;; </span><span class="comment">features. Here are a few configurations to make the navigation a
</span><span class="comment-delimiter">;; </span><span class="comment">bit more like what I use in org-mode:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">outline-mode</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outline-mode-map</span>
   <span class="string">&quot;[[&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-previous-heading</span>
   <span class="string">&quot;]]&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-next-heading</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:bind</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:repeat-map</span> outline-mode-repeat-map
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;[&quot;</span> . outline-previous-heading<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="string">&quot;]&quot;</span> . outline-next-heading<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> debugger-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">debugger-mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> hideshow -- hs-minor mode for code folding
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">hideshow</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">Comment folding results in weird behavior combined with
</span>  <span class="comment-delimiter">;; </span><span class="comment">outli-mode.  And comments are not that long generally, so this is
</span>  <span class="comment-delimiter">;; </span><span class="comment">good.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>hs-hide-comments-when-hiding-all nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> eat &amp; eshell
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">eshell</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>eshell-mode . im-disable-hl-line-mode-for-buffer<span class="rainbow-delimiters-depth-2-face">)
  (</span>eshell-mode . <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
                   (</span><span class="keyword">setq-local</span> corfu-auto nil<span class="rainbow-delimiters-depth-4-face">)
                   (</span>corfu-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>eshell-prompt-mode-map override<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;C-l&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>eshell/clear t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-eshell-setup<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">This is nil on purpose. Because `</span><span class="constant">im-eshell-append-history</span><span class="comment">' does
</span>  <span class="comment-delimiter">;; </span><span class="comment">duplication check before writing it to history and if this is
</span>  <span class="comment-delimiter">;; </span><span class="comment">non-nil then it fails to do the duplication check because
</span>  <span class="comment-delimiter">;; </span><span class="comment">duplicated items will not be inserted to history-ring at all.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> eshell-hist-ignoredups nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> eshell-history-size 10000<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">I manage history with `</span><span class="constant">im-eshell-append-history</span><span class="comment">''
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> eshell-save-history-on-exit nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">You can jump to a directory by doing a regex match with:
</span>  <span class="comment-delimiter">;;</span><span class="comment">
</span>  <span class="comment-delimiter">;;    </span><span class="comment">cd =some-regexp
</span>  <span class="comment-delimiter">;;</span><span class="comment">
</span>  <span class="comment-delimiter">;; </span><span class="comment">and you'll jump to the latest matching directory in in the last
</span>  <span class="comment-delimiter">;; </span><span class="comment">dir ring.
</span>  <span class="comment-delimiter">;;</span><span class="comment">
</span>  <span class="comment-delimiter">;; </span><span class="comment">Also use
</span>  <span class="comment-delimiter">;;</span><span class="comment">
</span>  <span class="comment-delimiter">;;     </span><span class="comment">cd -
</span>  <span class="comment-delimiter">;;</span><span class="comment">
</span>  <span class="comment-delimiter">;; </span><span class="comment">to jump to the latest directory before the current one.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> eshell-last-dir-ring-size 1000<span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-eshell-prompt</span> <span class="rainbow-delimiters-depth-3-face">()
    (</span>concat <span class="rainbow-delimiters-depth-4-face">(</span>abbreviate-file-name <span class="rainbow-delimiters-depth-5-face">(</span>eshell/pwd<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>= <span class="rainbow-delimiters-depth-6-face">(</span>user-uid<span class="rainbow-delimiters-depth-6-face">)</span> 0<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot; # &quot; &quot; \n$ &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> eshell-prompt-regexp <span class="string">&quot;^$ &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> eshell-prompt-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell-prompt</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">eshell-syntax-highlighting</span>
  <span class="builtin">:after</span> eshell
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>eshell-syntax-highlighting-global-mode +1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">You may need to call `</span><span class="constant">eat-compile-terminfo</span><span class="comment">' after installing eat.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">eat</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> git
             <span class="builtin">:host</span> codeberg
             <span class="builtin">:repo</span> <span class="string">&quot;akib/emacs-eat&quot;</span>
             <span class="builtin">:files</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;*.el&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;term&quot; &quot;term/*.el&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;*.texi&quot;
                     &quot;*.ti&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;terminfo/e&quot; &quot;terminfo/e/*&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                     (</span><span class="string">&quot;terminfo/65&quot; &quot;terminfo/65/*&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                     (</span><span class="string">&quot;integration&quot; &quot;integration/*&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                     (</span><span class="builtin">:exclude</span> <span class="string">&quot;.dir-locals.el&quot; &quot;*-tests.el&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>eat-make<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>eat-mode . im-disable-hl-line-mode-for-buffer<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> eat-enable-shell-prompt-annotation nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> eat-shell <span class="rainbow-delimiters-depth-3-face">(</span>executable-find <span class="string">&quot;fish&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> eat-tramp-shells <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;docker&quot;</span> . <span class="string">&quot;/bin/sh&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                           (</span><span class="string">&quot;ssh&quot;</span> . <span class="string">&quot;/usr/bin/zsh&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>eat-eshell-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Send a notification for long running commands
</span>
<span class="comment-delimiter">;; </span><span class="comment">See `</span><span class="constant">im-eshell-notify-duration</span><span class="comment">' to control what a long running
</span><span class="comment-delimiter">;; </span><span class="comment">command means.  This only sends if user is focused to another
</span><span class="comment-delimiter">;; </span><span class="comment">buffer or Emacs is out of focus.
</span>
<span class="comment-delimiter">;; </span><span class="comment">I already have this feature in zsh, provided by starship
</span><span class="comment-delimiter">;; </span><span class="comment">prompt. This is just an enhanced eshell implementation.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-eshell-notify-duration</span> 1
    <span class="doc">&quot;Minimum time in seconds that a command takes for a notification to fire.&quot;</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defvar-local</span> <span class="variable-name">im-eshell-notify--last-execution-time</span> nil<span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-eshell-notify--pre-command-hook</span> <span class="rainbow-delimiters-depth-3-face">()
    (</span><span class="keyword">setq</span> im-eshell-notify--last-execution-time <span class="rainbow-delimiters-depth-4-face">(</span>float-time<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-eshell-notify--post-command-hook</span> <span class="rainbow-delimiters-depth-3-face">()
    (</span><span class="keyword">when</span> im-eshell-notify--last-execution-time
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>execution-time <span class="rainbow-delimiters-depth-7-face">(</span>- <span class="rainbow-delimiters-depth-8-face">(</span>float-time<span class="rainbow-delimiters-depth-8-face">)</span> im-eshell-notify--last-execution-time<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>&gt; execution-time im-eshell-notify-duration<span class="rainbow-delimiters-depth-6-face">)</span>
          <span class="comment-delimiter">;; </span><span class="comment">Only send a notification if user focused to another buffer or
</span>          <span class="comment-delimiter">;; </span><span class="comment">Emacs is out of focus.
</span>          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span>not <span class="rainbow-delimiters-depth-9-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                 (</span>not <span class="rainbow-delimiters-depth-9-face">(</span>eq <span class="rainbow-delimiters-depth-1-face">(</span>current-buffer<span class="rainbow-delimiters-depth-1-face">) (</span>window-buffer <span class="rainbow-delimiters-depth-2-face">(</span>selected-window<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>alert
             <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;Execution took %s seconds.&quot;</span> execution-time<span class="rainbow-delimiters-depth-8-face">)</span>
             <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;Command finished: %s!&quot;</span> eshell-last-command-name<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-pre-command-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-eshell-notify--pre-command-hook</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-post-command-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-eshell-notify--post-command-hook</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Proper command completion
</span>
<span class="comment-delimiter">;; </span><span class="comment">This package provides command, subcommand and argument completion
</span><span class="comment-delimiter">;; </span><span class="comment">using fish shell. You need to have fish shell installed. There is
</span><span class="comment-delimiter">;; </span><span class="comment">also helm version that provides argument documentation but I
</span><span class="comment-delimiter">;; </span><span class="comment">haven't tried it yet and I need to make it work with corfu instead
</span><span class="comment-delimiter">;; </span><span class="comment">of helm.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- In `</span><span class="constant">eshell</span><span class="comment">', fish completion is only used when `</span><span class="constant">pcomplete</span><span class="comment">' fails.
</span><span class="comment-delimiter">;; </span><span class="comment">- Don't forget that pcomplete works with TAB, not M-TAB.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Also do `</span><span class="constant">fish_update_completions</span><span class="comment">' time to time in a fish shell to
</span><span class="comment-delimiter">;; </span><span class="comment">parse and generate completions for fish shell.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">fish-completion</span>
  <span class="builtin">:after</span> eshell
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>eshell-mode . fish-completion-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Reading bash/zsh aliases into Eshell
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-eshell-load-my-aliases</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Load fish/zsh/bash aliases/abbreviations into eshell.
'</span><span class="constant">$*</span><span class="doc">' is appended after each alias so that they can take
positional parameters in eshell.

Aliases needs to be defined in a particular way:

  alias alias-name='alias value'

- There should be no spaces around the equals sign.
- Single quote should be used instead of double quoutes.

For fish shel abbreviations, only the following form is accepted:

  abbr -a -- alias-name 'alias value'

There is also a special syntax for defining eshell-specific aliases
that is read verbatim (meaning that no '</span><span class="constant">$*</span><span class="doc">' is appended):

  #eshell test='</span><span class="constant">ls</span><span class="doc">'&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span>
   eshell-command-aliases-list
   <span class="rainbow-delimiters-depth-3-face">(</span>-filter
    <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">identity</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span>
     <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-when-let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>_ eshell? name _2 imp<span class="rainbow-delimiters-depth-7-face">)
                 (</span>s-match <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">alias</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">#eshell</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">abbr -a --</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[a-zA-Z0-9_-]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">=</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string"> </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">'</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">'</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string"> *#.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">*$&quot;</span> it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>list name <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-prefix? <span class="string">&quot;#eshell&quot;</span> eshell?<span class="rainbow-delimiters-depth-8-face">)</span>
                      imp
                    <span class="rainbow-delimiters-depth-8-face">(</span>concat imp <span class="string">&quot; $*&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
     (</span><span class="keyword">--mapcat</span>
      <span class="rainbow-delimiters-depth-6-face">(</span>s-split <span class="string">&quot;\n&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">with-temp-buffer</span> <span class="rainbow-delimiters-depth-8-face">(</span>insert-file-contents it<span class="rainbow-delimiters-depth-8-face">) (</span>buffer-string<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
      (</span>append
       <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">when-let*</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>path <span class="string">&quot;~/.config/fish/conf.d/aliases.fish&quot;</span><span class="rainbow-delimiters-depth-9-face">)
                   (</span>_ <span class="rainbow-delimiters-depth-1-face">(</span>file-exists-p path<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
         (</span>list path<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
       (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>file-exists-p <span class="string">&quot;~/.config/aliases/&quot;</span><span class="rainbow-delimiters-depth-8-face">)
         (</span>directory-files <span class="string">&quot;~/.config/aliases/&quot;</span> t directory-files-no-dot-files-regexp<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-alias-load-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell-load-my-aliases</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Eshell-specific aliases
</span>
<span class="comment-delimiter">;; </span><span class="comment">Look at [[Aliases]] section in my config to see all bash/zsh
</span><span class="comment-delimiter">;; </span><span class="comment">aliases. These are eshell specific:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>im-tangle-file
 <span class="builtin">:path</span> <span class="string">&quot;~/.config/aliases/eshell&quot;</span>
 <span class="builtin">:contents</span> <span class="string">&quot;#eshell clear='clear 1'&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Also here are some aliases/functions for eshell defined in elisp:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">eshell/mkcd</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)
  (</span>eshell/mkdir args<span class="rainbow-delimiters-depth-2-face">)
  (</span>eshell/cd args<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">eshell/project-root</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)
  (</span>eshell/cd <span class="rainbow-delimiters-depth-3-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Automatically print notes for given directory
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have the file ~im-autodir-file~ which contains notes for
</span><span class="comment-delimiter">;; </span><span class="comment">directories, like in the following format:
</span>
<span class="comment-delimiter">;; </span><span class="comment">* ~/a/directory
</span><span class="comment-delimiter">;; </span><span class="comment">Here are my notes for the directory...
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">* ~/another/directory: This one contains some source code
</span><span class="comment-delimiter">;; </span><span class="comment">Use the following to compile this:
</span><span class="comment-delimiter">;; </span><span class="comment">...
</span>
<span class="comment-delimiter">;; </span><span class="comment">When I enter any of the listed directories, eshell automatically
</span><span class="comment-delimiter">;; </span><span class="comment">prints out my notes.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-autodir-file</span> directory-notes-org<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-autodir-last-doc</span> nil<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eshell-handle-dir-change</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>dir <span class="rainbow-delimiters-depth-5-face">(</span>file-name-as-directory <span class="rainbow-delimiters-depth-6-face">(</span>expand-file-name default-directory<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> im-autodir-last-doc
          <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>find-file-noselect im-autodir-file<span class="rainbow-delimiters-depth-5-face">)
            (</span><span class="keyword">save-restriction</span>
              <span class="rainbow-delimiters-depth-6-face">(</span>widen<span class="rainbow-delimiters-depth-6-face">)
              (</span><span class="keyword">catch</span> <span class="highlight-quoted-quote">'</span><span class="constant">found</span>
                <span class="rainbow-delimiters-depth-7-face">(</span>org-map-entries
                 <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">()
                   (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">-&gt;&gt;</span>
                          <span class="rainbow-delimiters-depth-2-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                          (</span>s-split <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                          (</span>car<span class="rainbow-delimiters-depth-2-face">)
                          (</span>expand-file-name<span class="rainbow-delimiters-depth-2-face">)
                          (</span>file-name-as-directory<span class="rainbow-delimiters-depth-2-face">)
                          (</span>equal dir<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                     (</span><span class="keyword">throw</span> <span class="highlight-quoted-quote">'</span><span class="constant">found</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer-substring-no-properties
                                    <span class="rainbow-delimiters-depth-3-face">(</span>org-element-property <span class="builtin">:contents-begin</span> <span class="rainbow-delimiters-depth-4-face">(</span>org-element-at-point<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
                                    (</span>org-element-property <span class="builtin">:contents-end</span> <span class="rainbow-delimiters-depth-4-face">(</span>org-element-at-point<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                 <span class="string">&quot;LEVEL=1&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
                nil<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> im-autodir-last-doc
      <span class="rainbow-delimiters-depth-4-face">(</span>insert <span class="string">&quot;im-autodir-show-doc&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>eshell-send-input<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-autodir-show-doc</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">-&gt;&gt;</span>
   im-autodir-last-doc
   s-lines
   <span class="rainbow-delimiters-depth-3-face">(</span>-take 20<span class="rainbow-delimiters-depth-3-face">)
   (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-directory-change-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell-handle-dir-change</span><span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">eshell-directory-change-hook is not get triggered when eshell is opened, hence:
</span><span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell-handle-dir-change</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-jump-to-project-documentation</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Jump to *my* documentation for current project.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer <span class="rainbow-delimiters-depth-4-face">(</span>find-file-noselect directory-notes-org<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>projdir <span class="rainbow-delimiters-depth-5-face">(</span>abbreviate-file-name <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>buf <span class="rainbow-delimiters-depth-5-face">(</span>find-file-noselect directory-notes-org<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>pos <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">with-current-buffer</span> buf
                <span class="rainbow-delimiters-depth-6-face">(</span>widen<span class="rainbow-delimiters-depth-6-face">)
                (</span>org-find-exact-headline-in-buffer projdir<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> pos
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>y-or-n-p <span class="string">&quot;Note not found for this project. Want to create?&quot;</span><span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">with-current-buffer</span> buf
            <span class="rainbow-delimiters-depth-6-face">(</span>widen<span class="rainbow-delimiters-depth-6-face">)
            (</span>goto-char <span class="rainbow-delimiters-depth-7-face">(</span>point-max<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span>org-insert-heading nil nil t<span class="rainbow-delimiters-depth-6-face">)
            (</span>org-edit-headline projdir<span class="rainbow-delimiters-depth-6-face">)
            (</span>org-set-property <span class="string">&quot;CREATED_AT&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>concat <span class="string">&quot;[&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>im-today<span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;]&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span><span class="keyword">setq</span> pos <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="warning">user-error</span> <span class="string">&quot;Doc not found directory: %s&quot;</span> projdir<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer buf<span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char pos<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-fold-show-entry<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Consistent history
</span>
<span class="comment-delimiter">;; </span><span class="comment">Normally, if you have more than one eshell instance open and quit
</span><span class="comment-delimiter">;; </span><span class="comment">them consecutively, the last closed one will overwrite the
</span><span class="comment-delimiter">;; </span><span class="comment">~eshell-history-file~. The following /appends/ issued command to
</span><span class="comment-delimiter">;; </span><span class="comment">history after each command.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-eshell-history-blacklist</span> <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">ls</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">pwd</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">cd</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">clear</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">exit</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">rm</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">mkdir</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">mkcd</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">im-autodir</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">lls</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">ll</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Adapted from: https://emacs.stackexchange.com/questions/18564/merge-history-from-multiple-eshells
</span><span class="comment-delimiter">;; </span><span class="comment">Changes:
</span><span class="comment-delimiter">;; </span><span class="comment">- Duplication check
</span><span class="comment-delimiter">;; </span><span class="comment">- Blacklisted commands
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar-local</span> <span class="variable-name">im-eshell-append-history</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-eshell-append-history</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Call `</span><span class="constant">eshell-write-history</span><span class="doc">' with the `</span><span class="constant">append</span><span class="doc">' parameter set to `</span><span class="constant">t</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>not im-eshell-append-history<span class="rainbow-delimiters-depth-3-face">)</span>
      <span class="comment-delimiter">;; </span><span class="comment">Remove the eshell save hook on first run.
</span>      <span class="comment-delimiter">;; </span><span class="comment">Also don't append on first run to prevent duplication.
</span>      <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
        <span class="rainbow-delimiters-depth-4-face">(</span>remove-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-exit-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eshell--save-history</span> t<span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">setq</span> im-eshell-append-history t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> eshell-history-ring
               <span class="rainbow-delimiters-depth-5-face">(</span>ring-elements eshell-history-ring<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>last-elem <span class="rainbow-delimiters-depth-7-face">(</span>s-trim <span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>ring-elements eshell-history-ring<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span>prev-elem <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-9-face">(</span>s-trim <span class="rainbow-delimiters-depth-1-face">(</span>nth 1 <span class="rainbow-delimiters-depth-2-face">(</span>ring-elements eshell-history-ring<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>string= last-elem prev-elem<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                   (</span>not <span class="rainbow-delimiters-depth-8-face">(</span>s-matches? im-eshell-history-blacklist last-elem<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">with-temp-buffer</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>insert last-elem <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">eshell-with-private-file-modes</span>
             <span class="rainbow-delimiters-depth-8-face">(</span>write-region <span class="rainbow-delimiters-depth-9-face">(</span>point-min<span class="rainbow-delimiters-depth-9-face">) (</span>point-max<span class="rainbow-delimiters-depth-9-face">)
                           (</span>file-truename eshell-history-file-name<span class="rainbow-delimiters-depth-9-face">)</span>
                           <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">no-message</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-post-command-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell-append-history</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Reset Eshell
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-eshell-reset</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Reset current eshell.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil eshell-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>name <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>dir default-directory<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>kill-buffer-query-functions <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">()</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>kill-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>default-directory dir<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-eshell name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> bookmark.el
</span>
<span class="comment-delimiter">;; </span><span class="comment">You can use ~list-bookmarks~ command to view/edit/delete them but
</span><span class="comment-delimiter">;; </span><span class="comment">using ~consult-bookmark~ and calling ~embark-act~ on them to
</span><span class="comment-delimiter">;; </span><span class="comment">view/delete/edit given bookmark might be easier.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> bookmark-save-flag 1<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ Save bookmarks automatically
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;bs&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bookmark-set</span>
  <span class="string">&quot;bm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-bookmark</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> process-menu-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">process-menu-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">revert-buffer</span>
  <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">process-menu-delete-process</span>
  <span class="string">&quot;x&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">process-menu-delete-process</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> timer-list-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">timer-list-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">revert-buffer</span>
  <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">timer-list-cancel</span>
  <span class="string">&quot;x&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">timer-list-cancel</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tabulated-list-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">- It's a built-in mode that shows some kind of tabulated data.
</span><span class="comment-delimiter">;; </span><span class="comment">- It is used by many major modes, like [[docker]], [[prodigy]], etc. I just add these common keybindings to have a consistent way of navigating in them.
</span><span class="comment-delimiter">;; </span><span class="comment">- I also try to bind following keys in their respective mode maps:
</span><span class="comment-delimiter">;; </span><span class="comment">- =a= key to a function that lists all the actions that can be taken on current column.
</span><span class="comment-delimiter">;; </span><span class="comment">- =Enter= to the default action (generally opening something etc.)
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">tabulated-list</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> tabulated-list-mode-map
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;{&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabulated-list-narrow-current-column</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;}&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabulated-list-widen-current-column</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;H&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabulated-list-previous-column</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;L&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabulated-list-next-column</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabulated-list-sort</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;r&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabulated-list-revert</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> vtable-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here are mostly used keys in vtable-map:
</span><span class="comment-delimiter">;; </span><span class="comment">- S :: Sort by column.
</span><span class="comment-delimiter">;; </span><span class="comment">- r :: Refresh the table
</span><span class="comment-delimiter">;; </span><span class="comment">- {,} :: narrow/widen column
</span>
<span class="comment-delimiter">;; </span><span class="comment">Unbind g first
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vtable-map</span> <span class="string">&quot;g&quot;</span> nil<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Add evil bindings for vtable mode
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">general-def</span>
  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vtable-map</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vtable-revert-command</span>
  <span class="string">&quot;H&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vtable-previous-column</span>
  <span class="string">&quot;L&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vtable-next-column</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Helper functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-vtable--pretty-colors</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return a (color color) list that can be used with :column-colors and :row-colors.
Makes the tables more readable.&quot;</span>
  <span class="comment-delimiter">;; </span><span class="comment">Mini-frame dependency is not cool bot ok. Rest of the config is still look like hell.
</span>  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span>,<span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">background-color</span> <span class="rainbow-delimiters-depth-4-face">(</span>frame-parameters<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> ,<span class="rainbow-delimiters-depth-3-face">(</span>mini-frame-get-background-color<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> alert &amp; im-notify-posframe
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Alert package
</span>
<span class="comment-delimiter">;; </span><span class="comment">Several packages are using this package to show system-level
</span><span class="comment-delimiter">;; </span><span class="comment">notifications. Here I set some defaults/fallback values.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">alert</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;yy&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-notifications</span>
    <span class="string">&quot;yu&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-enable-dnd</span>
    <span class="string">&quot;yU&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-disable-dnd</span>
    <span class="string">&quot;yb&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-blacklist</span>
    <span class="string">&quot;ys&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-snooze-last</span>
    <span class="string">&quot;yc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-clear-all</span>
    <span class="string">&quot;yC&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span>  <span class="rainbow-delimiters-depth-4-face">(</span>im-notify-posframe-clear-all t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>alert-define-style
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-alert-posframe</span>
   <span class="builtin">:title</span> <span class="string">&quot;Posframe alerts&quot;</span>
   <span class="builtin">:notifier</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>info<span class="rainbow-delimiters-depth-4-face">)
     (</span>im-notify-posframe
      <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get info <span class="builtin">:title</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="builtin">:message</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get info <span class="builtin">:message</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="builtin">:margin</span> t
      <span class="builtin">:duration</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get info <span class="builtin">:persistent</span><span class="rainbow-delimiters-depth-6-face">)</span> alert-fade-time<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="builtin">:severity</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get info <span class="builtin">:severity</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> alert-fade-time 15<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> alert-default-style <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-alert-posframe</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Re-define osx-notifier to handle strings better.
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">defun</span> <span class="function-name">alert-osx-notifier-notify</span> <span class="rainbow-delimiters-depth-4-face">(</span>info<span class="rainbow-delimiters-depth-4-face">)
      (</span>do-applescript <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;display notification %S with title %S&quot;</span>
                              <span class="rainbow-delimiters-depth-6-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>plist-get info <span class="builtin">:message</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                              (</span>substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>plist-get info <span class="builtin">:title</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>alert-message-notify info<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">org-clock sends notification if the current tasks estimated effort is met.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span>
   org-show-notification-handler
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>notification<span class="rainbow-delimiters-depth-4-face">)
     (</span>im-notify-posframe <span class="builtin">:title</span> <span class="string">&quot;*org-mode*&quot;</span> <span class="builtin">:message</span> notification <span class="builtin">:margin</span> t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> im-notify-posframe
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-notify-posframe-blacklist-regexp</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-notify-posframe-dnd</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-notify-posframe--active</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar-local</span> <span class="variable-name">im-notify-posframe--notification-data</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">async-cl-defun</span> im-notify-posframe <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> data <span class="type">&amp;key</span> id title message duration margin <span class="rainbow-delimiters-depth-3-face">(</span>severity <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> title <span class="rainbow-delimiters-depth-3-face">(</span>propertize title <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:weight</span> bold<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>bname <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;*notif-%s*&quot;</span>
                       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> id <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;%s-%s&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> title <span class="rainbow-delimiters-depth-9-face">(</span>im-string-url-case title<span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>random<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span>not im-notify-posframe-dnd<span class="rainbow-delimiters-depth-5-face">)
               (</span>not <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> im-notify-posframe-blacklist-regexp
                         <span class="rainbow-delimiters-depth-7-face">(</span>s-matches?
                          <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>stringp im-notify-posframe-blacklist-regexp<span class="rainbow-delimiters-depth-9-face">)</span>
                              im-notify-posframe-blacklist-regexp
                            <span class="rainbow-delimiters-depth-9-face">(</span>eval im-notify-posframe-blacklist-regexp<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                          (</span>concat <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> title <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;\n&quot;</span> message<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)

      (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>message <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>await <span class="rainbow-delimiters-depth-9-face">(</span>im-screen-sharing-now?<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                         <span class="string">&quot;[REDACTED due to screensharing]&quot;</span>
                       message<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>posframe-show
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-7-face">(</span>get-buffer-create bname<span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">setq</span> im-notify-posframe--notification-data
                 <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">thread-first</span>
                   data
                   <span class="rainbow-delimiters-depth-9-face">(</span>map-insert <span class="builtin">:time</span> <span class="rainbow-delimiters-depth-1-face">(</span>float-time<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                   (</span>map-insert <span class="builtin">:id</span> <span class="rainbow-delimiters-depth-1-face">(</span>substring-no-properties bname<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>current-buffer<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="builtin">:string</span>
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> margin
             <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;\n  %s  \n  %s  \n\n&quot;</span> title <span class="rainbow-delimiters-depth-8-face">(</span>s-trim <span class="rainbow-delimiters-depth-9-face">(</span>s-join <span class="string">&quot;  \n&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-2-face">(</span>concat <span class="string">&quot;  &quot;</span> it<span class="rainbow-delimiters-depth-2-face">) (</span>s-lines message<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>format <span class="string">&quot;%s\n%s&quot;</span> title message<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="builtin">:poshandler</span>
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>info<span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>posy <span class="rainbow-delimiters-depth-1-face">(</span>* <span class="rainbow-delimiters-depth-2-face">(</span>line-pixel-height<span class="rainbow-delimiters-depth-2-face">)
                          (</span><span class="keyword">--reduce-from</span> <span class="rainbow-delimiters-depth-3-face">(</span>+ acc
                                            <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">with-current-buffer</span> it
                                              <span class="rainbow-delimiters-depth-5-face">(</span>count-lines <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">) (</span>point-max<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
                                         0
                                         <span class="rainbow-delimiters-depth-3-face">(</span>remove bname im-notify-posframe--active<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span>cons <span class="rainbow-delimiters-depth-9-face">(</span>- <span class="rainbow-delimiters-depth-1-face">(</span>plist-get info <span class="builtin">:parent-frame-width</span><span class="rainbow-delimiters-depth-1-face">)
                      (</span>plist-get info <span class="builtin">:posframe-width</span><span class="rainbow-delimiters-depth-1-face">)</span>
                      20<span class="rainbow-delimiters-depth-9-face">)
                   (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-1-face">(</span>&gt; posy 0<span class="rainbow-delimiters-depth-1-face">)
                       (</span>+ posy <span class="rainbow-delimiters-depth-2-face">(</span>+ 3 3 15<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
                     30<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="builtin">:border-width</span> 3
         <span class="builtin">:max-height</span> 10
         <span class="builtin">:min-width</span> 30
         <span class="builtin">:max-width</span> 80
         <span class="builtin">:border-color</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">pcase</span> severity
                         <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">or</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">high</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">urgent</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;red3&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                         (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="string">&quot;yellow3&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                         (</span>_ nil<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">push</span> bname im-notify-posframe--active<span class="rainbow-delimiters-depth-5-face">)</span>

        <span class="comment-delimiter">;; </span><span class="comment">Clear the notification after a certain time, if requested
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> duration
          <span class="rainbow-delimiters-depth-6-face">(</span>run-with-timer
           duration nil
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">()
             (</span>posframe-hide bname<span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">push</span> bname im-notify-posframe--active<span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">setq</span> im-notify-posframe--active <span class="rainbow-delimiters-depth-9-face">(</span>delete bname im-notify-posframe--active<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>

        <span class="comment-delimiter">;; </span><span class="comment">Also use native notifications if Emacs is not focused
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-6-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>alert-default-style
                 <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">im-when-on</span>
                  <span class="builtin">:linux</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">libnotify</span>
                  <span class="builtin">:darwin</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">osx-notifier</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">ignore-errors</span>
              <span class="rainbow-delimiters-depth-8-face">(</span>alert message <span class="builtin">:title</span> title <span class="builtin">:severity</span> severity<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>

      <span class="comment-delimiter">;; </span><span class="comment">Send it to my phone but only if Emacs is idle for a certain
</span>      <span class="comment-delimiter">;; </span><span class="comment">time
</span>      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-7-face">(</span>current-idle-time<span class="rainbow-delimiters-depth-7-face">)
                     (</span>&gt;= <span class="rainbow-delimiters-depth-8-face">(</span>time-to-seconds <span class="rainbow-delimiters-depth-9-face">(</span>current-idle-time<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> 30<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                <span class="comment-delimiter">;; </span><span class="comment">If we are sharing a screen, that means the
</span>                <span class="comment-delimiter">;; </span><span class="comment">notification will only show REDACTED. Then send it
</span>                <span class="comment-delimiter">;; </span><span class="comment">to my phone so that I can see it privately through
</span>                <span class="comment-delimiter">;; </span><span class="comment">my watch.
</span>                <span class="rainbow-delimiters-depth-6-face">(</span>await <span class="rainbow-delimiters-depth-7-face">(</span>im-screen-sharing-now?<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>im-ntfy
         message
         <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> title <span class="string">&quot;Emacs&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-clear-all</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> delete?<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">--each</span>
      <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-prefix? <span class="string">&quot;*notif&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">) (</span>buffer-list<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> delete?
        <span class="rainbow-delimiters-depth-4-face">(</span>posframe-delete it<span class="rainbow-delimiters-depth-4-face">)
      (</span>posframe-hide it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-notify-posframe--active <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">()</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-dummy-notification</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-notify-posframe <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;%s&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>random<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="builtin">:message</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-temp-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>spook<span class="rainbow-delimiters-depth-4-face">) (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="builtin">:margin</span> t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-notifications</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>notification <span class="rainbow-delimiters-depth-5-face">(</span>im-notify-posframe--select<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">empv--select-action</span> <span class="string">&quot;Act on notification&quot;
      &quot;Open&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>switch-to-buffer-other-window <span class="rainbow-delimiters-depth-5-face">(</span>plist-get notification <span class="builtin">:buffer-name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Delete&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-5-face">(</span>posframe-delete <span class="rainbow-delimiters-depth-6-face">(</span>plist-get notification <span class="builtin">:buffer-name</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">) (</span>message <span class="string">&quot;&gt;&gt; Deleted.&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Snooze&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-notify-posframe-snooze notification <span class="rainbow-delimiters-depth-5-face">(</span>im-read-duration<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-enable-dnd</span> <span class="rainbow-delimiters-depth-2-face">(</span>seconds<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Enable DND mode for SECONDS.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>im-read-duration<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-notify-posframe-dnd t<span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; Disabling notifications for %s seconds.&quot;</span> seconds<span class="rainbow-delimiters-depth-2-face">)
  (</span>run-with-timer seconds nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe-disable-dnd</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-disable-dnd</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Disable DND mode.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-notify-posframe-dnd nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-blacklist</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>pp-use-max-width t<span class="rainbow-delimiters-depth-4-face">)
         (</span>result <span class="rainbow-delimiters-depth-5-face">(</span>read-string
                  <span class="string">&quot;Blacklist expr: &quot;</span>
                  <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>stringp im-notify-posframe-blacklist-regexp<span class="rainbow-delimiters-depth-7-face">)</span>
                      im-notify-posframe-blacklist-regexp
                    <span class="rainbow-delimiters-depth-7-face">(</span>s-trim <span class="rainbow-delimiters-depth-8-face">(</span>pp-to-string im-notify-posframe-blacklist-regexp<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> im-notify-posframe-blacklist-regexp
          <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-blank? result<span class="rainbow-delimiters-depth-5-face">)</span>
              nil
            <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-prefix? <span class="string">&quot;(rx&quot;</span> result<span class="rainbow-delimiters-depth-6-face">)
                (</span>car <span class="rainbow-delimiters-depth-7-face">(</span>read-from-string result<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
              result<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> Add ack, like tmr? Maybe add ack option to im-notify-posframe
</span><span class="comment-delimiter">;; </span><span class="comment">itself and call with ack within this function
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-snooze</span> <span class="rainbow-delimiters-depth-2-face">(</span>notification seconds<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list
                <span class="rainbow-delimiters-depth-4-face">(</span>im-notify-posframe--select<span class="rainbow-delimiters-depth-4-face">)
                (</span>im-read-duration<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>run-with-timer
   seconds nil
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe</span> notification<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; You will be reminded about '</span><span class="constant">%s</span><span class="string">' in %s seconds.&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>plist-get notification <span class="builtin">:title</span><span class="rainbow-delimiters-depth-3-face">)</span> seconds<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-snooze-last</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-notify-posframe-snooze <span class="rainbow-delimiters-depth-3-face">(</span>car <span class="rainbow-delimiters-depth-4-face">(</span>im-notify-posframe-notifications-list<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-read-duration<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe-notifications-list</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return notification datas in sorted order.
First one is the latest one.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">thread-last</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>buffer-list<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-4-face">(</span>string-prefix-p <span class="string">&quot;*notif&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">with-current-buffer</span> it <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-6-face">(</span>x im-notify-posframe--notification-data<span class="rainbow-delimiters-depth-6-face">) (</span>map-insert x <span class="builtin">:buffer-name</span> <span class="rainbow-delimiters-depth-7-face">(</span>buffer-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--filter</span> it<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--sort</span> <span class="rainbow-delimiters-depth-4-face">(</span>&gt; <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:time</span><span class="rainbow-delimiters-depth-5-face">) (</span>plist-get other <span class="builtin">:time</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe--format-notification</span> <span class="rainbow-delimiters-depth-2-face">(</span>it<span class="rainbow-delimiters-depth-2-face">)
  (</span>format <span class="string">&quot;%s | %s - %s&quot;</span>
          <span class="rainbow-delimiters-depth-3-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%d %H:%M&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>plist-get it <span class="builtin">:time</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
          (</span>plist-get it <span class="builtin">:title</span><span class="rainbow-delimiters-depth-3-face">)
          (</span>plist-get it <span class="builtin">:message</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notify-posframe--select</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>im-completing-read
   <span class="string">&quot;Select notification: &quot;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-notify-posframe-notifications-list<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notify-posframe--format-notification</span>
   <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-notification</span>
   <span class="builtin">:sort?</span> nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-read-duration</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Ask the user to type a duration in a human-readable way.
Return parsed seconds from users answer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>tmr--parse-duration <span class="rainbow-delimiters-depth-3-face">(</span>current-time<span class="rainbow-delimiters-depth-3-face">) (</span>tmr--read-duration<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> im-ntfy -- ntfy wrapper
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-ntfy</span>
    <span class="rainbow-delimiters-depth-2-face">(</span>message
     <span class="type">&amp;rest</span> options
     <span class="type">&amp;key</span>
     title
     priority
     <span class="rainbow-delimiters-depth-3-face">(</span>icon <span class="rainbow-delimiters-depth-4-face">(</span>concat im-server <span class="string">&quot;/assets/emacs.png&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>channel <span class="string">&quot;emacs&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
     file
     <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send a notification to my phone.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>im-read-string <span class="string">&quot;Message: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-read-string <span class="string">&quot;Title: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:file</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>y-or-n-p <span class="string">&quot;Attach local file? &quot;</span><span class="rainbow-delimiters-depth-5-face">)
            (</span>expand-file-name <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name <span class="string">&quot;Attachment: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:channel</span> <span class="rainbow-delimiters-depth-4-face">(</span>completing-read <span class="string">&quot;Channel: &quot;</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;phone&quot; &quot;emacs&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>set-process-sentinel
   <span class="rainbow-delimiters-depth-3-face">(</span>apply
    <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">start-process</span>
    <span class="string">&quot;ntfy&quot; &quot;*ntfy-out*&quot;</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;ntfy&quot;
      &quot;publish&quot;</span>
      ,@<span class="rainbow-delimiters-depth-5-face">(</span>map-apply
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>opt val<span class="rainbow-delimiters-depth-7-face">) (</span>format <span class="string">&quot;--%s=%s&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-chop-prefix <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>symbol-name opt<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> val<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>map-into <span class="comment-delimiter">;; </span><span class="comment">← To remove the duplicates
</span>          <span class="rainbow-delimiters-depth-7-face">(</span>map-filter <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>opt val<span class="rainbow-delimiters-depth-9-face">) (</span><span class="keyword">and</span> val <span class="rainbow-delimiters-depth-1-face">(</span>not <span class="rainbow-delimiters-depth-2-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:channel</span><span class="rainbow-delimiters-depth-3-face">)</span> opt<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="builtin">:icon</span> ,icon ,@options<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
          <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">hash-table</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      ,channel
      ,message<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>proc text<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-5-face">(</span>eq <span class="rainbow-delimiters-depth-6-face">(</span>process-exit-status proc<span class="rainbow-delimiters-depth-6-face">)</span> 0<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="warning">error</span> <span class="string">&quot;&gt;&gt; [%s] Failed to send message through `</span><span class="constant">ntfy</span><span class="string">'.&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%dT%H:%M:%S%z&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Hydra
</span>
<span class="comment-delimiter">;; </span><span class="comment">Hydra creates a menu for quickly calling/toggling functions/modes
</span><span class="comment-delimiter">;; </span><span class="comment">in a visually easy way. My main use case for it right now is
</span><span class="comment-delimiter">;; </span><span class="comment">grouping bunch of appearance related functions/modes that I use
</span><span class="comment-delimiter">;; </span><span class="comment">infrequently. I believe for hydra's are not very useful for
</span><span class="comment-delimiter">;; </span><span class="comment">commands that you use frequently, it makes things slower than a
</span><span class="comment-delimiter">;; </span><span class="comment">plain keybinding but it's quite useful for the stuff that you
</span><span class="comment-delimiter">;; </span><span class="comment">forget or use infrequently.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">hydra</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">pretty-hydra</span>
  <span class="builtin">:after</span> hydra
  <span class="builtin">:defer</span> t
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;a&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-appearance/body</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">pretty-hydra-define</span> im-appearance
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:foreign-keys</span> warn <span class="builtin">:title</span> <span class="string">&quot;Appearance&quot;</span> <span class="builtin">:quit-key</span> <span class="string">&quot;q&quot;</span> <span class="builtin">:color</span> amaranth<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;Writeroom&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;W&quot;</span> writeroom-mode <span class="string">&quot;Writeroom mode&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;&gt;&quot;</span> writeroom-increase-width <span class="string">&quot;Width +&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;&lt;&quot;</span> writeroom-decrease-width <span class="string">&quot;Width -&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;m&quot;</span> writeroom-toggle-mode-line <span class="string">&quot;Toggle modeline&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;p&quot;</span> spacious-padding-mode <span class="string">&quot;Spacious padding&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;Zoom&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;0&quot;</span> text-scale-increase <span class="string">&quot;Zoom In (Buffer)&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;9&quot;</span> text-scale-decrease <span class="string">&quot;Zoom Out (Buffer)&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;+&quot;</span> default-text-scale-increase <span class="string">&quot;Zoom In (All)&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;-&quot;</span> default-text-scale-decrease <span class="string">&quot;Zoom Out (All)&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;=&quot;</span> default-text-scale-reset <span class="string">&quot;Zoom Reset (All)&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;Tabs&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;tl&quot;</span> tab-line-mode <span class="string">&quot;Tab Line mode (buffer)&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;tL&quot;</span> global-tab-line-mode <span class="string">&quot;Tab Line mode (global)&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;tb&quot;</span> tab-bar-mode <span class="string">&quot;Tab Bar mode (global)&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;Highlighting&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;hg&quot;</span> diff-hl <span class="string">&quot;Highlight git diff&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;hd&quot;</span> rainbow-delimiters-mode <span class="string">&quot;Rainbow parens&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;hl&quot;</span> global-hl-line-mode <span class="string">&quot;Highlight current line&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;hb&quot;</span> beacon-mode <span class="string">&quot;Cursor trailer (baecon)&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;hw&quot;</span> im-whitespace-mode-toggle <span class="string">&quot;Whitespaces&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;ht&quot;</span> highlight-thing-mode <span class="string">&quot;Highlight current symbol&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;Miscellaneous&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;n&quot;</span> display-line-numbers-mode <span class="string">&quot;Line numbers&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;l&quot;</span> visual-line-mode <span class="string">&quot;Wrap lines&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;T&quot;</span> toggle-truncate-lines <span class="string">&quot;Truncate lines&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;v&quot;</span> visual-fill-column-mode <span class="string">&quot;Wrap lines at 72th col&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;i&quot;</span> highlight-indent-guides-mode <span class="string">&quot;Indent Guides&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;f&quot;</span> fci-mode <span class="string">&quot;Fill column&quot;</span> <span class="builtin">:toggle</span> t<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;&lt;SPC&gt;&quot;</span> nil <span class="string">&quot;Quit&quot;</span> <span class="builtin">:color</span> blue<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> wgrep
</span>
<span class="comment-delimiter">;; </span><span class="comment">With this package, you can make =grep= buffers editable and your
</span><span class="comment-delimiter">;; </span><span class="comment">edits can be applied to the files itself. Also =embark= has a
</span><span class="comment-delimiter">;; </span><span class="comment">feature where you can export the current completing-read results
</span><span class="comment-delimiter">;; </span><span class="comment">into a grep buffer, the action is called =embark-export= and it
</span><span class="comment-delimiter">;; </span><span class="comment">works on =consult-ripgrep= etc.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Do ~C-c C-p~ (or =i=, enabled by evil-collection) on a =grep= buffer to make it editable.
</span><span class="comment-delimiter">;; </span><span class="comment">- Do ~C-j~ or ~C-k~ (enabled by evil-collection, by default you need to use =n=) to peek at next/prev instance.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">wgrep</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> dired/dirvish
</span>
<span class="comment-delimiter">;; </span><span class="comment">There is also ~wdired-mode~ which you can use to do bulk rename intuitively.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">dired</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>dired-dwim-target t<span class="rainbow-delimiters-depth-2-face">)
  (</span>dired-listing-switches <span class="string">&quot;-l -A -h -v --group-directories-first&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>ls-lisp-dirs-first t<span class="rainbow-delimiters-depth-2-face">)
  (</span>ls-lisp-use-insert-directory-program nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>dired-kill-when-opening-new-dired-buffer t<span class="rainbow-delimiters-depth-2-face">)
  (</span>dired-clean-confirm-killing-deleted-buffers nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>dired-recursive-copies <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">always</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>dired-recursive-deletes <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">always</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>dired-dwim-target t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-dired-setup<span class="rainbow-delimiters-depth-2-face">)
  (</span>put <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-find-alternate-file</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">disabled</span> nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">dirvish</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;hlissner/dirvish&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:after</span> dired
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;ed&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-dwim</span>
    <span class="string">&quot;fh&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-side</span>
    <span class="string">&quot;eD&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-dirvish</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Add a way to open dirvish in selected directory using Embark
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">embark-file-map</span> <span class="string">&quot;J&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-dirvish</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dirvish-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;\\&quot;</span>    <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-dired-find-file-ace-window</span>
   <span class="string">&quot;h&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dired-up-directory</span>
   <span class="string">&quot;l&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dired-find-alternate-file</span>
   <span class="string">&quot;T&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-layout-toggle</span>
   <span class="string">&quot;e&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-dispatch</span>
   <span class="string">&quot;q&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-quit</span>
   <span class="string">&quot;&lt;tab&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-toggle-subtree</span>
   <span class="string">&quot;f&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-file-info-menu</span>
   <span class="string">&quot;s&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-setup-menu</span>
   <span class="string">&quot;H&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-history-go-backward</span>
   <span class="string">&quot;L&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dirvish-history-go-forward</span>
   <span class="string">&quot;Q&quot;</span>     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-quit</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>dirvish-override-dired-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>dirvish-subtree-always-show-state t<span class="rainbow-delimiters-depth-2-face">)
  (</span>dirvish-attributes <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>vc-state subtree-state all-the-icons collapse git-msg file-time file-size<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Disable wrapping lines in some modes so that full-screen dirvish looks good
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dirvish-directory-view-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-line-wrapping</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dired-omit-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-line-wrapping</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-tab-line</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-dirvish</span> <span class="rainbow-delimiters-depth-2-face">(</span>dir<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Start dirvish in selected DIR.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;DOpen Dirvish in: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>dirvish dir<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-disable-line-wrapping</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>inhibit-message t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>visual-line-mode -1<span class="rainbow-delimiters-depth-3-face">)
    (</span>toggle-truncate-lines +1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-disable-tab-line</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>tab-line-mode -1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-dired-find-file-ace-window</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;In Dired, visit this file or directory in another window.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>dired--find-file <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>one-window-p<span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">find-file-other-window</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-find-file-ace-window</span><span class="rainbow-delimiters-depth-3-face">) (</span>dired-get-file-for-visit<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> im-dired-rsync
</span>
<span class="comment-delimiter">;; </span><span class="comment">Dired copies files sync. This function uses rsync to copy stuff
</span><span class="comment-delimiter">;; </span><span class="comment">async, especially useful while copying stuff over tramp/ssh.
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-dired-rsync</span> <span class="rainbow-delimiters-depth-2-face">(</span>dest<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Copy selected files with rsync to DEST.
This works over TRAMP (but only ssh and remote to local is
supported).

NOTE: Use \&quot;rsync --version\&quot; &gt; 3 or something like that.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>target <span class="rainbow-delimiters-depth-6-face">(</span>dired-dwim-target-directory<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>list
      <span class="rainbow-delimiters-depth-5-face">(</span>expand-file-name
       <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name
        <span class="string">&quot;Copy selected files to: &quot;</span>
        <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-contains? <span class="string">&quot;ssh:&quot;</span> target<span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;~/&quot;</span> target<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> dest <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name dest<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>files <span class="rainbow-delimiters-depth-5-face">(</span>dired-get-marked-files nil current-prefix-arg<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>ssh-regexp <span class="string">&quot;/ssh:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[a-zA-Z0-9_-\\.@]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">:&quot;</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>resolve-dir <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>it<span class="rainbow-delimiters-depth-6-face">) (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>f-dir? it<span class="rainbow-delimiters-depth-7-face">)</span> it <span class="rainbow-delimiters-depth-7-face">(</span>f-dirname it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>fix-remote-files
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>it<span class="rainbow-delimiters-depth-6-face">)
            (</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-7-face">(</span>host <span class="rainbow-delimiters-depth-8-face">(</span>nth 1 <span class="rainbow-delimiters-depth-9-face">(</span>s-match ssh-regexp it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                (</span>concat host <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>string-trim-left it ssh-regexp<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>shell-quote-argument it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">If `</span><span class="constant">default-directory</span><span class="comment">' points to ssh'ed directory, that
</span>         <span class="comment-delimiter">;; </span><span class="comment">may cause some issues. This is just to keep things simple
</span>         <span class="comment-delimiter">;; </span><span class="comment">and error-free.
</span>         <span class="rainbow-delimiters-depth-4-face">(</span>default-directory
           <span class="rainbow-delimiters-depth-5-face">(</span>funcall resolve-dir <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-matches? ssh-regexp dest<span class="rainbow-delimiters-depth-7-face">)
                                    (</span>car files<span class="rainbow-delimiters-depth-7-face">)</span>
                                  dest<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:command</span> <span class="string">&quot;rsync&quot;</span>
     <span class="builtin">:eat</span> t
     <span class="builtin">:switch</span> t
     <span class="builtin">:args</span>
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;-s&quot; &quot;--archive&quot; &quot;--recursive&quot; &quot;--verbose&quot; &quot;--human-readable&quot; &quot;--partial&quot; &quot;--xattrs&quot; &quot;--info=progress1&quot;</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--any?</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-matches? ssh-regexp it<span class="rainbow-delimiters-depth-7-face">)</span> files<span class="rainbow-delimiters-depth-6-face">)</span>
           <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;-e&quot; &quot;ssh&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span>mapcar fix-remote-files files<span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-matches? ssh-regexp dest<span class="rainbow-delimiters-depth-6-face">)</span>
           <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;-e&quot; &quot;ssh&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>funcall fix-remote-files dest<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-finish</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span>message <span class="string">&quot;&gt;&gt; Files copied successfully.&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-fail</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span>message <span class="string">&quot;!! Error while copying files.&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> image-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">image-mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> image-mode-map
  <span class="comment-delimiter">;; </span><span class="comment">&quot;q&quot; #'evil-delete-buffer
</span>  <span class="string">&quot;+&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-increase-size</span>
  <span class="string">&quot;-&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-decrease-size</span>
  <span class="string">&quot;H&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-scroll-right</span>
  <span class="string">&quot;L&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-scroll-left</span>
  <span class="string">&quot;J&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-scroll-up</span>
  <span class="string">&quot;K&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-scroll-down</span>
  <span class="string">&quot;gg&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-scroll-down</span>
  <span class="string">&quot;G&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-scroll-up</span>
  <span class="string">&quot;h&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>image-scroll-right 5<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;l&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>image-scroll-left 5<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;j&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>image-scroll-up 5<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;k&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>image-scroll-down 5<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-rotate</span>
  <span class="string">&quot;_&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-flip-horizontally</span>
  <span class="string">&quot;\\&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">image-flip-horizontally</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> calendar &amp; diary &amp; appt
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some tips:
</span>
<span class="comment-delimiter">;; </span><span class="comment">- ~.~ go to today
</span><span class="comment-delimiter">;; </span><span class="comment">- ~0,$~ beginning/end of the week
</span><span class="comment-delimiter">;; </span><span class="comment">- ~(,)~ beginning/end of the month
</span><span class="comment-delimiter">;; </span><span class="comment">- ~{,}~ prev/next month
</span><span class="comment-delimiter">;; </span><span class="comment">- ~[,]~ prev/next year
</span><span class="comment-delimiter">;; </span><span class="comment">- ~gs~ show sunrise/sunset time of date under cursor
</span><span class="comment-delimiter">;; </span><span class="comment">- ~gd~ go to a date with a wizard.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~a~ to jump org-agenda for that day.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~d~ to show diary entries only. (agenda already shows these)
</span><span class="comment-delimiter">;; </span><span class="comment">- ~ii~ to insert entry for that date.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~iw/im/iy/ia/ib~ to insert weekly/monthly/anneversary/block (block being between the marked day and selected day) entry.
</span><span class="comment-delimiter">;; </span><span class="comment">- Set a mark by hitting ~v~, then go to another date and hit ~M-=~ which will show day count between those two dates.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">calendar</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Enable including other diary entries using the #include &quot;...&quot; syntax
</span>  <span class="comment-delimiter">;; </span><span class="comment">I use this to separate my work and normal diary
</span>  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>diary-list-entries . diary-include-other-diary-files<span class="rainbow-delimiters-depth-3-face">)
         (</span>diary-list-entries . diary-sort-entries<span class="rainbow-delimiters-depth-3-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">Show week numbers on calendar
</span>         <span class="rainbow-delimiters-depth-3-face">(</span>after-init . im-calendar-week-number-mode<span class="rainbow-delimiters-depth-3-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">Show sunrise/sunset when calendar opens
</span>         <span class="rainbow-delimiters-depth-3-face">(</span>calendar-today-visible . calendar-sunrise-sunset<span class="rainbow-delimiters-depth-3-face">)
         (</span>calendar-today-visible . calendar-mark-today<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;ec&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">calendar</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:commands</span> calendar
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> diary-fancy-display-mode-map <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-delete-buffer</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> calendar-mode-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-calendar-jump-org-agenda</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-calendar-setup<span class="rainbow-delimiters-depth-2-face">)

  (</span>calendar-set-date-style <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">european</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Start the week from Monday
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> calendar-week-start-day 1<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">lng and lat for my location, to get sunrise/sunset times on my
</span>  <span class="comment-delimiter">;; </span><span class="comment">calendar (press `</span><span class="constant">gs</span><span class="comment">'). `</span><span class="constant">calendar-sunrise-sunset</span><span class="comment">' shows the
</span>  <span class="comment-delimiter">;; </span><span class="comment">sunrise/sunset times for time under the cursor which means you
</span>  <span class="comment-delimiter">;; </span><span class="comment">can look up sunrise/sunset times of past/future times.
</span>
  <span class="comment-delimiter">;; </span><span class="comment">See down below for im-adaptive-theme, it automatically sets
</span>  <span class="comment-delimiter">;; </span><span class="comment">these variables. I keep this as fallback here:
</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> calendar-latitude im-amsterdam-lat<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> calendar-longitude im-amsterdam-long<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Use 24-hour format to display times
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> calendar-time-display-form
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>24-hours <span class="string">&quot;:&quot;</span> minutes <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> time-zone <span class="string">&quot; (&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> time-zone <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> time-zone <span class="string">&quot;)&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> diary-display-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-fancy-display</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> diary-number-of-entries 7<span class="rainbow-delimiters-depth-2-face">)

  (</span>evil-collection-define-key <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">calendar-mode-map</span>
    <span class="string">&quot;ii&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-entry</span>
    <span class="string">&quot;id&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-entry</span>
    <span class="string">&quot;iw&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-weekly-entry</span>
    <span class="string">&quot;im&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-monthly-entry</span>
    <span class="string">&quot;iy&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-yearly-entry</span>
    <span class="string">&quot;ia&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-anniversary-entry</span>
    <span class="string">&quot;ib&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diary-insert-block-entry</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Show calendar at the bottom
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>im-shackle-window <span class="string">&quot;Calendar&quot;</span> 0.3<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-calendar-jump-org-agenda</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open the currently selected calendar date on org-agenda.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil calendar-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>org-agenda-window-setup <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">other-window</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>org-agenda-span 1<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-calendar-goto-agenda<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">https://www.emacswiki.org/emacs/CalendarWeekNumbers
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-calendar-week-number-mode</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show week numbers in M-x calendar.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>copy-face font-lock-constant-face <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">calendar-iso-week-face</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>set-face-attribute <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">calendar-iso-week-face</span> nil <span class="builtin">:height</span> 0.7<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span>
   calendar-intermonth-text
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>propertize
     <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;%2d&quot;</span>
             <span class="rainbow-delimiters-depth-5-face">(</span>car
              <span class="rainbow-delimiters-depth-6-face">(</span>calendar-iso-from-absolute
               <span class="rainbow-delimiters-depth-7-face">(</span>calendar-absolute-from-gregorian <span class="rainbow-delimiters-depth-8-face">(</span>list month day year<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">font-lock-face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">calendar-iso-week-face</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Automatically syncing with remote calendars
</span>
<span class="comment-delimiter">;; </span><span class="comment">I'm experimenting with using default Emacs calendar as my work
</span><span class="comment-delimiter">;; </span><span class="comment">calendar. To do so, I import the remote calendar into my diary
</span><span class="comment-delimiter">;; </span><span class="comment">using the following function. Set ~im-calendar-remote-ics-file~ to
</span><span class="comment-delimiter">;; </span><span class="comment">the url of ICS file beforehand.
</span>
<span class="comment-delimiter">;; </span><span class="comment">You also need to import work diary file in your main diary file,
</span><span class="comment-delimiter">;; </span><span class="comment">like this:
</span>
<span class="comment-delimiter">;; </span><span class="comment">#include &quot;~/.emacs.d/.cache/work-diary&quot;
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">im-work-diary-path</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="string">&quot;~/.emacs.d/.cache/work-diary&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-update-calendar</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Sync emacs calendar/diary with my remote calendar.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; Updating the calender...&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>url-retrieve
   im-calendar-remote-ics-file
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>status<span class="rainbow-delimiters-depth-4-face">)
     (</span>delete-region <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span> url-http-end-of-headers<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Following is required because some diary entries may contain
</span>     <span class="comment-delimiter">;; </span><span class="comment">Turkish characters and url-retrieve does not set
</span>     <span class="comment-delimiter">;; </span><span class="comment">buffer-multibyte to t automatically
</span>     <span class="rainbow-delimiters-depth-4-face">(</span>set-buffer-multibyte t<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Clean the work-diary first, so that items do not get
</span>     <span class="comment-delimiter">;; </span><span class="comment">duplicated
</span>     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>find-file-noselect im-work-diary-path<span class="rainbow-delimiters-depth-5-face">)
       (</span>delete-region <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">) (</span>point-max<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>icalendar-import-buffer im-work-diary-path t<span class="rainbow-delimiters-depth-4-face">)
     (</span>message <span class="string">&quot;&gt;&gt; Updating the calendar... DONE&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;; </span><span class="comment">To sync it automatically:
</span>
<span class="comment-delimiter">;; </span><span class="comment">Disabled it for now as our public calendar links are disabled.
</span><span class="comment-delimiter">;; </span><span class="comment">(run-with-timer 60 (* 30 60) #'im-update-calendar)
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> appt.el: notifications for org-agenda and diary items
</span>
<span class="comment-delimiter">;; </span><span class="comment">~appt.el~ shows notifications for upcoming events in your diary and
</span><span class="comment-delimiter">;; </span><span class="comment">in your org-agenda.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- By default appt shows only the entries found in diary and the included files in ~diary-file~
</span><span class="comment-delimiter">;; </span><span class="comment">- If you want to add an appt but do not want to edit ~diary-file~, you can use ~appt-add~ which adds it to the ~appt-time-msg-list~.
</span><span class="comment-delimiter">;; </span><span class="comment">- You can use ~appt-delete~ to remove appts from the list.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~appt-time-msg-list~ updated when
</span><span class="comment-delimiter">;; </span><span class="comment">- this package is initialized, aka ~(require 'appt)~
</span><span class="comment-delimiter">;; </span><span class="comment">- at 00:01
</span><span class="comment-delimiter">;; </span><span class="comment">- manually by ~appt-check~
</span><span class="comment-delimiter">;; </span><span class="comment">- manually by ~org-agenda-to-appt~
</span><span class="comment-delimiter">;; </span><span class="comment">- whenever ~diary-file~ (and the files it includes) is edited
</span><span class="comment-delimiter">;; </span><span class="comment">- whenever one of ~org-agenda-files~ is edited. (see below)
</span>
<span class="comment-delimiter">;; </span><span class="comment">~appt-message-warning-time~ is the minutes before appt.el starts showing warnings and it shows warnings every ~appt-display-interval~ minutes until the event starts.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">appt</span>
  <span class="builtin">:defer</span> 20
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Automatically update `</span><span class="constant">appt-time-msg-list</span><span class="comment">' after editing an
</span>  <span class="comment-delimiter">;; </span><span class="comment">org-agenda file
</span>  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>org-mode . im-org-agenda-to-appt-on-save<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Use my notification function for appt notifications
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> appt-disp-window-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-appt-notify</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> appt-message-warning-time 10<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> appt-display-interval 4<span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">save-window-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>appt-activate 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-agenda-to-appt-on-save</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>add-hook
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-save-hook</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>-contains? <span class="rainbow-delimiters-depth-6-face">(</span>org-agenda-files <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">unrestricted</span><span class="rainbow-delimiters-depth-6-face">) (</span>buffer-file-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="comment-delimiter">;; </span><span class="comment">When REFRESH is non-nil, it removes all appts and
</span>       <span class="comment-delimiter">;; </span><span class="comment">re-parses. This means appts that are manually added using
</span>       <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">appt-add</span><span class="comment">' are removed. I used to use `</span><span class="constant">appt-add</span><span class="comment">' but now I
</span>       <span class="comment-delimiter">;; </span><span class="comment">use `</span><span class="constant">tmr</span><span class="comment">' which supports both HH:MM and relative timers.
</span>
       <span class="comment-delimiter">;; </span><span class="comment">Do this async as it causes some lag on save on some of my
</span>       <span class="comment-delimiter">;; </span><span class="comment">org files that are &gt; 2MB.
</span>       <span class="rainbow-delimiters-depth-5-face">(</span>async-start
        <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">()</span>
           ,<span class="rainbow-delimiters-depth-7-face">(</span>async-inject-variables <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">org-agenda-files</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">load-path</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">org-todo-keywords</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span><span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">org</span><span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">org-agenda</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>org-agenda-to-appt <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">refresh</span><span class="rainbow-delimiters-depth-7-face">)</span>
           appt-time-msg-list<span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>result<span class="rainbow-delimiters-depth-7-face">)</span>
          <span class="comment-delimiter">;; </span><span class="comment">Clear the properties that comes with it. I'm not quite
</span>          <span class="comment-delimiter">;; </span><span class="comment">sure why is this needed but otherwise appt-check fails.
</span>          <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">setq</span> appt-time-msg-list <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-9-face">(</span>list <span class="rainbow-delimiters-depth-1-face">(</span>car it<span class="rainbow-delimiters-depth-1-face">) (</span>car <span class="rainbow-delimiters-depth-2-face">(</span>nth 1 it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">) (</span>nth 2 it<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> result<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span>message <span class="string">&quot;&gt;&gt; appt updated&quot;</span><span class="rainbow-delimiters-depth-7-face">)
          (</span>appt-check<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   nil t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-appt-notify</span> <span class="rainbow-delimiters-depth-2-face">(</span>min-to-appt new-time appt-msg<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>listp min-to-appt<span class="rainbow-delimiters-depth-3-face">)
      (</span><span class="keyword">--each</span> <span class="rainbow-delimiters-depth-4-face">(</span>-zip-pair min-to-appt appt-msg<span class="rainbow-delimiters-depth-4-face">)
        (</span>im-appt-notify--helper <span class="rainbow-delimiters-depth-5-face">(</span>car it<span class="rainbow-delimiters-depth-5-face">)</span> new-time <span class="rainbow-delimiters-depth-5-face">(</span>cdr it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-appt-notify--helper min-to-appt new-time appt-msg<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-appt-notify--helper</span> <span class="rainbow-delimiters-depth-2-face">(</span>min-to-appt new-time appt-msg<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> min-to-appt <span class="rainbow-delimiters-depth-3-face">(</span>string-to-number min-to-appt<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; appt :: %s, remaining %s mins&quot;</span> appt-msg min-to-appt<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>important? <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cond</span>
                     <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>s-contains? <span class="string">&quot;meeting&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-downcase appt-msg<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span> t<span class="rainbow-delimiters-depth-6-face">)
                     (</span>t nil<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>alert
     <span class="rainbow-delimiters-depth-4-face">(</span>im-org-header-line-to-title appt-msg<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;Reminder, %s mins left&quot;</span> min-to-appt new-time<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:severity</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> important? <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">high</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:persistent</span> important?
     <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">appt</span>
     <span class="builtin">:id</span> appt-msg<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> More org-mode and diary integration and utilities
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-diary-kill-entry-as-bullet-task</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> include-description<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Copy current diary entry as a bullet.org task.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-as-&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-3-face">)</span> it
   <span class="rainbow-delimiters-depth-3-face">(</span>s-match <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9]+:[0-9]+-[0-9]+:[0-9]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> it<span class="rainbow-delimiters-depth-3-face">)
   (</span>format
    <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#A] %s :work:\nSCHEDULED: &lt;%s %s&gt;\n%s&quot;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>link <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-8-face">(</span>im-diary-entry-meeting-link<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>format <span class="string">&quot;[[%s][%s]]&quot;</span> link <span class="rainbow-delimiters-depth-6-face">(</span>nth 2 it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>nth 2 it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>im-today<span class="rainbow-delimiters-depth-4-face">)
    (</span>nth 1 it<span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">if</span> include-description <span class="rainbow-delimiters-depth-5-face">(</span>im-diary-entry-description<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>im-kill it<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-diary-entry-meeting-link</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get meeting/zoom link of current diary entry.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>entry-details <span class="rainbow-delimiters-depth-5-face">(</span>im-diary-entry-description<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-temp-buffer</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>insert entry-details<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>re-search-forward <span class="string">&quot;https://.*zoom&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-diary-entry-description</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get details/description of current diary entry.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-window-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>push-button<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>beg <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-excursion</span>
                 <span class="rainbow-delimiters-depth-7-face">(</span>re-search-backward <span class="string">&quot;^[</span><span class="negation-char">^</span><span class="string"> \n].+&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                 (</span>forward-line<span class="rainbow-delimiters-depth-7-face">)
                 (</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>end <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-excursion</span>
                 <span class="rainbow-delimiters-depth-7-face">(</span>re-search-forward <span class="string">&quot;^[</span><span class="negation-char">^</span><span class="string"> \n].+&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                 (</span>beginning-of-line<span class="rainbow-delimiters-depth-7-face">)
                 (</span>point<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-kill <span class="rainbow-delimiters-depth-5-face">(</span>buffer-substring beg end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tramp
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> tramp-default-method <span class="string">&quot;ssh&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">setq</span> tramp-verbose 2<span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ Only show errors and warnings
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> vc-handled-backends <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>Git<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">^ Only try to handle git, this speeds up things a little bit
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> w3m
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Installation/Keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">w3m</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>w3m im-w3m-open-url-dwim<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>w3m-mode . <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span><span class="keyword">setq-local</span> scroll-margin 0<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">w3m-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;&amp;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>funcall browse-url-secondary-browser-function w3m-current-url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;^&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>browse-url w3m-current-url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;K&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">w3m-next-buffer</span>
   <span class="string">&quot;J&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">w3m-previous-buffer</span>
   <span class="string">&quot;o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-w3m-open-url-dwim</span>
   <span class="string">&quot;O&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">w3m-edit-url</span>
   <span class="string">&quot;t&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-w3m-open-url-dwim <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="string">&quot;URL: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="builtin">:new-session</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;T&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-w3m-open-url-dwim <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="string">&quot;URL: &quot;</span> w3m-current-url<span class="rainbow-delimiters-depth-5-face">)</span> <span class="builtin">:new-session</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;M-j&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">w3m-tab-move-left</span>
   <span class="string">&quot;M-k&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">w3m-tab-move-right</span>
   <span class="string">&quot;x&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">w3m-delete-buffer</span>
   <span class="string">&quot;Y&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-w3m-yank-url</span>
   <span class="string">&quot;f&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-w3m-avy-link</span>
   <span class="string">&quot;F&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-w3m-avy-link-new-session</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>w3m-fill-column 80<span class="rainbow-delimiters-depth-2-face">)
  (</span>w3m-use-title-buffer-name t<span class="rainbow-delimiters-depth-2-face">)
  (</span>w3m-default-display-inline-images t<span class="rainbow-delimiters-depth-2-face">)
  (</span>w3m-use-tab-line nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">(setq w3m-display-mode 'plain)
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>w3m-display-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">plain</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-w3m-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-w3m-open-url-dwim</span> <span class="rainbow-delimiters-depth-2-face">(</span>url <span class="type">&amp;optional</span> new-session<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;sURL: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-url? url<span class="rainbow-delimiters-depth-3-face">)
      (</span><span class="keyword">if</span> new-session <span class="rainbow-delimiters-depth-4-face">(</span>w3m-goto-url-new-session url<span class="rainbow-delimiters-depth-4-face">) (</span>w3m-goto-url url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> new-session <span class="rainbow-delimiters-depth-4-face">(</span>w3m-search w3m-search-default-engine url<span class="rainbow-delimiters-depth-4-face">) (</span>w3m-search-new-session w3m-search-default-engine url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Extras
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-w3m-all-anchor-points</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> start end<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return all anchor points for current w3m buffer.
If START and/or END is given, only return anchor points between
START and END positions of the buffer, otherwise return all
anchor points in the buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>points <span class="rainbow-delimiters-depth-5-face">(</span>list<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>start <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> start <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>end <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> end <span class="rainbow-delimiters-depth-6-face">(</span>point-max<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>prev 0<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>goto-char start<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>w3m-next-anchor<span class="rainbow-delimiters-depth-6-face">)
                  (</span>&gt; <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span> prev<span class="rainbow-delimiters-depth-6-face">)
                  (</span>&lt;= <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span> end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> prev <span class="rainbow-delimiters-depth-6-face">(</span>point<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when-let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>url <span class="rainbow-delimiters-depth-8-face">(</span>w3m-url-valid <span class="rainbow-delimiters-depth-9-face">(</span>w3m-anchor<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span>_ <span class="rainbow-delimiters-depth-8-face">(</span>string-match <span class="string">&quot;\\`https?:&quot;</span> url<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span> points<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    points<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-w3m-avy-link</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Jump to a link and open it automatically.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>avy-process <span class="rainbow-delimiters-depth-3-face">(</span>im-w3m-all-anchor-points <span class="rainbow-delimiters-depth-4-face">(</span>window-start<span class="rainbow-delimiters-depth-4-face">) (</span>window-end<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>w3m-goto-url <span class="rainbow-delimiters-depth-3-face">(</span>w3m-anchor<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-w3m-avy-link-new-session</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Jump to a link and open it automatically.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>avy-process <span class="rainbow-delimiters-depth-3-face">(</span>im-w3m-all-anchor-points <span class="rainbow-delimiters-depth-4-face">(</span>window-start<span class="rainbow-delimiters-depth-4-face">) (</span>window-end<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>w3m-goto-url-new-session <span class="rainbow-delimiters-depth-3-face">(</span>w3m-anchor<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-w3m-yank-url</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Copy current URL to clipboard.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">w3m-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-kill w3m-current-url<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Rename w3m buffer names in a way that works with my
</span><span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">im-tab-line-buffers</span><span class="comment">' implementation
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-advice</span> <span class="function-name">w3m-buffer-name-add-title</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-3-face">)</span> rename-w3m-buffer-name<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> w3m-use-title-buffer-name
    <span class="rainbow-delimiters-depth-3-face">(</span>rename-buffer
     <span class="rainbow-delimiters-depth-4-face">(</span>format
      <span class="string">&quot;*w3m: %s *w3m*&lt;%d&gt;&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>w3m-current-title<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="comment-delimiter">;; </span><span class="comment">Lot's of functions on w3m depend on this number. Hence I left
</span>      <span class="comment-delimiter">;; </span><span class="comment">it here. Ugly but not worth dealing with
</span>      <span class="rainbow-delimiters-depth-5-face">(</span>w3m-buffer-number <span class="rainbow-delimiters-depth-6-face">(</span>current-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> eww -- web browser
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defconst</span> <span class="variable-name">im-reddit-comment-url-regexp</span> <span class="string">&quot;.*reddit.com/r/[a-zA-Z0-9_-]+/comments/[a-zA-Z0-9_-]+/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[a-zA-Z0-9_-]+/?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">/[a-zA-Z0-9_-]+/?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">&amp;.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?$&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-purified-url-handler</span> <span class="rainbow-delimiters-depth-2-face">(</span>fn<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Clear the redundant stuff from urls.
Some links are prefixed with google redirection url, this
removes (and other similar stuff) so that the url handler works
properly.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>url <span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-3-face">)
    (</span>funcall
     fn
     <span class="rainbow-delimiters-depth-4-face">(</span>s-chop-prefix <span class="string">&quot;https://www.google.com/url?q=&quot;</span> url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> browse-url-secondary-browser-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">browse-url-firefox</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">setq</span> browse-url-handlers
      <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;.*jtracker.trendyol.*/browse/.*&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jira-view-ticket</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*slack.com/archives/.*&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-open-link</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>,im-reddit-comment-url-regexp . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">reddigg-view-comments</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*news.ycombinator.com/item\\?id=.*&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hnreader-comment</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">stackoverflow.com</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">stackexchange.com</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">.*&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-open-stackexchange-link</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">youtube.com/watch.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">youtu.be/.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">empv-play-or-enqueue</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*\\.mp3&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">empv--play-or-enqueue</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*github.com/.*issues/.*&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-github-issue-view</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;https://github.com/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[</span><span class="negation-char">^</span><span class="string">/]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[</span><span class="negation-char">^</span><span class="string">/]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">/blob/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[</span><span class="negation-char">^</span><span class="string">/]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-github-view-repo-file</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*github.com/[A-Za-z0-9\\. _-]+/[A-Za-z0-9\\. _-]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\?tab=readme-ov-file.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?$&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-github-view-repo-readme</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*zoom.us/j/.*&quot;</span> . ,<span class="rainbow-delimiters-depth-4-face">(</span>im-purified-url-handler <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-open-zoom-meeting-dwim</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">trendyol</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">gitlab</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">slack</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">docs.google</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">.*&quot;</span> . browse-url-firefox<span class="rainbow-delimiters-depth-3-face">)
        (</span><span class="string">&quot;.&quot;</span> . <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>link <span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">) (</span>im-eww link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">eww</span>
  <span class="builtin">:commands</span> eww
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>eww-mode . tab-line-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;ew&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww-plain</span>
    <span class="string">&quot;eW&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">embark-file-map</span> <span class="string">&quot;/&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eww-open-file</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">shr-map</span>
   <span class="string">&quot;z&quot;</span> nil <span class="comment-delimiter">;; </span><span class="comment">So that regular evil bindings work
</span>   <span class="string">&quot;v&quot;</span> nil <span class="comment-delimiter">;; </span><span class="comment">So that regular evil bindings work
</span>   <span class="string">&quot;O&quot;</span> nil <span class="comment-delimiter">;; </span><span class="comment">So that my bindings work
</span>   <span class="string">&quot;+&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">shr-zoom-image</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eww-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;Y&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eww-copy-page-url</span>
   <span class="comment-delimiter">;; </span><span class="comment">There is also u binding in shr-map but this is easier to remember
</span>   <span class="string">&quot;c&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">shr-maybe-probe-and-copy-url</span>
   <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww-save-image</span>
   <span class="string">&quot;O&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>eww <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="string">&quot;URL: &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>eww-current-url<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;t&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww</span>
   <span class="string">&quot;T&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>funcall-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww</span> <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="string">&quot;URL: &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>eww-current-url<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;f&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww-avy-follow</span>
   <span class="string">&quot;F&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-eww-avy-follow <span class="builtin">:new-session</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eww-reload</span>
   <span class="string">&quot;R&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eww-readable</span>
   <span class="string">&quot;&lt;f2&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww-open-in-xwidget-webkit</span>
   <span class="string">&quot;&lt;f3&gt;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>browse-url <span class="rainbow-delimiters-depth-5-face">(</span>eww-current-url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;&lt;f4&gt;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>browse-url-default-browser <span class="rainbow-delimiters-depth-5-face">(</span>eww-current-url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;&amp;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>funcall browse-url-secondary-browser-function <span class="rainbow-delimiters-depth-5-face">(</span>eww-current-url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">Gifs make my computer suffer, so I just disable them
</span>  <span class="comment-delimiter">;; </span><span class="comment">(setq shr-image-animate nil)
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>shr-max-image-proportion 0.6<span class="rainbow-delimiters-depth-2-face">)
  (</span>shr-discard-aria-hidden t<span class="rainbow-delimiters-depth-2-face">)
  (</span>shr-use-xwidgets-for-media t<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Use browse-url for each link opening. This way my
</span>  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">browse-url-handlers</span><span class="comment">' take precedence over eww.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>eww-use-browse-url <span class="string">&quot;.*&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>eww-search-prefix <span class="string">&quot;https://www.ecosia.org/search?q=&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>eww-auto-rename-buffer
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>format <span class="string">&quot;*eww: %s*&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get eww-data <span class="builtin">:title</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;...&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-eww-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww</span> <span class="rainbow-delimiters-depth-2-face">(</span>url<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;`</span><span class="constant">eww</span><span class="doc">' wrapper.
Like `</span><span class="constant">eww</span><span class="doc">' but open URL in a new eww buffer instead of reusing
the same one if called interactively.  If inside an eww buffer,
then utilize `</span><span class="constant">eww-browse-url</span><span class="doc">' instead.  See `</span><span class="constant">eww-use-browse-url</span><span class="doc">'
for why.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>im-web-autosuggest <span class="builtin">:history</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eww-prompt-history</span> <span class="builtin">:initial</span> <span class="rainbow-delimiters-depth-5-face">(</span>im-region-or <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-eww-plain url<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww-plain</span> <span class="rainbow-delimiters-depth-2-face">(</span>url<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Search: &quot;</span> nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eww-prompt-history</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="comment-delimiter">;; </span><span class="comment">If called interactively, just use a new buffer
</span>   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-4-face">) (</span>eww url t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="comment-delimiter">;; </span><span class="comment">If we are inside an eww buffer and this function is called, simply navigate to the URL.
</span>   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>equal major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eww-mode</span><span class="rainbow-delimiters-depth-4-face">) (</span>eww-browse-url url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="comment-delimiter">;; </span><span class="comment">Default to interactive behavior
</span>   <span class="rainbow-delimiters-depth-3-face">(</span>t <span class="rainbow-delimiters-depth-4-face">(</span>eww url t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww-avy-follow</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> follow-type<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>wend <span class="rainbow-delimiters-depth-5-face">(</span>window-end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>urls <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>window-start<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while-let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>match <span class="rainbow-delimiters-depth-7-face">(</span>text-property-search-forward <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">shr-tab-stop</span> nil nil t<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="rainbow-delimiters-depth-7-face">(</span>&lt; <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">)</span> wend<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span>prop-match-beginning match<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
        <span class="comment-delimiter">;; </span><span class="comment">(push (get-text-property (point) 'shr-url) urls)
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">push</span> <span class="rainbow-delimiters-depth-6-face">(</span>point<span class="rainbow-delimiters-depth-6-face">)</span> urls<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>avy-process <span class="rainbow-delimiters-depth-4-face">(</span>nreverse urls<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">pcase</span> follow-type
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:new-session</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>eww <span class="rainbow-delimiters-depth-6-face">(</span>get-text-property <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">shr-url</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="builtin">:new-session</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="builtin">:external</span> <span class="rainbow-delimiters-depth-5-face">(</span>eww-browse-with-external-browser  t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>_ <span class="rainbow-delimiters-depth-5-face">(</span>eww-follow-link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww-save-image</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Save the image at point.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>image <span class="rainbow-delimiters-depth-5-face">(</span>get-text-property <span class="rainbow-delimiters-depth-6-face">(</span>point<span class="rainbow-delimiters-depth-6-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">display</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
        <span class="comment-delimiter">;; </span><span class="comment">Disable all save hooks as they might damage the file
</span>        <span class="rainbow-delimiters-depth-4-face">(</span>before-save-hook <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>after-save-hook <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> image
                 <span class="rainbow-delimiters-depth-5-face">(</span>eq <span class="rainbow-delimiters-depth-6-face">(</span>car image<span class="rainbow-delimiters-depth-6-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">image</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;No images at point!&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-temp-buffer</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> buffer-file-name
            <span class="rainbow-delimiters-depth-5-face">(</span>read-file-name <span class="string">&quot;Save to: &quot;</span>  nil default-directory nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>plist-get <span class="rainbow-delimiters-depth-6-face">(</span>cdr image<span class="rainbow-delimiters-depth-6-face">)</span> <span class="builtin">:data</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>save-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww-open-in-xwidget-webkit</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil eww-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>xwidget-webkit-browse-url <span class="rainbow-delimiters-depth-3-face">(</span>plist-get eww-data <span class="builtin">:url</span><span class="rainbow-delimiters-depth-3-face">)</span> t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-xwidget-webkit-open-in-eww</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil xwidget-webkit-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>eww <span class="rainbow-delimiters-depth-3-face">(</span>xwidget-webkit-uri <span class="rainbow-delimiters-depth-4-face">(</span>xwidget-webkit-current-session<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> im-web-autosuggest -- autosuggestions for web searches
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-web-autosuggest-history</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">cl-defun</span> <span class="function-name">im-web-autosuggest</span>
    <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span>
     <span class="rainbow-delimiters-depth-3-face">(</span>history <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-web-autosuggest-history</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>initial <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Autosuggest as you type for web searches.
This uses StartPage's autosuggestion endpoint.  It is not very good but
better than nothing.

HISTORY is by default `</span><span class="constant">im-web-autosuggest-history</span><span class="doc">', it should be a
symbol.  Access history as usual, C-r or \\[</span><span class="constant">consult-history</span><span class="doc">].

INITIAL is the initial string shown in the prompt.  By default it's
empty string.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>consult--read
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">thread-first</span>
      <span class="rainbow-delimiters-depth-5-face">(</span>consult--async-sink<span class="rainbow-delimiters-depth-5-face">)
      (</span>consult--async-refresh-immediate<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-web-autosuggest--gen<span class="rainbow-delimiters-depth-5-face">)
      (</span>consult--async-throttle<span class="rainbow-delimiters-depth-5-face">)
      (</span>consult--async-split<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:prompt</span> <span class="string">&quot;Search for: &quot;</span>
    <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span>
    <span class="builtin">:lookup</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>selected candidates cand <span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)</span> selected<span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:initial</span> <span class="rainbow-delimiters-depth-4-face">(</span>concat <span class="string">&quot;#&quot;</span> initial<span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:sort</span> nil
    <span class="builtin">:history</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> history <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-web-autosuggest-history</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:require-match</span> nil<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-web-autosuggest--gen</span> <span class="rainbow-delimiters-depth-2-face">(</span>next<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>action<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">pcase</span> action
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>pred stringp<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>not <span class="rainbow-delimiters-depth-7-face">(</span>string-empty-p <span class="rainbow-delimiters-depth-8-face">(</span>string-trim action<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>im-request
           <span class="string">&quot;https://ac.ecosia.org/autocomplete&quot;</span>
           <span class="builtin">:type</span> <span class="string">&quot;list&quot;</span>
           <span class="builtin">:q</span> action
           <span class="builtin">:-on-success</span>
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>data<span class="rainbow-delimiters-depth-8-face">)
             (</span>funcall next <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">flush</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">when</span> data
               <span class="rainbow-delimiters-depth-9-face">(</span>funcall next <span class="rainbow-delimiters-depth-1-face">(</span>cadr data<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
           <span class="builtin">:-on-error</span>
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>data<span class="rainbow-delimiters-depth-8-face">)
             (</span>funcall next <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">flush</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>_ <span class="rainbow-delimiters-depth-5-face">(</span>funcall next action<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Fixing page layouts
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some pages I frequently visit needs some fixing to display the
</span><span class="comment-delimiter">;; </span><span class="comment">content better.  The following piece does exactly that.  For each
</span><span class="comment-delimiter">;; </span><span class="comment">given url, it runs the specified function in the eww buffer.  This
</span><span class="comment-delimiter">;; </span><span class="comment">way I get a better view.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-eww-page-fixers</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;^https://</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">www.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?startpage.com/sp/search&quot;</span> . im-eww--fix-startpage<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eww</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eww-after-render-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eww-after-render</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww-after-render</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">--each</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-assoc-regexp <span class="rainbow-delimiters-depth-4-face">(</span>eww-current-url<span class="rainbow-delimiters-depth-4-face">)</span> im-eww-page-fixers<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>fn <span class="rainbow-delimiters-depth-6-face">(</span>cdr it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>inhibit-read-only t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>funcall fn<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eww--fix-startpage</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-3-face">(</span>re-search-forward <span class="string">&quot;Visit in Anonymous View&quot;</span> nil t<span class="rainbow-delimiters-depth-3-face">)
    (</span>delete-region <span class="rainbow-delimiters-depth-4-face">(</span>line-beginning-position<span class="rainbow-delimiters-depth-4-face">) (</span>line-end-position<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-min<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>pos <span class="rainbow-delimiters-depth-5-face">(</span>point<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>eobp<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">) (</span>not <span class="rainbow-delimiters-depth-6-face">(</span>looking-at <span class="string">&quot;^Web results&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-char<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>delete-region pos <span class="rainbow-delimiters-depth-4-face">(</span>point<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>re-search-forward <span class="string">&quot;^Startpage isn’t&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>forward-line -1<span class="rainbow-delimiters-depth-2-face">)
  (</span>delete-region <span class="rainbow-delimiters-depth-3-face">(</span>point<span class="rainbow-delimiters-depth-3-face">) (</span>point-max<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>page-break-lines-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Language detection and code highlighting in eww buffers
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">language-detection</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">eww-tag-pre</span> <span class="rainbow-delimiters-depth-2-face">(</span>dom<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>shr-folding-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">none</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>shr-current-font <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">default</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shr-ensure-newline<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>eww-fontify-pre dom<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shr-ensure-newline<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">eww-fontify-pre</span> <span class="rainbow-delimiters-depth-2-face">(</span>dom<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>shr-generic dom<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>mode <span class="rainbow-delimiters-depth-6-face">(</span>eww-buffer-auto-detect-mode<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> mode
        <span class="rainbow-delimiters-depth-5-face">(</span>eww-fontify-buffer mode<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>buffer-string<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">eww-fontify-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">delay-mode-hooks</span> <span class="rainbow-delimiters-depth-3-face">(</span>funcall mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>font-lock-default-function mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>font-lock-default-fontify-region <span class="rainbow-delimiters-depth-3-face">(</span>point-min<span class="rainbow-delimiters-depth-3-face">)
                                    (</span>point-max<span class="rainbow-delimiters-depth-3-face">)</span>
                                    nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">eww-buffer-auto-detect-mode</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>map <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>ada ada-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>awk awk-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>c c-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>cpp c++-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>clojure clojure-mode lisp-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>csharp csharp-mode java-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>css css-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>dart dart-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>delphi delphi-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>emacslisp emacs-lisp-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>erlang erlang-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>fortran fortran-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>fsharp fsharp-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>go go-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>groovy groovy-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>haskell haskell-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>html html-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>java java-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>javascript javascript-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>json json-mode javascript-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>latex latex-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>lisp lisp-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>lua lua-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>matlab matlab-mode octave-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>objc objc-mode c-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>perl perl-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>php php-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>prolog prolog-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>python python-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>r r-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>ruby ruby-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>rust rust-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>scala scala-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>shell shell-script-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>smalltalk smalltalk-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>sql sql-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>swift swift-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>visualbasic visual-basic-mode<span class="rainbow-delimiters-depth-6-face">)
                (</span>xml sgml-mode<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>language <span class="rainbow-delimiters-depth-5-face">(</span>language-detection-string
                    <span class="rainbow-delimiters-depth-6-face">(</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>point-min<span class="rainbow-delimiters-depth-7-face">) (</span>point-max<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>modes <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>assoc language map<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>mode <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cl-loop</span> for mode in modes
                        when <span class="rainbow-delimiters-depth-6-face">(</span>fboundp mode<span class="rainbow-delimiters-depth-6-face">)</span>
                        return mode<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;%s&quot;</span> language<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>fboundp mode<span class="rainbow-delimiters-depth-4-face">)</span>
      mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> shr-external-rendering-functions
      <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>pre . eww-tag-pre<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> shell-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">shell</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">shell-mode-map</span> <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-l&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">comint-clear-buffer</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> vc --- version control
</span>
<span class="comment-delimiter">;; </span><span class="comment">I used to use but because of it's slowness (mostly fault of macOs
</span><span class="comment-delimiter">;; </span><span class="comment">and my work mandatory security apps), I ditched it. vc is pretty
</span><span class="comment-delimiter">;; </span><span class="comment">nice most of the time.
</span>
<span class="comment-delimiter">;; </span><span class="comment">I've also implemented a status/commit workflow, similar to magit's
</span><span class="comment-delimiter">;; </span><span class="comment">but it's very fast and much more streamlined for my usage. See
</span><span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">im-git-status</span><span class="comment">' and `</span><span class="constant">im-git-commit</span><span class="comment">'.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vc</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vc-dir-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-dir-refresh</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vc-git-log-view-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;&lt;backtab&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-vc-toggle-all-log-view-entries</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">diff-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-vc-diff-open-file-at-revision-dwim</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span>
    <span class="string">&quot;gp&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-pull</span>
    <span class="string">&quot;gR&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-update-git-state</span>
    <span class="string">&quot;gbc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-create-branch</span>
    <span class="string">&quot;gbs&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-switch-branch</span>
    <span class="string">&quot;gB&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-annotate</span> <span class="comment-delimiter">;; </span><span class="comment">Git Blame
</span>    <span class="string">&quot;gL&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-print-root-log</span>
    <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: add magit like interface for force pushing and selecting upstream?
</span>    <span class="string">&quot;gP&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vc-push</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-vc-git-setup<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-log-view-setup<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-vc-dir-setup<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-vc-annotate-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-vc-diff-open-file-at-revision-dwim</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open the file at revision.
Simply works like you hit enter on a magit diff window.  Useful
when displaying old diffs and you want to jump to the full file
of that revision.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil diff-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">pcase-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span>,old ,new<span class="rainbow-delimiters-depth-5-face">)</span> diff-vc-revisions<span class="rainbow-delimiters-depth-4-face">)
               (</span>file-path <span class="rainbow-delimiters-depth-5-face">(</span>s-trim
                           <span class="rainbow-delimiters-depth-6-face">(</span>s-chop-prefixes
                            <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;--- a/&quot; &quot;+++ a/&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                            (</span><span class="keyword">save-excursion</span>
                              <span class="rainbow-delimiters-depth-8-face">(</span>diff-beginning-of-file<span class="rainbow-delimiters-depth-8-face">)
                              (</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span>old? <span class="rainbow-delimiters-depth-5-face">(</span>equal <span class="string">&quot;-&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>char-to-string <span class="rainbow-delimiters-depth-7-face">(</span>char-after <span class="rainbow-delimiters-depth-8-face">(</span>point-at-bol<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span>rev <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> old? old new<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span>line-info <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-excursion</span>
                            <span class="rainbow-delimiters-depth-6-face">(</span>diff-beginning-of-hunk<span class="rainbow-delimiters-depth-6-face">)
                            (</span>s-split <span class="string">&quot; &quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-trim <span class="rainbow-delimiters-depth-8-face">(</span>nth 1 <span class="rainbow-delimiters-depth-9-face">(</span>s-split <span class="string">&quot;@@&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span>line <span class="rainbow-delimiters-depth-5-face">(</span>string-to-number
                      <span class="rainbow-delimiters-depth-6-face">(</span>car <span class="rainbow-delimiters-depth-7-face">(</span>s-split
                            <span class="string">&quot;,&quot;</span>
                            <span class="rainbow-delimiters-depth-8-face">(</span>s-chop-prefixes
                             <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-9-face">(</span><span class="string">&quot;-&quot; &quot;+&quot;</span><span class="rainbow-delimiters-depth-9-face">)
                             (</span><span class="keyword">if</span> old? <span class="rainbow-delimiters-depth-1-face">(</span>car line-info<span class="rainbow-delimiters-depth-1-face">) (</span>nth 1 line-info<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer-create <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s.%s&quot;</span> file-path rev<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert
       <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string
        <span class="rainbow-delimiters-depth-6-face">(</span>format
         <span class="string">&quot;git show %s:%s&quot;</span> rev file-path<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>switch-to-buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">delay-mode-hooks</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>funcall <span class="rainbow-delimiters-depth-6-face">(</span>assoc-default file-path auto-mode-alist <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">string-match</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>reveal-mode<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-line line<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-update-git-state</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Update all diff-hl overlays and vc state for current project.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>project <span class="rainbow-delimiters-depth-5-face">(</span>project-current nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
              (</span>buffers <span class="rainbow-delimiters-depth-5-face">(</span>project-buffers project<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--each</span> buffers
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">with-current-buffer</span> it
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> buffer-file-name <span class="rainbow-delimiters-depth-7-face">(</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">prog-mode</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>diff-hl-update<span class="rainbow-delimiters-depth-6-face">)
          (</span>vc-refresh-state<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-vc-toggle-all-log-view-entries</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle the visibility of all log view entries in the current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil vc-git-log-view-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; Toggling all entries. This may take a while...&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-max<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span>equal <span class="rainbow-delimiters-depth-6-face">(</span>point<span class="rainbow-delimiters-depth-6-face">) (</span>point-min<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-5-face">(</span>log-view-toggle-entry-display<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-line -1<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-4-face">(</span>log-view-toggle-entry-display<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; Toggling all entries. This may take a while...Done&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> git-timemachine
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Toggle with ~git-timemachine~ (SPC gt).
</span><span class="comment-delimiter">;; </span><span class="comment">- When in timemachine mode,
</span><span class="comment-delimiter">;; </span><span class="comment">- use =gt&lt;SOMETHING&gt;= to do timemachine specific operations. Some useful ones are:
</span><span class="comment-delimiter">;; </span><span class="comment">- t -&gt; =git-timemachine-show-revision-fuzzy=, selects a revision through completing-read interface.
</span><span class="comment-delimiter">;; </span><span class="comment">- y/Y -&gt; Yank (abbreviated) revision hash.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~C-j/k~ to go to prev/next revision of the file.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">git-timemachine</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>git-timemachine-toggle<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;gt&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">git-timemachine-toggle</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-git-timemachine-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> diff-hl -- git gutter alternative
</span>
<span class="comment-delimiter">;; </span><span class="comment">Highlights changed lines in git. You can also stage hunks directly
</span><span class="comment-delimiter">;; </span><span class="comment">in the buffer.
</span>
<span class="comment-delimiter">;; </span><span class="comment">I used to use `</span><span class="constant">git-gutter</span><span class="comment">' but it adds lots of advices and clashes
</span><span class="comment-delimiter">;; </span><span class="comment">with my configuration.  diff-hl is a better maintained alternative
</span><span class="comment-delimiter">;; </span><span class="comment">and seemingly faster.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Doom Emacs customizations for diff-hl:
</span><span class="comment-delimiter">;; </span><span class="comment">https://github.com/doomemacs/doomemacs/blob/master/modules/ui/vc-gutter/config.el
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some observations on Doom Emacs configurations:
</span>
<span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">evil-insert-state-exit-hook</span><span class="comment">' causes performance issues, macros
</span><span class="comment-delimiter">;; </span><span class="comment">gets slower as the get in/out to insert state quickly.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">diff-hl</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;dgutov/diff-hl&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>prog-mode . diff-hl-mode<span class="rainbow-delimiters-depth-3-face">)
   (</span>diff-hl-mode . diff-hl-flydiff-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>diff-hl-disable-on-remote t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Performance optiomization for diffs.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>vc-git-diff-switches <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;--histogram&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Async update breaks my emacs for some reason. It's not on by
</span>  <span class="comment-delimiter">;; </span><span class="comment">default but wanted to keep it here to note this. This happens
</span>  <span class="comment-delimiter">;; </span><span class="comment">probably due to make-thread calls. Possibly only happens on OSX.
</span>  <span class="comment-delimiter">;; </span><span class="comment">UPDATE: After updating Emacs to 29.4, the crashing problem
</span>  <span class="comment-delimiter">;; </span><span class="comment">disappeared but setting it to t makes diff-hl even more slow.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>diff-hl-update-async nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>diff-hl-flydiff-delay 0.5<span class="rainbow-delimiters-depth-2-face">)
  (</span>diff-hl-show-staged-changes nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>diff-hl-draw-borders nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;g[&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-previous-hunk</span>
    <span class="string">&quot;g]&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-next-hunk</span>
    <span class="comment-delimiter">;; </span><span class="default-0035">FIXME</span><span class="comment">: Shortcuts that appear on &quot;show&quot; dialog are not usable (due to evil mode?)
</span>    <span class="string">&quot;g{&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-show-hunk-previous</span>
    <span class="string">&quot;g}&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-show-hunk-next</span>
    <span class="comment-delimiter">;; </span><span class="default-0035">FIXME</span><span class="comment">: This does not work on region (can not apply the hunk for some reason?)
</span>    <span class="string">&quot;gS&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-stage-dwim</span>
    <span class="string">&quot;gr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-revert-hunk</span>
    <span class="string">&quot;gx&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-revert-hunk</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;[g&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-previous-hunk</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;]g&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">diff-hl-next-hunk</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">define-advice</span> <span class="function-name">diff-hl-previous-hunk</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">) (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">diff-hl-next-hunk</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">) (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">diff-hl-show-hunk-previous</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">) (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">diff-hl-show-hunk-next</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">) (</span>recenter<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">diff-hl-stage-dwim</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:around</span> <span class="rainbow-delimiters-depth-4-face">(</span>orig-fn <span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-4-face">)</span> apply-even-if-buffer-is-narrowed<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="doc">&quot;Original `</span><span class="constant">diff-hl-stage-dwim</span><span class="doc">' does not work if buffer is narrowed, this fixes it.&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>widen<span class="rainbow-delimiters-depth-4-face">)
      (</span>apply orig-fn args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> blamer -- git blame
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">blamer</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>blamer-show-posframe-commit-info<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;gi&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">blamer-show-posframe-commit-info</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> avy
</span>
<span class="comment-delimiter">;; </span><span class="comment">avy is very similar to ~vim-easymotion~. It simply jumps to a
</span><span class="comment-delimiter">;; </span><span class="comment">visible text using a given char.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =s= for jumping to beginning of a word
</span><span class="comment-delimiter">;; </span><span class="comment">- =S= for jumping any part of the text
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">avy</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>avy-goto-subword-1 avy-goto-word-1<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>avy-keys <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>?q ?w ?e ?r ?t ?a ?s ?d ?f ?j ?k ?l ?u ?i ?o ?p<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>avy-case-fold-search nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>avy-all-windows t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;S&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">avy-goto-subword-1</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">avy-goto-word-1</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> vertico &amp; marginalia &amp; orderless &amp; mini-frame
</span>
<span class="comment-delimiter">;; </span><span class="comment">A nice, fast minibuffer narrowing framework. It works well with quite a lot of package.
</span><span class="comment-delimiter">;; </span><span class="comment">- =marginalia.el= brings annotations to completing-read, ie. it adds current keybinding of a command, summary of command to M-x.
</span><span class="comment-delimiter">;; </span><span class="comment">- =miniframe.el= shows all completing-read prompts in a nice mini popup frame.
</span><span class="comment-delimiter">;; </span><span class="comment">- Also see [[embark]].
</span>
<span class="comment-delimiter">;; </span><span class="comment">Keybindings:
</span><span class="comment-delimiter">;; </span><span class="comment">- =SPC 0= to repeat/open last vertico window you closed.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some shortcuts you can use on any vertico window:
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-{n,p}= goes {back,forward} in minibuffer history.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-{[,]}= goes {previous,next} group.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-m= cycles the marginalia detail level.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-a= brings up embark-act menu. See [[embark]].
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-A= embark act all.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-w= copy the current candidate intelligently (im-vertico-save).
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-q= avy-like select and act.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-q= avy-like select and act.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-r= separaedit
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-d= insert directory (consult-dir)
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-g= vertico multigrid
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-c= vertico-select (and act with M-A on selected)
</span><span class="comment-delimiter">;; </span><span class="comment">- =TAB= inserts the current candidate (into minibuffer).
</span><span class="comment-delimiter">;; </span><span class="comment">- Do &amp;&lt;search_term&gt; to search inside annotations (orderless feature). This is a bit slow.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vertico</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>after-init . vertico-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Grow and shrink the Vertico minibuffer
</span>  <span class="comment-delimiter">;; </span><span class="comment">(setq vertico-resize t)
</span>
  <span class="comment-delimiter">;; </span><span class="comment">Show more candidates
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> vertico-count 15<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Enable cycling for `</span><span class="constant">vertico-next</span><span class="comment">' and `</span><span class="constant">vertico-previous</span><span class="comment">'.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> vertico-cycle t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Hide commands in M-x which do not work in the current mode.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> read-extended-command-predicate <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">command-completion-default-include-p</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Add prompt indicator to `</span><span class="constant">completing-read-multiple</span><span class="comment">'.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defun</span> <span class="function-name">crm-indicator</span> <span class="rainbow-delimiters-depth-3-face">(</span>args<span class="rainbow-delimiters-depth-3-face">)
    (</span>cons <span class="rainbow-delimiters-depth-4-face">(</span>concat <span class="string">&quot;[CRM] &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>car args<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">) (</span>cdr args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>advice-add <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">completing-read-multiple</span> <span class="builtin">:filter-args</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">crm-indicator</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Do not allow the cursor in the minibuffer prompt
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> minibuffer-prompt-properties <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>read-only t cursor-intangible t face minibuffer-prompt<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-setup-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cursor-intangible-mode</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Enable recursive minibuffers
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> enable-recursive-minibuffers t<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Bindings
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-w&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-save</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-[&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-previous-group</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-]&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-next-group</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-j&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">next-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-k&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">previous-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-d&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-scroll-up</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-b&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-scroll-down</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key minibuffer-mode-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;C-w&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-map</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Use `</span><span class="constant">consult-completion-in-region</span><span class="comment">' which works with vertico
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> completion-in-region-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-completion-in-region</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-vertico-save</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Same as `</span><span class="constant">vertico-save</span><span class="doc">' but removes bogus char and closes minibuffer.
Also see: https://isamert.net/2021/03/27/killing-copying-currently-selected-candidates-content-text-in-selectrum.html&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>candidate <span class="rainbow-delimiters-depth-5-face">(</span>vertico--candidate<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>prompt <span class="rainbow-delimiters-depth-5-face">(</span>minibuffer-prompt<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>kill-new
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">cond</span>
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>s-contains? <span class="string">&quot;grep&quot;</span> prompt<span class="rainbow-delimiters-depth-6-face">) (</span>s-join <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>-drop 2 <span class="rainbow-delimiters-depth-8-face">(</span>s-split <span class="string">&quot;:&quot;</span> candidate<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="comment-delimiter">;; </span><span class="comment">^ Strip `filename:line-number:` from the text
</span>      <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>s-matches? <span class="string">&quot;.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">Go to line</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Switch to</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">.*&quot;</span> prompt<span class="rainbow-delimiters-depth-6-face">) (</span>s-chop-right 1 candidate<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="comment-delimiter">;; </span><span class="comment">^ `</span><span class="constant">consult-line</span><span class="comment">' and `</span><span class="constant">consult-buffer</span><span class="comment">' has an unrecognizable char at
</span>      <span class="comment-delimiter">;; </span><span class="comment">the end of every candidate, so I just strip them here
</span>      <span class="rainbow-delimiters-depth-5-face">(</span>t candidate<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>keyboard-escape-quit<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> vertico extensions
</span>
<span class="comment-delimiter">;; </span><span class="comment">Load vertico extensions
</span><span class="rainbow-delimiters-depth-1-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">load-path</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;%sstraight/build/vertico/extensions&quot;</span> straight-base-dir<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Enable avy style candidate selection
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vertico-quick</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> vertico
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> vertico-quick1 <span class="string">&quot;asdfgqwe&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> vertico-quick2 <span class="string">&quot;hjklui&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key vertico-map <span class="string">&quot;\M-q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-quick-exit</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">vertico-repeat</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> vertico
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-setup-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-repeat-save</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span> <span class="string">&quot;0&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-repeat</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Enable showing vertico in a buffer instead of minibuffer
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vertico-buffer</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> vertico<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Switch between different vertico display forms for different commands
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vertico-multiform</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> vertico
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Toggle grid mode by hitting M-g while in vertico
</span>  <span class="comment-delimiter">;; </span><span class="comment">Toggling grid mode does not work well with mini-frame.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key vertico-map <span class="string">&quot;\M-g&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vertico-multiform-grid</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">'(command display-type... (buffer-local-variable . value))
</span>  <span class="comment-delimiter">;; </span><span class="comment">vertico README explains this very well
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> vertico-multiform-commands
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>consult-org-heading
           buffer
           <span class="rainbow-delimiters-depth-5-face">(</span>vertico-buffer-display-action . <span class="rainbow-delimiters-depth-6-face">(</span>display-buffer-in-side-window
                                             <span class="rainbow-delimiters-depth-7-face">(</span>side . right<span class="rainbow-delimiters-depth-7-face">)
                                             (</span>window-width . 0.4<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
          (</span>consult-imenu
           buffer
           <span class="rainbow-delimiters-depth-5-face">(</span>vertico-buffer-display-action . <span class="rainbow-delimiters-depth-6-face">(</span>display-buffer-in-side-window
                                             <span class="rainbow-delimiters-depth-7-face">(</span>side . right<span class="rainbow-delimiters-depth-7-face">)
                                             (</span>window-width . 0.4<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>vertico-multiform-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Enable displaying candidates in a grid.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vertico-grid</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> vertico<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Other complementary packages:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">orderless</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">See the following: https://github.com/minad/vertico?tab=readme-ov-file#tramp-hostname-and-username-completion
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> completion-styles <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>orderless partial-completion basic<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> completion-category-defaults nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> completion-category-overrides <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>file <span class="rainbow-delimiters-depth-5-face">(</span>styles basic partial-completion<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">marginalia</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>define-key minibuffer-local-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-m&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">marginalia-cycle</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> marginalia-censor-variables <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;pass</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">auth-source-netrc-cache</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">auth-source-.*-nonce</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">token</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">key</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">password</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">cookie</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">phone-number</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">app-id</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">feed-link&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>marginalia-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">mini-frame</span>
  <span class="comment-delimiter">;; </span><span class="comment">Disabled for now.
</span>  <span class="comment-delimiter">;; </span><span class="comment">:hook (after-init . mini-frame-mode)
</span>  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> mini-frame-show-parameters
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>top . 0.15<span class="rainbow-delimiters-depth-4-face">)
          (</span>width . 0.70<span class="rainbow-delimiters-depth-4-face">)
          (</span>left . 0.5<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> mini-frame-color-shift-step 15<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Disable mini-frame while using some functions either that does
</span>  <span class="comment-delimiter">;; </span><span class="comment">not work well with mini-frame or it doesn't make sense to use it
</span>  <span class="comment-delimiter">;; </span><span class="comment">with mini-frame
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> mini-frame-ignore-commands
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>completion-at-point
          evil-ex
          ctrlf-forward-default
          tab-jump-out
          consult-line
          consult-ripgrep
          consult-bookmark
          jq-interactively
          im-consult-ripgrep
          consult-org-heading
          consult-imenu<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> ~project.el~ and project management
</span>
<span class="comment-delimiter">;; </span><span class="comment">~(project-remember-projects-under im-projects-root t)~ does not
</span><span class="comment-delimiter">;; </span><span class="comment">work as I expect, so I add all of my projects using a custom
</span><span class="comment-delimiter">;; </span><span class="comment">function that returns all of my projects' paths.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">project</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>project--find-in-directory<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defconst</span> <span class="variable-name">im-projects-root</span> <span class="string">&quot;~/Workspace/projects&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-current-project-root</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return the root path of current project.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">ignore-errors</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-4-face">(</span>project-root <span class="rainbow-delimiters-depth-5-face">(</span>project-current<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">(when-let (path (locate-dominating-file default-directory &quot;.git&quot;))
</span><span class="comment-delimiter">;;   </span><span class="comment">(expand-file-name path)))
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-project-name-transformers</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;List of functions to do transformations on the function name.
Like shortening it in some form etc.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-current-project-name</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return current projects name.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>seq-reduce
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>acc it<span class="rainbow-delimiters-depth-4-face">) (</span>funcall it acc<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   im-project-name-transformers
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>curr-proj <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
            (</span>projects-root <span class="rainbow-delimiters-depth-6-face">(</span>expand-file-name im-projects-root<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>string-prefix-p projects-root curr-proj<span class="rainbow-delimiters-depth-5-face">)
           (</span>string-trim <span class="rainbow-delimiters-depth-6-face">(</span>string-remove-prefix projects-root curr-proj<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;/&quot; &quot;/&quot;</span><span class="rainbow-delimiters-depth-5-face">)
         (</span>file-name-nondirectory <span class="rainbow-delimiters-depth-6-face">(</span>directory-file-name curr-proj<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>file-name-nondirectory <span class="rainbow-delimiters-depth-5-face">(</span>directory-file-name default-directory<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-is-git-dir</span> <span class="rainbow-delimiters-depth-2-face">(</span>dir<span class="rainbow-delimiters-depth-2-face">)
  (</span>file-directory-p <span class="rainbow-delimiters-depth-3-face">(</span>concat dir <span class="string">&quot;/.git&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-all-project-roots</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Find every project dir under `</span><span class="constant">im-projects-root</span><span class="doc">'.
It simply checks for folders with `</span><span class="constant">.git</span><span class="doc">' under them.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name im-projects-root<span class="rainbow-delimiters-depth-3-face">)
   (</span>format <span class="string">&quot;fd . '</span><span class="constant">%s</span><span class="string">' --type directory --maxdepth 6 --absolute-path&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>shell-command-to-string<span class="rainbow-delimiters-depth-3-face">)
   (</span>s-trim<span class="rainbow-delimiters-depth-3-face">)
   (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-is-git-dir it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>abbreviate-file-name <span class="rainbow-delimiters-depth-5-face">(</span>f-full it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-import-projects</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-load-projects-list</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-load-projects-list</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>make-thread
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>message <span class="string">&quot;Loading projects....&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Ensure all projects are known by project.el
</span>     <span class="comment-delimiter">;; </span><span class="comment">The following does not recurse as I like it to be
</span>     <span class="comment-delimiter">;; </span><span class="comment">(project-remember-projects-under im-projects-root t)
</span>     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> project--list <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--each</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>project--find-in-directory it<span class="rainbow-delimiters-depth-6-face">) (</span>im-all-project-roots<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>project-remember-project it t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>message <span class="string">&quot;Loading projects...Done.&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-init-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-load-projects-list</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">project.el offers ~C-x p~ keymap with very useful bindings. I also
</span><span class="comment-delimiter">;; </span><span class="comment">keep my project related bindings under ~SPC p~.
</span>
<span class="comment-delimiter">;; </span><span class="comment">After doing ~project-switch-project~, you are expected to hit a key
</span><span class="comment-delimiter">;; </span><span class="comment">to trigger a project action, like finding a file in the project or
</span><span class="comment-delimiter">;; </span><span class="comment">doing a project grep. You need to add these actions into
</span><span class="comment-delimiter">;; </span><span class="comment">~project-switch-commands~ list and you need to define a key in
</span><span class="comment-delimiter">;; </span><span class="comment">~project-prefix-map~ (that is ~C-x p~) to make it triggerable by
</span><span class="comment-delimiter">;; </span><span class="comment">given key.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;p&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span>
                <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-4-face">(</span>root <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                    (</span>project-switch-project root<span class="rainbow-delimiters-depth-4-face">)
                  (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">project-switch-project</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defmacro</span> <span class="function-name">im-projectelify</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> cmd desc key non-interactive dont-wrap dir-as-param<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;If you add a command to `</span><span class="constant">project-switch-commands</span><span class="doc">', it will not
work properly everytime becuse the function should be aware of
what the current project is, provided by the `</span><span class="constant">project-current</span><span class="doc">'
function. This function simply wraps the original CMD to make it
work in the `</span><span class="constant">project-current</span><span class="doc">'s directory.

If CMD is already project.el aware, then pass DONT-WRAP as
non-nil so that you only add it to `</span><span class="constant">project-prefix-map</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fn <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> dont-wrap
                <span class="rainbow-delimiters-depth-6-face">(</span>symbol-name cmd<span class="rainbow-delimiters-depth-6-face">)
              (</span>concat <span class="rainbow-delimiters-depth-7-face">(</span>symbol-name cmd<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;-projectel&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">unless</span> ,dont-wrap
         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">defun</span> ,<span class="rainbow-delimiters-depth-6-face">(</span>intern fn<span class="rainbow-delimiters-depth-6-face">) ()
           (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>default-directory <span class="rainbow-delimiters-depth-9-face">(</span>project-root <span class="rainbow-delimiters-depth-1-face">(</span>project-current t<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">cond</span>
              <span class="rainbow-delimiters-depth-8-face">(</span>,non-interactive <span class="rainbow-delimiters-depth-9-face">(</span>funcall <span class="highlight-quoted-quote">#'</span>,cmd<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>,dir-as-param <span class="rainbow-delimiters-depth-9-face">(</span>funcall <span class="highlight-quoted-quote">#'</span>,cmd default-directory<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>t <span class="rainbow-delimiters-depth-9-face">(</span>call-interactively <span class="highlight-quoted-quote">#'</span>,cmd<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">when</span> ,desc
         <span class="rainbow-delimiters-depth-5-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">project-switch-commands</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span>,<span class="rainbow-delimiters-depth-7-face">(</span>intern fn<span class="rainbow-delimiters-depth-7-face">)</span> ,desc<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">when</span> ,key
         <span class="rainbow-delimiters-depth-5-face">(</span>define-key project-prefix-map ,<span class="rainbow-delimiters-depth-6-face">(</span>kbd key<span class="rainbow-delimiters-depth-6-face">)</span> <span class="highlight-quoted-quote">#'</span>,<span class="rainbow-delimiters-depth-6-face">(</span>intern fn<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> project-switch-commands <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-shell-for <span class="builtin">:desc</span> <span class="string">&quot;Eshell&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;e&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> project-query-replace-regexp <span class="builtin">:desc</span> <span class="string">&quot;Replace in project (regexp)&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;r&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> project-kill-buffers <span class="builtin">:desc</span> <span class="string">&quot;Kill buffers&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;k&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-term <span class="builtin">:desc</span> <span class="string">&quot;terminal&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;t&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-shell-command <span class="builtin">:desc</span> <span class="string">&quot;Run shell command&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;!&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-find-file-in <span class="builtin">:desc</span> <span class="string">&quot;Files&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;f&quot;</span> <span class="builtin">:non-interactive</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> dired <span class="builtin">:desc</span> <span class="string">&quot;Dired&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;RET&quot;</span> <span class="builtin">:dir-as-param</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> magit-status <span class="builtin">:desc</span> <span class="string">&quot;Magit&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;m&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> consult-ripgrep <span class="builtin">:desc</span> <span class="string">&quot;Grep&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;g&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> lab-list-project-merge-requests <span class="builtin">:desc</span> <span class="string">&quot;Merge requests&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;M&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> lab-list-project-pipelines <span class="builtin">:desc</span> <span class="string">&quot;Pipelines&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> lab-act-on-last-failed-pipeline-job <span class="builtin">:desc</span> <span class="string">&quot;Last failed pipeline job&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;K&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> project-switch-project <span class="builtin">:desc</span> <span class="string">&quot;Switch&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;s&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> project-vc-dir <span class="builtin">:desc</span> <span class="string">&quot;VC dir&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;v&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-select-any-project-file <span class="builtin">:desc</span> <span class="string">&quot;Files (all projects)&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;F&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-consult-ripgrep-all-projects <span class="builtin">:desc</span> <span class="string">&quot;Grep (all projects)&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;G&quot;</span> <span class="builtin">:dont-wrap</span> t<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> git-link-homepage <span class="builtin">:desc</span> <span class="string">&quot;Link (homepage)&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;H&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-projectelify</span> <span class="builtin">:cmd</span> im-git-link-homepage <span class="builtin">:desc</span> <span class="string">&quot;Link (copy)&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;l&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">All-projects commands
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-select-any-project-file</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-find-file-in im-projects-root<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-consult-ripgrep-all-projects</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-consult-ripgrep im-projects-root<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Others
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-project-shell-last-height</span> 20<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-project-shell-last-window</span> nil<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-shell-for</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> type placement shell-fn shell-name<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> shell-fn
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">setq</span> shell-fn
          <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>name<span class="rainbow-delimiters-depth-5-face">)
            (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">eshell</span><span class="rainbow-delimiters-depth-5-face">)
            (</span><span class="keyword">save-window-excursion</span>
              <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>eshell-buffer-name name<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                (</span>eshell t<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> type <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">project</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>proj-dir <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">ignore-errors</span>
                         <span class="rainbow-delimiters-depth-7-face">(</span>project-root <span class="rainbow-delimiters-depth-8-face">(</span>project-current<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                       default-directory<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">cl-case</span> type
                              <span class="rainbow-delimiters-depth-6-face">(</span>project proj-dir<span class="rainbow-delimiters-depth-6-face">)
                              (</span>dir default-directory<span class="rainbow-delimiters-depth-6-face">)
                              (</span>t <span class="rainbow-delimiters-depth-7-face">(</span>expand-file-name type<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>proj-name <span class="rainbow-delimiters-depth-5-face">(</span>f-base default-directory<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>name <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;*$%s: %s*&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> shell-name <span class="string">&quot;shell&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span> proj-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if-let*</span> <span class="rainbow-delimiters-depth-4-face">(</span>placement
              <span class="rainbow-delimiters-depth-5-face">(</span>window <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-prefix? <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;</span><span class="warning">\</span><span class="string">*</span><span class="warning">\</span><span class="string">$%s: &quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> shell-name <span class="string">&quot;shell&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">) (</span>buffer-name <span class="rainbow-delimiters-depth-9-face">(</span>window-buffer it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">) (</span>window-list<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
              (</span>focused? <span class="rainbow-delimiters-depth-6-face">(</span>equal window <span class="rainbow-delimiters-depth-7-face">(</span>selected-window<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">progn</span>
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span>top bottom<span class="rainbow-delimiters-depth-7-face">)</span> placement<span class="rainbow-delimiters-depth-6-face">)
            (</span><span class="keyword">setq</span> im-project-shell-last-height <span class="rainbow-delimiters-depth-7-face">(</span>window-height window<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>delete-window window<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">when</span> im-project-shell-last-window
            <span class="rainbow-delimiters-depth-6-face">(</span>select-window im-project-shell-last-window<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>term <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span>get-buffer name<span class="rainbow-delimiters-depth-8-face">)
                       (</span>funcall shell-fn name<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">with-current-buffer</span> term
          <span class="rainbow-delimiters-depth-6-face">(</span>tab-line-mode -1<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> im-project-shell-last-window <span class="rainbow-delimiters-depth-6-face">(</span>get-buffer-window<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>not placement<span class="rainbow-delimiters-depth-6-face">)
            (</span>switch-to-buffer term<span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">progn</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>display-buffer-in-side-window
             term
             <span class="rainbow-delimiters-depth-8-face">(</span>append
              <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>window-height . ,im-project-shell-last-height<span class="rainbow-delimiters-depth-1-face">)
                (</span>side . ,placement<span class="rainbow-delimiters-depth-1-face">)
                (</span>slot . 1<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>select-window <span class="rainbow-delimiters-depth-8-face">(</span>get-buffer-window term<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-term</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Select a term and open.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">empv--select-action</span> <span class="string">&quot;Term: &quot;
    &quot;eshell project&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">project</span> nil nil <span class="string">&quot;eshell&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;eshell dir&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dir</span> nil nil <span class="string">&quot;eshell&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;eshell new&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;vterm project&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">project</span> nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-vterm</span> <span class="string">&quot;vterm&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;vterm dir&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dir</span> nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-vterm</span> <span class="string">&quot;vterm&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;vterm new&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-vterm</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;eat project&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">project</span> nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-eat</span> <span class="string">&quot;eat&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;eat dir&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dir</span> nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-eat</span> <span class="string">&quot;eat&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="string">&quot;eat new&quot;</span> → <span class="rainbow-delimiters-depth-3-face">(</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eat</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im--suggest-shell-name</span> <span class="rainbow-delimiters-depth-2-face">(</span>type<span class="rainbow-delimiters-depth-2-face">)
  (</span>format <span class="string">&quot;$%s: %s/%s&quot;</span> type <span class="rainbow-delimiters-depth-3-face">(</span>im-current-project-name<span class="rainbow-delimiters-depth-3-face">)
          (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>buffer-file-name <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
              (</span>buffer-name<span class="rainbow-delimiters-depth-4-face">)
            (</span>symbol-name major-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eat</span> <span class="rainbow-delimiters-depth-2-face">(</span>name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-eshell</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Buffer name: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>im--suggest-shell-name <span class="string">&quot;eat&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">eat</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>eat-buffer-name name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>eat nil t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-vterm</span> <span class="rainbow-delimiters-depth-2-face">(</span>name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-eshell</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Buffer name: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;$vterm: %s/%s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-name<span class="rainbow-delimiters-depth-6-face">) (</span>buffer-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">vterm</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>vterm-buffer-name name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>vterm t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eshell</span> <span class="rainbow-delimiters-depth-2-face">(</span>name<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Buffer name: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>generate-new-buffer-name <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;*$eshell: %s*&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>im-current-project-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>eshell t<span class="rainbow-delimiters-depth-3-face">)
    (</span>rename-buffer name t<span class="rainbow-delimiters-depth-3-face">)
    (</span>current-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im--new-eat</span> <span class="rainbow-delimiters-depth-2-face">(</span>name<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">eat</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-window-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>eat-buffer-name name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>eat nil t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im--new-vterm</span> <span class="rainbow-delimiters-depth-2-face">(</span>name<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">vterm</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-window-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>vterm-buffer-name name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>vterm t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-terminal-vertically</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>select-window <span class="rainbow-delimiters-depth-3-face">(</span>split-window-vertically<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-terminal-horizontally</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>select-window <span class="rainbow-delimiters-depth-3-face">(</span>split-window-horizontally<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-eshell</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="string">&quot;M-_&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-terminal-vertically</span>
  <span class="string">&quot;M-|&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-terminal-horizontally</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span> <span class="string">&quot;2&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-term</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">bind-key</span> <span class="string">&quot;M-`&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">project</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bottom</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-eat</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">bind-key</span> <span class="string">&quot;&lt;f2&gt;&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="string">&quot;~&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">top</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-eat</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">bind-key</span> <span class="string">&quot;&lt;f3&gt;&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-shell-for <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dir</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bottom</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im--new-eat</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> consult
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some key points:
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =SPC RET= brings up =consult-buffer=.
</span><span class="comment-delimiter">;; </span><span class="comment">- Typing =SPC {p,f,b,m}= narrows the list into {project files, files, buffers, bookmarks}.
</span><span class="comment-delimiter">;; </span><span class="comment">- Also see: [[id:90769b1b-7baf-4285-80f9-153ae07d73ab][frequently used files]]
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-y= brings up =consult-yank=, where you can select from clipboard history and paste.
</span><span class="comment-delimiter">;; </span><span class="comment">- =C-f= does fuzzy search on current file lines.
</span><span class="comment-delimiter">;; </span><span class="comment">- Do =M-,= on a candidate to preview it.
</span><span class="comment-delimiter">;; </span><span class="comment">- Also don't forget to utilize =M-a= (=embark-act=) in consult windows.
</span><span class="comment-delimiter">;; </span><span class="comment">- Use =M-n= (future-history) to insert current symbol after running a consult command. Normally you would use =M-{p,n}= to cycle between history items but when you open minibuffer, typing =M-n= directly tries to guess what the user input would be.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">consult</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;fo&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">find-file</span>
    <span class="string">&quot;fb&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">switch-to-buffer</span>
    <span class="string">&quot;fs&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">save-buffer</span>
    <span class="string">&quot;fd&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-dir</span>
    <span class="string">&quot;fl&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-line</span>
    <span class="comment-delimiter">;; </span><span class="comment">Normally searches within project buffers, with prefix arg
</span>    <span class="comment-delimiter">;; </span><span class="comment">searches within all buffers.
</span>    <span class="string">&quot;fL&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-line-multi</span>
    <span class="string">&quot;cr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-history</span>
    <span class="string">&quot;RET&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-buffer</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-mode-map</span>
   <span class="string">&quot;C-r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-history</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-map</span>
   <span class="string">&quot;M-i&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-org-heading</span>
   <span class="string">&quot;M-I&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-org-agenda</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-mode-map</span>
   <span class="string">&quot;C-r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-history</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;M-i&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">condition-case</span> nil
                            <span class="rainbow-delimiters-depth-5-face">(</span>consult-imenu<span class="rainbow-delimiters-depth-5-face">)
                          (</span><span class="warning">error</span> <span class="rainbow-delimiters-depth-6-face">(</span>consult-outline<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-narrow-map</span>
   <span class="comment-delimiter">;; </span><span class="comment">Shows all narrowing possibilities when you hit &quot;?&quot;
</span>   <span class="comment-delimiter">;; </span><span class="comment">If no narrowing is available, simply inserts &quot;?&quot;
</span>   <span class="string">&quot;?&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-narrow-help</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-consult-setup<span class="rainbow-delimiters-depth-2-face">)

  (</span>global-set-key <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;f13&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-buffer</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>advice-add <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">register-preview</span> <span class="builtin">:override</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-register-window</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> consult-preview-key <span class="string">&quot;M-,&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ When you do M-, on a candidate, it previews it
</span>
  <span class="comment-delimiter">;; </span><span class="comment">xref consult integration
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> xref-show-xrefs-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-xref</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> xref-show-definitions-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-xref</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Hide some buffers from consult-buffer window. If you want to jump
</span>  <span class="comment-delimiter">;; </span><span class="comment">on one of these buffers, start with a space after opening
</span>  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">consult-buffer</span><span class="comment">'.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-buffer-filter</span>
   <span class="string">&quot;\\`\\*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">Help</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Backtrace</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Messages</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Buffer List</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Flycheck.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">scratch.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">This also supports previews. Use the `</span><span class="constant">consult-preview-key</span><span class="comment">'.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-switch-theme</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-theme</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Project &amp; file management
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some functionality for project management. I do some fine-tuning for =find= and =ripgrep= commands that consult uses.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> consult-find-command <span class="string">&quot;fd  --hidden --full-path ARG OPTS&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> consult-ripgrep-command <span class="string">&quot;rg  --hidden --null --line-buffered --color=always --max-columns=500 --no-heading --smart-case --line-number . -e ARG OPTS&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> consult-project-root-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-current-project-root</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;cf&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-find-file-in</span>
  <span class="string">&quot;cG&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-consult-ripgrep-in-given-directory</span>
  <span class="string">&quot;cg&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-consult-ripgrep-current-directory</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-consult-ripgrep</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;`</span><span class="constant">consult-ripgrep</span><span class="doc">' in PATH (or in current project, if path is nil).
`</span><span class="constant">consult-ripgrep</span><span class="doc">' with `</span><span class="constant">consult-project-root-function</span><span class="doc">' shows full
path of the file in the results.  I don't want that.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-ripgrep <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> path <span class="rainbow-delimiters-depth-4-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-consult-ripgrep-current-directory</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Do ripgrep in `</span><span class="constant">default-directory</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-ripgrep default-directory<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-consult-ripgrep-in-given-directory</span> <span class="rainbow-delimiters-depth-2-face">(</span>dir<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;DSelect directory: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-ripgrep dir<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-find-file-in</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> dir<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find file in DIR.
`</span><span class="constant">fd</span><span class="doc">' is already fast enough, no need for `</span><span class="constant">consult-find</span><span class="doc">'s async
approach.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;DFind files in: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> dir default-directory<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">im-output-select</span>
     <span class="builtin">:cmd</span> <span class="string">&quot;fd --exclude '</span><span class="constant">.git</span><span class="string">' --exclude '</span><span class="constant">node_modules</span><span class="string">' --hidden .&quot;</span>
     <span class="builtin">:prompt</span> <span class="string">&quot;Open file: &quot;</span>
     <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file</span>
     <span class="builtin">:map</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-chop-prefix <span class="string">&quot;./&quot;</span> it<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-4-face">(</span>find-file it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-consult-git-grep-branch</span> <span class="rainbow-delimiters-depth-2-face">(</span>branch<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run interactive grep inside given BRANCH and display the result at that revision.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-output-select</span>
          <span class="builtin">:cmd</span> <span class="string">&quot;git branch -a --format='%(refname:lstrip=2)'&quot;</span>
          <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;Select branch (current=%s): &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>lab-git-current-branch<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
          <span class="builtin">:keep-order</span> t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">pcase-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span>result <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-window-excursion</span>
                         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">prog1</span> <span class="rainbow-delimiters-depth-7-face">(</span>consult-git-grep <span class="rainbow-delimiters-depth-8-face">(</span>list branch<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                           (</span>kill-buffer <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">im-tap</span> <span class="rainbow-delimiters-depth-9-face">(</span>current-buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span><span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span>,fname ,line-no<span class="rainbow-delimiters-depth-5-face">) (</span>s-split-up-to <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-chop-prefix <span class="rainbow-delimiters-depth-7-face">(</span>concat branch <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> result<span class="rainbow-delimiters-depth-6-face">)</span> 2<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer-create <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;*%s at %s*&quot;</span> fname branch<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)
      (</span>insert
       <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string
        <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;git show %s:%s&quot;</span> branch fname<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-line <span class="rainbow-delimiters-depth-5-face">(</span>1- <span class="rainbow-delimiters-depth-6-face">(</span>string-to-number line-no<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">delay-mode-hooks</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>funcall <span class="rainbow-delimiters-depth-6-face">(</span>assoc-default fname auto-mode-alist <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">string-match</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>font-lock-fontify-buffer<span class="rainbow-delimiters-depth-4-face">)
      (</span>switch-to-buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>recenter<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> consult-buffer and some extensions
</span>
<span class="comment-delimiter">;; </span><span class="comment">I use =(consult-buffer)= function for switching between
</span><span class="comment-delimiter">;; </span><span class="comment">buffers/files/marks etc. Here I add a source for my frequently used
</span><span class="comment-delimiter">;; </span><span class="comment">files. This is handy in a way that =(consult-buffer)= becomes my
</span><span class="comment-delimiter">;; </span><span class="comment">go-to place for switching to anything.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-consult-source-files</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>list
   <span class="builtin">:name</span>     <span class="string">&quot;My files&quot;</span>
   <span class="builtin">:narrow</span>   ?f
   <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file</span>
   <span class="builtin">:face</span>     <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-file</span>
   <span class="builtin">:history</span>  <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file-name-history</span>
   <span class="builtin">:state</span>    <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult--file-state</span>
   <span class="builtin">:default</span>  t
   <span class="builtin">:hidden</span>   nil
   <span class="builtin">:items</span>    <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-my-files</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;My frequently accessed files source for `</span><span class="constant">consult-buffer</span><span class="doc">'.&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">https://github.com/minad/consult/issues/206#issuecomment-886380330
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-consult-source-dired-buffers</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:name</span>     <span class="string">&quot;Dired&quot;</span>
    <span class="builtin">:narrow</span>   ?d
    <span class="builtin">:hidden</span>   t
    <span class="builtin">:category</span> buffer
    <span class="builtin">:face</span>     dired-header
    <span class="builtin">:state</span>    ,<span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult--buffer-state</span>
    <span class="builtin">:items</span>
    ,<span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
       (</span>consult--buffer-query <span class="builtin">:mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-mode</span>
                              <span class="builtin">:sort</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">visibility</span>
                              <span class="builtin">:as</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">buffer-name</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Dired buffer candidate source for `</span><span class="constant">consult-buffer</span><span class="doc">'.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-append!</span> consult-buffer-sources <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-consult-source-dired-buffers</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-my-files</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return list of all files I frequently use.&quot;</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span>,@<span class="rainbow-delimiters-depth-3-face">(</span>directory-files im-scratch-project-path t<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Org may be loaded lazily
</span>    ,@<span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">bound-and-true-p</span> org-directory<span class="rainbow-delimiters-depth-4-face">)
        (</span>directory-files org-directory t <span class="string">&quot;^\\w+.*.org$&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    ,@<span class="rainbow-delimiters-depth-3-face">(</span>directory-files im-load-path t <span class="string">&quot;\\.el$&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
    ,@<span class="rainbow-delimiters-depth-3-face">(</span>directory-files im-packages-path t <span class="string">&quot;\\.el$&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-append!</span> consult-buffer-sources <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-consult-source-files</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Move bookmarks to the top of buffer sources
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>delq <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult--source-bookmark</span> consult-buffer-sources<span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-buffer-sources</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult--source-bookmark</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">I also add a source for listing all of my projects:
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-consult-source-projects</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>list
   <span class="builtin">:name</span>     <span class="string">&quot;Projects&quot;</span>
   <span class="builtin">:narrow</span>   ?a
   <span class="builtin">:hidden</span>   nil
   <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file</span>
   <span class="builtin">:action</span>  <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>it <span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">) (</span>project-switch-project it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:items</span>   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span> project--list<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Projects source for `</span><span class="constant">consult-buffer</span><span class="doc">'.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-append!</span> consult-buffer-sources <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-consult-source-projects</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> consult-dir: Jump to different places easily in minibuffer
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here is a nice description of the package from it's README:
</span>
<span class="comment-delimiter">;; </span><span class="comment">&gt; Avoid &quot;navigating&quot; long distances when picking a file or
</span><span class="comment-delimiter">;; </span><span class="comment">&gt; directory in any Emacs command that requires one. Think of it
</span><span class="comment-delimiter">;; </span><span class="comment">&gt; like the shell tools autojump, fasd or z but for Emacs.
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">consult-dir--my-dirs</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>list
   <span class="builtin">:name</span> <span class="string">&quot;My favorites&quot;</span>
   <span class="builtin">:narrow</span> ?m
   <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">file</span>
   <span class="builtin">:face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-file</span>
   <span class="builtin">:items</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()</span>
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;~/Downloads/&quot;
       &quot;~/Documents/&quot;
       &quot;~/Pictures/f3/Camera/&quot;
       &quot;~/Music/&quot;
       &quot;~/Music/mix/&quot;
       &quot;~/Videos/Shows/&quot;
       &quot;~/Videos/Movies/&quot;
       &quot;~/Documents/notes/&quot;
       &quot;~/Documents/notes/img/&quot;
       &quot;~/Workspace/projects/&quot;
       &quot;~/Workspace/temp/&quot;
       &quot;~/Workspace/temp/git/&quot;
       &quot;~/.emacs.d/&quot;
       &quot;~/.local/share/&quot;
       &quot;~/.local/bin/&quot;
       &quot;~/.config/&quot;</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;/run/media/%s/&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>user-login-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;/run/media/%s/BINGUS/&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>user-login-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">consult-dir</span>
  <span class="builtin">:defer
  :bind</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;C-x C-d&quot;</span> . consult-dir<span class="rainbow-delimiters-depth-3-face">)</span>
         <span class="builtin">:map</span> vertico-map
         <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;M-d&quot;</span> . consult-dir<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>consult-dir-sources <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>consult-dir--my-dirs
                         consult-dir--source-bookmark
                         consult-dir--source-recentf
                         consult-dir--source-tramp-local
                         consult-dir--source-default
                         consult-dir--source-project<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> embark
</span>
<span class="comment-delimiter">;; </span><span class="comment">=embark.el= provides contextual command maps.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =M-a= activates command mode. Next key should be command. Do =C-h= to list all commands with their keybindings.
</span><span class="comment-delimiter">;; </span><span class="comment">- Commands are context specific, ie. the commands is based on if currently selected item is a file, folder, buffer etc.
</span><span class="comment-delimiter">;; </span><span class="comment">- It's mostly used within the minibuffer, some example functions:
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-a w= (~embark-save~) saves the current candidate's text into kill-ring.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-a i= (~embark-insert~) like the one above but instead of saving to the kill-ring, it directly inserts it to the buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">- =M-a S= (~embark-collect-snapshot~) creates a buffer containing all the candidates.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- To apply an action to multiple items, filter the items first and then do =embark-collect-snapshot=. A buffer will open and you can apply the main action or other actions on the items.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">embark-consult</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">embark</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>embark embark-act-all<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">bind-key</span> <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">embark-act</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">bind-key</span> <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-A&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">embark-act-all</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">bind-key</span> <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-c&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">embark-select</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> embark-prompter <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">embark-completing-read-prompter</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ This directly shows the actions in a completing read window.
</span>  <span class="comment-delimiter">;; </span><span class="comment">By default, it is set to `</span><span class="constant">embark-keymap-prompter</span><span class="comment">' and you need to
</span>  <span class="comment-delimiter">;; </span><span class="comment">hit `</span><span class="constant">C-h</span><span class="comment">' to bring this menu up.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> embark-indicators <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>embark-highlight-indicator embark-isearch-highlight-indicator<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ I removed embark-mixed-indicator from the list because I'm
</span>  <span class="comment-delimiter">;; </span><span class="comment">using embark-completing-read-prompter by default which already
</span>  <span class="comment-delimiter">;; </span><span class="comment">provides same functionality
</span>
  <span class="comment-delimiter">;; </span><span class="comment">Hitting C-h after any prefix command will open a completing-read
</span>  <span class="comment-delimiter">;; </span><span class="comment">interface to select a command that prefix has. Complements
</span>  <span class="comment-delimiter">;; </span><span class="comment">which-key.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> prefix-help-command <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">embark-prefix-help-command</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> embark-quit-after-action <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>kill-buffer . nil<span class="rainbow-delimiters-depth-4-face">)
                                   (</span>t . t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Replace describe-symbol with helpful-symbol
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key embark-symbol-map <span class="string">&quot;h&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">helpful-symbol</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> sudo-file-edit action
</span>
<span class="comment-delimiter">;; </span><span class="comment">Nice little embark action that let's you open files with sudo.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Source: https://karthinks.com/software/fifteen-ways-to-use-embark/
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-sudo-find-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>file<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Open FILE as root.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;FOpen file as root: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>file-writable-p file<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="warning">user-error</span> <span class="string">&quot;File is user writeable, aborting sudo&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>find-file <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>file-remote-p file<span class="rainbow-delimiters-depth-4-face">)
                 (</span>concat <span class="string">&quot;/&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>file-remote-p file <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">method</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;:&quot;</span>
                         <span class="rainbow-delimiters-depth-5-face">(</span>file-remote-p file <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">user</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;@&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>file-remote-p file <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">host</span><span class="rainbow-delimiters-depth-5-face">)</span>
                         <span class="string">&quot;|sudo:root@&quot;</span>
                         <span class="rainbow-delimiters-depth-5-face">(</span>file-remote-p file <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">host</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;:&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>file-remote-p file <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">localname</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span>concat <span class="string">&quot;/sudo:root@localhost:&quot;</span> file<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>define-key embark-file-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;#&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-sudo-find-file</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> search actions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>define-key embark-general-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;G&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-google-this</span><span class="rainbow-delimiters-depth-1-face">)
(</span>define-key embark-general-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;C&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-gpt</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> URI-encode/hexify action
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-embark-hexify/uri-encode</span> <span class="rainbow-delimiters-depth-2-face">(</span>start end<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Properly URI-encode the region between START and END in current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;r&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>encoded <span class="rainbow-delimiters-depth-5-face">(</span>url-hexify-string <span class="rainbow-delimiters-depth-6-face">(</span>buffer-substring-no-properties start end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>delete-region start end<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert encoded<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>define-key embark-general-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;U&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-embark-hexify/uri-encode</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Bind command to a leader key action
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>define-key embark-command-map  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;m&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-embark-bind-leader-command</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-embark-bind-leader-command</span> <span class="rainbow-delimiters-depth-2-face">(</span>command key<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Bind KEY to COMMAND in `</span><span class="constant">im-leader</span><span class="doc">' map.
KEY should not contain the leader key.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-command <span class="string">&quot;Set key to command: &quot;</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>read-string <span class="string">&quot;Bind key (SPC&lt;key&gt;) (maybe use 3 4 5 6 7 8 9 etc.): &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>normal<span class="rainbow-delimiters-depth-3-face">)</span>
    key command<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Fix =embark-org-copy-as-markdown=
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-advice</span> <span class="function-name">embark-org-copy-as-markdown</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:before</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-3-face">)</span> load-required-libs<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Load required libs.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">ox-md</span> nil t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> More org-mode actions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>keymap-set embark-region-map <span class="string">&quot;V&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-copy-visible</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> flymake
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">flymake</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">:hook ((prog-mode . flymake-mode)
</span>  <span class="comment-delimiter">;;        </span><span class="comment">(after-init . (lambda () (setq ))))
</span>  <span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">flymake-popon</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> codeberg  <span class="builtin">:repo</span> <span class="string">&quot;akib/emacs-flymake-popon&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>flymake-mode . flymake-popon-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Disable showing diagnostics in eldoc (in echo area) as we already
</span>  <span class="comment-delimiter">;; </span><span class="comment">show diagnostics in a posframe.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>flymake-popon-mode  . <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>remove-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eldoc-documentation-functions</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">flymake-eldoc-function</span> t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>flymake-popon-posframe-extra-arguments
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:poshandler</span> posframe-poshandler-window-bottom-center<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-flymake-yank-diagnostics-at-point</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Copy the flymake diagnostics at point.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-kill
   <span class="rainbow-delimiters-depth-3-face">(</span>mapconcat <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">flymake-diagnostic-text</span> <span class="rainbow-delimiters-depth-4-face">(</span>flymake-diagnostics <span class="rainbow-delimiters-depth-5-face">(</span>point<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-show-diagnostic-list</span> <span class="rainbow-delimiters-depth-2-face">(</span>arg<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Show all lsp errors or flycheck/flymake errors, depending on which is available.
When ARG is non-nil, query the whole workspace/project.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">bound-and-true-p</span> lsp-mode<span class="rainbow-delimiters-depth-4-face">)
    (</span>consult-lsp-diagnostics arg<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">bound-and-true-p</span> flymake-mode<span class="rainbow-delimiters-depth-4-face">)
    (</span>consult-flymake arg<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">bound-and-true-p</span> flycheck-mode<span class="rainbow-delimiters-depth-4-face">)
    (</span>consult-flycheck<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t <span class="rainbow-delimiters-depth-4-face">(</span><span class="warning">user-error</span> <span class="string">&quot;No diagnostic provider found&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="comment-delimiter">;; </span><span class="comment">Write ~n SPC~, ~w SPC~, ~e SPC~ to show notes, warnings, errors
</span>  <span class="comment-delimiter">;; </span><span class="comment">only.
</span>  <span class="string">&quot;ge&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-show-diagnostic-list</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> corfu &amp; corfu-doc &amp; kind-icon
</span>
<span class="comment-delimiter">;; </span><span class="comment">- When corfu popup is open
</span><span class="comment-delimiter">;; </span><span class="comment">- ~M-SPC~ to insert a space to be able to filter with orderless.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~M-q~ to show an avy like quick selection keys.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~M-m~ to move completion items to mini-buffer (completing-read).
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">corfu</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:files</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:defaults</span> <span class="string">&quot;extensions/*.el&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>corfu-cycle t<span class="rainbow-delimiters-depth-2-face">)
  (</span>corfu-auto t<span class="rainbow-delimiters-depth-2-face">)
  (</span>corfu-auto-prefix 2<span class="rainbow-delimiters-depth-2-face">)
  (</span>corfu-auto-delay 0.4<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Enabled differently in eshell
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>global-corfu-modes <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>not eshell<span class="rainbow-delimiters-depth-4-face">)</span> t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-j&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-next</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-k&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-previous</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;RET&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-complete</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;tab&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> nil<span class="rainbow-delimiters-depth-2-face">)

  (</span>set-face-background <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">corfu-current</span> <span class="string">&quot;dim gray&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>global-corfu-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">This is useful because sometimes I just want to collect list of
</span><span class="comment-delimiter">;; </span><span class="comment">completions. With this I can use embark's collect functionality.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">corfu-move-to-minibuffer</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">pcase</span> completion-in-region--data
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span>,beg ,end ,table ,pred ,extras<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>completion-extra-properties extras<span class="rainbow-delimiters-depth-6-face">)</span>
           completion-cycle-threshold completion-cycling<span class="rainbow-delimiters-depth-5-face">)
       (</span>consult-completion-in-region beg end table pred<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span>keymap-set corfu-map <span class="string">&quot;M-m&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-move-to-minibuffer</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">corfu-continue-commands</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-move-to-minibuffer</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">corfu-quick</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> corfu
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> corfu-quick1 <span class="string">&quot;asdfgqwe&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> corfu-quick2 <span class="string">&quot;hjklui&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="string">&quot;\M-q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-quick-insert</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">kind-icon</span>
  <span class="builtin">:after</span> corfu
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> kind-icon-default-face <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">corfu-default</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">corfu-margin-formatters</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">kind-icon-margin-formatter</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">corfu-popupinfo</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:after</span> corfu
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> corfu-popupinfo-delay <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>1.0 . 0.3<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>corfu-popupinfo-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Toggle doc on/off while in corfu
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-i&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-popupinfo-toggle</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-l&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-popupinfo-location</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-p&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-popupinfo-scroll-down</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key corfu-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">corfu-popupinfo-scroll-up</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> cape
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">cape</span>
  <span class="comment-delimiter">;; </span><span class="comment">Bind dedicated completion commands
</span>  <span class="comment-delimiter">;; </span><span class="comment">Alternative prefix keys: C-c p, M-p, M-+, ...
</span>  <span class="builtin">:bind</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;M-o p&quot;</span> . completion-at-point<span class="rainbow-delimiters-depth-3-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">capf
</span>         <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;M-o t&quot;</span> . complete-tag<span class="rainbow-delimiters-depth-3-face">)</span>        <span class="comment-delimiter">;; </span><span class="comment">etags
</span>         <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;M-o d&quot;</span> . cape-dabbrev<span class="rainbow-delimiters-depth-3-face">)</span>        <span class="comment-delimiter">;; </span><span class="comment">or dabbrev-completion
</span>         <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;M-o h&quot;</span> . cape-history<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o f&quot;</span> . cape-file<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o k&quot;</span> . cape-elisp-keyword<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o s&quot;</span> . cape-elisp-symbol<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o a&quot;</span> . cape-abbrev<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o i&quot;</span> . cape-ispell<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o l&quot;</span> . cape-line<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o e&quot;</span> . cape-emoji<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o w&quot;</span> . cape-dict<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o \\&quot;</span> . cape-tex<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o _&quot;</span> . cape-tex<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o ^&quot;</span> . cape-tex<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o &amp;&quot;</span> . cape-sgml<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;M-o r&quot;</span> . cape-rfc1345<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="comment-delimiter">;; </span><span class="comment">Add `</span><span class="constant">completion-at-point-functions</span><span class="comment">', used by `</span><span class="constant">completion-at-point</span><span class="comment">'.
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-dabbrev)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-file)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-history)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-keyword)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-tex)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-sgml)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-rfc1345)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-abbrev)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-ispell)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-dict)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-symbol)
</span>  <span class="comment-delimiter">;;</span><span class="comment">(add-to-list 'completion-at-point-functions #'cape-line)
</span>  <span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defmacro</span> <span class="function-name">im-cape</span>
    <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> name completion extractor category
          bound key annotate doc <span class="rainbow-delimiters-depth-3-face">(</span>exclusive <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">no</span><span class="rainbow-delimiters-depth-3-face">) (</span>sort t<span class="rainbow-delimiters-depth-3-face">)</span> kind<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create a cape completion function with given parameters.

COMPLETION is a either a list that holds the completions or a
function that returns the completions.  This can be an arbitrary
object as EXTRACTOR is used for extracting the real completions
from this object.  EXTRACTOR is a function that is called with
the result of COMPLETION and real completion list is gathered
this way.

BOUND is boundaries of the thing that gets completed.  May be
symbol, word, file etc.

KEY is key to bind this cape to.

ANNOTATE is a function that returns annotation for given
completion.  It should return a string.  The function is called
with two arguments, first being the object returned by COMPLETION
and second being current completion item.

DOC is a function that returns documentation for given
completion.  Should return a string.  Signature is same with
ANNOTATE.

KIND is a function that returns the kind for current completion
item.  It should return a symbol like `</span><span class="constant">file</span><span class="doc">', `</span><span class="constant">folder</span><span class="doc">', `</span><span class="constant">text</span><span class="doc">',
`</span><span class="constant">snippet</span><span class="doc">', `</span><span class="constant">keyword</span><span class="doc">', `</span><span class="constant">function</span><span class="doc">', `</span><span class="constant">variable</span><span class="doc">', `</span><span class="constant">module</span><span class="doc">', `</span><span class="constant">color</span><span class="doc">'
etc.  In turn, there is a icon displayed that is associated with
the kind symbol.  Signature is same with ANNOTATE.

SORT should be nil to disable sorting.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>cape-fn <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;im-cape-%s&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>symbol-name name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defun</span> ,cape-fn <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;optional</span> interactive<span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-6-face">(</span>list t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">if</span> interactive
             <span class="rainbow-delimiters-depth-6-face">(</span>cape-interactive <span class="highlight-quoted-quote">#'</span>,cape-fn<span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">pcase-let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-9-face">(</span>,beg . ,end<span class="rainbow-delimiters-depth-9-face">) (</span>cape--bounds <span class="highlight-quoted-quote">'</span>,bound<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                       (</span>xs <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-1-face">(</span>functionp ,completion<span class="rainbow-delimiters-depth-1-face">)
                               (</span>funcall ,completion<span class="rainbow-delimiters-depth-1-face">)</span>
                             ,completion<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>append
              <span class="rainbow-delimiters-depth-8-face">(</span>list beg end
                    <span class="rainbow-delimiters-depth-9-face">(</span>cape--properties-table <span class="rainbow-delimiters-depth-1-face">(</span>funcall ,extractor xs<span class="rainbow-delimiters-depth-1-face">)</span> <span class="builtin">:sort</span> ,sort<span class="rainbow-delimiters-depth-9-face">)</span>
                    <span class="builtin">:exclusive</span> <span class="highlight-quoted-quote">'</span>,exclusive<span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">when</span> ,annotate
                <span class="rainbow-delimiters-depth-9-face">(</span>list <span class="builtin">:annotation-function</span> <span class="rainbow-delimiters-depth-1-face">(</span>apply-partially ,annotate xs<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">when</span> ,kind
                <span class="rainbow-delimiters-depth-9-face">(</span>list <span class="builtin">:company-kind</span> <span class="rainbow-delimiters-depth-1-face">(</span>apply-partially ,kind xs<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">when</span> ,doc
                <span class="rainbow-delimiters-depth-9-face">(</span>list <span class="builtin">:company-doc-buffer</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-2-face">(</span>x<span class="rainbow-delimiters-depth-2-face">)
                                            (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create <span class="string">&quot; *im-cape-doc*&quot;</span><span class="rainbow-delimiters-depth-3-face">)
                                              (</span>erase-buffer<span class="rainbow-delimiters-depth-3-face">)
                                              (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>funcall ,doc xs x<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
                                              (</span>current-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">when</span> <span class="highlight-quoted-quote">'</span>,category
                <span class="rainbow-delimiters-depth-9-face">(</span>list <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span>,category<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">when</span> ,key
         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">bind-key</span> ,key <span class="highlight-quoted-quote">#'</span>,cape-fn<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> eglot
</span>
<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Add hooks for modes, eglot-ensure
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">eglot</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>eglot-autoshutdown t<span class="rainbow-delimiters-depth-2-face">)
  (</span>eglot-events-buffer-size 0<span class="rainbow-delimiters-depth-2-face">)
  (</span>eglot-extend-to-xref nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>eglot-ignored-server-capabilities
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:documentFormattingProvider
     :documentRangeFormattingProvider
     :documentOnTypeFormattingProvider</span>
     <span class="comment-delimiter">;; </span><span class="comment">:colorProvider
</span>     <span class="builtin">:foldingRangeProvider</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">This is needed so that go-to definition works for library files.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">eglot-java</span>
  <span class="builtin">:after</span> eglot
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;yveszoundi/eglot-java&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>java-ts-mode . eglot-java-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> vterm
</span>
<span class="comment-delimiter">;; </span><span class="comment">Also check out =~/.zshrc= and =~/.config/zsh/emacs.sh=. These files
</span><span class="comment-delimiter">;; </span><span class="comment">contains some helpful commands that enriches ~vterm~ usage.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Use =C-z= to go in/out (you can also use =jk= to go back into
</span><span class="comment-delimiter">;; </span><span class="comment">normal mode from emacs mode) emacs state so that you can make use
</span><span class="comment-delimiter">;; </span><span class="comment">of use vi-mode in zsh.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">evil-collection-vterm-escape-stay</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Go back to normal state but don't move cursor backwards.
Moving cursor backwards is the default vim behavior but it is not
appropriate in some cases like terminals.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> evil-move-cursor-back nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-make-repeatable</span> im-vterm-prompt
  <span class="string">&quot;[&quot;</span> vterm-previous-prompt
  <span class="string">&quot;]&quot;</span> vterm-next-prompt<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">vterm</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>vterm-mode . evil-collection-vterm-escape-stay<span class="rainbow-delimiters-depth-3-face">)
         (</span>vterm-mode . im-disable-hl-line-mode-for-buffer<span class="rainbow-delimiters-depth-3-face">)
         (</span>vterm-mode . evil-emacs-state<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;tj&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jump-to-visible-term</span>
    <span class="string">&quot;tl&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-run-last-command-on-visible-term</span>
    <span class="string">&quot;ty&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-send-selected-text-to-visible-term</span>
    <span class="string">&quot;tr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-run-command-on-visible-term-with-history</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vterm-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span>
   <span class="string">&quot;C-r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vterm--self-insert</span>
   <span class="string">&quot;M-\\&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vterm--self-insert</span>
   <span class="string">&quot;M--&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vterm--self-insert</span>
   <span class="string">&quot;C-c&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vterm--self-insert</span>
   <span class="string">&quot;C-x&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vterm--self-insert</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init
  :config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-vterm-setup<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Setting screen as the terminal fixes some of vterm's problems, as
</span>  <span class="comment-delimiter">;; </span><span class="comment">described here[1] but it creates some other problems like when
</span>  <span class="comment-delimiter">;; </span><span class="comment">the screen size changes, some of the scrollback gets deleted etc.
</span>  <span class="comment-delimiter">;; </span><span class="comment">[1]: https://github.com/akermu/emacs-libvterm/issues/179#issuecomment-1045331359
</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> vterm-shell <span class="rainbow-delimiters-depth-3-face">(</span>executable-find <span class="string">&quot;fish&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> vterm-kill-buffer-on-exit t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Utility functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-terminal-buffer-name-regexp</span> <span class="string">&quot;\\*?\\$?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">e?shell</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">v?term</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">.*&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-run-last-command-on-visible-term</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>save-buffer<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-with-visible-buffer</span> im-terminal-buffer-name-regexp
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">pcase</span> major-mode
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-mode</span>  <span class="rainbow-delimiters-depth-5-face">(</span>eshell-previous-matching-input <span class="string">&quot;&quot;</span> 0<span class="rainbow-delimiters-depth-5-face">)
                     (</span>eshell-send-input<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eat-mode</span> <span class="rainbow-delimiters-depth-5-face">(</span>eat-self-input 1 <span class="rainbow-delimiters-depth-6-face">(</span>aref <span class="rainbow-delimiters-depth-7-face">(</span>kbd <span class="string">&quot;&lt;up&gt;&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> 0<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                 (</span>eat-self-input 1 <span class="rainbow-delimiters-depth-6-face">(</span>aref <span class="rainbow-delimiters-depth-7-face">(</span>kbd <span class="string">&quot;RET&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> 0<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vterm-mode</span> <span class="rainbow-delimiters-depth-5-face">(</span>vterm-send-up<span class="rainbow-delimiters-depth-5-face">)
                   (</span>vterm-send-return<span class="rainbow-delimiters-depth-5-face">)</span>
                   t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-run-command-on-visible-term</span> <span class="rainbow-delimiters-depth-2-face">(</span>cmd<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-with-visible-buffer</span> im-terminal-buffer-name-regexp
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">pcase</span> major-mode
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-mode</span>  <span class="rainbow-delimiters-depth-5-face">(</span>insert cmd<span class="rainbow-delimiters-depth-5-face">)
                     (</span>eshell-send-input<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eat-mode</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>eat--send-string <span class="rainbow-delimiters-depth-6-face">(</span>eat-term-parameter eat-terminal <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eat--process</span><span class="rainbow-delimiters-depth-6-face">)</span> cmd<span class="rainbow-delimiters-depth-5-face">)
       (</span>eat-self-input 1 <span class="rainbow-delimiters-depth-6-face">(</span>aref <span class="rainbow-delimiters-depth-7-face">(</span>kbd <span class="string">&quot;RET&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> 0<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vterm-mode</span> <span class="rainbow-delimiters-depth-5-face">(</span>vterm-send-string cmd<span class="rainbow-delimiters-depth-5-face">)
                   (</span>vterm-send-return<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  cmd<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-send-selected-text-to-visible-term</span> <span class="rainbow-delimiters-depth-2-face">(</span>start end<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;r&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>use-region-p<span class="rainbow-delimiters-depth-3-face">)
      (</span>im-run-command-on-visible-term <span class="rainbow-delimiters-depth-4-face">(</span>buffer-substring-no-properties start end<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-run-command-on-visible-term <span class="rainbow-delimiters-depth-4-face">(</span>s-trim <span class="rainbow-delimiters-depth-5-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-term-run-history</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-jump-to-term-last-window</span> nil<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jump-to-visible-term</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Jump to the visible term window.
When invoked in a term window, return back to last window that
this command is invoked from.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>string-match im-terminal-buffer-name-regexp <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name <span class="rainbow-delimiters-depth-6-face">(</span>window-buffer <span class="rainbow-delimiters-depth-7-face">(</span>selected-window<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>select-window im-jump-to-term-last-window<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> im-jump-to-term-last-window <span class="rainbow-delimiters-depth-5-face">(</span>selected-window<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>im-select-window-with-buffer im-terminal-buffer-name-regexp<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-run-command-on-visible-term-with-history</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>cmd <span class="rainbow-delimiters-depth-5-face">(</span>im-run-command-on-visible-term
              <span class="rainbow-delimiters-depth-6-face">(</span>completing-read <span class="string">&quot;Run new command: &quot;</span> im-term-run-history<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> cmd
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> im-term-run-history <span class="rainbow-delimiters-depth-5-face">(</span>cons cmd <span class="rainbow-delimiters-depth-6-face">(</span>delete cmd im-term-run-history<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> simple-modeline
</span>
<span class="comment-delimiter">;; </span><span class="comment">Lightweight and nice modeline.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">simple-modeline</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;gexplorer/simple-modeline&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . simple-modeline-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span> <span class="rainbow-delimiters-depth-2-face">(</span>simple-modeline-segments
           <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>simple-modeline-segment-modified
              simple-modeline-segment-buffer-name
              simple-modeline-segment-position<span class="rainbow-delimiters-depth-4-face">)
             (</span>simple-modeline-segment-input-method
              simple-modeline-segment-eol
              simple-modeline-segment-encoding
              simple-modeline-segment-vc
              simple-modeline-segment-misc-info
              simple-modeline-segment-process
              simple-modeline-segment-major-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> howdoyou
</span>
<span class="comment-delimiter">;; </span><span class="comment">When you search for something, it opens the results in an org-mode
</span><span class="comment-delimiter">;; </span><span class="comment">buffer. Results are fetched from SX (stack-exchange, stackoverflow
</span><span class="comment-delimiter">;; </span><span class="comment">etc) sites.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =SPC hs= or =howdoyou-query= :: search function
</span><span class="comment-delimiter">;; </span><span class="comment">- =C-M-Left= :: prev answer
</span><span class="comment-delimiter">;; </span><span class="comment">- =C-M-Right= :: next answer
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">howdoyou</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>howdoyou-query howdoyou--get-buffer<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">howdoyou-mode-keymap</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>normal motion<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;gn&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">howdoyou-next-link</span>
   <span class="string">&quot;gp&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">howdoyou-previous-link</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span>
    <span class="string">&quot;is&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">howdoyou-query</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> howdoyou-switch-to-answer-buffer t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> howdoyou-number-of-answers 5<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-open-stackexchange-link</span> <span class="rainbow-delimiters-depth-2-face">(</span>link<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Open stackexchange LINK in a nicely formatted org buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sLink: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>switch-to-buffer <span class="rainbow-delimiters-depth-3-face">(</span>howdoyou--get-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>insert <span class="string">&quot;Loading...&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">promise-chain</span> <span class="rainbow-delimiters-depth-4-face">(</span>howdoyou-read-so-link link<span class="rainbow-delimiters-depth-4-face">)
      (</span>then <span class="highlight-quoted-quote">#'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>_<span class="rainbow-delimiters-depth-6-face">)
                (</span>im-url-get-title-async
                 link
                 <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>title<span class="rainbow-delimiters-depth-8-face">)
                   (</span><span class="keyword">with-current-buffer</span> buffer <span class="rainbow-delimiters-depth-9-face">(</span>rename-buffer <span class="rainbow-delimiters-depth-1-face">(</span>format <span class="string">&quot;*se: %s*&quot;</span> title<span class="rainbow-delimiters-depth-1-face">)</span> <span class="builtin">:unique</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tldr
</span>
<span class="comment-delimiter">;; </span><span class="comment">tldr client for Emacs.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">tldr</span>
  <span class="builtin">:commands</span> tldr
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;it&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tldr</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> yasnippet &amp; yankpad: template manager
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">yasnippet</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>minibuffer-setup . yas-minor-mode<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="comment-delimiter">;; </span><span class="comment">^ Enable expanding in mini-buffer.
</span>   <span class="rainbow-delimiters-depth-3-face">(</span>after-init . yas-global-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">yankpad</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/yankpad&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:after</span> <span class="rainbow-delimiters-depth-2-face">(</span>org yasnippet<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>yankpad--categories yankpad--snippets<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;sr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-reload</span>
    <span class="string">&quot;sc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-set-category</span>
    <span class="string">&quot;se&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-edit</span>
    <span class="string">&quot;ss&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-map</span>
    <span class="string">&quot;sm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-map</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-insert</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-insert</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-e&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hippie-expand</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-local-map</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-insert</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-e&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hippie-expand</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>yankpad-file snippets-org<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Categories returned by the following functions will be used to
</span>  <span class="comment-delimiter">;; </span><span class="comment">expand snippets
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>yankpad-auto-category-functions <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>yankpad-major-mode-category im-current-project-name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">hippie-expand-try-functions-list</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">yankpad-expand</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">I also like to use these snippets outside of Emacs. For this, I
</span><span class="comment-delimiter">;; </span><span class="comment">defined =im-select-any-snippet=. It let's you select any snippet
</span><span class="comment-delimiter">;; </span><span class="comment">from the yankpad file (no mode restriction, shows all snippets
</span><span class="comment-delimiter">;; </span><span class="comment">prefixed with mode name they are defined for) through
</span><span class="comment-delimiter">;; </span><span class="comment">=completing-read=. Combined with ~im-globally~, you can use this
</span><span class="comment-delimiter">;; </span><span class="comment">outside of Emacs.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im--all-snippets-cache</span> nil<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-load-snippets-list</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>make-thread
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>message <span class="string">&quot;&gt;&gt; Loading snippets...&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">setq</span>
      im--all-snippets-cache
      <span class="rainbow-delimiters-depth-5-face">(</span>-mapcat
       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>category<span class="rainbow-delimiters-depth-7-face">)
         (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-8-face">(</span>cons <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;%s :: %s&quot;</span> category <span class="rainbow-delimiters-depth-1-face">(</span>car it<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> it<span class="rainbow-delimiters-depth-8-face">)</span>
                <span class="comment-delimiter">;; </span><span class="comment">Clear some sections of the data that causes
</span>                <span class="comment-delimiter">;; </span><span class="comment">issues with emacs-async. It prints out some data
</span>                <span class="comment-delimiter">;; </span><span class="comment">like #3 #5 etc. which can't be `</span><span class="constant">read</span><span class="comment">'.
</span>                <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--map</span>
                 <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-1-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">src-block</span> <span class="rainbow-delimiters-depth-2-face">(</span>nth 2 it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
                     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-1-face">(</span>,@<span class="rainbow-delimiters-depth-2-face">(</span>-take 2 it<span class="rainbow-delimiters-depth-2-face">)</span> nil ,@<span class="rainbow-delimiters-depth-2-face">(</span>-take-last 2 it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
                   it<span class="rainbow-delimiters-depth-9-face">)
                 (</span><span class="keyword">ignore-errors</span>
                   <span class="rainbow-delimiters-depth-1-face">(</span>yankpad--snippets category<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>yankpad--categories<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>message <span class="string">&quot;&gt;&gt; Loading snippets... Done&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Load snippets for the first time, after the startup
</span><span class="comment-delimiter">;; </span><span class="comment">This may take a bit of time
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>run-with-timer 5 nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-load-snippets-list</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-select-any-snippet</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;List all templates for all modes and return the applied template
  as string.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>selected <span class="rainbow-delimiters-depth-5-face">(</span>completing-read <span class="string">&quot;Select snippet: &quot;</span> im--all-snippets-cache<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
          (</span>snippet <span class="rainbow-delimiters-depth-5-face">(</span>alist-get selected im--all-snippets-cache nil nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="rainbow-delimiters-depth-5-face">(</span>_ category _<span class="rainbow-delimiters-depth-5-face">) (</span>s-match <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> :: </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> selected<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-temp-buffer</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> yankpad-category category<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="comment-delimiter">;; </span><span class="comment">Activate yas snippet on the temp buffer
</span>      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>yas-dont-activate-functions <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">()</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>yas-minor-mode-on<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>yankpad--run-snippet snippet<span class="rainbow-delimiters-depth-4-face">)
      (</span>im-kill <span class="rainbow-delimiters-depth-5-face">(</span>buffer-string<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> git-link
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">git-link</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;glm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-git-link-merge-requests</span>
    <span class="string">&quot;gll&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-git-link-on-branch</span>
    <span class="string">&quot;glL&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-git-link-commit</span>
    <span class="string">&quot;glc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">git-link-commit</span>
    <span class="string">&quot;glh&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">git-link-homepage</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> git-link-open-in-browser t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-git-link-homepage</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like git-link-homepage itself but it does not open in browser, simply returns the address as string.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>git-link-open-in-browser nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>call-interactively <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">git-link-homepage</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>car kill-ring<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-git-link-on-branch</span> <span class="rainbow-delimiters-depth-2-face">(</span>branch<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Like `</span><span class="constant">git-link</span><span class="doc">' but let's you select the branch first when called interactively.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>completing-read
     <span class="string">&quot;Select a branch: &quot;</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>vc-git-branches<span class="rainbow-delimiters-depth-5-face">)</span>
     nil nil <span class="rainbow-delimiters-depth-5-face">(</span>lab-git-current-branch<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>git-link-default-branch branch<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>call-interactively <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">git-link</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-git-link-commit</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">git-link</span><span class="doc">' but use commit hash in url.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>git-link-use-commit t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>call-interactively <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">git-link</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-git-link-merge-requests</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open MR page.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>browse-url
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>homepage <span class="rainbow-delimiters-depth-6-face">(</span>im-git-link-homepage<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">cond</span>
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>s-contains? <span class="string">&quot;gitlab&quot;</span> homepage<span class="rainbow-delimiters-depth-6-face">) (</span>concat homepage <span class="string">&quot;/-/merge_requests&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="rainbow-delimiters-depth-6-face">(</span>s-contains? <span class="string">&quot;github&quot;</span> homepage<span class="rainbow-delimiters-depth-6-face">) (</span>concat homepage <span class="string">&quot;/pulls&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>t <span class="rainbow-delimiters-depth-6-face">(</span><span class="warning">user-error</span> <span class="string">&quot;Forge undefined&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tab-out
</span>
<span class="comment-delimiter">;; </span><span class="comment">When you press tab, jump out from the current enclosing
</span><span class="comment-delimiter">;; </span><span class="comment">parens/quotes etc. When there is no enclosing stuff, TAB key
</span><span class="comment-delimiter">;; </span><span class="comment">automatically fallbacks to it's default behavior.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">tab-jump-out</span>
  <span class="builtin">:diminish
  :straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;zhangkaiyulw/tab-jump-out&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">This is not defined as a global minor mode, so define one and enable it
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">define-globalized-minor-mode</span> <span class="function-name">global-tab-jump-out-mode</span> tab-jump-out-mode
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
      (</span>tab-jump-out-mode<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">push</span> <span class="string">&quot;/&quot;</span> tab-jump-out-delimiters<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">push</span> <span class="string">&quot;=&quot;</span> tab-jump-out-delimiters<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>global-tab-jump-out-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> helpful and elisp-demos
</span>
<span class="comment-delimiter">;; </span><span class="comment">- helpful :: Better help dialogs with syntax highlighting, references, source etc.
</span><span class="comment-delimiter">;; </span><span class="comment">- elisp-demos :: Adds code examples into function help buffers.
</span><span class="comment-delimiter">;; </span><span class="comment">- Code examples are maintained [[https://github.com/xuchunyang/elisp-demos/blob/master/elisp-demos.org][here]], don't forget to contribute!
</span><span class="comment-delimiter">;; </span><span class="comment">- Call ~elisp-demos-add-demo~ to add a demo locally.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">helpful</span>
  <span class="comment-delimiter">;; </span><span class="comment">Override default help bindings
</span>  <span class="builtin">:bind</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;C-h f&quot;</span> . helpful-callable<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;C-h v&quot;</span> . helpful-variable<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;C-h k&quot;</span> . helpful-key<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;C-h p&quot;</span> . helpful-at-point<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> helpful-mode-map
    <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-delete-buffer</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">elisp-demos</span>
  <span class="builtin">:after</span> helpful
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>advice-add <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">helpful-update</span> <span class="builtin">:after</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">elisp-demos-advice-helpful-update</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Here, I also bind some keys for convenience. Taken from
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://github.com/radian-software/radian/blob/23e80b3d865bfb60b166309249ac4db2b176b9fc/emacs/radian.el#LL3970C1-L3982C1][here]].
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">bind-key</span> <span class="string">&quot;C-h C-f&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">find-function</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">bind-key</span> <span class="string">&quot;C-h C-v&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">find-variable</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">bind-key</span> <span class="string">&quot;C-h C-l&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">find-library</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> expand-region
</span>
<span class="comment-delimiter">;; </span><span class="comment">Also see combobulate package. I use it instead
</span><span class="comment-delimiter">;; </span><span class="comment">(`</span><span class="constant">combobulate-mark-node-dwim</span><span class="comment">') whenever possible instead of
</span><span class="comment-delimiter">;; </span><span class="comment">expand-region.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">expand-region</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;karthink/expand-region.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>insert normal<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;M-w&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">er/expand-region</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> aggressive-indent
</span>
<span class="comment-delimiter">;; </span><span class="comment">It keeps your indentation working all the time. Seems like a good
</span><span class="comment-delimiter">;; </span><span class="comment">idea but I have some concerns about it, so I just use it with elisp
</span><span class="comment-delimiter">;; </span><span class="comment">for the time being.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">aggressive-indent</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>emacs-lisp-mode . aggressive-indent-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">aggressive-indent-protected-commands</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-undo</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">aggressive-indent-protected-commands</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">format-all-buffer</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> xmodmap-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Simple mode for editing =~/.Xmodmap= file.
</span><span class="comment-delimiter">;; </span><span class="comment">Source:  https://www.emacswiki.org/emacs/XModMapMode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-generic-mode</span> <span class="highlight-quoted-quote">'</span><span class="function-name">xmodmap-mode</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>?!<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;add&quot; &quot;clear&quot; &quot;keycode&quot; &quot;keysym&quot; &quot;pointer&quot; &quot;remove&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  nil
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;[xX]modmap</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">rc</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  nil
  <span class="doc">&quot;Simple mode for xmodmap files.&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> slack
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">slack</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;emacs-slack/emacs-slack&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;ess&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-select-room</span>
    <span class="string">&quot;esd&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-dms</span>
    <span class="string">&quot;esS&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slack-select-unread-rooms</span>
    <span class="string">&quot;esm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-send-message</span>
    <span class="string">&quot;est&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slack-all-threads</span>
    <span class="string">&quot;esr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-last-messages-alternative</span>
    <span class="string">&quot;esR&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-last-messages</span>
    <span class="string">&quot;esl&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-open-last-message</span>
    <span class="string">&quot;esy&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-yank-last-message</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> slack-log-level <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">error</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ info level shows unnecessary stuff that distracts me
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> slack-block-highlight-source t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> slack-buffer-emojify nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> slack-render-image-p t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> slack-image-max-height 150<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> slack-prefer-current-team t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Set current team with `</span><span class="constant">slack-change-current-team</span><span class="comment">'
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> slack-buffer-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">switch-to-buffer</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> slack-typing-visibility nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ Typing indicators causes some issues on my end.  Gonna disable
</span>  <span class="comment-delimiter">;; </span><span class="comment">it for now.
</span>
  <span class="comment-delimiter">;; </span><span class="comment">Disable filling as it fucks with copying stuff
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> lui-fill-type nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lui-fill-column 0<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lui-time-stamp-format <span class="string">&quot;[%a %b %d %H:%M]&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> slack-message-custom-notifier <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-notify</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> slack-message-custom-delete-notifier <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-notify</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> slack-visible-thread-sign <span class="string">&quot;╚═&gt; &quot;</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-buffer-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-line-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-thread-message-buffer-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-line-mode</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-mode-map</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> slack-message-edit-buffer-mode-map
    <span class="string">&quot;@&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slack-message-embed-mention</span>
    <span class="string">&quot;mc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slack-message-embed-channel</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> slack-message-compose-buffer-mode-map
    <span class="string">&quot;@&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slack-message-embed-mention</span>
    <span class="string">&quot;mc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slack-message-embed-channel</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Fix for/from yuya373/emacs-slack#547-1542119271
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>advice-add <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lui-buttonize-urls</span> <span class="builtin">:before-until</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-mode</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">dolist</span> <span class="rainbow-delimiters-depth-3-face">(</span>mode <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>slack-buffer-mode-hook
                  slack-edit-message-mode-hook
                  slack-message-buffer-mode-hook
                  slack-all-threads-buffer-mode-hook
                  slack-message-edit-buffer-mode-hook
                  slack-search-result-buffer-mode-hook
                  slack-thread-message-buffer-mode-hook
                  slack-message-compose-buffer-mode-hook<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>add-hook mode <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack--enable-completion-at-point</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>add-hook mode <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">visual-line-mode</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-initialize</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-3-face">(</span>slack-ws-close<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-3-face">(</span>slack-team-delete<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-slack--last-messages nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-slack-kill-buffers<span class="rainbow-delimiters-depth-2-face">)
  (</span>slack-register-team
   <span class="builtin">:name</span> ty-slack-name
   <span class="builtin">:token</span> ty-slack-token
   <span class="builtin">:enterprise-token</span> ty-slack-enterprise-token
   <span class="builtin">:cookie</span> ty-slack-cookie
   <span class="builtin">:subscribed-channels</span> ty-slack-channels
   <span class="builtin">:visible-threads</span> nil
   <span class="builtin">:mark-as-read-immediately</span> t<span class="rainbow-delimiters-depth-2-face">)
  (</span>slack-start<span class="rainbow-delimiters-depth-2-face">)
  (</span>slack-change-current-team<span class="rainbow-delimiters-depth-2-face">)
  (</span>run-at-time nil 3600 <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-check</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack--enable-completion-at-point</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">setq-local</span>
   completion-at-point-functions
   <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span>,<span class="rainbow-delimiters-depth-4-face">(</span>cape-company-to-capf <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">company-slack-backend</span><span class="rainbow-delimiters-depth-4-face">)</span>
     cape-emoji<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-kill-buffers</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">--each</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--filter</span>
           <span class="rainbow-delimiters-depth-4-face">(</span>s-prefix? <span class="string">&quot;*slack: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">) (</span>buffer-list<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-5-face">(</span>kill-buffer it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">with-current-buffer</span> it
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>kill-buffer-query-functions nil<span class="rainbow-delimiters-depth-7-face">)
              (</span>kill-buffer-hook nil<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>kill-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-toggle-timestamps</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle visibility of timestamps in current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil slack-message-buffer-mode slack-thread-message-buffer-mode-map<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>inhibit-read-only t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>eobp<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>get-text-property <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lui-time-stamp</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>get-text-property <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">invisible</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>remove-text-properties <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">) (</span>1+ <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-8-face">(</span>invisible nil<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>put-text-property <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">) (</span>1+ <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">invisible</span> t<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span>next-property-change <span class="rainbow-delimiters-depth-7-face">(</span>point<span class="rainbow-delimiters-depth-7-face">)</span> nil <span class="rainbow-delimiters-depth-7-face">(</span>point-max<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack--add-reaction-to-message</span> <span class="rainbow-delimiters-depth-2-face">(</span>reaction<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">defalias</span> <span class="rainbow-delimiters-depth-3-face">(</span>intern <span class="rainbow-delimiters-depth-4-face">(</span>concat <span class="string">&quot;react-&quot;</span> reaction<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
       (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>slack-buffer-add-reaction-to-message
        slack-current-buffer
        ,reaction
        <span class="rainbow-delimiters-depth-5-face">(</span>slack-get-ts<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-slack-dnd</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-slack--last-messages</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-toggle-dnd</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;slack :: DND is %s.&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">setq</span> im-slack-dnd <span class="rainbow-delimiters-depth-4-face">(</span>not im-slack-dnd<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-check</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>one-hour-ago <span class="rainbow-delimiters-depth-5-face">(</span>- <span class="rainbow-delimiters-depth-6-face">(</span>string-to-number <span class="rainbow-delimiters-depth-7-face">(</span>format-time-string <span class="string">&quot;%s&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> 3600<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>msg-count <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
                     <span class="rainbow-delimiters-depth-6-face">(</span>im-slack-last-messages-per-room<span class="rainbow-delimiters-depth-6-face">)
                     (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-7-face">(</span>&gt; <span class="rainbow-delimiters-depth-8-face">(</span>im-slack--message-ts it<span class="rainbow-delimiters-depth-8-face">)</span> one-hour-ago<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                     (</span>length<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>&gt; msg-count 0<span class="rainbow-delimiters-depth-4-face">)
      (</span>message <span class="string">&quot;&gt;&gt; Check slack. %s messages in last hour.&quot;</span>
               <span class="rainbow-delimiters-depth-5-face">(</span>propertize <span class="rainbow-delimiters-depth-6-face">(</span>number-to-string msg-count<span class="rainbow-delimiters-depth-6-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:weight</span> bold<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">async-defun</span> <span class="function-name">im-slack-notify</span> <span class="rainbow-delimiters-depth-2-face">(</span>message room team<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span>
         <span class="rainbow-delimiters-depth-4-face">(</span>slack-message-minep message team<span class="rainbow-delimiters-depth-4-face">)
         (</span>slack-mpim-p room<span class="rainbow-delimiters-depth-4-face">)
         (</span>slack-message-notify-p message room team<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>sender-name <span class="rainbow-delimiters-depth-6-face">(</span>slack-message-sender-name message team<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>room-name <span class="rainbow-delimiters-depth-6-face">(</span>slack-room-name room team<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>title <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;%s - %s&quot;</span> room-name sender-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>msg-str <span class="rainbow-delimiters-depth-6-face">(</span>im-slack--stringify-message
                     <span class="rainbow-delimiters-depth-7-face">(</span>list <span class="builtin">:message</span> message <span class="builtin">:team</span> team<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">push</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>list <span class="builtin">:room</span> room
             <span class="builtin">:team</span> team
             <span class="builtin">:message</span> message
             <span class="builtin">:sender-name</span> sender-name
             <span class="builtin">:room-name</span> room-name
             <span class="builtin">:title</span> title
             <span class="builtin">:message-string</span> msg-str<span class="rainbow-delimiters-depth-5-face">)</span>
       im-slack--last-messages<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>slack-message-minep message team<span class="rainbow-delimiters-depth-6-face">)
                  (</span>s-contains? <span class="string">&quot;message deleted&quot;</span> msg-str<span class="rainbow-delimiters-depth-6-face">)
                  (</span>s-contains? <span class="string">&quot;has joined the&quot;</span> msg-str<span class="rainbow-delimiters-depth-6-face">)
                  (</span>s-contains? <span class="string">&quot;has left the&quot;</span> msg-str<span class="rainbow-delimiters-depth-6-face">)</span>
                  <span class="comment-delimiter">;; </span><span class="comment">Dont show notifications for visible slack windows if emacs is not idle
</span>                  <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span>
                   <span class="rainbow-delimiters-depth-7-face">(</span>&lt; <span class="rainbow-delimiters-depth-8-face">(</span>time-to-seconds <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-1-face">(</span>current-idle-time<span class="rainbow-delimiters-depth-1-face">)</span> 0<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> 15<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="keyword">--some</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span>s-contains? room-name it<span class="rainbow-delimiters-depth-8-face">)
                    (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-9-face">(</span>buffer-name <span class="rainbow-delimiters-depth-1-face">(</span>window-buffer it<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">) (</span>window-list<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
        <span class="comment-delimiter">;; </span><span class="comment">Only send desktop notifications for the things I'm interested
</span>        <span class="comment-delimiter">;; </span><span class="comment">mpim || group || in subscribed channels
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>slack-message-notify-p message room team<span class="rainbow-delimiters-depth-6-face">)</span>
          <span class="comment-delimiter">;; </span><span class="comment">msg-str sometimes causes errors with `</span><span class="constant">alert</span><span class="comment">'. Thats why I
</span>          <span class="comment-delimiter">;; </span><span class="comment">used `</span><span class="constant">ignore-errors</span><span class="comment">'.
</span>          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">ignore-errors</span>
            <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">unless</span> im-slack-dnd
              <span class="rainbow-delimiters-depth-8-face">(</span>alert
               msg-str
               <span class="builtin">:title</span> title
               <span class="builtin">:category</span> <span class="string">&quot;slack&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">unless</span> im-slack-dnd
          <span class="rainbow-delimiters-depth-6-face">(</span>message
           <span class="string">&quot;&gt;&gt; Slack: %s // %s&quot;</span>
           title
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>await <span class="rainbow-delimiters-depth-9-face">(</span>im-screen-sharing-now?<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
               <span class="string">&quot;[REDACTED due to screensharing]&quot;</span>
             <span class="rainbow-delimiters-depth-8-face">(</span>s-truncate 80 <span class="rainbow-delimiters-depth-9-face">(</span>s-replace <span class="string">&quot;\n&quot; &quot;&quot;</span> msg-str<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-yank-last-message</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Yank the contents of the last received message as text.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-kill
   <span class="rainbow-delimiters-depth-3-face">(</span>im-slack--stringify-message
    <span class="rainbow-delimiters-depth-4-face">(</span>im-slack--last-message<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-open-last-message</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open last room that got new message.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-slack--open-message-or-thread <span class="rainbow-delimiters-depth-3-face">(</span>im-slack--last-message<span class="rainbow-delimiters-depth-3-face">)</span> <span class="builtin">:focus?</span> nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-slack--open-message-or-thread</span> <span class="rainbow-delimiters-depth-2-face">(</span>msg <span class="type">&amp;key</span> <span class="rainbow-delimiters-depth-3-face">(</span>focus? t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let-plist</span> msg
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-5-face">(</span>slack-thread-message-p .message<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>slack-thread-show-messages .message .room .team<span class="rainbow-delimiters-depth-4-face">)
      (</span>slack-room-display
       .room
       .team<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Focus the message on buffer
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">when</span> focus?
      <span class="rainbow-delimiters-depth-4-face">(</span>run-with-timer
       1.3 nil
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">() (</span>slack-buffer-goto <span class="rainbow-delimiters-depth-7-face">(</span>slack-ts .message<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-slack-recent-messages</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack-last-messages</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-last-messages-per-room</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">-&gt;&gt;</span>
   im-slack--last-messages
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>list <span class="builtin">:room-name</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:room-name</span><span class="rainbow-delimiters-depth-5-face">)</span>
                <span class="builtin">:room</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:room</span><span class="rainbow-delimiters-depth-5-face">)</span>
                <span class="builtin">:team</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:team</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>-uniq<span class="rainbow-delimiters-depth-3-face">)
   (</span>-map <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>room<span class="rainbow-delimiters-depth-5-face">)
           (</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-6-face">(</span>equal <span class="rainbow-delimiters-depth-7-face">(</span>plist-get room <span class="builtin">:room-name</span><span class="rainbow-delimiters-depth-7-face">)
                          (</span>plist-get it <span class="builtin">:room-name</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                   im-slack--last-messages<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack--message-ts</span> <span class="rainbow-delimiters-depth-2-face">(</span>message<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>plist-get message <span class="builtin">:message</span><span class="rainbow-delimiters-depth-3-face">)</span>
   slack-ts
   <span class="rainbow-delimiters-depth-3-face">(</span>s-split <span class="string">&quot;\\.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   car
   string-to-number<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-last-messages</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;List and open rooms that had new messages in them recently.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-slack--open-message-or-thread
   <span class="rainbow-delimiters-depth-3-face">(</span>im-completing-read
    <span class="string">&quot;Select message: &quot;</span>
    im-slack--last-messages
    <span class="builtin">:sort?</span> nil
    <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack--format-message</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:focus?</span> nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack--format-message</span> <span class="rainbow-delimiters-depth-2-face">(</span>it<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let-plist</span> it
    <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;%s (%s) - %s&quot;</span>
            <span class="rainbow-delimiters-depth-4-face">(</span>propertize .room-name <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:weight</span> bold <span class="builtin">:foreground</span> <span class="string">&quot;systemPinkColor&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span><span class="keyword">when</span> .message
              <span class="rainbow-delimiters-depth-5-face">(</span>propertize
               <span class="rainbow-delimiters-depth-6-face">(</span>lab--time-ago
                <span class="rainbow-delimiters-depth-7-face">(</span>im-slack--message-ts it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
               <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:slant</span> italic <span class="builtin">:foreground</span> <span class="string">&quot;systemGrayColor&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span>s-truncate 50 .message-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-last-messages-alternative</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-slack-last-messages</span><span class="doc">' but only show the last message per room.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>selected
         <span class="rainbow-delimiters-depth-5-face">(</span>im-completing-read
          <span class="string">&quot;Select room: &quot;</span>
          <span class="rainbow-delimiters-depth-6-face">(</span>im-slack-last-messages-per-room<span class="rainbow-delimiters-depth-6-face">)</span>
          <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-slack--format-message</span>
          <span class="builtin">:sort?</span> nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let-plist</span> selected
      <span class="rainbow-delimiters-depth-4-face">(</span>slack-room-display
       .room
       .team<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-send-message</span> <span class="rainbow-delimiters-depth-2-face">(</span>msg<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send given MSG or region as message to interactively selected user.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>text <span class="rainbow-delimiters-depth-8-face">(</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-9-face">(</span>region-beginning<span class="rainbow-delimiters-depth-9-face">) (</span>region-end<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>y-or-n-p <span class="string">&quot;Wrap with backticks? &quot;</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>format <span class="string">&quot;```\n%s\n```&quot;</span> text<span class="rainbow-delimiters-depth-7-face">)</span>
            text<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>read-string <span class="string">&quot;Enter message: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>room team<span class="rainbow-delimiters-depth-5-face">) (</span>im-slack--select-room<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>slack-message-send-internal
     msg room team<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-clipboard-image-upload</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Uploads png image from clipboard.

The default `</span><span class="constant">slack-clipboard-image-upload</span><span class="doc">' was not working
properly in MacOS.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-clipboard-contains-image-p<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="warning">user-error</span> <span class="string">&quot;No image in clipboard&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>file <span class="rainbow-delimiters-depth-5-face">(</span>make-temp-file <span class="string">&quot;clip&quot;</span> nil <span class="string">&quot;.png&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-save-clipboard-image-to-file file<span class="rainbow-delimiters-depth-3-face">)
    (</span>slack-file-upload file <span class="string">&quot;png&quot; &quot;image.png&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> multiple message quote
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-slack-quote-message</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>quote-text <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
                     <span class="rainbow-delimiters-depth-6-face">(</span>im-slack-current-message-content<span class="rainbow-delimiters-depth-6-face">)
                     (</span>substring-no-properties<span class="rainbow-delimiters-depth-6-face">)
                     (</span>s-trim<span class="rainbow-delimiters-depth-6-face">)
                     (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                     (</span>-drop 1<span class="rainbow-delimiters-depth-6-face">)
                     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>concat <span class="string">&quot;&gt; &quot;</span> it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                     (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                     (</span>s-append <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>slack-message-write-another-buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert quote-text<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-current-message-content</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">slack-if-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buf slack-current-buffer<span class="rainbow-delimiters-depth-4-face">)
                  (</span>team <span class="rainbow-delimiters-depth-5-face">(</span>slack-buffer-team buf<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                  (</span>room <span class="rainbow-delimiters-depth-5-face">(</span>slack-buffer-room buf<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                  (</span>message <span class="rainbow-delimiters-depth-5-face">(</span>slack-room-find-message room <span class="rainbow-delimiters-depth-6-face">(</span>slack-get-ts<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
      (</span>slack-message-to-string message team<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-open-link</span> <span class="rainbow-delimiters-depth-2-face">(</span>link<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Link: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>m <span class="rainbow-delimiters-depth-5-face">(</span>s-match
             <span class="string">&quot;https://</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.enterprise</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?.slack.com/archives/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">/p</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\?thread_ts=</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?&quot;</span>
             link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>team <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-6-face">(</span>string= <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">oref</span> it domain<span class="rainbow-delimiters-depth-7-face">) (</span>nth 1 m<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                       (</span>hash-table-values slack-teams-by-token<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>room <span class="rainbow-delimiters-depth-5-face">(</span>slack-room-find <span class="rainbow-delimiters-depth-6-face">(</span>nth 3 m<span class="rainbow-delimiters-depth-6-face">)</span> team<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>message-ts <span class="rainbow-delimiters-depth-5-face">(</span>number-to-string <span class="rainbow-delimiters-depth-6-face">(</span>/ <span class="rainbow-delimiters-depth-7-face">(</span>string-to-number <span class="rainbow-delimiters-depth-8-face">(</span>nth 4 m<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span> 1000000.0<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>message <span class="rainbow-delimiters-depth-5-face">(</span>slack-room-find-message room message-ts<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>thread <span class="rainbow-delimiters-depth-5-face">(</span>nth 5 m<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-slack--open-message-or-thread <span class="rainbow-delimiters-depth-4-face">(</span>list <span class="builtin">:message</span> message <span class="builtin">:room</span> room <span class="builtin">:team</span> team<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    thread<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-dms</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> data<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;List and open dms.
Get DMs and MPIMs from client.dms endpoint, sort them by time and
present to user.  This kind of guarantees the order that you see
in the DM section of the official Slack client.

Fetches missing channels/users first.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>team <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>slack-team-select<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> data
        <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>selected
                <span class="rainbow-delimiters-depth-7-face">(</span>im-completing-read
                 <span class="string">&quot;Select: &quot;</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--sort</span>
                  <span class="rainbow-delimiters-depth-9-face">(</span>&gt;
                   <span class="rainbow-delimiters-depth-1-face">(</span>string-to-number <span class="rainbow-delimiters-depth-2-face">(</span>plist-get <span class="rainbow-delimiters-depth-3-face">(</span>plist-get it <span class="builtin">:message</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="builtin">:ts</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                   (</span>string-to-number <span class="rainbow-delimiters-depth-2-face">(</span>plist-get <span class="rainbow-delimiters-depth-3-face">(</span>plist-get other <span class="builtin">:message</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="builtin">:ts</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                  (</span>append
                   <span class="rainbow-delimiters-depth-1-face">(</span>plist-get data <span class="builtin">:mpims</span><span class="rainbow-delimiters-depth-1-face">)
                   (</span>plist-get data <span class="builtin">:ims</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                 <span class="builtin">:sort?</span> nil
                 <span class="builtin">:formatter</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>it<span class="rainbow-delimiters-depth-9-face">)
                   (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>room-name <span class="rainbow-delimiters-depth-3-face">(</span>slack-room-name <span class="rainbow-delimiters-depth-4-face">(</span>slack-room-find <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:id</span><span class="rainbow-delimiters-depth-5-face">)</span> team<span class="rainbow-delimiters-depth-4-face">)</span> team<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                         (</span>text <span class="rainbow-delimiters-depth-3-face">(</span>plist-get <span class="rainbow-delimiters-depth-4-face">(</span>plist-get it <span class="builtin">:message</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="builtin">:text</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                     (</span>format <span class="string">&quot;%s (%s) - %s&quot;</span>
                             <span class="rainbow-delimiters-depth-2-face">(</span>propertize room-name <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:weight</span> bold <span class="builtin">:foreground</span> <span class="string">&quot;systemPinkColor&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                             (</span>propertize
                              <span class="rainbow-delimiters-depth-3-face">(</span>lab--time-ago
                               <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">-&gt;&gt;</span>
                                <span class="rainbow-delimiters-depth-5-face">(</span>plist-get <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:message</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="builtin">:ts</span><span class="rainbow-delimiters-depth-5-face">)
                                (</span>s-split <span class="string">&quot;\\.&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
                                car
                                string-to-number<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
                              <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:slant</span> italic <span class="builtin">:foreground</span> <span class="string">&quot;systemGrayColor&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                             (</span>s-truncate 50 text<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>slack-room-display
           <span class="rainbow-delimiters-depth-6-face">(</span>slack-room-find <span class="rainbow-delimiters-depth-7-face">(</span>plist-get selected <span class="builtin">:id</span><span class="rainbow-delimiters-depth-7-face">)</span> team<span class="rainbow-delimiters-depth-6-face">)</span>
           team<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>slack-request
       <span class="rainbow-delimiters-depth-5-face">(</span>slack-request-create
        <span class="string">&quot;https://slack.com/api/client.dms?count=250&quot;</span>
        team
        <span class="builtin">:success</span>
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">cl-function</span>
         <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="type">&amp;key</span> data <span class="type">&amp;allow-other-keys</span><span class="rainbow-delimiters-depth-8-face">)
           (</span><span class="keyword">ignore-error</span> <span class="rainbow-delimiters-depth-9-face">(</span>quit minibuffer-quit<span class="rainbow-delimiters-depth-9-face">)
             (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>user-ids
                     <span class="rainbow-delimiters-depth-3-face">(</span>append
                      <span class="rainbow-delimiters-depth-4-face">(</span>-non-nil <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:message</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:user</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get data <span class="builtin">:ims</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                      (</span>-non-nil <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:message</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:user</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get data <span class="builtin">:mpims</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                    (</span>missing-user-ids <span class="rainbow-delimiters-depth-3-face">(</span>slack-team-missing-user-ids <span class="rainbow-delimiters-depth-4-face">(</span>slack-team-select<span class="rainbow-delimiters-depth-4-face">)</span> user-ids<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                    (</span>channels <span class="rainbow-delimiters-depth-3-face">(</span>append
                               <span class="rainbow-delimiters-depth-4-face">(</span>-non-nil <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:id</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get data <span class="builtin">:ims</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                               (</span>-non-nil <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:id</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get data <span class="builtin">:mpims</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                    (</span>missing-channel-ids <span class="rainbow-delimiters-depth-3-face">(</span>-non-nil <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>slack-room-find it <span class="rainbow-delimiters-depth-7-face">(</span>slack-team-select<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> nil it<span class="rainbow-delimiters-depth-5-face">)</span> channels<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                    (</span>missing-users? <span class="rainbow-delimiters-depth-3-face">(</span>&gt; <span class="rainbow-delimiters-depth-4-face">(</span>length missing-user-ids<span class="rainbow-delimiters-depth-4-face">)</span> 0<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                    (</span>missing-channels? <span class="rainbow-delimiters-depth-3-face">(</span>&gt; <span class="rainbow-delimiters-depth-4-face">(</span>length missing-channel-ids<span class="rainbow-delimiters-depth-4-face">)</span> 0<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
               (</span><span class="keyword">cond</span>
                <span class="rainbow-delimiters-depth-2-face">(</span>missing-users?
                 <span class="rainbow-delimiters-depth-3-face">(</span>message <span class="string">&quot;&gt;&gt; Some people are missing: %s, loading...&quot;</span> missing-user-ids<span class="rainbow-delimiters-depth-3-face">)
                 (</span>slack-user-info-request
                  missing-user-ids
                  team <span class="builtin">:after-success</span>
                  <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
                    (</span>message <span class="string">&quot;&gt;&gt; Some people are missing: %s, loading...Done&quot;</span> missing-user-ids<span class="rainbow-delimiters-depth-5-face">)
                    (</span>im-slack-dms data<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                (</span>missing-channels?
                 <span class="rainbow-delimiters-depth-3-face">(</span>message <span class="string">&quot;&gt;&gt; Some channels are missing: %s, loading...&quot;</span> missing-channel-ids<span class="rainbow-delimiters-depth-3-face">)
                 (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>finished-count 0<span class="rainbow-delimiters-depth-5-face">)
                        (</span>cb <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">()
                              (</span><span class="keyword">setq</span> finished-count <span class="rainbow-delimiters-depth-8-face">(</span>1+ finished-count<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                              (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>length= missing-channel-ids finished-count<span class="rainbow-delimiters-depth-8-face">)
                                (</span>message <span class="string">&quot;&gt;&gt; Some channels are missing: %s, loading...Done&quot;</span> missing-channel-ids<span class="rainbow-delimiters-depth-8-face">)
                                (</span>im-slack-dms data<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                   (</span><span class="keyword">--each</span> missing-channel-ids
                     <span class="rainbow-delimiters-depth-5-face">(</span>slack-conversations-info
                      it
                      team
                      <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">() (</span>funcall cb<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                (</span>t <span class="rainbow-delimiters-depth-3-face">(</span>im-slack-dms data<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack-select-room</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">slack-select-rooms</span><span class="doc">' but disable sorting.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>team <span class="rainbow-delimiters-depth-5-face">(</span>slack-team-select<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>alist <span class="rainbow-delimiters-depth-5-face">(</span>slack-room-names
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">cl-loop</span> for team in <span class="rainbow-delimiters-depth-7-face">(</span>list team<span class="rainbow-delimiters-depth-7-face">)</span>
                          append <span class="rainbow-delimiters-depth-7-face">(</span>append <span class="rainbow-delimiters-depth-8-face">(</span>slack-team-ims team<span class="rainbow-delimiters-depth-8-face">)
                                         (</span>slack-team-groups team<span class="rainbow-delimiters-depth-8-face">)
                                         (</span>slack-team-channels team<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                 team
                 <span class="highlight-quoted-quote">#'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>rs<span class="rainbow-delimiters-depth-7-face">)
                     (</span>cl-remove-if
                      <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>it<span class="rainbow-delimiters-depth-9-face">)
                        (</span>slack-room-hidden-p it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                      rs<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>slack-room-display
     <span class="rainbow-delimiters-depth-4-face">(</span>cdr <span class="rainbow-delimiters-depth-5-face">(</span>im-completing-read <span class="string">&quot;Select: &quot;</span> alist <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span> <span class="builtin">:sort?</span> nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     team<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Utils/internals
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-slack--last-message</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-3-face">(</span>not <span class="rainbow-delimiters-depth-4-face">(</span>s-matches? <span class="string">&quot;.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">alert</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">practice</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">.*&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:room-name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> im-slack--last-messages<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack--stringify-message</span> <span class="rainbow-delimiters-depth-2-face">(</span>msg<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>message <span class="rainbow-delimiters-depth-5-face">(</span>plist-get msg <span class="builtin">:message</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>team <span class="rainbow-delimiters-depth-5-face">(</span>plist-get msg <span class="builtin">:team</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>slack-message-to-alert message team<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-slack--select-room</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Select interactively and return (room team) pair.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>team <span class="rainbow-delimiters-depth-5-face">(</span>slack-team-select<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>room <span class="rainbow-delimiters-depth-5-face">(</span>slack-room-select
                <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">cl-loop</span> for team in <span class="rainbow-delimiters-depth-7-face">(</span>list team<span class="rainbow-delimiters-depth-7-face">)</span>
                         append <span class="rainbow-delimiters-depth-7-face">(</span>append <span class="rainbow-delimiters-depth-8-face">(</span>slack-team-ims team<span class="rainbow-delimiters-depth-8-face">)
                                        (</span>slack-team-groups team<span class="rainbow-delimiters-depth-8-face">)
                                        (</span>slack-team-channels team<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                team<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>list room team<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>slack-message-buffer-mode-map slack-thread-message-buffer-mode-map slack-all-threads-buffer-mode-map<span class="rainbow-delimiters-depth-2-face">)</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>normal motion<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-quit</span>

  <span class="string">&quot;@&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-embed-mention</span>
  <span class="string">&quot;mc&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-embed-channel</span>
  <span class="string">&quot;mm&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-write-another-buffer</span>
  <span class="string">&quot;md&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-delete</span>
  <span class="string">&quot;my&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-copy-link</span>
  <span class="string">&quot;ml&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-copy-link</span>
  <span class="string">&quot;me&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-edit</span>
  <span class="string">&quot;mt&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-thread-show-or-create</span>
  <span class="string">&quot;mq&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-slack-quote-message</span>
  <span class="string">&quot;mi&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-display-user-profile-info</span>
  <span class="string">&quot;mj&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-thread-message-buffer-jump-to-channel-buffer</span>

  <span class="string">&quot;mrr&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-add-reaction</span>
  <span class="string">&quot;mR&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-message-remove-reaction</span>
  <span class="string">&quot;mrs&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;seen&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mr1&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;+1&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mr2&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;ok_hand&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mr3&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;eyes&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mr4&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;ultrafastparrot&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mr5&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;pepedance&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mrp&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;prayge&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mrh&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;handshake&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;mrl&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-slack--add-reaction-to-message <span class="string">&quot;pepe-love&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="string">&quot;[[&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-buffer-goto-prev-message</span>
  <span class="string">&quot;]]&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">slack-buffer-goto-next-message</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> prodigy
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">prodigy</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;rejeep/prodigy.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . im-prodigy-autostart<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;et&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> prodigy-mode-map
    <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-quit</span>
    <span class="string">&quot;m&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-mark</span>
    <span class="string">&quot;u&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-unmark</span>
    <span class="string">&quot;x&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-stop</span>
    <span class="string">&quot;S&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-start</span>
    <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-restart</span>
    <span class="string">&quot;R&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-refresh</span>
    <span class="string">&quot;f&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-jump-file-manager</span>
    <span class="string">&quot;M&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-jump-magit</span>
    <span class="string">&quot;t&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-add-tag-filter</span>
    <span class="string">&quot;T&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-clear-filters</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;RET&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">prodigy-display-process</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>prodigy-define-service
  <span class="builtin">:name</span> <span class="string">&quot;kmonad - keyboard remapper&quot;</span>
  <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="string">&quot;~/workspace/apps/kmonad/result/bin/kmonad&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:args</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>x y<span class="rainbow-delimiters-depth-3-face">)
          (</span><span class="keyword">-&gt;&gt;</span>
           <span class="rainbow-delimiters-depth-4-face">(</span>format
            <span class="string">&quot;~/.config/kmonad-%s&quot;</span>
            <span class="rainbow-delimiters-depth-5-face">(</span>completing-read
             <span class="string">&quot;Which configuration?&quot;</span>
             <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-chop-left 7 it<span class="rainbow-delimiters-depth-7-face">) (</span>directory-files <span class="string">&quot;~/.config/&quot;</span> nil <span class="string">&quot;kmonad-.*&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
           (</span>expand-file-name<span class="rainbow-delimiters-depth-4-face">)
           (</span>list<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:sudo</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-prodigy-autostart</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Start all services with the `</span><span class="constant">:auto-start</span><span class="doc">' set to non-nil if they are not already started.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">prodigy-with-refresh</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--each</span>
       prodigy-services
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:auto-start</span><span class="rainbow-delimiters-depth-6-face">)
                (</span>not <span class="rainbow-delimiters-depth-7-face">(</span>prodigy-service-started-p it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>prodigy-start-service it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> separaedit -- edit comment blocks/multiline strings etc. indirectly
</span>
<span class="comment-delimiter">;; </span><span class="comment">Pop current comment section OR a multiline string into a markdown
</span><span class="comment-delimiter">;; </span><span class="comment">buffer and edit it there. Pretty useful for writing long
</span><span class="comment-delimiter">;; </span><span class="comment">comments/strings.
</span>
<span class="comment-delimiter">;; </span><span class="comment">It also supports editing code blocks inside comment blocks in their
</span><span class="comment-delimiter">;; </span><span class="comment">language, like
</span><span class="comment-delimiter">;; </span><span class="comment">```c
</span><span class="comment-delimiter">;; </span><span class="comment">int main () {
</span><span class="comment-delimiter">;;    </span><span class="comment">int x = 3; // Do M-x `</span><span class="constant">separedit</span><span class="comment">' here.
</span><span class="comment-delimiter">;; </span><span class="comment">}
</span><span class="comment-delimiter">;; </span><span class="comment">```
</span>
<span class="comment-delimiter">;; </span><span class="comment">If the code block does not have a language marker, then it's
</span><span class="comment-delimiter">;; </span><span class="comment">assumed to be in the same language of the buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">```
</span><span class="comment-delimiter">;; </span><span class="comment">(progn
</span><span class="comment-delimiter">;;   </span><span class="comment">(+ 1 2))
</span><span class="comment-delimiter">;; </span><span class="comment">```
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">separedit</span>
  <span class="comment-delimiter">;; </span><span class="comment">C-u separedit → Let's you select the editing mode first.
</span>  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;gm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">separedit</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-mode-map</span>
   <span class="string">&quot;M-r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">separedit</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> separedit-default-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">markdown-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> separedit-continue-fill-column t<span class="rainbow-delimiters-depth-2-face">)
  (</span>advice-add
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">separedit--select-mode</span>
   <span class="builtin">:override</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>completing-read <span class="string">&quot;Select major mode: &quot;</span> obarray
                      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>x<span class="rainbow-delimiters-depth-6-face">)
                        (</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-7-face">(</span>fboundp x<span class="rainbow-delimiters-depth-7-face">)
                             (</span>commandp x<span class="rainbow-delimiters-depth-7-face">)
                             (</span>string-match <span class="string">&quot;-mode$&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>symbol-name x<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                      t
                      nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">separedit--mode-history</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>car separedit--mode-history<span class="rainbow-delimiters-depth-6-face">)
                                                       (</span>format <span class="string">&quot;%s&quot;</span> major-mode<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> all-the-icons
</span>
<span class="comment-delimiter">;; </span><span class="comment">You should run =all-the-icons-install-fonts= command after
</span><span class="comment-delimiter">;; </span><span class="comment">this. Also run =fc-cache -f -v= afterwards
</span><span class="comment-delimiter">;; </span><span class="comment">(=all-the-icons-install-fonts= already does that but it may fail).
</span><span class="comment-delimiter">;; </span><span class="comment">=all-the-icons-completion= gives you icons in completion UI, like
</span><span class="comment-delimiter">;; </span><span class="comment">in =completing-read= etc.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">all-the-icons</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">use-package</span> <span class="constant">all-the-icons-completion</span>
  <span class="builtin">:after</span> <span class="rainbow-delimiters-depth-2-face">(</span>all-the-icons vertico<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>all-the-icons-completion-mode +1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> reddigg and hnreader -- org-mode interface for reddit and hacernews
</span>
<span class="comment-delimiter">;; </span><span class="comment">These packages lets me display comments of given reddit/hn thread
</span><span class="comment-delimiter">;; </span><span class="comment">in an org buffer.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Also see `</span><span class="constant">browse-url-handlers</span><span class="comment">' configuration to see how I utilize
</span><span class="comment-delimiter">;; </span><span class="comment">these packages.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">reddigg</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/emacs-reddigg&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> reddigg-convert-md-to-org t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">hnreader</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> jq-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">A mode for editing ~jq~ scripts. Mostly using it for ~jq-interactively~ function which enables you to write a jq query and update the buffer accordingly in real time.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">jq-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.jq\\'&quot;</span>
  <span class="builtin">:commands</span> jq-interactively<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> imenu-list
</span>
<span class="comment-delimiter">;; </span><span class="comment">You can also do ~consult-imenu~ and ~embark-collect~ but it does not have a refresh feature.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">imenu-list</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;il&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">imenu-list</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> wolfram
</span>
<span class="comment-delimiter">;; </span><span class="comment">Easy way to interact with WolframAlpha. I generally use it for unit conversions or stuff like that.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">wolfram</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;hsjunnesson/wolfram.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span> <span class="string">&quot;iw&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">wolfram-alpha</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> wolfram-alpha-app-id im-wolfram-alpha-app-id<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-ai &amp; im-ai -- interactions with LLMs
</span>
<span class="comment-delimiter">;; </span><span class="comment">There are bunch of Emacs-ChatGPT integrations and org-ai seems to
</span><span class="comment-delimiter">;; </span><span class="comment">be best as it fits my workflow quite well. Besides being useful in
</span><span class="comment-delimiter">;; </span><span class="comment">org-mode, it also has org-mode independent features.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">org-ai</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;rksm/org-ai&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>org-mode . org-ai-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-ai-default-chat-model <span class="string">&quot;gpt-4o&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-ai-default-max-tokens 2000<span class="rainbow-delimiters-depth-2-face">)
  (</span>org-ai-default-chat-system-prompt <span class="string">&quot;You're an helpful assistant designed to provide helpful, accurate, and concise responses. Your primary focus should be on delivering quick and clear solutions, especially for programming-related queries. Focus on providing quick, clear solutions. When appropriate, offer additional insights, alternative approaches (such as using standard functions over ad-hoc implementations), or different perspectives to enhance user understanding or outcomes along with the original solution. Keep replies relevant, to the point, and free from unnecessary explanations or obvious/elementary information.&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-ai-chat-models</span> <span class="string">&quot;gpt-4o-mini&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">im-ai</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-ai-file <span class="string">&quot;~/Documents/notes/extra/gpt.org&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader-v</span>
    <span class="string">&quot;eg&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-ai</span>
    <span class="string">&quot;sl&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-ai-lookup</span>
    <span class="string">&quot;sa&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-ai-snippet</span>
    <span class="string">&quot;sA&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-ai-snippet-superior</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> gptel
</span>
<span class="comment-delimiter">;; </span><span class="comment">Seems more capable than org-ai. Probably going to replace org-ai
</span><span class="comment-delimiter">;; </span><span class="comment">with this in the long run.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- Supports images etc.
</span><span class="comment-delimiter">;; </span><span class="comment">- Automatically converts markdown responses to org syntax on the fly,
</span><span class="comment-delimiter">;; </span><span class="comment">- Very easy to add/delete context.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Use &lt;file:...&gt; syntax to include media files in the prompt. Should
</span><span class="comment-delimiter">;; </span><span class="comment">be in a single line.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">* Commands
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- ~gptel~                     → Start a dedicated chat buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~gptel-add~                 → Add to context DWIM
</span><span class="comment-delimiter">;; </span><span class="comment">- ~gptel-send~                → Send current region as prompt and insert the result.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~C-u gptel-send~            → Edit stuff before sending prompt.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Inside a gptel buffer:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- ~C-u C-x RET~ or ~gptel-menu~ → Menu
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">gptel</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> gptel-default-mode <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> gptel-track-media t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> gptel-prompt-prefix-alist <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>org-mode . <span class="string">&quot;[ME]: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> gptel-response-prefix-alist <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>org-mode . <span class="string">&quot;[AI]: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tmr.el -- timers, reminders etc.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Pretty timers. I forget everything, so it's quite important for me
</span><span class="comment-delimiter">;; </span><span class="comment">to have a quick way to define timers. I was using ~appt-add~ for
</span><span class="comment-delimiter">;; </span><span class="comment">this before but it does not let you view/manipulate upcoming timers
</span><span class="comment-delimiter">;; </span><span class="comment">easily and tmr does this very well with ~tmr-tabulated-view~.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- tmr :: To quickly define a timer, without any description.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- tmr-with-details :: Define a timer with description, also asks if
</span><span class="comment-delimiter">;;   </span><span class="comment">you need acknowledgment. Acknowledgment is useful in a sense that
</span><span class="comment-delimiter">;;   </span><span class="comment">you can re-schedule the timer if you need it. It will ask you to
</span><span class="comment-delimiter">;;   </span><span class="comment">write ~ack~ when the time is up, if you are not ready, you can
</span><span class="comment-delimiter">;;   </span><span class="comment">re-schedule the timer with the same notation you use while
</span><span class="comment-delimiter">;;   </span><span class="comment">creating it which is super convenient.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">tmr</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>tmr--parse-duration<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;T&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tmr-with-details</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Replace the notification function so that it works on my Mac
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>remove-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tmr-timer-finished-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tmr-notification-notify</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Acknowledge using the GUI dialog as it requires mouse which makes
</span>  <span class="comment-delimiter">;; </span><span class="comment">me more conscious (and also works when emacs is unfocued)
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>remove-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tmr-timer-finished-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tmr-acknowledge-minibuffer</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tmr-timer-finished-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tmr-ack</span> 90<span class="rainbow-delimiters-depth-2-face">)

  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tmr-timer-finished-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tmr-notify</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> tmr-sound-file <span class="string">&quot;/System/Library/Sounds/Glass.aiff&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">evilify
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>define-key tmr-tabulated-mode-map <span class="string">&quot;j&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">next-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key tmr-tabulated-mode-map <span class="string">&quot;k&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">previous-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key tmr-tabulated-mode-map <span class="string">&quot;x&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tmr-remove</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>define-key tmr-tabulated-mode-map <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tmr-remove</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tmr-tabulated-mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Show upcoming timers in global-mode-string
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> global-mode-string <span class="rainbow-delimiters-depth-3-face">(</span>append global-mode-string <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>im-tmr-upcoming-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>run-with-timer 1 15 <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tmr-format-upcoming</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tmr-ack</span> <span class="rainbow-delimiters-depth-2-face">(</span>timer<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>tmr--timer-acknowledgep timer<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-force-focus-emacs<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Doing jk escapes the acknowledge dialog, so I disable it here
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>evil-escape-inhibit t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>tmr-acknowledge-minibuffer timer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tmr-notify</span> <span class="rainbow-delimiters-depth-2-face">(</span>timer<span class="rainbow-delimiters-depth-2-face">)
  (</span>alert
   <span class="rainbow-delimiters-depth-3-face">(</span>tmr--long-description-for-finished-timer timer<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:title</span> <span class="string">&quot;TMR&quot;</span>
   <span class="comment-delimiter">;; </span><span class="comment">TMR events are high priority for me
</span>   <span class="builtin">:severity</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">high</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-tmr-upcoming-string</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span>put <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-tmr-upcoming-string</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">risky-local-variable</span> t<span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">This is required to make propertize work
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-tmr-format-upcoming</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">setq</span>
   im-tmr-upcoming-string
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-some-&gt;&gt;</span>
       tmr--timers
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>not <span class="rainbow-delimiters-depth-7-face">(</span>tmr--timer-finishedp it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>remaining <span class="rainbow-delimiters-depth-9-face">(</span>- <span class="rainbow-delimiters-depth-1-face">(</span>float-time <span class="rainbow-delimiters-depth-2-face">(</span>tmr--timer-end-date it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                                        (</span>float-time<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                      (</span>&lt;= remaining 300<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s (%s)&quot;</span>
                    <span class="rainbow-delimiters-depth-6-face">(</span>propertize <span class="rainbow-delimiters-depth-7-face">(</span>tmr--timer-description it<span class="rainbow-delimiters-depth-7-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">underline</span><span class="rainbow-delimiters-depth-6-face">)
                    (</span>propertize <span class="rainbow-delimiters-depth-7-face">(</span>tmr--format-remaining it<span class="rainbow-delimiters-depth-7-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">italic</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>s-join <span class="string">&quot;, &quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>s-prepend <span class="string">&quot; «&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>s-append <span class="string">&quot;» &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>force-mode-line-update t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> lab.el -- gitlab integration
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">lab</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/lab.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>lab--git lab--time-ago lab-git-clone lab-current-branch lab-git-origin-switch-to-ssh<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;gmb&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-list-branch-merge-requests</span>
    <span class="string">&quot;gmm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-list-my-merge-requests</span>
    <span class="string">&quot;gma&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-list-group-merge-requests</span>
    <span class="string">&quot;gmp&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-list-project-merge-requests</span>
    <span class="string">&quot;gmc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lab-create-merge-request</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="comment-delimiter">;; </span><span class="comment">Add advices for automatically starting to watch pipelines
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">magit</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">define-advice</span> <span class="function-name">magit-push-current-to-pushremote</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)</span> start-watching-pipeline<span class="rainbow-delimiters-depth-4-face">)
      (</span>lab-watch-pipeline-for-last-commit<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vc</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">define-advice</span> <span class="function-name">vc-push</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)</span> start-watching-pipeline<span class="rainbow-delimiters-depth-4-face">)
      (</span>lab-watch-pipeline-for-last-commit<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Automatically refresh projects list after cloning a project
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lab-after-git-clone-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-load-projects-list</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">And jump to that project
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lab-after-git-clone-functions</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>dired default-directory<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> lab-projects-directory im-projects-root<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lab-pipeline-watcher-initial-delay 30<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lab-pipeline-watcher-debounce-time 15<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lab-host ty-gitlab-url<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lab-token ty-gitlab-token<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lab-group ty-gitlab-group<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> lab-should-open-pipeline-on-manual-action? t<span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">midnight-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-update-all-projects</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-update-all-projects</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>lab-pull-bulk <span class="rainbow-delimiters-depth-3-face">(</span>lab-all-project-roots im-projects-root<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Can't get all group projects async right now
</span>  <span class="comment-delimiter">;; </span><span class="comment">(lab-get-all-group-projects-async :on-success ))
</span>  <span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">I also have an experimental GitHub version, tailored for more
</span><span class="comment-delimiter">;; </span><span class="comment">open-source work needs instead of regular stuff.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">im-github</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>lab-github-issue-at-point lab-github-issue-view org-dblock-write:github-issues<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>lab-github-view-repo-readme<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-open-thing-at-point-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>lab-github-issue-at-point . lab-github-open-issue<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> swagg.el -- Swagger UI
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">swagg</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/swagg.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;us&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">swagg-request-with-rest-block</span>
    <span class="string">&quot;uS&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">swagg-request</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> swagg-rest-block-org-header-tags <span class="string">&quot;verb&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> swagg-fetch-lang <span class="string">&quot;deno :allow net&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> whisper -- Recording and transcribing audio locally
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">whisper</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;natrys/whisper.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:bind</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;C-M-r&quot;</span> . whisper-run<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> whisper-install-directory <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name <span class="string">&quot;~/Workspace/apps/whisper/&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
        whisper-model <span class="string">&quot;small&quot;</span>
        whisper-language <span class="string">&quot;en&quot;</span>
        whisper-translate nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">define-advice</span> <span class="function-name">whisper-run</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:before</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-3-face">)</span> set-microphone<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> whisper--ffmpeg-input-device
    <span class="rainbow-delimiters-depth-3-face">(</span>im-whisper-select-microphone<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-whisper-select-microphone</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span>
   whisper--ffmpeg-input-device
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-output-select</span>
     <span class="builtin">:prompt</span> <span class="string">&quot;Select mic: &quot;</span>
     <span class="builtin">:cmd</span> <span class="string">&quot;/opt/homebrew/bin/ffmpeg -f avfoundation -list_devices true -i ''&quot;</span>
     <span class="builtin">:keep-order</span> t
     <span class="builtin">:filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;[AVFound&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>s-match <span class="string">&quot;\\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]&quot;</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>nth 1<span class="rainbow-delimiters-depth-4-face">)
    (</span>s-prepend <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> osm -- OpenStreetMaps in Emacs
</span>
<span class="comment-delimiter">;; </span><span class="comment">Very cool and the nice thing is it integrates itself with the built-in bookmarking system. So you can bookmark places (or store them as org links) and jump to them whenever needed.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">osm</span>
  <span class="builtin">:general</span>
  <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Maybe add this to evil-collection
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">osm-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="comment-delimiter">;; </span><span class="comment">Navigation
</span>   <span class="string">&quot;h&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-left</span>
   <span class="string">&quot;l&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-right</span>
   <span class="string">&quot;j&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-down</span>
   <span class="string">&quot;k&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-up</span>
   <span class="string">&quot;H&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-left-left</span>
   <span class="string">&quot;L&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-right-right</span>
   <span class="string">&quot;J&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-down-down</span>
   <span class="string">&quot;K&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-up-up</span>
   <span class="comment-delimiter">;; </span><span class="comment">Positioning
</span>   <span class="string">&quot;+&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-zoom-in</span>
   <span class="string">&quot;-&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-zoom-out</span>
   <span class="string">&quot;c&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-center</span>
   <span class="string">&quot;g&quot;</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-home</span>
   <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">revert-buffer</span>
   <span class="comment-delimiter">;; </span><span class="comment">Url
</span>   <span class="string">&quot;u&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-save-url</span>
   <span class="string">&quot;y&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-store-link</span>
   <span class="comment-delimiter">;; </span><span class="comment">Other
</span>   <span class="string">&quot;s&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-search</span>
   <span class="string">&quot;X&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">osm-gpx-hide</span>
   <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">quit-window</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>osm-server <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">default</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>osm-copyright nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">osm-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-line-wrapping</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> reveal-in-finder
</span>
<span class="comment-delimiter">;; </span><span class="comment">Well, sometimes you need to open that pesky program.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">reveal-in-osx-finder</span>
  <span class="builtin">:if</span> <span class="rainbow-delimiters-depth-2-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> xwidget-webkit &amp; xwwp
</span>
<span class="comment-delimiter">;; </span><span class="comment">Dependency of xwwp
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">ctable</span>
  <span class="builtin">:after</span> xwwp
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;kiwanami/emacs-ctable&quot;</span>  <span class="builtin">:files</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:defaults</span> <span class="string">&quot;*.el&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">xwwp</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;kchanqvq/xwwp&quot;</span>  <span class="builtin">:files</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:defaults</span> <span class="string">&quot;*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>xwwp<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xwidget-webkit-mode-map</span>
   <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;f&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xwwp-ace-toggle</span>
   <span class="string">&quot;b&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-collection-xwidget-webkit-search-tabs</span>
   <span class="string">&quot;o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xwwp</span>
   <span class="string">&quot;O&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xwidget-webkit-browse-url</span>
   <span class="string">&quot;i&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xwidget-webkit-insert-string</span>
   <span class="string">&quot;e&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xwidget-webkit-edit-mode</span>
   <span class="string">&quot;v&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-xwidget-webkit-visual-mode</span>
   <span class="string">&quot;&lt;f2&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-xwidget-webkit-open-in-eww</span>
   <span class="string">&quot;&lt;f3&gt;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>browse-url <span class="rainbow-delimiters-depth-5-face">(</span>xwidget-webkit-uri <span class="rainbow-delimiters-depth-6-face">(</span>xwidget-webkit-current-session<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;&lt;f4&gt;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-4-face">(</span>browse-url-default-browser <span class="rainbow-delimiters-depth-5-face">(</span>xwidget-webkit-uri <span class="rainbow-delimiters-depth-6-face">(</span>xwidget-webkit-current-session<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-xwidget-setup<span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">xwwp-full</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> xwidget-webkit-buffer-name-format <span class="string">&quot;*webkit: %T*&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> xwidget-webkit-cookie-file <span class="string">&quot;~/.cache/emacs-webkit-cookies&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">define-advice</span> <span class="function-name">xwidget-webkit-begin-edit-textarea</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-3-face">)</span> fix<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Now doing `C-c C-c' sends the text to webkit.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-current-buffer</span> <span class="string">&quot;textarea&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>use-local-map <span class="rainbow-delimiters-depth-4-face">(</span>copy-keymap text-mode-map<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>local-set-key <span class="rainbow-delimiters-depth-4-face">(</span>kbd <span class="string">&quot;C-c C-c&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xwidget-webkit-end-edit-textarea</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">define-advice</span> <span class="function-name">xwidget-webkit-end-edit-textarea</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-3-face">)</span> fix<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;The textarea buffer is not needed anymore.
Also this is required for the above advice to work.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kill-buffer <span class="string">&quot;textarea&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: scroll to the same section that is open in webkit
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-xwidget-webkit-visual-mode</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Gather the page source, render it with `</span><span class="constant">shr</span><span class="doc">' and display it.
This is a simple trick for being able to easily copy stuff from
the page without using mouse.  Instead of opening the same url
with `</span><span class="constant">eww</span><span class="doc">' (for that, see `</span><span class="constant">im-xwidget-webkit-open-in-eww</span><span class="doc">') we
directly render the current pages HTML to be able to get all the
pages content. Otherwise `</span><span class="constant">eww</span><span class="doc">' might fail to render what we need
due to lack of JavaScript support or maybe there is a required
login process that you can't do in `</span><span class="constant">eww</span><span class="doc">' etc..&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>title <span class="rainbow-delimiters-depth-5-face">(</span>xwidget-webkit-title <span class="rainbow-delimiters-depth-6-face">(</span>xwidget-webkit-current-session<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>xwidget-webkit-execute-script
     <span class="rainbow-delimiters-depth-4-face">(</span>xwidget-webkit-current-session<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;document.documentElement.outerHTML&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>document<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">save-window-excursion</span>
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-7-face">(</span>get-buffer-create <span class="string">&quot;*im-xwidget-webkit-html*&quot;</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>erase-buffer<span class="rainbow-delimiters-depth-7-face">)
           (</span>insert document<span class="rainbow-delimiters-depth-7-face">)
           (</span>shr-render-buffer <span class="rainbow-delimiters-depth-8-face">(</span>current-buffer<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>switch-to-buffer <span class="string">&quot;*html*&quot;</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>rename-buffer <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;*webkit-visual: %s*&quot;</span> title<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">define-advice</span> <span class="function-name">xwidget-at</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:around</span> <span class="rainbow-delimiters-depth-3-face">(</span>original <span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-3-face">)</span> handle-errors<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Sometimes `</span><span class="constant">xwidget-at</span><span class="doc">' fails for no real reason, this fixes that.
This happens to me on org-buffers, xwidget-at tries to get
  `</span><span class="constant">display</span><span class="doc">' property of `</span><span class="constant">point-min</span><span class="doc">' but this fails&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">ignore-errors</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>apply original args<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: I haven't figured out what to do with `</span><span class="constant">im-apply-patch-from-src-block</span><span class="comment">' after migrating from org-mode based config.
</span><span class="comment-delimiter">;; </span><span class="comment">I made some changes to xwwp to make it work.
</span><span class="comment-delimiter">;; </span><span class="comment">[[elisp:(im-apply-patch-from-src-block &quot;xwwp-patch&quot; (f-join straight-base-dir &quot;straight/repos/xwwp&quot;))][Apply the following patch]]:
</span>
<span class="comment-delimiter">;; </span><span class="comment">diff --git a/xwwp-history.el b/xwwp-history.el
</span><span class="comment-delimiter">;; </span><span class="comment">index 29afa20..6e311af 100644
</span><span class="comment-delimiter">;; </span><span class="comment">--- a/xwwp-history.el
</span><span class="comment-delimiter">;; </span><span class="comment">+++ b/xwwp-history.el
</span><span class="comment-delimiter">;; </span><span class="comment">@@ -65,7 +65,7 @@
</span><span class="comment-delimiter">;; </span><span class="comment">(existed (gethash url xwwp-history-table)))
</span><span class="comment-delimiter">;; </span><span class="comment">(when existed
</span><span class="comment-delimiter">;;   </span><span class="comment">(setq item existed)
</span><span class="comment-delimiter">;;   </span><span class="comment">-      (incf (xwwp-history-item-visit-count existed)))
</span><span class="comment-delimiter">;; </span><span class="comment">+      (cl-incf (xwwp-history-item-visit-count existed)))
</span><span class="comment-delimiter">;; </span><span class="comment">(puthash url item xwwp-history-table)
</span><span class="comment-delimiter">;; </span><span class="comment">(when existed
</span><span class="comment-delimiter">;;   </span><span class="comment">(setq xwwp-history-visualization-list
</span><span class="comment-delimiter">;;         </span><span class="comment">@@ -160,6 +160,9 @@
</span><span class="comment-delimiter">;;         </span><span class="comment">&quot;&quot;
</span><span class="comment-delimiter">;;         </span><span class="comment">(cond
</span><span class="comment-delimiter">;;          </span><span class="comment">((eq xwwp-follow-link-completion-system 'default)
</span><span class="comment-delimiter">;;           </span><span class="comment">-    (completing-read prompt xwwp-history-completion-list nil nil default))
</span><span class="comment-delimiter">;;          </span><span class="comment">+    (let ((result (completing-read prompt xwwp-history-completion-list nil nil default)))
</span><span class="comment-delimiter">;;                 </span><span class="comment">+      (if-let (data (assoc result xwwp-history-completion-list #'equal))
</span><span class="comment-delimiter">;;                            </span><span class="comment">+          (cdr data)
</span><span class="comment-delimiter">;;                            </span><span class="comment">+        result)))
</span><span class="comment-delimiter">;;         </span><span class="comment">((eq xwwp-follow-link-completion-system 'helm)
</span><span class="comment-delimiter">;;          </span><span class="comment">(helm :sources
</span><span class="comment-delimiter">;;            </span><span class="comment">diff --git a/xwwp.el b/xwwp.el
</span><span class="comment-delimiter">;;            </span><span class="comment">index acd4ea2..00b6cff 100644
</span><span class="comment-delimiter">;;            </span><span class="comment">--- a/xwwp.el
</span><span class="comment-delimiter">;;            </span><span class="comment">+++ b/xwwp.el
</span><span class="comment-delimiter">;;            </span><span class="comment">@@ -161,7 +161,7 @@ Interactively, URL defaults to the string looking like a url around point.&quot;
</span><span class="comment-delimiter">;;        </span><span class="comment">(if new-session
</span><span class="comment-delimiter">;;            </span><span class="comment">(xwidget-webkit-new-session url)
</span><span class="comment-delimiter">;;          </span><span class="comment">(progn (xwidget-webkit-goto-url url)
</span><span class="comment-delimiter">;;   </span><span class="comment">-             (switch-to-buffer-other-window (xwidget-buffer (xwidget-webkit-current-session)))))))
</span><span class="comment-delimiter">;;   </span><span class="comment">+             (switch-to-buffer (xwidget-buffer (xwidget-webkit-current-session)))))))
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;;    </span><span class="comment">;;; Adapted from EWW code to provide a DWIM style XWWP command
</span><span class="comment-delimiter">;;    </span><span class="comment">(require 'eww)
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> vundo -- unto-tree like branching undo
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> undo-limit 67108864<span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">; </span><span class="comment">64mb.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> undo-strong-limit 100663296<span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">; </span><span class="comment">96mb.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> undo-outer-limit 1006632960<span class="rainbow-delimiters-depth-1-face">)</span> <span class="comment-delimiter">; </span><span class="comment">960mb.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vundo</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;U&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vundo-mode-map</span>
   <span class="string">&quot;q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-quit</span>
   <span class="string">&quot;RET&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-confirm</span>
   <span class="string">&quot;d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-diff</span>
   <span class="string">&quot;h&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-backward</span>
   <span class="string">&quot;l&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-forward</span>
   <span class="string">&quot;k&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-previous</span>
   <span class="string">&quot;j&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">vundo-next</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>vundo-compact-display t<span class="rainbow-delimiters-depth-2-face">)
  (</span>vundo-window-max-height 20<span class="rainbow-delimiters-depth-2-face">)
  (</span>vundo-glyph-alist vundo-unicode-symbols<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vundo-mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">undo-fu</span>
  <span class="builtin">:demand</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">undo-fu-session</span>
  <span class="builtin">:after</span> undo-fu
  <span class="builtin">:demand</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>undo-fu-session-compression <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">zst</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>global-undo-fu-session-mode 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> deadgrep
</span>
<span class="comment-delimiter">;; </span><span class="comment">~consult-ripgrep~ is nice but having a dedicated search buffer
</span><span class="comment-delimiter">;; </span><span class="comment">where I can tinker with options is sometimes better
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">deadgrep</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>deadgrep-display-buffer-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">switch-to-buffer</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>deadgrep-project-root-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-current-project-root</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Normally =--multiline= has memory and performance penalty and not
</span>  <span class="comment-delimiter">;; </span><span class="comment">recommended for every search but I normally use =consult-ripgrep=
</span>  <span class="comment-delimiter">;; </span><span class="comment">and if I'm using deadgrep than this means shit got serious and I
</span>  <span class="comment-delimiter">;; </span><span class="comment">need the advanced stuff.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>deadgrep-extra-arguments <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;--no-config&quot; &quot;--multiline&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">deadgrep-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;RET&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-visit-result</span>
   <span class="string">&quot;o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-visit-result-other-window</span>
   <span class="string">&quot;TAB&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-toggle-file-results</span>
   <span class="string">&quot;S&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-search-term</span>
   <span class="string">&quot;T&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-cycle-search-type</span>
   <span class="string">&quot;C&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-cycle-search-case</span>
   <span class="string">&quot;F&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-cycle-files</span>
   <span class="string">&quot;D&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-directory</span>
   <span class="string">&quot;^&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-parent-directory</span>
   <span class="string">&quot;r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-restart</span>
   <span class="string">&quot;I&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-incremental</span>
   <span class="string">&quot;i&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">deadgrep-edit-mode</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> consult-gh (GitHub interface for consult)
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">consult-gh</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;armindarvish/consult-gh&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:after</span> consult
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">Previews are triggered with `</span><span class="constant">consult-preview-key</span><span class="comment">'
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>consult-gh-show-preview t<span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-issues-state-to-show <span class="string">&quot;all&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-issue-maxnum 150<span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-repo-maxnum 150<span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-pr-maxnum 150<span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-code-maxnum 50<span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-default-orgs-list <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;isamert&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-default-clone-directory <span class="string">&quot;~/Workspace/temp&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-file-action <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-gh--files-view-action</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>consult-gh-issue-action
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>it<span class="rainbow-delimiters-depth-4-face">)
     (</span>browse-url <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;https://github.com/%s/issues/%s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get <span class="rainbow-delimiters-depth-7-face">(</span>cdr it<span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:repo</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get <span class="rainbow-delimiters-depth-7-face">(</span>cdr it<span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:issue</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span>
   consult-gh-repo-action
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>it<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>repo <span class="rainbow-delimiters-depth-7-face">(</span>car <span class="rainbow-delimiters-depth-8-face">(</span>s-split <span class="string">&quot; &quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>s-trim <span class="rainbow-delimiters-depth-1-face">(</span>substring-no-properties it<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">empv--select-action</span> <span class="string">&quot;Action: &quot;
         &quot;View README&quot;</span> =&gt; <span class="rainbow-delimiters-depth-6-face">(</span>browse-url <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;https://github.com/%s.git&quot;</span> repo<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="string">&quot;Files&quot;</span> =&gt; <span class="rainbow-delimiters-depth-6-face">(</span>consult-gh--repo-browse-files-action it<span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="string">&quot;Issues&quot;</span> =&gt; <span class="rainbow-delimiters-depth-6-face">(</span>consult-gh-issue-list repo<span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="string">&quot;Clone&quot;</span> =&gt; <span class="rainbow-delimiters-depth-6-face">(</span>lab-git-clone
                     <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;https://github.com/%s.git&quot;</span> repo<span class="rainbow-delimiters-depth-7-face">)
                     (</span>read-directory-name <span class="string">&quot;Directory to clone in: &quot;</span> lab-projects-directory<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Some aliases so that all GitHub functionality is under same prefix
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">lab-github-search-repo</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-gh-search-repos</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">lab-github-search-code</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult-gh-search-code</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> copilot
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Do ~copilot-login~ to activate.
</span><span class="comment-delimiter">;; </span><span class="comment">- Turn on ~copilot-mode~ to use it.
</span>
<span class="comment-delimiter">;; </span><span class="comment">[2024-04-12 Fri 18:28] I don't use it anymore. Tried it for one
</span><span class="comment-delimiter">;; </span><span class="comment">month and decided that it's counter-productive. Utilizing org-ai is
</span><span class="comment-delimiter">;; </span><span class="comment">much better when needed.
</span>
<span class="comment-delimiter">;; </span><span class="comment">(use-package copilot
</span><span class="comment-delimiter">;;   </span><span class="comment">:straight (:host github :repo &quot;zerolfx/copilot.el&quot; :files (&quot;dist&quot; &quot;*.el&quot;))
</span><span class="comment-delimiter">;;   </span><span class="comment">:general
</span><span class="comment-delimiter">;;   </span><span class="comment">(:keymaps 'copilot-completion-map
</span><span class="comment-delimiter">;;    </span><span class="comment">&quot;&lt;right&gt;&quot; #'copilot-accept-completion
</span><span class="comment-delimiter">;;    </span><span class="comment">&quot;&lt;left&gt;&quot; #'copilot-cancel-completion
</span><span class="comment-delimiter">;;    </span><span class="comment">&quot;&lt;up&gt;&quot; #'copilot-previous-completion
</span><span class="comment-delimiter">;;    </span><span class="comment">&quot;&lt;down&gt;&quot; #'copilot-next-completion)
</span><span class="comment-delimiter">;;   </span><span class="comment">(:modes 'insert
</span><span class="comment-delimiter">;;    </span><span class="comment">&quot;M-o z&quot; #'copilot-complete))
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> artist-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here I simply add some bindings form artist-mode and a cheatsheet in the header line.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook
 <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">artist-mode-hook</span>
 <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-artist-mode-hook</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-artist-mode-hook</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>local-set-key <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;f2&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">artist-select-op-pen-line</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">f2 = pen mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>local-set-key <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;f3&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">artist-select-op-line</span><span class="rainbow-delimiters-depth-2-face">)</span>     <span class="comment-delimiter">; </span><span class="comment">f3 = line
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>local-set-key <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;f4&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">artist-select-op-square</span><span class="rainbow-delimiters-depth-2-face">)</span>   <span class="comment-delimiter">; </span><span class="comment">f4 = rectangle
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>local-set-key <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;f5&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">artist-select-op-ellipse</span><span class="rainbow-delimiters-depth-2-face">)</span>  <span class="comment-delimiter">; </span><span class="comment">f5 = ellipse
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> header-line-format <span class="string">&quot;f2 → pen, f3 → line, f4 → square, f5 → ellipse&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> biome -- weather information
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">biome</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;SqrtMinusOne/biome&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="comment-delimiter">;; </span><span class="comment">These commands are generated in the :config section.
</span>  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-biome-weather-daily-ankara
             im-biome-weather-daily-amsterdam
             im-biome-weather-daily-istanbul
             im-biome-weather-hourly-ankara
             im-biome-weather-hourly-amsterdam
             im-biome-weather-hourly-istanbul<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">See README, this fixes request--callback: peculiar error issue.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>biome-api-try-parse-error-as-response t<span class="rainbow-delimiters-depth-2-face">)
  (</span>biome-query-coords
   <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;Amsterdam, Netherlands&quot;</span> ,im-amsterdam-lat ,im-amsterdam-long<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;Ankara, Turkey&quot;</span> ,im-ankara-lat ,im-ankara-long<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;Istanbul, Turkey&quot;</span> ,im-istanbul-lat ,im-istanbul-long<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>biome-grid-highlight-current t<span class="rainbow-delimiters-depth-2-face">)
  (</span>biome-query-override-column-names
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;apparent_temperature_max&quot;</span> . <span class="string">&quot;Max feel&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;apparent_temperature_min&quot;</span> . <span class="string">&quot;Min feel&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;temperature_2m_min&quot;</span> . <span class="string">&quot;Min temp&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;temperature_2m_max&quot;</span> . <span class="string">&quot;Max temp&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;precipitation_probability_max&quot;</span> . <span class="string">&quot;🌧️ %%&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;precipitation_probability&quot;</span> . <span class="string">&quot;🌧️ %%&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;precipitation_hours&quot;</span> . <span class="string">&quot;🌧️ hours&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;precipitation_sum&quot;</span> . <span class="string">&quot;🌧️ sum&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;precipitation&quot;</span> . <span class="string">&quot;🌧️ &quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;relativehumidity_2m&quot;</span> . <span class="string">&quot;Humid&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;weathercode&quot;</span> . <span class="string">&quot; Code&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;is_day&quot;</span> . <span class="string">&quot;Zone     &quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;shortwave_radiation_sum&quot;</span> . <span class="string">&quot;Radiation&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="string">&quot;time&quot;</span> . <span class="string">&quot;📅 &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Generate a preset for each city in biome-query-coords
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">--each</span> <span class="rainbow-delimiters-depth-3-face">(</span>map-keys biome-query-coords<span class="rainbow-delimiters-depth-3-face">)
    (</span>eval
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">biome-def-preset</span> ,<span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="string">&quot;im-biome-weather-daily-&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>downcase <span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>s-split <span class="string">&quot;, &quot;</span> it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:name</span> . <span class="string">&quot;Weather Forecast&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="builtin">:group</span> . <span class="string">&quot;daily&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="builtin">:params</span>
          <span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;daily&quot; &quot;shortwave_radiation_sum&quot; &quot;uv_index_clear_sky_max&quot; &quot;uv_index_max&quot; &quot;precipitation_probability_max&quot;
           &quot;precipitation_hours&quot; &quot;precipitation_sum&quot; &quot;sunset&quot; &quot;sunrise&quot; &quot;apparent_temperature_min&quot; &quot;apparent_temperature_max&quot;
           &quot;temperature_2m_min&quot; &quot;temperature_2m_max&quot; &quot;weathercode&quot;</span><span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="string">&quot;latitude&quot;</span> . ,<span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>map-elt biome-query-coords it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="string">&quot;longitude&quot;</span> . ,<span class="rainbow-delimiters-depth-8-face">(</span>cadr <span class="rainbow-delimiters-depth-9-face">(</span>map-elt biome-query-coords it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">--each</span> <span class="rainbow-delimiters-depth-3-face">(</span>map-keys biome-query-coords<span class="rainbow-delimiters-depth-3-face">)
    (</span>eval
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">biome-def-preset</span> ,<span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="string">&quot;im-biome-weather-hourly-&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>downcase <span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>s-split <span class="string">&quot;, &quot;</span> it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:name</span> . <span class="string">&quot;Weather Forecast&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="builtin">:group</span> . <span class="string">&quot;hourly&quot;</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="builtin">:params</span>
          <span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;hourly&quot; &quot;uv_index_clear_sky&quot; &quot;uv_index&quot; &quot;relativehumidity_2m&quot; &quot;precipitation&quot;
           &quot;precipitation_probability&quot; &quot;apparent_temperature&quot; &quot;temperature_2m&quot; &quot;is_day&quot;  &quot;weathercode&quot;</span><span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="string">&quot;latitude&quot;</span> . ,<span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>map-elt biome-query-coords it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="string">&quot;longitude&quot;</span> . ,<span class="rainbow-delimiters-depth-8-face">(</span>cadr <span class="rainbow-delimiters-depth-9-face">(</span>map-elt biome-query-coords it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> outli -- outlier for code files
</span>
<span class="comment-delimiter">;; </span><span class="comment">I migrated my .org config into a single elisp file, thanks to
</span><span class="comment-delimiter">;; </span><span class="comment">outli. This way it is easier to maintain and I get the use some of
</span><span class="comment-delimiter">;; </span><span class="comment">the org features in my configuration.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">outli</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;jdtsmith/outli&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>prog-mode . outli-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="comment-delimiter">;; </span><span class="comment">You can jump between /pages/ by using ~C-x [~ and ~C-x ]~. See
</span>  <span class="comment-delimiter">;; </span><span class="comment">[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Pages.html][this]]
</span>  <span class="comment-delimiter">;; </span><span class="comment">for more information. Using the same convention for outli:
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outli-mode-map</span>
   <span class="string">&quot;C-x [&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-previous-heading</span>
   <span class="string">&quot;C-x ]&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-next-heading</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Here are some org-mode like bindings for outli:
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outli-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;gh&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-up-heading</span>
   <span class="string">&quot;gk&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-backward-same-level</span>
   <span class="string">&quot;gj&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-forward-same-level</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Add h as narrow prefix for headings in consult-imenu
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-imenu</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">push</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>?h <span class="string">&quot;Headings&quot;</span><span class="rainbow-delimiters-depth-4-face">) (</span>plist-get <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>assoc <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs-lisp-mode</span> consult-imenu-config<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="builtin">:types</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> epkg
</span>
<span class="comment-delimiter">;; </span><span class="comment">Browse elisp packages inside Emacs. This is useful as I am not
</span><span class="comment-delimiter">;; </span><span class="comment">using package.el and don't want to load it. Use
</span><span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">epkg-list-packages</span><span class="comment">'.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">epkg</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> upver -- update dependencies interactively
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">upver</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>upver<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/upver.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> notmuch &amp; message &amp; sendmail -- email stuff
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">ol-notmuch</span>
  <span class="builtin">:after</span> notmuch<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Easy to use, fast email client.  Tagging feature is something I am
</span><span class="comment-delimiter">;; </span><span class="comment">familiar from elfeed, and notmuch executes this concept very
</span><span class="comment-delimiter">;; </span><span class="comment">well. A pleasure to use.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Summary of what is going on:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- `</span><span class="constant">mbsync</span><span class="comment">' (or `</span><span class="constant">isync</span><span class="comment">') is used for fetching mail from remote mail
</span><span class="comment-delimiter">;;   </span><span class="comment">server to local.
</span><span class="comment-delimiter">;;   </span><span class="comment">- The configuration is kept under =~/.mbsyncrc=
</span><span class="comment-delimiter">;;   </span><span class="comment">- This needs to be run periodically to sync mail.  See my
</span><span class="comment-delimiter">;;     </span><span class="comment">`</span><span class="constant">im-sync-mail</span><span class="comment">' function.
</span><span class="comment-delimiter">;; </span><span class="comment">- `</span><span class="constant">notmuch</span><span class="comment">' is the mail indexer which essentially lets you search
</span><span class="comment-delimiter">;;   </span><span class="comment">your mail.
</span><span class="comment-delimiter">;;   </span><span class="comment">- The configuration is kept under =~/.notmuch-config=
</span><span class="comment-delimiter">;;   </span><span class="comment">- It is an external program, that works on your local maildir
</span><span class="comment-delimiter">;;     </span><span class="comment">(which is created by the `</span><span class="constant">mbsync</span><span class="comment">')
</span><span class="comment-delimiter">;;   </span><span class="comment">- It needs to be run after each update to index your mail.  See
</span><span class="comment-delimiter">;;     </span><span class="comment">my `</span><span class="constant">im-sync-mail</span><span class="comment">' function.
</span><span class="comment-delimiter">;;   </span><span class="comment">- It is also an Emacs package which let's you view your email and
</span><span class="comment-delimiter">;;     </span><span class="comment">interact with them.
</span><span class="comment-delimiter">;; </span><span class="comment">- `</span><span class="constant">msmtp</span><span class="comment">' is the SMTP client that let's you send your mails.
</span><span class="comment-delimiter">;;   </span><span class="comment">- The configuration is kept under =~/.msmtprc=.
</span><span class="comment-delimiter">;;   </span><span class="comment">- See `</span><span class="constant">sendmail</span><span class="comment">' and `</span><span class="constant">message</span><span class="comment">' configuration down below for Emacs
</span><span class="comment-delimiter">;;     </span><span class="comment">integration.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">See [[../index.org]] for relevant configuration files.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Great video, explaining notmuch and the workflow by prot:
</span><span class="comment-delimiter">;; </span><span class="comment">https://youtube.com/watch?v=g7iF11qamh8
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">For gmail configuration, following is helpful:
</span><span class="comment-delimiter">;; </span><span class="comment">https://frostyx.cz/posts/synchronize-your-2fa-gmail-with-mbsync#gmail-with-2fa
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Another helpful and easy to follow guide:
</span><span class="comment-delimiter">;; </span><span class="comment">https://jonathanchu.is/posts/emacs-notmuch-isync-msmtp-setup/
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Most of the customizations down below are inspired by prot's configuration:
</span><span class="comment-delimiter">;; </span><span class="comment">https://protesilaos.com/emacs/dotemacs
</span>
<span class="comment-delimiter">;; </span><span class="comment">Good time to set these values:
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> user-full-name <span class="string">&quot;Isa Mert Gurbuz&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">setq</span> user-mail-address <span class="string">&quot;isamertgurbuz@gmail.com&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">notmuch</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>notmuch-show-logo nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-hello-auto-refresh t<span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-show-all-tags-list t<span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-show-empty-saved-searches t<span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-show-relative-dates t<span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-show-part-button-default-action <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">notmuch-show-view-part</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-saved-searches
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:name</span> <span class="string">&quot;📥 inbox&quot;</span> <span class="builtin">:query</span> <span class="string">&quot;tag:inbox and not tag:deleted&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;i&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="builtin">:name</span> <span class="string">&quot;💬 unread (inbox)&quot;</span> <span class="builtin">:query</span> <span class="string">&quot;tag:unread and tag:inbox&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;u&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="builtin">:name</span> <span class="string">&quot;🏳️ flagged&quot;</span> <span class="builtin">:query</span> <span class="string">&quot;tag:flagged&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;f&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="builtin">:name</span> <span class="string">&quot;✍🏻 sent&quot;</span> <span class="builtin">:query</span> <span class="string">&quot;tag:sent&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;t&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="builtin">:name</span> <span class="string">&quot;📰 drafts&quot;</span> <span class="builtin">:query</span> <span class="string">&quot;tag:draft&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;d&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="builtin">:name</span> <span class="string">&quot;💭 all mail&quot;</span> <span class="builtin">:query</span> <span class="string">&quot;*&quot;</span> <span class="builtin">:key</span> <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-mua-hidden-headers nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-always-prompt-for-sender t<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Automatically move sent mails to Sent folder of corresponding
</span>  <span class="comment-delimiter">;; </span><span class="comment">account and add/remove relevant tags
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>notmuch-fcc-dirs <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;isamertgurbuz@gmail.com&quot;</span> . <span class="string">&quot;gmail/Sent +sent -new -inbox -unread&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="comment-delimiter">;; </span><span class="comment">Check if attachments are really attached before sending
</span>  <span class="comment-delimiter">;; </span><span class="comment">Also see `</span><span class="constant">notmuch-mua-attachment-regexp</span><span class="comment">'
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>notmuch-mua-send . notmuch-mua-attachment-check<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">notmuch-search-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="comment-delimiter">;; </span><span class="comment">gr → Refresh view
</span>   <span class="comment-delimiter">;; </span><span class="comment">C → compose mail
</span>   <span class="string">&quot;u&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-collection-notmuch-search-toggle-unread</span>
   <span class="string">&quot;gs&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">notmuch-search</span>
   <span class="string">&quot;gS&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">notmuch-tree</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">notmuch-show-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
    <span class="string">&quot;o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">notmuch-show-view-part</span>
    <span class="string">&quot;O&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">notmuch-show-save-part</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span>
    <span class="string">&quot;en&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-notmuch-inbox</span>
    <span class="string">&quot;eN&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">notmuch-hello</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-default</span> notmuch-search-oldest-first nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-notmuch-setup<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">I use the s key for another thing
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-define-key <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">notmuch-common-keymap</span>
    <span class="string">&quot;s&quot;</span> nil
    <span class="string">&quot;S&quot;</span> nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">message</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>message-setup . message-sort-headers<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>mail-user-agent <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">message-user-agent</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message-mail-user-agent t<span class="rainbow-delimiters-depth-2-face">)
  (</span>message-elide-ellipsis <span class="string">&quot;\n&gt; [... %l lines elided]\n&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>compose-mail-user-agent-warnings nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>mail-signature <span class="string">&quot;Isa Mert Gurbuz\nhttps://isamert.net\n&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message-citation-line-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">message-insert-formatted-citation-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message-confirm-send nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>message-kill-buffer-on-exit t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">sendmail</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:after</span> message
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> send-mail-function <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">sendmail-send-it</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> sendmail-program <span class="rainbow-delimiters-depth-3-face">(</span>executable-find <span class="string">&quot;msmtp&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> message-sendmail-envelope-from <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">header</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-notmuch-inbox</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open Inbox directly.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>notmuch-search <span class="rainbow-delimiters-depth-3-face">(</span>plist-get <span class="rainbow-delimiters-depth-4-face">(</span>car notmuch-saved-searches<span class="rainbow-delimiters-depth-4-face">)</span> <span class="builtin">:query</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Sync mail
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">async-defun</span> <span class="function-name">im-sync-mail</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> interactive?<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run mbsync, update notmuch index and check new message count.

This could be a cron job but keeping it in emacs gives me the
opportunity to notify the new email count right after fetching all
mails.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-check-internet-connection<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">condition-case</span> reason
        <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span>count<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">when</span> interactive?
            <span class="rainbow-delimiters-depth-6-face">(</span>message <span class="string">&quot;&gt;&gt; Checking mail...&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>await <span class="rainbow-delimiters-depth-6-face">(</span>im-shell-command <span class="builtin">:command</span> <span class="string">&quot;mbsync --all --verbose&quot;</span> <span class="builtin">:async</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>await <span class="rainbow-delimiters-depth-6-face">(</span>im-shell-command <span class="builtin">:command</span> <span class="string">&quot;notmuch new&quot;</span> <span class="builtin">:async</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>await <span class="rainbow-delimiters-depth-6-face">(</span>im-shell-command <span class="builtin">:command</span> <span class="string">&quot;notmuch tag +work -- not tag:work and folder:work/INBOX&quot;</span> <span class="builtin">:async</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">setq</span>
           count
           <span class="rainbow-delimiters-depth-6-face">(</span>string-to-number
            <span class="rainbow-delimiters-depth-7-face">(</span>await <span class="rainbow-delimiters-depth-8-face">(</span>im-shell-command <span class="builtin">:command</span> <span class="string">&quot;notmuch count tag:inbox and tag:unread&quot;</span> <span class="builtin">:async</span> t<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">when</span> interactive?
            <span class="rainbow-delimiters-depth-6-face">(</span>message <span class="string">&quot;You have %s new mail.&quot;</span> count<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>&gt; count 0<span class="rainbow-delimiters-depth-6-face">)
            (</span>alert <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;You have %s new mail!&quot;</span> count<span class="rainbow-delimiters-depth-7-face">)</span>
                   <span class="builtin">:title</span> <span class="string">&quot;New Mail!&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">error</span> <span class="rainbow-delimiters-depth-5-face">(</span>alert <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;Exit code: %s. See buffers *notmuch* and *mbsync*.&quot;</span> reason<span class="rainbow-delimiters-depth-6-face">)</span>
                    <span class="builtin">:title</span> <span class="string">&quot;Checking for mail failed!&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>run-with-timer
 60
 <span class="rainbow-delimiters-depth-2-face">(</span>* 15 60<span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-sync-mail</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Mail auto completion for my contacts
</span>
<span class="comment-delimiter">;; </span><span class="comment">With the following, &quot;M-o m&quot; completes email addresses of my
</span><span class="comment-delimiter">;; </span><span class="comment">contacts.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-cape</span>
 <span class="builtin">:name</span> people-emails
 <span class="builtin">:completion</span>
 <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">()
   (</span><span class="keyword">-&gt;&gt;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>im-deserialize-from-file <span class="string">&quot;~/.emacs.d/sync/people&quot;</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>-map
     <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>entry<span class="rainbow-delimiters-depth-6-face">)
       (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>mails <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-1-face">(</span>s-prefix? <span class="string">&quot;EMAIL&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>car it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span> entry<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
         (</span><span class="keyword">--map</span>
          <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>type <span class="rainbow-delimiters-depth-2-face">(</span>s-titleize <span class="rainbow-delimiters-depth-3-face">(</span>s-chop-prefix <span class="string">&quot;_&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-chop-prefix <span class="string">&quot;EMAIL&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>car it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
            (</span>list
             <span class="rainbow-delimiters-depth-1-face">(</span>cdr it<span class="rainbow-delimiters-depth-1-face">)</span>
             <span class="comment-delimiter">;; </span><span class="comment">annotation
</span>             <span class="rainbow-delimiters-depth-1-face">(</span>concat <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>s-blank? type<span class="rainbow-delimiters-depth-3-face">)</span> <span class="string">&quot;&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>concat type <span class="string">&quot; of &quot;</span> <span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">) (</span>map-elt entry <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>
             <span class="comment-delimiter">;; </span><span class="comment">doc
</span>             entry<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
          mails<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>-flatten-n 1<span class="rainbow-delimiters-depth-4-face">)
    (</span>-non-nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:extractor</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>xs<span class="rainbow-delimiters-depth-3-face">) (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span> xs<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:bound</span> symbol
 <span class="builtin">:category</span> symbol
 <span class="builtin">:key</span> <span class="string">&quot;M-o m&quot;</span>
 <span class="builtin">:doc</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>xs x<span class="rainbow-delimiters-depth-3-face">) (</span>pp-to-string <span class="rainbow-delimiters-depth-4-face">(</span>nth 1 <span class="rainbow-delimiters-depth-5-face">(</span>map-elt xs x<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:annotate</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>xs x<span class="rainbow-delimiters-depth-3-face">) (</span>concat <span class="string">&quot; -&gt; &quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>nth 0 <span class="rainbow-delimiters-depth-5-face">(</span>map-elt xs x<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> easysession.el -- session manager
</span>
<span class="comment-delimiter">;; </span><span class="comment">Simple package to save/retrieve Emacs sessions. It works well with
</span><span class="comment-delimiter">;; </span><span class="comment">tab-bar. Currently my workflow is:
</span>
<span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">easysession-save-as</span><span class="comment">' :: Save a named session.
</span><span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">easysession-switch-to</span><span class="comment">' :: Load a session. Usually called after starting Emacs.
</span>
<span class="comment-delimiter">;; </span><span class="comment">By default, all file visiting buffers, dired buffers, and indirect
</span><span class="comment-delimiter">;; </span><span class="comment">buffers are persisted and restored.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">easysession</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;jamescherti/easysession.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-git -- my git workflow, magit alternative
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">im-git</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-git-show-stash-diff<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;gs&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-git-status</span>
    <span class="string">&quot;gc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-git-commit</span>
    <span class="string">&quot;ga&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-git-commit-amend</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-git-commit-finished-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-update-git-state</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-shiori -- Shiori bookmark manager integration
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">im-shiori</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-shiori-url im-homeserver-shiori-url<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shiori-username im-homeserver-username<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shiori-password im-homeserver-password<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shiori-elfeed-tags <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>later bookmark shiori<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>im-shiori-enable-elfeed-support<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-tab --- my tab related extensions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">im-tab</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="comment-delimiter">;; </span><span class="comment">Save current tab window configuration to a key
</span>    <span class="string">&quot;ww2&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-save-current</span>
    <span class="string">&quot;ww3&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-save-current</span>
    <span class="string">&quot;ww4&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-save-current</span>
    <span class="string">&quot;ww5&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-save-current</span>
    <span class="comment-delimiter">;; </span><span class="comment">Restore a saved configuration with a key
</span>    <span class="string">&quot;w2&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-restore-current</span>
    <span class="string">&quot;w3&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-restore-current</span>
    <span class="string">&quot;w4&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-restore-current</span>
    <span class="string">&quot;w5&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-configuration-restore-current</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-filebrowser -- Filebrowser integration
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">im-filebrowser</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-filebrowser-share<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-filebrowser-url im-homeserver-filebrowser-url<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-filebrowser-username im-homeserver-username<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-filebrowser-password im-homeserver-password<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-filebrowser-base-path <span class="string">&quot;/ssh:files:&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Editing
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Breaking long texts/comments into multiple lines
</span>
<span class="comment-delimiter">;; </span><span class="comment">I use =M-q= (=fill-paragraph=) to break long texts into multiple
</span><span class="comment-delimiter">;; </span><span class="comment">lines. It also works well within comment sections. 80 col length is
</span><span class="comment-delimiter">;; </span><span class="comment">quite readable. See how this item is formatted, it's done
</span><span class="comment-delimiter">;; </span><span class="comment">automatically by the usage of =M-q=.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span> fill-column 80<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> synosaurus &amp; wordnut
</span>
<span class="comment-delimiter">;; </span><span class="comment">Both synosaurus and wordnut uses ~wordnet~ to work. Use
</span><span class="comment-delimiter">;; </span><span class="comment">~synosaurus-choose-and-replace~ to replace the current word with
</span><span class="comment-delimiter">;; </span><span class="comment">one of it's synonyms.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">synosaurus</span>
  <span class="builtin">:commands</span> synosaurus-choose-and-replace
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;mr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">synosaurus-choose-and-replace</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> synosaurus-choose-method nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">wordnut</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> sozluk.el -- Turkish dictionary
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">sozluk</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/sozluk.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">(sozluk-include-etymology-on-sozluk t)
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>sozluk-deasciify-if-not-found t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">This is an optional dependency for sozluk.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">turkish</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;tc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">turkish-correct-region</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> jinx -- spellchecker, flyspell alternative
</span>
<span class="comment-delimiter">;; </span><span class="comment">I was using ~flyspell~ and ~flyspell-correct~ before but Jinx works
</span><span class="comment-delimiter">;; </span><span class="comment">much better &amp; faster out-of-the-box. It automatically works nicely
</span><span class="comment-delimiter">;; </span><span class="comment">in code buffers too!
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">You need to install ~enchant~ to make Jinx work (and compile).
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">[2024-08-24 Sat 03:30] Recently I have been having random crashes,
</span><span class="comment-delimiter">;; </span><span class="comment">and it turns out (after a very long session of debugging) the reason
</span><span class="comment-delimiter">;; </span><span class="comment">is enchant. enchant SEGFAULTs when using Apple Spell, so what I did
</span><span class="comment-delimiter">;; </span><span class="comment">is:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src
</span><span class="comment-delimiter">;;   </span><span class="comment">rm /opt/homebrew/Cellar/enchant/2.8.2/share/enchant-2/AppleSpell.config
</span><span class="comment-delimiter">;;   </span><span class="comment">rm /opt/homebrew/Cellar/enchant/2.8.2/lib/enchant-2/enchant_applespell.so
</span><span class="comment-delimiter">;;   </span><span class="comment">rm /opt/homebrew/Cellar/enchant/2.8.2/lib/enchant-2/enchant_applespell.a
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Seems like other people also had this issue and resolved
</span><span class="comment-delimiter">;; </span><span class="comment">differently, like building enchant from source etc:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- https://github.com/rrthomas/enchant/issues/391
</span><span class="comment-delimiter">;; </span><span class="comment">- https://github.com/pyenchant/pyenchant/issues/321
</span><span class="comment-delimiter">;; </span><span class="comment">- https://old.reddit.com/r/emacs/comments/1eg9hdg/multilingual_spellchecking_omg_what_a_rabbit_hole/
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">jinx</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>emacs-startup . global-jinx-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span> <span class="rainbow-delimiters-depth-2-face">(</span>jinx-languages <span class="string">&quot;en_US tr_TR&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-normal-state-map</span>
   <span class="string">&quot;z=&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jinx-correct-word</span>
   <span class="comment-delimiter">;; </span><span class="comment">Override flyspell bindings from evil-commands with jinx ones
</span>   <span class="string">&quot;[s&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jinx-previous</span>
   <span class="string">&quot;]s&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jinx-next</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-visual-state-map</span>
   <span class="string">&quot;z=&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jinx-correct-word</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> puni &amp; combobulate &amp; electric-pair-mode (structrual editing stuff)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Using `</span><span class="constant">electric-pair-mode</span><span class="comment">' to automatically pair parenthesis.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-init-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">electric-pair-mode</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">puni</span><span class="comment">' provides structral editing for a lot of languages using some
</span><span class="comment-delimiter">;; </span><span class="comment">Emacs built-ins.  It's pretty good most of the time and I really
</span><span class="comment-delimiter">;; </span><span class="comment">use a very small subset of it's feature set.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">puni</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;AmaiKinono/puni&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">prog-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>insert<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;M-[&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-barf-forward</span>
   <span class="string">&quot;M-]&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-slurp-forward</span>
   <span class="string">&quot;M-d&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-splice</span>
   <span class="string">&quot;M-t&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-transpose</span>
   <span class="string">&quot;M-\\&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-split</span>
   <span class="string">&quot;M-(&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-wrap-round</span>
   <span class="string">&quot;M-{&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-wrap-curly</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">prog-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>normal<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;(&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-backward-sexp-or-up-list</span>
   <span class="string">&quot;)&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">puni-forward-sexp-or-up-list</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">combobulate</span><span class="comment">' provides structural editing for some languages using
</span><span class="comment-delimiter">;; </span><span class="comment">treesit.el, here are the bindings that I find useful (which are
</span><span class="comment-delimiter">;; </span><span class="comment">enabled by `</span><span class="constant">combobulate-mode</span><span class="comment">'):
</span>
<span class="comment-delimiter">;; </span><span class="comment">- M-P :: combobulate-drag-up
</span><span class="comment-delimiter">;; </span><span class="comment">- M-N :: combobulate-drag-down
</span>
<span class="comment-delimiter">;; </span><span class="comment">I also replace `</span><span class="constant">expand-region</span><span class="comment">' with combobulate equivalent and also
</span><span class="comment-delimiter">;; </span><span class="comment">re-bind some of the bindings from `</span><span class="constant">puni</span><span class="comment">' with their combobulate
</span><span class="comment-delimiter">;; </span><span class="comment">equivalent:
</span>
<span class="comment-delimiter">;; </span><span class="comment">- M-w :: combobulate-mark-node-dwim
</span><span class="comment-delimiter">;; </span><span class="comment">- M-t :: combobulate-transpose-sexps
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">combobulate</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span>combobulate <span class="builtin">:type</span> git <span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;mickeynp/combobulate&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>python-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span>js-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span>css-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span>yaml-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span>json-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span>typescript-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span>tsx-ts-mode . combobulate-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">combobulate-key-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>normal insert<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;M-w&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">combobulate-mark-node-dwim</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">combobulate-key-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>insert<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;M-t&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">combobulate-transpose-sexps</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">Numeric selection is confusing
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>combobulate-proffer-allow-numeric-selection nil<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">define-advice</span> <span class="function-name">combobulate-mark-node-dwim</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:before</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> visual-mode<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="doc">&quot;Activate visual mode before marking.&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>evil-visual-char<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">The reason I use a very little subset of these packages is that I
</span><span class="comment-delimiter">;; </span><span class="comment">already use evil-mode and it's editing capabilities cover most of
</span><span class="comment-delimiter">;; </span><span class="comment">the feature set provided by puni and combobulate.
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> writeroom-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Gives you a nice, uncluttered editing experience by removing all
</span><span class="comment-delimiter">;; </span><span class="comment">unneeded visual clutter and by justifying the text in the middle.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">writeroom-mode</span>
  <span class="builtin">:commands</span> writeroom-mode
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> writeroom-fullscreen-effect <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">maximized</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> writeroom-global-effects nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> writeroom-mode-line-toggle-position <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">header-line-format</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> writeroom-width 81<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Dummy IDE mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">I try to use ~lsp-mode~ and other language-specific packages for
</span><span class="comment-delimiter">;; </span><span class="comment">the languages I use (see [[Language specific]]), but sometimes
</span><span class="comment-delimiter">;; </span><span class="comment">either they are too slow or the computer I'm currently working on
</span><span class="comment-delimiter">;; </span><span class="comment">requires some extra setup or I just don't want to use them for some
</span><span class="comment-delimiter">;; </span><span class="comment">reason. For those cases, I use a collection of packages that gives
</span><span class="comment-delimiter">;; </span><span class="comment">you the power of IDEs but in some dummy/restricted way.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- &lt;&lt;highlight-thing&gt;&gt; :: Automatically highlights the all instances of the symbol under the cursor in the buffer. Simply use evils ~*~ and ~#~ to jump between them.
</span><span class="comment-delimiter">;; </span><span class="comment">- &lt;&lt;dumb-jump&gt;&gt; :: Jumps to definition by using predefined-regexps, generally works fine. Use =gd=.
</span><span class="comment-delimiter">;; </span><span class="comment">- To debug why it's not working: M-x ~set-variable dumb-jump-debug t~, then go to *Messages* buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">- &lt;&lt;treesit&gt;&gt; :: This is a generic parser for bunch of languages. You can also inspect the syntax tree on the fly and do whatever you want to do with it. Best feature so far is just better (like, miles ahead better) syntax highlighting for some languages. Especially for JS/TS and Rust.
</span><span class="comment-delimiter">;; </span><span class="comment">- &lt;&lt;hl-todo&gt;&gt; :: Highlight </span><span class="default-0035">TODO</span><span class="comment">/</span><span class="default-0035">FIXME</span><span class="comment"> etc.
</span><span class="comment-delimiter">;; </span><span class="comment">- Use ~]t~ and ~[t~ to go next/prev </span><span class="default-0035">TODO</span><span class="comment">/</span><span class="default-0035">FIXME</span><span class="comment"> item.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">dumb-jump</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xref-backend-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dumb-jump-xref-activate</span> 90<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">ag is supported by nearly every rule but rg is not.
</span>  <span class="comment-delimiter">;; </span><span class="comment">also see: https://github.com/jacktasia/dumb-jump/issues/376
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> dumb-jump-force-searcher <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">ag</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> dumb-jump-ignore-context nil<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> dumb-jump-fallback-search t<span class="rainbow-delimiters-depth-2-face">)

  (</span>remove-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xref-backend-functions</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">etags--xref-backend</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">hl-todo</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>prog-mode . hl-todo-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:bind</span> <span class="rainbow-delimiters-depth-2-face">(</span> <span class="builtin">:map</span> evil-normal-state-map
          <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;[t&quot;</span> . hl-todo-previous<span class="rainbow-delimiters-depth-3-face">)
          (</span><span class="string">&quot;]t&quot;</span> . hl-todo-next<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> hl-todo-keyword-faces <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;</span><span class="default-0037">TODO</span><span class="string">&quot;</span>   . <span class="string">&quot;#FF0000&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                                (</span><span class="string">&quot;</span><span class="default-0037">FIXME</span><span class="string">&quot;</span>  . <span class="string">&quot;#FF0000&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                                (</span><span class="string">&quot;</span><span class="default-0040">DEBUG</span><span class="string">&quot;</span>  . <span class="string">&quot;#A020F0&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                                (</span><span class="string">&quot;</span><span class="default-0041">GOTCHA</span><span class="string">&quot;</span> . <span class="string">&quot;#FF4500&quot;</span><span class="rainbow-delimiters-depth-4-face">)
                                (</span><span class="string">&quot;</span><span class="default-0042">STUB</span><span class="string">&quot;</span>   . <span class="string">&quot;#1E90FF&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">hl-todo-next</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">define-advice</span> <span class="function-name">hl-todo-previous</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> reveal<span class="rainbow-delimiters-depth-3-face">) (</span>reveal-post-command<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Highlight thing at point manually
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq</span>
 hi-lock-face-defaults
 <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;hi-salmon&quot; &quot;hi-aquamarine&quot; &quot;hi-blue&quot; &quot;hi-yellow&quot; &quot;hi-pink&quot; &quot;hi-green&quot; &quot;hi-black-b&quot; &quot;hi-blue-b&quot; &quot;hi-red-b&quot; &quot;hi-green-b&quot; &quot;hi-black-hb&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-highlight-thing-at-point-dwim</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Hightlight or unhighlight current symbol or selection.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--any?</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>-contains? hi-lock-face-defaults
                 <span class="rainbow-delimiters-depth-6-face">(</span>symbol-name it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>-flatten <span class="rainbow-delimiters-depth-6-face">(</span>list <span class="rainbow-delimiters-depth-7-face">(</span>plist-get <span class="rainbow-delimiters-depth-8-face">(</span>text-properties-at <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>unhighlight-regexp
     <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>use-region-p<span class="rainbow-delimiters-depth-6-face">)
         (</span>regexp-quote <span class="rainbow-delimiters-depth-7-face">(</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-8-face">(</span>region-beginning<span class="rainbow-delimiters-depth-8-face">) (</span>region-end<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>hi-lock-regexp-okay <span class="rainbow-delimiters-depth-7-face">(</span>find-tag-default-as-symbol-regexp<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>use-region-p<span class="rainbow-delimiters-depth-4-face">)
    (</span>highlight-regexp
     <span class="rainbow-delimiters-depth-5-face">(</span>regexp-quote <span class="rainbow-delimiters-depth-6-face">(</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>region-beginning<span class="rainbow-delimiters-depth-7-face">) (</span>region-end<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>deactivate-mark<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">symbol</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>hi-lock-face-symbol-at-point<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t <span class="rainbow-delimiters-depth-4-face">(</span>unhighlight-regexp t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-h&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-highlight-thing-at-point-dwim</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-H&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>unhighlight-regexp t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Media/feed/IRC
</span>
<span class="comment-delimiter">;; </span><span class="comment">I try to maximize my Emacs usage which brings it's own benefits and
</span><span class="comment-delimiter">;; </span><span class="comment">downsides which I will not go over here. Here are some packages and
</span><span class="comment-delimiter">;; </span><span class="comment">configurations that are not related to programming/editing.
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> elfeed (RSS feeds)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Feed reader.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Filter examples (after hitting ~s~)
</span><span class="comment-delimiter">;; </span><span class="comment">- +tag OR -tag (unread is also a tag)
</span><span class="comment-delimiter">;; </span><span class="comment">- #number-of-entries-limit (like #20)
</span><span class="comment-delimiter">;; </span><span class="comment">- !inverse-regex (!x?emacs will filter out titles containing x?emacs regex)
</span><span class="comment-delimiter">;; </span><span class="comment">- =regex (entries that contains the regex will be shown)
</span><span class="comment-delimiter">;; </span><span class="comment">- +unread +youtube =emacs #10 @5-months-ago
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">elfeed</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>elfeed im-elfeed-reload-and-open<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span>
    <span class="string">&quot;ee&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-elfeed-reload-and-open</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-search-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;o&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">elfeed-search-browse-url</span>
   <span class="string">&quot;O&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-elfeed-search-browse-url-in-default-browser</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-collection-elfeed-setup<span class="rainbow-delimiters-depth-2-face">)

  (</span>evil-collection-define-key <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-search-mode-map</span>
    <span class="string">&quot;s&quot;</span> nil
    <span class="string">&quot;S&quot;</span> nil
    <span class="string">&quot;gs&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-search-live-filter</span>
    <span class="string">&quot;gS&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-search-set-filter</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-collection-define-key <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-show-mode-map</span>
    <span class="string">&quot;s&quot;</span> nil
    <span class="string">&quot;S&quot;</span> nil<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">When adding tags, don't add any hierarchical tags like (blog
</span>  <span class="comment-delimiter">;; </span><span class="comment">blog-software), or (metal metal-black) Just use something like:
</span>  <span class="comment-delimiter">;; </span><span class="comment">(blog software) and (metal black)
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">im-feeds</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> elfeed-search-title-max-width 100<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> elfeed-curl-extra-arguments <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;--netrc&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> elfeed-feeds <span class="rainbow-delimiters-depth-3-face">(</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-elfeed--expand</span> im-feeds<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">To apply hooks to all existing entries, use: elfeed-apply-hooks-now
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>im-elfeed-auto-tag-url <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;youtube\\.com&quot;</span> youtube<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-elfeed-auto-tag-title <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;youtube\\.com&quot;</span> youtube<span class="rainbow-delimiters-depth-4-face">)
                              (</span><span class="string">&quot;c\\+\\+&quot;</span>  <span class="rainbow-delimiters-depth-5-face">(</span>programming c++<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                              (</span><span class="string">&quot;python&quot;</span>   <span class="rainbow-delimiters-depth-5-face">(</span>programming python<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                              (</span><span class="string">&quot;haskell&quot;</span>  <span class="rainbow-delimiters-depth-5-face">(</span>programming haskell<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: experiment with custom faces
</span><span class="comment-delimiter">;; </span><span class="comment">(defface elfeed-comic
</span><span class="comment-delimiter">;;   </span><span class="comment">'((t :foreground &quot;#BFF&quot;))
</span><span class="comment-delimiter">;;   </span><span class="comment">&quot;Marks comics in Elfeed.&quot;
</span><span class="comment-delimiter">;;   </span><span class="comment">:group 'elfeed)
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">(push '(comic elfeed-comic)
</span><span class="comment-delimiter">;;       </span><span class="comment">elfeed-search-face-alist)
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-elfeed-search-browse-url-in-default-browser</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open URL in the default browser.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-default-browser</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>elfeed-search-browse-url<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-elfeed-auto-tag-url</span> <span class="rainbow-delimiters-depth-2-face">(</span>pairs<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Takes a list of url-regex and tag-list pairs and adds a new entry hook for each of them.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">--map</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-new-entry-hook</span>
             <span class="rainbow-delimiters-depth-4-face">(</span>elfeed-make-tagger <span class="builtin">:feed-url</span> <span class="rainbow-delimiters-depth-5-face">(</span>car it<span class="rainbow-delimiters-depth-5-face">)</span>
                                 <span class="builtin">:add</span> <span class="rainbow-delimiters-depth-5-face">(</span>cdr it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   pairs<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-elfeed-auto-tag-title</span> <span class="rainbow-delimiters-depth-2-face">(</span>pairs<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Takes a list of title-regex and tag-list pairs and adds a new entry hook for each of them.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">--map</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">elfeed-new-entry-hook</span>
             <span class="rainbow-delimiters-depth-4-face">(</span>elfeed-make-tagger <span class="builtin">:entry-title</span> <span class="rainbow-delimiters-depth-5-face">(</span>car it<span class="rainbow-delimiters-depth-5-face">)</span>
                                 <span class="builtin">:add</span> <span class="rainbow-delimiters-depth-5-face">(</span>cdr it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   pairs<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">https://github.com/skeeto/.emacs.d/blob/master/etc/feed-setup.el
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">youtube-feed-format</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;^UC&quot;</span> . <span class="string">&quot;https://www.youtube.com/feeds/videos.xml?channel_id=%s&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;^PL&quot;</span> . <span class="string">&quot;https://www.youtube.com/feeds/videos.xml?playlist_id=%s&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;&quot;</span>    . <span class="string">&quot;https://www.youtube.com/feeds/videos.xml?user=%s&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-elfeed--expand</span> <span class="rainbow-delimiters-depth-2-face">(</span>listing<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Expand feed URLs depending on their tags.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">cl-destructuring-bind</span> <span class="rainbow-delimiters-depth-3-face">(</span>url . tags<span class="rainbow-delimiters-depth-3-face">)</span> listing
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>member <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">youtube</span> tags<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>case-fold-search nil<span class="rainbow-delimiters-depth-7-face">)
             (</span>test <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>s r<span class="rainbow-delimiters-depth-9-face">) (</span>string-match-p r s<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>format <span class="rainbow-delimiters-depth-8-face">(</span>cl-assoc url youtube-feed-format <span class="builtin">:test</span> test<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="rainbow-delimiters-depth-8-face">(</span>cdr format<span class="rainbow-delimiters-depth-8-face">)</span> url<span class="rainbow-delimiters-depth-7-face">)</span> tags<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>member <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">reddit</span> tags<span class="rainbow-delimiters-depth-5-face">)
      (</span>cons <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;https://www.reddit.com/r/%s/.rss&quot;</span> url<span class="rainbow-delimiters-depth-6-face">)</span> tags<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>member <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">gh-release</span> tags<span class="rainbow-delimiters-depth-5-face">)
      (</span>cons <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;https://github.com/%s/releases.atom&quot;</span> url<span class="rainbow-delimiters-depth-6-face">)</span> tags<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>listing<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-elfeed-reload-and-open</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Reload and open elfeed.
Useful if .elfeed directory is freshly syncned.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">elfeed</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer <span class="string">&quot;*elfeed-search*&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>jump? <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> buffer <span class="rainbow-delimiters-depth-6-face">(</span>y-or-n-p <span class="string">&quot;Elfeed is already open, do you want to jump without reloading?&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> jump?
      <span class="rainbow-delimiters-depth-4-face">(</span>elfeed-db-load<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>elfeed<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> jump?
      <span class="rainbow-delimiters-depth-4-face">(</span>elfeed-search-update--force<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> empv (music/media/radio/youtube management)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Manage media and streams through =completing-read=.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">empv</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/empv.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">empv--select-action</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;r&quot;</span> empv-map<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">im-radio-channels</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-radio-channels im-radio-channels<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-radio-log-file <span class="string">&quot;~/Documents/notes/songs.org&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-base-directory <span class="string">&quot;~/Music/&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-video-dir <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;~/Videos&quot; &quot;~/Movies&quot;</span> ,<span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;/run/media/%s/BINGUS/Videos&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>user-login-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span> ,<span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;/run/media/%s/FLOPPA/Videos&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>user-login-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-audio-dir <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;~/Music&quot;</span> ,<span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;/run/media/%s/BINGUS/Music&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>user-login-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span> ,<span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;/run/media/%s/FLOPPA/Music&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>user-login-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-allow-insecure-connections t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-invidious-instance im-empv-invidious-instance<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">^ see https://api.invidious.io/
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> empv-youtube-use-tabulated-results t<span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">empv-mpv-args</span> <span class="string">&quot;--ytdl-format=bestvideo+bestaudio/best[ext=mp4]/best&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">empv-mpv-args</span> <span class="string">&quot;--save-position-on-quit&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-reset-playback-speed-on-quit t<span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">empv-init-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">empv-override-quit-key</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">empv-youtube-results-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-line-wrapping</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">setq</span> empv-subsonic-url im-navidrome-server<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-subsonic-username im-navidrome-username<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> empv-subsonic-password im-navidrome-password<span class="rainbow-delimiters-depth-2-face">)

  (</span>evil-make-overriding-map empv-youtube-results-mode-map <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">embark</span> <span class="rainbow-delimiters-depth-3-face">(</span>empv-embark-initialize-extra-actions<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-file-apps</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">mp3</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">ogg</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\'&quot;</span> . <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>path _str<span class="rainbow-delimiters-depth-6-face">) (</span>empv-play-file path<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-export-radio-channels-as-m3u</span> <span class="rainbow-delimiters-depth-2-face">(</span>file<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Export radio list into an M3U FILE.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-file-name
     <span class="string">&quot;Where to save the .m3u file?&quot;
     &quot;~/Documents/sync/&quot;
     &quot;radiolist.m3u&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-temp-file</span> file
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
     im-radio-channels
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span>
      <span class="rainbow-delimiters-depth-5-face">(</span>format
       <span class="string">&quot;#EXTINF:0, %s\n%s&quot;</span>
       <span class="rainbow-delimiters-depth-6-face">(</span>car it<span class="rainbow-delimiters-depth-6-face">)</span>
       <span class="comment-delimiter">;; </span><span class="comment">Replace http:// with icyx://, because VLC on Android can't
</span>       <span class="comment-delimiter">;; </span><span class="comment">retrieve song name if the stream is on http://
</span>       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-contains? <span class="string">&quot;radcap.ru&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>car it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>s-replace <span class="string">&quot;http://&quot; &quot;icyx://&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>cdr it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
         (</span>cdr it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--reduce</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s\n%s&quot;</span> acc it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>s-prepend <span class="string">&quot;#EXTM3U\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> orgmdb (movies &amp; shows)
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have a file called ~watchlist.org~ where I keep list of movies and shows that I watched and going to watch. Here are some packages and functions to deal with them.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">orgmdb</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/orgmdb.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:bind</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:map</span> evil-normal-state-map <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;go&quot;</span> . orgmdb-act<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> orgmdb-omdb-apikey im-orgmdb-omdb-apikey<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> orgmdb-poster-folder <span class="string">&quot;~/Documents/notes/data/posters&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> orgmdb-fill-property-list <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>genre runtime director country imdb-id imdb-link imdb-rating metascore actors poster plot<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> rcirc -- simple, built-in irc client
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">rcirc</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>rcirc-server-alist <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;irc.libera.chat&quot;</span>
                         <span class="builtin">:port</span> 6697
                         <span class="builtin">:nick</span> <span class="string">&quot;isamert&quot;</span>
                         <span class="builtin">:password</span> ,im-libera-chat-password
                         <span class="builtin">:encryption</span> tls
                         <span class="builtin">:channels</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;#rcirc&quot; &quot;#emacs&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-default-nick <span class="string">&quot;isamert&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-default-full-name <span class="string">&quot;Isa Mert Gurbuz&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-prompt <span class="rainbow-delimiters-depth-3-face">(</span>concat
                 <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>all-the-icons-default-adjust 0<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                   (</span>all-the-icons-faicon <span class="string">&quot;angle-double-right&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="warning">&quot;_ &quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-reconnect-delay 15<span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-reconnect-attempts 5<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>evil-set-initial-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">rcirc-mode</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">rcirc-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-rcirc-setup-buffer</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-rcirc-setup-buffer</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">setq-local</span> scroll-conservatively 8192<span class="rainbow-delimiters-depth-2-face">)
  (</span>whitespace-mode -1<span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-omit-mode +1<span class="rainbow-delimiters-depth-2-face">)
  (</span>rcirc-track-minor-mode +1<span class="rainbow-delimiters-depth-2-face">)
  (</span>turn-on-visual-line-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Keybindings
</span>
<span class="comment-delimiter">;; </span><span class="comment">Keybindings are generally set in-place, following have no context,
</span><span class="comment-delimiter">;; </span><span class="comment">so they are here.
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Some general keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;&lt;escape&gt;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">keyboard-escape-quit</span><span class="rainbow-delimiters-depth-1-face">)
(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;C-x &lt;escape&gt;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">keyboard-escape-quit</span><span class="rainbow-delimiters-depth-1-face">)
(</span>global-set-key <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;C-c &lt;escape&gt;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">keyboard-escape-quit</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> prog-mode-map
  <span class="string">&quot;gd&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xref-find-definitions</span>
  <span class="string">&quot;gr&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xref-find-references</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> prog-mode-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">comment-line</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">visual</span> prog-mode-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">comment-dwim</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span> <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-d&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-kill-this-buffer</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span> <span class="string">&quot;1&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>call-interactively <span class="rainbow-delimiters-depth-4-face">(</span>local-key-binding <span class="rainbow-delimiters-depth-5-face">(</span>kbd <span class="string">&quot;C-c C-c&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Programming languages
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> General/language-agnostic functionality
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Jump to beginning/end of a statement
</span>
<span class="comment-delimiter">;; </span><span class="comment">Using [w and ]w, I can jump between statements. For
</span>
<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: should be able to descend down the tree
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-treesit-end-of-statement</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>treesit-end-of-thing
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">rx</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="string">&quot;local_variable&quot; &quot;return&quot; &quot;if&quot; &quot;for&quot; &quot;with&quot; &quot;try&quot; &quot;method&quot; &quot;lexical&quot; &quot;call&quot;</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">or</span> <span class="string">&quot;_statement&quot; &quot;_declaration&quot; &quot;_definition&quot; &quot;_expression&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-treesit-beginning-of-statement</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>treesit-beginning-of-thing
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">rx</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="string">&quot;local_variable&quot; &quot;return&quot; &quot;if&quot; &quot;for&quot; &quot;with&quot; &quot;try&quot; &quot;method&quot; &quot;lexical&quot; &quot;call&quot;</span><span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">or</span> <span class="string">&quot;_statement&quot; &quot;_declaration&quot; &quot;_definition&quot; &quot;_expression&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Only tried in java-ts-mode so far
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> java-ts-mode-map <span class="string">&quot;[w&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-treesit-beginning-of-statement</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> java-ts-mode-map <span class="string">&quot;]w&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-treesit-end-of-statement</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> tsx-ts-mode-map <span class="string">&quot;[w&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-treesit-beginning-of-statement</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> tsx-ts-mode-map <span class="string">&quot;]w&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-treesit-end-of-statement</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> typescript-ts-mode-map <span class="string">&quot;[w&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-treesit-beginning-of-statement</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> typescript-ts-mode-map <span class="string">&quot;]w&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-treesit-end-of-statement</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-make-repeatable</span> im-treesit-statement
  <span class="string">&quot;[&quot;</span> im-treesit-beginning-of-statement
  <span class="string">&quot;]&quot;</span> im-treesit-end-of-statement<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> format-all, apheleia -- Format buffers, automatically
</span>
<span class="comment-delimiter">;; </span><span class="comment">Use =format-all-buffer= function to format current buffer. Works for any language.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">format-all</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>format-all-buffer format-all-region<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">/Apheleia/ is like ~format-all~ but works async and automatically
</span><span class="comment-delimiter">;; </span><span class="comment">formats on buffer save.  I keep both of them because sometimes I
</span><span class="comment-delimiter">;; </span><span class="comment">need ~format-all-buffer~ and it works with more formatters.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">apheleia</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . apheleia-global-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-toggle-auto-code-formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">apheleia-mode</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Disable it inside `</span><span class="constant">emacs-lisp-mode</span><span class="comment">' as I already use
</span>  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">aggressive-indent-mode</span><span class="comment">' for that.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs-lisp-mode-hook</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>apheleia-mode -1<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Display/get currently focused function name in modeline
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">which-function</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . which-function-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-disable-which-func</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>which-function-mode -1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Generally unnecessary and sometimes causes problems
</span><span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-disable-which-func</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> outline-indent-mode -- Code folding based on indendation
</span>
<span class="comment-delimiter">;; </span><span class="comment">I generally use the built-in hs-minor-mode but it does not work
</span><span class="comment-delimiter">;; </span><span class="comment">with all languages. outline-indent is a more generic solution that works
</span><span class="comment-delimiter">;; </span><span class="comment">fairly well.
</span>
<span class="comment-delimiter">;; </span><span class="comment">I used to use origami-mode for the use cases I mentioned but
</span><span class="comment-delimiter">;; </span><span class="comment">outline-indent is much better and makes more sense while
</span><span class="comment-delimiter">;; </span><span class="comment">folding. origami was a bit confusing (as the /thing/ itself).
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">outline-indent</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;jamescherti/outline-indent.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>python . outline-indent-minor-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>python-ts . outline-indent-minor-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>yaml . outline-indent-minor-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>yaml-ts . outline-indent-minor-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>docker-compose-mode . outline-indent-minor-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>sql-mode . outline-indent-minor-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>outline-indent-ellipsis <span class="string">&quot; ▼ &quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> REPLs
</span>
<span class="comment-delimiter">;; </span><span class="comment">I really like being able to do my development inside REPL. It
</span><span class="comment-delimiter">;; </span><span class="comment">creates a really nice feedback loop and fastens the development
</span><span class="comment-delimiter">;; </span><span class="comment">process. While support for this type of development is not good in
</span><span class="comment-delimiter">;; </span><span class="comment">other languages than Lisps, I at least like to have the ability to
</span><span class="comment-delimiter">;; </span><span class="comment">run and evaluate pieces of code in given languages REPL.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here I created a function to ease up that process. For given REPL,
</span><span class="comment-delimiter">;; </span><span class="comment">this creates a background REPL process (like ~jshell~) and sends
</span><span class="comment-delimiter">;; </span><span class="comment">your inputs to REPL and outputs the result to echo area. It's like
</span><span class="comment-delimiter">;; </span><span class="comment">~eval-last-sexp~ but for all languages that has a REPL (and with
</span><span class="comment-delimiter">;; </span><span class="comment">much limited execution functionality of course, you are limited by
</span><span class="comment-delimiter">;; </span><span class="comment">the REPL.)
</span>
<span class="comment-delimiter">;; </span><span class="comment">This creates only one REPL process per language, so you can build
</span><span class="comment-delimiter">;; </span><span class="comment">up a context and use that throughout your projects.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;;&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">general-predicate-dispatch</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-eval-dwim <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eros-eval-last-sexp</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eval-region</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eros-eval-defun</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">java-ts-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jshell-repl-eval</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">js-ts-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-deno-repl-eval</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">typescript-ts-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-deno-repl-eval</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">clojure-mode</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-eval-dwim <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cider-eval-last-sexp</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cider-eval-region</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cider-eval-defun-at-point</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lisp-mode</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-eval-dwim <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slime-eval-last-expression</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slime-eval-region</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slime-eval-region</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">racket-mode</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-eval-dwim <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">racket-eval-last-sexp</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">racket-send-region</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">racket-send-definition</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">scheme-mode</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-eval-dwim <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">geiser-eval-last-sexp</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">geiser-eval-region</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">geiser-eval-definition</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">kotlin-mode</span><span class="rainbow-delimiters-depth-3-face">) (</span>im-eval-dwim <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">kotlin-send-line</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">kotlin-send-region</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">kotlin-send-line</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;'&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">general-predicate-dispatch</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eros-inspect-last-result</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">java-ts-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-repl-inspect-last-result</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">js-ts-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-repl-inspect-last-result</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">typescript-ts-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-repl-inspect-last-result</span>
        <span class="rainbow-delimiters-depth-3-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">clojure-mode</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cider-inspect-last-result</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defconst</span> <span class="variable-name">im-repl-result-buffer</span> <span class="string">&quot;*im-repl-result*&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">im-repl-last-result</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar-local</span> <span class="variable-name">im-repl-send-command</span> nil
  <span class="doc">&quot;REPL send command associated with the buffer.
This helps some functions to work independent of the REPL itself.&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-registered-repls</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;All available REPLs.
Through this, we can select interactively which REPL to use if
it's ambiguous.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-eval-dwim</span> <span class="rainbow-delimiters-depth-2-face">(</span>lastf regionf defunf<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Generate an interactive function that you can bind to a key.
It calls LASTF, REGIONF or DEFUNF depending on the context.  Only
works for Lispy languages.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">()
    (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)
      (</span>call-interactively regionf<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span>?\) ?\&quot;<span class="rainbow-delimiters-depth-7-face">) (</span>char-before<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span>?\ ?\)<span class="rainbow-delimiters-depth-7-face">) (</span>char-after<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>call-interactively lastf<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>t
      <span class="rainbow-delimiters-depth-5-face">(</span>call-interactively defunf<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)


(</span><span class="keyword">defun</span> <span class="function-name">im-repl-send</span> <span class="rainbow-delimiters-depth-2-face">(</span>code<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send CODE to REPL.
If no REPL session is associated with buffer, then let user
select one interactively.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>funcall
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> im-repl-send-command
       <span class="rainbow-delimiters-depth-4-face">(</span>intern <span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="string">&quot;im-&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>downcase <span class="rainbow-delimiters-depth-7-face">(</span>completing-read <span class="string">&quot;Select a REPL: &quot;</span> im-registered-repls<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;-repl-send&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   code<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-repl-inspect-last-result</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Inspect last REPL result in a separate buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek-remove<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create im-repl-result-buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>erase-buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert im-repl-last-result<span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-buffer-visible-p <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>switch-to-buffer-other-window <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-repl-eval-buffer-top-level-forms</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Eval buffer but only some selected types of forms.
Only tested with JS/TS.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>top-level-forms <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;import_statement&quot;
                           &quot;type_alias_declaration&quot;
                           &quot;function_declaration&quot;</span>
                           <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: lexical_declaration → Run only
</span>                           <span class="comment-delimiter">;; </span><span class="comment">if function declarations or a
</span>                           <span class="comment-delimiter">;; </span><span class="comment">constant?
</span>                           <span class="string">&quot;lexical_declaration&quot;
                           &quot;export_statement&quot;
                           &quot;interface_declaration&quot;
                           &quot;class_declaration&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">-&gt;&gt;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>treesit-buffer-root-node<span class="rainbow-delimiters-depth-4-face">)
     (</span>treesit-node-children<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>-contains? top-level-forms <span class="rainbow-delimiters-depth-6-face">(</span>treesit-node-type it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-6-face">(</span>treesit-node-text it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-map <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-repl-send</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defmacro</span> <span class="function-name">im-create-repl</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> name args prefix expr parser input-regexp process-region<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create family of functions for interacting with given REPL of NAME.

NAME is the binary name of the REPL, like jshell, deno etc. (case-insensitive)

ARGS is the arguments passed to NAME.

PREFIX is the prefix used while showing the result in echo area.

INPUT-REGEXP is used to detect the input line of the REPL.

EXPR is the expression finder at point.  Should return a
tree-sitter node.

PARSER is result parser.  Process output is sent to this function
and if the return value is non-nil, result is shown in the echo
area.

As a result, 3 functions are generated:

- im-NAME-repl-start :: Creates the process and starts the repl.
  Process is associated with *NAME-repl* buffer.

- im-NAME-repl-send :: Sends given string to REPL.

- im-NAME-repl-eval :: Entry function.  Just bind this to
  something and it starts a REPL if needed when called and sends
  the current expression (or the selected expression) to REPL.

It was probably a bad idea to use a macro for writing this but I
already had an implementation for \&quot;deno\&quot; and it was quite easy
to turn it into something generic using macros.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>process-var <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;im-%s-repl-process&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>downcase name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>repl-buffer-name <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;*%s-repl*&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>downcase name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>is-repl-running <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()
                             (</span><span class="keyword">and</span> ,process-var <span class="rainbow-delimiters-depth-7-face">(</span>process-live-p ,process-var<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>repl-send-command <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;im-%s-repl-send&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>downcase name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>repl-eval-command <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;im-%s-repl-eval&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>downcase name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>repl-start-command <span class="rainbow-delimiters-depth-5-face">(</span>intern <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;im-%s-repl-start&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>downcase name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defvar</span> ,process-var nil<span class="rainbow-delimiters-depth-4-face">)
       (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-registered-repls</span> ,name<span class="rainbow-delimiters-depth-4-face">)</span>

       <span class="comment-delimiter">;;; </span><span class="comment">defun im-REPL-repl-start
</span>       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defun</span> ,repl-start-command <span class="rainbow-delimiters-depth-5-face">()</span>
         ,<span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;Start (or restart, if already running) the %s REPL on the background.&quot;</span> name<span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>,is-repl-running<span class="rainbow-delimiters-depth-6-face">)
           (</span>delete-process ,process-var<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">setq-local</span> im-repl-send-command <span class="highlight-quoted-quote">#'</span>,repl-send-command<span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">setq</span> im-repl-last-result <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">See this: https://emacs.stackexchange.com/questions/40603/process-input-seems-buggy-in-emacs-on-os-x
</span>         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>process-connection-type nil<span class="rainbow-delimiters-depth-7-face">)
                (</span>repl <span class="rainbow-delimiters-depth-8-face">(</span>start-process ,repl-buffer-name
                                     ,repl-buffer-name
                                     ,<span class="rainbow-delimiters-depth-9-face">(</span>downcase name<span class="rainbow-delimiters-depth-9-face">)</span>
                                     ,@args<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">setq</span> ,process-var repl<span class="rainbow-delimiters-depth-6-face">)
           (</span>set-process-filter
            repl
            <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>proc out<span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">with-current-buffer</span> ,repl-buffer-name
                <span class="rainbow-delimiters-depth-9-face">(</span>goto-char <span class="rainbow-delimiters-depth-1-face">(</span>point-max<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                (</span>insert <span class="rainbow-delimiters-depth-1-face">(</span>ansi-color-apply out<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">setq</span> im-repl-last-result <span class="rainbow-delimiters-depth-9-face">(</span>concat im-repl-last-result <span class="rainbow-delimiters-depth-1-face">(</span>ansi-color-apply out<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-9-face">(</span>s-matches? ,input-regexp out<span class="rainbow-delimiters-depth-9-face">)
                (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>result <span class="rainbow-delimiters-depth-3-face">(</span>,parser im-repl-last-result<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                  (</span><span class="keyword">setq</span> im-repl-last-result result<span class="rainbow-delimiters-depth-1-face">)
                  (</span><span class="keyword">when</span> result
                    <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer im-repl-result-buffer<span class="rainbow-delimiters-depth-3-face">)
                        (</span>im-repl-inspect-last-result<span class="rainbow-delimiters-depth-3-face">)
                      (</span><span class="keyword">progn</span>
                        <span class="rainbow-delimiters-depth-4-face">(</span>message <span class="string">&quot;%s%s&quot;</span> ,prefix <span class="rainbow-delimiters-depth-5-face">(</span>im-kill result<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
                        <span class="comment-delimiter">;; </span><span class="comment">Show it inline
</span>                        <span class="rainbow-delimiters-depth-4-face">(</span>im-peek
                         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()
                           (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-7-face">(</span>get-buffer-create <span class="string">&quot;*im-repl-result-inline*&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                             (</span>erase-buffer<span class="rainbow-delimiters-depth-7-face">)
                             (</span>insert im-repl-last-result<span class="rainbow-delimiters-depth-7-face">)
                             (</span>current-buffer<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>set-process-sentinel
            repl
            <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>proc out<span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>eq <span class="rainbow-delimiters-depth-1-face">(</span>process-exit-status proc<span class="rainbow-delimiters-depth-1-face">)</span> 0<span class="rainbow-delimiters-depth-9-face">)
                  (</span>message ,<span class="rainbow-delimiters-depth-1-face">(</span>format <span class="string">&quot;&gt;&gt; Closed %s REPL session.&quot;</span> name<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                (</span>message ,<span class="rainbow-delimiters-depth-1-face">(</span>format <span class="string">&quot;&gt;&gt; %s REPL has crashed.&quot;</span> name<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>

       <span class="comment-delimiter">;;; </span><span class="comment">defun im-REPL-repl-send
</span>       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defun</span> ,repl-send-command <span class="rainbow-delimiters-depth-5-face">(</span>expr<span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">setq</span> im-repl-last-result <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>str <span class="rainbow-delimiters-depth-8-face">(</span>concat <span class="rainbow-delimiters-depth-9-face">(</span>s-trim expr<span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">with-current-buffer</span> ,repl-buffer-name
             <span class="rainbow-delimiters-depth-7-face">(</span>goto-char <span class="rainbow-delimiters-depth-8-face">(</span>point-max<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>insert str<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>process-send-string ,process-var str<span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span>evil-visual-state-p<span class="rainbow-delimiters-depth-7-face">)
             (</span>evil-force-normal-state<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>

       <span class="comment-delimiter">;;; </span><span class="comment">defun im-REPL-repl-eval
</span>       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">defun</span> ,repl-eval-command <span class="rainbow-delimiters-depth-5-face">()
         (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-6-face">(</span>,is-repl-running<span class="rainbow-delimiters-depth-6-face">)
           (</span>,repl-start-command<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>expr
                <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>use-region-p<span class="rainbow-delimiters-depth-9-face">)
                    (</span>funcall
                     ,process-region
                     <span class="rainbow-delimiters-depth-1-face">(</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-2-face">(</span>region-beginning<span class="rainbow-delimiters-depth-2-face">)
                                                     (</span>region-end<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>curr ,expr<span class="rainbow-delimiters-depth-2-face">)
                        (</span>this-command <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-paste-after</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                    (</span>evil-goggles--show-async-hint
                     <span class="rainbow-delimiters-depth-2-face">(</span>treesit-node-start curr<span class="rainbow-delimiters-depth-2-face">)
                     (</span>treesit-node-end curr<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                    (</span>treesit-node-text curr<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>,repl-send-command expr<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-create-repl</span>
 <span class="builtin">:name</span> <span class="string">&quot;Deno&quot;</span>
 <span class="builtin">:args</span> <span class="rainbow-delimiters-depth-2-face">()</span>
 <span class="builtin">:prefix</span> <span class="string">&quot;=&gt; &quot;</span>
 <span class="comment-delimiter">;; </span><span class="comment">NOTE: After 1.43.1 (?) deno started to return only the results and
</span> <span class="comment-delimiter">;; </span><span class="comment">not the prompt
</span> <span class="builtin">:input-regexp</span> <span class="string">&quot;&quot;</span>
 <span class="builtin">:process-region</span>
 <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>str<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="comment-delimiter">;; </span><span class="comment">Remove block comments before sending, because Deno repl cant
</span>   <span class="comment-delimiter">;; </span><span class="comment">handle them properly.
</span>   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-4-face">(</span>string-match <span class="string">&quot;/\\*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[</span><span class="negation-char">^</span><span class="string">*]</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\\*[</span><span class="negation-char">^</span><span class="string">/]</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">*\\*/&quot;</span> str<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">setq</span> str <span class="rainbow-delimiters-depth-5-face">(</span>replace-match <span class="string">&quot;&quot;</span> t t str<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   str<span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:expr</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-ts-current-expression<span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="comment-delimiter">;; </span><span class="comment">See the note above, we don't need any parsing logic
</span> <span class="builtin">:parser</span> identity<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-create-repl</span>
 <span class="builtin">:name</span> <span class="string">&quot;JShell&quot;</span>
 <span class="builtin">:args</span> nil
 <span class="builtin">:prefix</span> <span class="string">&quot;&quot;</span>
 <span class="builtin">:process-region</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">identity</span>
 <span class="builtin">:input-regexp</span> <span class="string">&quot;jshell&gt;&quot;</span>
 <span class="builtin">:expr</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-ts-current-expression<span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:parser</span>
 <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>out<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">-&gt;&gt;</span>
    out
    <span class="rainbow-delimiters-depth-4-face">(</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>-drop-last 1<span class="rainbow-delimiters-depth-4-face">)
    (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tree-sitter
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">treesit</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . im-install-and-enable-treesit-grammers<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-install-and-enable-treesit-grammers</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Install and enable grammers defined in `</span><span class="constant">treesit-language-source-alist</span><span class="doc">'.
Only for built-in modes.  Others are registered through `</span><span class="constant">use-package</span><span class="doc">'s :mode keyword.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">treesit</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> treesit-language-source-alist
        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>awk <span class="string">&quot;https://github.com/Beaglefoot/tree-sitter-awk&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>bash <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-bash&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>c <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-c&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>c-sharp <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-c-sharp&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>clojure <span class="string">&quot;https://github.com/sogaiu/tree-sitter-clojure&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>cmake <span class="string">&quot;https://github.com/uyha/tree-sitter-cmake&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>commonlisp <span class="string">&quot;https://github.com/tree-sitter-grammars/tree-sitter-commonlisp&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>cpp <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-cpp&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>css <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-css&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>dockerfile <span class="string">&quot;https://github.com/camdencheek/tree-sitter-dockerfile&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>go <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-go&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>gomod <span class="string">&quot;https://github.com/camdencheek/tree-sitter-go-mod&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>html <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-html&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>java <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-java&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>javascript <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-javascript&quot; &quot;master&quot; &quot;src&quot;</span> nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>json <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-json&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>kotlin <span class="string">&quot;https://github.com/fwcd/tree-sitter-kotlin&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)</span>
          <span class="comment-delimiter">;; </span><span class="comment">(latex &quot;https://github.com/latex-lsp/tree-sitter-latex&quot; nil nil nil nil)
</span>          <span class="rainbow-delimiters-depth-4-face">(</span>lua <span class="string">&quot;https://github.com/tree-sitter-grammars/tree-sitter-lua&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>make <span class="string">&quot;https://github.com/tree-sitter-grammars/tree-sitter-make&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)</span>
          <span class="comment-delimiter">;; </span><span class="comment">(markdown &quot;https://github.com/tree-sitter-grammars/tree-sitter-markdown&quot; nil nil nil nil)
</span>          <span class="rainbow-delimiters-depth-4-face">(</span>nix <span class="string">&quot;https://github.com/nix-community/tree-sitter-nix&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>nu <span class="string">&quot;https://github.com/nushell/tree-sitter-nu&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>python <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-python&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>r <span class="string">&quot;https://github.com/r-lib/tree-sitter-r&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>ruby <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-ruby&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>rust <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-rust&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>scala <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-scala&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>sql <span class="string">&quot;https://github.com/DerekStride/tree-sitter-sql&quot; &quot;gh-pages&quot;</span> nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>toml <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-toml&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>tsx <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-typescript&quot; &quot;master&quot; &quot;tsx/src&quot;</span> nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>typescript <span class="string">&quot;https://github.com/tree-sitter/tree-sitter-typescript&quot; &quot;master&quot; &quot;typescript/src&quot;</span> nil nil<span class="rainbow-delimiters-depth-4-face">)
          (</span>yaml <span class="string">&quot;https://github.com/tree-sitter-grammars/tree-sitter-yaml&quot;</span> nil nil nil nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">dolist</span> <span class="rainbow-delimiters-depth-3-face">(</span>source treesit-language-source-alist<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span>treesit-ready-p <span class="rainbow-delimiters-depth-5-face">(</span>car source<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>treesit-install-language-grammar <span class="rainbow-delimiters-depth-5-face">(</span>car source<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">auto-mode-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;\\.ts\\'&quot;</span> . typescript-ts-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">auto-mode-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;\\.tsx\\'&quot;</span> . tsx-ts-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span>
     major-mode-remap-alist
     <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>yaml . yaml-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>toml . toml-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>rust . rust-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>ruby . ruby-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>python-mode . python-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>json-mode . json-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>javascript-mode . js-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>java-mode . java-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>go-mode . go-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>dockerfile-mode . dockerfile-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>css-mode . css-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>cpp-mode . cpp-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>cmake-mode . cmake-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>c++-mode . c++-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>c-mode . c-ts-mode<span class="rainbow-delimiters-depth-5-face">)
       (</span>bash-mode . bash-ts-mode<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> markdown
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">markdown-mode</span>
  <span class="builtin">:mode</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;README\\.md\\'&quot;</span> . gfm-mode<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="string">&quot;\\.md\\'&quot;</span> . gfm-mode<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="string">&quot;\\.markdown\\'&quot;</span> . gfm-mode<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="string">&quot;\\.txt\\'&quot;</span> . gfm-mode<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="string">&quot;qutebrowser-editor-&quot;</span> . gfm-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">markdown-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;&lt;RET&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">markdown-follow-thing-at-point</span>
   <span class="string">&quot;TAB&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">markdown-cycle</span>
   <span class="string">&quot;]]&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">markdown-outline-next</span>
   <span class="string">&quot;[[&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">markdown-outline-previous</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-leader</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">markdown-mode-map</span>
    <span class="string">&quot;oi&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">markdown-toggle-inline-images</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> markdown-command <span class="string">&quot;multimarkdown&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> markdown-fontify-code-blocks-natively t<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> markdown-display-remote-images t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">edit-indirect</span>
  <span class="builtin">:after</span> markdown-mode<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> haskell
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">haskell-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.hs\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">(use-package lsp-haskell
</span><span class="comment-delimiter">;;   </span><span class="comment">:after (lsp haskell)
</span><span class="comment-delimiter">;;   </span><span class="comment">:config
</span><span class="comment-delimiter">;;   </span><span class="comment">(setq lsp-haskell-process-path-hie &quot;ghcide&quot;
</span><span class="comment-delimiter">;;         </span><span class="comment">lsp-haskell-process-args-hie '()))
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> rust
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">rust-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.rs\\'&quot;</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> lsp-rust-server <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">rust-analyzer</span>
        lsp-rust-clippy-preference <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">on</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> web-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">This helps me edit html files with css and javascipt inside them.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">web-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.html\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> javascript
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> jsdoc.el
</span>
<span class="comment-delimiter">;; </span><span class="comment">This is a package I wrote for inserting JSDoc comments easily. Check out the [[https://github.com/im-jsdoc.el][README]].
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">jsdoc</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/jsdoc.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Add node_modules/.bin to PATH automatically
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-add-node-modules-to-path</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Add node_modules/.bin to `</span><span class="constant">exec-path</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-some--&gt;</span> <span class="rainbow-delimiters-depth-3-face">(</span>locate-dominating-file <span class="string">&quot;.&quot; &quot;node_modules&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>expand-file-name it<span class="rainbow-delimiters-depth-3-face">)
    (</span>f-join it <span class="string">&quot;node_modules/.bin&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq-local</span> exec-path <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span>,it ,@exec-path<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">js-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-add-node-modules-to-path</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eshell-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-add-node-modules-to-path</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Helper functions
</span>
<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> make this idempotent, it breaks absolute imports
</span><span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> make it work on a line instead of between quotes
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-js-relative-import-to-abs</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Convert a relative import to an absolute import.
For example, if you are on the line:
  import Test from '</span><span class="constant">../../test</span><span class="doc">'
This function transforms the line into:
  import Test from '</span><span class="constant">src/a/b/test</span><span class="doc">'&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fname <span class="rainbow-delimiters-depth-5-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-6-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">filename</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>bounds <span class="rainbow-delimiters-depth-5-face">(</span>bounds-of-thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">filename</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>delete-region <span class="rainbow-delimiters-depth-4-face">(</span>car bounds<span class="rainbow-delimiters-depth-4-face">) (</span>cdr bounds<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>s-chop-prefix <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">) (</span>expand-file-name fname<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-convert-js-object-to-json</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Convert selected JS object into JSON object.
Example:
  {a: 3, b: 5}
is converted into
  {
    \&quot;a\&quot;: 3,
    \&quot;b\&quot;: 5
  }&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>use-region-p<span class="rainbow-delimiters-depth-3-face">)
      (</span>shell-command-on-region
       <span class="rainbow-delimiters-depth-4-face">(</span>region-beginning<span class="rainbow-delimiters-depth-4-face">)
       (</span>region-end<span class="rainbow-delimiters-depth-4-face">)</span>
       <span class="string">&quot;node -e 'console.log(JSON.stringify(eval(\&quot;(\&quot; + require(\&quot;fs\&quot;).readFileSync(0, \&quot;utf-8\&quot;) + \&quot;)\&quot;), null, 2))'&quot;</span>
       <span class="rainbow-delimiters-depth-4-face">(</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span>
       t<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="warning">user-error</span> <span class="string">&quot;Select something first&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-convert-json-to-js-object</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Convert selected JS object into JSON object.
Example:
  {
    \&quot;a\&quot;: 3,
    \&quot;b\&quot;: 5
  }
is converted into
  {
    a: 3,
    b: 5,
  }&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>use-region-p<span class="rainbow-delimiters-depth-3-face">)
      (</span>shell-command-on-region
       <span class="rainbow-delimiters-depth-4-face">(</span>region-beginning<span class="rainbow-delimiters-depth-4-face">)
       (</span>region-end<span class="rainbow-delimiters-depth-4-face">)</span>
       <span class="string">&quot;node -e 'console.log(require(\&quot;util\&quot;).inspect(JSON.parse(require(\&quot;fs\&quot;).readFileSync(0, \&quot;utf-8\&quot;)), false, null))'&quot;</span>
       <span class="rainbow-delimiters-depth-4-face">(</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span>
       t<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="warning">user-error</span> <span class="string">&quot;Select something first&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Debug helpers
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-refactor-debug-log-text</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return a string in the following format: '</span><span class="constant">BufferName:FunctionName:LineNumber</span><span class="doc">'.
This is used in my snippets.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;%s:%s:%s&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>buffer-name<span class="rainbow-delimiters-depth-3-face">) (</span>which-function<span class="rainbow-delimiters-depth-3-face">) (</span>line-number-at-pos<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-js-insert-debug-log-for-current-variable</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Insert a `</span><span class="constant">console.log</span><span class="doc">' line for currently focused variable.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>curr-indent<span class="rainbow-delimiters-depth-4-face">)
         (</span>node <span class="rainbow-delimiters-depth-5-face">(</span>treesit-node-child-by-field-name
                <span class="rainbow-delimiters-depth-6-face">(</span>car <span class="rainbow-delimiters-depth-7-face">(</span>jsdoc--tsc-find-descendants-with-type
                      <span class="rainbow-delimiters-depth-8-face">(</span>treesit-node-parent <span class="rainbow-delimiters-depth-9-face">(</span>treesit-node-at <span class="rainbow-delimiters-depth-1-face">(</span>point<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                      <span class="string">&quot;variable_declarator&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                <span class="string">&quot;name&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>text <span class="rainbow-delimiters-depth-5-face">(</span>treesit-node-text node<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>treesit-node-end <span class="rainbow-delimiters-depth-5-face">(</span>treesit-node-parent node<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>end-of-line<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> curr-indent <span class="rainbow-delimiters-depth-4-face">(</span>current-indentation<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>make-string curr-indent ? <span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert
     <span class="rainbow-delimiters-depth-4-face">(</span>format
      <span class="string">&quot;console.log(\&quot;%s\&quot;, %s) // </span><span class="default-0037">FIXME</span><span class="string"> remove log&quot;</span>
      <span class="rainbow-delimiters-depth-5-face">(</span>im-refactor-debug-log-text<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="keyword">-&gt;&gt;</span>
       text
       <span class="rainbow-delimiters-depth-6-face">(</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>-map <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">s-trim</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>s-join <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> typescript &amp; deno
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">setq-default</span> typescript-ts-mode-indent-offset 2<span class="rainbow-delimiters-depth-1-face">)

(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">auto-mode-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.ts\\'&quot;</span> . typescript-ts-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">typescript-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-add-node-modules-to-path</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tsx-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-add-node-modules-to-path</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">typescript-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">tsx-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">im-deno</span>
  <span class="builtin">:straight</span> nil
  <span class="builtin">:demand</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> REPL interaction
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-treesit-find-parent-with-type</span> <span class="rainbow-delimiters-depth-2-face">(</span>node wanted-type<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get first parent of NODE where parents type is WANTED-TYPE.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>curr-node node<span class="rainbow-delimiters-depth-4-face">)
        (</span>curr-type nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> curr-node <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>equal curr-type wanted-type<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> curr-node <span class="rainbow-delimiters-depth-5-face">(</span>treesit-node-parent curr-node<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> curr-type <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> curr-node <span class="rainbow-delimiters-depth-6-face">(</span>treesit-node-type curr-node<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    curr-node<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-ts-current-expression</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get smallest meaningful expression (as something that can be sent to REPL).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>current-node <span class="rainbow-delimiters-depth-5-face">(</span>treesit-node-at <span class="rainbow-delimiters-depth-6-face">(</span>point<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>getter <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>it<span class="rainbow-delimiters-depth-6-face">)
                   (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-7-face">(</span>node <span class="rainbow-delimiters-depth-8-face">(</span>im-treesit-find-parent-with-type current-node <span class="rainbow-delimiters-depth-9-face">(</span>car it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                     (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>numberp <span class="rainbow-delimiters-depth-9-face">(</span>cdr it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                         (</span>treesit-node-child node <span class="rainbow-delimiters-depth-9-face">(</span>cdr it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                       node<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">-&gt;&gt;</span>
     <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;lexical_declaration&quot;</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="string">&quot;expression_statement&quot;</span> . 0<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="string">&quot;function_declaration&quot;</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="string">&quot;interface_declaration&quot;</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="string">&quot;enum_declaration&quot;</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="string">&quot;import_statement&quot;</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="string">&quot;class_declaration&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-find getter<span class="rainbow-delimiters-depth-4-face">)
     (</span>funcall getter<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> ob-deno
</span>
<span class="comment-delimiter">;; </span><span class="comment">To allow net access (--allow-net), use &quot;:allow net&quot; in the src
</span><span class="comment-delimiter">;; </span><span class="comment">block header.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Use &quot;return ...&quot; to get the object.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">ob-deno</span>
  <span class="builtin">:after</span> org
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/ob-deno&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src-lang-modes</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;deno&quot;</span> . typescript-ts<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> json
</span>
<span class="comment-delimiter">;; </span><span class="comment">~hs-minor-mode~ works great with JSON.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">json-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">json-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Running JQ or Javascript on given JSON
</span>
<span class="comment-delimiter">;; </span><span class="comment">I work with JSON a lot. Here I have some functions that let's you run given expression on selected JSON.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-nodejs-runner-preface</span>
  <span class="string">&quot;const R = require(\&quot;ramda\&quot;);&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-deno-runner-preface</span>
  <span class="string">&quot;const R = await import(\&quot;https://esm.sh/v122/ramda@0.29.0\&quot;);&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-run-jq-on-json</span> <span class="rainbow-delimiters-depth-2-face">(</span>json expression <span class="type">&amp;optional</span> replace<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given EXPRESSION with jq on JSON and return the result.
If REPLACE is non-nil, then clear the buffer or current
selection and insert the result.

When called with prefix argument, REPLACE becomes non-nil.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>im--read-json-and-expression<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im--run-x-on-json
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-temp-buffer</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>insert json<span class="rainbow-delimiters-depth-4-face">)
     (</span>shell-command-on-region <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">) (</span>point-max<span class="rainbow-delimiters-depth-5-face">) (</span>format <span class="string">&quot;jq -r \&quot;%s\&quot;&quot;</span> expression<span class="rainbow-delimiters-depth-5-face">)</span> nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">t</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-3-face">)</span>
   replace<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-run-nodejs-on-json</span> <span class="rainbow-delimiters-depth-2-face">(</span>json expression <span class="type">&amp;optional</span> replace<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given EXPRESSION with nodejs on JSON and return the result.
If REPLACE is non-nil, then clear the buffer or current
selection and insert the result.

When called with prefix argument, REPLACE becomes non-nil.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>im--read-json-and-expression<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im--run-x-on-json
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-temp-buffer</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>insert im-nodejs-runner-preface<span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;const it = %s;&quot;</span> json<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;JSON.stringify(%s, null, 2)&quot;</span> expression<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>shell-command-on-region <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">) (</span>point-max<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;node -p&quot;</span> nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">t</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-3-face">)</span>
   replace<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-run-deno-on-json</span> <span class="rainbow-delimiters-depth-2-face">(</span>json expression <span class="type">&amp;optional</span> replace<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given EXPRESSION with deno on JSON and return the result.
If REPLACE is non-nil, then clear the buffer or current
selection and insert the result.

When called with prefix argument, REPLACE becomes non-nil.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>im--read-json-and-expression<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im--run-x-on-json
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-temp-buffer</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>insert im-deno-runner-preface<span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;const it = %s;&quot;</span> json<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;console.log(JSON.stringify(%s, null, 2))&quot;</span> expression<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>shell-command-on-region <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">) (</span>point-max<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;deno run --allow-all -&quot;</span> nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">t</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-3-face">)</span>
   replace<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im--run-x-on-json</span> <span class="rainbow-delimiters-depth-2-face">(</span>result interactive? <span class="type">&amp;optional</span> replace<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given EXPRESSION with nodejs on JSON and return the result.
If REPLACE is non-nil, then clear the buffer or current
selection and insert the result.

When called with prefix argument, REPLACE becomes non-nil.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">and</span> interactive?
             <span class="rainbow-delimiters-depth-4-face">(</span>not replace<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>&gt;= <span class="rainbow-delimiters-depth-5-face">(</span>max-mini-window-lines<span class="rainbow-delimiters-depth-5-face">) (</span>length <span class="rainbow-delimiters-depth-6-face">(</span>s-lines result<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>message <span class="string">&quot;&gt;&gt; %s&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-trim result<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="string">&quot;*nodejs-result*&quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>switch-to-buffer-other-window <span class="rainbow-delimiters-depth-6-face">(</span>current-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert result<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> replace <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>delete-region <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">) (</span>region-end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>insert result<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>replace
    <span class="rainbow-delimiters-depth-4-face">(</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)
    (</span>insert result<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  result<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im--read-json-and-expression</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>list
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>use-region-p<span class="rainbow-delimiters-depth-4-face">)
       (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">) (</span>region-end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>json <span class="rainbow-delimiters-depth-7-face">(</span>read-string <span class="string">&quot;JSON (leave empty to use whole buffer): &quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-blank? json<span class="rainbow-delimiters-depth-6-face">)
           (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>point-min<span class="rainbow-delimiters-depth-7-face">) (</span>point-max<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>read-string <span class="string">&quot;Expression: &quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   current-prefix-arg<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;qj&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-run-deno-on-json</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Extra functionality
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-jsons-print-path-python</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>jsons-path-printer <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jsons-print-path-python</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>jsons-print-path<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jsons-print-path-javascript-js-jq</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>jsons-path-printer <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jsons-print-path-jq</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>jsons-print-path<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;  </span><span class="comment">Provides jsons-print-path function, it simply kills the path to the key under point
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">json-snatcher</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Copies paths like:.definition.summary.pastGroup.trackingResults[0].trackingItemReferenceId
</span>  <span class="comment-delimiter">;; </span><span class="comment">I've created two functions above for the variations
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> jsons-path-printer <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jsons-print-path-jq</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Add execution ability to json blocks inside org-mode. Either add
</span><span class="comment-delimiter">;; </span><span class="comment">`:jq some-jq-query' or `:node it.accessor' to code block's header
</span><span class="comment-delimiter">;; </span><span class="comment">to filter the json
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">org-babel-execute:json</span> <span class="rainbow-delimiters-depth-2-face">(</span>body params<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>jq <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>assoc <span class="builtin">:jq</span> params<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>node <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>assoc <span class="builtin">:node</span> params<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>jq <span class="rainbow-delimiters-depth-5-face">(</span>im-run-jq-on-json body jq<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>node <span class="rainbow-delimiters-depth-5-face">(</span>im-run-nodejs-on-json body node<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> scala
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">scala-mode</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">scala</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">sbt</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">worksheet\\.sc</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\'&quot;</span> . scala-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:interpreter</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;scala&quot;</span> . scala-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Enable sbt mode for executing sbt commands
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">sbt-mode</span>
  <span class="builtin">:commands</span> sbt-start sbt-command
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">WORKAROUND: https://github.com/ensime/emacs-sbt-mode/issues/31
</span>  <span class="comment-delimiter">;; </span><span class="comment">allows using SPACE when in the minibuffer
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>substitute-key-definition
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">minibuffer-complete-word</span>
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">self-insert-command</span>
   minibuffer-local-completion-map<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> sbt:program-options <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;-Dsbt.supershell=false&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Supplementary functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-jshell</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open JShell with runtime dependencies of the current project loaded.
Please note that tab-completion for runtime dependencies *do not*
work.  You need to enter full path while importing by yourself.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>vterm-shell <span class="string">&quot;mvn -q com.github.johnpoth:jshell-maven-plugin:1.3:run -DtestClasspath&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">^ This plugin makes it possible to import project's maven dependencies
</span>         <span class="comment-delimiter">;; </span><span class="comment">another option is to use jshell directly.
</span>         <span class="rainbow-delimiters-depth-4-face">(</span>vterm-buffer-name <span class="string">&quot;*vterm-jshell*&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>vterm<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> clojure
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here is the current workflow I use:
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =lein new app project-name=
</span><span class="comment-delimiter">;; </span><span class="comment">- =cider-jack-in=
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">cider</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">cider-inspector-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
    <span class="string">&quot;RET&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cider-inspector-operate-on-point</span>
    <span class="string">&quot;DEL&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">cider-inspector-pop</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> cider-inspector-page-size 50<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> cider-show-error-buffer nil<span class="rainbow-delimiters-depth-2-face">)

  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">clojure-mode-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">clojure-mode-hook</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">aggressive-indent-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outli-heading-config</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>clojure-mode <span class="string">&quot;;;&quot;</span> ?\; t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">compojure</span><span class="comment">' indent
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">define-clojure-indent</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>defroutes <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">defun</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>GET 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>POST 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>PUT 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>DELETE 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>HEAD 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>ANY 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>OPTIONS 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>PATCH 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>rfn 2<span class="rainbow-delimiters-depth-3-face">)
    (</span>let-routes 1<span class="rainbow-delimiters-depth-3-face">)
    (</span>context 2<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> common-lisp
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">slime</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>lisp-mode . slime-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lisp-mode-map-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;K&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">slime-documentation</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>inferior-lisp-program <span class="string">&quot;sbcl&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> emmet-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">Hit &lt;C-j&gt; after these and get:
</span>
<span class="comment-delimiter">;; </span><span class="comment">- =a= ~&lt;a href=&quot;|&quot;&gt;|&lt;/a&gt;~
</span><span class="comment-delimiter">;; </span><span class="comment">- =.x= ~&lt;div class=&quot;x&quot;&gt;&lt;/div&gt;~
</span><span class="comment-delimiter">;; </span><span class="comment">- =br/= ~&lt;br /&gt;~
</span><span class="comment-delimiter">;; </span><span class="comment">- =p.x.y.z= ~&lt;p className=&quot;x y z&quot;&gt;&lt;/p&gt;~ (Works well with JSX)
</span><span class="comment-delimiter">;; </span><span class="comment">- ~input[type=text]~ ~&lt;input type=&quot;text&quot; name=&quot;&quot; value=&quot;&quot;/&gt;~
</span><span class="comment-delimiter">;; </span><span class="comment">- =a&gt;b&gt;c= ~&lt;a href=&quot;&quot;&gt;&lt;b&gt;&lt;c&gt;&lt;/c&gt;&lt;/b&gt;&lt;/a&gt;~
</span><span class="comment-delimiter">;; </span><span class="comment">- =b*3= ~&lt;b&gt;&lt;/b&gt;&lt;b&gt;&lt;/b&gt;&lt;b&gt;&lt;/b&gt;~
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">emmet-mode</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>js-mode css-mode sgml-mode web-mode tsx-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>emmet-expand-jsx-className? t<span class="rainbow-delimiters-depth-2-face">)
  (</span>emmet-self-closing-tag-style <span class="string">&quot; /&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> R-lang
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">ess</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.r\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span>setenv <span class="string">&quot;R_LIBS&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="string">&quot;~/.rlibs&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span>setenv <span class="string">&quot;R_LIBS_USER&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>expand-file-name <span class="string">&quot;~/.rlibs&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> kotlin
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">kotlin-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.kt\\'&quot;</span>
  <span class="builtin">:custom</span>
  <span class="comment-delimiter">;; </span><span class="comment">ki is a better REPL for Kotlin. You can save and reload your session.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>kotlin-command <span class="string">&quot;ki&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> gradle/groovy
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">groovy-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.gradle\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> yaml
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">yaml-ts-mode</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.yaml\\'&quot; &quot;\\.yml\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">yaml-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-indent-minor-mode</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">yaml-ts-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">highlight-indent-guides-mode</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> elisp
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Inspector/debugging/pretty-printing
</span>
<span class="comment-delimiter">;; </span><span class="comment">There is a built-in function (~data-debug-eval-expression~) to
</span><span class="comment-delimiter">;; </span><span class="comment">inspect objects (not good as CIDERs inspector but it works). I made
</span><span class="comment-delimiter">;; </span><span class="comment">a helper function to evaluate last expression and open data-debug
</span><span class="comment-delimiter">;; </span><span class="comment">window of it.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-eval-and-inspect-last-sexp</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">data-debug</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>data-debug-show-stuff <span class="rainbow-delimiters-depth-3-face">(</span>eval-last-sexp nil<span class="rainbow-delimiters-depth-3-face">)</span> <span class="string">&quot;last sexp&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">data-debug-mode</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">data-debug-mode-map</span>
   <span class="string">&quot;RET&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">data-debug-expand-or-contract</span>
   <span class="string">&quot;TAB&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">data-debug-expand-or-contract</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">There is also ~pp-eval-last-sexp~ which evaluates and pretty-prints
</span><span class="comment-delimiter">;; </span><span class="comment">the result of last expression in a separate buffer, which can be
</span><span class="comment-delimiter">;; </span><span class="comment">better for inspection sometimes.
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> eros
</span>
<span class="comment-delimiter">;; </span><span class="comment">Like CIDER, it shows the results of ~eval-last-sexp~ etc. in an
</span><span class="comment-delimiter">;; </span><span class="comment">overlay, right next to the expression itself. There is also
</span><span class="comment-delimiter">;; </span><span class="comment">~eros-inspect-last-result~ which essentially shows the result of
</span><span class="comment-delimiter">;; </span><span class="comment">last evaluation in a pretty printed format in a different buffer.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">eros</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/eros&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . eros-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">eros-inspect-hooks</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>flycheck-mode -1<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Pretty stuff
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span>
  im-elisp-pretty-symbols
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;&gt;=&quot;</span>     . ?≥<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;&lt;=&quot;</span>     . ?≤<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;defun&quot;</span>  . ?ƒ<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;interactive&quot;</span> . ?⎇<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;lambda&quot;</span> . ?λ<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;thread-last&quot;</span> . ?↠<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;thread-first&quot;</span> . ?→<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;-&gt;&gt;&quot;</span> . ?↠<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;-&gt;&quot;</span> . ?→<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-prettify-mode</span> emacs-lisp-mode-hook im-elisp-pretty-symbols<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">im-prettify-mode</span> lisp-interaction-mode-hook im-elisp-pretty-symbols<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Highlights quotes. Surprisingly useful
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">highlight-quoted</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>emacs-lisp-mode . highlight-quoted-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Linting &amp; package development
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">package-lint</span>
  <span class="builtin">:commands</span> package-lint-current-buffer<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">flycheck-package</span>
  <span class="builtin">:after</span> flycheck
  <span class="builtin">:config</span> <span class="rainbow-delimiters-depth-2-face">(</span>flycheck-package-setup<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Folding
</span>
<span class="rainbow-delimiters-depth-1-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs-lisp-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lisp-interaction-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">hs-minor-mode</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Indentation fix
</span>
<span class="comment-delimiter">;; </span><span class="comment">Taken from: https://github.com/Fuco1/.emacs.d/blob/2c302dcbedf2722c5c412b6a6d3e3258f6ac1ccf/site-lisp/my-redef.el#LL18C1-L100C62
</span><span class="comment-delimiter">;; </span><span class="comment">Redefines the silly indent of keyword lists
</span><span class="comment-delimiter">;; </span><span class="comment">before
</span><span class="comment-delimiter">;;   </span><span class="comment">(:foo bar
</span><span class="comment-delimiter">;;         </span><span class="comment">:baz qux)
</span><span class="comment-delimiter">;; </span><span class="comment">after
</span><span class="comment-delimiter">;;   </span><span class="comment">(:foo bar
</span><span class="comment-delimiter">;;    </span><span class="comment">:baz qux)
</span><span class="rainbow-delimiters-depth-1-face">(</span>eval-after-load <span class="string">&quot;lisp-mode&quot;</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defun</span> <span class="function-name">lisp-indent-function</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent-point state<span class="rainbow-delimiters-depth-3-face">)</span>
     <span class="doc">&quot;This function is the normal value of the variable `</span><span class="constant">lisp-indent-function</span><span class="doc">'.
The function `</span><span class="constant">calculate-lisp-indent</span><span class="doc">' calls this to determine
if the arguments of a Lisp function call should be indented specially.

INDENT-POINT is the position at which the line being indented begins.
Point is located at the point to indent under (for default indentation);
STATE is the `</span><span class="constant">parse-partial-sexp</span><span class="doc">' state for that position.

If the current line is in a call to a Lisp function that has a non-nil
property `</span><span class="constant">lisp-indent-function</span><span class="doc">' (or the deprecated `</span><span class="constant">lisp-indent-hook</span><span class="doc">'),
it specifies how to indent.  The property value can be:

* `</span><span class="constant">defun</span><span class="doc">', meaning indent `</span><span class="constant">defun</span><span class="doc">'-style
  </span><span class="warning">\</span><span class="doc">(this is also the case if there is no property and the function
  has a name that begins with \&quot;def\&quot;, and three or more arguments);

* an integer N, meaning indent the first N arguments specially
  (like ordinary function arguments), and then indent any further
  arguments like a body;

* a function to call that returns the indentation (or nil).
  `</span><span class="constant">lisp-indent-function</span><span class="doc">' calls this function with the same two arguments
  that it itself received.

This function returns either the indentation to use, or nil if the
Lisp function does not specify a special indentation.&quot;</span>
     <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>normal-indent <span class="rainbow-delimiters-depth-6-face">(</span>current-column<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>orig-point <span class="rainbow-delimiters-depth-6-face">(</span>point<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>1+ <span class="rainbow-delimiters-depth-6-face">(</span>elt state 1<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>parse-partial-sexp <span class="rainbow-delimiters-depth-5-face">(</span>point<span class="rainbow-delimiters-depth-5-face">)</span> calculate-lisp-indent-last-sexp 0 t<span class="rainbow-delimiters-depth-4-face">)
       (</span><span class="keyword">cond</span>
        <span class="comment-delimiter">;; </span><span class="comment">car of form doesn't seem to be a symbol, or is a keyword
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-7-face">(</span>elt state 2<span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span>not <span class="rainbow-delimiters-depth-9-face">(</span>looking-at <span class="string">&quot;\\sw</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\\s_&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                  (</span>looking-at <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>&gt; <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">save-excursion</span> <span class="rainbow-delimiters-depth-1-face">(</span>forward-line 1<span class="rainbow-delimiters-depth-1-face">) (</span>point<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
                     calculate-lisp-indent-last-sexp<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-8-face">(</span>goto-char calculate-lisp-indent-last-sexp<span class="rainbow-delimiters-depth-8-face">)
                    (</span>beginning-of-line<span class="rainbow-delimiters-depth-8-face">)
                    (</span>parse-partial-sexp <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)</span>
                                        calculate-lisp-indent-last-sexp 0 t<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">Indent under the list or under the first sexp on the same
</span>         <span class="comment-delimiter">;; </span><span class="comment">line as calculate-lisp-indent-last-sexp.  Note that first
</span>         <span class="comment-delimiter">;; </span><span class="comment">thing on that line has to be complete sexp since we are
</span>         <span class="comment-delimiter">;; </span><span class="comment">inside the innermost containing sexp.
</span>         <span class="rainbow-delimiters-depth-6-face">(</span>backward-prefix-chars<span class="rainbow-delimiters-depth-6-face">)
         (</span>current-column<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">save-excursion</span>
                <span class="rainbow-delimiters-depth-8-face">(</span>goto-char indent-point<span class="rainbow-delimiters-depth-8-face">)
                (</span>skip-syntax-forward <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-8-face">)
                (</span>not <span class="rainbow-delimiters-depth-9-face">(</span>looking-at <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">save-excursion</span>
                <span class="rainbow-delimiters-depth-8-face">(</span>goto-char orig-point<span class="rainbow-delimiters-depth-8-face">)
                (</span>looking-at <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">save-excursion</span>
           <span class="rainbow-delimiters-depth-7-face">(</span>goto-char <span class="rainbow-delimiters-depth-8-face">(</span>+ 2 <span class="rainbow-delimiters-depth-9-face">(</span>elt state 1<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>current-column<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>t
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>function <span class="rainbow-delimiters-depth-9-face">(</span>buffer-substring <span class="rainbow-delimiters-depth-1-face">(</span>point<span class="rainbow-delimiters-depth-1-face">)
                                           (</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-2-face">(</span>forward-sexp 1<span class="rainbow-delimiters-depth-2-face">) (</span>point<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
               method<span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">setq</span> method <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-9-face">(</span>function-get <span class="rainbow-delimiters-depth-1-face">(</span>intern-soft function<span class="rainbow-delimiters-depth-1-face">)</span>
                                          <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lisp-indent-function</span><span class="rainbow-delimiters-depth-9-face">)
                            (</span>get <span class="rainbow-delimiters-depth-1-face">(</span>intern-soft function<span class="rainbow-delimiters-depth-1-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lisp-indent-hook</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span><span class="keyword">cond</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-1-face">(</span>eq method <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">defun</span><span class="rainbow-delimiters-depth-1-face">)
                      (</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-2-face">(</span>null method<span class="rainbow-delimiters-depth-2-face">)
                           (</span>&gt; <span class="rainbow-delimiters-depth-3-face">(</span>length function<span class="rainbow-delimiters-depth-3-face">)</span> 3<span class="rainbow-delimiters-depth-2-face">)
                           (</span>string-match <span class="string">&quot;\\`def&quot;</span> function<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                  (</span>lisp-indent-defform state indent-point<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                 (</span><span class="rainbow-delimiters-depth-9-face">(</span>integerp method<span class="rainbow-delimiters-depth-9-face">)
                  (</span>lisp-indent-specform method state
                                        indent-point normal-indent<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                 (</span>method
                  <span class="rainbow-delimiters-depth-9-face">(</span>funcall method indent-point state<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> doctest.el
</span>
<span class="comment-delimiter">;; </span><span class="comment">See this:
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://ag91.github.io/blog/2023/03/20/doctestel-or-testing-your-pure-elisp-functions-in-your-docstring/][Doctest.el
</span><span class="comment-delimiter">;; </span><span class="comment">or testing your pure Elisp functions in your docstring - Where
</span><span class="comment-delimiter">;; </span><span class="comment">parallels cross]]
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">doctest</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;ag91/doctest&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>doctest doctest-here doctest-defun<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> suggest.el -- Function suggestions
</span>
<span class="comment-delimiter">;; </span><span class="comment">Do ~M-x suggest~, enter the inputs and the expected output and
</span><span class="comment-delimiter">;; </span><span class="comment">it'll suggest you some functions. Quite nice and useful, I used it
</span><span class="comment-delimiter">;; </span><span class="comment">plenty of time.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">suggest</span>
  <span class="builtin">:commands</span> suggest<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> emr &amp; redshank -- refactoring tools
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">redshank</span>
  <span class="comment-delimiter">;; </span><span class="comment">All interactive redshank commands
</span>  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>redshank-maybe-splice-progn
             redshank-point-at-enclosing-let-form
             redshank-ignore-event
             redshank-asdf-insert-module-components
             redshank-highlight-binder
             redshank-unhighlight-binder
             redshank-slime-uninstall
             redshank-letify-form
             redshank-backward-down-list
             redshank-letify-form-up
             redshank-extract-to-defun
             redshank-enclose-form-with-lambda
             redshank-condify-form
             redshank-eval-whenify-form
             redshank-rewrite-negated-predicate
             redshank-elisp-generate-form
             redshank-lisp-generate-form
             redshank-generate-thing-at-point
             redshank-defclass-skeleton
             redshank-define-condition-skeleton<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">emr</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/emacs-refactor&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Racket
</span>
<span class="comment-delimiter">;; </span><span class="comment">- Open a racket buffer.
</span><span class="comment-delimiter">;; </span><span class="comment">- Do C-c C-c (racket-run)
</span><span class="comment-delimiter">;; </span><span class="comment">- It'll drop you on a REPL within the scope of the file.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">racket-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.rkt\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> dhall
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">dhall-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.dhall\\'&quot;</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">I use dhall-lsp-server, so I don't need this
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> dhall-use-header-line nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> nix
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">nix-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.nix\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-import-env-from-nix-shell</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>file-exists-p <span class="string">&quot;shell.nix&quot;</span><span class="rainbow-delimiters-depth-6-face">) (</span>executable-find <span class="string">&quot;nix-shell&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">error</span> <span class="string">&quot;Failed to find shell.nix or nix-shell&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--&gt;</span> <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string <span class="string">&quot;nix-shell --quiet --run '</span><span class="constant">env</span><span class="string">'&quot;</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>split-string it <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
         (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>name val<span class="rainbow-delimiters-depth-8-face">) (</span>s-split-up-to <span class="string">&quot;=&quot;</span> it 1<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span>setenv name val<span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span>string-equal name <span class="string">&quot;PATH&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span><span class="keyword">setq</span> exec-path <span class="rainbow-delimiters-depth-8-face">(</span>split-string val path-separator<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span>,name ,val<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Done.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> swift
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">swift-mode</span> <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> scheme
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">scheme</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outli</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outli-heading-config</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span>scheme-mode <span class="string">&quot;;;&quot;</span> ?\; t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">geiser</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:commands</span> geiser
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>geiser-debug-jump-to-debug-p nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>geiser-default-implementation <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">guile</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">geiser</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>evil-collection-geiser-setup<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">geiser-guile</span>
  <span class="builtin">:after</span> geiser
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Docker stuff
</span>
<span class="comment-delimiter">;; </span><span class="comment">Some major modes for editing files.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">dockerfile-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;Dockerfile\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">use-package</span> <span class="constant">docker-compose-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;docker-compose\\'&quot;</span>
  <span class="builtin">:hook</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>docker-compose-mode . highlight-indent-guides-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">A package for  managing docker.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">docker</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> docker-container-mode-map <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">docker-container-help</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> docker-image-mode-map     <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">docker-image-help</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> docker-machine-mode-map   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">docker-machine-help</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> docker-network-mode-map   <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">docker-network-help</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> docker-volume-mode-map    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">docker-volume-help</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> vimrc
</span>
<span class="comment-delimiter">;; </span><span class="comment">Mostly for editing tridactyl and sometimes real vimrc.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">vimrc-mode</span> <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Graphviz/dot
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">graphviz-dot-mode</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.dot\\'&quot; &quot;\\.gv\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src-lang-modes</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;dot&quot;</span> . graphviz-dot<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> PlantUML
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">plantuml-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">plantuml</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">pum</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">plu</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\'&quot;</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-src-lang-modes</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;plantuml&quot;</span> . plantuml<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> plantuml-default-exec-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jar</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> plantuml-jar-path <span class="string">&quot;/nix/store/q0v5nv70zc23fx4hjgghnqf7lvydr6fq-plantuml-1.2021.3/lib/plantuml.jar&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> org-plantuml-jar-path plantuml-jar-path<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Couchbase
</span>
<span class="comment-delimiter">;; </span><span class="comment">Install couchbase-query package for running interactive queries
</span><span class="comment-delimiter">;; </span><span class="comment">inside emacs.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">couchbase-query</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/couchbase-query.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>couchbase-query-command <span class="string">&quot;/Applications/Couchbase Server.app/Contents/Resources/couchbase-core/bin/cbq&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Create a mode for n1ql and make n1ql code blocks inside org-mode
</span><span class="comment-delimiter">;; </span><span class="comment">runnable.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Create a dummy derived mode based on sql-mode for n1ql, so that we
</span><span class="comment-delimiter">;; </span><span class="comment">get some syntax highlighting for free
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-derived-mode</span> <span class="function-name">n1ql-mode</span> sql-mode <span class="string">&quot;n1ql-mode&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">auto-mode-alist</span> <span class="rainbow-delimiters-depth-2-face">(</span>cons <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">rx</span> <span class="string">&quot;.n1ql&quot;</span> string-end<span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">n1ql-mode</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Add a function to execute n1ql code blocks in org-mode. It works
</span><span class="comment-delimiter">;; </span><span class="comment">just like how sql-mode code blocks is executed
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">org-babel-execute:n1ql</span> <span class="rainbow-delimiters-depth-2-face">(</span>body params<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-cbq
   body
   <span class="builtin">:host</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:host</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:username</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:username</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:password</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:password</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:select</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>alist-get <span class="builtin">:select</span> params<span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)


(</span><span class="keyword">cl-defun</span> <span class="function-name">im-cbq</span> <span class="rainbow-delimiters-depth-2-face">(</span>query <span class="type">&amp;key</span> host username password <span class="rainbow-delimiters-depth-3-face">(</span>select <span class="string">&quot;.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run a couchbase query and return the result.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>insert query<span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command-on-region
     <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)
     (</span>point-max<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;cbq -quiet -engine '</span><span class="constant">%s</span><span class="string">' -credentials '</span><span class="constant">%s</span><span class="string">'&quot;</span>
             host
             <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s:%s&quot;</span> username password<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     nil t<span class="rainbow-delimiters-depth-3-face">)
    (</span>replace-regexp-in-region <span class="string">&quot;^cbq&gt; &quot; &quot;&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">) (</span>point-max<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command-on-region <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">) (</span>point-max<span class="rainbow-delimiters-depth-4-face">) (</span>format <span class="string">&quot;jq -r '</span><span class="constant">%s</span><span class="string">'&quot;</span> select<span class="rainbow-delimiters-depth-4-face">)</span> nil t<span class="rainbow-delimiters-depth-3-face">)
    (</span>buffer-string<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Create a mode for cbc binary and make cbc-mode code blocks runnable
</span><span class="comment-delimiter">;; </span><span class="comment">inside emacs. cbc is not able to read commands from a file, so it
</span><span class="comment-delimiter">;; </span><span class="comment">does not really makes sense to create a mode for it but I do this
</span><span class="comment-delimiter">;; </span><span class="comment">to be able to create code blocks in org mode for cbc commands so
</span><span class="comment-delimiter">;; </span><span class="comment">that I can save some commands in an org file and re-run them
</span><span class="comment-delimiter">;; </span><span class="comment">whenever I want.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-generic-mode</span> <span class="highlight-quoted-quote">'</span><span class="function-name">cbc-mode</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>?!<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;help&quot; &quot;version&quot; &quot;cat&quot; &quot;create&quot; &quot;create&quot; &quot;cp&quot; &quot;incr&quot; &quot;decr&quot; &quot;touch&quot; &quot;rm&quot; &quot;hash&quot; &quot;stats&quot; &quot;observe&quot; &quot;view&quot; &quot;lock&quot; &quot;unlock&quot; &quot;admin&quot; &quot;bucket&quot; &quot;bucket&quot; &quot;bucket&quot; &quot;role&quot; &quot;user&quot; &quot;user&quot; &quot;user&quot; &quot;connstr&quot; &quot;query&quot; &quot;write&quot; &quot;strerror&quot; &quot;ping&quot; &quot;watch&quot; &quot;keygen&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  nil
  <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;cbc\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  nil
  <span class="doc">&quot;Simple mode for couchbase cbc commandline utility.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">org-babel-execute:cbc</span> <span class="rainbow-delimiters-depth-2-face">(</span>body params<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-cbc
   body
   <span class="builtin">:host</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:host</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:username</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:username</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:password</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:password</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:bucket</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="builtin">:bucket</span> params<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:select</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>alist-get <span class="builtin">:select</span> params<span class="rainbow-delimiters-depth-4-face">)</span> <span class="string">&quot;.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-cbc</span> <span class="rainbow-delimiters-depth-2-face">(</span>cbc-command <span class="type">&amp;key</span> host username password bucket raw <span class="rainbow-delimiters-depth-3-face">(</span>select <span class="string">&quot;.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given cbc command.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>cmd <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;cbc %s --spec=%s/%s --username='</span><span class="constant">%s</span><span class="string">' --password='</span><span class="constant">%s</span><span class="string">'&quot;</span>
                      cbc-command
                      host
                      bucket
                      username
                      password<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;im-cbc :: %s&quot;</span> cmd<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-temp-buffer</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>im-shell-command-to-string cmd<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>shell-command-on-region
       <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)
       (</span>point-max<span class="rainbow-delimiters-depth-5-face">)
       (</span>format <span class="string">&quot;jq %s '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> raw <span class="string">&quot;-r&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span> select<span class="rainbow-delimiters-depth-5-face">)</span>
       nil
       t<span class="rainbow-delimiters-depth-4-face">)
      (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> BigQuery
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-derived-mode</span> <span class="function-name">bqsql-mode</span> sql-mode <span class="string">&quot;bqsql-mode&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">auto-mode-alist</span> <span class="rainbow-delimiters-depth-2-face">(</span>cons <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">rx</span> <span class="string">&quot;.bqsql&quot;</span> string-end<span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bqsql-mode</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">org-babel-expand-body:bqsql</span> <span class="rainbow-delimiters-depth-2-face">(</span>body params<span class="rainbow-delimiters-depth-2-face">)
  (</span>s-format
   body
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>key alist<span class="rainbow-delimiters-depth-4-face">) (</span>assoc-default <span class="rainbow-delimiters-depth-5-face">(</span>intern key<span class="rainbow-delimiters-depth-5-face">)</span> alist<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>mapcar <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>x<span class="rainbow-delimiters-depth-5-face">) (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>eq <span class="rainbow-delimiters-depth-7-face">(</span>car x<span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:var</span><span class="rainbow-delimiters-depth-6-face">) (</span>cdr x<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span> params<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">org-babel-execute:bqsql</span> <span class="rainbow-delimiters-depth-2-face">(</span>query params<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Execute QUERY with given PARAMS.
`</span><span class="constant">:var</span><span class="doc">' syntax is ${var_name} and replaced as-is.

`</span><span class="constant">:format</span><span class="doc">' can be either `</span><span class="constant">org-table</span><span class="doc">', `</span><span class="constant">table</span><span class="doc">' or `</span><span class="constant">json</span><span class="doc">'.  Former outputs
an org table, other one outputs the result as json.  By default, it's
`</span><span class="constant">org-table</span><span class="doc">'.  `</span><span class="constant">org-table</span><span class="doc">' means the output is a regular org mode table.
`</span><span class="constant">table</span><span class="doc">' means the output is `</span><span class="constant">table.el</span><span class="doc">' formatted table (it is actually
what is returned from bq command with the `</span><span class="constant">pretty</span><span class="doc">' formatting option).

If `</span><span class="constant">:buffer</span><span class="doc">' is non-nil, then output results to a buffer, instead
of the results drawer.

If `</span><span class="constant">:cmd</span><span class="doc">' is non-nil, then instead of executing query, print out
the resulting bq command.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>job-id <span class="rainbow-delimiters-depth-5-face">(</span>im-uuid<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>dry-run? <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="builtin">:dry-run</span> params<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>format <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>alist-get <span class="builtin">:format</span> params<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;org-table&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>api <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="builtin">:api</span> params<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>project-id <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="builtin">:project-id</span> params<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>buffer? <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="builtin">:buffer</span> params<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>cmd? <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="builtin">:cmd</span> params<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>json-out? <span class="rainbow-delimiters-depth-5-face">(</span>s-matches? <span class="string">&quot;json&quot;</span> format<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>buf <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="string">&quot;*im-big-querysql*&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>org-buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>start-time <span class="rainbow-delimiters-depth-5-face">(</span>float-time<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
         cmd cmd-str
         process
         <span class="rainbow-delimiters-depth-4-face">(</span>vars <span class="rainbow-delimiters-depth-5-face">(</span>org-babel--get-vars params<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> query <span class="rainbow-delimiters-depth-4-face">(</span>org-babel-expand-body:bqsql query params<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> cmd <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;query&quot;</span> ,buf <span class="string">&quot;bq&quot; &quot;query&quot;</span>
                ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> api <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;--api&quot;</span> ,api<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> dry-run? <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;--dry_run&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> project-id <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;--project_id&quot;</span> ,project-id<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                <span class="string">&quot;--quiet&quot; &quot;--max_rows&quot; &quot;100000&quot; &quot;--nouse_legacy_sql&quot;
                &quot;--format&quot;</span> ,<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">pcase</span> format
                              <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="string">&quot;org-table&quot; &quot;table&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;pretty&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                              (</span>x x<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                <span class="string">&quot;--job_id&quot;</span> ,job-id ,query<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> cmd-str <span class="rainbow-delimiters-depth-4-face">(</span>s-join
                   <span class="string">&quot; &quot;</span>
                   <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>not <span class="rainbow-delimiters-depth-8-face">(</span>s-prefix? <span class="string">&quot;--&quot;</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                              (</span>format <span class="string">&quot;\&quot;%s\&quot;&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-replace <span class="string">&quot;\&quot;&quot; &quot;\\\&quot;&quot;</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
                            it<span class="rainbow-delimiters-depth-6-face">)
                          (</span>-drop 2 cmd<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> cmd?
      <span class="rainbow-delimiters-depth-4-face">(</span>org-babel-insert-result cmd-str<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;Done&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> buf
      <span class="rainbow-delimiters-depth-4-face">(</span>buffer-disable-undo<span class="rainbow-delimiters-depth-4-face">)
      (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-ensure-binary <span class="string">&quot;bq&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;google-cloud-sdk&quot;</span> <span class="builtin">:installer</span> <span class="string">&quot;nix-env -iA&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> process <span class="rainbow-delimiters-depth-4-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">start-process</span> cmd<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>set-process-sentinel
     process
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>p m<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>end-time <span class="rainbow-delimiters-depth-8-face">(</span>float-time<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>result <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">with-current-buffer</span> buf
                        <span class="comment-delimiter">;; </span><span class="comment">Convert pretty table into an org mode table
</span>                        <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-1-face">(</span>equal <span class="string">&quot;org-table&quot;</span> format<span class="rainbow-delimiters-depth-1-face">)
                          (</span>goto-char <span class="rainbow-delimiters-depth-2-face">(</span>point-min<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                          (</span>skip-chars-forward <span class="string">&quot;\n\t &quot;</span><span class="rainbow-delimiters-depth-1-face">)
                          (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-2-face">(</span>looking-at <span class="string">&quot;^\\+&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                            (</span>kill-line 1<span class="rainbow-delimiters-depth-2-face">)
                            (</span>forward-line 1<span class="rainbow-delimiters-depth-2-face">)
                            (</span>delete-char 1<span class="rainbow-delimiters-depth-2-face">)
                            (</span>insert <span class="string">&quot;|&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                            (</span>end-of-line<span class="rainbow-delimiters-depth-2-face">)
                            (</span>delete-char -1<span class="rainbow-delimiters-depth-2-face">)
                            (</span>insert <span class="string">&quot;|&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                            (</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-max<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                            (</span>skip-chars-backward <span class="string">&quot;\n\t &quot;</span><span class="rainbow-delimiters-depth-2-face">)
                            (</span>beginning-of-line<span class="rainbow-delimiters-depth-2-face">)
                            (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>looking-at <span class="string">&quot;^\\+&quot;</span><span class="rainbow-delimiters-depth-3-face">)
                              (</span>kill-line 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                        (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-1-face">(</span>point-min<span class="rainbow-delimiters-depth-1-face">) (</span>point-max<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>msg <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;=&gt; Query finished, time elapsed: %s&quot;</span>
                           <span class="rainbow-delimiters-depth-9-face">(</span>format-seconds <span class="string">&quot;%Y %D %H %M %z%S&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>- end-time start-time<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>bname <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;*bqsql:%s&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-1-face">(</span>eq buffer? t<span class="rainbow-delimiters-depth-1-face">)</span> job-id buffer?<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
              found?<span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">with-current-buffer</span> org-buffer
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">save-excursion</span>
             <span class="rainbow-delimiters-depth-8-face">(</span>goto-char <span class="rainbow-delimiters-depth-9-face">(</span>point-max<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">setq</span> found? <span class="rainbow-delimiters-depth-9-face">(</span>re-search-backward job-id nil t<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> buffer? <span class="rainbow-delimiters-depth-1-face">(</span>not found?<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
               (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-1-face">(</span>get-buffer-create bname<span class="rainbow-delimiters-depth-1-face">)
                 (</span>erase-buffer<span class="rainbow-delimiters-depth-1-face">)
                 (</span>insert result<span class="rainbow-delimiters-depth-1-face">)
                 (</span><span class="keyword">if</span> json-out?
                     <span class="rainbow-delimiters-depth-2-face">(</span>json-ts-mode<span class="rainbow-delimiters-depth-2-face">)
                   (</span><span class="keyword">progn</span>
                     <span class="rainbow-delimiters-depth-3-face">(</span>org-mode<span class="rainbow-delimiters-depth-3-face">)
                     (</span>im-disable-line-wrapping<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                 (</span><span class="keyword">setq</span> header-line-format msg<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
               (</span><span class="keyword">unless</span> found?
                 <span class="rainbow-delimiters-depth-1-face">(</span><span class="warning">user-error</span> <span class="string">&quot;Org-block is gone.  Result inserted to the buffer %s&quot;</span> bname<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span>forward-line -4<span class="rainbow-delimiters-depth-8-face">)
             (</span>org-babel-insert-result
              <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">if</span> buffer? msg result<span class="rainbow-delimiters-depth-9-face">)
              (</span>list <span class="string">&quot;replace&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cond</span>
                               <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span>s-prefix? <span class="string">&quot;Error&quot;</span> result<span class="rainbow-delimiters-depth-3-face">)</span> <span class="string">&quot;drawer&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                               (</span>buffer? <span class="string">&quot;drawer&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                               (</span>json-out? <span class="string">&quot;lang&quot;</span><span class="rainbow-delimiters-depth-2-face">)
                               (</span>t <span class="string">&quot;raw&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
              nil
              nil
              <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when</span> json-out? <span class="string">&quot;json&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">when</span> buffer?
               <span class="rainbow-delimiters-depth-9-face">(</span>switch-to-buffer-other-window bname<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    job-id<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-big-query--fix-table-name</span> <span class="rainbow-delimiters-depth-2-face">(</span>table-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Fix table name by replacing first `</span><span class="constant">.</span><span class="doc">' with `</span><span class="constant">:</span><span class="doc">'.
This is the format that `</span><span class="constant">bq</span><span class="doc">' tool expects.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>s-replace-regexp <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[A-Za-z0-9_-]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\.&quot; &quot;\\1:&quot;</span> table-name<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-big-query-job-status</span> <span class="rainbow-delimiters-depth-2-face">(</span>job-id<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get status for given job id.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Job ID: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>im-region-or <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">symbol</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buf <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;*im-bigquery: %s*&quot;</span> job-id<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer buf<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;bq show %s -j '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> current-prefix-arg <span class="string">&quot;--format=prettyjson&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span> job-id<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-big-query-table-info</span> <span class="rainbow-delimiters-depth-2-face">(</span>table-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get summary information for TABLE-NAME.
This information includes schema summary, last modified date,
total {rows,bytes} etc. and first 10 rows of the table.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string
          <span class="string">&quot;Table: &quot;</span>
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">ignore-errors</span>
            <span class="rainbow-delimiters-depth-6-face">(</span>im-region-or
             <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">() (</span>im-inner-back-quote-at-point<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> table-name <span class="rainbow-delimiters-depth-3-face">(</span>im-big-query--fix-table-name table-name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer-name <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;*bq table info: %s*&quot;</span> table-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:buffer-name</span> buffer-name
     <span class="builtin">:switch</span> t
     <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;bq show '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">im-tap</span> table-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-start</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span>toggle-truncate-lines +1<span class="rainbow-delimiters-depth-5-face">)
       (</span>im-shell-command
        <span class="builtin">:buffer-name</span> buffer-name
        <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;bq head -n 200 '</span><span class="constant">%s</span><span class="string">'&quot;</span> table-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-big-query-get-all-datasets</span> <span class="rainbow-delimiters-depth-2-face">(</span>project-id<span class="rainbow-delimiters-depth-2-face">)
  (</span>json-parse-string
   <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string
    <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;bq ls --format=json --project_id=%s&quot;</span> project-id<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:object-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">alist</span>
   <span class="builtin">:array-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-big-query-get-all-tables</span> <span class="rainbow-delimiters-depth-2-face">(</span>dataset-id<span class="rainbow-delimiters-depth-2-face">)
  (</span>json-parse-string
   <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string
    <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;bq ls --format=json --max_results 5000 '</span><span class="constant">%s</span><span class="string">'&quot;</span> dataset-id<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:object-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">alist</span>
   <span class="builtin">:array-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmemoizefile</span> im-big-query-all-tables <span class="rainbow-delimiters-depth-2-face">()</span> <span class="string">&quot;~/.emacs.d/big-query-table-cache&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-big-query-get-all-datasets im-big-query-project-id<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span> it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--mapcat</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-5-face">(</span>im-big-query-get-all-tables it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-big-query-all-table-names</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span> it<span class="rainbow-delimiters-depth-3-face">) (</span>im-big-query-all-tables<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Act on it
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-big-query-select-table</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Select a BigQuery table and insert it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>insert
   <span class="rainbow-delimiters-depth-3-face">(</span>im-completing-read
    <span class="string">&quot;Table: &quot;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-replace <span class="string">&quot;:&quot; &quot;.&quot;</span> it<span class="rainbow-delimiters-depth-5-face">) (</span>im-big-query-all-table-names<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:category</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-big-query-table-name</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">embark</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">defvar-keymap</span> im-big-query-table-name
    <span class="builtin">:doc</span> <span class="doc">&quot;Actions for BQ tables&quot;</span>
    <span class="builtin">:parent</span> embark-general-map
    <span class="comment-delimiter">;; </span><span class="comment">Define the first binding as the default action
</span>    <span class="string">&quot;i&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-big-query-table-info</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">embark-keymap-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>im-big-query-table-name . im-big-query-table-name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">bind-key</span> <span class="string">&quot;M-o B&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-big-query-select-table</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-cape</span>
 <span class="builtin">:name</span> big-query-tables
 <span class="builtin">:completion</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-big-query-all-table-names</span>
 <span class="builtin">:extractor</span>
 <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>xs<span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-replace <span class="string">&quot;:&quot; &quot;.&quot;</span> it<span class="rainbow-delimiters-depth-4-face">)</span> xs<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:bound</span> filename
 <span class="builtin">:kind</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>xs x<span class="rainbow-delimiters-depth-3-face">)</span> <span class="doc">&quot;&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">module</span><span class="rainbow-delimiters-depth-2-face">)</span>
 <span class="builtin">:category</span> symbol
 <span class="builtin">:key</span> <span class="string">&quot;M-o b&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> kbd-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">For working with KMonad kbd files. Do ~C-c C-c~ (~kbd-start-demo~)
</span><span class="comment-delimiter">;; </span><span class="comment">to apply your config and try it in a buffer.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">kbd-mode</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;kmonad/kbd-mode&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.kbd\\'&quot;</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> kbd-mode-kill-kmonad <span class="string">&quot;pkill -9 kmonad&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> kbd-mode-start-kmonad <span class="string">&quot;kmonad ~/.config/kmonad.kbd&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> lua-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">lua-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.lua\\'&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> jsonnet-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">jsonnet-mode</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.jsonnet\\'&quot; &quot;\\.libsonnet\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Apheleia config, so that it automatically formats on save
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setf</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jsonnet</span> apheleia-formatters<span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;jsonnetfmt&quot; &quot;-&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setf</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jsonnet-mode</span> apheleia-mode-alist<span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jsonnet</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> sql
</span>
<span class="comment-delimiter">;; </span><span class="comment">I generally do not edit ~.sql~ files but instead I do SQL through
</span><span class="comment-delimiter">;; </span><span class="comment">code blocks in org-mode. /lsp-mode/ offers ~lsp-org~ command to
</span><span class="comment-delimiter">;; </span><span class="comment">help using LSP features inside org-mode code blocks. It synergzes
</span><span class="comment-delimiter">;; </span><span class="comment">well with lsp-sqls. One important thing to remember is that you
</span><span class="comment-delimiter">;; </span><span class="comment">need to have a ~:tangle &lt;file&gt;~ in the code blocks so that LSP mode
</span><span class="comment-delimiter">;; </span><span class="comment">can actually have the tangled file to send to the corresponding
</span><span class="comment-delimiter">;; </span><span class="comment">LSP.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- ~lsp-org~ :: Start LSP mode. Must be executed with cursor being source block.
</span><span class="comment-delimiter">;; </span><span class="comment">- ~lsp-virtual-buffer-disconnect~ :: Turn off lsp-mode.
</span>
<span class="comment-delimiter">;; </span><span class="comment">~sql-connect~ also works fairly well, except for code
</span><span class="comment-delimiter">;; </span><span class="comment">completion. But you can always list the tables and columns with SQL
</span><span class="comment-delimiter">;; </span><span class="comment">and afterwards dabbrev helps you like you have code completion.
</span>
<span class="comment-delimiter">;; </span><span class="comment">I initialize ~sql-connection-alist~ in another file that is not
</span><span class="comment-delimiter">;; </span><span class="comment">checked out to this repository and afterwards I call the
</span><span class="comment-delimiter">;; </span><span class="comment">~im-sql-setup-lsp~ function.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-sql-setup-lsp</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Set `</span><span class="constant">lsp-sqls-connections</span><span class="doc">' using `</span><span class="constant">sql-connection-alist</span><span class="doc">'.
Only works for PostgreSQL connections right now.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span>
   lsp-sqls-connections
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--map</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>driver . <span class="string">&quot;postgresql&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>dataSourceName . ,<span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;host=%s port=%s user=%s password=%s dbname=%s sslmode=disable&quot;</span>
                                 <span class="rainbow-delimiters-depth-7-face">(</span>car <span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">sql-server</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                                 (</span>car <span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">sql-port</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                                 (</span>car <span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">sql-user</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                                 (</span>car <span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">sql-password</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                                 (</span>car <span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">sql-database</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
    sql-connection-alist<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-sql-run-query</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;Open a new scratch buffer with code completion to run a query, using org-mode.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buff <span class="rainbow-delimiters-depth-5-face">(</span>format-time-string <span class="string">&quot;sql_%Y-%m-%d.org&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer buff<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create buff<span class="rainbow-delimiters-depth-5-face">)
        (</span>insert <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">im-s-interpolated</span>
                 <span class="string">&quot;#+TITLE: #{(format-time-string \&quot;%Y-%m-%d\&quot;)}-sql
#+PROPERTY: header-args:sql :noweb yes :tangle .#{(format-time-string \&quot;%Y%m%d\&quot;)}.sql
#+PROPERTY: header-args:bqsql :noweb yes\n
You can always use ~sql-connect~ to get a simple REPL. It is
faster for longer outputs.

Use ~lsp-sql-switch-connection~ to switch between different
connections, to make code completion work for your current
context.

Don't forget about snippets too.&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>org-mode<span class="rainbow-delimiters-depth-5-face">)
        (</span>im-disable-line-wrapping<span class="rainbow-delimiters-depth-5-face">)
        (</span>write-file <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;~/Documents/notes/temp/%s&quot;</span> buff<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> buff
      <span class="rainbow-delimiters-depth-4-face">(</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-max<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">im-s-interpolated</span>
        <span class="string">&quot;\n\n* #{(format-time-string \&quot;%Y-%m-%d %a %H:%M\&quot;)}
#+begin_src sql :engine postgresql :dbconnection #{(sql-read-connection \&quot;Select DB: \&quot;)}
SELECT * FROM _ LIMIT 1;
#+end_src\n\n&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>forward-line -3<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">unless</span> lsp-mode
        <span class="rainbow-delimiters-depth-5-face">(</span>lsp-org<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="comment-delimiter">;; </span><span class="comment">I wasn't able to find a way to retrieve current
</span>      <span class="comment-delimiter">;; </span><span class="comment">connection. If I was able to, then I would compare it with
</span>      <span class="comment-delimiter">;; </span><span class="comment">the selected dbconnection from above and show the following
</span>      <span class="comment-delimiter">;; </span><span class="comment">selection only if needed
</span>      <span class="rainbow-delimiters-depth-4-face">(</span>lsp-sql-switch-connection<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer buff<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> go
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">go-mode</span>
  <span class="builtin">:mode</span> <span class="string">&quot;\\.go\\'&quot;</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> nginx
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">nginx-mode</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;nginx\\.conf\\'&quot;</span>  . nginx-mode<span class="rainbow-delimiters-depth-3-face">)
         (</span><span class="string">&quot;/nginx/.+\\.conf\\'&quot;</span> . nginx-mode<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Conf
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">conf-mode</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">conf-mode-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outli-mode</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> fish
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">fish-mode</span>
  <span class="builtin">:mode</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;\\.fish\\'&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> python
</span>
<span class="comment-delimiter">;; </span><span class="comment">* Jupyter &amp; org-mode
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- =jupyter= package enables you to use jupyter notebooks in Emacs.
</span><span class="comment-delimiter">;; </span><span class="comment">- It provides two ways, one is through org-mode and it's the one I
</span><span class="comment-delimiter">;;   </span><span class="comment">prefer.
</span><span class="comment-delimiter">;; </span><span class="comment">- You need to convert =ipynb= files into org-mode files by running:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src sh
</span><span class="comment-delimiter">;; </span><span class="comment">pandoc --from ipynb --to org some-file.ipynb # this outputs an org-mode file
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- Do =jupyter-connect-repl=.
</span><span class="comment-delimiter">;; </span><span class="comment">- Start (?, not sure, it may be automatic)
</span><span class="comment-delimiter">;;   </span><span class="comment">~jupyter-org-interaction-mode~ and then you will get completion at
</span><span class="comment-delimiter">;;   </span><span class="comment">point
</span><span class="comment-delimiter">;; </span><span class="comment">- Then you can simply use jupyter-python source blocks to write
</span><span class="comment-delimiter">;;   </span><span class="comment">your code and run them exactly as you do with normal org code
</span><span class="comment-delimiter">;;   </span><span class="comment">blocks.
</span><span class="comment-delimiter">;; </span><span class="comment">- There are also these functions which you can utilize:
</span><span class="comment-delimiter">;;   </span><span class="comment">- jupyter-eval-defun
</span><span class="comment-delimiter">;;   </span><span class="comment">- jupyter-inspect-at-point      → K
</span><span class="comment-delimiter">;;   </span><span class="comment">- jupyter-eval-line-or-region   → C-x C-e
</span><span class="comment-delimiter">;;   </span><span class="comment">- jupyter-repl-interrupt-kernel → C-c C-i
</span><span class="comment-delimiter">;;   </span><span class="comment">- jupyter-repl-restart-kernel   → C-c C-r
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">* Virtual Envs and Jupyter
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">If you are using virtualenvironments, then simply do
</span><span class="comment-delimiter">;; </span><span class="comment">=pyvenv-activate= and select the virtenv folder.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">You can create a venv like: =python3 -m venv &lt;venv-folder&gt;=. To
</span><span class="comment-delimiter">;; </span><span class="comment">install requirements.txt dependencies, do ~pip install -r
</span><span class="comment-delimiter">;; </span><span class="comment">requirements.txt~ after activating the venv with ~source
</span><span class="comment-delimiter">;; </span><span class="comment">&lt;venv-folder&gt;/bin/activate.{,.fish,.zsh}~.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">After activating the venv, you may need to do
</span><span class="comment-delimiter">;; </span><span class="comment">~jupyter-repl-restart-kernel~.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">pyvenv</span>
  <span class="builtin">:defer</span> t<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">jupyter</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">ob-core</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">setq</span> org-babel-default-header-args:jupyter-python
          <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:async</span> . <span class="string">&quot;yes&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>      <span class="comment-delimiter">;; </span><span class="comment">Make outputs async
</span>            <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:session</span> . <span class="string">&quot;py&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>     <span class="comment-delimiter">;; </span><span class="comment">A named session
</span>            <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:kernel</span> . <span class="string">&quot;python3&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">Don't know but works
</span>            <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:pandoc</span> . t<span class="rainbow-delimiters-depth-5-face">)</span>         <span class="comment-delimiter">;; </span><span class="comment">Convert rich outputs to org-mode format
</span>            <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:display</span> <span class="string">&quot;text/plain text/html&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
            <span class="comment-delimiter">;; </span><span class="comment">^ Prefer plain-text outputs from jupyter instead of
</span>            <span class="comment-delimiter">;; </span><span class="comment">direct html outputs
</span>            <span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-convert-ipynb-to-org-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Convert the current IPython Notebook file to Org format and open it in a new buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>org-buffer-name <span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="rainbow-delimiters-depth-6-face">(</span>file-name-sans-extension <span class="rainbow-delimiters-depth-7-face">(</span>buffer-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;.org&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>pandoc-output <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string
                         <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;pandoc --from ipynb --to org '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer-create org-buffer-name<span class="rainbow-delimiters-depth-4-face">)
      (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)
      (</span>insert pandoc-output<span class="rainbow-delimiters-depth-4-face">)
      (</span>switch-to-buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Window and buffer management
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tab-bar-mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">It's a great workspace manager that comes bundled with Emacs. I was
</span><span class="comment-delimiter">;; </span><span class="comment">using an abomination where ~persp.el~ and ~eyebrowse~ was glued
</span><span class="comment-delimiter">;; </span><span class="comment">together but I guess this is a simpler and more sane alternative to
</span><span class="comment-delimiter">;; </span><span class="comment">them.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">tab-bar</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>tab-bar-new-tab-to <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">rightmost</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-new-tab-choice im-init-file<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Experimenting with not showing tab-bar at all.
</span>  <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: need a way to display on which tab am I, possibly inside
</span>  <span class="comment-delimiter">;; </span><span class="comment">modeline?
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>tab-bar-show t<span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-history-limit 20<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Show numbers before tab names
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>tab-bar-tab-hints t<span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-auto-width nil<span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-auto-width-max t<span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-tab-name-format-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-tab-name-format-default</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-tab-name-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-tab-name-current</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="default-0035">FIXME</span><span class="comment">: For some reason, my function gets slower over time. Dunno
</span>  <span class="comment-delimiter">;; </span><span class="comment">why, will investigate later.
</span>  <span class="comment-delimiter">;; </span><span class="comment">(setq tab-bar-tab-name-function #'im-current-project-name)
</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>tab-bar-format
   <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-format-tabs
     tab-bar-separator
     tab-bar-format-add-tab
     tab-bar-format-align-right
     tab-bar-format-global<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Don't show global-mode-string in mode-line because we already show
</span>  <span class="comment-delimiter">;; </span><span class="comment">it on right side of the tab-bar
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>mode-line-misc-info <span class="rainbow-delimiters-depth-3-face">(</span>assq-delete-all <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global-mode-string</span> mode-line-misc-info<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:hook</span> <span class="rainbow-delimiters-depth-2-face">(</span>after-init . tab-bar-mode<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="comment-delimiter">;; </span><span class="comment">Enable history so that I can use `</span><span class="constant">tab-bar-history-back</span><span class="comment">'
</span>  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">tab-bar-history-forward</span><span class="comment">'.  `</span><span class="constant">winner-mode</span><span class="comment">' also have the same
</span>  <span class="comment-delimiter">;; </span><span class="comment">functionality but `</span><span class="constant">tab-bar-history-mode</span><span class="comment">' works per tab so that it
</span>  <span class="comment-delimiter">;; </span><span class="comment">does not mangle things up between different tabs which is just
</span>  <span class="comment-delimiter">;; </span><span class="comment">great.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>tab-bar-history-mode<span class="rainbow-delimiters-depth-2-face">)</span>

  <span class="comment-delimiter">;; </span><span class="comment">Evil has a default binding for switching between tabs with ~gt~ and
</span>  <span class="comment-delimiter">;; </span><span class="comment">~gT~, switching forward and backward respectively. I just make them
</span>  <span class="comment-delimiter">;; </span><span class="comment">repeatable so that after first ~gt~ (~gT~) I can hammer down ~t~
</span>  <span class="comment-delimiter">;; </span><span class="comment">(or ~T~) to switch next/prev tab quickly instead of doing ~gt~ (or
</span>  <span class="comment-delimiter">;; </span><span class="comment">~gT~) again and again.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-make-repeatable</span> tab-bar-switch
    <span class="string">&quot;t&quot;</span> evil-tab-next
    <span class="string">&quot;t&quot;</span> tab-bar-switch-to-next-tab
    <span class="string">&quot;T&quot;</span> tab-bar-switch-to-prev-tab<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">I want to show ~consult-buffer~ when I open a new tab to be able to
</span><span class="comment-delimiter">;; </span><span class="comment">quickly jump a file. I also want to show it in a buffer, not in
</span><span class="comment-delimiter">;; </span><span class="comment">mini-buffer.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-tab-bar-new-tab</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open a new tab and display consult-buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-bar-new-tab<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>vertico-multiform-commands <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>consult-buffer buffer <span class="rainbow-delimiters-depth-7-face">(</span>vertico-buffer-display-action . <span class="rainbow-delimiters-depth-8-face">(</span>display-buffer-same-window<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>mini-frame-ignore-commands <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span>,@mini-frame-ignore-commands consult-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>this-command <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">consult-buffer</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>consult-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tab-bar-new-tab-with-current-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open a new tab and display the current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>tab-bar-new-tab-choice t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>tab-bar-new-tab<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tab-line-mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-tab-line-hidden-buffer-name-regexp</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>concat
   <span class="string">&quot;\\*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">Calc.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Calendar</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">elfeed-log</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">helpful.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Compile-Log</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Help</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">lsp-log</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\*&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">magit.*&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">slack-curl-downloader&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">slack-log&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">slack-event-log&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">dir-data&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">.*-ls\\*&quot;
   &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">.*stderr\\*&quot;
   &quot;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Regexp to filter out buffer names on tab line.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">use-package</span> <span class="constant">tab-line</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:type</span> built-in<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">:hook (after-init . global-tab-line-mode)
</span>  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>tab-line-close-button-show <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">selected</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-line-tabs-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-line-buffers</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-line-tab-name-truncated-max 32<span class="rainbow-delimiters-depth-2-face">)
  (</span>tab-line-tab-name-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-line-buffer-name</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tab-line-buffer-name</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer <span class="type">&amp;optional</span> _buffers<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>name <span class="rainbow-delimiters-depth-5-face">(</span>tab-line-tab-name-truncated-buffer buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">im-tab-line-buffers groups special with the same prefix
</span>    <span class="comment-delimiter">;; </span><span class="comment">together. I mostly prefix my buffers like &quot;*XXX: ...&quot; and here
</span>    <span class="comment-delimiter">;; </span><span class="comment">I delete that prefix to gain a little bit more space while
</span>    <span class="comment-delimiter">;; </span><span class="comment">displaying.
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>str <span class="rainbow-delimiters-depth-6-face">(</span>s-match <span class="string">&quot; ?\\*[a-zA-Z0-9_-]+: </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>cadr str<span class="rainbow-delimiters-depth-4-face">)</span>
      name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tab-line-buffers</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return related project buffers (not limited to files, shells etc.) to display in tab-line.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>proj <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-6-face">)
                   (</span>expand-file-name default-directory<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>buffer-name <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>buffer-filter <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-matches? <span class="string">&quot;^\\*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\\$&quot;</span> buffer-name<span class="rainbow-delimiters-depth-6-face">)
                            (</span>apply-partially <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-line--buffer-same-group?</span> buffer-name<span class="rainbow-delimiters-depth-6-face">)
                          (</span>apply-partially <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-line--buffer-same-project?</span> proj<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>seq-sort-by
     <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">buffer-name</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">string&lt;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>seq-filter <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>b<span class="rainbow-delimiters-depth-6-face">)
                   (</span><span class="keyword">with-current-buffer</span> b
                     <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-8-face">(</span>im-tab-line--buffer-valid?<span class="rainbow-delimiters-depth-8-face">)
                          (</span>funcall buffer-filter<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                 (</span>funcall tab-line-tabs-buffer-list-function<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tab-line--buffer-valid?</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>not <span class="rainbow-delimiters-depth-3-face">(</span>s-matches? im-tab-line-hidden-buffer-name-regexp <span class="rainbow-delimiters-depth-4-face">(</span>buffer-name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tab-line--buffer-same-project?</span> <span class="rainbow-delimiters-depth-2-face">(</span>project-dir<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">and</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>s-prefix? project-dir <span class="rainbow-delimiters-depth-4-face">(</span>expand-file-name default-directory<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>not <span class="rainbow-delimiters-depth-4-face">(</span>s-matches? <span class="string">&quot;^\\*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\\$&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-tab-line--buffer-same-group?</span> <span class="rainbow-delimiters-depth-2-face">(</span>orig-buffer-name<span class="rainbow-delimiters-depth-2-face">)
  (</span>s-prefix? <span class="rainbow-delimiters-depth-3-face">(</span>substring orig-buffer-name 0 4<span class="rainbow-delimiters-depth-3-face">) (</span>buffer-name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> tabgo.el
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">tabgo</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;isamert/tabgo.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:demand</span> t
  <span class="builtin">:general</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
   <span class="string">&quot;M-r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabgo</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil-org-mode-keymap</span>
   <span class="string">&quot;M-r&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tabgo</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> ace-window
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">ace-window</span>
  <span class="builtin">:defer</span> t
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>aw-select<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>aw-background t<span class="rainbow-delimiters-depth-2-face">)
  (</span>aw-ignore-current t<span class="rainbow-delimiters-depth-2-face">)
  (</span>aw-keys <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span>?a ?s ?d ?f ?g ?h ?j ?k ?l<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>set-face-attribute <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">aw-leading-char-face</span> nil <span class="builtin">:height</span> 4.5 <span class="builtin">:weight</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bold</span> <span class="builtin">:foreground</span> <span class="string">&quot;controlAccentColor&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>ace-window-posframe-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-find-file-ace-window</span> <span class="rainbow-delimiters-depth-2-face">(</span>filename <span class="type">&amp;optional</span> wildcards<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Edit file FILENAME, in selected window.

Like \\[</span><span class="constant">find-file</span><span class="doc">] (which see), but uses the selected window by `</span><span class="constant">ace-select-window</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>find-file-read-args <span class="string">&quot;Find file in other window: &quot;</span>
                        <span class="rainbow-delimiters-depth-4-face">(</span>confirm-nonexistent-file-or-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>aw-ignore-current nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>select-window <span class="rainbow-delimiters-depth-4-face">(</span>ace-select-window<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>switch-to-buffer <span class="rainbow-delimiters-depth-3-face">(</span>find-file-noselect filename nil nil wildcards<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> bufler
</span>
<span class="comment-delimiter">;; </span><span class="comment">Good for buffer management, especially for groupped killings.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">bufler</span>
  <span class="builtin">:commands</span> <span class="rainbow-delimiters-depth-2-face">(</span>bufler<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:config</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> bufler-list-mode-map
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;q&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">quit-window</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;x&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bufler-list-buffer-kill</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;return&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bufler-list-buffer-switch</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;&lt;tab&gt;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">magit-section-cycle</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;M-,&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bufler-list-buffer-peek</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>kbd <span class="string">&quot;p&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bufler-list-buffer-peek</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-quit</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Quit current window or buffer.
Inspired by `</span><span class="constant">meow-quit</span><span class="doc">' but I changed it in a way to make it work with side windows properly.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span>
       <span class="rainbow-delimiters-depth-4-face">(</span>window-parameter <span class="rainbow-delimiters-depth-5-face">(</span>selected-window<span class="rainbow-delimiters-depth-5-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">window-side</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>&gt; <span class="rainbow-delimiters-depth-5-face">(</span>seq-length <span class="rainbow-delimiters-depth-6-face">(</span>seq-filter <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>it<span class="rainbow-delimiters-depth-8-face">) (</span>not <span class="rainbow-delimiters-depth-9-face">(</span>window-parameter it <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">window-side</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">) (</span>window-list <span class="rainbow-delimiters-depth-8-face">(</span>selected-frame<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> 1<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
      (</span>delete-window<span class="rainbow-delimiters-depth-3-face">)
    (</span>previous-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-split-window-below</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Split window below and focus.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>split-window-below<span class="rainbow-delimiters-depth-2-face">)
  (</span>other-window 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-split-window-right</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Split window right and focus.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>split-window-right<span class="rainbow-delimiters-depth-2-face">)
  (</span>other-window 1<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span>
  <span class="string">&quot;Q&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-quit</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-\\&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-split-window-right</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M--&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>  <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-split-window-below</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;[2&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-line-switch-to-prev-tab</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;]2&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-line-switch-to-next-tab</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;[1&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-switch-to-prev-tab</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;]1&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-switch-to-next-tab</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;l&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-right</span>
  <span class="string">&quot;h&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-left</span>
  <span class="string">&quot;j&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-down</span>
  <span class="string">&quot;k&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-up</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span>
  <span class="comment-delimiter">;; </span><span class="comment">misc window operations
</span>  <span class="string">&quot;wo&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">other-window</span>
  <span class="string">&quot;w1&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">delete-other-windows</span>
  <span class="string">&quot;w=&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">balance-windows</span>
  <span class="comment-delimiter">;; </span><span class="comment">window-move
</span>  <span class="string">&quot;wL&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-move-far-right</span>
  <span class="string">&quot;wH&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-move-far-left</span>
  <span class="string">&quot;wJ&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-move-very-bottom</span>
  <span class="string">&quot;wK&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">evil-window-move-very-top</span>
  <span class="comment-delimiter">;; </span><span class="comment">window-size
</span>  <span class="string">&quot;w+&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">enlarge-window</span>
  <span class="string">&quot;w-&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">shrink-window</span>
  <span class="string">&quot;w&gt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">enlarge-window-horizontally</span>
  <span class="string">&quot;w&lt;&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">shrink-window-horizontally</span>
  <span class="comment-delimiter">;; </span><span class="comment">workspace (tab-bar-mode)
</span>  <span class="string">&quot;W&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-switch-to-tab</span>
  <span class="string">&quot;wu&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-history-back</span> <span class="comment-delimiter">;; </span><span class="comment">undo
</span>  <span class="string">&quot;wr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-history-forward</span> <span class="comment-delimiter">;; </span><span class="comment">redo
</span>  <span class="string">&quot;wt&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-bar-new-tab</span> <span class="comment-delimiter">;; </span><span class="comment">tab
</span>  <span class="string">&quot;wT&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-tab-bar-new-tab-with-current-buffer</span> <span class="comment-delimiter">;; </span><span class="comment">tab
</span>  <span class="string">&quot;wn&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-rename-tab</span> <span class="comment-delimiter">;; </span><span class="comment">name
</span>  <span class="string">&quot;wm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-move</span> <span class="comment-delimiter">;; </span><span class="comment">move
</span>  <span class="string">&quot;ws&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-switch-to-tab</span> <span class="comment-delimiter">;; </span><span class="comment">switch
</span>  <span class="string">&quot;wl&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-bar-switch-to-recent-tab</span> <span class="comment-delimiter">;; </span><span class="comment">last
</span>  <span class="string">&quot;wk&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">tab-close</span> <span class="comment-delimiter">;; </span><span class="comment">kill
</span>  <span class="comment-delimiter">;; </span><span class="comment">buffer
</span>  <span class="string">&quot;wb&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">bufler</span>
  <span class="comment-delimiter">;; </span><span class="comment">ace-window
</span>  <span class="string">&quot;wa&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">ace-window</span>
  <span class="string">&quot;ws&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">ace-swap-window</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Buffer related bindings
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;b0&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">erase-buffer</span>
  <span class="string">&quot;br&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">rename-buffer</span>
  <span class="string">&quot;bo&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-open-region-in-temp-buffer</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>normal insert motion<span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-1&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kbd <span class="string">&quot;M-2&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 2<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kbd <span class="string">&quot;M-3&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 3<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kbd <span class="string">&quot;M-4&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 4<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kbd <span class="string">&quot;M-5&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 5<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kbd <span class="string">&quot;M-6&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 6<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>kbd <span class="string">&quot;M-7&quot;</span><span class="rainbow-delimiters-depth-2-face">) (</span><span class="keyword">λ-interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>tab-bar-select-tab 7<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-make-repeatable</span> winner
  <span class="string">&quot;u&quot;</span> tab-bar-history-back
  <span class="string">&quot;r&quot;</span> tab-bar-history-forward<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-make-repeatable</span> window-resize
  <span class="string">&quot;+&quot;</span> enlarge-window
  <span class="string">&quot;-&quot;</span> shrink-window
  <span class="string">&quot;&gt;&quot;</span> enlarge-window-horizontally
  <span class="string">&quot;&lt;&quot;</span> shrink-window-horizontally<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Misc functions
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> marks integration
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[https://github.com/im-marks][marks]] is a grep-like tool for
</span><span class="comment-delimiter">;; </span><span class="comment">searching org-mode and markdown files. The following snippet
</span><span class="comment-delimiter">;; </span><span class="comment">provides a ~consult~ support for marks.
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span> <span class="string">&quot;cm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-marks-my-docs</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-consult--marks-builder</span> <span class="rainbow-delimiters-depth-2-face">(</span>paths<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-3-face">(</span>input<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">pcase-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span>,arg . ,opts<span class="rainbow-delimiters-depth-6-face">) (</span>consult--command-split input<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>cons
       <span class="rainbow-delimiters-depth-5-face">(</span>list <span class="string">&quot;marks&quot; &quot;--no-color&quot; &quot;--null&quot; &quot;--path&quot;</span> default-directory <span class="string">&quot;--query&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-trim arg<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>apply-partially <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">consult--highlight-regexps</span> <span class="rainbow-delimiters-depth-6-face">(</span>list <span class="rainbow-delimiters-depth-7-face">(</span>regexp-quote arg<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-marks</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> directory<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run `</span><span class="constant">marks</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> directory default-directory<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>consult--grep <span class="string">&quot;marks&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-consult--marks-builder</span> default-directory <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-marks-my-docs</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Run marks inside `</span><span class="constant">~/Documents/notes</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-marks <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name <span class="string">&quot;~/Documents/notes&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Jira
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;eji&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jira-list-issues</span>
  <span class="string">&quot;ejc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jira-create-ticket</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Install required JIRA client
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">jiralib2</span>
  <span class="builtin">:autoload</span> <span class="rainbow-delimiters-depth-2-face">(</span>jiralib2-assign-issue
             jiralib2-create-issue
             jiralib2-get-issue
             jiralib2-get-issuetypes
             jiralib2-get-users
             jiralib2-session-call
             jiralib2-update-summary-description
             jiralib2-create-issue
             jiralib2-jql-search<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>jiralib2-url ty-jira-url<span class="rainbow-delimiters-depth-2-face">)
  (</span>jiralib2-auth <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">basic</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>jiralib2-user-login-name ty-jira-login<span class="rainbow-delimiters-depth-2-face">)
  (</span>jiralib2-token nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">My completing-read based JIRA utilities
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-git-worktrees-root</span> <span class="string">&quot;~/Workspace/projects/worktrees&quot;</span>
  <span class="doc">&quot;Directory to create worktrees in.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-git-main-branch</span> <span class="string">&quot;master&quot;</span>
  <span class="doc">&quot;Main branch name.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-projects</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="string">&quot;AI&quot; &quot;SAT&quot; &quot;DISP&quot; &quot;LISTI&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;List of projects that I enrolled in JIRA.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-base-branch</span> <span class="string">&quot;origin/master&quot;</span>
  <span class="doc">&quot;Brach to create feature branches from.
Consider using origin/something to create the branch from latest
something.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-story-points-field-name</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">customfield_10002</span>
  <span class="doc">&quot;Which field describes the story points in JIRA response.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-feature-branch-prefix</span> <span class="string">&quot;feature/&quot;</span>
  <span class="doc">&quot;Prefix to prepend feature branch names.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-my-issues-query</span> <span class="string">&quot;Pair-programmer = currentUser() OR assignee = currentUser() OR creator = currentUser() ORDER BY createdDate DESC&quot;</span>
  <span class="doc">&quot;Query to find out issues that are assigned to me.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-kanban-board-query</span>
  <span class="string">&quot;project = AI AND (fixVersion in unreleasedVersions() OR fixVersion is EMPTY) AND createdDate &gt;= -2w ORDER BY Rank ASC&quot;</span>
  <span class="doc">&quot;Query to get kanban board issues.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-jira-board-id</span>
  <span class="string">&quot;1332&quot;</span>
  <span class="doc">&quot;Interested board id. </span><span class="default-0038">TODO</span><span class="doc">: make this a list so that I can access to multiple boards by `</span><span class="constant">im-jira-list-issues</span><span class="doc">'.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-open-issue</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue-number<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Open given Jira ISSUE-NUMBER.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sIssue: &quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Remove the following if I move this functionality to a package/file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">jiralib2</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>url <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s/browse/%s&quot;</span> jiralib2-url <span class="rainbow-delimiters-depth-6-face">(</span>car <span class="rainbow-delimiters-depth-7-face">(</span>s-split <span class="string">&quot; &quot;</span> issue-number<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>kill-new url<span class="rainbow-delimiters-depth-3-face">)
    (</span>browse-url url<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-issue-at-point</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>sym <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">symbol</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-matches? <span class="string">&quot;[a-zA-Z]+-[0-9]+&quot;</span> sym<span class="rainbow-delimiters-depth-4-face">)</span>
      sym<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-to-list <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-open-thing-at-point-alist</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>im-jira-issue-at-point . im-jira-open-issue<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmemoize</span> im-jira-get-my-issues <span class="rainbow-delimiters-depth-2-face">()
  (</span>jiralib2-jql-search im-jira-my-issues-query<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-kanban-issues</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>jiralib2-jql-search im-jira-kanban-board-query<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-board-issues</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>jiralib2-board-issues im-jira-board-id nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-jql</span> <span class="rainbow-delimiters-depth-2-face">(</span>jql<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Enter JQL: &quot; &quot;text ~ \&quot;...\&quot; AND statusCategory = \&quot;To Do|In Progress|Done\&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> <span class="string">&quot;sEnter JQL: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>jiralib2-jql-search jql<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-current-sprint-issues</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> projects<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get current sprint issues for all PROJECTS.
If PROJECTS is nil, then `</span><span class="constant">im-jira-projects</span><span class="doc">' is used.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>issues <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>mapc
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>project<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">setq</span>
        issues
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">thread-last</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;project = \&quot;%s\&quot; AND Sprint in openSprints()&quot;</span>
                  project<span class="rainbow-delimiters-depth-7-face">)
          (</span>jiralib2-jql-search<span class="rainbow-delimiters-depth-7-face">)
          (</span>append issues<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">or</span> projects im-jira-projects<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    issues<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-new-issues</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>issues <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">()</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>mapcar
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>project<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">setq</span>
        issues
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">thread-last</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;project = \&quot;%s\&quot; AND created &gt; -10d&quot;</span>
                  project<span class="rainbow-delimiters-depth-7-face">)
          (</span>jiralib2-jql-search<span class="rainbow-delimiters-depth-7-face">)
          (</span>append issues<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     im-jira-projects<span class="rainbow-delimiters-depth-3-face">)</span>
    issues<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-list-issues</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> arg<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-jira-issue-actions
   <span class="rainbow-delimiters-depth-3-face">(</span>im-completing-read
    <span class="string">&quot;Select ticket: &quot;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">pcase</span> <span class="rainbow-delimiters-depth-5-face">(</span>completing-read <span class="string">&quot;Issue list: &quot;</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;My issues&quot; &quot;Current Sprint&quot; &quot;New issues&quot; &quot;Kanban&quot; &quot;Board&quot; &quot;JQL&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;My issues&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-jira-get-my-issues<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;New issues&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-jira-get-new-issues<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;Current Sprint&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-jira-get-current-sprint-issues<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;Board&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-jira-get-board-issues<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;Kanban&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-jira-get-kanban-issues<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="string">&quot;JQL&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jira-jql</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-jira--format-ticket-name</span>
    <span class="builtin">:sort?</span> nil<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-ticket-to-branch</span> <span class="rainbow-delimiters-depth-2-face">(</span>key summary<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create a new branch from given ISSUE-NAME and switch to it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sIssue name: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>branch-name <span class="rainbow-delimiters-depth-5-face">(</span>im-jira--create-branch-name-from-ticket <span class="rainbow-delimiters-depth-6-face">(</span>concat key summary<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Updating...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span>= 0 <span class="rainbow-delimiters-depth-5-face">(</span>shell-command <span class="string">&quot;git fetch --all&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;Cannot git fetch --all&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Creating branch...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>magit-branch-and-checkout branch-name im-jira-base-branch<span class="rainbow-delimiters-depth-3-face">)
    (</span>vc-refresh-state<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-jira-change-issue-status-to-status key <span class="string">&quot;In Progress&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Currently on %s.&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>lab-git-current-branch<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-ticket-to-worktree</span> <span class="rainbow-delimiters-depth-2-face">(</span>key summary<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;sIssue name: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>branch-name <span class="rainbow-delimiters-depth-5-face">(</span>im-jira--create-branch-name-from-ticket <span class="rainbow-delimiters-depth-6-face">(</span>concat key summary<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>worktree <span class="rainbow-delimiters-depth-5-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;%s/%s&quot;</span> im-git-worktrees-root <span class="rainbow-delimiters-depth-7-face">(</span>s-replace <span class="string">&quot;/&quot; &quot;-&quot;</span> branch-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Updating...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-4-face">(</span>= 0 <span class="rainbow-delimiters-depth-5-face">(</span>shell-command <span class="string">&quot;git fetch --all&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;Cannot git fetch --all&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Creating worktree...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>-contains? <span class="rainbow-delimiters-depth-5-face">(</span>vc-git-branches<span class="rainbow-delimiters-depth-5-face">)</span> branch-name<span class="rainbow-delimiters-depth-4-face">)
        (</span>magit-worktree-checkout worktree branch-name<span class="rainbow-delimiters-depth-4-face">)
      (</span>magit-worktree-branch worktree branch-name im-jira-base-branch<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>tab-bar-new-tab<span class="rainbow-delimiters-depth-3-face">)
    (</span>tab-bar-rename-tab worktree<span class="rainbow-delimiters-depth-3-face">)
    (</span>cd worktree<span class="rainbow-delimiters-depth-3-face">)
    (</span>find-file<span class="rainbow-delimiters-depth-3-face">)
    (</span>vc-refresh-state<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-jira-change-issue-status-to-status key <span class="string">&quot;In Progress&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Currently on %s.&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>lab-git-current-branch<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-create-ticket</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>project <span class="rainbow-delimiters-depth-5-face">(</span>im-jira--select-project<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>issue-type <span class="rainbow-delimiters-depth-5-face">(</span>im-jira--select-issue-type<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>summary <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="string">&quot;Issue summary: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-get-input
     <span class="builtin">:init</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="rainbow-delimiters-depth-5-face">(</span>concat
              <span class="string">&quot;* %s\n&quot;
              &quot;:PROPERTIES:\n&quot;
              &quot;:PROJECT-ID: %s\n&quot;
              &quot;:ISSUE-TYPE: %s\n&quot;
              &quot;:SPRINT: active|future\n&quot;
              &quot;:END:\n\n&quot;</span>
              <span class="rainbow-delimiters-depth-6-face">(</span>im-jira--get-issue-template issue-type<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
             summary project issue-type<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:pre-process</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
       (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>list
        <span class="builtin">:summary</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
        <span class="builtin">:project-id</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-get nil <span class="string">&quot;PROJECT-ID&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
        <span class="builtin">:type</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-get nil <span class="string">&quot;ISSUE-TYPE&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
        <span class="builtin">:rest</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>,<span class="rainbow-delimiters-depth-8-face">(</span>im-jira-get-issue-field-id-for <span class="string">&quot;Sprint&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span> .
                 ,<span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span> <span class="rainbow-delimiters-depth-9-face">(</span>im-jira-find-sprint <span class="rainbow-delimiters-depth-1-face">(</span>org-entry-get nil <span class="string">&quot;SPRINT&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-accept</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>description props<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">setq</span> description
             <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">-&gt;&gt;</span>
              <span class="rainbow-delimiters-depth-7-face">(</span>org-export-string-as description <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">confluence</span> t<span class="rainbow-delimiters-depth-7-face">)
              (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>-drop 1<span class="rainbow-delimiters-depth-7-face">)
              (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>message <span class="string">&quot;&gt;&gt; (im-jira-create-ticket %s :description %s)&quot;</span> props description<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">thread-last</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jiralib2-create-issue</span>
                <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-7-face">(</span>,<span class="rainbow-delimiters-depth-8-face">(</span>plist-get props <span class="builtin">:project-id</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  ,<span class="rainbow-delimiters-depth-8-face">(</span>plist-get props <span class="builtin">:type</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  ,<span class="rainbow-delimiters-depth-8-face">(</span>plist-get props <span class="builtin">:summary</span><span class="rainbow-delimiters-depth-8-face">)</span>
                  ,description
                  ,@<span class="rainbow-delimiters-depth-8-face">(</span>plist-get props <span class="builtin">:rest</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>im-jira-issue-actions<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-issue-fields</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>jiralib2-session-call <span class="string">&quot;/rest/api/2/field&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> support pagination
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-sprints</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">values</span> <span class="rainbow-delimiters-depth-3-face">(</span>jiralib2-session-call <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;/rest/agile/1.0/board/%s/sprint&quot;</span> im-jira-board-id<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-find-sprint</span> <span class="rainbow-delimiters-depth-2-face">(</span>sprint<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find a sprint. SPRINT can be a full sprint name or one \&quot;active\&quot;|\&quot;future\&quot;.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>sprints <span class="rainbow-delimiters-depth-5-face">(</span>im-jira-get-sprints<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">or</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-5-face">(</span>string-equal sprint <span class="rainbow-delimiters-depth-6-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">name</span> it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> sprints<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-5-face">(</span>string-equal sprint <span class="rainbow-delimiters-depth-6-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">state</span> it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> sprints<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-issue-field-id-for</span> <span class="rainbow-delimiters-depth-2-face">(</span>field-name<span class="rainbow-delimiters-depth-2-face">)
  (</span>alist-get
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--find</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>string-equal field-name <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">name</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>im-jira-get-issue-fields<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-get-issue-transitions</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue<span class="rainbow-delimiters-depth-2-face">)
  (</span>alist-get
   <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">transitions</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>jiralib2-session-call <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;/rest/api/2/issue/%s/transitions?expand=transition.fields&quot;</span> issue<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-change-issue-status-to</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue status-id<span class="rainbow-delimiters-depth-2-face">)
  (</span>jiralib2-session-call
   <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;/rest/api/2/issue/%s/transitions?expand=transition.fields&quot;</span> issue<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:type</span> <span class="string">&quot;POST&quot;</span>
   <span class="builtin">:data</span> <span class="rainbow-delimiters-depth-3-face">(</span>json-encode
          <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>transition <span class="rainbow-delimiters-depth-6-face">(</span>id . ,status-id<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-change-issue-status</span> <span class="rainbow-delimiters-depth-2-face">(</span>key<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;sIssue number: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-completing-read
    <span class="string">&quot;Select status: &quot;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>im-jira-get-issue-transitions key<span class="rainbow-delimiters-depth-4-face">)</span>
    <span class="builtin">:formatter</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>it<span class="rainbow-delimiters-depth-5-face">) (</span><span class="keyword">let-alist</span> it <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;%s [%s]&quot;</span> .name .to.name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>im-jira-change-issue-status-to key<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-change-issue-status-to-status</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue-id status<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Same as `</span><span class="constant">im-jira-change-issue-status-to</span><span class="doc">' but uses the
  status name as shown in Jira UI instead of status id.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-jira-change-issue-status-to
   issue-id
   <span class="rainbow-delimiters-depth-3-face">(</span>alist-get
    <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--find</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>string-equal <span class="rainbow-delimiters-depth-6-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">name</span> it<span class="rainbow-delimiters-depth-6-face">)</span> status<span class="rainbow-delimiters-depth-5-face">)
     (</span>im-jira-get-issue-transitions issue-id<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Utility
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defmemoizefile</span> im-jira-get-users <span class="rainbow-delimiters-depth-2-face">()</span> <span class="string">&quot;~/.emacs.d/jira-user-cache&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>mapcar
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>project<span class="rainbow-delimiters-depth-4-face">) (</span>cons project <span class="rainbow-delimiters-depth-5-face">(</span>jiralib2-get-users project<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   im-jira-projects<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira--select-user</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">thread-last</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>im-jira-get-users<span class="rainbow-delimiters-depth-3-face">)
    (</span>assoc-string <span class="rainbow-delimiters-depth-4-face">(</span>im-jira--select-project<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>cdr<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span>cons <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">name</span> it<span class="rainbow-delimiters-depth-5-face">)</span> it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-alist-completing-read <span class="string">&quot;Select a user: &quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira--select-project</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Interactively select one of enrolled projects.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>eq <span class="rainbow-delimiters-depth-4-face">(</span>length im-jira-projects<span class="rainbow-delimiters-depth-4-face">)</span> 1<span class="rainbow-delimiters-depth-3-face">)
      (</span>car im-jira-projects<span class="rainbow-delimiters-depth-3-face">)
    (</span>completing-read <span class="string">&quot;Select project: &quot;</span> im-jira-projects<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira--select-issue-type</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>completing-read
   <span class="string">&quot;Issue type: &quot;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--map</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let-alist</span> it <span class="rainbow-delimiters-depth-5-face">(</span>cons .name .id<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>jiralib2-get-issuetypes<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira--get-issue-template</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue-type<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">pcase</span> issue-type
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;Story&quot; &quot;** Motivation\n\n\n** Description\n\n\n** Acceptance Criteria\n\n\n** Projects\n\n\n** Has Automation Test?\n\n\n** Links (UI/UX, Analysis etc.)\n\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;Sprint Development Bug&quot; &quot;** Description\n\n\n**Case\n\n\n** Projects\n\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="string">&quot;Production Bug&quot; &quot;** Description\n\n\n** Steps\n\n\n** Projects\n\n\n** Incident Excel\n\n\n** Links - SS - Video\n\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira--create-branch-name-from-ticket</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create a branch name from given Jira ISSUE-NAME&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">thread-last</span>
    issue-name
    <span class="rainbow-delimiters-depth-3-face">(</span>im-string-url-case<span class="rainbow-delimiters-depth-3-face">)
    (</span>s-downcase<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-s-upcase-until <span class="string">&quot;-&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>s-prepend im-jira-feature-branch-prefix<span class="rainbow-delimiters-depth-3-face">)
    (</span>read-string <span class="string">&quot;Branch name: &quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> Color code status etc.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-jira--format-ticket-name</span> <span class="rainbow-delimiters-depth-2-face">(</span>it<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Format ticket name for displaying in completing-read window.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let-alist</span> it
    <span class="rainbow-delimiters-depth-3-face">(</span>format
     <span class="string">&quot;%-7s\t[%-11s]\t%-15s =&gt; %-15s\t%s&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>propertize .key
                 <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bold</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>propertize <span class="rainbow-delimiters-depth-5-face">(</span>s-truncate 11 .fields.status.name<span class="rainbow-delimiters-depth-5-face">)</span>
                 <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">italic</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>propertize <span class="rainbow-delimiters-depth-5-face">(</span>s-truncate 15 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> .fields.reporter.name <span class="string">&quot;N/A&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                 <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">italic</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>propertize <span class="rainbow-delimiters-depth-5-face">(</span>s-truncate 15 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> .fields.assignee.name <span class="string">&quot;N/A&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
                 <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">italic</span><span class="rainbow-delimiters-depth-4-face">)</span>
     .fields.summary<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-issue-actions</span> <span class="rainbow-delimiters-depth-2-face">(</span>issue<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>jiralib2-get-issue <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="string">&quot;Jira issue: &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-issue-at-point<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cl-loop</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let-alist</span> issue
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>action
             <span class="rainbow-delimiters-depth-7-face">(</span>im-completing-read
              <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;Act on %s: &quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>s-truncate 20 .fields.summary<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
              <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="string">&quot;View&quot; &quot;Open&quot; &quot;Update&quot; &quot;To branch&quot; &quot;To worktree&quot; &quot;Assign to...&quot; &quot;Insert as task&quot; &quot;Change status&quot; &quot;Inspect&quot; &quot;[Cancel]&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span>
              <span class="builtin">:sort?</span> nil<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">pcase</span> action
         <span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;View&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-view-ticket .key<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;Open&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">with-default-browser</span>
           <span class="rainbow-delimiters-depth-8-face">(</span>im-jira-open-issue .key<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;Update&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-update-ticket .key .fields.summary .fields.description<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;To branch&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-ticket-to-branch .key .fields.summary<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;To worktree&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-ticket-to-worktree .key .fields.summary<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;Assign to...&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>jiralib2-assign-issue
           .key
           <span class="rainbow-delimiters-depth-8-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">name</span> <span class="rainbow-delimiters-depth-9-face">(</span>im-jira--select-user<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;Change status&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-change-issue-status .key<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;Insert as task&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>insert <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;** </span><span class="default-0037">TODO</span><span class="string"> [#A] %s %s :work:&quot;</span> .key .fields.summary<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;Inspect&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span>im-json-encode-and-show issue<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="string">&quot;[Cancel]&quot;</span>
          <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-convert-jira-markup-to-org-mode</span> <span class="rainbow-delimiters-depth-2-face">(</span>jira-markup<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert given JIRA-MARKUP string to org-mode format.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>insert jira-markup<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">This creates loose lists where newlines appear between
</span>    <span class="comment-delimiter">;; </span><span class="comment">list items and ox-confluence does not handle this well and
</span>    <span class="comment-delimiter">;; </span><span class="comment">breaks lists.
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-on-region
     <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">) (</span>point-max<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;pandoc -f jira -t org --wrap=none&quot;</span>
     nil t<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">So I try to remove those unnecassary new lines here.
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Same replacement applied twice.
</span>     <span class="rainbow-delimiters-depth-4-face">(</span>replace-regexp-in-string <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[ \t]*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">-</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\n\n</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[ \t]*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">-&quot; &quot;\\1-\\2\n\\3-&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>replace-regexp-in-string <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[ \t]*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">-</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\n\n</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[ \t]*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">-&quot; &quot;\\1-\\2\n\\3-&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>replace-regexp-in-string <span class="string">&quot;\\\\\\\\$&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Fix deeply nested bullet points
</span>     <span class="rainbow-delimiters-depth-4-face">(</span>replace-regexp-in-string <span class="string">&quot;---- &quot; &quot;- &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Fix - [ ] markers
</span>     <span class="rainbow-delimiters-depth-4-face">(</span>replace-regexp-in-string <span class="string">&quot;- \\*=( )=\\* &quot; &quot;- [ ] &quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>replace-regexp-in-string <span class="string">&quot;- \\*=(-)=\\* &quot; &quot;- [-] &quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>replace-regexp-in-string <span class="string">&quot;- \\*=(X)=\\* &quot; &quot;- [X] &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-update-ticket</span> <span class="rainbow-delimiters-depth-2-face">(</span>key summary description<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-get-input
   <span class="builtin">:init</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>concat
    <span class="string">&quot;* &quot;</span>
    summary
    <span class="string">&quot;\n&quot;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>im-convert-jira-markup-to-org-mode description<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:pre-process</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:on-accept</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>description summary<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">setq</span> description
           <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
            <span class="rainbow-delimiters-depth-6-face">(</span>org-export-string-as description <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">confluence</span> t<span class="rainbow-delimiters-depth-6-face">)
            (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
            (</span>-drop 1<span class="rainbow-delimiters-depth-6-face">)
            (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>message <span class="string">&quot;&gt;&gt; (im-jira-update-ticket \&quot;%s\&quot; \&quot;%s\&quot; \&quot;%s\&quot;)&quot;</span> key summary description<span class="rainbow-delimiters-depth-4-face">)
     (</span>jiralib2-update-summary-description key summary description<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">jira-view-mode
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar-local</span> <span class="variable-name">jira-view-mode-ticket</span> nil
  <span class="doc">&quot;Currently viewed ticket object.&quot;</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">define-derived-mode</span> <span class="function-name">jira-view-mode</span> org-mode <span class="string">&quot;JiraView&quot;</span>
  <span class="doc">&quot;Mode for viewing JIRA tickets.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">jira-view-mode-open-externally</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil jira-view-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-default-browser</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let-alist</span> jira-view-mode-ticket
     <span class="rainbow-delimiters-depth-4-face">(</span>im-jira-open-issue .key<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">jira-view-mode-edit</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil jira-view-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let-alist</span> jira-view-mode-ticket
    <span class="rainbow-delimiters-depth-3-face">(</span>im-jira-update-ticket .key .fields.summary .fields.description<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">jira-view-mode-reload</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil jira-view-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let-alist</span> jira-view-mode-ticket
    <span class="rainbow-delimiters-depth-3-face">(</span>im-jira-view-ticket .key<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">jira-view-mode-act</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil jira-view-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-jira-issue-actions jira-view-mode-ticket<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">jira-view-mode-inspect</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil jira-view-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-inspect jira-view-mode-ticket<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> jira-view-mode-map
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;&amp;&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jira-view-mode-open-externally</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;ge&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jira-view-mode-edit</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;gr&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jira-view-mode-reload</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;gi&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jira-view-mode-inspect</span>
  <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> All actions might be single keypress.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;ga&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">jira-view-mode-act</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-view-ticket</span> <span class="rainbow-delimiters-depth-2-face">(</span>key<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;sIssue key: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-3-face">(</span>match <span class="rainbow-delimiters-depth-4-face">(</span>s-match <span class="string">&quot;browse/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[a-zA-Z0-9-]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">/?&quot;</span> key<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> key <span class="rainbow-delimiters-depth-4-face">(</span>nth 1 match<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>ticket <span class="rainbow-delimiters-depth-5-face">(</span>jiralib2-get-issue key<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let-alist</span> ticket
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>buffer <span class="rainbow-delimiters-depth-7-face">(</span>get-buffer-create <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;*jira:%s:%s*&quot;</span> key .fields.summary<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-6-face">(</span>eq <span class="rainbow-delimiters-depth-7-face">(</span>current-buffer<span class="rainbow-delimiters-depth-7-face">)</span> buffer<span class="rainbow-delimiters-depth-6-face">)
          (</span>switch-to-buffer-other-window buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)
      (</span>insert
       <span class="rainbow-delimiters-depth-5-face">(</span>concat
        <span class="string">&quot;* &quot;</span>
        key
        <span class="string">&quot; - &quot;</span>
        .fields.summary
        <span class="string">&quot;\n&quot;</span>
        <span class="rainbow-delimiters-depth-6-face">(</span>im-convert-jira-markup-to-org-mode .fields.description<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>jira-view-mode<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> header-line-format <span class="string">&quot;Hit `</span><span class="constant">&amp;</span><span class="string">' to open in browser, `</span><span class="constant">ge</span><span class="string">' to edit, `</span><span class="constant">gr</span><span class="string">' to reload, `</span><span class="constant">ga</span><span class="string">' to see actions.&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq-local</span> jira-view-mode-ticket ticket<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-set-property <span class="string">&quot;STATUS&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> .fields.status.name <span class="string">&quot;N/A&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-set-property <span class="string">&quot;REPORTER&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> .fields.reporter.name <span class="string">&quot;N/A&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-set-property <span class="string">&quot;ASSIGNEE&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> .fields.assignee.name <span class="string">&quot;N/A&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-set-property <span class="string">&quot;STORY_POINTS&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>alist-get im-jira-story-points-field-name .fields<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;N/A&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>org-fold-show-all<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-list-current-sprint-assignee-swimlane</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Draw an org table for the current sprint that resembles assignee
swimlanes of JIRA.
It also shows how much story point each assignee has and how much
story points they have released. See the following figure:

  | Assignee  | Total | Done | Sub-total | Status      | Issue         |
  |-----------+-------+------+-----------+-------------+---------------|
  | someone-1 |   8.0 |  3.0 |           |             |               |
  |           |       |      |       3.0 | Open        | AI-483 - ...  |
  |           |       |      |       3.0 | Done        | AI-423 -  ... |
  |           |       |      |       2.0 | Code Review | AI-488 - ...  |
  |-----------+-------+------+-----------+-------------+---------------|
  | someone-2 |   7.0 |  2.0 |           |             |               |
  |           |       |      |       2.0 | Released    | AI-485 - ...  |
  |           |       |      |       5.0 | In Progress | AI-313 - ...  |&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create <span class="string">&quot;*jira: current-sprint-by-points*&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>erase-buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-mode<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-dblock-write:jira <span class="rainbow-delimiters-depth-4-face">(</span>list <span class="builtin">:projects</span> im-jira-projects<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer <span class="rainbow-delimiters-depth-4-face">(</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">org-dblock-write:jira</span> <span class="rainbow-delimiters-depth-2-face">(</span>params<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Dynamic block version of `</span><span class="constant">im-jira-list-current-sprint-assignee-swimlane</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>projects <span class="rainbow-delimiters-depth-5-face">(</span>plist-get params <span class="builtin">:projects</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>issues <span class="rainbow-delimiters-depth-5-face">(</span>plist-get params <span class="builtin">:issues</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>progress? <span class="rainbow-delimiters-depth-5-face">(</span>plist-get params <span class="builtin">:progress?</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>jql <span class="rainbow-delimiters-depth-5-face">(</span>plist-get params <span class="builtin">:jql</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>group-by-assignee? <span class="rainbow-delimiters-depth-5-face">(</span>plist-get params <span class="builtin">:group-by-assignee</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
         results<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> issues
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">setq</span> jql <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;key IN (%s)&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-join <span class="string">&quot;, &quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">symbol-name</span> issues<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> results <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">cond</span>
                   <span class="rainbow-delimiters-depth-5-face">(</span>jql <span class="rainbow-delimiters-depth-6-face">(</span>jiralib2-jql-search jql<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                   (</span>t <span class="rainbow-delimiters-depth-6-face">(</span>im-jira-get-current-sprint-issues projects<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> progress?
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>done <span class="rainbow-delimiters-depth-7-face">(</span>length <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-9-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="string">&quot;Released&quot; &quot;Done&quot;</span><span class="rainbow-delimiters-depth-1-face">) (</span><span class="keyword">let-alist</span> it .fields.status.name<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> results<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span>total <span class="rainbow-delimiters-depth-7-face">(</span>length results<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert
         <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;- Progress :: %s/%s (%s%%)\n\n&quot;</span> done total <span class="rainbow-delimiters-depth-7-face">(</span>/ <span class="rainbow-delimiters-depth-8-face">(</span>* 100 done<span class="rainbow-delimiters-depth-8-face">)</span> total<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> group-by-assignee?
        <span class="rainbow-delimiters-depth-4-face">(</span>insert <span class="string">&quot;| Assignee | Total | Done |  Sub-total | Status | Creator  | Issue |\n|-\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert <span class="string">&quot;| Assignee | Creator | Point | Status | Sprint | Issue |\n|-\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>group-by-assignee?
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
       results
       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--group-by</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">let-alist</span> it .fields.assignee.name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>map-apply
        <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>key vals<span class="rainbow-delimiters-depth-8-face">)
          (</span>list
           <span class="builtin">:assignee</span> key
           <span class="builtin">:total</span> <span class="rainbow-delimiters-depth-9-face">(</span>-sum <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let-alist</span> it <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>alist-get im-jira-story-points-field-name .fields<span class="rainbow-delimiters-depth-4-face">)</span> 0<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span> vals<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
           <span class="builtin">:done</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">-&gt;&gt;</span>
                  vals
                  <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-2-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="string">&quot;Done&quot; &quot;Released&quot;</span><span class="rainbow-delimiters-depth-3-face">) (</span><span class="keyword">let-alist</span> it .fields.status.name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                  (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let-alist</span> it <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>alist-get im-jira-story-points-field-name .fields<span class="rainbow-delimiters-depth-4-face">)</span> 0<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                  (</span>-sum<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span>
           <span class="builtin">:tasks</span>
           <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">-&gt;&gt;</span>
            <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let-alist</span> it
                     <span class="rainbow-delimiters-depth-3-face">(</span>list
                      <span class="builtin">:points</span> <span class="rainbow-delimiters-depth-4-face">(</span>alist-get im-jira-story-points-field-name .fields<span class="rainbow-delimiters-depth-4-face">)</span>
                      <span class="builtin">:summary</span> <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;%s - %s&quot;</span> .key .fields.summary<span class="rainbow-delimiters-depth-4-face">)</span>
                      <span class="builtin">:status</span> .fields.status.name
                      <span class="builtin">:creator</span> .fields.creator.name<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                   vals<span class="rainbow-delimiters-depth-1-face">)
            (</span><span class="keyword">--sort</span> <span class="rainbow-delimiters-depth-2-face">(</span>string&gt; <span class="rainbow-delimiters-depth-3-face">(</span>plist-get it <span class="builtin">:status</span><span class="rainbow-delimiters-depth-3-face">) (</span>plist-get other <span class="builtin">:status</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span><span class="keyword">--sort</span> <span class="rainbow-delimiters-depth-7-face">(</span>&gt; <span class="rainbow-delimiters-depth-8-face">(</span>plist-get it <span class="builtin">:total</span><span class="rainbow-delimiters-depth-8-face">) (</span>plist-get other <span class="builtin">:total</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;| %s | %s | %s | | | |\n%s&quot;</span>
                      <span class="rainbow-delimiters-depth-8-face">(</span>plist-get it <span class="builtin">:assignee</span><span class="rainbow-delimiters-depth-8-face">)
                      (</span>plist-get it <span class="builtin">:total</span><span class="rainbow-delimiters-depth-8-face">)
                      (</span>plist-get it <span class="builtin">:done</span><span class="rainbow-delimiters-depth-8-face">)
                      (</span>s-join
                       <span class="string">&quot;\n&quot;</span>
                       <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-1-face">(</span>format <span class="string">&quot;| | | | %s | %s | %s | %s |&quot;</span>
                                      <span class="rainbow-delimiters-depth-2-face">(</span>plist-get it <span class="builtin">:points</span><span class="rainbow-delimiters-depth-2-face">)
                                      (</span>plist-get it <span class="builtin">:creator</span><span class="rainbow-delimiters-depth-2-face">)
                                      (</span>plist-get it <span class="builtin">:status</span><span class="rainbow-delimiters-depth-2-face">)
                                      (</span>s-truncate 120 <span class="rainbow-delimiters-depth-3-face">(</span>plist-get it <span class="builtin">:summary</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                              (</span>plist-get it <span class="builtin">:tasks</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>s-join <span class="string">&quot;\n|-\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>insert<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>t
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
       results
       <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">let-alist</span> it
                <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;| %s | %s | %s | %s | %s | %s |&quot;</span>
                        .fields.assignee.name
                        .fields.creator.name
                        <span class="rainbow-delimiters-depth-9-face">(</span>alist-get im-jira-story-points-field-name .fields<span class="rainbow-delimiters-depth-9-face">)</span>
                        .fields.status.name
                        <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>match <span class="rainbow-delimiters-depth-3-face">(</span>s-match <span class="string">&quot;name=</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[</span><span class="negation-char">^</span><span class="string">,]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">,&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-5-face">(</span>car .fields.customfield_10004<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                          (</span>nth 1 match<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                        (</span>s-truncate 120 <span class="rainbow-delimiters-depth-1-face">(</span>format <span class="string">&quot;%s - %s&quot;</span> .key .fields.summary<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>insert<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-table-align<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-jira-create-quick-issue</span> <span class="rainbow-delimiters-depth-2-face">(</span>arg<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Quickly create an issue and act on it.
If ARG is non-nil, insert the issue number to current buffer
instead of acting on issue.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>issue <span class="rainbow-delimiters-depth-5-face">(</span>jiralib2-create-issue
                <span class="rainbow-delimiters-depth-6-face">(</span>im-jira--select-project<span class="rainbow-delimiters-depth-6-face">)
                (</span>im-jira--select-issue-type<span class="rainbow-delimiters-depth-6-face">)
                (</span>read-string <span class="string">&quot;Issue summary: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
                <span class="string">&quot;This is an automatically generated small issue.&quot;</span>
                <span class="rainbow-delimiters-depth-6-face">(</span>cons
                 <span class="rainbow-delimiters-depth-7-face">(</span>im-jira-get-issue-field-id-for <span class="string">&quot;Sprint&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                 (</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span> <span class="rainbow-delimiters-depth-8-face">(</span>im-jira-find-sprint <span class="string">&quot;future&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let-alist</span> issue
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">save-window-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>im-jira-view-ticket .key<span class="rainbow-delimiters-depth-5-face">)
        (</span>message <span class="string">&quot;&gt;&gt; Opened issue in a buffer.&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-kill .key<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">if</span> arg
          <span class="rainbow-delimiters-depth-5-face">(</span>insert .key <span class="string">&quot; - &quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>im-jira-issue-actions issue<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> My Android phone and Emacs
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have an Android phone that is running
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://termux.com/][Termux]] all the time. If you install Termux
</span><span class="comment-delimiter">;; </span><span class="comment">through [[https://www.f-droid.org/][F-Droid]] you can also install
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://f-droid.org/en/packages/com.termux.api/][Termux:API]]
</span><span class="comment-delimiter">;; </span><span class="comment">package which brings bunch of commands like =termux-clipboard-set=,
</span><span class="comment-delimiter">;; </span><span class="comment">=termux-sms-list= etc. Much of the commands requires to be called
</span><span class="comment-delimiter">;; </span><span class="comment">in foreground, so they are not very useful over SSH but you can
</span><span class="comment-delimiter">;; </span><span class="comment">work around that by starting a =tmux= session on the phone and
</span><span class="comment-delimiter">;; </span><span class="comment">executing commands on that tmux session through SSH. This way I can
</span><span class="comment-delimiter">;; </span><span class="comment">send arbitrary text to my phones clipboard using the commands
</span><span class="comment-delimiter">;; </span><span class="comment">below.
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;ept&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-send-text-to-my-phone</span>
  <span class="string">&quot;epc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-send-clipboard-to-my-phone</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-phone-hostname</span>
  <span class="string">&quot;f3&quot;</span>
  <span class="doc">&quot;Hostname or local address to connect to my phone by SSH.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-send-termux-command-async</span> <span class="rainbow-delimiters-depth-2-face">(</span>cmd fn <span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send CMD to my phone.
When CMD finishes, FN is called with the process output.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sText: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>output
        <span class="rainbow-delimiters-depth-4-face">(</span>txt
         <span class="rainbow-delimiters-depth-5-face">(</span>concat cmd <span class="string">&quot; &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-join <span class="string">&quot;&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-8-face">(</span>concat <span class="string">&quot;\&quot;&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>s-replace <span class="string">&quot;\&quot;&quot; &quot;\\\&quot;&quot;</span> it<span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;\&quot;&quot; &quot; &quot;</span><span class="rainbow-delimiters-depth-8-face">)</span> args<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>proc <span class="rainbow-delimiters-depth-5-face">(</span>start-process
               <span class="string">&quot;*im-termux-cmd*&quot;</span>
               nil
               <span class="string">&quot;ssh&quot;
               &quot;-T&quot;</span>
               im-phone-hostname<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>set-process-filter proc <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>proc out<span class="rainbow-delimiters-depth-5-face">) (</span><span class="keyword">setq</span> output <span class="rainbow-delimiters-depth-6-face">(</span>concat output out<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>set-process-sentinel proc <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>proc event<span class="rainbow-delimiters-depth-5-face">) (</span>funcall fn output<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>process-send-string proc txt<span class="rainbow-delimiters-depth-3-face">)
    (</span>process-send-eof proc<span class="rainbow-delimiters-depth-3-face">)
    (</span>process-send-eof proc<span class="rainbow-delimiters-depth-3-face">)</span>
    proc<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-send-termux-command</span> <span class="rainbow-delimiters-depth-2-face">(</span>cmd <span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send CMD to my phone.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sText: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-temp-buffer</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>insert cmd <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--each</span> args
      <span class="rainbow-delimiters-depth-4-face">(</span>insert <span class="string">&quot;\&quot;&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-replace <span class="string">&quot;\&quot;&quot; &quot;\\\&quot;&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;\&quot;&quot; &quot; &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command-on-region
     <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)
     (</span>point-max<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;ssh -T %s&quot;</span> im-phone-hostname<span class="rainbow-delimiters-depth-4-face">)</span>
     t t<span class="rainbow-delimiters-depth-3-face">)
    (</span>buffer-string<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-send-text-to-my-phone</span> <span class="rainbow-delimiters-depth-2-face">(</span>text<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send TEXT to my phones clipboard. This only works if the phone
  is already open.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;sText: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-send-termux-command-async <span class="string">&quot;termux-clipboard-set&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>_<span class="rainbow-delimiters-depth-4-face">) (</span>message <span class="string">&quot;&gt;&gt; Text sent: %s.&quot;</span> text<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> text<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-send-clipboard-to-my-phone</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Send current clipboard content to my phones clipboard. This only
  works if the phone is already open.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-send-text-to-my-phone <span class="rainbow-delimiters-depth-3-face">(</span>current-kill 0<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-list-phone-text-messages</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;List messages from my phone.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>result <span class="rainbow-delimiters-depth-5-face">(</span>completing-read
                 <span class="string">&quot;Messages: &quot;</span>
                 <span class="rainbow-delimiters-depth-6-face">(</span>seq-map
                  <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>msg<span class="rainbow-delimiters-depth-8-face">) (</span><span class="keyword">let-alist</span> msg <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;%s :: %s&quot;</span> .number .body<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                  (</span>json-read-from-string
                   <span class="rainbow-delimiters-depth-8-face">(</span>im-send-termux-command <span class="string">&quot;termux-sms-list&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer-other-window <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer-create <span class="string">&quot;*im-message*&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert result<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Signal
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">dbus</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;epn&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-signal-send-note-to-myself</span>
  <span class="string">&quot;epm&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-signal-send-message</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defconst</span> <span class="variable-name">im-signal-dbus-args</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:session</span> <span class="string">&quot;org.asamk.Signal&quot;
                                &quot;/org/asamk/Signal&quot;
                                &quot;org.asamk.Signal&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-signal</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send a signal DBUS command with ARGS.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dbus-call-method</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span>,@im-signal-dbus-args ,@args<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-signal-async</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send an async Signal DBUS command with ARGS.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dbus-call-method-asynchronously</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span>,@im-signal-dbus-args ,@args<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-signal-send-note-to-myself</span> <span class="rainbow-delimiters-depth-2-face">(</span>note <span class="type">&amp;optional</span> attachments<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send a NOTE with attachments to my phone.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)
        (</span>buffer-substring <span class="rainbow-delimiters-depth-6-face">(</span>region-beginning<span class="rainbow-delimiters-depth-6-face">) (</span>region-end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>read-string <span class="string">&quot;Enter note: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>y-or-n-p <span class="string">&quot;Want to attach something? &quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>list <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name <span class="string">&quot;Attachment: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-signal-async
   <span class="string">&quot;sendNoteToSelfMessage&quot;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>msg<span class="rainbow-delimiters-depth-4-face">) (</span>message <span class="string">&quot;&gt;&gt; Signal %s&quot;</span> msg<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   note
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>mapcar <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">expand-file-name</span> attachments<span class="rainbow-delimiters-depth-4-face">)</span>
       <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:array</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-signal-send-message</span> <span class="rainbow-delimiters-depth-2-face">(</span>recipient content <span class="type">&amp;optional</span> attachments<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Send message to RECIPIENT with CONTENT.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>im-signal-select-contact<span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)
        (</span>buffer-substring <span class="rainbow-delimiters-depth-6-face">(</span>region-beginning<span class="rainbow-delimiters-depth-6-face">) (</span>region-end<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>read-string <span class="string">&quot;Enter message: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>y-or-n-p <span class="string">&quot;Want to attach something? &quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>list <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name <span class="string">&quot;Attachment: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-signal-async
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>plist-get recipient <span class="builtin">:number</span><span class="rainbow-delimiters-depth-4-face">)</span>
       <span class="string">&quot;sendMessage&quot;
     &quot;sendGroupMessage&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>msg<span class="rainbow-delimiters-depth-4-face">) (</span>message <span class="string">&quot;&gt;&gt; Signal %s&quot;</span> msg<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   content
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span>mapcar <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">expand-file-name</span> attachments<span class="rainbow-delimiters-depth-4-face">)</span>
       <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:array</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>cadr recipient<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-signal-select-contact</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Select a contact interactively.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>contacts <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span>
                    <span class="rainbow-delimiters-depth-6-face">(</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>im-signal <span class="string">&quot;getContactName&quot;</span> it<span class="rainbow-delimiters-depth-7-face">)</span> it<span class="rainbow-delimiters-depth-6-face">)
                    (</span>im-signal <span class="string">&quot;listNumbers&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>groups <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span>
                  <span class="rainbow-delimiters-depth-6-face">(</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>format
                         <span class="string">&quot;%s [GROUP]&quot;</span>
                         <span class="rainbow-delimiters-depth-8-face">(</span>im-signal <span class="string">&quot;getGroupName&quot;</span>
                                    <span class="rainbow-delimiters-depth-9-face">(</span>dbus-string-to-byte-array <span class="rainbow-delimiters-depth-1-face">(</span>dbus-byte-array-to-string it<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
                        it<span class="rainbow-delimiters-depth-6-face">)
                  (</span>im-signal <span class="string">&quot;getGroupIds&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>all <span class="rainbow-delimiters-depth-5-face">(</span>append contacts groups<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>selected <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>assoc <span class="rainbow-delimiters-depth-7-face">(</span>completing-read <span class="string">&quot;Send message to: &quot;</span> all<span class="rainbow-delimiters-depth-7-face">)</span> all<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>stringp selected<span class="rainbow-delimiters-depth-4-face">)
        (</span>list <span class="builtin">:number</span> selected<span class="rainbow-delimiters-depth-4-face">)
      (</span>list <span class="builtin">:group</span> <span class="rainbow-delimiters-depth-5-face">(</span>dbus-string-to-byte-array <span class="rainbow-delimiters-depth-6-face">(</span>dbus-byte-array-to-string selected<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-signal-sync-message-received-handler</span> <span class="rainbow-delimiters-depth-2-face">(</span>ts source receiver _ msg attchs<span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;&gt;&gt; [signal] sender=%s, receiver=%s, msg=%s, attach=%s, _=%s&quot;</span> source receiver msg attchs _<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-4-face">(</span>string= im-my-phone-number source<span class="rainbow-delimiters-depth-4-face">)
             (</span><span class="keyword">or</span>
              <span class="rainbow-delimiters-depth-5-face">(</span>string= receiver im-my-phone-number<span class="rainbow-delimiters-depth-5-face">)
              (</span>-contains?
               <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">uuid</span> it<span class="rainbow-delimiters-depth-7-face">) (</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">accounts</span> <span class="rainbow-delimiters-depth-8-face">(</span>json-read-file <span class="rainbow-delimiters-depth-9-face">(</span>expand-file-name <span class="string">&quot;~/.local/share/signal-cli/data/accounts.json&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
               receiver<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>string= <span class="string">&quot;hey&quot;</span> msg<span class="rainbow-delimiters-depth-6-face">)
          (</span>string= <span class="string">&quot;ping&quot;</span> msg<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;&gt;&gt; %s&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>shell-command-to-string <span class="string">&quot;hostname&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;stop &quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>string= <span class="rainbow-delimiters-depth-7-face">(</span>s-chop-prefix <span class="string">&quot;stop &quot;</span> msg<span class="rainbow-delimiters-depth-7-face">) (</span>shell-command-to-string <span class="string">&quot;hostname&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>im-signal-send-note-to-myself <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;&gt;&gt; Closing signal bot.&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>shell-command-to-string <span class="string">&quot;hostname&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>im-stop-signal-bot<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;run&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself
       <span class="rainbow-delimiters-depth-6-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-7-face">(</span>s-chop-prefix <span class="string">&quot;run &quot;</span> msg<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>string= <span class="string">&quot;help&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself
       <span class="rainbow-delimiters-depth-6-face">(</span>concat
        <span class="string">&quot;- hey/ping&quot;
        &quot;- stop &lt;hostname&gt;&quot;
        &quot;- run &lt;shell-command&gt;\n&quot;
        &quot;- grab &lt;file-path&gt;\n&quot;
        &quot;- note &lt;note-details&gt;\n&quot;
        &quot;- clip :: get computer clipboard\n&quot;
        &quot;- gpt &lt;prompt&gt;\n&quot;
        &quot;- gpt4 &lt;prompt&gt;\n&quot;
        &quot;- bus|tram|ovchipkaart\n&quot;
        &quot;\n&quot;
        &quot;- send a link and it will copied to clipboard\n&quot;
        &quot;- help&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;grab&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself
       <span class="string">&quot;&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>list <span class="rainbow-delimiters-depth-7-face">(</span>s-chop-prefix <span class="string">&quot;grab &quot;</span> msg<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;note&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>kill-new <span class="rainbow-delimiters-depth-6-face">(</span>s-chop-prefix <span class="string">&quot;note &quot;</span> msg<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>im-clear-side-windows<span class="rainbow-delimiters-depth-5-face">)
      (</span>org-capture nil <span class="string">&quot;I&quot;</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;&gt;&gt; Noted: %s&quot;</span> msg<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;http&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>message <span class="string">&quot;&gt;&gt; [signal] Copied to clipboard: %s&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>kill-new msg<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-equals? <span class="string">&quot;clip&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself <span class="rainbow-delimiters-depth-6-face">(</span>car kill-ring<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;gpt&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-gpt
       <span class="rainbow-delimiters-depth-6-face">(</span>s-chop-prefix <span class="string">&quot;gpt &quot;</span> msg<span class="rainbow-delimiters-depth-6-face">)</span>
       <span class="builtin">:callback</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>_ response<span class="rainbow-delimiters-depth-7-face">) (</span>im-signal-send-note-to-myself response<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;gpt4&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-gpt
       <span class="rainbow-delimiters-depth-6-face">(</span>s-chop-prefix <span class="string">&quot;gpt4 &quot;</span> msg<span class="rainbow-delimiters-depth-6-face">)</span>
       <span class="builtin">:model</span> <span class="string">&quot;gpt-4&quot;</span>
       <span class="builtin">:callback</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>_ response<span class="rainbow-delimiters-depth-7-face">) (</span>im-signal-send-note-to-myself response<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="rainbow-delimiters-depth-5-face">(</span>s-matches? <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">bus</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">ovchip.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">tram</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> msg<span class="rainbow-delimiters-depth-5-face">)
      (</span>im-signal-send-note-to-myself <span class="rainbow-delimiters-depth-6-face">(</span>im-ovchipkaart<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>attchs
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--each</span> attchs
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>mime <span class="rainbow-delimiters-depth-9-face">(</span>im-mimetype it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">cond</span>
           <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>s-prefix? <span class="string">&quot;image/&quot;</span> mime<span class="rainbow-delimiters-depth-9-face">)
            (</span>message <span class="string">&quot;</span><span class="default-0037">TODO</span><span class="string">: Handle self images %s&quot;</span> it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
           (</span><span class="rainbow-delimiters-depth-9-face">(</span>s-prefix <span class="string">&quot;audio/&quot;</span> mime<span class="rainbow-delimiters-depth-9-face">)
            (</span>message <span class="string">&quot;</span><span class="default-0037">TODO</span><span class="string">: Handle self sound %s&quot;</span> it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-signal-bot-object</span> nil<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-start-signal-bot</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">unless</span> im-signal-bot-object
    <span class="rainbow-delimiters-depth-3-face">(</span>message <span class="string">&quot;&gt;&gt; signal-bot is starting...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span>
     im-signal-bot-object
     <span class="rainbow-delimiters-depth-4-face">(</span>apply
      <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">dbus-register-signal</span>
      <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span>,@im-signal-dbus-args
        ,<span class="string">&quot;SyncMessageReceived&quot;</span>
        ,<span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-signal-sync-message-received-handler</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-stop-signal-bot</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>dbus-unregister-object im-signal-bot-object<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-signal-bot-object nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>run-with-timer 60 nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-start-signal-bot</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> people.org - Contact management
</span>
<span class="comment-delimiter">;; </span><span class="comment">Please see
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://isamert.net/2021/04/21/managing-your-contacts-in-org-mode-and-syncing-them-to-your-phone-android-ios-whatever-.html][this
</span><span class="comment-delimiter">;; </span><span class="comment">post]] for further information.
</span>

<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-contacts--build-contact-item</span> <span class="rainbow-delimiters-depth-2-face">(</span>template-string contact-property<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>s-contains? <span class="string">&quot;$1&quot;</span> contact-property<span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">-&gt;&gt;</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>org-entry-properties<span class="rainbow-delimiters-depth-5-face">)
     (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-matches? <span class="rainbow-delimiters-depth-7-face">(</span>s-replace <span class="string">&quot;$1&quot; &quot;.*&quot;</span> contact-property<span class="rainbow-delimiters-depth-7-face">) (</span>car it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>subprop <span class="rainbow-delimiters-depth-9-face">(</span>nth 1 <span class="rainbow-delimiters-depth-1-face">(</span>s-match <span class="rainbow-delimiters-depth-2-face">(</span>s-replace <span class="string">&quot;$1&quot; &quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[a-zA-Z0-9_-]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> contact-property<span class="rainbow-delimiters-depth-2-face">) (</span>car it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>concat <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="rainbow-delimiters-depth-9-face">(</span>s-replace <span class="string">&quot;$1&quot;</span> subprop template-string<span class="rainbow-delimiters-depth-9-face">) (</span>cdr it<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>stuff <span class="rainbow-delimiters-depth-7-face">(</span>org-entry-get nil contact-property<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>concat <span class="rainbow-delimiters-depth-6-face">(</span>format template-string stuff<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
        <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-contacts--contact-entry?</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">thread-last</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>org-entry-properties<span class="rainbow-delimiters-depth-3-face">)
    (</span>-map <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">--any</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-prefix? <span class="string">&quot;PHONE&quot;</span> it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-contacts-build-vcard-for-heading</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Build a VCARD for the current heading and return it as string.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-contacts--contact-entry?<span class="rainbow-delimiters-depth-3-face">)
    (</span>string-join
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;BEGIN:VCARD\nVERSION:4.0\nPRODID:ez-vcard 0.11.3\n&quot;</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;UID:urn:uuid:%s\n&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-id-get nil t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>im-contacts--build-contact-item <span class="string">&quot;FN:%s&quot; &quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-get nil <span class="string">&quot;DISPLAY_NAME&quot;</span><span class="rainbow-delimiters-depth-6-face">)
            (</span>im-contacts--build-contact-item <span class="string">&quot;N:;%s;;;&quot; &quot;DISPLAY_NAME&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>im-contacts--build-contact-item <span class="string">&quot;N:;%s;;;&quot; &quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span>im-contacts--build-contact-item <span class="string">&quot;TEL;TYPE=$1:%s&quot; &quot;PHONE_$1&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span>im-contacts--build-contact-item <span class="string">&quot;EMAIL;TYPE=$1:%s&quot; &quot;EMAIL_$1&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span>im-contacts--build-contact-item <span class="string">&quot;ADR;TYPE=$1:;;%s;;;;&quot; &quot;ADDRESS_$1&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>im-contacts--build-contact-item <span class="string">&quot;ORG:%s&quot; &quot;GROUP&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span>im-contacts--build-contact-item <span class="string">&quot;CATEGORIES:%s&quot; &quot;GROUP&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">thread-last</span>
          <span class="rainbow-delimiters-depth-6-face">(</span>im-contacts--build-contact-item <span class="string">&quot;BDAY:%s&quot; &quot;SCHEDULED&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>s-replace-regexp <span class="string">&quot;BDAY:&lt;[0-9]\\{</span><span class="variable-name">4\\</span><span class="string">}</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&gt;&quot; &quot;BDAY:1900\\1&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>s-replace <span class="string">&quot;-&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="comment-delimiter">;; </span><span class="comment">vcard supports multiple anniversaries but there is no
</span>       <span class="comment-delimiter">;; </span><span class="comment">way to name them as far as I understand. So I just
</span>       <span class="comment-delimiter">;; </span><span class="comment">drop anniversary names and add all of them.
</span>       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">thread-last</span>
           <span class="rainbow-delimiters-depth-6-face">(</span>im-contacts--build-contact-item <span class="string">&quot;ANNIVERSARY:%s&quot; &quot;ANNIVERSARY_$1&quot;</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">-&gt;&gt;</span>
                   it
                   <span class="rainbow-delimiters-depth-8-face">(</span>s-replace-all <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="string">&quot; &quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">) (</span><span class="string">&quot;-&quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">) (</span><span class="string">&quot;[&quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">) (</span><span class="string">&quot;]&quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">) (</span><span class="string">&quot;&lt;&quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">) (</span><span class="string">&quot;&gt;&quot;</span> . <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                   (</span>s-trim<span class="rainbow-delimiters-depth-8-face">)
                   (</span>s-replace-regexp <span class="string">&quot;[a-zA-Z]+$&quot; &quot;\n&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="comment-delimiter">;;</span><span class="comment">,(format &quot;REV:%s\n&quot; (format-time-string &quot;%Y-%m-%dT%T&quot;))
</span>       <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: add notes
</span>       <span class="comment-delimiter">;; </span><span class="comment">Be careful while exporting and sending contact to other people
</span>       ,<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-6-face">(</span>image-base64
                   <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">-some-&gt;&gt;</span>
                       <span class="rainbow-delimiters-depth-8-face">(</span>org-agenda-get-some-entry-text <span class="rainbow-delimiters-depth-9-face">(</span>point-marker<span class="rainbow-delimiters-depth-9-face">)</span> most-positive-fixnum<span class="rainbow-delimiters-depth-8-face">)
                     (</span>substring-no-properties<span class="rainbow-delimiters-depth-8-face">)
                     (</span>s-match <span class="string">&quot;^\\[\\[file:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\.jpg</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">jpeg</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">png</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">]]&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                     (</span>nth 1<span class="rainbow-delimiters-depth-8-face">)
                     (</span>im-encode-image-base64<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>format <span class="string">&quot;PHOTO:%s\n&quot;</span> image-base64<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="string">&quot;TITLE:\nEND:VCARD&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-contacts-export-as-vcard</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> file-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create a .vcf FILE-NAME containing all contact information.
I use \&quot;Simple Contacts Pro\&quot; to import contacts to my phone.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-file-name
     <span class="string">&quot;Where to save the .vcf file?&quot;
     &quot;~/Documents/sync/&quot;
     &quot;contacts.vcf&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>write-region
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">thread-last</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>org-map-entries <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-contacts-build-vcard-for-heading</span> <span class="string">&quot;LEVEL=1&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-non-nil<span class="rainbow-delimiters-depth-4-face">)
     (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   nil
   file-name<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: This does not delete the contact if header is removed
</span><span class="comment-delimiter">;; </span><span class="comment">completely. I probably need something like
</span><span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">im-org-header-deleted-hook</span><span class="comment">', akin to `</span><span class="constant">im-org-header-changed-hook</span><span class="comment">'.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-contacts--update-contact-on-change</span> <span class="rainbow-delimiters-depth-2-face">(</span>info<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Whenever a contact changes in people.org, push changes to Nextcloud.
This is done by adding this function to
  `</span><span class="constant">im-org-header-changed-hook</span><span class="doc">'.  See down below.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>s-ends-with? <span class="string">&quot;people.org&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">save-restriction</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>widen<span class="rainbow-delimiters-depth-5-face">)
        (</span>goto-char <span class="rainbow-delimiters-depth-6-face">(</span>plist-get info <span class="builtin">:begin</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-6-face">(</span>contact <span class="rainbow-delimiters-depth-7-face">(</span>im-contacts-build-vcard-for-heading<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
          <span class="comment-delimiter">;; </span><span class="comment">Save buffer in case of
</span>          <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">im-contacts-build-vcard-for-heading</span><span class="comment">' adds an ID to the
</span>          <span class="comment-delimiter">;; </span><span class="comment">heading
</span>          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>before-save-hook nil<span class="rainbow-delimiters-depth-8-face">)
                (</span>after-save-hook nil<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>save-buffer<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>im-nextcloud-put-contact
           contact
           <span class="builtin">:on-success</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-8-face">) (</span>message <span class="string">&quot;&gt;&gt; Contact updated: %s&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>plist-get info <span class="builtin">:header</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
           <span class="builtin">:on-error</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-8-face">) (</span>message <span class="string">&quot;!! Failed to update contact: %s. Reason: %s&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>plist-get info <span class="builtin">:header</span><span class="rainbow-delimiters-depth-9-face">)</span> _<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-org-header-changed-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-contacts--update-contact-on-change</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> people.org - Quick info selection
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-people</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Select and kill people info.
people.org should contain the following snippet on it's `</span><span class="constant">after-save-hook</span><span class="doc">':
  (im-serialize-into-file \&quot;~/.emacs.d/sync/people\&quot;
    (org-map-entries #'org-entry-properties \&quot;LEVEL=1\&quot;))&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>selected
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
           <span class="rainbow-delimiters-depth-6-face">(</span>im-completing-read
            <span class="string">&quot;Select info&quot;</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>-mapcat
             <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>info<span class="rainbow-delimiters-depth-9-face">)
               (</span><span class="keyword">--map</span>
                <span class="rainbow-delimiters-depth-1-face">(</span>list
                 <span class="builtin">:format</span>
                 <span class="rainbow-delimiters-depth-2-face">(</span>format
                  <span class="string">&quot;%s &gt;&gt; %s → %s&quot;</span>
                  <span class="rainbow-delimiters-depth-3-face">(</span>propertize <span class="rainbow-delimiters-depth-4-face">(</span>alist-get <span class="string">&quot;ITEM&quot;</span> info nil nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:weight</span> bold<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
                  (</span>propertize <span class="rainbow-delimiters-depth-4-face">(</span>car it<span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;yellow&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
                  (</span>propertize <span class="rainbow-delimiters-depth-4-face">(</span>cdr it<span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="builtin">:weight</span> bold <span class="builtin">:foreground</span> <span class="string">&quot;green&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                 <span class="builtin">:item</span> it <span class="builtin">:info</span> info<span class="rainbow-delimiters-depth-1-face">)
                (</span><span class="keyword">--filter</span>
                 <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">and</span>
                  <span class="rainbow-delimiters-depth-3-face">(</span>not <span class="rainbow-delimiters-depth-4-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;PRIORITY&quot; &quot;CATEGORY&quot;</span><span class="rainbow-delimiters-depth-5-face">) (</span>car it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
                  (</span>not <span class="rainbow-delimiters-depth-4-face">(</span>s-blank? <span class="rainbow-delimiters-depth-5-face">(</span>cdr it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                 info<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span>im-deserialize-from-file <span class="string">&quot;~/.emacs.d/sync/people&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
            <span class="builtin">:formatter</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>it<span class="rainbow-delimiters-depth-8-face">) (</span>plist-get it <span class="builtin">:format</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>prop <span class="rainbow-delimiters-depth-5-face">(</span>car <span class="rainbow-delimiters-depth-6-face">(</span>plist-get selected <span class="builtin">:item</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>val <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>plist-get selected <span class="builtin">:item</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>info <span class="rainbow-delimiters-depth-5-face">(</span>cdr <span class="rainbow-delimiters-depth-6-face">(</span>plist-get selected <span class="builtin">:info</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-kill val<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">cond</span>
     <span class="comment-delimiter">;; </span><span class="comment">Insert link to person if we are in org-mode
</span>     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-6-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-6-face">)
           (</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>equal prop <span class="string">&quot;ID&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>insert <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;[[id:%s][%s]]&quot;</span>
                      val
                      <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>use-region-p<span class="rainbow-delimiters-depth-8-face">)
                          (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>beg <span class="rainbow-delimiters-depth-2-face">(</span>region-beginning<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                                 (</span>end <span class="rainbow-delimiters-depth-2-face">(</span>region-end<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                                 (</span>str <span class="rainbow-delimiters-depth-2-face">(</span>buffer-substring-no-properties beg end<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                            (</span>delete-region beg end<span class="rainbow-delimiters-depth-9-face">)</span>
                            str<span class="rainbow-delimiters-depth-8-face">)
                        (</span>s-trim <span class="rainbow-delimiters-depth-9-face">(</span>read-string <span class="string">&quot;Name: &quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>alist-get <span class="string">&quot;ITEM&quot;</span> info nil nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="comment-delimiter">;; </span><span class="comment">Strip out links from addresses
</span>     <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;ADDRESS&quot;</span> prop<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-6-face">(</span>x <span class="rainbow-delimiters-depth-7-face">(</span>s-match <span class="string">&quot;\\[\\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]\\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]\\]&quot;</span> val<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">progn</span>
            <span class="comment-delimiter">;; </span><span class="comment">Put them both in clipboard
</span>            <span class="rainbow-delimiters-depth-7-face">(</span>im-kill <span class="rainbow-delimiters-depth-8-face">(</span>car x<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>im-kill <span class="rainbow-delimiters-depth-8-face">(</span>nth 2 x<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>im-kill val<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>t <span class="rainbow-delimiters-depth-5-face">(</span>im-kill val<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;ou&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-people</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Google search
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-google-this</span> <span class="rainbow-delimiters-depth-2-face">(</span>input<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Search selected region or current word in Google. Let's you edit the query beforehand.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-string
     <span class="string">&quot;Googling: &quot;</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>im-region-or <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">word</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>browse-url
   <span class="rainbow-delimiters-depth-3-face">(</span>concat
    eww-search-prefix
    input<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader-v</span> <span class="string">&quot;mg&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-google-this</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> bullet.org
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have a ~bullet.org~ file that I keep my daily journal and here
</span><span class="comment-delimiter">;; </span><span class="comment">are some utility functions that use with it. I may document this
</span><span class="comment-delimiter">;; </span><span class="comment">later (or even publish it as a package?)
</span>
<span class="comment-delimiter">;; </span><span class="comment">Keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;obb&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-non-day-header</span>
  <span class="string">&quot;oby&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-yesterday</span>
  <span class="string">&quot;obY&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-yesterday-indirect</span>
  <span class="string">&quot;obt&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-today</span>
  <span class="string">&quot;obT&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-tomorrow</span>
  <span class="string">&quot;obf&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-given-day</span>
  <span class="string">&quot;obr&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-recurring</span>
  <span class="string">&quot;obR&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-recurring-indirect</span>
  <span class="string">&quot;obw&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-work</span>
  <span class="string">&quot;obW&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-work-indirect</span>
  <span class="string">&quot;obl&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-life</span>
  <span class="string">&quot;obL&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-life-indirect</span>
  <span class="string">&quot;obc&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-computer</span>
  <span class="string">&quot;obC&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-computer-indirect</span>
  <span class="string">&quot;obi&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-inbox</span>
  <span class="string">&quot;obI&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-bullet-focus-inbox-indirect</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Date utils
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-today</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get todays date in format YYYY-MM-DD Day.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%d %a&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-u</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get day of week as number.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>string-to-number <span class="rainbow-delimiters-depth-3-face">(</span>format-time-string <span class="string">&quot;%u&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-d</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get day of month as number.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>string-to-number <span class="rainbow-delimiters-depth-3-face">(</span>format-time-string <span class="string">&quot;%d&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-V</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get week number.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>string-to-number <span class="rainbow-delimiters-depth-3-face">(</span>format-time-string <span class="string">&quot;%V&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-date</span> <span class="rainbow-delimiters-depth-2-face">(</span>date <span class="type">&amp;optional</span> str<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Display the time described by DATE.
DATE can be '</span><span class="constant">now</span><span class="doc">', '</span><span class="constant">yesterday</span><span class="doc">', 'two days ago' etc.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>s-trim-right
   <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string
    <span class="rainbow-delimiters-depth-4-face">(</span>concat <span class="rainbow-delimiters-depth-5-face">(</span>locate-file <span class="string">&quot;date&quot;</span> exec-path<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot; --date='&quot;</span> date <span class="string">&quot;' +'&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> str <span class="string">&quot;%Y-%m-%d %a&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;'&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Create utils
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-create-a-day</span> <span class="rainbow-delimiters-depth-2-face">(</span>date<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create given DATE heading in bullet.org in the appropriate place..
DATE should be in the form of YYYY-MM-DD.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>point <span class="rainbow-delimiters-depth-5-face">(</span>im-bullet-find-a-day date<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char point<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="warning">user-error</span> <span class="string">&quot;The day already exists&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>widen<span class="rainbow-delimiters-depth-2-face">)
  (</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-max<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cl-loop</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span>re-search-backward <span class="string">&quot;^* \\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9]+-[0-9]+-[0-9]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string"> \\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?\\].*&quot;</span> nil t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>time-less-p
          <span class="rainbow-delimiters-depth-5-face">(</span>date-to-time <span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="rainbow-delimiters-depth-7-face">(</span>match-string 1<span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;T000&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>date-to-time <span class="rainbow-delimiters-depth-6-face">(</span>concat date <span class="string">&quot;T000&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>org-insert-heading-after-current<span class="rainbow-delimiters-depth-4-face">)
     (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;[%s%s] [%%]&quot;</span>
                     date
                     <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-matches? <span class="string">&quot;[a-zA-Z]+$&quot;</span> date<span class="rainbow-delimiters-depth-7-face">)</span>
                         <span class="string">&quot;&quot;</span>
                       <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot; %s&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>format-time-string <span class="string">&quot;%a&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>date-to-time <span class="rainbow-delimiters-depth-1-face">(</span>concat date <span class="string">&quot;T000&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">cl-return</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Focus a day
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-find-a-day</span> <span class="rainbow-delimiters-depth-2-face">(</span>day<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>widen<span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-max<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>re-search-backward <span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="string">&quot;^* \\[&quot;</span> day <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string"> \\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?\\]&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> nil t<span class="rainbow-delimiters-depth-4-face">)
      (</span>point-marker<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-a-day</span> <span class="rainbow-delimiters-depth-2-face">(</span>day<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Focus to given DAY.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-bullet-org-ensure<span class="rainbow-delimiters-depth-2-face">)
  (</span>widen<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>day-entry <span class="rainbow-delimiters-depth-5-face">(</span>im-bullet-find-a-day day<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char day-entry<span class="rainbow-delimiters-depth-3-face">)
    (</span>beginning-of-line<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-show-outline-only<span class="rainbow-delimiters-depth-3-face">)</span>
    t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-given-day</span> <span class="rainbow-delimiters-depth-2-face">(</span>date<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Focus given DATE's header.
If it does not exists, create it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>org-read-date<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>not <span class="rainbow-delimiters-depth-4-face">(</span>im-bullet-focus-a-day date<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-bullet-create-a-day date<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-today</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Focus todays header.
If it does not exists, create it.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>today <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>&lt;= <span class="rainbow-delimiters-depth-7-face">(</span>string-to-number <span class="rainbow-delimiters-depth-8-face">(</span>format-time-string <span class="string">&quot;%H&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span> 3<span class="rainbow-delimiters-depth-6-face">)
                   (</span>im-date <span class="string">&quot;yesterday&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span>format-time-string <span class="string">&quot;%Y-%m-%d&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span>im-bullet-focus-a-day today<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-bullet-create-a-day today<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-tomorrow</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Focus yesterdays header.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>tomorrow <span class="rainbow-delimiters-depth-5-face">(</span>im-date <span class="string">&quot;tomorrow&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>not <span class="rainbow-delimiters-depth-5-face">(</span>im-bullet-focus-a-day tomorrow<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-bullet-create-a-day tomorrow<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-tomorrow-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-tomorrow</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-tomorrow<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-yesterday</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Focus yesterdays header.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-focus-a-day <span class="rainbow-delimiters-depth-3-face">(</span>im-date <span class="string">&quot;yesterday&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-yesterday-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-yesterday</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-yesterday<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-heading</span> <span class="rainbow-delimiters-depth-2-face">(</span>heading<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-org-ensure<span class="rainbow-delimiters-depth-2-face">)
  (</span>widen<span class="rainbow-delimiters-depth-2-face">)
  (</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-min<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>re-search-forward <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;^*+ %s&quot;</span> heading<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>beginning-of-line<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-show-outline-only<span class="rainbow-delimiters-depth-3-face">)</span>
    t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-recurring</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-focus-heading <span class="string">&quot;Recurring&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-recurring-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-recurring</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-recurring<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-work</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-focus-heading <span class="string">&quot;Work backlog&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-work-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-work</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-work<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-life</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-focus-heading <span class="string">&quot;Life backlog&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-life-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-life</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-life<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-computer</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-focus-heading <span class="string">&quot;Computer backlog&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-computer-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-computer</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-computer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-inbox</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-bullet-focus-heading <span class="string">&quot;Inbox&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-inbox-indirect</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">im-bullet-focus-inbox</span><span class="doc">' but in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-org-focused-tree-to-indirect-buffer</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>im-bullet-focus-inbox<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Focus non-day
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-focus-non-day-header</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Interactively select and focus a non-day header.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-match-data</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>widen<span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char 0<span class="rainbow-delimiters-depth-3-face">)
    (</span>re-search-forward <span class="string">&quot;^\\*+ \\[[0-9]+-&quot;</span> nil t<span class="rainbow-delimiters-depth-3-face">)
    (</span>narrow-to-region <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">) (</span>point-at-bol<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>consult-org-heading<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Template utils
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-current-date</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return current date.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">save-restriction</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>widen<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>re-search-backward <span class="string">&quot;^* \\[202&quot;</span> nil t<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">-some-&gt;&gt;</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-get-heading t t t t<span class="rainbow-delimiters-depth-6-face">)
          (</span>s-match <span class="string">&quot;\\[</span><span class="constant">.*?\\</span><span class="string">]&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>car<span class="rainbow-delimiters-depth-6-face">)
          (</span>substring-no-properties<span class="rainbow-delimiters-depth-6-face">)
          (</span>s-chop-prefix <span class="string">&quot;[&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>s-chop-suffix <span class="string">&quot;]&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-when-weekday</span> <span class="rainbow-delimiters-depth-2-face">(</span>template <span class="type">&amp;rest</span> template-args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>&lt;= <span class="rainbow-delimiters-depth-4-face">(</span>im-u<span class="rainbow-delimiters-depth-4-face">)</span> 5<span class="rainbow-delimiters-depth-3-face">)
     (</span>s-trim <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-s-interpolated</span> ,template ,@template-args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-when-weekday-n</span> <span class="rainbow-delimiters-depth-2-face">(</span>n template <span class="type">&amp;rest</span> template-args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>= <span class="rainbow-delimiters-depth-4-face">(</span>im-u<span class="rainbow-delimiters-depth-4-face">)</span> ,n<span class="rainbow-delimiters-depth-3-face">)
     (</span>s-trim <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-s-interpolated</span> ,template ,@template-args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-when-monthday-n</span> <span class="rainbow-delimiters-depth-2-face">(</span>n template <span class="type">&amp;rest</span> template-args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>= <span class="rainbow-delimiters-depth-4-face">(</span>im-d<span class="rainbow-delimiters-depth-4-face">)</span> ,n<span class="rainbow-delimiters-depth-3-face">)
     (</span>s-trim <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-s-interpolated</span> ,template ,@template-args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-when-weekend</span> <span class="rainbow-delimiters-depth-2-face">(</span>template <span class="type">&amp;rest</span> template-args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>&gt; <span class="rainbow-delimiters-depth-4-face">(</span>im-u<span class="rainbow-delimiters-depth-4-face">)</span> 5<span class="rainbow-delimiters-depth-3-face">)
     (</span>s-trim <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-s-interpolated</span> ,template ,@template-args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-when-saturday</span> <span class="rainbow-delimiters-depth-2-face">(</span>template <span class="type">&amp;rest</span> template-args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>= <span class="rainbow-delimiters-depth-4-face">(</span>im-u<span class="rainbow-delimiters-depth-4-face">)</span> 6<span class="rainbow-delimiters-depth-3-face">)
     (</span>s-trim <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-s-interpolated</span> ,template ,@template-args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defmacro</span> <span class="function-name">im-when-sunday</span> <span class="rainbow-delimiters-depth-2-face">(</span>template <span class="type">&amp;rest</span> template-args<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>= <span class="rainbow-delimiters-depth-4-face">(</span>im-u<span class="rainbow-delimiters-depth-4-face">)</span> 7<span class="rainbow-delimiters-depth-3-face">)
     (</span>s-trim <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">im-s-interpolated</span> ,template ,@template-args<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Daily summary
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="comment-delimiter">;; </span><span class="comment">Implementation is a bit cumbersome but it's easy to adopt for my ad-hoc requests
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">org-dblock-write:daily-summary</span> <span class="rainbow-delimiters-depth-2-face">(</span>params<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create a daily summary for my bullet.org.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>items <span class="rainbow-delimiters-depth-5-face">(</span>org-map-entries
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> nil
                   <span class="rainbow-delimiters-depth-7-face">(</span>list
                    <span class="builtin">:name</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span>
                    <span class="builtin">:clock</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span>org-clock-sum-current-item<span class="rainbow-delimiters-depth-8-face">)</span>
                    <span class="builtin">:tags</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-9-face">(</span>org-get-tags<span class="rainbow-delimiters-depth-9-face">)</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-9-face">(</span>empty<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                    <span class="builtin">:level</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span>org-current-level<span class="rainbow-delimiters-depth-8-face">)</span>
                    <span class="builtin">:parent</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">save-excursion</span>
                      <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-1-face">(</span>org-up-heading-safe<span class="rainbow-delimiters-depth-1-face">)
                        (</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                 <span class="string">&quot;LEVEL&gt;1&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>total-time <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
                      items
                      <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-7-face">(</span>= <span class="rainbow-delimiters-depth-8-face">(</span>plist-get it <span class="builtin">:level</span><span class="rainbow-delimiters-depth-8-face">)</span> 2<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                      (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                      (</span>-sum<span class="rainbow-delimiters-depth-6-face">)
                      (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>routines <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-6-face">(</span>s-equals? <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:parent</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;Routines&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span> items<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>work <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-6-face">(</span>-contains? <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:tags</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;work&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span> items<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>others <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-6-face">(</span>not <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span>
                                 <span class="rainbow-delimiters-depth-8-face">(</span>-contains? <span class="rainbow-delimiters-depth-9-face">(</span>plist-get it <span class="builtin">:tags</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;work&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                                 (</span>s-equals? <span class="rainbow-delimiters-depth-9-face">(</span>plist-get it <span class="builtin">:parent</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;Routines&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                                 (</span>s-equals? <span class="rainbow-delimiters-depth-9-face">(</span>plist-get it <span class="builtin">:name</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;Routines&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="warning">items</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span>insert <span class="string">&quot;| [Event] | [Duration] ||\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="string">&quot;|-|\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     items
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-equals? <span class="string">&quot;Routines&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>funcall <span class="rainbow-delimiters-depth-5-face">(</span>-flip <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">plist-get</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|Routines|%s||\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     routines
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;Breakfast&quot; &quot;Dinner&quot;</span><span class="rainbow-delimiters-depth-6-face">) (</span>plist-get it <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|\\-- Eating||%s|\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     routines
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;Breakfast&quot; &quot;Dinner&quot;</span><span class="rainbow-delimiters-depth-7-face">) (</span>plist-get it <span class="builtin">:name</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|\\-- Other||%s|\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span>insert <span class="string">&quot;|-|\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     work
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|Work|%s||\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     work
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>-contains? <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:tags</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;meeting&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|\\-- Meetings||%s|\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     work
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>-contains? <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:tags</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;meeting&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|\\-- Other||%s|\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span>insert <span class="string">&quot;|-|\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     others
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|Other|%s||\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     others
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>-contains? <span class="rainbow-delimiters-depth-6-face">(</span>plist-get it <span class="builtin">:tags</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;side&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|\\-- Side projects||%s|\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span><span class="keyword">-&gt;&gt;</span>
     others
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>-contains? <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:tags</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;side&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get it <span class="builtin">:clock</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>-sum<span class="rainbow-delimiters-depth-4-face">)
     (</span>org-minutes-to-clocksum-string<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;|\\-- Other||%s|\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>insert<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)

    (</span>insert <span class="string">&quot;|-|\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;|Total|%s||\n&quot;</span> total-time<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>delete-char 1<span class="rainbow-delimiters-depth-3-face">)
    (</span>org-table-align<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">Misc utils
</span><span class="comment-delimiter">;;</span><span class="comment">
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-schedule-all-today</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Schedule all level-2 org mode tasks that have a scheduled date in
the past to today's date with the same time. If the task is not
scheduled, schedules them to todays date.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>today <span class="rainbow-delimiters-depth-5-face">(</span>im-today<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>today-time <span class="rainbow-delimiters-depth-5-face">(</span>date-to-time today<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>org-map-entries
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
       (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>entry-date <span class="rainbow-delimiters-depth-8-face">(</span>org-entry-get nil <span class="string">&quot;SCHEDULED&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">and</span>
                <span class="rainbow-delimiters-depth-8-face">(</span>org-entry-get nil <span class="string">&quot;</span><span class="default-0037">TODO</span><span class="string">&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                (</span><span class="keyword">if</span> entry-date
                    <span class="rainbow-delimiters-depth-9-face">(</span>time-less-p
                     <span class="rainbow-delimiters-depth-1-face">(</span>date-to-time entry-date<span class="rainbow-delimiters-depth-1-face">)</span>
                     today-time<span class="rainbow-delimiters-depth-9-face">)</span>
                  t<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>org-schedule nil
                         <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>entry-date<span class="rainbow-delimiters-depth-1-face">)
                                  (</span>hour-min <span class="rainbow-delimiters-depth-2-face">(</span>nth 2 <span class="rainbow-delimiters-depth-3-face">(</span>s-split <span class="string">&quot; &quot;</span> entry-date<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                             (</span>concat today <span class="string">&quot; &quot;</span> hour-min<span class="rainbow-delimiters-depth-9-face">)</span>
                           today<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="string">&quot;LEVEL=2&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-open-weekly-plan</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open weekly planning entry in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>find-buffer-visiting bullet-org<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span>
               <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">ignore-errors</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span>org-link-open
                  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-9-face">(</span>link
                    <span class="rainbow-delimiters-depth-1-face">(</span><span class="builtin">:type</span> <span class="string">&quot;fuzzy&quot;</span>
                     <span class="builtin">:path</span> ,<span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;W%s&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-V<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                     <span class="builtin">:application</span> nil <span class="builtin">:search-option</span> nil <span class="builtin">:begin</span> 0 <span class="builtin">:end</span> 0<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
               <span class="comment-delimiter">;; </span><span class="comment">Try one week earlier
</span>               <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">ignore-errors</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span>org-link-open
                  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-9-face">(</span>link
                    <span class="rainbow-delimiters-depth-1-face">(</span><span class="builtin">:type</span> <span class="string">&quot;fuzzy&quot;</span>
                     <span class="builtin">:path</span> ,<span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;W%s&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>1- <span class="rainbow-delimiters-depth-4-face">(</span>im-V<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                     <span class="builtin">:application</span> nil <span class="builtin">:search-option</span> nil <span class="builtin">:begin</span> 0 <span class="builtin">:end</span> 0<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>im-org-tree-to-indirect-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-open-monthly-plan</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open monthly planning entry in an indirect buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>find-buffer-visiting bullet-org<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span>
               <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">ignore-errors</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span>org-link-open
                  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-9-face">(</span>link
                    <span class="rainbow-delimiters-depth-1-face">(</span><span class="builtin">:type</span> <span class="string">&quot;fuzzy&quot;</span>
                     <span class="builtin">:path</span> ,<span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;%s&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>format-time-string <span class="string">&quot;%B&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                     <span class="builtin">:application</span> nil <span class="builtin">:search-option</span> nil <span class="builtin">:begin</span> 0 <span class="builtin">:end</span> 0<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
               <span class="comment-delimiter">;; </span><span class="comment">Try one month earlier
</span>               <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">ignore-errors</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span>org-link-open
                  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-9-face">(</span>link
                    <span class="rainbow-delimiters-depth-1-face">(</span><span class="builtin">:type</span> <span class="string">&quot;fuzzy&quot;</span>
                     <span class="builtin">:path</span> ,<span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;%s&quot;</span> <span class="rainbow-delimiters-depth-3-face">(</span>format-time-string <span class="string">&quot;%B&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>time-subtract <span class="rainbow-delimiters-depth-5-face">(</span>current-time<span class="rainbow-delimiters-depth-5-face">) (</span>days-to-time 30<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                     <span class="builtin">:application</span> nil <span class="builtin">:search-option</span> nil <span class="builtin">:begin</span> 0 <span class="builtin">:end</span> 0<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>im-org-tree-to-indirect-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-listen-voice-recordings</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">empv-enqueue</span> <span class="rainbow-delimiters-depth-3-face">(</span>file-expand-wildcards <span class="string">&quot;~/Audio/watch-recordings/*/*.m4a&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-bullet-org-ensure</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">if-let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>find-buffer-visiting bullet-org<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
      (</span>switch-to-buffer buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>find-file bullet-org<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-org-suggest-filename</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> path ext<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Intelligently suggest a filename for the current context.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fname <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> path <span class="rainbow-delimiters-depth-6-face">(</span>f-filename path<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span>equal
              <span class="rainbow-delimiters-depth-6-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-7-face">(</span>buffer-file-name <span class="rainbow-delimiters-depth-8-face">(</span>buffer-base-buffer <span class="rainbow-delimiters-depth-9-face">(</span>current-buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
              (</span>expand-file-name bullet-org<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
             (</span>not <span class="rainbow-delimiters-depth-6-face">(</span>s-prefix? <span class="string">&quot;bullet_&quot;</span> fname<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>f-join
         <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;bullet_%s_%s%s&quot;</span>
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">ignore-errors</span>
                   <span class="rainbow-delimiters-depth-7-face">(</span>car <span class="rainbow-delimiters-depth-8-face">(</span>s-split
                         <span class="string">&quot; &quot;</span>
                         <span class="rainbow-delimiters-depth-9-face">(</span>im-bullet-current-date<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="keyword">if</span> ext
                     <span class="rainbow-delimiters-depth-7-face">(</span>s-chop-suffix <span class="rainbow-delimiters-depth-8-face">(</span>f-ext fname<span class="rainbow-delimiters-depth-8-face">)</span> fname<span class="rainbow-delimiters-depth-7-face">)</span>
                   fname<span class="rainbow-delimiters-depth-6-face">)
                 (</span><span class="keyword">if</span> ext
                     ext
                   <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      fname<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Scratch/temporary buffers in side windows
</span>
<span class="comment-delimiter">;; </span><span class="comment">Here I define two important functions and their helpers.  The
</span><span class="comment-delimiter">;; </span><span class="comment">following functions are pretty useful for quick note taking or
</span><span class="comment-delimiter">;; </span><span class="comment">evaluating elisp. Having these buffers in a side window makes them
</span><span class="comment-delimiter">;; </span><span class="comment">immune to some window commands which is what I want.
</span>
<span class="comment-delimiter">;; </span><span class="comment">- im-display-side-scratch-buffer :: This one opens (or closes if it's open) the *scratch* buffer in a side window, on the right. This is nice for quickly evaluating elisp, taking elisp related notes.
</span><span class="comment-delimiter">;; </span><span class="comment">- im-display-side-temp-org-buffer :: This one opens (or closes if it's open) the ~temp.org~ file in a in a side window, on the right. This is nice for taking some quick notes, writing some temporary todos etc.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-buffer-visible-p</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Check if given BUFFER is visible or not.  BUFFER is a string representing the buffer name.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-3-face">(</span>eq buffer <span class="rainbow-delimiters-depth-4-face">(</span>window-buffer <span class="rainbow-delimiters-depth-5-face">(</span>selected-window<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">) (</span>get-buffer-window buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-display-buffer-other-frame</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Like `</span><span class="constant">display-buffer-other-frame</span><span class="doc">' but with some sensible defaults.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-frame-alist <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>tab-bar-lines . 0<span class="rainbow-delimiters-depth-6-face">) (</span>vertical-scroll-bars<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>tab-line-mode -1<span class="rainbow-delimiters-depth-3-face">)
    (</span>display-buffer-other-frame <span class="rainbow-delimiters-depth-4-face">(</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-display-buffer-in-side-window</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer <span class="type">&amp;optional</span> width<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Just like `display-buffer-in-side-window` but only takes a BUFFER and rest of the parameters are for my taste.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>set-window-dedicated-p
   <span class="comment-delimiter">;; </span><span class="comment">^ Setting this to nil so that `</span><span class="constant">pop-to-buffer-same-window</span><span class="comment">' calls works in this window
</span>   <span class="comment-delimiter">;;   </span><span class="comment">otherwise it'll set `</span><span class="constant">window-dedicated-p</span><span class="comment">' to `</span><span class="constant">side</span><span class="comment">' and this will cause `</span><span class="constant">pop-to-buffer-same-window</span><span class="comment">'
</span>   <span class="comment-delimiter">;;   </span><span class="comment">to open stuff in another window.
</span>   <span class="rainbow-delimiters-depth-3-face">(</span>select-window
    <span class="rainbow-delimiters-depth-4-face">(</span>display-buffer-in-side-window
     buffer
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>side . right<span class="rainbow-delimiters-depth-6-face">)
       (</span>slot . 0<span class="rainbow-delimiters-depth-6-face">)
       (</span>window-width . ,<span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> width 84<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>window-parameters
        <span class="rainbow-delimiters-depth-7-face">(</span>no-delete-other-windows . t<span class="rainbow-delimiters-depth-7-face">)
        (</span>no-other-window . nil<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   nil<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-remove-window-with-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>the-buffer-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Remove window containing given THE-BUFFER-NAME.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>mapc <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>window<span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>string-equal <span class="rainbow-delimiters-depth-6-face">(</span>buffer-name <span class="rainbow-delimiters-depth-7-face">(</span>window-buffer window<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> the-buffer-name<span class="rainbow-delimiters-depth-5-face">)
            (</span>delete-window window<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
        (</span>window-list <span class="rainbow-delimiters-depth-4-face">(</span>selected-frame<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-buffer-with-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>file-path<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Toggle FILE-PATH in a side buffer. The buffer is opened in side window so it can't be accidentaly removed.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fname <span class="rainbow-delimiters-depth-5-face">(</span>file-name-nondirectory file-path<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-buffer-visible-p fname<span class="rainbow-delimiters-depth-4-face">)
        (</span>im-remove-window-with-buffer fname<span class="rainbow-delimiters-depth-4-face">)
      (</span>im-display-buffer-in-side-window
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-window-excursion</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>find-file file-path<span class="rainbow-delimiters-depth-6-face">)
         (</span>current-buffer<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-buffer-with-name</span> <span class="rainbow-delimiters-depth-2-face">(</span>buffer-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Hide/show given BUFFER-NAME in a side window.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-buffer-visible-p buffer-name<span class="rainbow-delimiters-depth-3-face">)
      (</span>im-remove-window-with-buffer buffer-name<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-display-buffer-in-side-window <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer buffer-name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-scratch-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle the scratch buffer in side window.  The buffer is opened in side window so it can't be accidentaly removed.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-toggle-side-buffer-with-file <span class="string">&quot;~/.emacs.d/scratch.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-temp-org-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle `temp.org` in a side buffer for quick note taking.  The buffer is opened in side window so it can't be accidentaly removed.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-toggle-side-buffer-with-file temp-org<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-bullet-org-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle `bullet.org` in a side buffer for quick note taking.  The buffer is opened in side window so it can't be accidentaly removed.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-toggle-side-buffer-with-file bullet-org<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-projects-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle `projects.org` in a side buffer for quick note taking.  The buffer is opened in side window so it can't be accidentaly removed.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-toggle-side-buffer-with-file projects-org<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-messages-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle `projects.org` in a side buffer for quick note taking.  The buffer is opened in side window so it can't be accidentaly removed.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-toggle-side-buffer-with-name <span class="string">&quot;*Messages*&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-tmr-buffer</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-toggle-side-buffer-with-name <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create <span class="string">&quot;*tmr-tabulated-view*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>tmr-tabulated-mode<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="rainbow-delimiters-depth-1-face-0036">(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-side-gpt-buffer</span> <span class="rainbow-delimiters-depth-2-face-0043">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face-0043">)
  (</span>im-toggle-side-buffer-with-file gpt-org<span class="rainbow-delimiters-depth-2-face-0043">)</span><span class="rainbow-delimiters-depth-1-face-0036">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Toggle temproary buffers
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;ts&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-scratch-buffer</span>
  <span class="string">&quot;to&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-temp-org-buffer</span>
  <span class="string">&quot;th&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-bullet-org-buffer</span>
  <span class="string">&quot;tg&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-gpt-buffer</span>
  <span class="string">&quot;tp&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-projects-buffer</span>
  <span class="string">&quot;tt&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-tmr-buffer</span>
  <span class="string">&quot;tm&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-toggle-side-messages-buffer</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> org-babel extension functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-org-babel-remove-all-results</span> nil
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>goto-char 1<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>total-removed 0<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-4-face">(</span>org-babel-next-src-block<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>org-babel-remove-result<span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">setq</span> total-removed <span class="rainbow-delimiters-depth-6-face">(</span>+ total-removed 1<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;%d result blocks are removed.&quot;</span> total-removed<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Functions for easy indentation switching
</span>
<span class="comment-delimiter">;; </span><span class="comment">- http://blog.binchen.org/posts/easy-indentation-setup-in-emacs-for-web-development.html
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-setup-indent-local</span> <span class="rainbow-delimiters-depth-2-face">(</span>n<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Set indent for current buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;nHow many spaces do you want? &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> tab-width n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> c-basic-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> sh-basic-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> coffee-tab-width n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">coffeescript
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> java-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> javascript-indent-level n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">javascript-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> js-indent-level n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">js-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> web-mode-markup-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">web-mode, html tag in html file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> web-mode-css-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">web-mode, css in html file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> web-mode-code-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">web-mode, js code in html file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> css-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">css-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> typescript-indent-level n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">typescript-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> typescript-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> java-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq-local</span> go-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;OK!&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-setup-indent-global</span> <span class="rainbow-delimiters-depth-2-face">(</span>n<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Set indent globally.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;nHow many spaces do you want? &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> tab-width n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> c-basic-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> sh-basic-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> coffee-tab-width n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">coffeescript
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> java-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> javascript-indent-level n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">javascript-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> js-indent-level n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">js-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> web-mode-markup-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">web-mode, html tag in html file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> web-mode-css-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">web-mode, css in html file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> web-mode-code-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">web-mode, js code in html file
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> css-indent-offset n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">css-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> typescript-indent-level n<span class="rainbow-delimiters-depth-2-face">)</span> <span class="comment-delimiter">; </span><span class="comment">typescript-mode
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> typescript-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> java-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> go-ts-mode-indent-offset n<span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;OK!&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Current file functionality
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;fi&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-print-buffer-file-info</span>
  <span class="string">&quot;fc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-copy-current-filename</span>
  <span class="string">&quot;fr&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-rename-current-file-name-and-buffer</span>
  <span class="string">&quot;fD&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-delete-current-file</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Sometimes I just want to delete/rename/move etc. the current file
</span><span class="comment-delimiter">;; </span><span class="comment">without resorting to dired or any other file manager. Here are some
</span><span class="comment-delimiter">;; </span><span class="comment">interactive functions to do that.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Slightly modified from:
</span><span class="comment-delimiter">;; </span><span class="comment">http://steve.yegge.googlepages.com/my-dot-emacs-file
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-rename-this-file-name-and-buffer</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-rename-current-file-name-and-buffer</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-rename-current-file-name-and-buffer</span> <span class="rainbow-delimiters-depth-2-face">(</span>new-name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Renames both current buffer and file it's visiting to NEW-NAME.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;FNew name: &quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>name <span class="rainbow-delimiters-depth-5-face">(</span>buffer-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>filename <span class="rainbow-delimiters-depth-5-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>not filename<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;Buffer '</span><span class="constant">%s</span><span class="string">' is not visiting a file!&quot;</span> name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer new-name<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="warning">user-error</span> <span class="string">&quot;A buffer named '</span><span class="constant">%s</span><span class="string">' already exists!&quot;</span> new-name<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>rename-file filename new-name 1<span class="rainbow-delimiters-depth-3-face">)
    (</span>rename-buffer new-name<span class="rainbow-delimiters-depth-3-face">)
    (</span>set-visited-file-name new-name<span class="rainbow-delimiters-depth-3-face">)
    (</span>set-buffer-modified-p nil<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-delete/remove-this-file</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-delete-current-file</span><span class="rainbow-delimiters-depth-1-face">)</span>
<span class="comment-delimiter">;; </span><span class="comment">Slightly modified version of: http://www.ergoemacs.org/emacs/elisp_delete-current-file.html
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-delete-current-file</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Delete the current file and copy it's content to `</span><span class="constant">kill-ring</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>y-or-n-p <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;Do you really want to remove this: \&quot;%s\&quot;?&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>kill-new <span class="rainbow-delimiters-depth-4-face">(</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Buffer content copied to kill-ring.&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-5-face">) (</span>file-exists-p <span class="rainbow-delimiters-depth-6-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>delete-file <span class="rainbow-delimiters-depth-5-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>message <span class="string">&quot;Deleted file: 「%s」.&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>buffer-offer-save nil<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>set-buffer-modified-p nil<span class="rainbow-delimiters-depth-4-face">)
      (</span>kill-buffer <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-copy-current-file-path</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-copy-current-filename</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-copy-current-filename</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> uri<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Copy the current buffer file name to the clipboard.
If the URI is non-nil, then add file:// in front of the
file-path.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>fname <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>equal major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-mode</span><span class="rainbow-delimiters-depth-6-face">)</span>
                    default-directory
                  <span class="rainbow-delimiters-depth-6-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>filename <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> fname uri<span class="rainbow-delimiters-depth-6-face">)
                       (</span>concat <span class="string">&quot;file://&quot;</span> fname<span class="rainbow-delimiters-depth-6-face">)</span>
                     fname<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; Copied: '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-kill <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> fname <span class="rainbow-delimiters-depth-6-face">(</span>buffer-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-print-buffer-file-info</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> kill-file-path<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cl-flet</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>prop <span class="rainbow-delimiters-depth-5-face">(</span>x<span class="rainbow-delimiters-depth-5-face">) (</span>propertize x <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;systemPurpleColor&quot;</span> <span class="builtin">:slant</span> italic<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span>plum <span class="rainbow-delimiters-depth-5-face">(</span>x<span class="rainbow-delimiters-depth-5-face">) (</span>propertize x <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;systemPurpleColor&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span>bold <span class="rainbow-delimiters-depth-5-face">(</span>x<span class="rainbow-delimiters-depth-5-face">) (</span>propertize x <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bold</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span>yellow <span class="rainbow-delimiters-depth-5-face">(</span>x<span class="rainbow-delimiters-depth-5-face">) (</span>propertize <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>numberp x<span class="rainbow-delimiters-depth-7-face">) (</span>number-to-string x<span class="rainbow-delimiters-depth-7-face">)</span> x<span class="rainbow-delimiters-depth-6-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:foreground</span> <span class="string">&quot;systemOrangeColor&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
            (</span>italic <span class="rainbow-delimiters-depth-5-face">(</span>x<span class="rainbow-delimiters-depth-5-face">) (</span>propertize x <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="builtin">:slant</span> italic<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>region? <span class="rainbow-delimiters-depth-6-face">(</span>use-region-p<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>point-min <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> region? <span class="rainbow-delimiters-depth-7-face">(</span>region-beginning<span class="rainbow-delimiters-depth-7-face">) (</span>point-min<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>point-max <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> region? <span class="rainbow-delimiters-depth-7-face">(</span>region-end<span class="rainbow-delimiters-depth-7-face">) (</span>point-max<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>proj-name <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>proj-path <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-7-face">) (</span>expand-file-name <span class="string">&quot;~/&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>fpath <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-7-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-7-face">) (</span>buffer-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>fpath-pretty <span class="rainbow-delimiters-depth-6-face">(</span>string-replace <span class="rainbow-delimiters-depth-7-face">(</span>expand-file-name <span class="string">&quot;~&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> <span class="string">&quot;~&quot;</span> fpath<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>in-git? <span class="rainbow-delimiters-depth-6-face">(</span>file-exists-p <span class="rainbow-delimiters-depth-7-face">(</span>expand-file-name <span class="string">&quot;.git&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>text
            <span class="rainbow-delimiters-depth-6-face">(</span>format
             <span class="string">&quot;[%s] %s\n%s\n%s\n%s\n%s%s\n%s\n%s%s%s%s&quot;</span>
             <span class="rainbow-delimiters-depth-7-face">(</span>bold proj-name<span class="rainbow-delimiters-depth-7-face">)
             (</span>plum <span class="rainbow-delimiters-depth-8-face">(</span>string-remove-prefix proj-path fpath<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">if</span> region? <span class="string">&quot;*region*&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>format <span class="string">&quot;%s%s&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> kill-file-path <span class="rainbow-delimiters-depth-9-face">(</span>bold <span class="string">&quot;Copied: &quot;</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>italic fpath-pretty<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>format <span class="string">&quot;%s: %s&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>prop <span class="string">&quot;- Size&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>yellow <span class="rainbow-delimiters-depth-9-face">(</span>im-human-readable-size <span class="rainbow-delimiters-depth-1-face">(</span>- point-max point-min<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>format
              <span class="string">&quot;%s: %s, %s: %s, %s: %s\n&quot;</span>
              <span class="rainbow-delimiters-depth-8-face">(</span>prop <span class="string">&quot;- Lines&quot;</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>yellow <span class="rainbow-delimiters-depth-9-face">(</span>count-lines point-min point-max<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>prop <span class="string">&quot;Words&quot;</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>yellow <span class="rainbow-delimiters-depth-9-face">(</span>length <span class="rainbow-delimiters-depth-1-face">(</span>split-string <span class="rainbow-delimiters-depth-2-face">(</span>buffer-substring-no-properties point-min point-max<span class="rainbow-delimiters-depth-2-face">)</span> <span class="string">&quot;\\W+&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">omit-nulls</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>prop <span class="string">&quot;Chars&quot;</span><span class="rainbow-delimiters-depth-8-face">)
              (</span>yellow <span class="rainbow-delimiters-depth-9-face">(</span>- point-max point-min<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>format <span class="string">&quot;%s: %s&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>prop <span class="string">&quot;- Major Mode&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span> major-mode<span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">if</span> in-git? <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;%s: %s&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>prop <span class="string">&quot;- Current branch&quot;</span><span class="rainbow-delimiters-depth-9-face">) (</span>bold <span class="rainbow-delimiters-depth-1-face">(</span>lab-git-current-branch<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>concat <span class="string">&quot;\n&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>im-read-time<span class="rainbow-delimiters-depth-8-face">)</span> <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-7-face">)
             (</span><span class="keyword">if</span> in-git?
                 <span class="rainbow-delimiters-depth-8-face">(</span>concat <span class="rainbow-delimiters-depth-9-face">(</span>bold <span class="string">&quot;\nGit Status: \n&quot;</span><span class="rainbow-delimiters-depth-9-face">) (</span>ansi-color-apply <span class="rainbow-delimiters-depth-1-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;git -c color.ui=always status %s&quot;</span> fpath<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
               (</span>italic <span class="string">&quot;\n Not in a git repository.&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
             <span class="string">&quot;\n&quot;</span>
             <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> in-git?
                 <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>diff <span class="rainbow-delimiters-depth-2-face">(</span>ansi-color-apply <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;git diff --color=always %s&quot;</span> fpath<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                        (</span>len <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-some-&gt;&gt;</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-split <span class="string">&quot;\n&quot;</span> diff<span class="rainbow-delimiters-depth-4-face">) (</span>car<span class="rainbow-delimiters-depth-4-face">) (</span>length<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span> 0<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                   (</span>concat
                    <span class="string">&quot;\n&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>s-repeat len <span class="string">&quot;─&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span> <span class="string">&quot;\n\n&quot;</span>
                    diff<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
               <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-peek
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()
         (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-7-face">(</span>get-buffer-create <span class="string">&quot;*im-buffer-info*&quot;</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>page-break-lines-mode<span class="rainbow-delimiters-depth-7-face">)
           (</span>erase-buffer<span class="rainbow-delimiters-depth-7-face">)
           (</span>insert <span class="rainbow-delimiters-depth-8-face">(</span>s-trim text<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>current-buffer<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> kill-file-path
        <span class="rainbow-delimiters-depth-5-face">(</span>im-kill fpath-pretty<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> xah-open-file-at-cursor
</span>
<span class="comment-delimiter">;; </span><span class="comment">This is better than =find-file-at-point= because it takes line
</span><span class="comment-delimiter">;; </span><span class="comment">numbers etc. into account.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">xah-open-file-at-cursor</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Open the file path under cursor.
If there is text selection, uses the text selection for path.  If
the path starts with “http://”, open the URL in browser.  Input
path can be {relative, full path, URL}.

Path may have a trailing “:‹n›” that indicates line number, or
“:‹n›:‹m›” with line and column number.  If so, jump to that line
number.  If path does not have a file extension, automatically
try with “.el” for elisp files.  This command is similar to
`</span><span class="constant">find-file-at-point</span><span class="doc">' but without prompting for confirmation.

URL `</span><span class="constant">http://ergoemacs.org/emacs/emacs_open_file_path_fast.html</span><span class="doc">'
Version 2020-10-17&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span>
         <span class="rainbow-delimiters-depth-4-face">(</span>$inputStr
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>use-region-p<span class="rainbow-delimiters-depth-6-face">)
              (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>region-beginning<span class="rainbow-delimiters-depth-7-face">) (</span>region-end<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span>$p0 $p1 $p2
                      <span class="comment-delimiter">;; </span><span class="comment">chars that are likely to be delimiters of
</span>                      <span class="comment-delimiter">;; </span><span class="comment">file path or url, e.g. whitespace, comma. The
</span>                      <span class="comment-delimiter">;; </span><span class="comment">colon is a problem. cuz it's in url, but not
</span>                      <span class="comment-delimiter">;; </span><span class="comment">in file name. Don't want to use just space as
</span>                      <span class="comment-delimiter">;; </span><span class="comment">delimiter because path or url are often in
</span>                      <span class="comment-delimiter">;; </span><span class="comment">brackets or quotes as in markdown or html
</span>                      <span class="rainbow-delimiters-depth-8-face">(</span>$pathStops <span class="string">&quot;^  \t\n\&quot;`'‘’“”|[]{}「」&lt;&gt;〔〕〈〉《》【】〖〗«»‹›❮❯❬❭〘〙·。\\&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">setq</span> $p0 <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>skip-chars-backward $pathStops<span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">setq</span> $p1 <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>goto-char $p0<span class="rainbow-delimiters-depth-7-face">)
              (</span>skip-chars-forward $pathStops<span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">setq</span> $p2 <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>goto-char $p0<span class="rainbow-delimiters-depth-7-face">)
              (</span>buffer-substring-no-properties $p1 $p2<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>$path
          <span class="rainbow-delimiters-depth-5-face">(</span>replace-regexp-in-string
           <span class="string">&quot;^file:///&quot; &quot;/&quot;</span>
           <span class="rainbow-delimiters-depth-6-face">(</span>replace-regexp-in-string
            <span class="string">&quot;:\\'&quot; &quot;&quot;</span> $inputStr<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>string-match-p <span class="string">&quot;\\`https?://&quot;</span> $path<span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>fboundp <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xahsite-url-to-filepath</span><span class="rainbow-delimiters-depth-5-face">)
            (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>$x <span class="rainbow-delimiters-depth-8-face">(</span>xahsite-url-to-filepath $path<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
              (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>string-match <span class="string">&quot;^http&quot;</span> $x <span class="rainbow-delimiters-depth-7-face">)
                  (</span>browse-url $x<span class="rainbow-delimiters-depth-7-face">)
                (</span>find-file $x<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="keyword">progn</span> <span class="rainbow-delimiters-depth-6-face">(</span>browse-url $path<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">progn</span> <span class="comment-delimiter">; </span><span class="comment">not starting “http://”
</span>        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>string-match <span class="string">&quot;#&quot;</span> $path <span class="rainbow-delimiters-depth-6-face">)
            (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span>
                  <span class="rainbow-delimiters-depth-8-face">(</span> $fpath <span class="rainbow-delimiters-depth-9-face">(</span>substring $path 0 <span class="rainbow-delimiters-depth-1-face">(</span>match-beginning 0<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                  (</span> $fractPart <span class="rainbow-delimiters-depth-9-face">(</span>substring $path <span class="rainbow-delimiters-depth-1-face">(</span>1+ <span class="rainbow-delimiters-depth-2-face">(</span>match-beginning 0<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>file-exists-p $fpath<span class="rainbow-delimiters-depth-8-face">)
                  (</span><span class="keyword">progn</span>
                    <span class="rainbow-delimiters-depth-9-face">(</span>find-file $fpath<span class="rainbow-delimiters-depth-9-face">)
                    (</span>goto-char 1<span class="rainbow-delimiters-depth-9-face">)
                    (</span>search-forward $fractPart <span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-9-face">(</span>y-or-n-p <span class="rainbow-delimiters-depth-1-face">(</span>format <span class="string">&quot;file no exist: 「%s」. Create?&quot;</span> $fpath<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                  (</span>find-file $fpath<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>string-match <span class="string">&quot;^\\`</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.+?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">:[0-9]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?\\'&quot;</span> $path<span class="rainbow-delimiters-depth-7-face">)
              (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-8-face">(</span>
                    <span class="rainbow-delimiters-depth-9-face">(</span>$fpath <span class="rainbow-delimiters-depth-1-face">(</span>match-string 1 $path<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                    (</span>$line-num <span class="rainbow-delimiters-depth-1-face">(</span>string-to-number <span class="rainbow-delimiters-depth-2-face">(</span>match-string 2 $path<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>file-exists-p $fpath<span class="rainbow-delimiters-depth-9-face">)
                    (</span><span class="keyword">progn</span>
                      <span class="rainbow-delimiters-depth-1-face">(</span>find-file $fpath<span class="rainbow-delimiters-depth-1-face">)
                      (</span>goto-char 1<span class="rainbow-delimiters-depth-1-face">)
                      (</span>forward-line <span class="rainbow-delimiters-depth-2-face">(</span>1- $line-num<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-1-face">(</span>y-or-n-p <span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;file no exist: 「%s」. Create?&quot;</span> $fpath<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                    (</span>find-file $fpath<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>file-exists-p $path<span class="rainbow-delimiters-depth-8-face">)
                (</span><span class="keyword">progn</span> <span class="comment-delimiter">; </span><span class="comment">open f.ts instead of f.js
</span>                  <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>$ext <span class="rainbow-delimiters-depth-3-face">(</span>file-name-extension $path<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                        (</span>$fnamecore <span class="rainbow-delimiters-depth-3-face">(</span>file-name-sans-extension $path<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-3-face">(</span>string-equal $ext <span class="string">&quot;js&quot;</span><span class="rainbow-delimiters-depth-3-face">)
                             (</span>file-exists-p <span class="rainbow-delimiters-depth-4-face">(</span>concat $fnamecore <span class="string">&quot;.ts&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                        (</span>find-file <span class="rainbow-delimiters-depth-3-face">(</span>concat $fnamecore <span class="string">&quot;.ts&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                      (</span>find-file $path<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
              (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>file-exists-p <span class="rainbow-delimiters-depth-1-face">(</span>concat $path <span class="string">&quot;.el&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                  (</span>find-file <span class="rainbow-delimiters-depth-1-face">(</span>concat $path <span class="string">&quot;.el&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-1-face">(</span>y-or-n-p <span class="rainbow-delimiters-depth-2-face">(</span>format <span class="string">&quot;file no exist: 「%s」. Create?&quot;</span> $path<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                  (</span>find-file $path <span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>define-key evil-normal-state-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;gf&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">xah-open-file-at-cursor</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> xah-{escape,unescape}-quotes
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">xah-escape-quotes</span> <span class="rainbow-delimiters-depth-2-face">(</span>@begin @end<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Replace 「\&quot;」 by 「\\\&quot;」 in current line or text selection.
See also: `</span><span class="constant">xah-unescape-quotes</span><span class="doc">'

URL `</span><span class="constant">http://ergoemacs.org/emacs/elisp_escape_quotes.html</span><span class="doc">'
Version 2017-01-11&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>use-region-p<span class="rainbow-delimiters-depth-4-face">)
       (</span>list <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">) (</span>region-end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>list <span class="rainbow-delimiters-depth-5-face">(</span>line-beginning-position<span class="rainbow-delimiters-depth-5-face">) (</span>line-end-position<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>narrow-to-region @begin @end<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span>search-forward <span class="string">&quot;\&quot;&quot;</span> nil t<span class="rainbow-delimiters-depth-5-face">)
        (</span>replace-match <span class="string">&quot;\\\&quot;&quot; &quot;FIXEDCASE&quot; &quot;LITERAL&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">xah-unescape-quotes</span> <span class="rainbow-delimiters-depth-2-face">(</span>@begin @end<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Replace  「\\\&quot;」 by 「\&quot;」 in current line or text selection.
See also: `</span><span class="constant">xah-escape-quotes</span><span class="doc">'

URL `</span><span class="constant">http://ergoemacs.org/emacs/elisp_escape_quotes.html</span><span class="doc">'
Version 2017-01-11&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>use-region-p<span class="rainbow-delimiters-depth-4-face">)
       (</span>list <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">) (</span>region-end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>list <span class="rainbow-delimiters-depth-5-face">(</span>line-beginning-position<span class="rainbow-delimiters-depth-5-face">) (</span>line-end-position<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>narrow-to-region @begin @end<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">while</span> <span class="rainbow-delimiters-depth-5-face">(</span>search-forward <span class="string">&quot;\\\&quot;&quot;</span> nil t<span class="rainbow-delimiters-depth-5-face">)
        (</span>replace-match <span class="string">&quot;\&quot;&quot; &quot;FIXEDCASE&quot; &quot;LITERAL&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>visual<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;ze&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xah-escape-quotes</span>
  <span class="string">&quot;zE&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xah-unescape-quotes</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> eksisozluk gundem
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-eksi-gundem-sirali</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Eksi gundemini entry sayisina gore sirala ve `</span><span class="constant">completing-read</span><span class="doc">' yap.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>results <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
                  <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">with-temp-buffer</span>
                    <span class="rainbow-delimiters-depth-7-face">(</span>insert
                     <span class="rainbow-delimiters-depth-8-face">(</span>shell-command-to-string <span class="string">&quot;curl --silent https://eksisozluk.com/basliklar/gundem | grep '</span><span class="constant">?a=popular</span><span class="string">' | sed -E 's/[ ]*href=\&quot;(.*)\&quot;&gt;(.*) &lt;small&gt;(.*)&lt;\\/small&gt;(.*)/(\\3) \\2|||\\1/' | sort -V -r | uniq&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span>goto-char <span class="rainbow-delimiters-depth-8-face">(</span>point-min<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span>xml-parse-string<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span>s-trim<span class="rainbow-delimiters-depth-6-face">)
                  (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-split <span class="string">&quot;|||&quot;</span> it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                  (</span><span class="keyword">--map</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-7-face">(</span>,<span class="rainbow-delimiters-depth-8-face">(</span>car it<span class="rainbow-delimiters-depth-8-face">)</span> . ,<span class="rainbow-delimiters-depth-8-face">(</span>cadr it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">-&gt;&gt;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>im-completing-read
      <span class="string">&quot;Baslik: &quot;</span> results
      <span class="builtin">:sort?</span> nil
      <span class="builtin">:formatter</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>cdr<span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;https://eksisozluk.com/%s&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>browse-url<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> insert uuid
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-uuid</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Generate a UUID.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>s-trim <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="string">&quot;uuidgen&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-insert-uuid</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Insert UUID.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>insert <span class="rainbow-delimiters-depth-3-face">(</span>im-uuid<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-shell-command
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar-local</span> <span class="variable-name">im-shell-command-mode-command</span> nil
  <span class="doc">&quot;Current shell command that belongs to the buffer.&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">define-minor-mode</span> <span class="function-name">im-shell-command-mode</span>
  <span class="doc">&quot;Shell command mode.&quot;</span>
  <span class="builtin">:lighter</span> <span class="string">&quot;iscm&quot;</span>
  <span class="builtin">:keymap</span> <span class="rainbow-delimiters-depth-2-face">(</span>make-sparse-keymap<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> im-shell-command-mode-map
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;gr&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-shell-command-mode-rerun-command</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-shell-command-mode-rerun-command</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Re-run the shell command.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-shell-command</span> im-shell-command-mode-command<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>


<span class="comment-delimiter">;; </span><span class="comment">In normal mode, hitting ! will display im-shell-command but in
</span><span class="comment-delimiter">;; </span><span class="comment">visual mode hitting ! will open evil's default evil-shell-command
</span><span class="comment-delimiter">;; </span><span class="comment">on selected region.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">evil-define-key</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">global</span> <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;!&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-shell-command</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-shell-smart-history</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">-&gt;&gt;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">with-temp-buffer</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>insert-file-contents eshell-history-file-name<span class="rainbow-delimiters-depth-4-face">)
     (</span>buffer-string<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   s-trim
   <span class="rainbow-delimiters-depth-3-face">(</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;:&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)
              (</span>s-replace-regexp <span class="string">&quot;^: [0-9:]+;&quot; &quot;&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span>
            it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="keyword">--filter</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-5-face">(</span>not <span class="rainbow-delimiters-depth-6-face">(</span>s-blank? it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                  (</span>&gt; <span class="rainbow-delimiters-depth-6-face">(</span>length it<span class="rainbow-delimiters-depth-6-face">)</span> 5<span class="rainbow-delimiters-depth-5-face">)
                  (</span>not <span class="rainbow-delimiters-depth-6-face">(</span>s-matches? <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">ls</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">pwd</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">exit</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">cd</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">echo</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                  (</span>not <span class="rainbow-delimiters-depth-6-face">(</span>s-suffix? <span class="string">&quot;\\&quot;</span> it<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>reverse<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-shell-command</span>
    <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span>
     command
     args
     eat
     env
     async
     switch
     <span class="rainbow-delimiters-depth-3-face">(</span>buffer-name <span class="rainbow-delimiters-depth-4-face">(</span>concat <span class="string">&quot;*&quot;</span> command <span class="string">&quot;*&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>on-start <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>on-finish <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
     (</span>on-fail <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run given shell COMMAND and redirect output to given BUFFER-NAME.
This is a wrapper around `</span><span class="constant">start-process-shell-command</span><span class="doc">' that adds
support for ANSI term colors and some syntactic convenience.

If ARGS is non-nil list, then use `</span><span class="constant">start-process</span><span class="doc">' with command as
COMMAND and args as ARGS.

ENV is a list of environment variables and values in the
following form:

    '(\&quot;DISPLAY=\&quot; \&quot;X=5\&quot; \&quot;Y=6\&quot;)

If EAT is non nil, use eat shell to display output which handles
terminal outputs way better.  ARGS must be a list.

When called interactively, asks for a command to run (with eshell
completion).

In BUFFER-NAME, `</span><span class="constant">im-shell-command-mode</span><span class="doc">' is activated and you can
use `</span><span class="constant">im-shell-command-mode-rerun-command</span><span class="doc">' or \&quot;gr\&quot; to replay the
command.

If EAT is non-nil and BUFFER-NAME does not contain \&quot;*...*\&quot;, the
asterisks will be added automatically by eat.

Returns process buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>command <span class="rainbow-delimiters-depth-6-face">(</span>im-completing-read <span class="string">&quot;Command: &quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>im-shell-smart-history<span class="rainbow-delimiters-depth-7-face">)</span> <span class="builtin">:sort?</span> nil<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>list
      <span class="builtin">:command</span> command
      <span class="builtin">:switch</span> t
      <span class="builtin">:on-finish</span>
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>msg <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;&gt;&gt; \&quot;%s\&quot; finished successfully.&quot;</span> command<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span>message msg<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>not <span class="rainbow-delimiters-depth-9-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
            (</span>alert msg<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="builtin">:on-fail</span>
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>msg <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;&gt;&gt; \&quot;%s\&quot; FAILED.&quot;</span> command<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
          (</span>message msg<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>not <span class="rainbow-delimiters-depth-9-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
            (</span>alert msg<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>process-environment <span class="rainbow-delimiters-depth-5-face">(</span>append env process-environment<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>proc
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> eat
              <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">progn</span>
                <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>buffer <span class="rainbow-delimiters-depth-1-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eat-make</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">-&gt;&gt;</span>
                                                 buffer-name
                                                 <span class="rainbow-delimiters-depth-3-face">(</span>s-chop-prefix <span class="string">&quot;*&quot;</span><span class="rainbow-delimiters-depth-3-face">)
                                                 (</span>s-chop-suffix <span class="string">&quot;*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
                                     command nil args<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                  (</span><span class="keyword">setq</span> buffer-name <span class="rainbow-delimiters-depth-9-face">(</span>buffer-name buffer<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                  (</span>get-buffer-process buffer<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span><span class="keyword">if</span> args
                <span class="rainbow-delimiters-depth-7-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">start-process</span> command buffer-name command args<span class="rainbow-delimiters-depth-7-face">)
              (</span>start-process-shell-command command buffer-name command<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>proc-out <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>fn <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>resolve reject<span class="rainbow-delimiters-depth-7-face">)
                (</span>set-process-sentinel
                 proc
                 <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-9-face">(</span>p e<span class="rainbow-delimiters-depth-9-face">)
                   (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-1-face">(</span>get-buffer-create buffer-name<span class="rainbow-delimiters-depth-1-face">)
                     (</span>read-only-mode -1<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                   (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>exit-code <span class="rainbow-delimiters-depth-3-face">(</span>process-exit-status p<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                     (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-2-face">(</span>= 0 exit-code<span class="rainbow-delimiters-depth-2-face">)
                         (</span>funcall resolve proc-out<span class="rainbow-delimiters-depth-2-face">)
                       (</span>funcall reject exit-code<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">prog1</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> async
                 <span class="rainbow-delimiters-depth-6-face">(</span>promise-new fn<span class="rainbow-delimiters-depth-6-face">)
               (</span>funcall fn on-finish on-fail<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">unless</span> eat
          <span class="rainbow-delimiters-depth-6-face">(</span>set-process-filter
           proc
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>proc str<span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">with-current-buffer</span> buffer-name
               <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">setq</span> proc-out <span class="rainbow-delimiters-depth-1-face">(</span>concat proc-out str<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
               (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-1-face">(</span><span class="rainbow-delimiters-depth-2-face">(</span>inhibit-read-only t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
                 (</span><span class="keyword">save-excursion</span>
                   <span class="rainbow-delimiters-depth-2-face">(</span>goto-char <span class="rainbow-delimiters-depth-3-face">(</span>point-max<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
                   (</span>insert <span class="rainbow-delimiters-depth-3-face">(</span>ansi-color-apply <span class="rainbow-delimiters-depth-4-face">(</span>s-replace <span class="string">&quot;&quot; &quot;\n&quot;</span> str<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">with-current-buffer</span> buffer-name
          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">unless</span> eat
            <span class="rainbow-delimiters-depth-7-face">(</span>prog-mode<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>im-shell-command-mode 1<span class="rainbow-delimiters-depth-6-face">)
          (</span>evil-normal-state<span class="rainbow-delimiters-depth-6-face">)
          (</span><span class="keyword">setq-local</span>
           im-shell-command-mode-command
           <span class="rainbow-delimiters-depth-7-face">(</span>list
            <span class="builtin">:command</span> command
            <span class="builtin">:args</span> args
            <span class="builtin">:buffer-name</span> buffer-name
            <span class="builtin">:on-start</span> on-start
            <span class="builtin">:on-finish</span> on-finish
            <span class="builtin">:on-fail</span> on-fail<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>funcall on-start<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">when</span> switch
          <span class="rainbow-delimiters-depth-6-face">(</span>switch-to-buffer buffer-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>get-buffer buffer-name<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Password manager
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-password-all</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Get list of all passwords and their properties from `</span><span class="constant">passwords.org</span><span class="doc">'.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-current-buffer</span> <span class="string">&quot;passwords.org&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
       (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>link <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>match <span class="rainbow-delimiters-depth-8-face">(</span>org-entry-get nil <span class="string">&quot;MATCH&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>header-link <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">save-excursion</span> <span class="rainbow-delimiters-depth-9-face">(</span>forward-char 5<span class="rainbow-delimiters-depth-9-face">) (</span>org-element-context<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>title <span class="rainbow-delimiters-depth-8-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>props <span class="rainbow-delimiters-depth-8-face">(</span>im-alist-to-plist <span class="rainbow-delimiters-depth-9-face">(</span>org-entry-properties<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span>plist-get props <span class="builtin">:username</span><span class="rainbow-delimiters-depth-7-face">)</span>
           <span class="comment-delimiter">;; </span><span class="comment">^ A password entry should contain at least the :username: prop
</span>           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>eq <span class="rainbow-delimiters-depth-9-face">(</span>org-element-type header-link<span class="rainbow-delimiters-depth-9-face">)</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">link</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">setq</span> link <span class="rainbow-delimiters-depth-9-face">(</span>org-element-property <span class="builtin">:raw-link</span> header-link<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span><span class="keyword">save-excursion</span>
               <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">setq</span> title
                     <span class="rainbow-delimiters-depth-1-face">(</span>buffer-substring-no-properties
                      <span class="rainbow-delimiters-depth-2-face">(</span>org-element-property <span class="builtin">:contents-begin</span> header-link<span class="rainbow-delimiters-depth-2-face">)
                      (</span>org-element-property <span class="builtin">:contents-end</span> header-link<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
           <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="builtin">:title</span> ,title <span class="builtin">:link</span> ,link ,@props<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>org-map-entries<span class="rainbow-delimiters-depth-4-face">)
     (</span>-filter <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">identity</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> Better matching algorithm Check if full string matches any,
</span><span class="comment-delimiter">;; </span><span class="comment">then check if host matches. Return full string match only if it
</span><span class="comment-delimiter">;; </span><span class="comment">exists. Also check if toplevel domain matches, if it does not match
</span><span class="comment-delimiter">;; </span><span class="comment">fully
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-password-find-for</span> <span class="rainbow-delimiters-depth-2-face">(</span>url<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return matching accounts for given URL.
If there are multiple accounts registered for one entry, then
list them as seperate entries.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>urlobj <span class="rainbow-delimiters-depth-5-face">(</span>url-generic-parse-url url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> url <span class="rainbow-delimiters-depth-4-face">(</span>url-host urlobj<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>port <span class="rainbow-delimiters-depth-6-face">(</span>url-port-if-non-default urlobj<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">setq</span> url <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s:%s&quot;</span> url port<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>candidates <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--filter</span>
                      <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-9-face">(</span>s-match <span class="rainbow-delimiters-depth-1-face">(</span>plist-get it <span class="builtin">:match</span><span class="rainbow-delimiters-depth-1-face">)</span> url<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                                (</span>s-contains? url <span class="rainbow-delimiters-depth-9-face">(</span>plist-get it <span class="builtin">:link</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
                        it<span class="rainbow-delimiters-depth-6-face">)
                      (</span>im-password-all<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>-flatten-n
     1
     <span class="rainbow-delimiters-depth-4-face">(</span>-map <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>info<span class="rainbow-delimiters-depth-6-face">)
             (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>unames <span class="rainbow-delimiters-depth-9-face">(</span>s-split <span class="string">&quot; &quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>plist-get info <span class="builtin">:username</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                   (</span>pwds <span class="rainbow-delimiters-depth-9-face">(</span>s-split <span class="string">&quot; &quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>plist-get info <span class="builtin">:password</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
               (</span>-zip-pair  <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;%s - %s&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>plist-get info <span class="builtin">:title</span><span class="rainbow-delimiters-depth-1-face">)</span> it<span class="rainbow-delimiters-depth-9-face">)</span> unames<span class="rainbow-delimiters-depth-8-face">)
                           (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-9-face">(</span>list <span class="builtin">:info</span> info <span class="builtin">:acc</span> it<span class="rainbow-delimiters-depth-9-face">)
                                  (</span>-zip-pair unames pwds<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
           candidates<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-password-qutebrowser</span> <span class="rainbow-delimiters-depth-2-face">(</span>url fifo<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find credentials for currently open link in Qutebrowser and fill.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>candidates <span class="rainbow-delimiters-depth-5-face">(</span>im-password-find-for url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>result <span class="rainbow-delimiters-depth-5-face">(</span>plist-get
                  <span class="rainbow-delimiters-depth-6-face">(</span>alist-get <span class="rainbow-delimiters-depth-7-face">(</span>completing-read <span class="string">&quot;Select account: &quot;</span> candidates<span class="rainbow-delimiters-depth-7-face">)</span> candidates nil nil <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">equal</span><span class="rainbow-delimiters-depth-6-face">)</span> <span class="builtin">:acc</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>username <span class="rainbow-delimiters-depth-5-face">(</span>car result<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>password <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-some-&gt;&gt;</span> <span class="rainbow-delimiters-depth-6-face">(</span>cdr result<span class="rainbow-delimiters-depth-6-face">)
                     (</span>s-replace <span class="string">&quot;\&quot;&quot; &quot;\\\&quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                     (</span>s-replace <span class="string">&quot;'&quot; &quot;\\'&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> username password<span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">pcase</span> <span class="rainbow-delimiters-depth-5-face">(</span>completing-read <span class="string">&quot;Method: &quot;</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;Fill all with TAB&quot; &quot;Fill username&quot; &quot;Fill password&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Fill all with TAB&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>write-region <span class="string">&quot;mode-enter insert\n&quot;</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>write-region <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;fake-key %s\n&quot;</span> username<span class="rainbow-delimiters-depth-7-face">)</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>write-region <span class="string">&quot;fake-key &lt;Tab&gt;\n&quot;</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>write-region <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;fake-key %s\n&quot;</span> password<span class="rainbow-delimiters-depth-7-face">)</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Fill username&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>write-region <span class="string">&quot;mode-enter insert\n&quot;</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>write-region <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;fake-key %s\n&quot;</span> username<span class="rainbow-delimiters-depth-7-face">)</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Fill password&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>write-region <span class="string">&quot;mode-enter insert\n&quot;</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>write-region <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;fake-key %s\n&quot;</span> password<span class="rainbow-delimiters-depth-7-face">)</span> nil fifo <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">append</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> Add other actions:
</span><span class="comment-delimiter">;; </span><span class="comment">- Fill with tab
</span><span class="comment-delimiter">;; </span><span class="comment">- Copy username/password etc.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-password-act</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">and-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>passwords <span class="rainbow-delimiters-depth-5-face">(</span>im-password-all<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
             (</span>candidates <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>cons <span class="rainbow-delimiters-depth-7-face">(</span>plist-get it <span class="builtin">:title</span><span class="rainbow-delimiters-depth-7-face">)</span> it<span class="rainbow-delimiters-depth-6-face">)</span> passwords<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
             (</span>selected <span class="rainbow-delimiters-depth-5-face">(</span>im-alist-completing-read <span class="string">&quot;Select: &quot;</span> candidates<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let-plist</span> selected
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">pcase</span> <span class="rainbow-delimiters-depth-5-face">(</span>completing-read
              <span class="string">&quot;Action: &quot;</span>
              <span class="rainbow-delimiters-depth-6-face">(</span>list <span class="string">&quot;Copy as username:password&quot;
                    &quot;Copy as PostgreSQL connection string&quot;
                    &quot;Copy as SQL src block header args&quot;
                    &quot;Copy as Couchbase (CBC, N1QL) src block header args&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Copy as username:password&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>kill-new
          <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;%s:%s&quot;</span> .username .password<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Copy as PostgreSQL connection string&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>kill-new
          <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;postgresql://%s:%s@%s:%s/%s&quot;</span>
                  .username .password .host .port .db<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Copy as SQL src block header args&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>kill-new
          <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;:engine postgresql :dbhost %s :dbuser %s :dbpassword %s :database %s :dbport %s&quot;</span>
                  .host .username .password .db .port<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="string">&quot;Copy as Couchbase (CBC, N1QL) src block header args&quot;</span>
         <span class="rainbow-delimiters-depth-6-face">(</span>kill-new
          <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;:host %s :username %s :password %s&quot;</span>
                  .host .username .password<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Kubernetes
</span>
<span class="comment-delimiter">;; </span><span class="comment">My main use case is drop into a shell of a pod. The code below
</span><span class="comment-delimiter">;; </span><span class="comment">makes it quite easy. Use ~im-kube-select-pod~ to select a pod and
</span><span class="comment-delimiter">;; </span><span class="comment">do some actions on it.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-kube--current-context</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span>s-trim <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="string">&quot;kubectl config current-context&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-use-context</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:cmd</span> <span class="string">&quot;kubectl config get-contexts --output=name&quot;</span>
   <span class="builtin">:keep-order</span> t
   <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;Select context (current=%s): &quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-kube--current-context<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;kubectl config use-context '</span><span class="constant">%s</span><span class="string">'&quot;</span> it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-kube-get-context-server-ip</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-kube-get-cluster-server-ip</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-kube-get-cluster-server-ip</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:cmd</span> <span class="string">&quot;kubectl config get-clusters&quot;</span>
   <span class="builtin">:drop</span> 1
   <span class="builtin">:keep-order</span> t
   <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;Select context (leave blank to use %s): &quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-kube--current-context<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:do</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-blank? it<span class="rainbow-delimiters-depth-5-face">) (</span>im-kube--current-context<span class="rainbow-delimiters-depth-5-face">)</span> it<span class="rainbow-delimiters-depth-4-face">)
    (</span>format <span class="string">&quot;kubectl config view -o jsonpath=\&quot;{.clusters[?(@.name == '</span><span class="constant">%s</span><span class="string">')].cluster.server}\&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
    shell-command-to-string
    im-kill<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-select-pod</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> switch-context<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Select a pod and act on it.
If SWITCH-CONTEXT is non nil, switch to another context before
selecting a pod.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> switch-context
    <span class="rainbow-delimiters-depth-3-face">(</span>im-kube-use-context<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:cmd</span> <span class="string">&quot;kubectl get pods --all-namespaces&quot;</span>
   <span class="builtin">:drop</span> 1
   <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;Select a pod from '</span><span class="constant">%s</span><span class="string">': &quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-kube--current-context<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:keep-order</span> t
   <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>info <span class="rainbow-delimiters-depth-6-face">(</span>s-split <span class="string">&quot; &quot;</span> it t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>im-kube-pod--act <span class="rainbow-delimiters-depth-5-face">(</span>list <span class="builtin">:name</span> <span class="rainbow-delimiters-depth-6-face">(</span>nth 1 info<span class="rainbow-delimiters-depth-6-face">)</span> <span class="builtin">:namespace</span> <span class="rainbow-delimiters-depth-6-face">(</span>nth 0 info<span class="rainbow-delimiters-depth-6-face">)</span> <span class="builtin">:context</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-kube--current-context<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar-local</span> <span class="variable-name">im-kube--current-context</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-kube-context-overview</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> context<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Same thing as `</span><span class="constant">im-kube-select-pod</span><span class="doc">' but in friendlier vtable form.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">when</span> current-prefix-arg
         <span class="rainbow-delimiters-depth-5-face">(</span>im-kube-use-context<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
       (</span>list <span class="rainbow-delimiters-depth-5-face">(</span>im-kube--current-context<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">vtable</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;*im-kube: %s*&quot;</span> context<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Make a major mode out of this
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">setq</span> im-kube--current-context context<span class="rainbow-delimiters-depth-3-face">)
    (</span>erase-buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>make-vtable
     <span class="builtin">:row-colors</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-vtable--pretty-colors<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:column-colors</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-vtable--pretty-colors<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:columns</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;Namespace&quot; &quot;Name&quot;</span>
                <span class="rainbow-delimiters-depth-5-face">(</span><span class="builtin">:name</span> <span class="string">&quot;Ready&quot;</span> <span class="builtin">:min-width</span> 6<span class="rainbow-delimiters-depth-5-face">)
                (</span><span class="builtin">:name</span> <span class="string">&quot;Status&quot;</span>
                 <span class="builtin">:formatter</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>value<span class="rainbow-delimiters-depth-7-face">)
                              (</span><span class="keyword">cond</span>
                               <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>equal value <span class="string">&quot;Running&quot;</span><span class="rainbow-delimiters-depth-9-face">) (</span>im-tbp--color <span class="string">&quot;green&quot;</span> value<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                               (</span><span class="rainbow-delimiters-depth-9-face">(</span>equal value <span class="string">&quot;Running&quot;</span><span class="rainbow-delimiters-depth-9-face">) (</span>im-tbp--color <span class="string">&quot;green&quot;</span> value<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                               (</span><span class="rainbow-delimiters-depth-9-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="string">&quot;Error&quot; &quot;CrashLoopBackOff&quot; &quot;NotReady&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span> value<span class="rainbow-delimiters-depth-9-face">) (</span>im-tbp--color <span class="string">&quot;red&quot;</span> value<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                               (</span>t <span class="rainbow-delimiters-depth-9-face">(</span>im-tbp--color <span class="string">&quot;yellow&quot;</span> value<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                (</span><span class="builtin">:name</span> <span class="string">&quot;Restarts&quot;</span>
                 <span class="builtin">:min-width</span> 8
                 <span class="builtin">:formatter</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-7-face">(</span>value<span class="rainbow-delimiters-depth-7-face">)
                              (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-9-face">(</span>&gt; <span class="rainbow-delimiters-depth-1-face">(</span>string-to-number value<span class="rainbow-delimiters-depth-1-face">)</span> 0<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                                  (</span>im-tbp--color <span class="string">&quot;red&quot;</span> value<span class="rainbow-delimiters-depth-8-face">)</span>
                                value<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                (</span><span class="builtin">:name</span> <span class="string">&quot;Age&quot;</span> <span class="builtin">:min-width</span> 3<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:use-header-line</span> nil
     <span class="builtin">:objects-function</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
                         (</span><span class="keyword">-&gt;&gt;</span>
                          context
                          <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kubectl get pods --all-namespaces --no-headers --context=%s&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                          (</span>shell-command-to-string <span class="rainbow-delimiters-depth-6-face">)
                          (</span>s-trim<span class="rainbow-delimiters-depth-6-face">)
                          (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                          (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>data <span class="rainbow-delimiters-depth-1-face">(</span>s-split <span class="string">&quot; &quot;</span> it t<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                                   (</span>list
                                    <span class="builtin">:namespace</span> <span class="rainbow-delimiters-depth-9-face">(</span>nth 0 data<span class="rainbow-delimiters-depth-9-face">)</span> <span class="builtin">:name</span> <span class="rainbow-delimiters-depth-9-face">(</span>nth 1 data<span class="rainbow-delimiters-depth-9-face">)</span> <span class="builtin">:ready</span> <span class="rainbow-delimiters-depth-9-face">(</span>nth 2 data<span class="rainbow-delimiters-depth-9-face">)</span>
                                    <span class="builtin">:status</span> <span class="rainbow-delimiters-depth-9-face">(</span>nth 3 data<span class="rainbow-delimiters-depth-9-face">)</span> <span class="builtin">:restarts</span> <span class="rainbow-delimiters-depth-9-face">(</span>nth 4 data<span class="rainbow-delimiters-depth-9-face">)</span> <span class="builtin">:age</span> <span class="rainbow-delimiters-depth-9-face">(</span>nth 5 data<span class="rainbow-delimiters-depth-9-face">)</span>
                                    <span class="builtin">:context</span> context<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:actions</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;RET&quot;</span> im-kube-pod--act
                <span class="string">&quot;L&quot;</span> im-kube-pod--logs
                <span class="string">&quot;F&quot;</span> im-kube-pod--logs-follow
                <span class="string">&quot;x&quot;</span> im-kube-pod--remove
                <span class="string">&quot;i&quot;</span> im-kube-pod--info<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:getter</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>object column vtable<span class="rainbow-delimiters-depth-5-face">)
               (</span><span class="keyword">let-plist</span> object
                 <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">pcase</span> <span class="rainbow-delimiters-depth-7-face">(</span>vtable-column vtable column<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="string">&quot;Namespace&quot;</span> .namespace<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="string">&quot;Name&quot;</span> .name<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="string">&quot;Ready&quot;</span> .ready<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="string">&quot;Status&quot;</span> .status<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="string">&quot;Restarts&quot;</span> .restarts<span class="rainbow-delimiters-depth-7-face">)
                   (</span><span class="string">&quot;Age&quot;</span> .age<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer <span class="rainbow-delimiters-depth-4-face">(</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">ol</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>org-link-set-parameters
   <span class="string">&quot;kubectx&quot;</span>
   <span class="builtin">:follow</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>link _<span class="rainbow-delimiters-depth-4-face">) (</span>im-kube-context-overview link<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:store</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
            (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-prefix? <span class="string">&quot;*im-kube: &quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>buffer-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
              (</span>org-link-store-props
               <span class="builtin">:type</span> <span class="string">&quot;kubectx&quot;</span>
               <span class="builtin">:description</span> im-kube--current-context
               <span class="builtin">:link</span>
               <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kubectx:%s&quot;</span> im-kube--current-context<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--act</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>namespace <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>name <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>context <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">empv--select-action</span> <span class="string">&quot;Action for&quot;
      &quot;Exec into default container&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--exec-into-default-container pod<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Exec into container&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--exec-into-container pod container<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Logs&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--logs pod container<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Logs (follow)&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--logs-follow pod container<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Logs (to a file)&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--logs-to-file pod container<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Logs (previous pod)&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--previous-logs pod container<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;App logs&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--app-logs pod<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Top&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--top pod<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Remove&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--remove pod<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Events&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--events pod<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="string">&quot;Info&quot;</span> → <span class="rainbow-delimiters-depth-4-face">(</span>im-kube-pod--info pod<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--select-container</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:cmd</span> <span class="rainbow-delimiters-depth-3-face">(</span>format
         <span class="string">&quot;kubectl get pods '</span><span class="constant">%s</span><span class="string">' --namespace='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' -o jsonpath='{.spec.containers[*].name}'&quot;</span>
         <span class="rainbow-delimiters-depth-4-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;Container for %s: &quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:split</span> <span class="string">&quot; &quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--info</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Pod info action.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>get-buffer-create <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;*im-kube-pod-info-%s*&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert
     <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;kubectl get pod '</span><span class="constant">%s</span><span class="string">' --namespace='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' --output=json&quot;</span>
                                      <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)
                                      (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-6-face">)
                                      (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>json-ts-mode<span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer <span class="rainbow-delimiters-depth-4-face">(</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--top</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shell-command
   <span class="builtin">:switch</span> t
   <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;kubectl top pod  '</span><span class="constant">%s</span><span class="string">' --namespace='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">'&quot;</span>
                    <span class="rainbow-delimiters-depth-4-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-4-face">)
                    (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-4-face">)
                    (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--remove</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>y-or-n-p <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;Do you really want to remove %s? &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:switch</span> t
     <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-kill <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;kubectl delete pod '</span><span class="constant">%s</span><span class="string">' --namespace='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">'&quot;</span>
                               <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)
                               (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-6-face">)
                               (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--events</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)
  (</span>shell-command
   <span class="rainbow-delimiters-depth-3-face">(</span>im-kill
    <span class="rainbow-delimiters-depth-4-face">(</span>format
     <span class="string">&quot;kubectl events --for '</span><span class="constant">pod/%s</span><span class="string">' --namespace='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">'&quot;</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>format <span class="string">&quot;*im-kube-events:%s*&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--app-logs</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Logs from all pods combined for given pod's app
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>container <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> container <span class="rainbow-delimiters-depth-6-face">(</span>im-kube-pod--select-container pod<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-eshell <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;$pod: %s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>im-kill
               <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kubectl logs -f --selector app=%s --namespace='</span><span class="constant">%s</span><span class="string">' --container='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">'&quot;</span>
                       <span class="rainbow-delimiters-depth-7-face">(</span>im-kube-pod--get-app-name pod<span class="rainbow-delimiters-depth-7-face">)
                       (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-7-face">)</span>
                       container
                       <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--previous-logs</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>container <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> container <span class="rainbow-delimiters-depth-6-face">(</span>im-kube-pod--select-container pod<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command
     <span class="rainbow-delimiters-depth-4-face">(</span>im-kill
      <span class="rainbow-delimiters-depth-5-face">(</span>format
       <span class="string">&quot;kubectl logs %s --since=0 --namespace='</span><span class="constant">%s</span><span class="string">' --container='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' -p&quot;</span>
       <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-6-face">)</span>
       container
       <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;*im-kube-logs:%s-%s-PREVIOUS*&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)</span> container<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--logs-to-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>container <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> container <span class="rainbow-delimiters-depth-6-face">(</span>im-kube-pod--select-container pod<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>fname <span class="rainbow-delimiters-depth-5-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-6-face">(</span>read-file-name
                                  <span class="string">&quot;File: &quot;
                                  &quot;~/Workspace/temp/&quot;</span>
                                  nil
                                  nil
                                  <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;%s-%s.logs&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%d&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; Downloading logs for %s. Done.&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>set-process-sentinel
     <span class="rainbow-delimiters-depth-4-face">(</span>start-process-shell-command
      <span class="string">&quot;*im-kube-log-write*&quot;
      &quot;*im-kube-log-write*&quot;</span>
      <span class="rainbow-delimiters-depth-5-face">(</span>im-kill <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kubectl logs %s --since=0 --namespace='</span><span class="constant">%s</span><span class="string">' --container='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' &gt; '</span><span class="constant">%s</span><span class="string">'&quot;</span>
                       <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-7-face">)
                       (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-7-face">)</span>
                       container
                       <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-7-face">)</span>
                       fname<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>proc event<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>eq <span class="rainbow-delimiters-depth-7-face">(</span>process-exit-status proc<span class="rainbow-delimiters-depth-7-face">)</span> 0<span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">progn</span>
             <span class="rainbow-delimiters-depth-7-face">(</span>message <span class="string">&quot;&gt;&gt; Downloading logs for %s. Done.&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>find-file fname<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="warning">user-error</span> <span class="string">&quot;Failed to get logs&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--logs-follow</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>container <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> container <span class="rainbow-delimiters-depth-6-face">(</span>im-kube-pod--select-container pod<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>vterm <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;$pod: %s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>vterm-insert
       <span class="rainbow-delimiters-depth-5-face">(</span>im-kill <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kubectl logs %s -f --namespace='</span><span class="constant">%s</span><span class="string">' --container='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">'&quot;</span>
                        <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-7-face">)
                        (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-7-face">)</span>
                        container
                        <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--logs</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>container <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> container <span class="rainbow-delimiters-depth-6-face">(</span>im-kube-pod--select-container pod<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command
     <span class="rainbow-delimiters-depth-4-face">(</span>im-kill
      <span class="rainbow-delimiters-depth-5-face">(</span>format
       <span class="string">&quot;kubectl logs %s --since=0 --namespace='</span><span class="constant">%s</span><span class="string">' --container='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">'&quot;</span>
       <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)
       (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-6-face">)</span>
       container
       <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>format <span class="string">&quot;*im-kube-logs:%s-%s*&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)</span> container<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--exec-into-container</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod <span class="type">&amp;optional</span> container<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>container <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> container <span class="rainbow-delimiters-depth-6-face">(</span>im-kube-pod--select-container pod<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-eshell <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;$pod: %s&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert
       <span class="rainbow-delimiters-depth-5-face">(</span>im-kill <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kubectl exec --namespace='</span><span class="constant">%s</span><span class="string">' --container='</span><span class="constant">%s</span><span class="string">' -i -t '</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' -- bash&quot;</span>
                        <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-7-face">)</span>
                        container
                        <span class="rainbow-delimiters-depth-7-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-7-face">)
                        (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--exec-into-default-container</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-eshell <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;$pod: %s&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>insert
     <span class="rainbow-delimiters-depth-4-face">(</span>im-kill <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;kubectl exec --namespace='</span><span class="constant">%s</span><span class="string">' -i -t '</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' -- bash&quot;</span>
                      <span class="rainbow-delimiters-depth-6-face">(</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-6-face">)
                      (</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-6-face">)
                      (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-kube-pod--get-app-name</span> <span class="rainbow-delimiters-depth-2-face">(</span>pod<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return the application name of the POD belongs.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>s-trim
   <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string
    <span class="rainbow-delimiters-depth-4-face">(</span>format
     <span class="string">&quot;kubectl get pod '</span><span class="constant">%s</span><span class="string">' --namespace='</span><span class="constant">%s</span><span class="string">' --context='</span><span class="constant">%s</span><span class="string">' -o custom-columns=:metadata.labels.app&quot;</span>
     <span class="rainbow-delimiters-depth-5-face">(</span>plist-get pod <span class="builtin">:name</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>plist-get pod <span class="builtin">:namespace</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>plist-get pod <span class="builtin">:context</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Kafka
</span>
<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> rewrite this using kafkactl
</span><span class="comment-delimiter">;; </span><span class="comment">Also add functions like `</span><span class="constant">im-kafka-switch-context</span><span class="comment">' etc.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-kafka-describe-consumer-group</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">im-select-kafka-consumers</span><span class="comment">' is a private function that
</span>  <span class="comment-delimiter">;; </span><span class="comment">returns a kafka server list
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>servers <span class="rainbow-delimiters-depth-5-face">(</span>im-select-kafka-consumers<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">im-output-select</span>
     <span class="builtin">:cmd</span> <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;kafka-consumer-groups.sh --list --bootstrap-server %s&quot;</span> servers<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:prompt</span> <span class="string">&quot;Select a consumer group: &quot;</span>
     <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-output-to-tabulated-list
          <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string
           <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;kafka-consumer-groups.sh --describe --group %s --bootstrap-server %s&quot;</span> it servers<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
          <span class="builtin">:buffer</span> <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="string">&quot;*kafka-describe:%s*&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Run functions globally
</span>
<span class="comment-delimiter">;; </span><span class="comment">Simply use ~im-dmenu~ function instead of the default
</span><span class="comment-delimiter">;; </span><span class="comment">~completing-read~ function when the code is called inside this
</span><span class="comment-delimiter">;; </span><span class="comment">macro. This way, you can use your ~completing-read~ based functions
</span><span class="comment-delimiter">;; </span><span class="comment">within your system, without needing to focus Emacs first.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defmacro</span> <span class="function-name">im-globally</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;rest</span> body<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>completing-read-function <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-dmenu</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
     ,@body<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Archive URLs with single-file
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-archive-url</span> <span class="rainbow-delimiters-depth-2-face">(</span>url <span class="type">&amp;key</span> where <span class="rainbow-delimiters-depth-3-face">(</span>backend <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">chrome</span><span class="rainbow-delimiters-depth-3-face">)</span> crawl tidy on-finish on-fail<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Archive the URL into WHERE.
WHERE can be a directory or a file.  If it's a directory, it should
already exists otherwise WHERE is interpreted as a file name.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span>
          <span class="rainbow-delimiters-depth-5-face">(</span>im-org-link-copy<span class="rainbow-delimiters-depth-5-face">)
          (</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>read-string <span class="string">&quot;URL: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>read-directory-name <span class="string">&quot;Save files into: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> where <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name where<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>s-matches? im-reddit-comment-url-regexp url<span class="rainbow-delimiters-depth-4-face">)
    (</span>im-archive-url--reddit url <span class="builtin">:where</span> where<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t
    <span class="rainbow-delimiters-depth-4-face">(</span>im-archive-url--helper
     url
     <span class="builtin">:where</span> where
     <span class="builtin">:backend</span> backend
     <span class="builtin">:crawl</span> crawl
     <span class="builtin">:tidy</span> tidy
     <span class="builtin">:on-finish</span> on-finish
     <span class="builtin">:on-fail</span> on-fail<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-archive-url--helper</span> <span class="rainbow-delimiters-depth-2-face">(</span>url <span class="type">&amp;key</span> where <span class="rainbow-delimiters-depth-3-face">(</span>backend <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">chrome</span><span class="rainbow-delimiters-depth-3-face">)</span> crawl tidy on-finish on-fail<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span>
          <span class="rainbow-delimiters-depth-5-face">(</span>im-org-link-copy<span class="rainbow-delimiters-depth-5-face">)
          (</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>read-string <span class="string">&quot;URL: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>read-directory-name <span class="string">&quot;Save files into: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> where <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name where<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>command
          <span class="rainbow-delimiters-depth-5-face">(</span>format
           <span class="string">&quot;%s --filename-replacement-character='</span><span class="constant">-</span><span class="string">' %s %s %s \&quot;%s\&quot; \&quot;%s\&quot;&quot;</span>
           <span class="rainbow-delimiters-depth-6-face">(</span>im-ensure-binary <span class="string">&quot;deno run -A npm:single-file-cli&quot;</span> <span class="builtin">:installer</span> <span class="string">&quot;Install deno and thats it.&quot;</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-7-face">)</span>
               <span class="string">&quot;--browser-executable-path=\&quot;/Applications/Google Chrome.app/Contents/MacOS/Google Chrome\&quot;&quot;
             &quot;--browser-executable-path=chromium-browser&quot;</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>eq backend <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">firefox</span><span class="rainbow-delimiters-depth-7-face">)</span>
               <span class="string">&quot;--back-end=webdriver-gecko&quot;
             &quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">if</span> crawl
               <span class="comment-delimiter">;; </span><span class="default-0035">FIXME</span><span class="comment"> --crawl-replace-urls=true does not work
</span>               <span class="string">&quot;--crawl-links=true --crawl-external-links-max-depth=1 --crawl-max-depth=1 --crawl-replace-urls=true --crawl-inner-links-only=false --crawl-no-parent=true&quot;
             &quot;&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
           url
           <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">cond</span>
            <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>f-dir? where<span class="rainbow-delimiters-depth-8-face">)
             (</span>format <span class="string">&quot;--output-directory=%s&quot;</span> where<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>where where<span class="rainbow-delimiters-depth-7-face">)
            (</span>t <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;--output-directory=%s&quot;</span> default-directory<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:command</span> command
     <span class="builtin">:switch</span> nil
     <span class="builtin">:buffer-name</span> <span class="string">&quot;*single-file output*&quot;</span>
     <span class="builtin">:on-finish</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">any</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>message <span class="string">&quot;Archived `</span><span class="constant">%s</span><span class="string">'!&quot;</span> url<span class="rainbow-delimiters-depth-6-face">)
         (</span>kill-new command<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="comment-delimiter">;; </span><span class="comment">single-file does not return the created file name, finding that manually
</span>       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>created-file <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">cond</span>
                            <span class="rainbow-delimiters-depth-9-face">(</span><span class="rainbow-delimiters-depth-1-face">(</span>f-file? where<span class="rainbow-delimiters-depth-1-face">)</span> where<span class="rainbow-delimiters-depth-9-face">)
                            (</span><span class="rainbow-delimiters-depth-1-face">(</span>f-dir? where<span class="rainbow-delimiters-depth-1-face">) (</span>im-latest-file where<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)
                            (</span>t <span class="rainbow-delimiters-depth-1-face">(</span><span class="warning">error</span> <span class="string">&quot;Can't find file created backup file&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">when</span> tidy
           <span class="rainbow-delimiters-depth-7-face">(</span>shell-command
            <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;%s -q -w 120 -m '</span><span class="constant">%s</span><span class="string">'&quot;</span>
                    <span class="rainbow-delimiters-depth-9-face">(</span>im-ensure-binary <span class="string">&quot;tidy&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span>
                    created-file<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">and</span> on-finish <span class="rainbow-delimiters-depth-7-face">(</span>funcall on-finish created-file<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-fail</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">any</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>message <span class="string">&quot;Archiving failed: '</span><span class="constant">%s</span><span class="string">'. Command is copied to your kill ring.&quot;</span> url<span class="rainbow-delimiters-depth-6-face">)
         (</span>kill-new command<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">and</span> on-fail <span class="rainbow-delimiters-depth-6-face">(</span>funcall on-fail <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">abnormal-exit</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">cl-defun</span> <span class="function-name">im-archive-url--reddit</span> <span class="rainbow-delimiters-depth-2-face">(</span>link <span class="type">&amp;key</span> where<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Archive Reddit comment page LINK to WHERE in org-mode.
See `</span><span class="constant">im-archive-url</span><span class="doc">' for WHERE's definition.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> link <span class="rainbow-delimiters-depth-3-face">(</span>substring link <span class="rainbow-delimiters-depth-4-face">(</span>length <span class="string">&quot;https://www.reddit.com/&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> nil<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">promise-chain</span> <span class="rainbow-delimiters-depth-3-face">(</span>reddigg--promise-comments link<span class="rainbow-delimiters-depth-3-face">)
    (</span>then <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">reddigg--print-comments</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>then <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
            (</span>write-region
             <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-7-face">(</span>reddigg--get-cmt-buffer<span class="rainbow-delimiters-depth-7-face">)
               (</span>buffer-substring-no-properties <span class="rainbow-delimiters-depth-8-face">(</span>point-min<span class="rainbow-delimiters-depth-8-face">) (</span>point-max<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
             nil
             <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">cond</span>
              <span class="comment-delimiter">;; </span><span class="comment">NOTE: I don't have a use case where I pass `</span><span class="constant">nil</span><span class="comment">' for
</span>              <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">where</span><span class="comment">'.  If I do, it's better to include the page
</span>              <span class="comment-delimiter">;; </span><span class="comment">title to the filename.
</span>              <span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>f-dir? where<span class="rainbow-delimiters-depth-8-face">) (</span>f-join where <span class="rainbow-delimiters-depth-9-face">(</span>format-time-string <span class="string">&quot;%Y%m%dT%H%M%S-reddit-comments.org&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
              (</span>where where<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>promise-catch <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>reason<span class="rainbow-delimiters-depth-5-face">)
                     (</span>message <span class="string">&quot;im-archive-url--reddit failed: %s&quot;</span> reason<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> narrow-indirect &amp; im-narrow-dwim
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">narrow-indirect</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;n&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-narrow-dwim</span>
  <span class="string">&quot;N&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>im-eval-dwim
       <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">ni-narrow-to-page-indirect-other-window</span>
       <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">ni-narrow-to-region-indirect-other-window</span>
       <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">ni-narrow-to-defun-indirect-other-window</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-narrow-dwim</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Smart narrowing.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>use-region-p<span class="rainbow-delimiters-depth-4-face">) (</span>narrow-to-region <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">) (</span>region-end<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-4-face">) (</span>org-narrow-to-subtree<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">markdown-mode</span><span class="rainbow-delimiters-depth-4-face">) (</span>markdown-narrow-to-subtree<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>eq major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs-lisp-mode</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>which-function<span class="rainbow-delimiters-depth-6-face">) (</span>narrow-to-defun<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>t <span class="rainbow-delimiters-depth-6-face">(</span>outli-toggle-narrow-to-subtree<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>s-contains? <span class="string">&quot;-ts-&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>symbol-name major-mode<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-5-face">(</span>def <span class="rainbow-delimiters-depth-6-face">(</span>treesit-defun-at-point<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
      (</span>narrow-to-region <span class="rainbow-delimiters-depth-6-face">(</span>treesit-node-start def<span class="rainbow-delimiters-depth-6-face">)
                        (</span>treesit-node-end def<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>outli-mode <span class="rainbow-delimiters-depth-4-face">(</span>outli-toggle-narrow-to-subtree<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>



<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-meme-downloader
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-meme-downloader</span> <span class="rainbow-delimiters-depth-2-face">(</span>url <span class="type">&amp;optional</span> file-title<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;URL: &quot;</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>read-string <span class="string">&quot;Title: &quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>title
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> file-title
              <span class="rainbow-delimiters-depth-6-face">(</span>s-trim
               <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">thread-last</span>
                 url
                 im-url-get-title
                 im-string-url-case
                 s-downcase<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>dir <span class="rainbow-delimiters-depth-5-face">(</span>expand-file-name <span class="string">&quot;~/Documents/memes&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>default-directory dir<span class="rainbow-delimiters-depth-4-face">)
         (</span>cmd <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;yt-dlp --output '%s.%%(ext)s' '</span><span class="constant">%s</span><span class="string">'&quot;</span> title url<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;im-meme-downloader :: %s&quot;</span> cmd<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:command</span> cmd
     <span class="builtin">:switch</span> nil
     <span class="builtin">:on-finish</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>output <span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">if-let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>matches <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">or</span>
                           <span class="rainbow-delimiters-depth-9-face">(</span>s-match <span class="string">&quot;\\[</span><span class="constant">download\\</span><span class="string">] </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> has already been downloaded&quot;</span> output<span class="rainbow-delimiters-depth-9-face">)
                           (</span>s-match <span class="string">&quot;^\\[</span><span class="constant">Merger\\</span><span class="string">] Merging formats into \&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\&quot;&quot;</span> output<span class="rainbow-delimiters-depth-9-face">)
                           (</span>s-match <span class="string">&quot;^\\[</span><span class="constant">download\\</span><span class="string">] Destination: </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> output<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                 (</span>fname <span class="rainbow-delimiters-depth-8-face">(</span>abbreviate-file-name <span class="rainbow-delimiters-depth-9-face">(</span>nth 1 matches<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">progn</span>
             <span class="rainbow-delimiters-depth-7-face">(</span>alert <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;Downloaded: %s!&quot;</span> fname<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>kill-new <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;%s/%s&quot;</span> dir fname<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>alert <span class="string">&quot;Can't parse yt-dlp output!&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-fail</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span>alert <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;Error while downloading: %s!&quot;</span> url<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> zoom
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-open-zoom-meeting-dwim</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> link<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-5-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-5-face">) (</span>read-string <span class="string">&quot;Link: &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>zoom <span class="rainbow-delimiters-depth-5-face">(</span>s-match
                     <span class="string">&quot;https://.*zoom\\.us/j/</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\?pwd=</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\w+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span>
                     link<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
              (</span>cmd <span class="rainbow-delimiters-depth-5-face">(</span>format
                    <span class="string">&quot;open '</span><span class="constant">zoommtg://zoom.us/join?confno=%s&amp;pwd=%s</span><span class="string">'&quot;</span>
                    <span class="rainbow-delimiters-depth-6-face">(</span>nth 1 zoom<span class="rainbow-delimiters-depth-6-face">)
                    (</span>nth 2 zoom<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; Running %s&quot;</span> cmd<span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command cmd<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> macOS calendar functions
</span>
<span class="comment-delimiter">;; </span><span class="comment">My work computer is a Mac. I synchronize my work calendar into my
</span><span class="comment-delimiter">;; </span><span class="comment">local by using macOS' Calendar app and I utilize
</span><span class="comment-delimiter">;; </span><span class="comment">[[https://hasseg.org/icalBuddy/][icalBuddy]] to interact with that
</span><span class="comment-delimiter">;; </span><span class="comment">calendar from Emacs.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-calendar-now</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show the current calendar item details in a buffer and open the
  zoom link if it has one.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shell-command
   <span class="builtin">:command</span> <span class="string">&quot;icalBuddy -f -ea eventsNow&quot;</span>
   <span class="builtin">:switch</span> t
   <span class="builtin">:buffer-name</span> <span class="string">&quot;*calendar-now*&quot;</span>
   <span class="builtin">:on-start</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">) (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:on-finish</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span>it<span class="rainbow-delimiters-depth-4-face">)
                (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>zoom <span class="rainbow-delimiters-depth-7-face">(</span>nth 1 <span class="rainbow-delimiters-depth-8-face">(</span>s-match <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">https://.*zoom.us/j/.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\b</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">\n</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> it<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                  (</span>im-open-zoom-meeting-dwim zoom<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">define-derived-mode</span> <span class="function-name">im-calendar-mode</span> outline-mode <span class="string">&quot;Calendar&quot;</span>
  <span class="doc">&quot;Calendar...&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-calendar-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">motion</span>
  <span class="string">&quot;TAB&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-cycle</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-calendar-today</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show today's calendar in a buffer.
The resulting buffer has outline-mode enabled, so you can use
outline-mode specific bindings to jump, hide/show stuff.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shell-command
   <span class="builtin">:command</span> <span class="string">&quot;icalBuddy -f eventsToday&quot;</span>
   <span class="builtin">:switch</span> t
   <span class="builtin">:on-start</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">) (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:on-finish</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)
                (</span>im-calendar-mode<span class="rainbow-delimiters-depth-4-face">)
                (</span><span class="keyword">setq-local</span> outline-regexp <span class="string">&quot;• &quot;</span><span class="rainbow-delimiters-depth-4-face">)
                (</span><span class="keyword">setq-local</span> outline-level <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-level</span><span class="rainbow-delimiters-depth-4-face">)
                (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                (</span>outline-cycle-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:buffer-name</span> <span class="string">&quot;*calendar-today*&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-calendar-for-date</span> <span class="rainbow-delimiters-depth-2-face">(</span>date<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Show given DATEs calendar in a buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>format-time-string <span class="string">&quot;%Y-%m-%d&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>org-read-date nil <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">to-time</span> nil <span class="string">&quot;Date:  &quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-shell-command
   <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;icalBuddy -f eventsFrom:%s to:%s&quot;</span> date date<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:switch</span> t
   <span class="builtin">:on-start</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">) (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:on-finish</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)
                (</span>im-calendar-mode<span class="rainbow-delimiters-depth-4-face">)
                (</span><span class="keyword">setq-local</span> outline-regexp <span class="string">&quot;• &quot;</span><span class="rainbow-delimiters-depth-4-face">)
                (</span><span class="keyword">setq-local</span> outline-level <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">outline-level</span><span class="rainbow-delimiters-depth-4-face">)
                (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                (</span>outline-cycle-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:buffer-name</span> <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;*calendar-%s*&quot;</span> date<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-clipboard-image-to-text
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defalias</span> <span class="highlight-quoted-quote">'</span><span class="function-name">im-clipboard-tesseract-ocr-text</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-clipboard-image-to-text</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defun</span> <span class="function-name">im-clipboard-image-to-text</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>temp-image <span class="rainbow-delimiters-depth-5-face">(</span>make-temp-file <span class="string">&quot;tesseract-image&quot;</span> nil <span class="string">&quot;.png&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>temp-text <span class="rainbow-delimiters-depth-5-face">(</span>make-temp-file <span class="string">&quot;tesseract-text&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="string">&quot;*ocr-result*&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-save-clipboard-image-to-file temp-image<span class="rainbow-delimiters-depth-3-face">)
    (</span>set-process-sentinel
     <span class="rainbow-delimiters-depth-4-face">(</span>start-process <span class="string">&quot;*tesseract-ocr*&quot;</span> nil <span class="string">&quot;tesseract&quot;</span> temp-image temp-text<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>proc out<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span>
            <span class="rainbow-delimiters-depth-7-face">(</span>eq <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">exit</span> <span class="rainbow-delimiters-depth-8-face">(</span>process-status proc<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
            (</span>eq 0 <span class="rainbow-delimiters-depth-8-face">(</span>process-exit-status proc<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">progn</span>
             <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">with-current-buffer</span> buffer
               <span class="rainbow-delimiters-depth-8-face">(</span>erase-buffer<span class="rainbow-delimiters-depth-8-face">)
               (</span>insert <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;[[%s]]\n\n\n&quot;</span> temp-image<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
               (</span>insert-file-contents <span class="rainbow-delimiters-depth-9-face">(</span>concat temp-text <span class="string">&quot;.txt&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
               (</span>iimage-mode<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>switch-to-buffer buffer<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>message <span class="string">&quot;*tesseract-ocr*: %s&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>string-trim out<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-gnuplot
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defmacro</span> <span class="function-name">im-gnuplot</span> <span class="rainbow-delimiters-depth-2-face">(</span>settings <span class="type">&amp;rest</span> forms<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;A horrible hack for using `</span><span class="constant">gnuplot</span><span class="doc">' in emacs-lisp. Example usage:

    (im-gnuplot
        (:persist t)
      (plot sin(x))
      (plot sin(x)/x)
      (plot cos(x))
      (plot cos(x)/x)
      (plot sin(x) title \&quot;Sin\&quot;, tan(x) title \&quot;Tangent\&quot;))

First argument is a plist which consists gnuplot configs or
variable definitions.  Configs are`</span><span class="constant">:persist</span><span class="doc">', `</span><span class="constant">:default</span><span class="doc">',
`</span><span class="constant">:slow</span><span class="doc">'. See `man gnuplot' for more information on these
settings. They can be either `</span><span class="constant">t</span><span class="doc">' or `</span><span class="constant">nil</span><span class="doc">'. Default is `</span><span class="constant">nil</span><span class="doc">' for
each one.

Variable definitions are like the `</span><span class="constant">let</span><span class="doc">' form, simply define
variables and use them in the gnuplot code below. Variable
namings should follow `</span><span class="constant">:this-style:</span><span class="doc">' and the values can be
arbitrary elisp.

    (im-gnuplot
        (:data: (make-temp-file \&quot;im-gnuplot\&quot; nil \&quot;.dat\&quot; \&quot;a 1\nb 2\nc 3\&quot;)
         :out-file: \&quot;~/output.png\&quot;)
      (set terminal pngcairo size 900,300 enhanced font \&quot;Verdana,8\&quot;)
      (set output :out-file:)
      (set style data histograms)
      (set boxwidth 0.9)
      (set style fill solid)
      (set xlabel \&quot;Time\&quot;)
      (set ylabel \&quot;Log count\&quot;)
      (set title \&quot;Log count over time\&quot;)
      (plot :data: using 2:xtic(1) title \&quot;\&quot;))&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">declare</span> <span class="rainbow-delimiters-depth-3-face">(</span>indent 1<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>script <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">thread-last</span>
                   forms
                   <span class="rainbow-delimiters-depth-6-face">(</span>mapcar
                    <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>it<span class="rainbow-delimiters-depth-8-face">)
                      (</span><span class="keyword">thread-first</span>
                        it
                        <span class="rainbow-delimiters-depth-9-face">(</span>prin1-to-string<span class="rainbow-delimiters-depth-9-face">)
                        (</span>string-trim-left <span class="string">&quot;(&quot;</span><span class="rainbow-delimiters-depth-9-face">)
                        (</span>string-trim-right <span class="string">&quot;)&quot;</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
                   (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                   (</span>s-replace-regexp <span class="string">&quot; (\\\\, </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">)&quot; &quot;,\\1&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
       <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>items <span class="rainbow-delimiters-depth-7-face">(</span>list ,@<span class="rainbow-delimiters-depth-8-face">(</span>-flatten-n 1 <span class="rainbow-delimiters-depth-9-face">(</span>map-apply <span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-2-face">(</span>key val<span class="rainbow-delimiters-depth-2-face">) (</span>list key val<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span> settings<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
              (</span>script-last <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">thread-last</span>
                             ,script
                             <span class="rainbow-delimiters-depth-8-face">(</span>s-prepend <span class="string">&quot;reset\n&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                             (</span>s-replace-regexp
                              <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">:[a-zA-Z-]+:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span>
                              <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-1-face">(</span>match<span class="rainbow-delimiters-depth-1-face">) (</span>format <span class="string">&quot; %s &quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>prin1-to-string <span class="rainbow-delimiters-depth-3-face">(</span>plist-get items <span class="rainbow-delimiters-depth-4-face">(</span>intern <span class="rainbow-delimiters-depth-5-face">(</span>s-trim match<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
         (</span><span class="keyword">with-temp-buffer</span>
           <span class="rainbow-delimiters-depth-6-face">(</span>insert script-last<span class="rainbow-delimiters-depth-6-face">)
           (</span>shell-command-on-region
            <span class="rainbow-delimiters-depth-7-face">(</span>point-min<span class="rainbow-delimiters-depth-7-face">) (</span>point-max<span class="rainbow-delimiters-depth-7-face">)
            (</span>format <span class="string">&quot;gnuplot%s%s%s&quot;</span>
                    <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>plist-get items <span class="builtin">:persist</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot; --persist&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>plist-get items <span class="builtin">:default</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot; --default&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">)
                    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-9-face">(</span>plist-get items <span class="builtin">:slow</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot; --slow&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
            nil t<span class="rainbow-delimiters-depth-6-face">)
           (</span>buffer-string<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Image and file system tags
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-image-edit-tags</span> <span class="rainbow-delimiters-depth-2-face">(</span>tags image <span class="type">&amp;optional</span> clear-all<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Add TAGS to IMAGE.
If CLEAR-ALL is non-nil, clear all tags before setting TAGS as
image tags. Otherwise TAGS are appended.  If cursor is on an org
link, use that as the IMAGE (when called interactively).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>org-link? <span class="rainbow-delimiters-depth-6-face">(</span>org-in-regexp org-link-any-re 1<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>file
           <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> org-link?
               <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">progn</span>
                 <span class="rainbow-delimiters-depth-8-face">(</span>goto-char <span class="rainbow-delimiters-depth-9-face">(</span>car org-link?<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                 (</span>plist-get <span class="rainbow-delimiters-depth-9-face">(</span>cadr <span class="rainbow-delimiters-depth-1-face">(</span>org-element-link-parser<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span> <span class="builtin">:path</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>read-file-name <span class="string">&quot;Image file: &quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>file-tags <span class="rainbow-delimiters-depth-6-face">(</span>s-join <span class="string">&quot;, &quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>im-image-tags file<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>tags <span class="rainbow-delimiters-depth-6-face">(</span>completing-read-multiple
                 <span class="string">&quot;Tags: &quot;</span>
                 <span class="rainbow-delimiters-depth-7-face">(</span>im-directory-image-tags <span class="rainbow-delimiters-depth-8-face">(</span>f-dirname file<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
                 nil nil
                 <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-8-face">(</span>s-blank? file-tags<span class="rainbow-delimiters-depth-8-face">)</span> nil <span class="rainbow-delimiters-depth-8-face">(</span>concat file-tags <span class="string">&quot;,&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>list
      tags
      file
      t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> image <span class="rainbow-delimiters-depth-3-face">(</span>expand-file-name image<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> clear-all
    <span class="rainbow-delimiters-depth-3-face">(</span>shell-command <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;exiftool -overwrite_original -keywords='' '</span><span class="constant">%s</span><span class="string">'&quot;</span> image<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>shell-command
   <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;exiftool -overwrite_original %s '</span><span class="constant">%s</span><span class="string">'&quot;</span>
           <span class="rainbow-delimiters-depth-4-face">(</span>s-join <span class="string">&quot; &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;-keywords+='</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-trim it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span> tags<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
           image<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Also add these tags as file extended attribute which helps KDE to
</span>  <span class="comment-delimiter">;; </span><span class="comment">easily index these files.  I'm using this in conjunction with exif
</span>  <span class="comment-delimiter">;; </span><span class="comment">attributes because it's quite easy to loose extended attributes
</span>  <span class="comment-delimiter">;; </span><span class="comment">and exif attributes serves as a backup.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">if</span> clear-all
      <span class="rainbow-delimiters-depth-3-face">(</span>im-set-file-attribute image <span class="string">&quot;user.xdg.tags&quot;</span> <span class="rainbow-delimiters-depth-4-face">(</span>s-join <span class="string">&quot;,&quot;</span> tags<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-set-file-attribute
     image <span class="string">&quot;user.xdg.tags&quot;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>s-join <span class="string">&quot;,&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>cons <span class="rainbow-delimiters-depth-6-face">(</span>im-get-file-attribute image <span class="string">&quot;user.xdg.tags&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span> tags<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-image-tags</span> <span class="rainbow-delimiters-depth-2-face">(</span>image<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return tags of IMAGE.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>result
         <span class="rainbow-delimiters-depth-5-face">(</span>plist-get
          <span class="rainbow-delimiters-depth-6-face">(</span>seq-first
           <span class="rainbow-delimiters-depth-7-face">(</span>json-parse-string
            <span class="rainbow-delimiters-depth-8-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;exiftool -quiet -json -keywords '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>expand-file-name image<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
            <span class="builtin">:array-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span>
            <span class="builtin">:object-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">plist</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
          <span class="builtin">:Keywords</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>listp result<span class="rainbow-delimiters-depth-4-face">)</span> result <span class="rainbow-delimiters-depth-4-face">(</span>list result<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-directory-image-tags</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> directory<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Return all unique image tags in DIRECTORY.
If DIRECTORY is null, `</span><span class="constant">default-directory</span><span class="doc">' is used.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>-uniq
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">--mapcat</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>plist-get it <span class="builtin">:Keywords</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>json-parse-string
     <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string
      <span class="rainbow-delimiters-depth-6-face">(</span>im-ensure-binary
       <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;exiftool -m -quiet -json -keywords '</span><span class="constant">%s</span><span class="string">'&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> directory default-directory<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
     <span class="builtin">:object-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">plist</span> <span class="builtin">:array-type</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">list</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-get-file-attribute</span> <span class="rainbow-delimiters-depth-2-face">(</span>file name<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Get extended attribute NAME for FILE.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;getfattr --absolute-names --only-values --name='</span><span class="constant">%s</span><span class="string">' '</span><span class="constant">%s</span><span class="string">'&quot;</span> name <span class="rainbow-delimiters-depth-4-face">(</span>expand-file-name file<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-set-file-attribute</span> <span class="rainbow-delimiters-depth-2-face">(</span>file name value<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Set extended attribute NAME as VALUE for FILE.
When called interactively, set given NAME to VALUE as extended
attribute for current buffers file or selected file.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>attr <span class="rainbow-delimiters-depth-6-face">(</span>completing-read <span class="string">&quot;Attribute: &quot;</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;user.xdg.tags&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>list
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-6-face">(</span>buffer-file-name<span class="rainbow-delimiters-depth-6-face">) (</span>read-file-name <span class="string">&quot;File: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
      attr
      <span class="rainbow-delimiters-depth-5-face">(</span>read-string <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;Value for '</span><span class="constant">%s</span><span class="string">': &quot;</span> attr<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>shell-command-to-string <span class="rainbow-delimiters-depth-3-face">(</span>format <span class="string">&quot;setfattr --name='</span><span class="constant">%s</span><span class="string">' --value='</span><span class="constant">%s</span><span class="string">' '</span><span class="constant">%s</span><span class="string">'&quot;</span> name value <span class="rainbow-delimiters-depth-4-face">(</span>expand-file-name file<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Converting minibuffer candidates to a table automatically
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-minibuffer-to-table</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>get-buffer-create <span class="string">&quot;*im-minibuffer-table*&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>items <span class="rainbow-delimiters-depth-5-face">(</span>completion-all-completions
                <span class="rainbow-delimiters-depth-6-face">(</span>minibuffer-contents<span class="rainbow-delimiters-depth-6-face">)</span>
                minibuffer-completion-table
                minibuffer-completion-predicate
                <span class="rainbow-delimiters-depth-6-face">(</span>max 0 <span class="rainbow-delimiters-depth-7-face">(</span>- <span class="rainbow-delimiters-depth-8-face">(</span>point<span class="rainbow-delimiters-depth-8-face">) (</span>minibuffer-prompt-end<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-4-face">(</span>last <span class="rainbow-delimiters-depth-5-face">(</span>last items<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>setcdr last nil<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> buffer
      <span class="rainbow-delimiters-depth-4-face">(</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">thread-last</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>cdr items<span class="rainbow-delimiters-depth-5-face">)
        (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span>insert<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>push-mark <span class="rainbow-delimiters-depth-5-face">(</span>point-max<span class="rainbow-delimiters-depth-5-face">)</span> t t<span class="rainbow-delimiters-depth-4-face">)
      (</span>orgtbl-create-or-convert-from-region nil<span class="rainbow-delimiters-depth-4-face">)
      (</span>deactivate-mark<span class="rainbow-delimiters-depth-4-face">)
      (</span>org-mode<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>run-with-timer 0.1 nil <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">() (</span>switch-to-buffer-other-window buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>abort-recursive-edit<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>define-key minibuffer-local-map <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;M-|&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-minibuffer-to-table</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-pair-prog-mode -- Minor mode for pair programming
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-minor-mode</span> <span class="function-name">im-pair-prog-mode</span>
  <span class="doc">&quot;Pair programming mode so that everyone can enjoy the beauty of Emacs.&quot;</span>
  <span class="builtin">:lighter</span> <span class="string">&quot; PairProg&quot;</span>
  <span class="builtin">:global</span> t
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">unless</span> im-pair-prog-mode
    <span class="rainbow-delimiters-depth-3-face">(</span>message <span class="string">&quot;Restoring normal environment...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>global-display-line-numbers-mode -1<span class="rainbow-delimiters-depth-3-face">)
    (</span>default-text-scale-reset<span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Restoring normal environment...Done.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> im-pair-prog-mode
    <span class="rainbow-delimiters-depth-3-face">(</span>message <span class="string">&quot;Preparing pair programming environment...&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>global-display-line-numbers-mode t<span class="rainbow-delimiters-depth-3-face">)
    (</span>default-text-scale-increment <span class="rainbow-delimiters-depth-4-face">(</span>* 2 default-text-scale-amount<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;Preparing pair programming environment...Done.&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-read-time
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-read-time</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show approximate read time of the selected area or whole buffer.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>funcall
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>called-interactively-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">interactive</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">message</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">format</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="string">&quot;%s min read&quot;</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>ceiling
    <span class="rainbow-delimiters-depth-4-face">(</span>/ <span class="rainbow-delimiters-depth-5-face">(</span>apply <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">count-words</span>
              <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-7-face">(</span>region-active-p<span class="rainbow-delimiters-depth-7-face">)
                  (</span>list <span class="rainbow-delimiters-depth-8-face">(</span>region-beginning<span class="rainbow-delimiters-depth-8-face">) (</span>region-end<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                (</span>list <span class="rainbow-delimiters-depth-8-face">(</span>point-min<span class="rainbow-delimiters-depth-8-face">) (</span>point-max<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       <span class="comment-delimiter">;; </span><span class="comment">I am using a value lower than average wpm to account for other
</span>       <span class="comment-delimiter">;; </span><span class="comment">things (distractions etc.)
</span>       230.0<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-peek -- Inline/popup documentation/translate/dictionary etc.
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> quick-peek
</span>
<span class="comment-delimiter">;; </span><span class="comment">I based im-peek on quick-peek but will drop the dependency
</span><span class="comment-delimiter">;; </span><span class="comment">eventually as I am not able to properly configure some aspects of
</span><span class="comment-delimiter">;; </span><span class="comment">the &quot;peek window&quot;.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">quick-peek</span>
  <span class="builtin">:straight</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="builtin">:host</span> github <span class="builtin">:repo</span> <span class="string">&quot;cpitclaudel/quick-peek&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Bindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">im-leader-v</span>
  <span class="string">&quot;mt&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-translate</span>
  <span class="string">&quot;ms&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-sozluk</span>
  <span class="string">&quot;mS&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-dictionary</span>
  <span class="string">&quot;me&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-etimoloji</span>
  <span class="string">&quot;mE&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-etymology</span>
  <span class="string">&quot;md&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc</span>
  <span class="string">&quot;mc&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-source</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-2-face">(</span>prog-mode-map<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="string">&quot;K&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">evil</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> evil-lookup-func <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span>
  <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-peek-mode-map</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>kbd <span class="string">&quot;K&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-remove</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> im-peek implementation
</span>
<span class="comment-delimiter">;;;;;;;</span><span class="outline-5-0044"> Variables
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-peek--buffer</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-peek--string</span> nil<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defvar</span> <span class="variable-name">im-peek--pos</span> 0<span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">defconst</span> <span class="variable-name">im-peek--line-count</span> 30<span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;;</span><span class="outline-5-0044"> Mode
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-minor-mode</span> <span class="function-name">im-peek-mode</span>
  <span class="doc">&quot;Elisp popup documentation mode.&quot;</span>
  <span class="builtin">:lighter</span> <span class="string">&quot; ElPopDoc&quot;</span>
  <span class="builtin">:global</span> t
  <span class="builtin">:keymap</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>map <span class="rainbow-delimiters-depth-5-face">(</span>make-sparse-keymap<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
            (</span>define-key map <span class="rainbow-delimiters-depth-4-face">(</span>kbd <span class="string">&quot;M-j&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-mode-scroll-down</span><span class="rainbow-delimiters-depth-3-face">)
            (</span>define-key map <span class="rainbow-delimiters-depth-4-face">(</span>kbd <span class="string">&quot;M-k&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-mode-scroll-up</span><span class="rainbow-delimiters-depth-3-face">)
            (</span>define-key map <span class="rainbow-delimiters-depth-4-face">(</span>kbd <span class="string">&quot;C-g&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-remove</span><span class="rainbow-delimiters-depth-3-face">)
            (</span>define-key map <span class="rainbow-delimiters-depth-4-face">(</span>kbd <span class="string">&quot;M-RET&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-jump</span><span class="rainbow-delimiters-depth-3-face">)</span>
            map<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setf</span> <span class="rainbow-delimiters-depth-3-face">(</span>alist-get <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-mode</span> minor-mode-overriding-map-alist<span class="rainbow-delimiters-depth-3-face">)</span>
        im-peek-mode-map<span class="rainbow-delimiters-depth-2-face">)
  (</span>evil-normalize-keymaps<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-jump</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil im-peek-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek-remove<span class="rainbow-delimiters-depth-2-face">)
  (</span>switch-to-buffer-other-window im-peek--buffer<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-mode-scroll-down</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> lines<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> nil im-peek-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>quick-peek-hide<span class="rainbow-delimiters-depth-2-face">)
  (</span>quick-peek-show
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>s-lines im-peek--string<span class="rainbow-delimiters-depth-4-face">)
    (</span>-drop <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">setq</span> im-peek--pos <span class="rainbow-delimiters-depth-6-face">(</span>+ <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">or</span> lines 1<span class="rainbow-delimiters-depth-7-face">)</span> im-peek--pos<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   nil nil im-peek--line-count<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-mode-scroll-up</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> lines<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span> nil im-peek-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span>quick-peek-hide<span class="rainbow-delimiters-depth-2-face">)
  (</span>quick-peek-show
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
    <span class="rainbow-delimiters-depth-4-face">(</span>s-lines im-peek--string<span class="rainbow-delimiters-depth-4-face">)
    (</span>-drop <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">setq</span> im-peek--pos <span class="rainbow-delimiters-depth-6-face">(</span>max 0 <span class="rainbow-delimiters-depth-7-face">(</span>+ <span class="rainbow-delimiters-depth-8-face">(</span>- <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">or</span> lines 1<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span> im-peek--pos<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>s-join <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   nil nil im-peek--line-count<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-remove</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span> nil im-peek-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> im-peek--pos 0<span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek-mode -1<span class="rainbow-delimiters-depth-2-face">)
  (</span>quick-peek-hide<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> minor-mode-overriding-map-alist
        <span class="rainbow-delimiters-depth-3-face">(</span>assq-delete-all <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-mode</span>
                         minor-mode-overriding-map-alist<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-unfold-if-folded</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> pt<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> pt <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">or</span> pt <span class="rainbow-delimiters-depth-4-face">(</span>point<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-3-face">(</span>listp buffer-invisibility-spec<span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span>
           <span class="comment-delimiter">;; </span><span class="comment">Check if org-fold is enabled or not first
</span>           <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-fold-outline</span> buffer-invisibility-spec<span class="rainbow-delimiters-depth-5-face">)
           (</span>org-fold-folded-p pt<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>goto-char pt<span class="rainbow-delimiters-depth-5-face">)
        (</span>org-fold-show-entry<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span>
           <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">outline</span> buffer-invisibility-spec<span class="rainbow-delimiters-depth-5-face">)
           (</span>outline-invisible-p pt<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>goto-char pt<span class="rainbow-delimiters-depth-5-face">)
        (</span>outline-show-entry<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span>
           <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">hs</span> buffer-invisibility-spec<span class="rainbow-delimiters-depth-5-face">)
           (</span><span class="keyword">save-excursion</span>
             <span class="rainbow-delimiters-depth-6-face">(</span>goto-char pt<span class="rainbow-delimiters-depth-6-face">)
             (</span>hs-already-hidden-p<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>goto-char pt<span class="rainbow-delimiters-depth-5-face">)
        (</span>hs-toggle-hiding<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment"> support fn returning a string instead of a buffer. Create a
</span><span class="comment-delimiter">;; </span><span class="comment">temp buffer when jump is called
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-peek</span> <span class="rainbow-delimiters-depth-2-face">(</span>fn<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Display a nice little small window below current line.
FN should take no args and return a buffer with the intended
contents.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-window-excursion</span> <span class="rainbow-delimiters-depth-6-face">(</span>funcall fn<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> im-peek--buffer buffer<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">run-at-time</span><span class="comment">' function is useful for forcing the following code
</span>    <span class="comment-delimiter">;; </span><span class="comment">to run in main event loop. This helps when `</span><span class="constant">im-peek</span><span class="comment">' is called
</span>    <span class="comment-delimiter">;; </span><span class="comment">in an async context.
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>run-at-time
     0 nil
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
       (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>str <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">setq</span> im-peek--string
                        <span class="rainbow-delimiters-depth-9-face">(</span><span class="keyword">with-current-buffer</span> buffer
                          <span class="rainbow-delimiters-depth-1-face">(</span>font-lock-ensure<span class="rainbow-delimiters-depth-1-face">)
                          (</span>buffer-string<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
         <span class="comment-delimiter">;; </span><span class="comment">Center the current point if the remaining line count is low
</span>         <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">and</span>
                <span class="rainbow-delimiters-depth-8-face">(</span>&lt; <span class="rainbow-delimiters-depth-9-face">(</span>im-line-count-below-cursor<span class="rainbow-delimiters-depth-9-face">) (</span>length <span class="rainbow-delimiters-depth-1-face">(</span>s-lines str<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
                (</span>&lt; <span class="rainbow-delimiters-depth-9-face">(</span>im-line-count-below-cursor<span class="rainbow-delimiters-depth-9-face">) (</span>- <span class="rainbow-delimiters-depth-1-face">(</span>window-height<span class="rainbow-delimiters-depth-1-face">)</span> 10<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>recenter 10<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>quick-peek-show str nil nil im-peek--line-count<span class="rainbow-delimiters-depth-6-face">)
         (</span>im-unfold-if-folded <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">save-excursion</span> <span class="rainbow-delimiters-depth-8-face">(</span>end-of-line<span class="rainbow-delimiters-depth-8-face">) (</span>1+ <span class="rainbow-delimiters-depth-9-face">(</span>point<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>im-peek-mode +1<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-open?</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return t if &gt;=1 peek window is open.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>car quick-peek--overlays<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Special peek functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">use-package</span> <span class="constant">google-translate</span>
  <span class="builtin">:defines</span> <span class="rainbow-delimiters-depth-2-face">(</span>google-translate-pop-up-buffer-set-focus<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:custom</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>google-translate-listen-program <span class="string">&quot;mpv&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Try 'curl or 'wget if getting any errors
</span>  <span class="rainbow-delimiters-depth-2-face">(</span>google-translate-backend-method <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">emacs</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="builtin">:init</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> google-translate-translation-directions-alist
        <span class="comment-delimiter">;; </span><span class="comment">Ordered based on my usage:
</span>        <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;auto&quot;</span> . <span class="string">&quot;en&quot;</span><span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="string">&quot;en&quot;</span> . <span class="string">&quot;tr&quot;</span><span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="string">&quot;nl&quot;</span> . <span class="string">&quot;en&quot;</span><span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="string">&quot;tr&quot;</span> . <span class="string">&quot;en&quot;</span><span class="rainbow-delimiters-depth-4-face">)
          (</span><span class="string">&quot;en&quot;</span> . <span class="string">&quot;nl&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-translate</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Simple `</span><span class="constant">google-translate-smooth-translate</span><span class="doc">' wrapper.
Use C-n C-p to switch between translation directions.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>google-translate-pop-up-buffer-set-focus t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>google-translate-smooth-translate<span class="rainbow-delimiters-depth-5-face">)
       (</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-sozluk</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show definition of the word at point (tr).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">sozluk</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-dictionary</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show definition of the word at point (en).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">wordnut-lookup-current-word</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-etimoloji</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show etymology of the word at point (tr).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">sozluk-etymology</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-etymology</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show etymology of the word at point (en).&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">()
     (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-etymology-en</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: If org mode, show link's text as peek
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-peek-doc</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show documentation at point.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-peek
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">cond</span>
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">ignore-errors</span> <span class="rainbow-delimiters-depth-6-face">(</span>symbol-value <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">lsp-mode</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc--lsp</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="rainbow-delimiters-depth-5-face">(</span>-contains? <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span>emacs-lisp-mode lisp-interaction-mode<span class="rainbow-delimiters-depth-6-face">)</span> major-mode<span class="rainbow-delimiters-depth-5-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc--elisp</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="rainbow-delimiters-depth-5-face">(</span>equal major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">clojure-mode</span><span class="rainbow-delimiters-depth-5-face">)</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc--clojure</span><span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="rainbow-delimiters-depth-5-face">(</span>equal major-mode <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-mode</span><span class="rainbow-delimiters-depth-5-face">)
     (</span><span class="keyword">cond</span>
      <span class="rainbow-delimiters-depth-6-face">(</span>jupyter-org-interaction-mode <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-peek-doc--jupyter</span><span class="rainbow-delimiters-depth-6-face">)
      (</span>t <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">()
           (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">wordnut-lookup-current-word</span><span class="rainbow-delimiters-depth-8-face">)
           (</span>current-buffer<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
    (</span>eldoc-mode <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eldoc-doc-buffer</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Add lsp mode etc.
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-peek-source</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Show source at point.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span>pos<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-peek
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">()
       (</span>call-interactively <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">xref-find-definitions</span><span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">setq</span> pos <span class="rainbow-delimiters-depth-6-face">(</span>line-number-at-pos<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
       (</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-peek-mode-scroll-down <span class="rainbow-delimiters-depth-4-face">(</span>- pos 2<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-doc--elisp</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>help-xref-following t<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>helpful-symbol <span class="rainbow-delimiters-depth-4-face">(</span>symbol-at-point<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>current-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-doc--lsp</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>result
         <span class="comment-delimiter">;; </span><span class="comment">Taken from lsp-describe-thing-at-point
</span>         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-some-&gt;&gt;</span> <span class="rainbow-delimiters-depth-6-face">(</span>lsp--text-document-position-params<span class="rainbow-delimiters-depth-6-face">)
           (</span>lsp--make-request <span class="string">&quot;textDocument/hover&quot;</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>lsp--send-request<span class="rainbow-delimiters-depth-6-face">)
           (</span>lsp:hover-contents<span class="rainbow-delimiters-depth-6-face">)
           (</span>funcall <span class="rainbow-delimiters-depth-7-face">(</span>-flip <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">lsp--render-on-hover-content</span><span class="rainbow-delimiters-depth-7-face">)</span> t<span class="rainbow-delimiters-depth-6-face">)
           (</span>string-trim-right<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">unless</span> result
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="warning">user-error</span> <span class="string">&quot;No doc at point&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">with-current-buffer</span> <span class="rainbow-delimiters-depth-4-face">(</span>get-buffer-create <span class="string">&quot;*im-lsp-md-doc*&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>erase-buffer<span class="rainbow-delimiters-depth-4-face">)
      (</span>insert result<span class="rainbow-delimiters-depth-4-face">)
      (</span>current-buffer<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-doc--clojure</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">save-window-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>cider-doc<span class="rainbow-delimiters-depth-3-face">)
    (</span>current-buffer<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-peek-doc--jupyter</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">save-window-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>jupyter-inspect-at-point<span class="rainbow-delimiters-depth-3-face">)
    (</span>get-buffer <span class="string">&quot;*Help*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-extract
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-extract</span> <span class="rainbow-delimiters-depth-2-face">(</span>files<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Extract each FILES into a folder.
This is a simple wrapper around `</span><span class="constant">aunpack</span><span class="doc">' binary.  It simply
finds the best way to extract and does not overwrite anything.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>dired-get-marked-files<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buff <span class="rainbow-delimiters-depth-5-face">(</span>current-buffer<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-4-face">(</span>im-ensure-binary <span class="string">&quot;aunpack&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;atool&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:args</span> <span class="rainbow-delimiters-depth-4-face">(</span>append <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;--each&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span> files<span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-finish</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>out<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>extracted <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">--keep</span>
                         <span class="rainbow-delimiters-depth-9-face">(</span>s-match <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">: extracted to `</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">'</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string"> (.*)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?&quot;</span> it<span class="rainbow-delimiters-depth-9-face">)
                         (</span>s-split <span class="string">&quot;\n&quot;</span> out t<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">with-current-buffer</span> buff
           <span class="comment-delimiter">;; </span><span class="comment">Dirvish does not kick in after doing the following, I
</span>           <span class="comment-delimiter">;; </span><span class="comment">don't know why. Doing anything on the buffer fixes the
</span>           <span class="comment-delimiter">;; </span><span class="comment">buffer tho.
</span>           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>derived-mode-p <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">dired-mode</span><span class="rainbow-delimiters-depth-8-face">)
             (</span>revert-buffer<span class="rainbow-delimiters-depth-8-face">)
             (</span>dired-goto-file <span class="rainbow-delimiters-depth-9-face">(</span>expand-file-name <span class="rainbow-delimiters-depth-1-face">(</span>nth 2 <span class="rainbow-delimiters-depth-2-face">(</span>car extracted<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span>message <span class="rainbow-delimiters-depth-7-face">(</span>s-join <span class="string">&quot;\n&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>-map <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">car</span> extracted<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:on-fail</span>
     <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="warning">error</span> <span class="string">&quot;&gt;&gt; Extraction failed! See *im-extract* buffer.&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:buffer-name</span> <span class="string">&quot;*im-extract*&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Etymology lookup inside Emacs
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-etymology-en</span> <span class="rainbow-delimiters-depth-2-face">(</span>input<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Find and retrieve the given word etymology from etymonline.
Adapted from: https://babbagefiles.xyz/emacs_etymologies/&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>read-string <span class="string">&quot;Word: &quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>im-region-or <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">word</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>buffer <span class="rainbow-delimiters-depth-5-face">(</span>generate-new-buffer <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;*etymology: %s*&quot;</span> input<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>switch-to-buffer buffer<span class="rainbow-delimiters-depth-3-face">)
    (</span>insert <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="string">&quot;links -dump http://www.etymonline.com/word/&quot;</span> input<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4-face">(</span>re-search-forward <span class="string">&quot;Error 404 (Not Found)&quot;</span> nil t<span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">progn</span>
          <span class="rainbow-delimiters-depth-5-face">(</span>kill-buffer<span class="rainbow-delimiters-depth-5-face">)
          (</span><span class="warning">user-error</span> <span class="string">&quot;Word not found: %s&quot;</span> input<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">progn</span>
        <span class="rainbow-delimiters-depth-5-face">(</span>delete-region <span class="rainbow-delimiters-depth-6-face">(</span>point-min<span class="rainbow-delimiters-depth-6-face">) (</span><span class="keyword">progn</span>
                                     <span class="rainbow-delimiters-depth-7-face">(</span>goto-char <span class="rainbow-delimiters-depth-8-face">(</span>point-min<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                                     (</span>search-forward <span class="string">&quot;[\s\s]&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">ignore-errors</span>
          <span class="rainbow-delimiters-depth-6-face">(</span>delete-region
           <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">progn</span>
             <span class="rainbow-delimiters-depth-8-face">(</span>goto-char <span class="rainbow-delimiters-depth-9-face">(</span>point-max<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
             (</span>search-backward-regexp <span class="string">&quot;See all related words&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
           (</span>point-max<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>goto-char <span class="rainbow-delimiters-depth-4-face">(</span>point-min<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> My git configuration
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-git-use/apply-my/personal-config</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Configure current repo to use my personal (non-work) git info.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">ignore-errors</span>
    <span class="rainbow-delimiters-depth-3-face">(</span>lab-git-origin-switch-to-ssh<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>shell-command-to-string <span class="string">&quot;git config user.name \&quot;Isa Mert Gurbuz\&quot;&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>shell-command-to-string <span class="string">&quot;git config user.email \&quot;isamertgurbuz@gmail.com\&quot;&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>message <span class="string">&quot;Done.&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Scratch project
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have a project pre-configured for scratch files. Like default
</span><span class="comment-delimiter">;; </span><span class="comment">scratch buffer, I also have different files for different languages
</span><span class="comment-delimiter">;; </span><span class="comment">that I use similarly to the scratch buffer. Due to the nature of
</span><span class="comment-delimiter">;; </span><span class="comment">other languages, it's not possible to have a simple buffer. Rather,
</span><span class="comment-delimiter">;; </span><span class="comment">I have to have a concrete file.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defvar</span> <span class="variable-name">im-scratch-project-path</span> <span class="string">&quot;~/Workspace/temp/scratch/&quot;</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-initialize-scratch-project</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Initialize a project where scratch files are kept.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-3-face">(</span>f-exists? im-scratch-project-path<span class="rainbow-delimiters-depth-3-face">)
    (</span>f-mkdir-full-path im-scratch-project-path<span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Create scratch.ts
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>f-write-text <span class="string">&quot;import * as R from '</span><span class="constant">npm:ramda</span><span class="string">';&quot;</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">utf-8</span> <span class="rainbow-delimiters-depth-4-face">(</span>f-join im-scratch-project-path <span class="string">&quot;scratch.ts&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>f-write-text <span class="string">&quot;;;; Directory Local Variables            -*- no-byte-compile: t -*-
  ;;; For more information see (info \&quot;(emacs) Directory Variables\&quot;)

  ((typescript-ts-mode . ((lsp-enabled-clients . (deno-ls)))))&quot;</span>
                  <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">utf-8</span> <span class="rainbow-delimiters-depth-4-face">(</span>f-join im-scratch-project-path <span class="string">&quot;.dir-locals.el&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Configure the project
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>default-directory im-scratch-project-path<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>shell-command-to-string <span class="string">&quot;git init&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; scratch project is ready!&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">after-init-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-initialize-scratch-project</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> YAML &lt;-&gt; JSON conversation
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-yaml-to-json</span> <span class="rainbow-delimiters-depth-2-face">(</span>yaml <span class="type">&amp;optional</span> replace?<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert YAML to JSON.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>im-region-or <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">string</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>json <span class="rainbow-delimiters-depth-5-face">(</span>im-kill <span class="rainbow-delimiters-depth-6-face">(</span>json-encode <span class="rainbow-delimiters-depth-7-face">(</span>yaml-parse-string yaml<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> replace? <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>replace-region-contents
       <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">)
       (</span>region-end<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()</span> json<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-json-to-yaml</span> <span class="rainbow-delimiters-depth-2-face">(</span>json <span class="type">&amp;optional</span> replace?<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Convert JSON to YAML.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>im-region-or <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">string</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>yaml <span class="rainbow-delimiters-depth-5-face">(</span>im-kill <span class="rainbow-delimiters-depth-6-face">(</span>yaml-encode <span class="rainbow-delimiters-depth-7-face">(</span>json-parse-string yaml<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> replace? <span class="rainbow-delimiters-depth-5-face">(</span>use-region-p<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>replace-region-contents
       <span class="rainbow-delimiters-depth-5-face">(</span>region-beginning<span class="rainbow-delimiters-depth-5-face">)
       (</span>region-end<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">()</span> yaml<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-test -- test related utility functions
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-test-run-code-coverage-report</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Run all tests and then open coverage.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-open-test-code-coverage-report t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-test-run-current-test-only</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Run currently focused test only.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-test-run-current-test-file t<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-test-open-code-coverage-report</span> <span class="rainbow-delimiters-depth-2-face">(</span>run-test-before<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Open code coverage report for current project.
With RUN-TEST-BEFORE is non-nil, then run tests before and then
open coverage.  You can simply call \&quot;gf\&quot; or
`</span><span class="constant">xah-open-file-at-cursor</span><span class="doc">' to navigate to a file shown on the
output.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
        (</span>cov-file <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;file://%s/coverage/lcov-report/index.html&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">if</span> run-test-before
        <span class="rainbow-delimiters-depth-4-face">(</span>im-shell-command
         <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">pcase</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-test-get-nodejs-test-program<span class="rainbow-delimiters-depth-6-face">)
                    (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jest</span> <span class="string">&quot;yarn jest --coverage --colors&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                    (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vitest</span> <span class="string">&quot;FORCE_COLOR=1 yarn vitest --coverage --run&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
         <span class="builtin">:buffer-name</span> <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s-test-cov&quot;</span> <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-name<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
         <span class="builtin">:switch</span> t
         <span class="builtin">:on-finish</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-6-face">) (</span>browse-url-default-browser cov-file<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
         <span class="builtin">:on-fail</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-6-face">) (</span><span class="warning">user-error</span> <span class="string">&quot;&gt;&gt; Tests are failed!&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>browse-url-default-browser cov-file<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-test-run-current-test-file</span> <span class="rainbow-delimiters-depth-2-face">(</span>run-only-focused-test<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Run the current test file.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="string">&quot;P&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">cond</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>locate-dominating-file <span class="string">&quot;.&quot; &quot;yarn.lock&quot;</span><span class="rainbow-delimiters-depth-4-face">) (</span>im-test-run-current-file--yarn run-only-focused-test<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span><span class="rainbow-delimiters-depth-4-face">(</span>locate-dominating-file <span class="string">&quot;.&quot; &quot;pom.xml&quot;</span><span class="rainbow-delimiters-depth-4-face">) (</span>im-test-run-current-file--mvn run-only-focused-test<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
   (</span>t <span class="rainbow-delimiters-depth-4-face">(</span><span class="warning">user-error</span> <span class="string">&quot;This project type is not recognized&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-test-get-nodejs-test-program</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Return either `</span><span class="constant">vitest</span><span class="doc">' or `</span><span class="constant">yarn</span><span class="doc">'.
Throw error otherwise.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let-alist</span> <span class="rainbow-delimiters-depth-3-face">(</span>json-read-file <span class="rainbow-delimiters-depth-4-face">(</span>f-join <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;package.json&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">and</span> .devDependencies.vitest <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vitest</span><span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="keyword">and</span> .devDependencies.jest <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jest</span><span class="rainbow-delimiters-depth-4-face">)
        (</span><span class="warning">user-error</span> <span class="string">&quot;Not a jest or vitest file project!&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-test-run-current-file--yarn</span> <span class="rainbow-delimiters-depth-2-face">(</span>run-only-focused-test<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>test-file <span class="rainbow-delimiters-depth-5-face">(</span>file-relative-name buffer-file-name <span class="rainbow-delimiters-depth-6-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>program <span class="rainbow-delimiters-depth-5-face">(</span>im-test-get-nodejs-test-program<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>current-test-name
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">ignore-errors</span>
            <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-excursion</span>
              <span class="rainbow-delimiters-depth-7-face">(</span>end-of-line<span class="rainbow-delimiters-depth-7-face">)
              (</span>re-search-backward <span class="string">&quot;it(['\&quot;]&quot;</span> nil t<span class="rainbow-delimiters-depth-7-face">)
              (</span>nth 1 <span class="rainbow-delimiters-depth-8-face">(</span>s-match <span class="string">&quot;it(['\&quot;]</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">['\&quot;],&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-1-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">pcase</span> program
      <span class="rainbow-delimiters-depth-4-face">(</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">vitest</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>switch-to-buffer-other-window
        <span class="rainbow-delimiters-depth-6-face">(</span>apply
         <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eat-make</span>
         <span class="rainbow-delimiters-depth-7-face">(</span>format
          <span class="string">&quot;yarn test: %s%s&quot;</span> test-file
          <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> run-only-focused-test <span class="rainbow-delimiters-depth-9-face">(</span>concat <span class="string">&quot;::&quot;</span> current-test-name<span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
         <span class="string">&quot;yarn&quot;</span>
         nil
         <span class="string">&quot;vitest&quot;</span>
         test-file
         <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">and</span> run-only-focused-test current-test-name<span class="rainbow-delimiters-depth-8-face">)
           (</span>list <span class="string">&quot;--testNamePattern&quot;</span> current-test-name<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">jest</span>
       <span class="rainbow-delimiters-depth-5-face">(</span>switch-to-buffer-other-window
        <span class="rainbow-delimiters-depth-6-face">(</span>apply
         <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">eat-make</span>
         <span class="rainbow-delimiters-depth-7-face">(</span>format
          <span class="string">&quot;yarn test: %s%s&quot;</span> test-file
          <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> run-only-focused-test <span class="rainbow-delimiters-depth-9-face">(</span>concat <span class="string">&quot;::&quot;</span> current-test-name<span class="rainbow-delimiters-depth-9-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
         <span class="string">&quot;yarn&quot;</span>
         nil
         <span class="string">&quot;jest&quot;
         &quot;--colors&quot;
         &quot;--runTestsByPath&quot;</span>
         test-file
         <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">and</span> run-only-focused-test current-test-name<span class="rainbow-delimiters-depth-8-face">)
           (</span>list current-test-name<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-test-run-current-file--mvn</span> <span class="rainbow-delimiters-depth-2-face">(</span>run-only-focused-test<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>test-file buffer-file-name<span class="rainbow-delimiters-depth-4-face">)
         (</span>default-directory <span class="rainbow-delimiters-depth-5-face">(</span>im-current-project-root<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>current-test-class
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">save-excursion</span>
            <span class="rainbow-delimiters-depth-6-face">(</span>goto-char <span class="rainbow-delimiters-depth-7-face">(</span>point-min<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
            (</span>search-forward-regexp <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">public </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?class </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[A-Za-z0-9_]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> &quot;</span> nil t<span class="rainbow-delimiters-depth-6-face">)
            (</span>beginning-of-line<span class="rainbow-delimiters-depth-6-face">)
            (</span>nth 1 <span class="rainbow-delimiters-depth-7-face">(</span>s-match <span class="string">&quot;class </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[A-Za-z0-9_]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string"> &quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-9-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>current-test-name
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">ignore-errors</span>
            <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-excursion</span>
              <span class="rainbow-delimiters-depth-7-face">(</span>end-of-line<span class="rainbow-delimiters-depth-7-face">)
              (</span>re-search-backward <span class="string">&quot;@Test&quot;</span> nil t<span class="rainbow-delimiters-depth-7-face">)
              (</span>forward-line<span class="rainbow-delimiters-depth-7-face">)
              (</span>nth 1 <span class="rainbow-delimiters-depth-8-face">(</span>s-match <span class="string">&quot; </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[A-Za-z0-9_]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">(&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>substring-no-properties <span class="rainbow-delimiters-depth-1-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>im-shell-command
     <span class="builtin">:command</span> <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;./mvnw test --offline -Dstyle.color=always -Djansi.force=true -Dtest='</span><span class="constant">%s%s</span><span class="string">'&quot;</span>
                      current-test-class
                      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> run-only-focused-test current-test-name<span class="rainbow-delimiters-depth-6-face">)
                          (</span>format <span class="string">&quot;#%s&quot;</span> current-test-name<span class="rainbow-delimiters-depth-6-face">)</span>
                        <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
     <span class="builtin">:switch</span> t<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> NextCloud integration
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Contacts
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-nextcloud-put-contact</span> <span class="rainbow-delimiters-depth-2-face">(</span>vcard <span class="type">&amp;key</span> on-success on-error<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Add given VCARD definition to my Nextcloud contacts.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>uuid <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
               vcard
               <span class="rainbow-delimiters-depth-6-face">(</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
               (</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-prefix? <span class="string">&quot;UID&quot;</span> it<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
               (</span>s-split <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
               -last-item<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>request <span class="rainbow-delimiters-depth-4-face">(</span>format
              <span class="string">&quot;%s/remote.php/dav/addressbooks/users/%s/contacts/%s.vcf&quot;</span>
              im-nextcloud-url im-nextcloud-user uuid<span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:headers</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="string">&quot;Content-Type&quot;</span> . <span class="string">&quot;text/vcard; charset=utf-8;&quot;</span><span class="rainbow-delimiters-depth-5-face">)
                 (</span><span class="string">&quot;Authorization&quot;</span> . ,<span class="rainbow-delimiters-depth-6-face">(</span>concat <span class="string">&quot;Basic &quot;</span> im-nextcloud-auth<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:type</span> <span class="string">&quot;PUT&quot;</span>
      <span class="builtin">:data</span> vcard
      <span class="builtin">:success</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">) (</span><span class="keyword">when</span> on-success <span class="rainbow-delimiters-depth-6-face">(</span>funcall on-success<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:error</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-5-face">) (</span><span class="keyword">when</span> on-error <span class="rainbow-delimiters-depth-6-face">(</span>funcall on-error _<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Maps
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">cl-defun</span> <span class="function-name">im-nextcloud-maps-put-favorite</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;key</span> id name lat lng category comment<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Create or update a favorite named NAME.
NAME, LAT, LNG, CATEGORY, COMMENT are required.

If ID is non-nil, then the favorite with ID is updated, otherwise
a new favorite is created.

This function returns a promise.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>im-request-json-async
   <span class="rainbow-delimiters-depth-3-face">(</span>format
    <span class="string">&quot;%s/index.php/apps/maps/api/1.0/favorites%s&quot;</span>
    im-nextcloud-url
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">if</span> id <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;/%s&quot;</span> id<span class="rainbow-delimiters-depth-5-face">)</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:headers</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;Authorization&quot;</span> . ,<span class="rainbow-delimiters-depth-5-face">(</span>concat <span class="string">&quot;Basic &quot;</span> im-nextcloud-auth<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:type</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">if</span> id <span class="string">&quot;PUT&quot; &quot;POST&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:data</span> <span class="rainbow-delimiters-depth-3-face">(</span>json-encode
          <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>name . ,name<span class="rainbow-delimiters-depth-5-face">)
            (</span>lat . ,lat<span class="rainbow-delimiters-depth-5-face">)
            (</span>lng . ,lng<span class="rainbow-delimiters-depth-5-face">)
            (</span>category . ,category<span class="rainbow-delimiters-depth-5-face">)
            (</span>comment . ,comment<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">async-defun</span> <span class="function-name">im-nextcloud-maps-remove-all-favorites</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Delete ALL favorites from Nextcloud Maps.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">dolist</span> <span class="rainbow-delimiters-depth-3-face">(</span>id <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">--map</span>
               <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">id</span> it<span class="rainbow-delimiters-depth-5-face">)
               (</span>await <span class="rainbow-delimiters-depth-6-face">(</span>im-request-json-async
                       <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;%s/index.php/apps/maps/api/1.0/favorites&quot;</span> im-nextcloud-url<span class="rainbow-delimiters-depth-7-face">)</span>
                       <span class="builtin">:headers</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span><span class="string">&quot;Authorization&quot;</span> . ,<span class="rainbow-delimiters-depth-9-face">(</span>concat <span class="string">&quot;Basic &quot;</span> im-nextcloud-auth<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; Removing %s...&quot;</span> id<span class="rainbow-delimiters-depth-3-face">)
    (</span>await
     <span class="rainbow-delimiters-depth-4-face">(</span>im-request-json-async
      <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;%s/index.php/apps/maps/api/1.0/favorites/%s&quot;</span> im-nextcloud-url id<span class="rainbow-delimiters-depth-5-face">)</span>
      <span class="builtin">:type</span> <span class="string">&quot;DELETE&quot;</span>
      <span class="builtin">:headers</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="string">&quot;Authorization&quot;</span> . ,<span class="rainbow-delimiters-depth-7-face">(</span>concat <span class="string">&quot;Basic &quot;</span> im-nextcloud-auth<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; Removing %s...Done&quot;</span> id<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">Remove all NC_IDs too
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">save-restriction</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>widen<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>delete-matching-lines <span class="string">&quot;:NC_ID:&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-nextcloud-maps-add-all-in-buffer</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Add all GEO entries to Nextcloud Maps favorites.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>org-map-entries
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-4-face">() (</span>im-nextcloud-maps-put-favorite-from-org<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">async-defun</span> <span class="function-name">im-nextcloud-maps-put-favorite-from-org</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Create or update map favorite under cursor.
A favorite is defined as an entry with GEO property, containing
an org geo: link.

If NC_ID property is non-nil, then favorite with NC_ID id is
updated, otherwise it a new favorite is created and then the
NC_ID property is set to the entry.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">-when-let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>prop <span class="rainbow-delimiters-depth-5-face">(</span>org-entry-get nil <span class="string">&quot;GEO&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
               (</span><span class="rainbow-delimiters-depth-5-face">(</span>_ lat lng _z address<span class="rainbow-delimiters-depth-5-face">) (</span>s-match <span class="string">&quot;\\[\\[geo:</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9\\.]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">,</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9\\.]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">;z=</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">[0-9]+</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]\\[</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">\\]\\]&quot;</span> prop<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>nc-id <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">-some-&gt;&gt;</span> <span class="rainbow-delimiters-depth-7-face">(</span>org-entry-get nil <span class="string">&quot;NC_ID&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                    (</span>string-to-number<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>name <span class="rainbow-delimiters-depth-6-face">(</span>org-entry-get nil <span class="string">&quot;ITEM&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>id <span class="rainbow-delimiters-depth-6-face">(</span>org-id-get-create<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span>result <span class="rainbow-delimiters-depth-6-face">(</span>await
                    <span class="rainbow-delimiters-depth-7-face">(</span>im-nextcloud-maps-put-favorite
                     <span class="builtin">:id</span> nc-id
                     <span class="builtin">:name</span> name
                     <span class="builtin">:lat</span> lat
                     <span class="builtin">:lng</span> lng
                     <span class="comment-delimiter">;; </span><span class="default-0035">TODO</span><span class="comment">: Multiple tags/categories are not supported in upstream.
</span>                     <span class="comment-delimiter">;; </span><span class="comment">See https://github.com/nextcloud/maps/issues/1154
</span>                     <span class="builtin">:category</span> <span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>org-get-tags<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span>
                     <span class="builtin">:comment</span>
                     <span class="rainbow-delimiters-depth-8-face">(</span>format
                      <span class="string">&quot;- Created at :: %s\n- Tags :: %s\n\n%s&quot;</span>
                      <span class="rainbow-delimiters-depth-9-face">(</span>org-entry-get nil <span class="string">&quot;CREATED_AT&quot;</span><span class="rainbow-delimiters-depth-9-face">)
                      (</span>org-entry-get nil <span class="string">&quot;TAGS&quot;</span><span class="rainbow-delimiters-depth-9-face">)
                      (</span>org-agenda-get-some-entry-text <span class="rainbow-delimiters-depth-1-face">(</span>point-marker<span class="rainbow-delimiters-depth-1-face">)</span> most-positive-fixnum<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">if</span> nc-id
          <span class="rainbow-delimiters-depth-5-face">(</span>message <span class="string">&quot;&gt;&gt; Updated map info.&quot;</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">let-alist</span> result
          <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">save-window-excursion</span>
            <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">save-excursion</span>
              <span class="rainbow-delimiters-depth-8-face">(</span>org-id-goto id<span class="rainbow-delimiters-depth-8-face">)
              (</span>org-set-property <span class="string">&quot;NC_ID&quot;</span> <span class="rainbow-delimiters-depth-9-face">(</span>number-to-string .id<span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>message <span class="string">&quot;&gt;&gt; Updated %s with NC_ID=%s.&quot;</span> name .id<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-nextcloud-maps--on-org-entry-changed</span> <span class="rainbow-delimiters-depth-2-face">(</span>info<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">save-excursion</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">save-restriction</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>widen<span class="rainbow-delimiters-depth-4-face">)
      (</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>plist-get info <span class="builtin">:begin</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>im-nextcloud-maps-put-favorite-from-org<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">im-org-header-changed-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-nextcloud-maps--on-org-entry-changed</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Shopping Mode
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have a simple shopping list that I sync with my phone. This is a
</span><span class="comment-delimiter">;; </span><span class="comment">simple mode for easier editing on that file.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">define-derived-mode</span> <span class="function-name">alisveris-mode</span> markdown-mode <span class="string">&quot;AlisverisMode&quot;</span>
  <span class="doc">&quot;Mode for my shopping list.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq-local</span> header-line-format <span class="rainbow-delimiters-depth-3-face">(</span>substitute-command-keys <span class="string">&quot;Bindings :: \\[</span><span class="constant">im-alisveris-add-to-market</span><span class="string">] → Market&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">general-def</span> <span class="builtin">:keymaps</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">alisveris-mode-map</span> <span class="builtin">:states</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">normal</span>
  <span class="string">&quot;\\a&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-alisveris-add-to-market</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-alisveris-add-to-market</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Add current item to market alisverisi.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> nil im-alisveris-mode<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>thing <span class="rainbow-delimiters-depth-5-face">(</span>s-trim <span class="rainbow-delimiters-depth-6-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">line</span> t<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">save-excursion</span>
      <span class="rainbow-delimiters-depth-4-face">(</span>goto-char <span class="rainbow-delimiters-depth-5-face">(</span>point-min<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>search-forward-regexp <span class="string">&quot;^## Market&quot;</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>insert <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;\n%s&quot;</span> thing<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>message <span class="string">&quot;Done.&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> im-tuir  -- Emacs tuir (reddit terminal viewer) wrapper
</span>
<span class="comment-delimiter">;; </span><span class="comment">Tuir can be installed like:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src sh
</span><span class="comment-delimiter">;; </span><span class="comment">python3 -m venv .
</span><span class="comment-delimiter">;; </span><span class="comment">bin/activate
</span><span class="comment-delimiter">;; </span><span class="comment">python3 -m pip install tuir-continued
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">I had to change the ~open_browser~ function of tuir so that it works
</span><span class="comment-delimiter">;; </span><span class="comment">properly on MacOS.
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">The file can be found under:
</span><span class="comment-delimiter">;; </span><span class="comment">=tuir/lib/python3.12/site-packages/tuir/terminal.py=
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">#+begin_src python
</span><span class="comment-delimiter">;; </span><span class="comment">def open_browser(self, url):
</span><span class="comment-delimiter">;;     </span><span class="comment">with self.suspend():
</span><span class="comment-delimiter">;;         </span><span class="comment">if self.config['</span><span class="constant">force_new_browser_window</span><span class="comment">']:
</span><span class="comment-delimiter">;;             </span><span class="comment">webbrowser.open_new(url)
</span><span class="comment-delimiter">;;         </span><span class="comment">else:
</span><span class="comment-delimiter">;;             </span><span class="comment">webbrowser.open_new_tab(url)
</span><span class="comment-delimiter">;; </span><span class="comment">#+end_src
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-tuir</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> link<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;A wrapper for terminal `</span><span class="constant">tuir</span><span class="doc">' command.
If LINK is non-nil, then open the link instead of homepage.  Calling
this function without a link should open the already existing tuir
buffer, otherwise it will create one.  Calling it with link kills the
existing buffer and opens the link in tuir.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">cond</span>
     <span class="rainbow-delimiters-depth-5-face">(</span><span class="rainbow-delimiters-depth-6-face">(</span>s-starts-with? <span class="string">&quot;*reddigg-&quot;</span> <span class="rainbow-delimiters-depth-7-face">(</span>buffer-name<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
      (</span><span class="keyword">save-excursion</span>
        <span class="rainbow-delimiters-depth-7-face">(</span>goto-char <span class="rainbow-delimiters-depth-8-face">(</span>point-min<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
        (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-8-face">(</span>re-search-forward <span class="string">&quot;https://</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">www\\.</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?reddit.com&quot;</span><span class="rainbow-delimiters-depth-8-face">)
          (</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
     (</span>t <span class="rainbow-delimiters-depth-6-face">(</span>thing-at-point <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">url</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">require</span> <span class="highlight-quoted-quote">'</span><span class="constant">eat</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-4-face">(</span>not link<span class="rainbow-delimiters-depth-4-face">) (</span>get-buffer <span class="string">&quot;*tuir*&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
      (</span>switch-to-buffer <span class="string">&quot;*tuir*&quot;</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>eat-buffer-name <span class="string">&quot;*tuir*&quot;</span><span class="rainbow-delimiters-depth-5-face">)
          (</span>eat-kill-buffer-on-exit t<span class="rainbow-delimiters-depth-5-face">)
          (</span>evil-default-state <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">insert</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">and</span> link <span class="rainbow-delimiters-depth-6-face">(</span>get-buffer <span class="string">&quot;*tuir*&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
        (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>kill-buffer-query-functions nil<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>kill-buffer <span class="string">&quot;*tuir*&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span>eat
       <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>path <span class="string">&quot;~/workspace/apps/tuir/bin/tuir&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
         (</span><span class="keyword">if</span> link
             <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;%s '</span><span class="constant">%s</span><span class="string">'&quot;</span> path link<span class="rainbow-delimiters-depth-7-face">)</span>
           path<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
      (</span><span class="keyword">with-current-buffer</span> <span class="string">&quot;*tuir*&quot;</span>
        <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">setq-local</span> evil-escape-inhibit t<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Global Mode Line formatting
</span>
<span class="comment-delimiter">;; </span><span class="comment">Automatically format global mode-line just like I wanted.  There is
</span><span class="comment-delimiter">;; </span><span class="comment">no easy way of editing the order of items inside
</span><span class="comment-delimiter">;; </span><span class="comment">`</span><span class="constant">global-mode-string</span><span class="comment">' and no really way to inject adjacent items to
</span><span class="comment-delimiter">;; </span><span class="comment">already existing items.  So I simply format it just like what I
</span><span class="comment-delimiter">;; </span><span class="comment">want periodically.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">when</span> tab-bar-show
  <span class="rainbow-delimiters-depth-2-face">(</span>run-at-time 10 45 <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-update-global-mode-line</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-update-global-mode-line</span> <span class="rainbow-delimiters-depth-2-face">(</span><span class="type">&amp;optional</span> force<span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>all-the-icons-default-adjust 0<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span>
     global-mode-string
     <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-4-face">(</span><span class="string">&quot;&quot;</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> im-is-mic-muted?
           <span class="rainbow-delimiters-depth-6-face">(</span>list
            <span class="rainbow-delimiters-depth-7-face">(</span>all-the-icons-faicon <span class="string">&quot;microphone-slash&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
            <span class="string">&quot; | &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">bound-and-true-p</span> appt-mode-string<span class="rainbow-delimiters-depth-6-face">)
           (</span>list
            <span class="rainbow-delimiters-depth-7-face">(</span>all-the-icons-faicon <span class="string">&quot;calendar-check-o&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
            <span class="string">&quot; &quot;</span>
            appt-mode-string<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">and</span> <span class="rainbow-delimiters-depth-7-face">(</span>functionp <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">org-clocking-p</span><span class="rainbow-delimiters-depth-7-face">) (</span>org-clocking-p<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>list
            <span class="rainbow-delimiters-depth-7-face">(</span>all-the-icons-fileicon <span class="string">&quot;org&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
            <span class="string">&quot; &quot;</span>
            org-mode-line-string<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span>
       ,@<span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">when</span> display-time-string
           <span class="rainbow-delimiters-depth-6-face">(</span>list
            <span class="rainbow-delimiters-depth-7-face">(</span>all-the-icons-wicon
             <span class="rainbow-delimiters-depth-8-face">(</span>format <span class="string">&quot;time-%s&quot;</span>
                     <span class="comment-delimiter">;; </span><span class="comment">Convert to number first so that leading 0s are stripped away
</span>                     <span class="rainbow-delimiters-depth-9-face">(</span>string-to-number <span class="rainbow-delimiters-depth-1-face">(</span>format-time-string <span class="string">&quot;%I&quot;</span><span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span>
            <span class="string">&quot; &quot;</span>
            display-time-string<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">when</span> force
    <span class="rainbow-delimiters-depth-3-face">(</span>force-mode-line-update<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">with-eval-after-load</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org</span>
  <span class="rainbow-delimiters-depth-2-face">(</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-clock-in-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-update-global-mode-line</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-clock-out-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-update-global-mode-line</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Operating system related
</span>
<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Sound/audio output chooser
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-osx-select-audio-output</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:cmd</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-ensure-binary <span class="string">&quot;SwitchAudioSource -t output -a&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;switchaudio-osx&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>current <span class="rainbow-delimiters-depth-6-face">(</span>im-shell-command-to-string <span class="string">&quot;SwitchAudioSource -t output -c&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
             (</span>format <span class="string">&quot;Select audio output (%s): &quot;</span> current<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
         <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;SwitchAudioSource -t output -s '</span><span class="constant">%s</span><span class="string">'&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span><span class="keyword">when-let</span> <span class="rainbow-delimiters-depth-5-face">(</span>out <span class="rainbow-delimiters-depth-6-face">(</span>-find <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>out<span class="rainbow-delimiters-depth-8-face">) (</span>equal it out<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
                               (</span>s-split <span class="string">&quot;\n&quot;</span> <span class="rainbow-delimiters-depth-8-face">(</span>shell-command-to-string <span class="string">&quot;SwitchAudioSource -t input -a&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
           (</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-6-face">(</span>y-or-n-p <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;Found an output with the same name (%s), switch to it?&quot;</span> out<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
             (</span>shell-command-to-string <span class="rainbow-delimiters-depth-7-face">(</span>format <span class="string">&quot;SwitchAudioSource -t input -s '</span><span class="constant">%s</span><span class="string">'&quot;</span> out<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-osx-select-audio-input</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:cmd</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-ensure-binary <span class="string">&quot;SwitchAudioSource -t input -a&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;switchaudio-osx&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:prompt</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>current <span class="rainbow-delimiters-depth-6-face">(</span>im-shell-command-to-string <span class="string">&quot;SwitchAudioSource -t input -c&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
             (</span>format <span class="string">&quot;Select audio input (%s): &quot;</span> current<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;SwitchAudioSource -t input -s '</span><span class="constant">%s</span><span class="string">'&quot;</span> it<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-linux-select-audio-output</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>sink
         <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
          <span class="rainbow-delimiters-depth-6-face">(</span>shell-command-to-string
           <span class="string">&quot;pactl list sinks | grep -E '</span><span class="constant">Name|device.description</span><span class="string">' | cut -d: -f2 | cut -d= -f2 | tr -d '</span><span class="constant">\&quot;</span><span class="string">'&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>s-trim<span class="rainbow-delimiters-depth-6-face">)
          (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">s-trim</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>-partition 2<span class="rainbow-delimiters-depth-6-face">)
          (</span>mapcar <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">nreverse</span><span class="rainbow-delimiters-depth-6-face">)
          (</span>im-alist-completing-read <span class="string">&quot;Select sink: &quot;</span><span class="rainbow-delimiters-depth-6-face">)</span>
          car<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Set default sink
</span>    <span class="rainbow-delimiters-depth-3-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-4-face">(</span>format <span class="string">&quot;pactl set-default-sink %s&quot;</span> sink<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Move inputs to the new sink
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span>
     <span class="rainbow-delimiters-depth-4-face">(</span>shell-command-to-string <span class="string">&quot;pactl list short sink-inputs | cut -d'</span><span class="constant">\t</span><span class="string">' -f1&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>s-trim<span class="rainbow-delimiters-depth-4-face">)
     (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>shell-command-to-string <span class="rainbow-delimiters-depth-6-face">(</span>format <span class="string">&quot;pactl move-sink-input %s %s&quot;</span> it sink<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-select-audio-output</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-when-on</span>
   <span class="builtin">:linux</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-linux-select-audio-output<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:darwin</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-osx-select-audio-output<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-select-audio-input</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-when-on</span>
   <span class="builtin">:linux</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-linux-select-audio-input<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:darwin</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-osx-select-audio-input<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defvar</span> <span class="variable-name">im-is-mic-muted?</span> nil<span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-set-mic-status</span> <span class="rainbow-delimiters-depth-2-face">(</span>status<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Set mic status to STATUS.
STATUS is either mute, unmute or toggle.

Asks for STATUS if called interactively.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>list
    <span class="rainbow-delimiters-depth-4-face">(</span>s-chop-suffix
     <span class="string">&quot;d&quot;</span> <span class="rainbow-delimiters-depth-5-face">(</span>cadr <span class="rainbow-delimiters-depth-6-face">(</span>read-multiple-choice <span class="string">&quot;Your mic should be &quot;</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="rainbow-delimiters-depth-8-face">(</span>?m <span class="string">&quot;muted&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>?u <span class="string">&quot;unmuted&quot;</span><span class="rainbow-delimiters-depth-8-face">) (</span>?t <span class="string">&quot;toggled&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-when-on</span>
   <span class="builtin">:linux</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="warning">user-error</span> <span class="string">&quot;Not implemented for gnu/linux&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:darwin</span>
   <span class="rainbow-delimiters-depth-3-face">(</span>set-process-filter
    <span class="rainbow-delimiters-depth-4-face">(</span>start-process <span class="string">&quot;*SwitchAudioSourceMic*&quot; &quot;*SwitchAudioSourceMic*&quot;
                   &quot;SwitchAudioSource&quot; &quot;-t&quot; &quot;input&quot; &quot;-m&quot;</span> status<span class="rainbow-delimiters-depth-4-face">)
    (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>proc out<span class="rainbow-delimiters-depth-5-face">)
      (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>status <span class="rainbow-delimiters-depth-8-face">(</span>car <span class="rainbow-delimiters-depth-9-face">(</span>s-match <span class="string">&quot;</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">un</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?muted</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>s-trim out<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>muted? <span class="rainbow-delimiters-depth-8-face">(</span>equal status <span class="string">&quot;muted&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)
             (</span>icon <span class="rainbow-delimiters-depth-8-face">(</span><span class="keyword">if</span> muted? <span class="string">&quot;🔇&quot; &quot;🔊&quot;</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-7-face">(</span>frame-focus-state<span class="rainbow-delimiters-depth-7-face">)
          (</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-8-face">(</span><span class="rainbow-delimiters-depth-9-face">(</span>alert-fade-time 5<span class="rainbow-delimiters-depth-9-face">)
                (</span>alert-default-style <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">osx-notifier</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)
            (</span>alert icon
                   <span class="builtin">:title</span> <span class="rainbow-delimiters-depth-9-face">(</span>format <span class="string">&quot;Mic is %s&quot;</span> status<span class="rainbow-delimiters-depth-9-face">)</span>
                   <span class="builtin">:persistent</span> nil
                   <span class="builtin">:never-persist</span> t<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="keyword">setq</span> im-is-mic-muted? muted?<span class="rainbow-delimiters-depth-6-face">)
        (</span>im-update-global-mode-line <span class="builtin">:force</span><span class="rainbow-delimiters-depth-6-face">)
        (</span>message
         <span class="string">&quot;Your mic is %s %s&quot;</span>
         <span class="rainbow-delimiters-depth-7-face">(</span>propertize status <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">face</span> <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">bold</span><span class="rainbow-delimiters-depth-7-face">)</span>
         icon<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-toggle-mic</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Toggle the mute status of your microphone.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>im-set-mic-status <span class="string">&quot;toggle&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;em&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-toggle-mic</span>
  <span class="string">&quot;eM&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-set-mic-status</span>
  <span class="string">&quot;ea&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-select-audio-output</span>
  <span class="string">&quot;eA&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-select-audio-input</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Bluetooth device connector
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-osx-connect-paired-bluetooth-device</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-output-select</span>
   <span class="builtin">:prompt</span> <span class="string">&quot;Select Bluetooth device: &quot;</span>
   <span class="builtin">:cmd</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-ensure-binary <span class="string">&quot;blueutil --paired&quot;</span><span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:formatter</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">-&gt;&gt;</span> it
                   <span class="rainbow-delimiters-depth-4-face">(</span>s-split <span class="string">&quot;, &quot;</span><span class="rainbow-delimiters-depth-4-face">)
                   (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-5-face">(</span>s-split <span class="string">&quot;:&quot;</span> it<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
                   (</span><span class="keyword">--find</span> <span class="rainbow-delimiters-depth-5-face">(</span>equal <span class="rainbow-delimiters-depth-6-face">(</span>car it<span class="rainbow-delimiters-depth-6-face">)</span> <span class="string">&quot;name&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span>
                   cadr
                   <span class="rainbow-delimiters-depth-4-face">(</span>s-replace <span class="string">&quot;\&quot;&quot; &quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
                   s-trim<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:filter</span> <span class="rainbow-delimiters-depth-3-face">(</span>s-contains? <span class="string">&quot;not connected&quot;</span> it<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:keep-order</span> nil
   <span class="builtin">:do</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>id <span class="rainbow-delimiters-depth-6-face">(</span><span class="keyword">-&gt;&gt;</span> <span class="rainbow-delimiters-depth-7-face">(</span>s-split <span class="string">&quot;,&quot;</span> it<span class="rainbow-delimiters-depth-7-face">)</span> car <span class="rainbow-delimiters-depth-7-face">(</span>s-split <span class="string">&quot;:&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span> cadr s-trim<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>message <span class="string">&quot;&gt;&gt; Connecting to %s...&quot;</span> id<span class="rainbow-delimiters-depth-4-face">)
         (</span>shell-command-to-string <span class="rainbow-delimiters-depth-5-face">(</span>format <span class="string">&quot;blueutil --connect %s&quot;</span> id<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>message <span class="string">&quot;&gt;&gt; Connecting to %s...Connected.&quot;</span> id<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-linux-connect-paired-bluetooth-device</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>paired-devices <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
                          <span class="rainbow-delimiters-depth-6-face">(</span>im-ensure-binary <span class="string">&quot;bluetoothctl devices Paired&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;bluez-utils&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                          (</span>shell-command-to-string<span class="rainbow-delimiters-depth-6-face">)
                          (</span>s-trim<span class="rainbow-delimiters-depth-6-face">)
                          (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>connected-devices <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
                             <span class="rainbow-delimiters-depth-6-face">(</span>shell-command-to-string <span class="string">&quot;bluetoothctl devices Connected&quot;</span><span class="rainbow-delimiters-depth-6-face">)
                             (</span>s-trim<span class="rainbow-delimiters-depth-6-face">)
                             (</span>s-split <span class="string">&quot;\n&quot;</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>device
          <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">-&gt;&gt;</span>
           <span class="rainbow-delimiters-depth-6-face">(</span>-difference paired-devices connected-devices<span class="rainbow-delimiters-depth-6-face">)
           (</span><span class="keyword">--map</span> <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">-&gt;&gt;</span>
                   <span class="rainbow-delimiters-depth-8-face">(</span>s-split-up-to <span class="string">&quot; &quot;</span> it 2<span class="rainbow-delimiters-depth-8-face">)
                   (</span>-drop 1<span class="rainbow-delimiters-depth-8-face">)
                   (</span>nreverse<span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>im-alist-completing-read <span class="string">&quot;Select bluetooth device to connect: &quot;</span><span class="rainbow-delimiters-depth-6-face">)
           (</span>car<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>set-process-filter
     <span class="rainbow-delimiters-depth-4-face">(</span>start-process <span class="string">&quot;im-connect-bluetooth&quot;</span> nil <span class="string">&quot;bluetoothctl&quot; &quot;connect&quot;</span> device<span class="rainbow-delimiters-depth-4-face">)
     (</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5-face">(</span>proc out<span class="rainbow-delimiters-depth-5-face">)
       (</span><span class="keyword">cond</span>
        <span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>s-matches? <span class="string">&quot;Failed to connect&quot;</span> out<span class="rainbow-delimiters-depth-7-face">) (</span>message <span class="string">&quot;%s&quot;</span> out<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)
        (</span><span class="rainbow-delimiters-depth-7-face">(</span>s-matches? <span class="string">&quot;Connection successful&quot;</span> out<span class="rainbow-delimiters-depth-7-face">) (</span>message <span class="string">&quot;%s&quot;</span> out<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">defun</span> <span class="function-name">im-connect-paired-bluetooth-device</span> <span class="rainbow-delimiters-depth-2-face">()
  (</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">im-when-on</span>
   <span class="builtin">:darwin</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-osx-connect-paired-bluetooth-device<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:linux</span> <span class="rainbow-delimiters-depth-3-face">(</span>im-linux-connect-paired-bluetooth-device<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">im-leader</span>
  <span class="string">&quot;eb&quot;</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-connect-paired-bluetooth-device</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Switch next monitor input
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-ddcutil-toggle/switch-monitor-input</span> <span class="rainbow-delimiters-depth-2-face">(</span>monitor<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="doc">&quot;Switch to other monitor, USBC, DisplayPort or HDMI.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">interactive</span> <span class="rainbow-delimiters-depth-3-face">(</span>list <span class="rainbow-delimiters-depth-4-face">(</span>intern <span class="rainbow-delimiters-depth-5-face">(</span>completing-read <span class="string">&quot;Monitor: &quot;</span> <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span>usbc hdmi dp<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="rainbow-delimiters-depth-4-face">(</span>target <span class="rainbow-delimiters-depth-5-face">(</span>alist-get monitor <span class="highlight-quoted-quote">'</span><span class="rainbow-delimiters-depth-6-face">(</span><span class="rainbow-delimiters-depth-7-face">(</span>hdmi . <span class="string">&quot;17&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                                      (</span>dp . <span class="string">&quot;15&quot;</span><span class="rainbow-delimiters-depth-7-face">)
                                      (</span>usbc . <span class="string">&quot;27&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
         (</span>cmd <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">im-when-on</span>
               <span class="builtin">:linux</span>
               <span class="rainbow-delimiters-depth-6-face">(</span>format
                <span class="string">&quot;%s setvcp 0x60 %s&quot;</span>
                <span class="rainbow-delimiters-depth-7-face">(</span>im-ensure-binary <span class="string">&quot;ddcutil&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;ddcutil&quot;</span> <span class="builtin">:installer</span> <span class="string">&quot;See index.org&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
                target<span class="rainbow-delimiters-depth-6-face">)</span>
               <span class="builtin">:darwin</span>
               <span class="rainbow-delimiters-depth-6-face">(</span>format
                <span class="string">&quot;%s set input %s&quot;</span>
                <span class="rainbow-delimiters-depth-7-face">(</span>im-ensure-binary <span class="string">&quot;m1ddc&quot;</span> <span class="builtin">:package</span> <span class="string">&quot;m1ddc&quot;</span> <span class="builtin">:installer</span> <span class="string">&quot;brew install&quot;</span><span class="rainbow-delimiters-depth-7-face">)</span>
                target<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>shell-command-to-string cmd<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> Check if screen is shared by Zoom/Chrome etc.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">defun</span> <span class="function-name">im-screen-sharing-now?</span> <span class="rainbow-delimiters-depth-2-face">()</span>
  <span class="doc">&quot;Check if screen is being shared by Zoom or Google Chrome.
Return a `</span><span class="constant">promise</span><span class="doc">', meant to be used in a async- function.
Only works for OSX right now.&quot;</span>
  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">im-when-on</span>
   <span class="builtin">:linux</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">progn</span>
     <span class="comment-delimiter">;; </span><span class="comment">(warn &quot;&gt;&gt; im-screen-sharing-now? is not implemented for gnu/linux system-type&quot;)
</span>     nil<span class="rainbow-delimiters-depth-3-face">)</span>
   <span class="builtin">:darwin</span>
   <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="rainbow-delimiters-depth-5-face">(</span>script <span class="string">&quot;
tell application \&quot;System Events\&quot;
    set listOfProcesses to every process whose visible is true
    set output to \&quot;\&quot;
    repeat with aProcess in listOfProcesses
        tell aProcess
            set windowList to every window where its name is not \&quot;\&quot;
            repeat with aWindow in windowList
                set windowName to name of aWindow
                if windowName contains \&quot;zoom share\&quot; or windowName contains \&quot;is sharing your screen\&quot; then
                    return true
                end if
            end repeat
        end tell
    end repeat
    return false
end tell&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)
     (</span>promise-new
      <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-6-face">(</span>resolve _reject<span class="rainbow-delimiters-depth-6-face">)
        (</span>make-process <span class="builtin">:name</span> <span class="string">&quot;check-screen-sharing&quot;</span>
                      <span class="builtin">:command</span> <span class="highlight-quoted-quote">`</span><span class="rainbow-delimiters-depth-7-face">(</span><span class="string">&quot;osascript&quot; &quot;-e&quot;</span> ,script<span class="rainbow-delimiters-depth-7-face">)</span>
                      <span class="builtin">:noquery</span> t
                      <span class="builtin">:filter</span>
                      <span class="rainbow-delimiters-depth-7-face">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-8-face">(</span>_proc string<span class="rainbow-delimiters-depth-8-face">)
                        (</span>funcall resolve <span class="rainbow-delimiters-depth-9-face">(</span>equal <span class="string">&quot;true&quot;</span> <span class="rainbow-delimiters-depth-1-face">(</span>s-trim string<span class="rainbow-delimiters-depth-1-face">)</span><span class="rainbow-delimiters-depth-9-face">)</span><span class="rainbow-delimiters-depth-8-face">)</span><span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;</span><span class="outline-3-0033"> MacOS
</span>
<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Keybindings
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-2-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">I use an external keyboard, this makes AltGr and Meta (Alt) work as expected
</span>  <span class="comment-delimiter">;; </span><span class="comment">I have also inverted Meta and Control keys system-wide or something, so
</span>  <span class="comment-delimiter">;; </span><span class="comment">this setting is done according to that.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> ns-option-modifier <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">meta</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">setq</span> ns-right-alternate-modifier <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">none</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Fix fullscreen
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-2-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">On MacOS, native fullscreen fucks with ESC, so I simply don't use
</span>  <span class="comment-delimiter">;; </span><span class="comment">it. Native fullscreen is also quite bad in itself, I can't assign
</span>  <span class="comment-delimiter">;; </span><span class="comment">keybindings to switch to a dedicated fullscreen app.
</span>
  <span class="comment-delimiter">;; </span><span class="comment">UPDATE: After an MacOS update (or Emacs update?) ESC problem is
</span>  <span class="comment-delimiter">;; </span><span class="comment">solved and I can use the native fullscreen. And now I use
</span>  <span class="comment-delimiter">;; </span><span class="comment">aerospace as my WM and it does not work with non-native
</span>  <span class="comment-delimiter">;; </span><span class="comment">fullscreen and I don't use it all.
</span>
  <span class="comment-delimiter">;; </span><span class="comment">(setq ns-use-native-fullscreen nil)
</span>
  <span class="comment-delimiter">;; </span><span class="comment">But non-native fullscreen does not play well with posframes for
</span>  <span class="comment-delimiter">;; </span><span class="comment">some reason. It creates some visual artifacts. So I simply remove
</span>  <span class="comment-delimiter">;; </span><span class="comment">them each time fullscreen is toggled.
</span>
  <span class="comment-delimiter">;; </span><span class="comment">(define-advice toggle-frame-fullscreen (:after (&amp;rest _) fix-fullscreen-artifacts)
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(posframe-delete-all)
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (im-notify-posframe-clear-all t))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot;*blamer*&quot;))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot;*lsp-ui-doc-1*&quot;))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot;*flycheck-posframe-buffer*&quot;))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot; *lsp-ui-doc-1*&quot;))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot;*lsp-documentation*&quot;))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot; *corfu-popupinfo*&quot;))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(ignore-errors (kill-buffer &quot; *corfu*&quot;)))
</span>  <span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;;;</span><span class="outline-4-0034"> Hammerspoon integration
</span>
<span class="comment-delimiter">;; </span><span class="comment">I have a menubar that shows my current tab and currently clocked in
</span><span class="comment-delimiter">;; </span><span class="comment">task. I disable the tab-bar visually and check which tab I
</span><span class="comment-delimiter">;; </span><span class="comment">currently am in through this Hammerspoon menubar.
</span>
<span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-2-face">(</span>eq system-type <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">darwin</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">defvar</span> <span class="variable-name">im-hammerspoon-server</span> <span class="string">&quot;http://localhost:4562&quot;</span><span class="rainbow-delimiters-depth-2-face">)
  (</span><span class="keyword">defvar</span> <span class="variable-name">im-hammerspoon-handle-clock-p</span> t
    <span class="doc">&quot;Whether to handle org clock stuff in hammerspoon or not.&quot;</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-toggle-hammerspoon-handle-clock</span> <span class="rainbow-delimiters-depth-3-face">()</span>
    <span class="doc">&quot;Toggle the value of `</span><span class="constant">im-hammerspoon-handle-clock-p</span><span class="doc">'.
This is useful when using laptop screen only as the menubar disappears
because of the notch if the text is too long and I can't see which tab I
am on because of this.&quot;</span>
    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">interactive</span><span class="rainbow-delimiters-depth-3-face">)
    (</span><span class="keyword">setq</span> im-hammerspoon-handle-clock-p <span class="rainbow-delimiters-depth-4-face">(</span>not im-hammerspoon-handle-clock-p<span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span>
    <span class="comment-delimiter">;; </span><span class="comment">Reset text if disabled
</span>    <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">unless</span> im-hammerspoon-handle-clock-p
      <span class="rainbow-delimiters-depth-4-face">(</span>request <span class="rainbow-delimiters-depth-5-face">(</span>concat im-hammerspoon-server <span class="string">&quot;/task&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
        <span class="builtin">:type</span> <span class="string">&quot;POST&quot;</span>
        <span class="builtin">:data</span> <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)
    (</span>message <span class="string">&quot;&gt;&gt; `</span><span class="constant">im-hammerspoon-handle-clock-p</span><span class="string">' is now %s&quot;</span> im-hammerspoon-handle-clock-p<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-clock-in-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-hammerspoon-handle-clock-in</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>add-hook <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">org-clock-out-hook</span> <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-hammerspoon-handle-clock-in</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">defun</span> <span class="function-name">im-hammerspoon-handle-clock-in</span> <span class="rainbow-delimiters-depth-3-face">()
    (</span><span class="keyword">when</span> im-hammerspoon-handle-clock-p
      <span class="rainbow-delimiters-depth-4-face">(</span>request <span class="rainbow-delimiters-depth-5-face">(</span>concat im-hammerspoon-server <span class="string">&quot;/task&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span>
        <span class="builtin">:type</span> <span class="string">&quot;POST&quot;</span>
        <span class="builtin">:data</span> <span class="rainbow-delimiters-depth-5-face">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-6-face">(</span>org-clock-is-active<span class="rainbow-delimiters-depth-6-face">)
                  (</span>substring-no-properties <span class="rainbow-delimiters-depth-7-face">(</span>org-clock-get-clock-string<span class="rainbow-delimiters-depth-7-face">)</span><span class="rainbow-delimiters-depth-6-face">)</span>
                <span class="string">&quot;&quot;</span><span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">define-advice</span> <span class="function-name">tab-bar-select-tab</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> report-tab-change-to-hammerspoon<span class="rainbow-delimiters-depth-3-face">)
    (</span>request <span class="rainbow-delimiters-depth-4-face">(</span>concat im-hammerspoon-server <span class="string">&quot;/workspace&quot;</span><span class="rainbow-delimiters-depth-4-face">)</span>
      <span class="builtin">:type</span> <span class="string">&quot;POST&quot;</span>
      <span class="builtin">:data</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="keyword">or</span> <span class="rainbow-delimiters-depth-5-face">(</span>alist-get <span class="highlight-quoted-quote">'</span><span class="highlight-quoted-symbol">name</span> <span class="rainbow-delimiters-depth-6-face">(</span>tab-bar--current-tab<span class="rainbow-delimiters-depth-6-face">)</span><span class="rainbow-delimiters-depth-5-face">)
                (</span>tab-bar-tab-name-current<span class="rainbow-delimiters-depth-5-face">)</span><span class="rainbow-delimiters-depth-4-face">)</span><span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span><span class="keyword">define-advice</span> <span class="function-name">org-clock-update-mode-line</span> <span class="rainbow-delimiters-depth-3-face">(</span><span class="builtin">:after</span> <span class="rainbow-delimiters-depth-4-face">(</span><span class="type">&amp;rest</span> _<span class="rainbow-delimiters-depth-4-face">)</span> report-to-hammerspoon<span class="rainbow-delimiters-depth-3-face">)
    (</span>im-hammerspoon-handle-clock-in<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)

  (</span>run-with-timer 30 30 <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">im-hammerspoon-handle-clock-in</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;;;;</span><span class="outline-2-0030"> Postamble
</span>
<span class="comment-delimiter">;; </span><span class="comment">Load the remaining external files that I want to be loaded
</span><span class="rainbow-delimiters-depth-1-face">(</span><span class="keyword">--each</span>
    <span class="rainbow-delimiters-depth-2-face">(</span>directory-files im-load-path t <span class="rainbow-delimiters-depth-3-face">(</span><span class="keyword">rx</span> <span class="string">&quot;.el&quot;</span> eos<span class="rainbow-delimiters-depth-3-face">)</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>load it<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">setq</span> custom-file <span class="rainbow-delimiters-depth-2-face">(</span>concat user-emacs-directory <span class="string">&quot;custom.el&quot;</span><span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)
(</span><span class="keyword">when</span> <span class="rainbow-delimiters-depth-2-face">(</span>file-exists-p custom-file<span class="rainbow-delimiters-depth-2-face">)
  (</span>load custom-file<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">unless</span> <span class="rainbow-delimiters-depth-2-face">(</span>daemonp<span class="rainbow-delimiters-depth-2-face">)</span>
  <span class="comment-delimiter">;; </span><span class="comment">This is good for the cases where emacsclient may be called inside
</span>  <span class="comment-delimiter">;; </span><span class="comment">emacs (from vterm etc.). Otherwise Emacs acts weird about the
</span>  <span class="comment-delimiter">;; </span><span class="comment">window placement.
</span>  <span class="rainbow-delimiters-depth-2-face">(</span><span class="keyword">setq</span> server-window <span class="highlight-quoted-quote">#'</span><span class="highlight-quoted-symbol">pop-to-buffer</span><span class="rainbow-delimiters-depth-2-face">)
  (</span>server-start<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span>message <span class="string">&quot;&gt;&gt;&gt; Started in %s&quot;</span> <span class="rainbow-delimiters-depth-2-face">(</span>emacs-init-time<span class="rainbow-delimiters-depth-2-face">)</span><span class="rainbow-delimiters-depth-1-face">)

(</span><span class="keyword">provide</span> <span class="highlight-quoted-quote">'</span><span class="constant">init</span><span class="rainbow-delimiters-depth-1-face">)</span>

<span class="comment-delimiter">;; </span><span class="comment">Here are some variables for this file specifically. Some of them
</span><span class="comment-delimiter">;; </span><span class="comment">are self-explanatory but I'll go over some of them for clarity:
</span><span class="comment-delimiter">;;</span><span class="comment">
</span><span class="comment-delimiter">;; </span><span class="comment">- separedit-default-mode :: All the comments in this file are
</span><span class="comment-delimiter">;;   </span><span class="comment">formatted with Org mode markup. When I do \\[</span><span class="constant">separedit</span><span class="comment">] on a
</span><span class="comment-delimiter">;;   </span><span class="comment">comment, an indirect buffer will pop up and normally edit that
</span><span class="comment-delimiter">;;   </span><span class="comment">section in markdown mode but through this variable I set it to
</span><span class="comment-delimiter">;;   </span><span class="comment">org.
</span><span class="comment-delimiter">;; </span><span class="comment">- I don't care about some byte compiler warnings for this file,
</span><span class="comment-delimiter">;;   </span><span class="comment">which are disabled through =byte-compile-warnings= variable.
</span><span class="comment-delimiter">;; </span><span class="comment">- In the same vein of the one above, I don't care about some
</span><span class="comment-delimiter">;;   </span><span class="comment">checkdoc warnings which are disabled through checkdoc-* variables
</span><span class="comment-delimiter">;;   </span><span class="comment">below.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Local Variables:
</span><span class="comment-delimiter">;; </span><span class="comment">byte-compile-warnings: (not unresolved free-vars)
</span><span class="comment-delimiter">;; </span><span class="comment">checkdoc-force-docstrings-flag: nil
</span><span class="comment-delimiter">;; </span><span class="comment">checkdoc--argument-missing-flag: nil
</span><span class="comment-delimiter">;; </span><span class="comment">separedit-default-mode: org-mode
</span><span class="comment-delimiter">;; </span><span class="comment">eval: (setq elisp-flymake-byte-compile-load-path load-path)
</span><span class="comment-delimiter">;; </span><span class="comment">End:
</span><span class="comment-delimiter">;;;</span><span class="outline-1-0029"> init.el ends here
</span></pre>

      </div>
      <div class="mode-line">
        <div class="left">U:%%-    .emacs.d/init.el           <span id="buffer-percent">Top</span>   <span id="buffer-line-number">Top</span>    <a id="buffer-git-address" href="https://github.com/isamert/dotfiles">Git:master</a>   (Elisp/l ElDoc)</div>
        <div class="right"></div>
      </div>
      <div id="echo-area"></div>
    </div>
    <div id="toc">
        <div id="toc-header">
            <strong>Table of Contents</strong>
            <span id="toggle-btn">[-]</span>
        </div>
      <ul id="toc-list"></ul>
    </div>
   <script src="/assets/emacs-frame.js"></script>
  </body>
</html>